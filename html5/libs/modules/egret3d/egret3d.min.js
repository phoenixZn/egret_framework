var __reflect=this&&this.__reflect||function(t,e,r){t.__class__=e,r?r.push(e):r=[e],t.__types__=t.__types__?r.concat(t.__types__):r},__extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},egret3d;!function(t){var e=function(){function e(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=0,this.y=0,this.z=0,this.w=0,this.x=t,this.y=e,this.z=r,this.w=i}return Object.defineProperty(e.prototype,"a",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"r",{get:function(){return this.x},set:function(t){this.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"g",{get:function(){return this.y},set:function(t){this.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:!0,configurable:!0}),e.prototype.add=function(t,r){void 0===r&&(r=null),r||(r=new e);var i=this.x,a=this.y,n=this.z,o=this.w,s=t.x,l=t.y,h=t.z,u=t.w;return r.setTo(i+s,a+l,n+h,o+u),r},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.copyFrom=function(t){var e=this;e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},e.prototype.crossProduct=function(t,r){return void 0===r&&(r=null),r=r||new e,r.x=this.y*t.z-this.z*t.y,r.y=this.z*t.x-this.x*t.z,r.z=this.x*t.y-this.y*t.x,r.w=1,r},e.prototype.decrementBy=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},e.distance=function(t,e){var r=t.x-e.x,i=t.y-e.y,a=t.z-e.z;return Math.sqrt(r*r+i*i+a*a)},e.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.prototype.equals=function(t,e){return void 0===e&&(e=!1),this.x==t.x&&this.y==t.y&&this.z==t.z&&(!e||this.w==t.w)},e.prototype.incrementBy=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},e.prototype.fromArray=function(t){this.x=t[0],this.y=t[1],this.z=t[2]},e.prototype.divide=function(t){return t instanceof e?new e(this.x/t.x,this.y/t.y,this.z/t.z):(this.x=this.x/t,this.y=this.y/t,this.z=this.z/t,this)},e.prototype.negate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},e.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,this.y*=e,void(this.z*=e)}},e.prototype.scaleBy=function(t){this.x*=t,this.y*=t,this.z*=t},e.prototype.setTo=function(t,e,r,i){void 0===i&&(i=1),this.x=t,this.y=e,this.z=r,this.w=i},e.prototype.subtract=function(t,r){return void 0===r&&(r=null),r||(r=new e),r.setTo(this.x-t.x,this.y-t.y,this.z-t.z),r},e.prototype.multiply=function(t,r){void 0===r&&(r=null),r||(r=new e);var i=this.x,a=this.y,n=this.z,o=t.x,s=t.y,l=t.z;return r.setTo(i*o,a*s,n*l),r},e.prototype.divided=function(t,r){void 0===r&&(r=null),r||(r=new e);var i=this.x,a=this.y,n=this.z,o=t.x,s=t.y,l=t.z;return r.setTo(i/o,a/s,n/l),r},e.prototype.lerp=function(t,e,r){var i=t.x,a=t.y,n=t.z,o=t.w,s=e.x,l=e.y,h=e.z,u=e.w;this.x=(s-i)*r+i,this.y=(l-a)*r+a,this.z=(h-n)*r+n,this.w=(u-o)*r+o},e.prototype.Dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.prototype.OrthoNormalVectorFast=function(t,r){r||(r=new e);var i,a;return Math.abs(t.z)>.70710678?(i=t.y*t.y+t.z*t.z,a=1/Math.sqrt(i),r.x=0,r.y=-t.z*a,r.z=t.y*a):(i=t.x*t.x+t.y*t.y,a=1/Math.sqrt(i),r.x=-t.y*a,r.y=t.x*a,r.z=0),r},e.prototype.slerp=function(r,i,a){var n=Math.sqrt(this.Dot(r,r)),o=Math.sqrt(this.Dot(i,i));if(1e-5>n||1e-5>o)return this.lerp(r,i,a);var s=n+a*(o-n),l=this.Dot(r,i)/(n*o);if(l>.99999)return this.lerp(r,i,a);if(-1+1e-5>l){e.HELP_0.copyFrom(r);var h=e.HELP_0.divide(n);this.OrthoNormalVectorFast(h,e.HELP_1);var u=e.HELP_1;t.Quaternion.HELP_0.fromAxisAngle(e.HELP_1,3.1415926*a*t.MathUtil.RADIANS_TO_DEGREES);var c=t.Quaternion.HELP_0.toMatrix3D(t.Matrix4_4.helpMatrix);return c.transformVector(h,this),void this.scaleBy(s)}r.dotProduct,this.Cross(r,i,e.HELP_0);var u=e.HELP_0;e.HELP_1.copyFrom(r);var h=e.HELP_1.divide(n);u.normalize();var d=Math.acos(l)*a;t.Quaternion.HELP_0.fromAxisAngle(u,d*t.MathUtil.RADIANS_TO_DEGREES);var c=t.Quaternion.HELP_0.toMatrix3D(t.Matrix4_4.helpMatrix);return c.transformVector(h,this),void this.scaleBy(s)},e.prototype.Cross=function(t,r,i){return void 0===i&&(i=null),i||(i=new e),i.x=t.y*r.z-t.z*r.y,i.y=t.z*r.x-t.x*r.z,i.z=t.x*r.y-t.y*r.x,i},e.prototype.toString=function(){return"<"+this.x+", "+this.y+", "+this.z+">"},e.prototype.parsing=function(t){var e=t.split(" ");e.length<3||(this.x=parseFloat(e[0]),this.y=parseFloat(e[1]),this.z=parseFloat(e[2]))},e.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.z!=t.z||this.w!=t.w)},e}();e.X_AXIS=new e(1,0,0),e.Y_AXIS=new e(0,1,0),e.Z_AXIS=new e(0,0,1),e.HELP_0=new e,e.HELP_1=new e,e.HELP_2=new e,e.HELP_3=new e,t.Vector3D=e,__reflect(e.prototype,"egret3d.Vector3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,r,i,a){void 0===t&&(t=null),void 0===e&&(e=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=0),this.type=t,this.thisObject=e,this.handler=r,this.param=i,this.priority=a}return t.prototype.equalCurrentListener=function(t,e,r,i){return this.type==t&&this.thisObject==r&&this.handler==e&&this.param==i?!0:!1},t}();e.event_id_count=0,t.EventListener=e,__reflect(e.prototype,"egret3d.EventListener");var r=function(){function t(){this.listeners={}}return t.prototype.dispatchEvent=function(t){var e=this.listeners[t.eventType];if(null!=e){e=e.slice();for(var r=0;r<e.length&&!t.isStopImmediatePropagation;r++){var i=e[r];try{t.param=i.param,t.target=this,t.currentTarget=i,i.handler.call(i.thisObject,t)}catch(a){window.console&&console.error(a.stack)}}}},t.prototype.dispose=function(){for(var t in this.listeners)for(var e=this.listeners[t];e.length>0;){var r=e[0];r.handler=null,r.thisObject=null,e.splice(0,1)}},t.prototype.addEventListener=function(t,r,i,a,n){void 0===a&&(a=null),void 0===n&&(n=0),null==this.listeners[t]&&(this.listeners[t]=[]);var o=new e(t,i,r,a,n);return o.id=++e.event_id_count,this.listeners[t].push(o),this.listeners[t].sort(function(t,e){return e.priority-t.priority}),o.id},t.prototype.removeEventListener=function(t,e,r){if(this.hasEventListener(t,e,r))for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e,r,a.param))return a.handler=null,a.thisObject=null,void this.listeners[t].splice(i,1)}},t.prototype.removeEventListenerAt=function(t){for(var e in this.listeners)for(var r=0;r<this.listeners[e].length;r++){var i=this.listeners[e][r];if(i.id==t)return i.handler=null,i.thisObject=null,void this.listeners[e].splice(r,1)}},t.prototype.clearEventListener=function(){this.listeners={}},t.prototype.containEventListener=function(t){return null==this.listeners[t]?!1:this.listeners[t].length>0},t.prototype.hasEventListener=function(t,e,r){if(void 0===e&&(e=null),void 0===r&&(r=null),null==this.listeners[t])return!1;if(r&&e)for(var i=0;i<this.listeners[t].length;i++){var a=this.listeners[t][i];if(a.equalCurrentListener(t,e,r,a.param))return!0}return!1},t}();t.EventDispatcher=r,__reflect(r.prototype,"egret3d.EventDispatcher")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.aabb=new t.Rectangle,r.mouseEnable=!0,r.mouseChildren=!0,r._renderText=!1,r._childs=[],r._child3Ds=[],r._rgbNumber=16777215,r._alphaNumber=1,r._color=new t.ColorTransform,r._pivot=new t.Vector3D,r._pos=new t.Point,r._rot=new t.Vector3D,r._sca=new t.Vector3D(1,1,100,100),r._globalColor=new t.ColorTransform,r._globalPos=new t.Point,r._globalRot=new t.Vector3D,r._globalSca=new t.Vector3D(1,1,100,100),r._orientation=new t.Quaternion,r._globalOrientation=new t.Quaternion,r._localVisible=!0,r._globalVisible=!0,r._visibleChange=!0,r._colorChange=!0,r._transformChange=!0,r._maskRectChange=!0,r._transformInvalid=!0,r._renderTextInvalid=!0,r._maskRectInvalid=!0,r._colorInvalid=!0,r._textureInvalid=!0,r._visibleInvalid=!0,r.parentIsStage=!1,r}return __extends(r,e),Object.defineProperty(r.prototype,"mouseX",{get:function(){for(var e=this,r=t.Input.mouseX;e;)r-=e.x,e=e.parent&&!e.parentIsStage?e.parent:null;return r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mouseY",{get:function(){for(var e=this,r=t.Input.mouseY;e;)r-=e.y,e=e.parent&&!e.parentIsStage?e.parent:null;return r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"stage",{get:function(){return this._stage},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"childs",{get:function(){return this._childs},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderText",{set:function(t){t!=this._renderText&&(this._renderTextInvalid=!0,this._renderText=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._sca.z},set:function(t){t!=this._sca.z&&(this._sca.z=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._sca.w},set:function(t){t!=this._sca.w&&(this._sca.w=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pivotX",{get:function(){return this._pivot.x},set:function(t){t!=this._pivot.x&&(this._pivot.x=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pivotY",{get:function(){return this._pivot.y},set:function(t){t!=this._pivot.y&&(this._pivot.y=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pivotZ",{get:function(){return this._pivot.z},set:function(t){t!=this._pivot.z&&(this._pivot.z=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mask",{get:function(){return this._localMaskRect},set:function(e){(null!=e||null!=this._localMaskRect)&&(this._localMaskRect=this._localMaskRect||new t.Rectangle,this._localMaskRect.copyFrom(e),this.updateMaskChange(!0))},enumerable:!0,configurable:!0}),r.prototype.calculateTransform=function(){if(this._transformChange){if(null!=this._parent){var t=this._parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation),this._globalOrientation.toEulerAngles(this._globalRot);var e=this._parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca)),r.ThisPos.setTo(this._pos.x,this._pos.y,0,1),e.multiply(r.ThisPos),t.transformVector(r.ThisPos,r.TargetPos),this._pos.x=r.ThisPos.x,this._pos.y=r.ThisPos.y,this._globalPos.x=r.TargetPos.x,this._globalPos.y=r.TargetPos.y,this._globalPos.incrementBy(this._parent.globalPosition)}else this._globalOrientation.copyFrom(this._orientation),this._globalPos.copyFrom(this._pos),this._globalSca.copyFrom(this._sca),this._globalRot.copyFrom(this._rot);this._transformChange=!1,this.calculateMask(),this.onUpdateTransform()}},r.prototype.calculateMask=function(){this.calculateTransform(),this._maskRectChange&&(this._parent?this._localMaskRect?(this._globalMaskRect=this._globalMaskRect||new t.Rectangle,this._globalMaskRect.x=this._localMaskRect.x*this._globalSca.x+this._globalPos.x,this._globalMaskRect.y=this._localMaskRect.y*this._globalSca.y+this._globalPos.y,this._globalMaskRect.width=this._localMaskRect.width*this._globalSca.x,this._globalMaskRect.height=this._localMaskRect.height*this._globalSca.y,this._parent.globalMask&&this._globalMaskRect.innerArea(this._parent.globalMask,this._globalMaskRect)):this._parent.globalMask?(this._globalMaskRect=this._globalMaskRect||new t.Rectangle,this._globalMaskRect.copyFrom(this._parent.globalMask)):this._globalMaskRect=null:this._localMaskRect?(this._globalMaskRect=this._globalMaskRect||new t.Rectangle,this._globalMaskRect.x=this._localMaskRect.x*this._globalSca.x+this._globalPos.x,this._globalMaskRect.y=this._localMaskRect.y*this._globalSca.y+this._globalPos.y,this._globalMaskRect.width=this._localMaskRect.width*this._globalSca.x,this._globalMaskRect.height=this._localMaskRect.height*this._globalSca.y):this._globalMaskRect=null,this._maskRectChange=!1)},r.prototype.onUpdateTransform=function(){},r.prototype.addChild=function(e){return e instanceof r?this.doAddChildAt(e,t.MathUtil.MAX_VALUE):void 0},r.prototype.addObject3D=function(t){return t&&this._child3Ds.push(t),t},r.prototype.addChildAt=function(t,e){return this.doAddChildAt(t,e)},r.prototype.doAddChildAt=function(t,e){if(null==t)return null;if(t.parent)throw Error("This object is already the other child object.");if(this._childs.indexOf(t)>=0)throw Error("The same child object has been added.");if(0>e)throw Error("Child index can not be small than 0 !");return e>=this._childs.length?this._childs.push(t):this._childs.splice(e,0,t),t._parent=this,this._stage&&this._stage.setRenderListInvalid(),t.activeStage(this._stage),t},r.prototype.removeChild=function(t){return this.doRemoveChild(t)},r.prototype.removeChildAt=function(t){return this.doRemoveChild(this._childs[t])},r.prototype.doRemoveChild=function(t){if(null==t)return null;var e=this._childs.indexOf(t);if(-1==e)throw Error("The display isn't a child of this container!");return this._childs.splice(e,1),t._parent=null,this._stage&&this._stage.setRenderListInvalid(),t.activeStage(null),t},r.prototype.swapChildIndex=function(t,e){},r.prototype.activeStage=function(t){if(this._stage!=t){this._stage=t,this.updateMaskChange(!0),this.updateTransformChange(!0),this.updateColorChange(!0),this.updateVisibleChange(!0);for(var e=0,r=this._childs.length;r>e;e++)this._childs[e].activeStage(t);this.onActiveStage()}},r.prototype.onActiveStage=function(){},r.prototype.hasChild=function(t){return this.childs.indexOf(t)},r.prototype.getChildByIndex=function(t){return this.childs[t]},r.prototype.getChildByName=function(t){if(!t)return null;for(var e,r=0,i=this._childs;r<i.length;r++)if(e=i[r],e.name==t)return e;return null},r.prototype.update=function(t,e){this.globalPosition,this.globalRotation,this.globalScale,this.globalColor,this.globalVisible,this.globalMask,this.updateMouseAABB()},r.prototype.updateMouseAABB=function(){if(this.mouseEnable){var t=this.globalPosition,e=this.globalScale;(this._maskRectInvalid||this._transformInvalid)&&(this.aabb.x=t.x,this.aabb.y=t.y,this.aabb.width=this.width*e.x,this.aabb.height=this.height*e.y,this.globalMask&&this.aabb.innerArea(this.globalMask,this.aabb))}else this.aabb.setTo(0,0,0,0)},r.prototype.updateMaskChange=function(t){if(this._maskRectChange!=t){this._maskRectChange=t,this._maskRectInvalid=t;for(var e=0;e<this._childs.length;++e)this._childs[e].updateMaskChange(t)}},r.prototype.updateTransformChange=function(t){if(this._transformChange!=t){this._transformChange=t,this._transformInvalid=t;for(var e=0;e<this._childs.length;++e)this._childs[e].updateTransformChange(t);this.updateMaskChange(t)}},r.prototype.updateVisibleChange=function(t){if(this._visibleChange!=t){this._visibleChange=t,this._visibleInvalid=t;for(var e=0;e<this._childs.length;++e)this._childs[e].updateVisibleChange(t)}},Object.defineProperty(r.prototype,"globalVisible",{get:function(){return this._visibleChange&&(this._parent?this._globalVisible=this._localVisible&&this._parent.globalVisible:this._globalVisible=this._localVisible,this._visibleChange=!1),this._globalVisible},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visible",{get:function(){return this._localVisible},set:function(t){this._localVisible!=t&&(this._localVisible=t,this.updateVisibleChange(!0))},enumerable:!0,configurable:!0}),r.prototype.updateColorChange=function(t){if(this._colorChange!=t){this._colorChange=t,this._colorInvalid=t;for(var e=0;e<this._childs.length;++e)this._childs[e].updateColorChange(t)}},Object.defineProperty(r.prototype,"globalX",{get:function(){return this.globalPosition.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalY",{get:function(){return this.globalPosition.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalPosition",{get:function(){return this._transformChange&&this.calculateTransform(),this._globalPos},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalRotationX",{get:function(){return this.globalRotation.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalRotationY",{get:function(){return this.globalRotation.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalRotationZ",{get:function(){return this.globalRotation.z},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalRotation",{get:function(){return this._transformChange&&this.calculateTransform(),this._globalRot},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalScale",{get:function(){return this._transformChange&&this.calculateTransform(),this._globalSca},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalScaleX",{get:function(){return this.globalScale.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalScaleY",{get:function(){return this.globalScale.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalScaleZ",{get:function(){return this.globalScale.z},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalOrientation",{get:function(){return this._transformChange&&this.calculateTransform(),this._globalOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalMask",{get:function(){return this._maskRectChange&&this.calculateMask(),this._globalMaskRect},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"position",{get:function(){return this._pos},set:function(t){this._pos.copyFrom(t),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotation",{get:function(){return this._rot},set:function(t){this._rot.x=t.x,this._rot.y=t.y,this._rot.z=t.z,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.copyFrom(t),this._orientation.toEulerAngles(this._rot),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"orientationX",{set:function(t){this._orientation.x!=t&&(this._orientation.x=t,this._orientation.toEulerAngles(this._rot),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"orientationY",{set:function(t){this._orientation.y!=t&&(this._orientation.y=t,this._orientation.toEulerAngles(this._rot),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"orientationZ",{set:function(t){this._orientation.z!=t&&(this._orientation.z=t,this._orientation.toEulerAngles(this._rot),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"orientationW",{set:function(t){this._orientation.w!=t&&(this._orientation.w=t,this._orientation.toEulerAngles(this._rot),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scale",{get:function(){return this._sca},set:function(t){this._sca=t,this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"x",{get:function(){return this._pos.x},set:function(t){this._pos.x!=t&&(this._pos.x=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._pos.y},set:function(t){this._pos.y!=t&&(this.updateTransformChange(!0),this._pos.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){this._rot.x!=t&&(this._rot.x=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){this._rot.y!=t&&(this._rot.y=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){this._rot.z!=t&&(this._rot.z=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){this._sca.x!=t&&(this._sca.x=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){this._sca.y!=t&&(this.updateTransformChange(!0),this._sca.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalColor",{get:function(){return this._colorChange&&(this._color.alpha=this._alphaNumber,this._color.setColorRGB(this._rgbNumber),this._parent?this._globalColor.multiply(this._parent.globalColor):this._globalColor.copyFrom(this._color),this._colorChange=!1),this._color},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._rgbNumber},set:function(t){this._rgbNumber!=t&&(this._rgbNumber=t,this.updateColorChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"alpha",{get:function(){return this._alphaNumber},set:function(t){this._alphaNumber=t,this._alphaNumber!=t&&(this._alphaNumber=t,this.updateColorChange(!0))},enumerable:!0,configurable:!0}),r}(t.EventDispatcher);e.ThisVector=new t.Vector3D,e.ThisPos=new t.Vector3D,e.TargetPos=new t.Vector3D,t.DisplayObject=e,__reflect(e.prototype,"egret3d.DisplayObject")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){void 0===t&&(t=null),this.length=16,this.rowLength=4,t?this.rawData=t:this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return e.prototype.lookAt=function(e,r,i){void 0===i&&(i=t.Vector3D.Y_AXIS);var a=this.rawData;r.subtract(e,t.Vector3D.HELP_0);var n=t.Vector3D.HELP_0;n.normalize();var o=i.crossProduct(n,t.Vector3D.HELP_1);o.length<.05&&(o.x=i.y,o.y=i.x,Math.abs(o.x-o.y)<.05?(o.x=-i.z,o.y=i.x,o.z=0):o.z=0),o.normalize();var s=n.crossProduct(o,t.Vector3D.HELP_2);a[0]=o.x,a[1]=s.x,a[2]=n.x,a[3]=0,a[4]=o.y,a[5]=s.y,a[6]=n.y,a[7]=0,a[8]=o.z,a[9]=s.z,a[10]=n.z,a[11]=0,a[12]=-o.dotProduct(e),a[13]=-s.dotProduct(e),a[14]=-n.dotProduct(e),a[15]=1},e.prototype.multiply=function(t){var r=this.rawData,i=t.rawData,a=e.helpMatrix;a[0]=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12],a[1]=r[0]*i[1]+r[1]*i[5]+r[2]*i[9]+r[3]*i[13],a[2]=r[0]*i[2]+r[1]*i[6]+r[2]*i[10]+r[3]*i[14],a[3]=r[0]*i[3]+r[1]*i[7]+r[2]*i[11]+r[3]*i[15],a[4]=r[4]*i[0]+r[5]*i[4]+r[6]*i[8]+r[7]*i[12],a[5]=r[4]*i[1]+r[5]*i[5]+r[6]*i[9]+r[7]*i[13],a[6]=r[4]*i[2]+r[5]*i[6]+r[6]*i[10]+r[7]*i[14],a[7]=r[4]*i[3]+r[5]*i[7]+r[6]*i[11]+r[7]*i[15],a[8]=r[8]*i[0]+r[9]*i[4]+r[10]*i[8]+r[11]*i[12],a[9]=r[8]*i[1]+r[9]*i[5]+r[10]*i[9]+r[11]*i[13],a[10]=r[8]*i[2]+r[9]*i[6]+r[10]*i[10]+r[11]*i[14],a[11]=r[8]*i[3]+r[9]*i[7]+r[10]*i[11]+r[11]*i[15],a[12]=r[12]*i[0]+r[13]*i[4]+r[14]*i[8]+r[15]*i[12],a[13]=r[12]*i[1]+r[13]*i[5]+r[14]*i[9]+r[15]*i[13],a[14]=r[12]*i[2]+r[13]*i[6]+r[14]*i[10]+r[15]*i[14],a[15]=r[12]*i[3]+r[13]*i[7]+r[14]*i[11]+r[15]*i[15],r[0]=a[0],r[1]=a[1],r[2]=a[2],r[3]=a[3],r[4]=a[4],r[5]=a[5],r[6]=a[6],r[7]=a[7],r[8]=a[8],r[9]=a[9],r[10]=a[10],r[11]=a[11],r[12]=a[12],r[13]=a[13],r[14]=a[14],r[15]=a[15]},e.prototype.perspectiveB=function(t,e,r,i){var a=Math.tan(t*Math.PI/360)*r,n=a*e;return this.frustum(-n,n,-a,a,r,i)},e.prototype.frustum=function(t,e,r,i,a,n){var o=this.rawData;return o[0]=2*a/(e-t),o[1]=0,o[2]=(e+t)/(e-t),o[3]=0,o[4]=0,o[5]=2*a/(i-r),o[6]=(i+r)/(i-r),o[7]=0,o[8]=0,o[9]=0,o[10]=-(n+a)/(n-a),o[11]=-2*n*a/(n-a),o[12]=0,o[13]=0,o[14]=-1,o[15]=0,this},e.prototype.perspective=function(t,e,r,i){var a=this.rawData,n=t*(Math.PI/180),o=Math.tan((Math.PI-n)/2),s=o/e;a[0]=s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=i/(i-r),a[11]=1,a[12]=0,a[13]=0,a[14]=-r*i/(i-r),a[15]=0},e.prototype.ortho=function(t,e,r,i){var a=this.rawData;a[0]=2/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/e,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1/(i-r),a[11]=0,a[12]=0,a[13]=0,a[14]=r/(r-i),a[15]=1},e.prototype.orthoOffCenter=function(t,e,r,i,a,n){var o=this.rawData;o[0]=2/(e-t),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/(i-r),o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1/(n-a),o[11]=0,o[12]=(t+e)/(t-e),o[13]=(i+r)/(r-i),o[14]=a/(a-n),o[15]=1},e.prototype.fromToRotation=function(e,r){var i=this.rawData,a=1e-6,n=t.Vector3D.HELP_0;r.crossProduct(e,n);var o=r.dotProduct(e);if(o>1-a)this.identity();else if(-1+a>o){var s=t.Vector3D.HELP_1,l=t.Vector3D.HELP_2,h=0,u=void 0,c=void 0,d=void 0,p=void 0,f=void 0,m=void 0,_=void 0,v=void 0,g=void 0,y=void 0,x=void 0,b=void 0,D=void 0,T=void 0,P=void 0,S=void 0,w=void 0,A=void 0;l.x=0,l.y=e.z,l.z=-e.y,l.dotProduct(l)<a&&(l.x=-e.z,l.y=0,l.z=e.x),h=1/Math.sqrt(l.dotProduct(l)),l[0]*=h,l[1]*=h,l[2]*=h,l.crossProduct(e,s),u=-e.x*e.x,c=-e.y*e.y,d=-e.z*e.z,p=-e.x*e.y,f=-e.x*e.z,m=-e.y*e.z,_=s.x*s.x,v=s.y*s.y,g=s.z*s.z,y=s.x*s.y,x=s.x*s.z,b=s.y*s.z,D=-l.x*l.x,T=-l.y*l.y,P=-l.z*l.z,S=-l.x*l.y,w=-l.x*l.z,A=-l.y*l.z,i[0]=u+_+D,i[1]=p+y+S,i[2]=f+x+w,i[4]=i[1],i[5]=c+v+T,i[6]=m+b+A,i[8]=i[2],i[9]=i[6],i[10]=d+g+P,i[3]=0,i[7]=0,i[11]=0,i[15]=1}else{var C=void 0,L=void 0,E=void 0,M=void 0,z=void 0,F=(1-o)/n.dotProduct(n);C=F*n.x,L=F*n.z,E=C*n.y,M=C*n.z,z=L*n.y,i[0]=o+C*n.x,i[1]=E-n.z,i[2]=M+n.y,i[4]=E+n.z,i[5]=o+F*n.y*n.y,i[6]=z-n.x,i[8]=M-n.y,i[9]=z+n.x,i[10]=o+L*n.z,i[3]=0,i[7]=0,i[11]=0,i[15]=1}},e.fromToRotation=function(t,r,i){return void 0===i&&(i=null),i||(i=new e),i.fromToRotation(t,r),i},e.prototype.append=function(t){var e=this.rawData,r=e[0],i=e[4],a=e[8],n=e[12],o=e[1],s=e[5],l=e[9],h=e[13],u=e[2],c=e[6],d=e[10],p=e[14],f=e[3],m=e[7],_=e[11],v=e[15];e[0]=r*t.rawData[0]+o*t.rawData[4]+u*t.rawData[8]+f*t.rawData[12],e[1]=r*t.rawData[1]+o*t.rawData[5]+u*t.rawData[9]+f*t.rawData[13],e[2]=r*t.rawData[2]+o*t.rawData[6]+u*t.rawData[10]+f*t.rawData[14],e[3]=r*t.rawData[3]+o*t.rawData[7]+u*t.rawData[11]+f*t.rawData[15],e[4]=i*t.rawData[0]+s*t.rawData[4]+c*t.rawData[8]+m*t.rawData[12],e[5]=i*t.rawData[1]+s*t.rawData[5]+c*t.rawData[9]+m*t.rawData[13],e[6]=i*t.rawData[2]+s*t.rawData[6]+c*t.rawData[10]+m*t.rawData[14],e[7]=i*t.rawData[3]+s*t.rawData[7]+c*t.rawData[11]+m*t.rawData[15],e[8]=a*t.rawData[0]+l*t.rawData[4]+d*t.rawData[8]+_*t.rawData[12],e[9]=a*t.rawData[1]+l*t.rawData[5]+d*t.rawData[9]+_*t.rawData[13],e[10]=a*t.rawData[2]+l*t.rawData[6]+d*t.rawData[10]+_*t.rawData[14],e[11]=a*t.rawData[3]+l*t.rawData[7]+d*t.rawData[11]+_*t.rawData[15],e[12]=n*t.rawData[0]+h*t.rawData[4]+p*t.rawData[8]+v*t.rawData[12],e[13]=n*t.rawData[1]+h*t.rawData[5]+p*t.rawData[9]+v*t.rawData[13],e[14]=n*t.rawData[2]+h*t.rawData[6]+p*t.rawData[10]+v*t.rawData[14],e[15]=n*t.rawData[3]+h*t.rawData[7]+p*t.rawData[11]+v*t.rawData[15]},e.prototype.add=function(t){var e=this.rawData,r=e[0],i=e[4],a=e[8],n=e[12],o=e[1],s=e[5],l=e[9],h=e[13],u=e[2],c=e[6],d=e[10],p=e[14],f=e[3],m=e[7],_=e[11],v=e[15],g=t.rawData[0],y=t.rawData[4],x=t.rawData[8],b=t.rawData[12],D=t.rawData[1],T=t.rawData[5],P=t.rawData[9],S=t.rawData[13],w=t.rawData[2],A=t.rawData[6],C=t.rawData[10],L=t.rawData[14],E=t.rawData[3],M=t.rawData[7],z=t.rawData[11],F=t.rawData[15];return e[0]=r+g,e[1]=o+D,e[2]=u+w,e[3]=f+E,e[4]=i+y,e[5]=s+T,e[6]=c+A,e[7]=m+M,e[8]=a+x,e[9]=l+P,e[10]=d+C,e[11]=_+z,e[12]=n+b,e[13]=h+S,e[14]=p+L,e[15]=v+F,this},e.prototype.sub=function(t){var e=this.rawData,r=e[0],i=e[4],a=e[8],n=e[12],o=e[1],s=e[5],l=e[9],h=e[13],u=e[2],c=e[6],d=e[10],p=e[14],f=e[3],m=e[7],_=e[11],v=e[15],g=t.rawData[0],y=t.rawData[4],x=t.rawData[8],b=t.rawData[12],D=t.rawData[1],T=t.rawData[5],P=t.rawData[9],S=t.rawData[13],w=t.rawData[2],A=t.rawData[6],C=t.rawData[10],L=t.rawData[14],E=t.rawData[3],M=t.rawData[7],z=t.rawData[11],F=t.rawData[15];return e[0]=r-g,e[1]=o-D,e[2]=u-w,e[3]=f-E,e[4]=i-y,e[5]=s-T,e[6]=c-A,e[7]=m-M,e[8]=a-x,e[9]=l-P,e[10]=d-C,e[11]=_-z,e[12]=n-b,e[13]=h-S,e[14]=p-L,e[15]=v-F,this},e.prototype.mult=function(t){var e=this.rawData;return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,this},e.prototype.rotation=function(r,i,a){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(r,i,a),this.makeTransform(e.position_000,e.scale_111,t.MathUtil.CALCULATION_QUATERNION)},e.prototype.appendRotation=function(t,r){var i=e.getAxisRotation(r.x,r.y,r.z,t);this.append(i)},e.prototype.createByRotation=function(e,r){var i,a,n=t.MathUtil.CALCULATION_MATRIX,o=e*t.MathUtil.DEGREES_TO_RADIANS;i=Math.sin(o),a=Math.cos(o),1==r.x&&(n.rawData[0]=1,n.rawData[1]=0,n.rawData[2]=0,n.rawData[3]=0,n.rawData[4]=0,n.rawData[5]=a,n.rawData[6]=i,n.rawData[7]=0,n.rawData[8]=0,n.rawData[9]=-i,n.rawData[10]=a,n.rawData[11]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),1==r.y&&(n.rawData[0]=a,n.rawData[1]=0,n.rawData[2]=-i,n.rawData[3]=0,n.rawData[4]=0,n.rawData[5]=1,n.rawData[6]=0,n.rawData[7]=0,n.rawData[8]=i,n.rawData[9]=0,n.rawData[10]=a,n.rawData[11]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),1==r.z&&(n.rawData[0]=a,n.rawData[1]=i,n.rawData[2]=0,n.rawData[3]=0,n.rawData[4]=-i,n.rawData[5]=a,n.rawData[6]=0,n.rawData[7]=0,n.rawData[8]=0,n.rawData[9]=0,n.rawData[10]=1,n.rawData[11]=0,n.rawData[12]=0,n.rawData[13]=0,n.rawData[14]=0,n.rawData[15]=1),this.append(n)},e.prototype.appendScale=function(t,r,i){e.helpMatrix.createByScale(t,r,i),this.append(e.helpMatrix)},e.prototype.createByScale=function(t,e,r){var i=this.rawData;i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=r,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1},e.prototype.appendTranslation=function(t,e,r){var i=this.rawData;i[12]+=t,i[13]+=e,i[14]+=r},e.prototype.clone=function(){var t=new e;return t.copyFrom(this),t},e.prototype.copyRowFrom=function(t,e){var r=this.rawData;switch(t){case 0:r[0]=e.x,r[1]=e.y,r[2]=e.z,r[3]=e.w;break;case 1:r[4]=e.x,r[5]=e.y,r[6]=e.z,r[7]=e.w;break;case 2:r[8]=e.x,r[9]=e.y,r[10]=e.z,r[11]=e.w;break;case 3:r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=e.w}},e.prototype.copyRowTo=function(t,e){var r=this.rawData;switch(t){case 0:e.x=r[0],e.y=r[1],e.z=r[2],e.w=r[3];break;case 1:e.x=r[4],e.y=r[5],e.z=r[6],e.w=r[7];break;case 2:e.x=r[8],e.y=r[9],e.z=r[10],e.w=r[11];break;case 3:e.x=r[12],e.y=r[13],e.z=r[14],e.w=r[15]}},e.prototype.copyFrom=function(t){var e=this.rawData;return e[0]=t.rawData[0],e[1]=t.rawData[1],e[2]=t.rawData[2],e[3]=t.rawData[3],e[4]=t.rawData[4],e[5]=t.rawData[5],e[6]=t.rawData[6],e[7]=t.rawData[7],e[8]=t.rawData[8],e[9]=t.rawData[9],e[10]=t.rawData[10],e[11]=t.rawData[11],e[12]=t.rawData[12],e[13]=t.rawData[13],e[14]=t.rawData[14],e[15]=t.rawData[15],this},e.prototype.copyRawDataFrom=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=!1);var i=this.rawData;i[0]=t[0+e],i[1]=t[1+e],i[2]=t[2+e],i[3]=t[3+e],i[4]=t[4+e],i[5]=t[5+e],i[6]=t[6+e],i[7]=t[7+e],i[8]=t[8+e],i[9]=t[9+e],i[10]=t[10+e],i[11]=t[11+e],i[12]=t[12+e],i[13]=t[13+e],i[14]=t[14+e],i[15]=t[15+e]},e.prototype.copyRawDataTo=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=!1);var i=this.rawData;t[0+e]=i[0],t[1+e]=i[1],t[2+e]=i[2],t[3+e]=i[3],t[4+e]=i[4],t[5+e]=i[5],t[6+e]=i[6],t[7+e]=i[7],t[8+e]=i[8],t[9+e]=i[9],t[10+e]=i[10],t[11+e]=i[11],t[12+e]=i[12],t[13+e]=i[13],t[14+e]=i[14],t[15+e]=i[15]},e.prototype.copyColFrom=function(t,e){var r=this.rawData;switch(t){case 0:r[0]=e.x,r[4]=e.y,r[8]=e.z,r[12]=e.w;
break;case 1:r[1]=e.x,r[5]=e.y,r[9]=e.z,r[13]=e.w;break;case 2:r[2]=e.x,r[6]=e.y,r[10]=e.z,r[14]=e.w;break;case 3:r[3]=e.x,r[7]=e.y,r[11]=e.z,r[15]=e.w;break;default:new Error("no more raw!")}},e.prototype.copyColTo=function(t,e){var r=this.rawData;switch(t){case 0:e.x=r[0],e.y=r[4],e.z=r[8],e.w=r[12];break;case 1:e.x=r[1],e.y=r[5],e.z=r[9],e.w=r[13];break;case 2:e.x=r[2],e.y=r[6],e.z=r[10],e.w=r[14];break;case 3:e.x=r[3],e.y=r[7],e.z=r[11],e.w=r[15];break;default:new Error("no more raw!")}},e.prototype.copyToMatrix3D=function(t){t.rawData=this.rawData.slice(0)},e.prototype.decompose=function(r,i){void 0===r&&(r="eulerAngles"),void 0===i&&(i=null);var a=t.MathUtil.CALCULATION_QUATERNION,n=i?i:e.prs;this.copyRawDataTo(e.helpMatrix.rawData);var o=e.helpMatrix.rawData,s=n[0];s.x=o[12],s.y=o[13],s.z=o[14],o[12]=0,o[13]=0,o[14]=0;var l=n[2];l.x=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),l.y=Math.sqrt(o[4]*o[4]+o[5]*o[5]+o[6]*o[6]),l.z=Math.sqrt(o[8]*o[8]+o[9]*o[9]+o[10]*o[10]),o[0]*(o[5]*o[10]-o[6]*o[9])-o[1]*(o[4]*o[10]-o[6]*o[8])+o[2]*(o[4]*o[9]-o[5]*o[8])<0&&(l.z=-l.z),o[0]/=l.x,o[1]/=l.x,o[2]/=l.x,o[4]/=l.y,o[5]/=l.y,o[6]/=l.y,o[8]/=l.z,o[9]/=l.z,o[10]/=l.z;var h=n[1];switch(r){case t.Orientation3D.AXIS_ANGLE:h.w=Math.acos((o[0]+o[5]+o[10]-1)/2);var u=Math.sqrt((o[6]-o[9])*(o[6]-o[9])+(o[8]-o[2])*(o[8]-o[2])+(o[1]-o[4])*(o[1]-o[4]));h.x=(o[6]-o[9])/u,h.y=(o[8]-o[2])/u,h.z=(o[1]-o[4])/u;break;case t.Orientation3D.QUATERNION:var c=o[0]+o[5]+o[10];c>0?(h.w=Math.sqrt(1+c)/2,h.x=(o[6]-o[9])/(4*h.w),h.y=(o[8]-o[2])/(4*h.w),h.z=(o[1]-o[4])/(4*h.w)):o[0]>o[5]&&o[0]>o[10]?(h.x=Math.sqrt(1+o[0]-o[5]-o[10])/2,h.w=(o[6]-o[9])/(4*h.x),h.y=(o[1]+o[4])/(4*h.x),h.z=(o[8]+o[2])/(4*h.x)):o[5]>o[10]?(h.y=Math.sqrt(1+o[5]-o[0]-o[10])/2,h.x=(o[1]+o[4])/(4*h.y),h.w=(o[8]-o[2])/(4*h.y),h.z=(o[6]+o[9])/(4*h.y)):(h.z=Math.sqrt(1+o[10]-o[0]-o[5])/2,h.x=(o[8]+o[2])/(4*h.z),h.y=(o[6]+o[9])/(4*h.z),h.w=(o[1]-o[4])/(4*h.z));break;case t.Orientation3D.EULER_ANGLES:var c=o[0]+o[5]+o[10];c>0?(a.w=Math.sqrt(1+c)/2,a.x=(o[6]-o[9])/(4*a.w),a.y=(o[8]-o[2])/(4*a.w),a.z=(o[1]-o[4])/(4*a.w)):o[0]>o[5]&&o[0]>o[10]?(a.x=Math.sqrt(1+o[0]-o[5]-o[10])/2,a.w=(o[6]-o[9])/(4*a.x),a.y=(o[1]+o[4])/(4*a.x),a.z=(o[8]+o[2])/(4*a.x)):o[5]>o[10]?(h.y=Math.sqrt(1+o[5]-o[0]-o[10])/2,a.x=(o[1]+o[4])/(4*a.y),a.w=(o[8]-o[2])/(4*a.y),a.z=(o[6]+o[9])/(4*a.y)):(a.z=Math.sqrt(1+o[10]-o[0]-o[5])/2,a.x=(o[8]+o[2])/(4*a.z),a.y=(o[6]+o[9])/(4*a.z),a.w=(o[1]-o[4])/(4*a.z)),a.toEulerAngles(h)}return n[0]=s,n[1]=h,n[2]=l,n},e.prototype.deltaTransformVector=function(e,r){void 0===r&&(r=null),r||(r=new t.Vector3D);var i=this.rawData,a=e.x,n=e.y,o=e.z;return r.x=a*i[0]+n*i[4]+o*i[8],r.y=a*i[1]+n*i[5]+o*i[9],r.z=a*i[2]+n*i[6]+o*i[10],r.w=a*i[3]+n*i[7]+o*i[11],r},e.prototype.identity=function(){var t=this.rawData;t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[0]=1,t[5]=1,t[10]=1,t[15]=1},e.prototype.fill=function(t){var e=this.rawData;e[1]=t,e[2]=t,e[3]=t,e[4]=t,e[6]=t,e[7]=t,e[8]=t,e[9]=t,e[11]=t,e[12]=t,e[13]=t,e[14]=t,e[0]=t,e[5]=t,e[10]=t,e[15]=t},e.prototype.invers33=function(){var t=this.rawData,e=t[5]*t[10]-t[9]*t[6],r=t[8]*t[6]-t[4]*t[10],i=t[4]*t[9]-t[8]*t[5],a=t[9]*t[2]-t[1]*t[10],n=t[0]*t[10]-t[8]*t[2],o=t[8]*t[1]-t[0]*t[9],s=t[1]*t[6]-t[5]*t[2],l=t[4]*t[2]-t[0]*t[6],h=t[0]*t[5]-t[4]*t[1],u=t[0]*e+t[4]*a+t[8]*s;if(Math.abs(u)>1e-11){var c=1/u;t[0]=c*e,t[4]=c*r,t[8]=c*i,t[1]=c*a,t[5]=c*n,t[9]=c*o,t[2]=c*s,t[6]=c*l,t[10]=c*h}},e.transpose=function(t,r){r=r||new e;var i=t.rawData,a=r.rawData;return a[0]=i[0],a[1]=i[4],a[2]=i[8],a[3]=i[12],a[4]=i[1],a[5]=i[5],a[6]=i[9],a[7]=i[13],a[8]=i[2],a[9]=i[6],a[10]=i[10],a[11]=i[14],a[12]=i[3],a[13]=i[7],a[14]=i[11],a[15]=i[15],r},e.inverse=function(t,r){r=r||new e;var i=t.rawData,a=r.rawData;a[0]=i[5]*i[10]*i[15]-i[5]*i[14]*i[11]-i[6]*i[9]*i[15]+i[6]*i[13]*i[11]+i[7]*i[9]*i[14]-i[7]*i[13]*i[10],a[1]=-i[1]*i[10]*i[15]+i[1]*i[14]*i[11]+i[2]*i[9]*i[15]-i[2]*i[13]*i[11]-i[3]*i[9]*i[14]+i[3]*i[13]*i[10],a[2]=i[1]*i[6]*i[15]-i[1]*i[14]*i[7]-i[2]*i[5]*i[15]+i[2]*i[13]*i[7]+i[3]*i[5]*i[14]-i[3]*i[13]*i[6],a[3]=-i[1]*i[6]*i[11]+i[1]*i[10]*i[7]+i[2]*i[5]*i[11]-i[2]*i[9]*i[7]-i[3]*i[5]*i[10]+i[3]*i[9]*i[6],a[4]=-i[4]*i[10]*i[15]+i[4]*i[14]*i[11]+i[6]*i[8]*i[15]-i[6]*i[12]*i[11]-i[7]*i[8]*i[14]+i[7]*i[12]*i[10],a[5]=i[0]*i[10]*i[15]-i[0]*i[14]*i[11]-i[2]*i[8]*i[15]+i[2]*i[12]*i[11]+i[3]*i[8]*i[14]-i[3]*i[12]*i[10],a[6]=-i[0]*i[6]*i[15]+i[0]*i[14]*i[7]+i[2]*i[4]*i[15]-i[2]*i[12]*i[7]-i[3]*i[4]*i[14]+i[3]*i[12]*i[6],a[7]=i[0]*i[6]*i[11]-i[0]*i[10]*i[7]-i[2]*i[4]*i[11]+i[2]*i[8]*i[7]+i[3]*i[4]*i[10]-i[3]*i[8]*i[6],a[8]=i[4]*i[9]*i[15]-i[4]*i[13]*i[11]-i[5]*i[8]*i[15]+i[5]*i[12]*i[11]+i[7]*i[8]*i[13]-i[7]*i[12]*i[9],a[9]=-i[0]*i[9]*i[15]+i[0]*i[13]*i[11]+i[1]*i[8]*i[15]-i[1]*i[12]*i[11]-i[3]*i[8]*i[13]+i[3]*i[12]*i[9],a[10]=i[0]*i[5]*i[15]-i[0]*i[13]*i[7]-i[1]*i[4]*i[15]+i[1]*i[12]*i[7]+i[3]*i[4]*i[13]-i[3]*i[12]*i[5],a[11]=-i[0]*i[5]*i[11]+i[0]*i[9]*i[7]+i[1]*i[4]*i[11]-i[1]*i[8]*i[7]-i[3]*i[4]*i[9]+i[3]*i[8]*i[5],a[12]=-i[4]*i[9]*i[14]+i[4]*i[13]*i[10]+i[5]*i[8]*i[14]-i[5]*i[12]*i[10]-i[6]*i[8]*i[13]+i[6]*i[12]*i[9],a[13]=i[0]*i[9]*i[14]-i[0]*i[13]*i[10]-i[1]*i[8]*i[14]+i[1]*i[12]*i[10]+i[2]*i[8]*i[13]-i[2]*i[12]*i[9],a[14]=-i[0]*i[5]*i[14]+i[0]*i[13]*i[6]+i[1]*i[4]*i[14]-i[1]*i[12]*i[6]-i[2]*i[4]*i[13]+i[2]*i[12]*i[5],a[15]=i[0]*i[5]*i[10]-i[0]*i[9]*i[6]-i[1]*i[4]*i[10]+i[1]*i[8]*i[6]+i[2]*i[4]*i[9]-i[2]*i[8]*i[5];for(var n=i[0]*a[0]+i[1]*a[4]+i[2]*a[8]+i[3]*a[12],o=0;16>o;o++)a[o]/=n;return r},e.prototype.invert=function(){var t=this.determinant,e=Math.abs(t)>1e-11,r=this.rawData;if(e){t=1/t;var i=r[0],a=r[4],n=r[8],o=r[12],s=r[1],l=r[5],h=r[9],u=r[13],c=r[2],d=r[6],p=r[10],f=r[14],m=r[3],_=r[7],v=r[11],g=r[15];r[0]=t*(l*(p*g-f*v)-h*(d*g-f*_)+u*(d*v-p*_)),r[1]=-t*(s*(p*g-f*v)-h*(c*g-f*m)+u*(c*v-p*m)),r[2]=t*(s*(d*g-f*_)-l*(c*g-f*m)+u*(c*_-d*m)),r[3]=-t*(s*(d*v-p*_)-l*(c*v-p*m)+h*(c*_-d*m)),r[4]=-t*(a*(p*g-f*v)-n*(d*g-f*_)+o*(d*v-p*_)),r[5]=t*(i*(p*g-f*v)-n*(c*g-f*m)+o*(c*v-p*m)),r[6]=-t*(i*(d*g-f*_)-a*(c*g-f*m)+o*(c*_-d*m)),r[7]=t*(i*(d*v-p*_)-a*(c*v-p*m)+n*(c*_-d*m)),r[8]=t*(a*(h*g-u*v)-n*(l*g-u*_)+o*(l*v-h*_)),r[9]=-t*(i*(h*g-u*v)-n*(s*g-u*m)+o*(s*v-h*m)),r[10]=t*(i*(l*g-u*_)-a*(s*g-u*m)+o*(s*_-l*m)),r[11]=-t*(i*(l*v-h*_)-a*(s*v-h*m)+n*(s*_-l*m)),r[12]=-t*(a*(h*f-u*p)-n*(l*f-u*d)+o*(l*p-h*d)),r[13]=t*(i*(h*f-u*p)-n*(s*f-u*c)+o*(s*p-h*c)),r[14]=-t*(i*(l*f-u*d)-a*(s*f-u*c)+o*(s*d-l*c)),r[15]=t*(i*(l*p-h*d)-a*(s*p-h*c)+n*(s*d-l*c))}return e},e.prototype.makeTransform=function(e,r,i){this.createByScale(r.x,r.y,r.z),i.toMatrix3D(t.MathUtil.CALCULATION_MATRIX),this.append(t.MathUtil.CALCULATION_MATRIX),this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=1},e.prototype.recompose=function(e){return t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(e[1].x,e[1].y,e[1].z),this.makeTransform(e[0],e[2],t.MathUtil.CALCULATION_QUATERNION),!0},e.prototype.transformVector=function(e,r){void 0===r&&(r=null);var i=this.rawData;r||(r=new t.Vector3D);var a=e.x,n=e.y,o=e.z;return r.x=a*i[0]+n*i[4]+o*i[8]+i[12],r.y=a*i[1]+n*i[5]+o*i[9]+i[13],r.z=a*i[2]+n*i[6]+o*i[10]+i[14],r.w=a*i[3]+n*i[7]+o*i[11]+i[15],r},e.prototype.transformVector4=function(e,r){void 0===r&&(r=null);var i=this.rawData;r||(r=new t.Vector3D);var a=e.x,n=e.y,o=e.z,s=e.w;return r.x=a*i[0]+n*i[4]+o*i[8]+s*i[12],r.y=a*i[1]+n*i[5]+o*i[9]+s*i[13],r.z=a*i[2]+n*i[6]+o*i[10]+s*i[14],r.w=a*i[3]+n*i[7]+o*i[11]+s*i[15],r},e.prototype.mat3TransformVector=function(e,r){void 0===r&&(r=null);var i=this.rawData;r||(r=new t.Vector3D);var a=e.x,n=e.y,o=e.z;return r.x=a*i[0]+n*i[4]+o*i[8],r.y=a*i[1]+n*i[5]+o*i[9],r.z=a*i[2]+n*i[6]+o*i[10],r},e.prototype.transformPlane=function(r){var i=new e;i.copyFrom(this),i.invert(),i.transpose();var a=new t.Vector3D(r.a,r.b,r.c,r.d);a.copyFrom(i.transformVector(a));var n=new t.Plane3D;return n.a=a.x,n.b=a.y,n.c=a.z,n.d=a.w/Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),n},e.prototype.transpose=function(){for(var t=this.rawData,r=0;r<e.helpMatrix.rawData.length;r++)e.helpMatrix.rawData[r]=t[r];t[1]=e.helpMatrix.rawData[4],t[2]=e.helpMatrix.rawData[8],t[3]=e.helpMatrix.rawData[12],t[4]=e.helpMatrix.rawData[1],t[6]=e.helpMatrix.rawData[9],t[7]=e.helpMatrix.rawData[13],t[8]=e.helpMatrix.rawData[2],t[9]=e.helpMatrix.rawData[6],t[11]=e.helpMatrix.rawData[14],t[12]=e.helpMatrix.rawData[3],t[13]=e.helpMatrix.rawData[7],t[14]=e.helpMatrix.rawData[11]},e.getAxisRotation=function(t,r,i,a){var n,o,s=new e,l=a*(Math.PI/180),h=Math.cos(l),u=Math.sin(l),c=1-h;return s.rawData[0]=h+t*t*c,s.rawData[5]=h+r*r*c,s.rawData[10]=h+i*i*c,n=t*r*c,o=i*u,s.rawData[1]=n+o,s.rawData[4]=n-o,n=t*i*c,o=r*u,s.rawData[8]=n+o,s.rawData[2]=n-o,n=r*i*c,o=t*u,s.rawData[9]=n-o,s.rawData[6]=n+o,s},Object.defineProperty(e.prototype,"determinant",{get:function(){var t=this.rawData;return(t[0]*t[5]-t[4]*t[1])*(t[10]*t[15]-t[14]*t[11])-(t[0]*t[9]-t[8]*t[1])*(t[6]*t[15]-t[14]*t[7])+(t[0]*t[13]-t[12]*t[1])*(t[6]*t[11]-t[10]*t[7])+(t[4]*t[9]-t[8]*t[5])*(t[2]*t[15]-t[14]*t[3])-(t[4]*t[13]-t[12]*t[5])*(t[2]*t[11]-t[10]*t[3])+(t[8]*t[13]-t[12]*t[9])*(t[2]*t[7]-t[6]*t[3])},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"position",{get:function(){var e=this.rawData;return new t.Vector3D(e[12],e[13],e[14])},set:function(t){var e=this.rawData;e[12]=t.x,e[13]=t.y,e[14]=t.z},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){var e=this.rawData;return new t.Vector3D(e[0],e[5],e[10])},enumerable:!0,configurable:!0}),e.prototype.toString=function(){var t=this.rawData;return"matrix3d("+Math.round(1e3*t[0])/1e3+","+Math.round(1e3*t[1])/1e3+","+Math.round(1e3*t[2])/1e3+","+Math.round(1e3*t[3])/1e3+","+Math.round(1e3*t[4])/1e3+","+Math.round(1e3*t[5])/1e3+","+Math.round(1e3*t[6])/1e3+","+Math.round(1e3*t[7])/1e3+","+Math.round(1e3*t[8])/1e3+","+Math.round(1e3*t[9])/1e3+","+Math.round(1e3*t[10])/1e3+","+Math.round(1e3*t[11])/1e3+","+Math.round(1e3*t[12])/1e3+","+Math.round(1e3*t[13])/1e3+","+Math.round(1e3*t[14])/1e3+","+Math.round(1e3*t[15])/1e3+")"},e.prototype.lerp=function(t,e,r){this.copyFrom(e).sub(t).mult(r).add(t)},e.prototype.getMaxScaleOnAxis=function(){var t=this.rawData,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))},e}();e.helpMatrix=new e,e.helpMatrix2=new e,e.position_000=new t.Vector3D,e.scale_111=new t.Vector3D(1,1,1),e.prs=[new t.Vector3D,new t.Vector3D,new t.Vector3D],t.Matrix4_4=e,__reflect(e.prototype,"egret3d.Matrix4_4")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function t(){}return t.INIT_PROBS=function(t){for(var e=0;e<t.length;e++)t[e]=this.PROB_INIT_VAL},t.BitTreeReverseDecode=function(t,e,r,i){void 0===i&&(i=0);for(var a=1,n=0,o=0;e>o;o++){var s=r.decodeBit(t,i+a);a<<=1,a+=s,n|=s<<o}return n},t}();e.LZMA_DIC_MIN=4096,e.LZMA_RES_ERROR=0,e.LZMA_RES_FINISHED_WITH_MARKER=1,e.LZMA_RES_FINISHED_WITHOUT_MARKER=2,e.kNumBitModelTotalBits=11,e.kNumMoveBits=5,e.PROB_INIT_VAL=(1<<e.kNumBitModelTotalBits)/2,e.kNumPosBitsMax=4,e.kNumStates=12,e.kNumLenToPosStates=4,e.kNumAlignBits=4,e.kStartPosModelIndex=4,e.kEndPosModelIndex=14,e.kNumFullDistances=1<<(e.kEndPosModelIndex>>>1),e.kMatchMinLen=2,t.LZMAConfig=e,__reflect(e.prototype,"nid.LZMAConfig")}(nid||(nid={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){return r.call(this)||this}return __extends(i,r),i.prototype.onRender=function(){},i.prototype.onUpdate=function(){},i.prototype.onEvent=function(){},i.prototype.setStyle=function(e,r){if(this.instanceStyles||(this.instanceStyles={}),"string"==typeof r){var i=t.textureResMgr.getTexture(r);if(!i)return void console.log("未找到名为: "+r+" 的资源贴图");r=i}this.instanceStyles[e]!==r&&(this.instanceStyles[e]=r)},i.prototype.getStyle=function(t){return this.instanceStyles?this.instanceStyles[t]:this.getDefaultStyle(t)},i.prototype.getDefaultStyle=function(t){return e.GUISkinManager.instance.getDefaultSkin(this.getDefaultStyleNameByStyleName(t))},i.prototype.getDefaultStyleNameByStyleName=function(t){return""},i.mergeStyles=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r={},i=t.length,a=0;i>a;a++){var n=t[a];for(var o in n)null==r[o]&&(r[o]=t[a][o])}return r},i}(t.DisplayObject);r.defaultStyles={},e.UIElement=r,__reflect(r.prototype,"egret3d.gui.UIElement")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function e(t){this.numBits=t,this.probs=new Uint16Array(1<<this.numBits)}return e.prototype.init=function(){t.LZMAConfig.INIT_PROBS(this.probs)},e.prototype.decode=function(t){for(var e=1,r=0;r<this.numBits;r++)e=(e<<1)+t.decodeBit(this.probs,e);return e-(1<<this.numBits)},e.prototype.reverseDecode=function(e){return t.LZMAConfig.BitTreeReverseDecode(this.probs,this.numBits,e)},e.constructArray=function(t,r){for(var i=[],a=0;r>a;a++)i[a]=new e(t);return i},e}();t.BitTreeDecoder=e,__reflect(e.prototype,"nid.BitTreeDecoder")}(nid||(nid={}));var egret3d;!function(t){var e=function(){function e(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=r,this.w=i}return e.prototype.setTo=function(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),this.x=t,this.y=e,this.z=r,this.w=i},Object.defineProperty(e.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:!0,configurable:!0}),e.prototype.fromArray=function(t){this.x=-t[0],this.y=-t[1],this.z=t[2],this.w=t[3]},e.prototype.multiply=function(t,e){var r=t.w,i=t.x,a=t.y,n=t.z,o=e.w,s=e.x,l=e.y,h=e.z;this.w=r*o-i*s-a*l-n*h,this.x=r*s+i*o+a*h-n*l,this.y=r*l-i*h+a*o+n*s,this.z=r*h+i*l-a*s+n*o},e.prototype.multiplyVector=function(t,r){void 0===r&&(r=null),null===r&&(r=new e);var i=t.x,a=t.y,n=t.z;return r.w=-this.x*i-this.y*a-this.z*n,r.x=this.w*i+this.y*n-this.z*a,r.y=this.w*a-this.x*n+this.z*i,r.z=this.w*n+this.x*a-this.y*i,r},e.prototype.fromAxisAngle=function(t,e){e*=Math.PI/180;var r=.5*e,i=Math.sin(r);this.w=Math.cos(r),this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.normalize()},e.prototype.toAxisAngle=function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,r=0;return e>0?(r=2*Math.acos(this.w),e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e):(r=0,t.x=1,t.y=0,t.z=0),r/=Math.PI/180},e.prototype.slerp=function(t,e,r){var i=t.w,a=t.x,n=t.y,o=t.z,s=e.w,l=e.x,h=e.y,u=e.z,c=i*s+a*l+n*h+o*u;if(0>c&&(c=-c,s=-s,l=-l,h=-h,u=-u),.95>c){var d=Math.acos(c),p=1/Math.sin(d),f=Math.sin(d*(1-r))*p,m=Math.sin(d*r)*p;this.w=i*f+s*m,this.x=a*f+l*m,this.y=n*f+h*m,this.z=o*f+u*m}else{this.w=i+r*(s-i),this.x=a+r*(l-a),this.y=n+r*(h-n),this.z=o+r*(u-o);var _=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=_,this.x*=_,this.y*=_,this.z*=_}},e.prototype.lerp=function(t,e,r){var i,a=t.w,n=t.x,o=t.y,s=t.z,l=e.w,h=e.x,u=e.y,c=e.z;0>a*l+n*h+o*u+s*c&&(l=-l,h=-h,u=-u,c=-c),this.w=a+r*(l-a),this.x=n+r*(h-n),this.y=o+r*(u-o),this.z=s+r*(c-s),i=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z),this.w*=i,this.x*=i,this.y*=i,this.z*=i},e.prototype.fromEulerAngles=function(e,r,i){e*=t.MathUtil.DEGREES_TO_RADIANS,r*=t.MathUtil.DEGREES_TO_RADIANS,i*=t.MathUtil.DEGREES_TO_RADIANS;var a=.5*e,n=.5*r,o=.5*i,s=Math.cos(a),l=Math.sin(a),h=Math.cos(n),u=Math.sin(n),c=Math.cos(o),d=Math.sin(o);return this.w=s*h*c+l*u*d,this.x=l*h*c-s*u*d,this.y=s*u*c+l*h*d,this.z=s*h*d-l*u*c,this},e.prototype.toEulerAngles=function(e){void 0===e&&(e=null),null===e&&(e=new t.Vector3D),e.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));var r=2*(this.w*this.y-this.z*this.x);return r=t.MathUtil.clampf(r,-1,1),e.y=Math.asin(r),e.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z)),e.x/=t.MathUtil.DEGREES_TO_RADIANS,e.y/=t.MathUtil.DEGREES_TO_RADIANS,e.z/=t.MathUtil.DEGREES_TO_RADIANS,e},e.prototype.normalize=function(t){void 0===t&&(t=1);var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e},e.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"},e.prototype.toMatrix3D=function(e){void 0===e&&(e=null);var r=this.x,i=this.y,a=this.z,n=this.w,o=t.MathUtil.RAW_DATA_CONTAINER,s=2*r*i,l=2*r*a,h=2*r*n,u=2*i*a,c=2*i*n,d=2*a*n,p=r*r,f=i*i,m=a*a,_=n*n;return o[0]=p-f-m+_,o[4]=s-d,o[8]=l+c,o[12]=0,o[1]=s+d,o[5]=-p+f-m+_,o[9]=u-h,o[13]=0,o[2]=l-c,o[6]=u+h,o[10]=-p-f+m+_,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1,e?(e.copyRawDataFrom(o),e):new t.Matrix4_4(new Float32Array(o))},e.prototype.fromMatrix=function(e){var r=e.decompose(t.Orientation3D.QUATERNION)[1];this.x=r.x,this.y=r.y,this.z=r.z,this.w=r.w},e.prototype.inverse=function(t){void 0===t&&(t=null),t||(t=new e);var r=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;if(r>0){var i=1/r;t.w=this.w*i,t.x=-this.x*i,t.y=-this.y*i,t.z=-this.z*i}return t},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.transformVector=function(e,r){void 0===r&&(r=null);var i,a,n,o,s=e.x,l=e.y,h=e.z;return null===r&&(r=new t.Vector3D),o=-this.x*s-this.y*l-this.z*h,i=this.w*s+this.y*h-this.z*l,a=this.w*l-this.x*h+this.z*s,n=this.w*h+this.x*l-this.y*s,r.x=-o*this.x+i*this.w-a*this.z+n*this.y,r.y=-o*this.y+i*this.z+a*this.w-n*this.x,r.z=-o*this.z-i*this.y+a*this.x+n*this.w,r},e.prototype.fromToRotation=function(e,r){var i=new t.Matrix4_4;t.Matrix4_4.fromToRotation(e,r,i),this.fromMatrix(i)},e.fromToRotation=function(t,r,i){return void 0===i&&(i=null),i||(i=new e),i.fromToRotation(t,r),i},e.prototype.copyFrom=function(t){var e=this;e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},e}();e.HELP_0=new e,e.HELP_1=new e,e.HELP_2=new e,t.Quaternion=e,__reflect(e.prototype,"egret3d.Quaternion")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function t(){this.out_pos=0}return t.prototype.create=function(t){this.buf=new Uint8Array(t),this.pos=0,this.size=t,this.isFull=!1,this.totalPos=0},t.prototype.putByte=function(t){this.totalPos++,this.buf[this.pos++]=t,this.pos==this.size&&(this.pos=0,this.isFull=!0),this.outStream[this.out_pos++]=t},t.prototype.getByte=function(t){return this.buf[t<=this.pos?this.pos-t:this.size-t+this.pos]},t.prototype.copyMatch=function(t,e){for(;e>0;e--)this.putByte(this.getByte(t))},t.prototype.checkDistance=function(t){return t<=this.pos||this.isFull},t.prototype.isEmpty=function(){return 0==this.pos&&!this.isFull},t}();t.OutWindow=e,__reflect(e.prototype,"nid.OutWindow")}(nid||(nid={}));var egret3d;!function(t){var e;!function(t){t[t.BoundPick=0]="BoundPick",t[t.PositionPick=1]="PositionPick",t[t.UVPick=2]="UVPick"}(e=t.PickType||(t.PickType={}));var r;!function(t){t[t.DISABLE=0]="DISABLE",t[t.X_AXIS=1]="X_AXIS",t[t.Y_AXIS=2]="Y_AXIS",t[t.Z_AXIS=3]="Z_AXIS",t[t.STANDARD=4]="STANDARD"}(r=t.BillboardType||(t.BillboardType={}));var i=function(i){function a(){var n=i.call(this)||this;return n._modelMatrix3D=new t.Matrix4_4,n._localMatrix3D=new t.Matrix4_4,n._transformChange=!0,n._pos=new t.Vector3D,n._rot=new t.Vector3D,n._sca=new t.Vector3D(1,1,1),n._orientation=new t.Quaternion,n._axis=new t.Vector3D,n._angle=0,n._globalPos=new t.Vector3D,n._globalRot=new t.Vector3D,n._globalSca=new t.Vector3D(1,1,1),n._globalOrientation=new t.Quaternion,n._qut=new t.Quaternion,n._vec=new t.Vector3D,n._active=!1,n._isRoot=!0,n.inFrustum=!1,n.billboard=r.DISABLE,n.renderLayer=0,n.name="",n.id=0,n.layer=0,n.tag=new t.Tag,n.parent=null,n.childs=new Array,n.isController=!0,n.visible=!0,n.pickType=e.BoundPick,n.pickResult=new t.PickResult,n.enablePick=!1,n.mouseChildren=!1,n.enableCulling=!0,n.id=++a.s_id,n._modelMatrix3D.identity(),n}return __extends(a,i),Object.defineProperty(a.prototype,"proAnimation",{get:function(){return this._proAnimation},set:function(t){this.setProAnimation(t)},enumerable:!0,configurable:!0}),a.prototype.setProAnimation=function(t){this._proAnimation=t,this._proAnimation&&(this._proAnimation.propertyAnimController.target=this)},Object.defineProperty(a.prototype,"bound",{get:function(){return this._bound},set:function(t){this._bound!=t&&(this._bound&&this._bound.dispose(),this._bound=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"currentBound",{get:function(){return this.mouseChildren?this.bound.childBound:this.bound},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"position",{get:function(){return this._pos},set:function(t){(this._pos.x!=t.x||this._pos.y!=t.y||this._pos.z!=t.z)&&(this.updateTransformChange(!0),this._pos.copyFrom(t))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rot},set:function(t){(this._rot.x!=t.x||this._rot.y!=t.y||this._rot.z!=t.z)&&(this._rot.x=t.x,this._rot.y=t.y,this._rot.z=t.z,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientation",{get:function(){return this._orientation},set:function(t){(this._orientation.x!=t.x||this._orientation.y!=t.y||this._orientation.z!=t.z||this._orientation.w!=t.w)&&(this._orientation.copyFrom(t),this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationX",{set:function(t){this._orientation.x!=t&&(this._orientation.x=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationY",{set:function(t){this._orientation.y!=t&&(this._orientation.y=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationZ",{set:function(t){this._orientation.z!=t&&(this._orientation.z=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationW",{set:function(t){this._orientation.w!=t&&(this._orientation.w=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this._sca},set:function(t){(this._sca.x!=t.x||this._sca.y!=t.y||this._sca.z!=t.z)&&(this.updateTransformChange(!0),this._sca=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"x",{get:function(){return this._pos.x},set:function(t){this._pos.x!=t&&(this._pos.x=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return this._pos.y},set:function(t){this._pos.y!=t&&(this._pos.y=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"z",{get:function(){return this._pos.z},set:function(t){this._pos.z!=t&&(this._pos.z=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){this._rot.x!=t&&(this._rot.x=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){this._rot.y!=t&&(this._rot.y=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){this._rot.z!=t&&(this._rot.z=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){this._sca.x!=t&&(this._sca.x=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){this._sca.y!=t&&(this._sca.y=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleZ",{get:function(){return this._sca.z},set:function(t){this._sca.z!=t&&(this._sca.z=t,this.updateTransformChange(!0))},enumerable:!0,configurable:!0}),a.prototype.setRotationFromAxisAngle=function(t,e){t.normalize(),this.updateTransformChange(!0),this._orientation.fromAxisAngle(t,e),this._orientation.toEulerAngles(this._rot),this._axis.copyFrom(t),this._angle=e},Object.defineProperty(a.prototype,"modelMatrix",{get:function(){return this._transformChange&&this.updateModelMatrix(),this._modelMatrix3D},set:function(e){var r=e.decompose(t.Orientation3D.QUATERNION);this.globalPosition=r[0],t.MathUtil.CALCULATION_QUATERNION.x=r[1].x,t.MathUtil.CALCULATION_QUATERNION.y=r[1].y,t.MathUtil.CALCULATION_QUATERNION.z=r[1].z,t.MathUtil.CALCULATION_QUATERNION.w=r[1].w,this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION,this.globalScale=r[2]},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"localMatrix",{get:function(){return this.modelMatrix,this._localMatrix3D},set:function(e){var r=e.decompose(t.Orientation3D.QUATERNION);this.position=r[0],a.qua0.setTo(r[1].x,r[1].y,r[1].z,r[1].w),this.orientation=a.qua0,this.scale=r[2]},enumerable:!0,configurable:!0}),a.prototype.updateModelMatrix=function(){if(null!=this.parent){var t=this.parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation),this._globalOrientation.toEulerAngles(this._globalRot);var e=this.parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca,a.v0)),t.transformVector(e.multiply(this._pos,a.v0),this._globalPos),this._globalPos.copyFrom(this._globalPos.add(this.parent.globalPosition,a.v0))}else this._globalOrientation.copyFrom(this._orientation),this._globalPos.copyFrom(this._pos),this._globalSca.copyFrom(this._sca),this._globalRot.copyFrom(this._rot);this.onMakeTransform(),this._transformChange=!1,this.onUpdateTransform()},a.prototype.onUpdateTransform=function(){},a.prototype.onMakeTransform=function(){this._localMatrix3D.makeTransform(this._pos,this._sca,this._orientation),this._modelMatrix3D.makeTransform(this._globalPos,this._globalSca,this._globalOrientation)},Object.defineProperty(a.prototype,"globalX",{get:function(){return this.globalPosition.x},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.x=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalY",{get:function(){return this.globalPosition.y},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.y=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalZ",{get:function(){return this.globalPosition.z},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.z=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalPosition",{get:function(){return this._transformChange&&this.modelMatrix,this._globalPos},set:function(t){this.parent?(this.parent.globalOrientation.inverse(this._qut),t.subtract(this.parent.globalPosition,this._vec),this._qut.transformVector(this._vec,this._vec),this._vec.divided(this.parent.globalScale,this._vec),this.position=this._vec):this.position=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationX",{get:function(){return this.globalRotation.x},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.x=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationY",{get:function(){return this.globalRotation.y},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.y=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationZ",{get:function(){return this.globalRotation.z},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.z=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalRot},set:function(e){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(e.x,e.y,e.z),this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScale",{get:function(){return this._transformChange&&this.modelMatrix,this._globalSca},set:function(t){this.parent?(t.divided(this.parent.globalScale,this._vec),this.scale=this._vec):this.scale=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleX",{get:function(){return this.globalScale.x},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.x=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleY",{get:function(){return this.globalScale.y},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.y=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleZ",{get:function(){return this.globalScale.z},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.z=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalOrientation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalOrientation},set:function(t){this.parent?(this.parent.globalOrientation.inverse(this._qut),this._qut.multiply(this._qut,t),this.orientation=this._qut):this.orientation=t},enumerable:!0,configurable:!0}),a.prototype.addChild=function(t){return t.parent&&t.parent.removeChild(t),this.childs.indexOf(t)>=0&&this.removeChild(t),this.childs.push(t),t.parent=this,t._isRoot=!1,t.updateTransformChange(!0),t},a.prototype.addChildAt=function(t,e){return 0>e?this.childs.splice(0,0,t):e>=this.childs.length?this.childs.push(t):this.childs.splice(e,0,t),t.parent=this,t.updateTransformChange(!0),t},a.prototype.getChildAt=function(t){return 0>t||t>=this.childs.length?null:this.childs[t]},a.prototype.addFollowUI=function(t){this._displayList=this._displayList||[];var e=this._displayList.indexOf(t);-1==e&&this._displayList.push(t)},a.prototype.removeFollowUI=function(t){if(this._displayList){var e=this._displayList.indexOf(t);e>=0&&this._displayList.splice(e,1)}},a.prototype.getChildIndex=function(t){for(var e=0;e<this.childs.length;++e)if(this.childs[e]==t)return e;return-1},a.prototype.getChild=function(t){return t>=0&&t<this.childs.length?this.childs[t]:null},a.prototype.removeChild=function(t){var e=this.childs.indexOf(t);return 0>e?null:(t.parent=null,this.childs.splice(e,1),t.updateTransformChange(!0),t)},a.prototype.removeChildAt=function(t){if(0>t||t>=this.childs.length)return null;var e=this.childs[t];return e.parent=null,this.childs.splice(t,1),e.updateTransformChange(!0),e},a.prototype.removeAllChild=function(){for(;this.childs.length>0;)this.removeChild(this.childs[0])},a.prototype.setChildIndex=function(t,e){for(var r=0;r<this.childs.length;++r)if(this.childs[r]==t){if(r==e)return;if(e>r)for(var i=r;i>e;--i)this.childs[i]=this.childs[i-1];else if(r>e)for(var i=r;e>i;++i)this.childs[i]=this.childs[i+1];return void(this.childs[e]=t)}},a.prototype.swapObject=function(t){t.parent;if(this.parent){var e=this.parent.getChildIndex(this),r=this.parent;r.removeChildAt(e),r.addChildAt(t,e)}for(var i=[];this.childs.length>0;)i.push(this.childs[0]),this.removeChild(this.childs[0]);
for(var a=0;a<i.length;++a)t.addChild(i[a]);this.updateTransformChange(!0),t.updateTransformChange(!0)},a.prototype.swapObjectAndChilds=function(t){for(var e=t.parent,r=new Array,i=0;i<t.childs.length;++i)r[i]=t.childs[i];if(this.parent){var a=this.parent.getChildIndex(this);this.parent.childs[a]=t}if(t.parent){var a=t.parent.getChildIndex(t);t.parent.childs[a]=this}t.parent=this.parent,this.parent=e,t.childs.length=0;for(var i=0;i<this.childs.length;++i)t.childs[i]=this.childs[i],t.childs[i].parent=t;this.childs.length=0;for(var i=0;i<r.length;++i)this.childs[i]=r[i],this.childs[i].parent=this;this.updateTransformChange(!0),t.updateTransformChange(!0)},a.prototype.swapChildren=function(t,e){for(var r=0,i=0;r<this.childs.length;++r)if(this.childs[r]==t){for(;i<this.childs.length;++i)if(this.childs[i]==e){var a=this.childs[r];this.childs[r]=this.childs[i],this.childs[i]=a;break}return}},a.prototype.swapChildrenAt=function(t,e){if(!(0>t||t>=this.childs.length||0>e||e>=this.childs.length)){var r=this.childs[t];this.childs[t]=this.childs[e],this.childs[e]=r}},a.prototype.lookAt=function(e,r,i){void 0===i&&(i=t.Vector3D.Y_AXIS),this.globalPosition=e,t.MathUtil.CALCULATION_MATRIX.lookAt(e,r,i),t.MathUtil.CALCULATION_MATRIX.invert();var a=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=a[1].x,t.MathUtil.CALCULATION_QUATERNION.y=a[1].y,t.MathUtil.CALCULATION_QUATERNION.z=a[1].z,t.MathUtil.CALCULATION_QUATERNION.w=a[1].w,this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION},a.prototype.lookAtLocal=function(e,r,i){void 0===i&&(i=t.Vector3D.Y_AXIS),this.position=e,t.MathUtil.CALCULATION_MATRIX.lookAt(e,r,i),t.MathUtil.CALCULATION_MATRIX.invert();var a=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=a[1].x,t.MathUtil.CALCULATION_QUATERNION.y=a[1].y,t.MathUtil.CALCULATION_QUATERNION.z=a[1].z,t.MathUtil.CALCULATION_QUATERNION.w=a[1].w,this.orientation=t.MathUtil.CALCULATION_QUATERNION},a.prototype.lookAtTarget=function(e){t.MathUtil.CALCULATION_MATRIX.lookAt(this.globalPosition,e.globalPosition,t.Vector3D.Y_AXIS),t.MathUtil.CALCULATION_MATRIX.invert();var r=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=r[1].x,t.MathUtil.CALCULATION_QUATERNION.y=r[1].y,t.MathUtil.CALCULATION_QUATERNION.z=r[1].z,t.MathUtil.CALCULATION_QUATERNION.w=r[1].w,this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION},a.prototype.lookAtTargetLocal=function(e){t.MathUtil.CALCULATION_MATRIX.lookAt(this.position,e.position,t.Vector3D.Y_AXIS),t.MathUtil.CALCULATION_MATRIX.invert();var r=t.MathUtil.CALCULATION_MATRIX.decompose(t.Orientation3D.QUATERNION);t.MathUtil.CALCULATION_QUATERNION.x=r[1].x,t.MathUtil.CALCULATION_QUATERNION.y=r[1].y,t.MathUtil.CALCULATION_QUATERNION.z=r[1].z,t.MathUtil.CALCULATION_QUATERNION.w=r[1].w,this.orientation=t.MathUtil.CALCULATION_QUATERNION},a.prototype.findObject3D=function(t){for(var e=null,r=0;r<this.childs.length;++r){if(this.childs[r].name==t)return e=this.childs[r];if(e=this.childs[r].findObject3D(t))return e}return e},a.prototype.findObject3DToID=function(t){for(var e=null,r=0;r<this.childs.length;++r){if(this.childs[r].id==t)return e=this.childs[r];if(e=this.childs[r].findObject3DToID(t))return e}return e},a.prototype.updateTransformChange=function(t){this._transformChange=t;for(var e=0;e<this.childs.length;++e)this.childs[e].updateTransformChange(t)},a.prototype.update=function(e,r,i){if(this.inFrustum&&this.proAnimation&&this.proAnimation.update(e,r,null),this._displayList)for(var a=0;a<this._displayList.length;a++)i.object3DToScreenRay(this.globalPosition,t.Vector3D.HELP_0),this._displayList[a].x=t.Vector3D.HELP_0.x,this._displayList[a].y=t.Vector3D.HELP_0.y},a.prototype.dispose=function(){i.prototype.dispose.call(this);for(var t=0;t<this.childs.length;t++)this.childs[t].dispose();this.removeAllChild()},Object.defineProperty(a.prototype,"root",{get:function(){return this.parent?this.parent.root:this},enumerable:!0,configurable:!0}),a.prototype.copy=function(t){this.position=t.position,this.rotation=t.rotation,this.scale=t.scale,this.visible=t.visible,this.name=t.name},a.prototype.clone=function(){var t=new a;return t.copy(this),t},a.prototype.deepClone=function(){for(var t=this.clone(),e=0;e<this.childs.length;++e)t.addChild(this.childs[e].deepClone());return t},a}(t.EventDispatcher);i.s_id=0,i.qua0=new t.Quaternion,i.mat0=new t.Matrix4_4,i.v0=new t.Vector3D,i.v1=new t.Vector3D,i.v2=new t.Vector3D,t.Object3D=i,__reflect(i.prototype,"egret3d.Object3D")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function t(){this.rangeI=0,this.codeI=1,this.loc1=2,this.loc2=3,this.in_pos=13}return t.prototype.isFinishedOK=function(){return 0==this.U32[this.codeI]},t.prototype.init=function(){this.U32=new Uint32Array(4),this.U16=new Uint16Array(4),this.corrupted=!1,0!=this.inStream[this.in_pos++]&&(this.corrupted=!0),this.U32[this.rangeI]=4294967295,this.U32[this.codeI]=0;for(var t=0;4>t;t++)this.U32[this.codeI]=this.U32[this.codeI]<<8|this.inStream[this.in_pos++];this.U32[this.codeI]==this.U32[this.rangeI]&&(this.corrupted=!0)},t.prototype.normalize=function(){this.U32[this.rangeI]<t.kTopValue&&(this.U32[this.rangeI]<<=8,this.U32[this.codeI]=this.U32[this.codeI]<<8|this.inStream[this.in_pos++])},t.prototype.decodeDirectBits=function(t){this.U32[this.loc1]=0;do this.U32[this.rangeI]>>>=1,this.U32[this.codeI]-=this.U32[this.rangeI],this.U32[this.loc2]=0-(this.U32[this.codeI]>>>31),this.U32[this.codeI]+=this.U32[this.rangeI]&this.U32[this.loc2],this.U32[this.codeI]==this.U32[this.rangeI]&&(this.corrupted=!0),this.normalize(),this.U32[this.loc1]<<=1,this.U32[this.loc1]+=this.U32[this.loc2]+1;while(--t);return this.U32[this.loc1]},t.prototype.decodeBit=function(t,e){return this.U16[0]=t[e],this.U32[2]=(this.U32[0]>>>11)*this.U16[0],this.U32[1]<this.U32[2]?(this.U16[0]+=2048-this.U16[0]>>>5,this.U32[0]=this.U32[2],this.U16[1]=0):(this.U16[0]-=this.U16[0]>>>5,this.U32[1]-=this.U32[2],this.U32[0]-=this.U32[2],this.U16[1]=1),t[e]=this.U16[0],this.U32[0]<16777216&&(this.U32[0]<<=8,this.U32[1]=this.U32[1]<<8|this.inStream[this.in_pos++]),this.U16[1]},t}();e.kTopValue=1<<24,t.RangeDecoder=e,__reflect(e.prototype,"nid.RangeDecoder")}(nid||(nid={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){var e=r.call(this)||this;return e._skin=new t.Quad,e.addChild(e._skin),e._state=i.STATE_UP,e._enable=!0,e._isDowning=!1,e.addEventListener(t.MouseEvent3D.MOUSE_DOWN,e.mouseEventHandler,e),e.addEventListener(t.MouseEvent3D.MOUSE_OUT,e.mouseEventHandler,e),e.addEventListener(t.MouseEvent3D.MOUSE_OVER,e.mouseEventHandler,e),e.drawBackground(),e}return __extends(i,r),i.prototype.getDefaultStyleNameByStyleName=function(t){var r={down:e.DefaultSkinName.DEFAULT_BUTTON_DOWN,up:e.DefaultSkinName.DEFAULT_BUTTON_UP,over:e.DefaultSkinName.DEFAULT_BUTTON_OVER,disable:e.DefaultSkinName.DEFAULT_BUTTON_DISABLE},i=r[t];return i||console.log(" ERROR!!! UIButton can't find default style : ",t),i},Object.defineProperty(i.prototype,"width",{get:function(){return this._skin.width},set:function(t){this._skin.width=t,this.onRender()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._skin.height},set:function(t){this._skin.height=t,this.onRender()},enumerable:!0,configurable:!0}),i.prototype.setStyle=function(t,e){r.prototype.setStyle.call(this,t,e),this.onRender()},i.prototype.mouseEventHandler=function(e){this._enable&&(e.eventType===t.MouseEvent3D.MOUSE_DOWN?this.startPress():e.eventType===t.MouseEvent3D.MOUSE_UP?this.endPress():e.eventType===t.MouseEvent3D.MOUSE_OUT?this.mouseOut():e.eventType===t.MouseEvent3D.MOUSE_OVER)},i.prototype.mouseOut=function(){this.setMouseState(i.STATE_UP)},i.prototype.mouseOver=function(){this._isDowning?this.setMouseState(i.STATE_DOWN):this.setMouseState(i.STATE_OVER)},i.prototype.startPress=function(){this.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this),this.stage&&this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this),this._isDowning=!0,this.setMouseState(i.STATE_DOWN)},i.prototype.onStageEnd=function(e){this.stage&&this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this),this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this),this.setMouseState(i.STATE_UP),this._isDowning=!1},i.prototype.endPress=function(){this.setMouseState(i.STATE_UP),this._isDowning=!1,this.stage&&this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onStageEnd,this),this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseEventHandler,this)},Object.defineProperty(i.prototype,"enable",{get:function(){return this._enable},set:function(t){this._enable=t,this.mouseEnable=t},enumerable:!0,configurable:!0}),i.prototype.setMouseState=function(t){this._state!==t&&(this._state=t,this.onRender())},i.prototype.onRender=function(){this.drawBackground()},i.prototype.drawBackground=function(){var t=this.enable?this.getStyle(this._state):this.getStyle(i.STATE_DISABLE);this._skin.texture=t},i}(e.UIElement);r.STATE_DOWN="down",r.STATE_UP="up",r.STATE_OVER="over",r.STATE_DISABLE="disable",e.UIButton=r,__reflect(r.prototype,"egret3d.gui.UIButton")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function e(){this.lowCoder=t.BitTreeDecoder.constructArray(3,1<<t.LZMAConfig.kNumPosBitsMax),this.midCoder=t.BitTreeDecoder.constructArray(3,1<<t.LZMAConfig.kNumPosBitsMax),this.highCoder=new t.BitTreeDecoder(8)}return e.prototype.init=function(){this.choice=[t.LZMAConfig.PROB_INIT_VAL,t.LZMAConfig.PROB_INIT_VAL],this.highCoder.init();for(var e=0;e<1<<t.LZMAConfig.kNumPosBitsMax;e++)this.lowCoder[e].init(),this.midCoder[e].init()},e.prototype.decode=function(t,e){return 0==t.decodeBit(this.choice,0)?this.lowCoder[e].decode(t):0==t.decodeBit(this.choice,1)?8+this.midCoder[e].decode(t):16+this.highCoder.decode(t)},e}();t.LenDecoder=e,__reflect(e.prototype,"nid.LenDecoder")}(nid||(nid={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.incrementBy=function(t){this.x+=t.x,this.y+=t.y},t.prototype.setTo=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x+=t,this.y+=e},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},t.prototype.normalize=function(t){void 0===t&&(t=1);var e=this.length;if(0!=e){var r=t/e;return this.x*=r,void(this.y*=r)}throw"Cannot divide by zero length."},t.prototype.offset=function(t,e){this.x+=t,this.y+=e},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.toString=function(){return"[Point] (x="+this.x+", y="+this.y+")"},t.distance=function(t,e){var r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)},t}();t.Point=e,__reflect(e.prototype,"egret3d.Point")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.border=0,this.imageData=null}return e.prototype.dispose=function(){this.textureBuffer&&(t.Context3DProxy.gl.deleteTexture(this.textureBuffer),this.textureBuffer=null),this.frameBuffer&&(t.Context3DProxy.gl.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.renderbuffer&&(t.Context3DProxy.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null)},e}();t.ContextTexture2D=e,__reflect(e.prototype,"egret3d.ContextTexture2D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.count=0}return t.prototype.incRef=function(){this.count++},t.prototype.decRef=function(){this.count-1>=0&&this.count--},Object.defineProperty(t.prototype,"isDispose",{get:function(){return this.count<=0},enumerable:!0,configurable:!0}),t}();t.Reference=e,__reflect(e.prototype,"egret3d.Reference")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){this._data=t,this._mapConfigParser=e,this._versionParser=null}return t.prototype.parser=function(){},t.prototype.parseTexture=function(t){},t.prototype.parseMethod=function(t){return null},t.prototype.parseMat=function(t){return null},t.prototype.parseNode=function(t){return null},t.prototype.parseEnvironment=function(t){},t.prototype.parseHud=function(t){return null},t.prototype.parseLight=function(t){return null},t}();t.UnitParser=e,__reflect(e.prototype,"egret3d.UnitParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.zIndex=-1,e.type="",e._multiMaterial={},e._materialCount=0,e.animation=null,e}return __extends(e,t),Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},set:function(t){this._geometry!=t&&(t&&t.incRef(),this._geometry&&this._geometry.dispose(),this._geometry=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"drawOrder",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){this._lightGroup=t;for(var e in this.multiMaterial)this.multiMaterial[e].lightGroup=this._lightGroup},enumerable:!0,configurable:!0}),e.prototype.addSubMaterial=function(t,e){this._multiMaterial[t]||this._materialCount++,this.setSubMaterial(t,e)},e.prototype.setSubMaterial=function(t,e){this._multiMaterial[t]=e,e||this.removeSubMaterial(t),0==t&&(this._material=e),e&&(e.lightGroup=this._lightGroup)},e.prototype.removeSubMaterial=function(t){this._multiMaterial[t]&&(delete this._multiMaterial[t],this._materialCount--)},e.prototype.getMaterial=function(t){return this._multiMaterial[t]},Object.defineProperty(e.prototype,"materialCount",{get:function(){return this._materialCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._multiMaterial[0]?this.setSubMaterial(0,t):this.addSubMaterial(0,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"multiMaterial",{get:function(){return this._multiMaterial},set:function(t){this._multiMaterial=t,this._materialCount=0;for(var e in t)this._materialCount++},enumerable:!0,configurable:!0}),e.prototype.update=function(e,r,i){t.prototype.update.call(this,e,r,i),this.inFrustum&&this.animation&&this.animation.update(e,r,this.geometry),this.geometry.subGeometrys.length<=0&&this.geometry.buildDefaultSubGeometry()},e.prototype.dispose=function(){t.prototype.dispose.call(this),this._bound&&(this._bound.dispose(),this._bound=null),this.geometry=null,this.multiMaterial={}},e}(t.Object3D);e.TYPE_MESH="mesh",e.TYPE_PARTICLE_EMIT="particleEmit",e.TYPE_WIREFRAME="wireframe",t.IRender=e,__reflect(e.prototype,"egret3d.IRender")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.url="",t._dataformat=null,t.data=null,t.taskTotal=0,t.taskCurrent=0,t.currentProgress=0,t.resourceName="",t}return __extends(r,e),Object.defineProperty(r.prototype,"dataformat",{get:function(){return this._dataformat},set:function(t){this._dataformat=t},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){e.prototype.dispose.call(this)},r.prototype.processFileFormat=function(){var e=t.StringUtil.getFileFormat(this.url);switch(e){case"rar":this._dataformat=r.DATAFORMAT_BINARY;case"7z":this._dataformat=r.DATAFORMAT_BINARY;case"lzma":this._dataformat=r.DATAFORMAT_BINARY;break;case"dds":this._dataformat=r.DATAFORMAT_DDS;break;case"tga":this._dataformat=r.DATAFORMAT_TGA;break;case"bmp":this._dataformat=r.DATAFORMAT_BITMAP;break;case"png":this._dataformat=r.DATAFORMAT_BITMAP;break;case"jpg":this._dataformat=r.DATAFORMAT_BITMAP;break;case"hdr":this._dataformat=r.DATAFORMAT_HDR;break;case"glsl":this._dataformat=r.DATAFORMAT_TEXT;break;case"pvr":this._dataformat=r.DATAFORMAT_PVR;break;case"esm":this._dataformat=r.DATAFORMAT_ESM;break;case"eam":this._dataformat=r.DATAFORMAT_EAM;break;case"e3dpack":this._dataformat=r.DATAFORMAT_E3DPACK;break;case"eum":this._dataformat=t.URLLoader.DATAFORMAT_EUM;break;case"eca":this._dataformat=r.DATAFORMAT_ECA;break;case"epa":this._dataformat=r.DATAFORMAT_EPA;break;case"json":this._dataformat=r.DATAFORMAT_JSON;break;case"xml":this._dataformat=r.DATAFORMAT_XML}},r}(t.EventDispatcher);e.DATAFORMAT_BINARY="binary",e.DATAFORMAT_TEXT="text",e.DATAFORMAT_SOUND="sound",e.DATAFORMAT_BITMAP="bitmap",e.DATAFORMAT_DDS="dds",e.DATAFORMAT_TGA="tga",e.DATAFORMAT_ESM="esm",e.DATAFORMAT_EAM="eam",e.DATAFORMAT_E3DPACK="e3dpack",e.DATAFORMAT_EUM="eum",e.DATAFORMAT_ECA="eca",e.DATAFORMAT_EPA="epa",e.DATAFORMAT_PVR="pvr",e.DATAFORMAT_HDR="hdr",e.DATAFORMAT_JSON="json",e.DATAFORMAT_XML="xml",t.ILoader=e,__reflect(e.prototype,"egret3d.ILoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=0,this.y=0,this.width=0,this.height=0,this.x=t,this.y=e,this.width=r,this.height=i}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.copyTo=function(t){t.copyFrom(this)},t.prototype.inner=function(t,e){return t<this.x||t>this.x+this.width||e<this.y||e>this.y+this.height?!1:!0},t.pointInRect=function(t,e,r,i,a,n){return r>t||t>a||i>e||e>n?!1:!0},t.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.width!=t.width||this.height!=t.height)},t.prototype.equalArea=function(t,e,r,i){return!(this.x!=t||this.y!=e||this.width!=r||this.height!=i)},t.prototype.equalInnerArea=function(t,e){var r=this.x,i=this.y,a=this.x+this.width,n=this.y+this.height,o=t.x,s=t.y,l=t.x+t.width,h=t.y+t.height;return Math.max(r,o)<=Math.min(a,l)&&Math.max(i,s)<=Math.min(n,h)?!0:!1},t.prototype.innerArea=function(e,r){r=r||new t;var i=this.x,a=this.y,n=this.x+this.width,o=this.y+this.height,s=e.x,l=e.y,h=e.x+e.width,u=e.y+e.height,c=Math.max(a,l),d=Math.min(o,u),p=Math.max(i,s),f=Math.min(h,n);return c>=0&&d>=0&&d-c>=0&&f-p>0?(r.x=p,r.y=c,r.width=f-p,r.height=d-c):(r.x=0,r.y=0,r.width=0,r.height=0),r},t.prototype.setTo=function(t,e,r,i){this.x=t,this.y=e,this.width=r,this.height=i},t}();t.Rectangle=e,__reflect(e.prototype,"egret3d.Rectangle")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.time=0,this.delay=0,this._stopImmediatePropagation=!1,this.eventType=t,this.data=e}return t.prototype.stopImmediatePropagation=function(){this._stopImmediatePropagation=!0},t.prototype.reset=function(){this._stopImmediatePropagation=!1},Object.defineProperty(t.prototype,"isStopImmediatePropagation",{get:function(){return this._stopImmediatePropagation},enumerable:!0,configurable:!0}),t}();e.ENTER_FRAME="enter_frame",e.RESIZE="resize",e.CHANGE="change",t.Event3D=e,__reflect(e.prototype,"egret3d.Event3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._label="",r._textField=new t.UITextField,r._textField.autoSize=t.UITextFieldAutoSize.CENTER,r._textField.textColor=4278190080,r.addChild(r._textField),r.onRender(),r._textHeight=-1,r._textWidth=-1,r}return __extends(r,e),r.prototype.getDefaultStyleNameByStyleName=function(e){var r={down:t.DefaultSkinName.DEFAULT_LABE_BUTTON_DOWN,up:t.DefaultSkinName.DEFAULT_LABEL_BUTTON_UP,disable:t.DefaultSkinName.DEFAULT_LABE_BUTTON_DISABLE},i=r[e];return i||console.log(" ERROR!!! UILabelButton can't find default style : ",e),i},Object.defineProperty(r.prototype,"textHeight",{get:function(){return this._textHeight},set:function(t){this._textHeight=t,this.onRender()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"textWidth",{get:function(){return this._textWidth},set:function(t){this._textWidth=t,this.onRender()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"textField",{get:function(){return this._textField},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"label",{get:function(){return this._label},set:function(t){this._label=t,this._textField.text=this._label},enumerable:!0,configurable:!0}),r.prototype.onRender=function(){e.prototype.onRender.call(this),this._textHeight>0?this.textField.textHeight=this._textHeight:this._textField.height=this._skin.height,this._textWidth>0?this.textField.textWidth=this._textWidth:this._textField.width=this._skin.width},r}(t.UIButton);t.UILabelButton=e,__reflect(e.prototype,"egret3d.gui.UILabelButton")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.useMipmap=!0,this.smooth=!0,this.repeat=!1,this.premultiply_alpha=0,this.filp_y=0,this.hasMipmap=!1,this.mirroredU=!1,this.mirroredV=!1,this.ready=!1}return e.prototype.copyFromTexture=function(e,r,i,a,n){this.parentTexture=e,e.width=a,e.height=n,this.guiIndex=e.guiIndex,this.texture2D=e.texture2D,this.uvRectangle=this.uvRectangle||new t.Rectangle,this.uvRectangle.x=r,this.uvRectangle.y=i,this.uvRectangle.width=a,this.uvRectangle.height=n},e.prototype.upload=function(t){},e.prototype.uploadForcing=function(t){},e.prototype.activeState=function(e){this.ready||(this.ready=!0,this.premultiply_alpha||t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.useMipmap&&!this.hasMipmap&&(t.Context3DProxy.gl.generateMipmap(t.Context3DProxy.gl.TEXTURE_2D),this.hasMipmap=!0),this.smooth?this.hasMipmap?(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR_MIPMAP_LINEAR),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.NEAREST),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.NEAREST)),this.repeat?this.mirroredU?t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.MIRRORED_REPEAT):this.mirroredV?t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.MIRRORED_REPEAT):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.REPEAT),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.REPEAT)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)),this.filp_y&&t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_FLIP_Y_WEBGL,this.filp_y))},e.prototype.dispose=function(){this.texture2D&&this.texture2D.dispose(),this.texture2D=null,this.texture3D&&this.texture3D.dispose(),this.texture3D=null},e.prototype.readPixels=function(e,r,i,a,n,o,s){if(void 0===n&&(n=t.ContextConfig.ColorFormat_RGBA8888),void 0===o&&(o=t.ContextConfig.UNSIGNED_BYTE),void 0===s&&(s=null),!s)switch(o){case t.ContextConfig.UNSIGNED_BYTE:n==t.ContextConfig.ColorFormat_RGBA8888?s=new Uint8Array(i*a*4):n==t.ContextConfig.ColorFormat_RGB888&&(s=new Uint8Array(i*a*3));break;case t.ContextConfig.FLOAT:n==t.ContextConfig.ColorFormat_RGBA8888?s=new Float32Array(i*a*4):n==t.ContextConfig.ColorFormat_RGB888&&(s=new Float32Array(i*a*3))}return s},e}();t.ITexture=e,__reflect(e.prototype,"egret3d.ITexture")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function e(){this.posSlotDecoder=t.BitTreeDecoder.constructArray(6,t.LZMAConfig.kNumLenToPosStates),this.alignDecoder=new t.BitTreeDecoder(t.LZMAConfig.kNumAlignBits),this.posDecoders=new Uint16Array(1+t.LZMAConfig.kNumFullDistances-t.LZMAConfig.kEndPosModelIndex),this.isMatch=new Uint16Array(t.LZMAConfig.kNumStates<<t.LZMAConfig.kNumPosBitsMax),this.isRep=new Uint16Array(t.LZMAConfig.kNumStates),this.isRepG0=new Uint16Array(t.LZMAConfig.kNumStates),this.isRepG1=new Uint16Array(t.LZMAConfig.kNumStates),this.isRepG2=new Uint16Array(t.LZMAConfig.kNumStates),this.isRep0Long=new Uint16Array(t.LZMAConfig.kNumStates<<t.LZMAConfig.kNumPosBitsMax),this.lenDecoder=new t.LenDecoder,this.repLenDecoder=new t.LenDecoder,this.rangeDec=new t.RangeDecoder,this.outWindow=new t.OutWindow}return e.prototype.init=function(){t.MEMORY.reset(),this.loc1=0|t.MEMORY.getUint32(),this.loc2=0|t.MEMORY.getUint32(),this.matchBitI=0|t.MEMORY.getUint16(),this.matchByteI=0|t.MEMORY.getUint16(),this.bitI=0|t.MEMORY.getUint16(),this.symbolI=0|t.MEMORY.getUint16(),this.prevByteI=0|t.MEMORY.getUint16(),this.litStateI=0|t.MEMORY.getUint16(),this.initLiterals(),this.initDist(),t.LZMAConfig.INIT_PROBS(this.isMatch),t.LZMAConfig.INIT_PROBS(this.isRep),t.LZMAConfig.INIT_PROBS(this.isRepG0),t.LZMAConfig.INIT_PROBS(this.isRepG1),t.LZMAConfig.INIT_PROBS(this.isRepG2),t.LZMAConfig.INIT_PROBS(this.isRep0Long),this.lenDecoder.init(),this.repLenDecoder.init()},e.prototype.create=function(){this.outWindow.create(this.dictSize),this.createLiterals()},e.prototype.createLiterals=function(){this.litProbs=new Uint16Array(768<<this.lc+this.lp)},e.prototype.initLiterals=function(){for(var e=768<<this.lc+this.lp,r=0;e>r;r++)this.litProbs[r]=t.LZMAConfig.PROB_INIT_VAL},e.prototype.decodeLiteral=function(e,r){t.MEMORY.u16[this.prevByteI]=0,this.outWindow.isEmpty()||(t.MEMORY.u16[this.prevByteI]=this.outWindow.getByte(1)),t.MEMORY.u16[this.symbolI]=1,t.MEMORY.u16[this.litStateI]=((this.outWindow.totalPos&(1<<this.lp)-1)<<this.lc)+(t.MEMORY.u16[this.prevByteI]>>>8-this.lc);var i=768*t.MEMORY.u16[this.litStateI]|0;if(e>=7){t.MEMORY.u16[this.matchByteI]=this.outWindow.getByte(r+1);do if(t.MEMORY.u16[this.matchBitI]=t.MEMORY.u16[this.matchByteI]>>>7&1,t.MEMORY.u16[this.matchByteI]<<=1,t.MEMORY.u16[this.bitI]=this.rangeDec.decodeBit(this.litProbs,i+(1+t.MEMORY.u16[this.matchBitI]<<8)+t.MEMORY.u16[this.symbolI]),t.MEMORY.u16[this.symbolI]=t.MEMORY.u16[this.symbolI]<<1|t.MEMORY.u16[this.bitI],t.MEMORY.u16[this.matchBitI]!=t.MEMORY.u16[this.bitI])break;while(t.MEMORY.u16[this.symbolI]<256)}for(;t.MEMORY.u16[this.symbolI]<256;)t.MEMORY.u16[this.symbolI]=t.MEMORY.u16[this.symbolI]<<1|this.rangeDec.decodeBit(this.litProbs,i+t.MEMORY.u16[this.symbolI]);this.outWindow.putByte(t.MEMORY.u16[this.symbolI]-256)},e.prototype.decodeDistance=function(e){var r=e;r>t.LZMAConfig.kNumLenToPosStates-1&&(r=t.LZMAConfig.kNumLenToPosStates-1);var i=this.posSlotDecoder[r].decode(this.rangeDec);if(4>i)return i;var a=(i>>>1)-1;return t.MEMORY.u32[this.loc1]=(2|1&i)<<a,i<t.LZMAConfig.kEndPosModelIndex?t.MEMORY.u32[this.loc1]+=t.LZMAConfig.BitTreeReverseDecode(this.posDecoders,a,this.rangeDec,t.MEMORY.u32[this.loc1]-i):(t.MEMORY.u32[this.loc1]+=this.rangeDec.decodeDirectBits(a-t.LZMAConfig.kNumAlignBits)<<t.LZMAConfig.kNumAlignBits,t.MEMORY.u32[this.loc1]+=this.alignDecoder.reverseDecode(this.rangeDec)),t.MEMORY.u32[this.loc1]},e.prototype.initDist=function(){for(var e=0;e<t.LZMAConfig.kNumLenToPosStates;e++)this.posSlotDecoder[e].init();this.alignDecoder.init(),t.LZMAConfig.INIT_PROBS(this.posDecoders)},e.prototype.decodeProperties=function(e){var r=new Uint8Array(4);if(r[0]=e[0],r[0]>=225)throw"Incorrect LZMA properties";r[1]=r[0]%9,r[0]/=9,r[2]=r[0]/5,r[3]=r[0]%5,this.lc=r[1],this.pb=r[2],this.lp=r[3],this.dictSizeInProperties=0;for(var i=0;4>i;i++)this.dictSizeInProperties|=e[i+1]<<8*i;this.dictSize=this.dictSizeInProperties,this.dictSize<t.LZMAConfig.LZMA_DIC_MIN&&(this.dictSize=t.LZMAConfig.LZMA_DIC_MIN)},e.prototype.updateState_Literal=function(t){return 4>t?0:10>t?t-3:t-6},e.prototype.updateState_ShortRep=function(t){return 7>t?9:11},e.prototype.updateState_Rep=function(t){return 7>t?8:11},e.prototype.updateState_Match=function(t){return 7>t?7:10},e.prototype.decode=function(e,r){this.init(),this.rangeDec.init(),e&&(this.outWindow.outStream=new Uint8Array(new ArrayBuffer(r)));for(var i=0,a=0,n=0,o=0,s=0;;){if(e&&0==r&&!this.markerIsMandatory&&this.rangeDec.isFinishedOK())return t.LZMAConfig.LZMA_RES_FINISHED_WITHOUT_MARKER;var l=this.outWindow.totalPos&(1<<this.pb)-1;if(0!=this.rangeDec.decodeBit(this.isMatch,(s<<t.LZMAConfig.kNumPosBitsMax)+l)){var h;if(0!=this.rangeDec.decodeBit(this.isRep,s)){if(e&&0==r)return t.LZMAConfig.LZMA_RES_ERROR;if(this.outWindow.isEmpty())return t.LZMAConfig.LZMA_RES_ERROR;if(0==this.rangeDec.decodeBit(this.isRepG0,s)){if(0==this.rangeDec.decodeBit(this.isRep0Long,(s<<t.LZMAConfig.kNumPosBitsMax)+l)){s=this.updateState_ShortRep(s),this.outWindow.putByte(this.outWindow.getByte(i+1)),r--;continue}}else{var u;0==this.rangeDec.decodeBit(this.isRepG1,s)?u=a:(0==this.rangeDec.decodeBit(this.isRepG2,s)?u=n:(u=o,o=n),n=a),a=i,i=u}h=this.repLenDecoder.decode(this.rangeDec,l),s=this.updateState_Rep(s)}else{if(o=n,n=a,a=i,h=this.lenDecoder.decode(this.rangeDec,l),s=this.updateState_Match(s),i=this.decodeDistance(h),4294967295==i)return this.rangeDec.isFinishedOK()?t.LZMAConfig.LZMA_RES_FINISHED_WITH_MARKER:t.LZMAConfig.LZMA_RES_ERROR;if(e&&0==r)return t.LZMAConfig.LZMA_RES_ERROR;if(i>=this.dictSize||!this.outWindow.checkDistance(i))return t.LZMAConfig.LZMA_RES_ERROR}h+=t.LZMAConfig.kMatchMinLen;var c=!1;if(e&&h>r&&(h=r,c=!0),this.outWindow.copyMatch(i+1,h),r-=h,c)return t.LZMAConfig.LZMA_RES_ERROR}else{if(e&&0==r)return t.LZMAConfig.LZMA_RES_ERROR;this.decodeLiteral(s,i),s=this.updateState_Literal(s),r--}}},e}();t.LzmaDecoder=e,__reflect(e.prototype,"nid.LzmaDecoder")}(nid||(nid={}));var egret3d;!function(t){var e=function(){function e(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=255),this.a=255,this.r=255,this.g=255,this.b=255,this.a=i,this.r=t,this.g=e,this.b=r}return e.white=function(){return new e(255,255,255,255)},e.black=function(){return new e(0,0,0,255)},e.red=function(){return new e(255,0,0,255)},e.green=function(){return new e(0,255,0,255)},e.blue=function(){return new e(0,0,255,255)},e.getColor=function(e,r,i){return void 0===r&&(r=t.ContextConfig.ColorFormat_RGBA8888),void 0===i&&(i=null),i||(i=new t.Vector3D),i.setTo((e>>16&255)/255,(e>>8&255)/255,(255&e)/255,(e>>24&255)/255),i},e.RGBAToColor=function(t,e,r,i){return i<<24|t<<16|e<<8|r},e.prototype.getColor=function(e){return void 0===e&&(e=t.ContextConfig.ColorFormat_RGBA8888),e==t.ContextConfig.ColorFormat_RGB565?0:e==t.ContextConfig.ColorFormat_RGBA5551?0:e==t.ContextConfig.ColorFormat_RGBA4444?0:this.r<<24|this.g<<16|this.b<<8|this.a},e.prototype.lerp=function(t,e,r){this.a=r*(e.a-t.a)+t.a,this.r=r*(e.r-t.r)+t.r,this.g=r*(e.g-t.g)+t.g,this.b=r*(e.b-t.b)+t.b,this.a=Math.floor(this.a),this.r=Math.floor(this.r),this.g=Math.floor(this.g),this.b=Math.floor(this.b)},e.prototype.copyFrom=function(t){this.a=t.a,this.r=t.r,this.g=t.g,this.b=t.b},e.prototype.setTo=function(t,e,r,i){void 0===t&&(t=255),void 0===e&&(e=255),void 0===r&&(r=255),void 0===i&&(i=255),this.a=t,this.r=e,this.g=r,this.b=i},e.createColor=function(t){var r=new e;return r.setColorARGB(t),r},e.prototype.setColorARGB=function(t){this.a=t/16777216,this.a>>=0,this.r=16711680&t,this.r>>=16,this.g=65280&t,this.g>>=8,this.b=255&t},e.prototype.setColorRGB=function(t){this.r=16711680&t,this.r>>=16,this.g=65280&t,this.g>>=8,this.b=255&t},e.prototype.randomColor=function(t,e,r){if(void 0===r&&(r=!1),r){var i=Math.random();this.a=t.a+(e.a-t.a)*i,this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i}else this.a=t.a+(e.a-t.a)*Math.random(),this.r=t.r+(e.r-t.r)*Math.random(),this.g=t.g+(e.g-t.g)*Math.random(),this.b=t.b+(e.b-t.b)*Math.random();
this.a=Math.floor(this.a),this.r=Math.floor(this.r),this.g=Math.floor(this.g),this.b=Math.floor(this.b)},e.prototype.scaleBy=function(t){this.a*=t,this.r*=t,this.g*=t,this.b*=t},e}();t.Color=e,__reflect(e.prototype,"egret3d.Color")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r,i,a,n){void 0===n&&(n=null),this.scissorRect=new t.Rectangle,this._viewPort=new t.Rectangle,this._backColor=new t.Vector3D(.3,.3,.6,1),this._cleanParmerts=t.Context3DProxy.gl.COLOR_BUFFER_BIT|t.Context3DProxy.gl.DEPTH_BUFFER_BIT,this._scene=new t.Scene3D,this._huds=new Array,this._postList=[],this.sunLight=new t.DirectLight(new t.Vector3D(0,-1,1)),this._entityCollect=new t.EntityCollect,this._entityCollect.root=this._scene,this._camera=n||new t.Camera3D(t.CameraType.perspective),this._camera.name="MainCamera",this._scene.addChild(this._camera),this._renderQuen=new t.RenderQuen,this._renderQuen.mainRender.camera=this._camera,this._viewPort.x=e,this._viewPort.y=r,this._viewPort.width=i,this._viewPort.height=a,this._camera.aspectRatio=i/a,this._camera.updateViewport(e,r,i,a),this._backImg&&(this._backImg.x=e,this._backImg.y=r,this._backImg.width=i,this._backImg.height=a),this.scissorRect.x=e,this.scissorRect.y=r,this.scissorRect.width=i,this.scissorRect.height=a,this._shadowCast=new t.ShadowCast(this)}return Object.defineProperty(e.prototype,"renderQuen",{get:function(){return this._renderQuen},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowCast",{get:function(){return this._shadowCast},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"post",{set:function(e){this._postList=e,e.length>0&&(this._postProcessing=this._postProcessing||new t.PostProcessing(this._renderQuen),this._postHUD=this._postHUD||new t.HUD(0,0,512,512),this._postHUD.fsShader="hud_H_fs")},enumerable:!0,configurable:!0}),e.prototype.blender=function(e,r){this._cleanParmerts=(e?t.Context3DProxy.gl.COLOR_BUFFER_BIT:0)|(r?t.Context3DProxy.gl.DEPTH_BUFFER_BIT:0)},Object.defineProperty(e.prototype,"backColor",{get:function(){return 255*this._backColor.w<<24|255*this._backColor.x<<16|255*this._backColor.y<<8|255*this._backColor.z},set:function(t){this._backColor.w=(t>>24&255)/255,this._backColor.x=(t>>16&255)/255,this._backColor.y=(t>>8&255)/255,this._backColor.z=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backImage",{get:function(){return this._backImg.diffuseTexture},set:function(e){e&&(this._backImg=this._backImg||new t.HUD,this._backImg.diffuseTexture=e,this._backImg.x=this.x,this._backImg.y=this.y,this._backImg.width=this.width,this._backImg.height=this.height)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camera3D",{get:function(){return this._camera},set:function(t){this._camera=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._quadStage&&this._quadStage.changeCamera()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t,this._entityCollect.root=this._scene,this.camera3D.parent&&this.addChild3D(this._camera)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._viewPort.x},set:function(t){this._viewPort.x=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._viewPort.y},set:function(t){this._viewPort.y=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._viewPort.width},set:function(t){this._viewPort.width=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.width=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._viewPort.height},set:function(t){this._viewPort.height=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.height=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"entityCollect",{get:function(){return this._entityCollect},enumerable:!0,configurable:!0}),e.prototype.getGUIStage=function(){return this._quadStage||(this._quadStage=new t.QuadStage(this)),this._quadStage},e.prototype.addGUI=function(e){this._quadStage||(this._quadStage=new t.QuadStage(this)),this._quadStage.addChild(e)},e.prototype.removeGUI=function(t){this._quadStage.removeChild(t)},e.prototype.addChild3D=function(t){this._scene.addChild(t)},e.prototype.removeChild3D=function(t){this._scene.removeChild(t)},e.prototype.inView3D=function(t,e){return this._viewPort.inner(t,e)},e.prototype.addHUD=function(t){-1==this._huds.indexOf(t)&&(t.viewPort=this._viewPort,this._huds.push(t))},e.prototype.findHud=function(t){for(var e=0;e<this._huds.length;++e)if(this._huds[e].name==t)return this._huds[e];return null},e.prototype.delHUD=function(t){var e=this._huds.indexOf(t);e>=0&&e<this._huds.length&&this._huds.splice(e,1)},e.prototype.update=function(e,r){t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("updateObject3D",60),this.updateObject3D(this._scene,e,r),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("updateObject3D"),t.Egret3DCanvas.context3DProxy.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),t.Egret3DCanvas.context3DProxy.setScissorRectangle(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("entityCollect",60),this._entityCollect.update(this._camera),this._shadowCast.shadowRender.enabled=!1,this._entityCollect.numberAcceptShadow>0&&(this._shadowCast.shadowRender.enabled=!0,this._shadowCast.update(this._entityCollect,e,r)),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("entityCollect"),this._cleanParmerts&t.Context3DProxy.gl.COLOR_BUFFER_BIT&&t.Egret3DCanvas.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),t.Egret3DCanvas.context3DProxy.clear(this._cleanParmerts),this._backImg&&this._backImg.draw(t.Egret3DCanvas.context3DProxy),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("draw",60),this._renderQuen.mainRender.camera=this.camera3D,this._renderQuen.draw(e,r,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._viewPort),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("draw"),this._postList.length>0&&(t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("post",60),this._postProcessing.postArray=this._postList,this._postProcessing.draw(e,r,t.Egret3DCanvas.context3DProxy,this._entityCollect,this.camera3D,this._viewPort),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("post"));for(var i=0;i<this._huds.length;++i)this._huds[i].draw(t.Egret3DCanvas.context3DProxy);this._quadStage&&(t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("GUI",60),this._quadStage.update(e,r,t.Egret3DCanvas.context3DProxy,this),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("GUI"))},e.prototype.updateObject3D=function(t,e,r){if(t&&t.visible){t.update(e,r,this.camera3D);for(var i=0;i<t.childs.length;++i)this.updateObject3D(t.childs[i],e,r)}},e}();t.View3D=e,__reflect(e.prototype,"egret3d.View3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.vexLength=3,this.matrix=new t.Matrix4_4,this.temp=new t.Vector3D,this.owner=e}return e.prototype.initBound=function(){null==this._bound&&(this._bound=new t.Wireframe,this._bound.material.diffuseColor=16777215,this._bound.name="Bound",this._bound.geometry.vertexCount=8,this._bound.geometry.indexCount=24,this._bound.geometry.setVertexIndices(0,[0,1,1,2,2,3,0,3,4,5,5,6,6,7,4,7,0,4,1,5,3,7,2,6]))},Object.defineProperty(e.prototype,"visible",{get:function(){return null==this._bound?!1:this._bound.parent?!0:!1},set:function(t){this.initBound(),t?this._bound.parent?this._bound.parent!=this.owner&&(this._bound.parent.removeChild(this._bound),this.owner.addChild(this._bound)):this.owner.addChild(this._bound):this._bound.parent&&this._bound.parent.removeChild(this._bound)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transform",{get:function(){return this.owner?this.owner.modelMatrix:this.matrix},enumerable:!0,configurable:!0}),e.prototype.pointIntersect=function(t){return!1},e.prototype.intersect=function(t,e){return void 0===e&&(e=null),!0},e.prototype.clone=function(){var t=new e(this.owner);return t.copyVertex(this),t},e.prototype.calculateTransform=function(){for(var t=0;t<this.vexData.length;t+=3)this.temp.setTo(this.vexData[t],this.vexData[t+1],this.vexData[t+2]),this.transform.transformVector(this.temp,this.temp),this.vexData[t+0]=this.temp.x,this.vexData[t+1]=this.temp.y,this.vexData[t+2]=this.temp.z},e.prototype.copyVertex=function(t){for(var e=0;e<t.vexData.length;++e)this.vexData[e]=t.vexData[e];for(var e=0;e<t.indexData.length;++e)this.indexData[e]=t.indexData[e];this.vexLength=t.vexLength},e.prototype.createChild=function(){this.childBound=new e(this.owner)},e.prototype.inBound=function(t){return!0},e.prototype.updateAABB=function(){},e.prototype.dispose=function(){null!=this._bound&&this._bound.dispose(),this.childBound&&this.childBound.dispose()},e}();t.Bound=e,__reflect(e.prototype,"egret3d.Bound")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.Event3D);e.LOADER_COMPLETE="onLoadComplete",e.COMPLETE="onLoadComplete",e.LOADER_ONCE_COMPLETE="onLoadOnceComplete",e.ONCE_COMPLETE="onLoadOnceComplete",e.LOADER_PROGRESS="onLoadProgress",e.PROGRESS="onLoadProgress",e.LOADER_ERROR="onLoadError",e.ERROR="onLoadError",t.LoaderEvent3D=e,__reflect(e.prototype,"egret3d.LoaderEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r){void 0===e&&(e=new t.Vector3D),void 0===r&&(r=new t.Vector3D),this.origin=new t.Vector3D,this.dir=new t.Vector3D,this.invViewMat=new t.Matrix4_4,this.origin.copyFrom(e),this.dir.copyFrom(r)}return e.prototype.IntersectTriangle=function(t,r,i,a){void 0===a&&(a=null);var n,o=r.subtract(t,e.v0),s=i.subtract(t,e.v1),l=this.dir.crossProduct(s,e.v2),h=o.dotProduct(l);if(h>0?n=this.origin.subtract(t,e.v3):(n=t.subtract(this.origin,e.v3),h=-h),1e-4>h)return!1;var u=n.dotProduct(l);if(null!=a&&(a[1]=u),0>u||u>h)return!1;var c=n.crossProduct(o,e.v4),d=this.dir.dotProduct(c);if(null!=a&&(a[2]=d),0>d||u+d>h)return!1;var p=s.dotProduct(c),f=1/h;return p*=f,u*=f,d*=f,null!=a&&(a[0]=p,a[1]=u,a[2]=d),0>p?!1:!0},e.prototype.IntersectSphere=function(r,i,a,n){void 0===a&&(a=null),void 0===n&&(n=null),a=a||[],e.transformCenter.copyFrom(r),e.v0.copyFrom(t.Vector3D.X_AXIS),e.v0.scaleBy(i),e.v0.add(e.transformCenter,e.v0),n.mat3TransformVector(e.v0,e.v0),e.v0.subtract(e.transformCenter,e.v0),i=e.v0.length,n&&n.transformVector(r,e.transformCenter);var o=0,s=0,l=e.transformCenter.subtract(this.origin,t.MathUtil.CALCULATION_VECTOR3D_0),h=this.dir.dotProduct(l);if(0>h)return null;var u=l.dotProduct(l),c=u-h*h,d=i*i;if(c>d)return null;var p=d-c;return 0>p?o=s=h:(p=Math.sqrt(p),o=h-p,s=h+p,0>o&&(o=s)),a.push(o),a.push(s),a},e.prototype.IntersectBound=function(e,r){return void 0===r&&(r=null),r=r||new t.PickResult,this.IntersectMesh(e.vexData,e.indexData,e.vexLength,e.indexData.length/3,0,e.transform,r)?r:null},e.prototype.IntersectMeshEx=function(t,e,r){return this.IntersectMesh(t.geometry.vertexArray,t.geometry.indexArray,t.geometry.vertexAttLength,t.geometry.faceCount,e,t.modelMatrix,r)},e.prototype.IntersectMesh=function(r,i,a,n,o,s,l){for(var h=e.modletriangle,u=e.uvarray,c=e.triangle,d=c[0],p=c[1],f=c[2],m=e.pos,_=e.uv,v=e.ret,g=-1,y=t.MathUtil.MAX_VALUE,x=0,b=0,D=0;n>D;++D){for(var T=0;3>T;++T){var P=i[3*D+T];m.setTo(r[a*P+0],r[a*P+1],r[a*P+2]),m.copyFrom(s.transformVector(m)),c[T].x=m.x,c[T].y=m.y,c[T].z=m.z}this.IntersectTriangle(d,p,f,v)&&v[0]<y&&(g=D,y=v[0],x=v[1],b=v[2])}if(n>g&&g>=0){for(var D=0;3>D;++D){var P=i[3*g+D];m.setTo(r[a*P+0],r[a*P+1],r[a*P+2]),h[D].copyFrom(m),o>0&&(_.x=r[a*P+0+o],_.y=r[a*P+1+o],u[D].x=_.x,u[D].y=_.y),m.copyFrom(s.transformVector(m)),c[D].x=m.x,c[D].y=m.y,c[D].z=m.z}l.faceIndex=g,l.v0=i[3*g+0],l.v1=i[3*g+1],l.v2=i[3*g+2];var S=p.subtract(d,e.v0);S.scaleBy(x);var w=f.subtract(d,e.v1);return w.scaleBy(b),l.globalPosition.copyFrom(d.add(S.add(w,e.v2),e.v3)),S=h[1].subtract(h[0],S),S.scaleBy(x),w=h[2].subtract(h[0],w),w.scaleBy(b),l.localPosition.copyFrom(h[0].add(S.add(w,e.v2),e.v3)),o>0&&(S=u[1].subtract(u[0],S),S.scaleBy(x),w=u[2].subtract(u[0],w),w.scaleBy(b),l.uv.copyFrom(u[0].add(S.add(w,e.v2),e.v3))),!0}return!1},e.prototype.CalculateAndTransformRay=function(t,r,i,a,n,o){this.reset(),this.dir.x=(2*n/t-1)/a.rawData[0],this.dir.y=(-2*o/r+1)/a.rawData[5],this.dir.z=1,this.invViewMat.copyFrom(i),this.origin.copyFrom(this.invViewMat.transformVector(this.origin,e.v0)),this.dir.copyFrom(this.invViewMat.deltaTransformVector(this.dir,e.v0)),this.dir.normalize()},e.prototype.reset=function(){this.origin.setTo(0,0,0),this.dir.setTo(0,0,0)},e}();e.v0=new t.Vector3D,e.v1=new t.Vector3D,e.v2=new t.Vector3D,e.v3=new t.Vector3D,e.v4=new t.Vector3D,e.transformCenter=new t.Vector3D,e.modletriangle=[new t.Vector3D,new t.Vector3D,new t.Vector3D],e.uvarray=[new t.Vector3D,new t.Vector3D,new t.Vector3D],e.triangle=[new t.Vector3D,new t.Vector3D,new t.Vector3D],e.ret=[0,0,0],e.pos=new t.Vector3D,e.uv=new t.Point,t.Ray=e,__reflect(e.prototype,"egret3d.Ray")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){void 0===t&&(t=!1),this.data=[],this.list=new Array,t&&(this.list=new Array)}return t.prototype.isHas=function(t){return this.data[t]?!0:!1},t.prototype.getValue=function(t){return this.data[t]},t.prototype.getList=function(){return this.list},t.prototype.add=function(t,e){this.data[t]=e,this.list&&this.list.push(e)},t.prototype.remove=function(t){if(this.list){var e=this.list.indexOf(this.data[t]);-1!=e&&this.list.splice(e)}delete this.data[t]},t.prototype.dispose=function(){delete this.data,delete this.list},t}();t.HashMap=e,__reflect(e.prototype,"egret3d.HashMap")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===r&&(r=null),void 0===i&&(i=t.VertexFormat.VF_POSITION);var a=e.call(this)||this;return a.type=t.IRender.TYPE_WIREFRAME,a.geometry=new t.Geometry,a.material=new t.ColorMaterial(16777215),a.addSubMaterial(0,a.material),a.material.drawMode=t.DrawMode.LINES,a.geometry.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0,a.fromVertexs(r,i),a}return __extends(r,e),r.prototype.fromVertexs=function(e,r){if(void 0===r&&(r=t.VertexFormat.VF_POSITION),e){this.geometry.setVerticesForIndex(0,r,e,e.length/t.GeometryUtil.fromVertexFormatToLength(r)),this.geometry.indexCount=2*(this.geometry.vertexCount-1);for(var i=0;i<this.geometry.vertexCount-1;++i)this.geometry.indexArray[2*i+0]=i,this.geometry.indexArray[2*i+1]=i+1}},r.prototype.fromVertexsEx=function(e,r){if(void 0===r&&(r=t.VertexFormat.VF_POSITION),e){this.geometry.setVerticesForIndex(0,r,e,e.length/t.GeometryUtil.fromVertexFormatToLength(r)),this.geometry.indexCount=this.geometry.vertexCount;for(var i=0;i<this.geometry.vertexCount;++i)this.geometry.indexArray[i]=i}},r.prototype.fromGeometry=function(e){var r=[];e.getVertexForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,r,e.vertexCount),this.geometry.setVerticesForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,r,e.vertexCount),this.geometry.indexCount=6*e.faceCount;for(var i=0;i<e.faceCount;++i){var a=e.indexArray[3*i+0],n=e.indexArray[3*i+1],o=e.indexArray[3*i+2];this.geometry.indexArray[6*i+0]=a,this.geometry.indexArray[6*i+1]=n,this.geometry.indexArray[6*i+2]=n,this.geometry.indexArray[6*i+3]=o,this.geometry.indexArray[6*i+4]=o,this.geometry.indexArray[6*i+5]=a}},r.prototype.copy=function(t){e.prototype.copy.call(this,t),this.geometry=t.geometry,this.material=t.material},r.prototype.clone=function(){var t=new r;return t.copy(this),t},r}(t.IRender);t.Wireframe=e,__reflect(e.prototype,"egret3d.Wireframe")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.VF_POSITION=1]="VF_POSITION",t[t.VF_NORMAL=2]="VF_NORMAL",t[t.VF_TANGENT=4]="VF_TANGENT",t[t.VF_COLOR=8]="VF_COLOR",t[t.VF_UV0=16]="VF_UV0",t[t.VF_UV1=32]="VF_UV1",t[t.VF_SKIN=64]="VF_SKIN",t[t.VF_QUAD_UVREC=128]="VF_QUAD_UVREC",t[t.VF_QUAD_ROTATION=256]="VF_QUAD_ROTATION",t[t.VF_QUAD_MASK=1024]="VF_QUAD_MASK",t[t.VF_QUAD_POS=2048]="VF_QUAD_POS",t[t.VF_QUAD_ORIGN=4096]="VF_QUAD_ORIGN",t[t.VF_QUAD_COLOR=8192]="VF_QUAD_COLOR"}(e=t.VertexFormat||(t.VertexFormat={}));var r=function(r){function i(){var e=null!==r&&r.apply(this,arguments)||this;return e.drawType=t.Context3DProxy.gl.STATIC_DRAW,e._vertexFormat=0,e.vertexAttLength=0,e.faceOrBack=!1,e.subGeometrys=[],e._bufferDiry=!0,e._vertexCount=0,e._indexCount=0,e._totalIndexCount=0,e._faceCount=0,e}return __extends(i,r),Object.defineProperty(i.prototype,"bufferDiry",{get:function(){return this._bufferDiry},set:function(t){this._bufferDiry=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){if(t){this._skeleton=t,this.skeletonGPUData=new Float32Array(8*t.jointNum);for(var e=0;e<t.jointNum;++e)this.skeletonGPUData[8*e+3]=1,this.skeletonGPUData[8*e+7]=1}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"vertexCount",{get:function(){return this._vertexCount},set:function(t){if(this._vertexCount!=t){var e=t*this.vertexAttLength,r=null;this.vertexArray?this.vertexCount<t?(r=new Float32Array(e),r.set(this.vertexArray),delete this.vertexArray):r=this.vertexArray:r=new Float32Array(e),this.vertexArray=r,this._vertexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"indexCount",{get:function(){return this._indexCount},set:function(t){if(this._indexCount=t,this._faceCount=t/3,!(this._totalIndexCount>=t)){var e=new Uint16Array(t);this.indexArray&&(e.set(this.indexArray),delete this.indexArray),this.indexArray=e,this._totalIndexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"faceCount",{get:function(){return this._faceCount},set:function(t){this._faceCount!=t&&(this.indexCount=3*t,this._faceCount=t)},enumerable:!0,configurable:!0}),i.prototype.buildDefaultSubGeometry=function(){var e=new t.SubGeometry;e.matID=0,e.geometry=this,e.start=0,e.count=this.indexCount,this.subGeometrys.push(e)},Object.defineProperty(i.prototype,"vertexFormat",{get:function(){return this._vertexFormat},set:function(r){this._vertexFormat=r,this.vertexFormat&e.VF_POSITION&&(this.vertexAttLength+=i.positionSize),this.vertexFormat&e.VF_NORMAL&&(this.vertexAttLength+=i.normalSize),this.vertexFormat&e.VF_TANGENT&&(this.vertexAttLength+=i.tangentSize),this.vertexFormat&e.VF_COLOR&&(this.vertexAttLength+=i.colorSize),this.vertexFormat&e.VF_UV0&&(this.vertexAttLength+=i.uvSize),this.vertexFormat&e.VF_UV1&&(this.vertexAttLength+=i.uv2Size),this.vertexFormat&e.VF_SKIN&&(this.vertexAttLength+=i.skinSize),this.vertexFormat&e.VF_QUAD_UVREC&&(this.vertexAttLength+=t.QuadData.uvRectangleSize),this.vertexFormat&e.VF_QUAD_ROTATION&&(this.vertexAttLength+=t.QuadData.rotationSize),this.vertexFormat&e.VF_QUAD_MASK&&(this.vertexAttLength+=t.QuadData.maskSize),this.vertexFormat&e.VF_QUAD_POS&&(this.vertexAttLength+=t.QuadData.posSize),this.vertexFormat&e.VF_QUAD_ORIGN&&(this.vertexAttLength+=t.QuadData.originalSize),this.vertexFormat&e.VF_QUAD_COLOR&&(this.vertexAttLength+=t.QuadData.colorSize),this.vertexSizeInBytes=4*this.vertexAttLength},enumerable:!0,configurable:!0}),i.prototype.activeState=function(t,e,r,i){this._bufferDiry&&(this._bufferDiry=!1,this.upload(r,this.drawType)),r.bindVertexBuffer(this.sharedVertexBuffer),r.bindIndexBuffer(this.sharedIndexBuffer)},i.prototype.upload=function(e,r){void 0===r&&(r=t.Context3DProxy.gl.STATIC_DRAW),this.sharedIndexBuffer||this.sharedVertexBuffer?(e.uploadVertexBuffer(this.sharedVertexBuffer),e.uploadIndexBuffer(this.sharedIndexBuffer)):(this.sharedIndexBuffer=e.creatIndexBuffer(this.indexArray),this.sharedVertexBuffer=e.creatVertexBuffer(this.vertexArray,r))},i.prototype.getVertexForIndex=function(t,r,a,n){if(void 0===a&&(a=null),void 0===n&&(n=1),a||(a=new Array),0>t||t>=this.vertexCount)return a;for(var o=0;n>o;++o){var s=0;if(r&e.VF_POSITION&&(this.vertexFormat&e.VF_POSITION?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1]),a.push(this.vertexArray[t*this.vertexAttLength+s+2])):a.push(0,0,0)),this.vertexFormat&e.VF_POSITION&&(s+=i.positionSize),r&e.VF_NORMAL&&(this.vertexFormat&e.VF_NORMAL?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1]),a.push(this.vertexArray[t*this.vertexAttLength+s+2])):a.push(0,0,0)),this.vertexFormat&e.VF_NORMAL&&(s+=i.normalSize),r&e.VF_TANGENT&&(this.vertexFormat&e.VF_TANGENT?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1]),a.push(this.vertexArray[t*this.vertexAttLength+s+2])):a.push(0,0,0)),this.vertexFormat&e.VF_TANGENT&&(s+=i.tangentSize),r&e.VF_COLOR&&(this.vertexFormat&e.VF_COLOR?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1]),a.push(this.vertexArray[t*this.vertexAttLength+s+2]),a.push(this.vertexArray[t*this.vertexAttLength+s+3])):a.push(0,0,0,0)),this.vertexFormat&e.VF_COLOR&&(s+=i.colorSize),r&e.VF_UV0&&(this.vertexFormat&e.VF_UV0?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1])):a.push(0,0)),this.vertexFormat&e.VF_UV0&&(s+=i.uvSize),r&e.VF_UV1&&(this.vertexFormat&e.VF_UV1?(a.push(this.vertexArray[t*this.vertexAttLength+s+0]),a.push(this.vertexArray[t*this.vertexAttLength+s+1])):a.push(0,0)),this.vertexFormat&e.VF_UV1&&(s+=i.uv2Size),r&e.VF_SKIN)if(this.vertexFormat&e.VF_SKIN)for(var l=0;l<i.skinSize;++l)a.push(this.vertexArray[t*this.vertexAttLength+s+l]);else a.push(0,0,0,0,0,0,0,0);this.vertexFormat&e.VF_SKIN&&(s+=i.skinSize),t++}return a},i.prototype.setVerticesForIndex=function(t,r,a,n){void 0===n&&(n=1),t+n>this.vertexCount&&(this.vertexCount=t+n),this._bufferDiry=!0;for(var o=0,s=0,l=0;n>l;++l){if(o=0,this.vertexFormat&e.VF_POSITION&&(r&e.VF_POSITION&&(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1],this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]),o+=i.positionSize),r&e.VF_POSITION&&(s+=i.positionSize),this.vertexFormat&e.VF_NORMAL&&(r&e.VF_NORMAL&&(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1],this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]),o+=i.normalSize),r&e.VF_NORMAL&&(s+=i.normalSize),this.vertexFormat&e.VF_TANGENT&&(r&e.VF_TANGENT&&(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1],this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2]),o+=i.tangentSize),r&e.VF_TANGENT&&(s+=i.tangentSize),this.vertexFormat&e.VF_COLOR&&(r&e.VF_COLOR?(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1],this.vertexArray[t*this.vertexAttLength+o+2]=a[s+2],this.vertexArray[t*this.vertexAttLength+o+3]=a[s+3]):0==this.vertexArray[t*this.vertexAttLength+o+0]&&0==this.vertexArray[t*this.vertexAttLength+o+1]&&0==this.vertexArray[t*this.vertexAttLength+o+2]&&0==this.vertexArray[t*this.vertexAttLength+o+3]&&(this.vertexArray[t*this.vertexAttLength+o+0]=1,this.vertexArray[t*this.vertexAttLength+o+1]=1,this.vertexArray[t*this.vertexAttLength+o+2]=1,this.vertexArray[t*this.vertexAttLength+o+3]=1),o+=i.colorSize),r&e.VF_COLOR&&(s+=i.colorSize),this.vertexFormat&e.VF_UV0&&(r&e.VF_UV0&&(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1]),o+=i.uvSize),r&e.VF_UV0&&(s+=i.uvSize),this.vertexFormat&e.VF_UV1&&(r&e.VF_UV1&&(this.vertexArray[t*this.vertexAttLength+o+0]=a[s+0],this.vertexArray[t*this.vertexAttLength+o+1]=a[s+1]),o+=i.uv2Size),r&e.VF_UV1&&(s+=i.uv2Size),this.vertexFormat&e.VF_SKIN){if(r&e.VF_SKIN)for(var h=0;h<i.skinSize;++h)this.vertexArray[t*this.vertexAttLength+o+h]=a[s+h];o+=i.skinSize}r&e.VF_SKIN&&(s+=i.skinSize),t++}},i.prototype.getVertexIndices=function(t,e,r){if(void 0===e&&(e=-1),void 0===r&&(r=null),r||(r=new Array),t>=this.indexCount)return r;-1==e?e=this.indexCount:e,t+e>this.indexCount&&(e=this.indexCount-t);for(var i=0;e>i;++i)r[i]=this.indexArray[i+t];return r},i.prototype.setVertexIndices=function(t,e){t+e.length>this.indexCount&&(this.indexCount=t+e.length);for(var r=0;r<e.length;++r)this.indexArray[t+r]=e[r]},i.prototype.cloneMirror=function(e,r,a){var n=new i;n.vertexFormat=this.vertexFormat,n.vertexCount=this.vertexCount,n.indexCount=this.indexCount;var o=0,s=new t.Vector3D,l=new t.Vector3D,h=new t.Vector3D(e?-1:1,r?-1:1,a?-1:1),u=new t.Quaternion;for(n.vertexArray=new Float32Array(this.vertexArray.length),n.indexArray=new Float32Array(this.indexArray.length),o=0;o<n.vertexArray.length;o++)n.vertexArray[o]=this.vertexArray[o];for(o=0;o<n.indexArray.length;o++)n.indexArray[o]=this.indexArray[o];for(t.Matrix4_4.helpMatrix.makeTransform(l,h,u),o=0;o<this.vertexCount;o++)s.x=n.vertexArray[o*this.vertexAttLength],s.y=n.vertexArray[o*this.vertexAttLength+1],s.z=n.vertexArray[o*this.vertexAttLength+2],t.Matrix4_4.helpMatrix.transformVector(s,t.Vector3D.HELP_0),n.vertexArray[o*this.vertexAttLength]=t.Vector3D.HELP_0.x,n.vertexArray[o*this.vertexAttLength+1]=t.Vector3D.HELP_0.y,n.vertexArray[o*this.vertexAttLength+2]=t.Vector3D.HELP_0.z;for(o=0;o<this.indexCount/3;o++)s.x=n.indexArray[3*o+0],s.y=n.indexArray[3*o+1],s.z=n.indexArray[3*o+2],n.indexArray[3*o+0]=s.x,n.indexArray[3*o+1]=s.z,n.indexArray[3*o+2]=s.y;for(o=0;o<this.subGeometrys.length;++o){var c=new t.SubGeometry;c.matID=o,c.geometry=n,c.start=3*this.subGeometrys[o].start,c.count=3*this.subGeometrys[o].count,c.textureDiffuse=this.subGeometrys[o].textureDiffuse,c.textureNormal=this.subGeometrys[o].textureNormal,c.textureSpecular=this.subGeometrys[o].textureSpecular,n.subGeometrys.push(c)}return n},i.prototype.copy=function(e){this.vertexFormat=e.vertexFormat,this.vertexCount=e.vertexCount,this.indexCount=e.indexCount;for(var r=0;r<e.vertexArray.length;++r)this.vertexArray[r]=e.vertexArray[r];for(var r=0;r<e.indexArray.length;++r)this.indexArray[r]=e.indexArray[r];this.subGeometrys.length=0;for(var r=0;r<e.subGeometrys.length;++r){var i=new t.SubGeometry;this.subGeometrys.push(i);var a=e.subGeometrys[r];i.geometry=this,i.start=a.start,i.count=a.count,i.matID=a.matID,i.textureDiffuse=a.textureDiffuse,i.textureNormal=a.textureNormal,i.textureSpecular=a.textureSpecular}},i.prototype.dispose=function(){this.decRef(),this.isDispose&&(this.sharedIndexBuffer&&(this.sharedIndexBuffer.dispose(),this.sharedIndexBuffer=null),this.sharedVertexBuffer&&(this.sharedVertexBuffer.dispose(),this.sharedVertexBuffer=null),this.vertexArray=null,this.indexArray=null,this.skeletonGPUData=null,this.skeleton=null,this.subGeometrys=[])},i}(t.Reference);r.positionSize=3,r.normalSize=3,r.tangentSize=3,r.colorSize=4,r.uvSize=2,r.uv2Size=2,r.skinSize=8,t.Geometry=r,__reflect(r.prototype,"egret3d.Geometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){void 0===i&&(i=null),void 0===a&&(a=null);var n=e.call(this)||this;return n.type=t.IRender.TYPE_MESH,n.geometry=r,a?n.animation=a:r&&n.geometry.vertexFormat&t.VertexFormat.VF_SKIN&&(n.animation=new t.SkeletonAnimation(new t.SkeletonAnimationState)),n.material=i?i:new t.TextureMaterial,n.addSubMaterial(0,n.material),n.bound=n.buildBoundBox(),n}return __extends(r,e),Object.defineProperty(r.prototype,"aabb",{get:function(){return this._aabbBox},enumerable:!0,configurable:!0}),r.prototype.initAABB=function(){this._aabbBox=new t.QuadAABB,this.calcGlobalQuadAABB()},r.prototype.calcGlobalQuadAABB=function(){var t=this.bound,e=this.modelMatrix;r.AABB_BL_2.setTo(t.min.x,t.min.y,t.min.z),r.AABB_BR_2.setTo(t.max.x,t.min.y,t.min.z),r.AABB_TL_2.setTo(t.min.x,t.max.y,t.min.z),r.AABB_TR_2.setTo(t.max.x,t.max.y,t.min.z),r.AABB_BL_1.setTo(t.min.x,t.min.y,t.max.z),r.AABB_BR_1.setTo(t.max.x,t.min.y,t.max.z),r.AABB_TL_1.setTo(t.min.x,t.max.y,t.max.z),r.AABB_TR_1.setTo(t.max.x,t.max.y,t.max.z),e.transformVector(r.AABB_BL_2,r.AABB_BL_2),e.transformVector(r.AABB_BR_2,r.AABB_BR_2),e.transformVector(r.AABB_TL_2,r.AABB_TL_2),e.transformVector(r.AABB_TR_2,r.AABB_TR_2),e.transformVector(r.AABB_BL_1,r.AABB_BL_1),e.transformVector(r.AABB_BR_1,r.AABB_BR_1),e.transformVector(r.AABB_TL_1,r.AABB_TL_1),e.transformVector(r.AABB_TR_1,r.AABB_TR_1),this._aabbBox.maxPosX=Math.max(r.AABB_TL_2.x,r.AABB_TR_2.x,r.AABB_BL_2.x,r.AABB_BR_2.x,r.AABB_TL_1.x,r.AABB_TR_1.x,r.AABB_BL_1.x,r.AABB_BR_1.x),this._aabbBox.maxPosY=Math.max(r.AABB_TL_2.y,r.AABB_TR_2.y,r.AABB_BL_2.y,r.AABB_BR_2.y,r.AABB_TL_1.y,r.AABB_TR_1.y,r.AABB_BL_1.y,r.AABB_BR_1.y),this._aabbBox.minPosX=Math.min(r.AABB_TL_2.x,r.AABB_TR_2.x,r.AABB_BL_2.x,r.AABB_BR_2.x,r.AABB_TL_1.x,r.AABB_TR_1.x,r.AABB_BL_1.x,r.AABB_BR_1.x),this._aabbBox.minPosY=Math.min(r.AABB_TL_2.y,r.AABB_TR_2.y,r.AABB_BL_2.y,r.AABB_BR_2.y,r.AABB_TL_1.y,r.AABB_TR_1.y,r.AABB_BL_1.y,r.AABB_BR_1.y)},Object.defineProperty(r.prototype,"isTriangle",{get:function(){return!1},enumerable:!0,configurable:!0}),r.prototype.onUpdateTransform=function(){this._aabbBox.setOffset(this._pos)},r.prototype.copy=function(t){e.prototype.copy.call(this,t);for(var r in t.multiMaterial)"0"!=r&&(this._multiMaterial[r]=t.multiMaterial[r]);this._materialCount=t.materialCount},r.prototype.clone=function(){var t=null;this.animation&&(t=this.animation.clone());var e=new r(this.geometry,this.material,t);return e.copy(this),e},r.prototype.buildBoundBox=function(){var e=new t.BoundBox(this);if(this.geometry&&this.geometry.vertexArray){e.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE)),e.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var r=0;r<this.geometry.vertexArray.length;r+=this.geometry.vertexAttLength)e.max.x<this.geometry.vertexArray[r]&&(e.max.x=this.geometry.vertexArray[r]),e.max.y<this.geometry.vertexArray[r+1]&&(e.max.y=this.geometry.vertexArray[r+1]),e.max.z<this.geometry.vertexArray[r+2]&&(e.max.z=this.geometry.vertexArray[r+2]),e.min.x>this.geometry.vertexArray[r]&&(e.min.x=this.geometry.vertexArray[r]),e.min.y>this.geometry.vertexArray[r+1]&&(e.min.y=this.geometry.vertexArray[r+1]),e.min.z>this.geometry.vertexArray[r+2]&&(e.min.z=this.geometry.vertexArray[r+2])}return e.fillBox(e.min,e.max),e.createChild(),this.bound=e,this.initAABB(),e},r}(t.IRender);e.AABB_TL_1=new t.Vector3D,e.AABB_TR_1=new t.Vector3D,e.AABB_BL_1=new t.Vector3D,e.AABB_BR_1=new t.Vector3D,e.AABB_TL_2=new t.Vector3D,e.AABB_TR_2=new t.Vector3D,e.AABB_BL_2=new t.Vector3D,e.AABB_BR_2=new t.Vector3D,t.Mesh=e,__reflect(e.prototype,"egret3d.Mesh",["egret3d.IQuadNode"])}(egret3d||(egret3d={}));
var egret3d;!function(t){var e=function(){function e(e,r){void 0===e&&(e=null),void 0===r&&(r=null),this._autoUpdate=!0,this._origin=new t.Vector3D(0,0,0),this._speed=300,this._target=e,this._lookAtObject=r}return Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){this._target!=t&&(this._target=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){this._lookAtObject!=t&&(this._lookAtObject=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(t){this._speed=t},enumerable:!0,configurable:!0}),e.prototype.update=function(){},e}();t.ControllerBase=e,__reflect(e.prototype,"egret3d.ControllerBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r){this.volume=1,this.loop=!1,this.pitch=1,r=r||{},r.volume&&(this.volume=r.volume),r.loop&&(this.loop=r.loop),r.pitch&&(this.pitch=r.pitch),this.sound=e,this.paused=!1,t.AudioManager.instance.hasAudioContext()?(this.context=t.AudioManager.instance.context,this.startTime=0,this.startOffset=0,this.source=null,this.gain=this.context.createGain()):t.AudioManager.instance.hasAudio()&&this.sound.audio&&(this.source=this.sound.audio.cloneNode(!1),this.source.pause())}return e.prototype.play=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)throw new Error("Call stop() before calling play()");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration)}else t.AudioManager.instance.hasAudio&&(this.paused=!1,this.source.play());this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)},e.prototype.pause=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.startOffset+=this.context.currentTime-this.startTime,this.source.stop(0),this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&this.source.pause(),this.paused=!0},e.prototype.unpause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source||!this.paused)throw new Error("Call pause() before unpausing.");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)}else t.AudioManager.instance.hasAudio()&&this.source.play();this.paused=!1},e.prototype.stop=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.stop(0),this.startOffset=0,this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.pause(),this.source.currentTime=0)},e.prototype.setLoop=function(t){this.source&&(this.source.loop=t)},e.prototype.setVolume=function(e){this.gain?this.gain.gain.value=e*t.AudioManager.instance.volume:this.source&&(this.source.volume=e*t.AudioManager.instance.volume)},e.prototype.setPitch=function(e){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.playbackRate.value=e):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.playbackRate=e)},e.prototype.isPlaying=function(){return t.AudioManager.instance.hasAudioContext()?!this.paused:t.AudioManager.instance.hasAudio()?!this.source.paused:void 0},e.prototype.getDuration=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)return this.source.buffer.duration}else if(t.AudioManager.instance.hasAudio()&&this.source){var e=this.source.duration;if(e===e)return e}return 0},e.prototype.createSource=function(){var t=this;this.sound.buffer&&(this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(this.context.destination),this.loop&&(this.source.onended=function(){return t.play()}))},e}();t.Channel=e,__reflect(e.prototype,"egret3d.Channel")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vertex_ShaderName={},this.fragment_ShaderName={},this.attributes=new Array}return t.prototype.build=function(t,e){},t.prototype.onAnimTimeChange=function(){},t.prototype.importShader=function(t,e,r){var i=t?this.vertex_ShaderName:this.fragment_ShaderName,a=i[e]=i[e]||[];-1==a.indexOf(r)&&a.push(r)},t.prototype.afterBuild=function(){},t.prototype.initNode=function(t,e){},t.prototype.update=function(t,e,r){},t.prototype.activeState=function(t,e,r,i,a,n,o){},t.prototype.upload=function(){},t.prototype.dispose=function(){},t}();t.AnimationNode=e,__reflect(e.prototype,"egret3d.AnimationNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){var i=r.call(this)||this;return i._background=new t.Quad,i._container=new e.UIElement,r.prototype.addChild.call(i,i._background),r.prototype.addChild.call(i,i._container),i._w=100,i._h=100,i.drawBackground(),i.updateMask(),i}return __extends(i,r),i.prototype.updateMask=function(){this.mask=new t.Rectangle(0,0,this._w,this._h)},Object.defineProperty(i.prototype,"background",{get:function(){return this._background},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._w},set:function(t){this._w=t,this._background.width=t,this.updateMask()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._h},set:function(t){this._h=t,this._background.height=t,this.updateMask()},enumerable:!0,configurable:!0}),i.prototype.onRender=function(){r.prototype.onRender.call(this),this.drawBackground(),this.updateMask()},i.prototype.getDefaultStyleNameByStyleName=function(t){var r={background:e.DefaultSkinName.DEFAULT_PANEL_BACKGROUND},i=r[t];return i||console.log(" ERROR!!! UIPanel can't find default style : ",t),i},i.prototype.drawBackground=function(){var t=this.getStyle("background");this._background.texture=t},i.prototype.setStyle=function(t,e){r.prototype.setStyle.call(this,t,e),this.onRender()},i.prototype.addChild=function(t){return this._container.addChild(t)},i.prototype.addChildAt=function(t,e){return this._container.addChildAt(t,e)},i.prototype.removeChild=function(t){return this._container.removeChild(t)},i.prototype.removeChildAt=function(t){return this._container.removeChildAt(t)},i.prototype.swapChildIndex=function(t,e){this._container.swapChildIndex(t,e)},i.prototype.hasChild=function(t){return this._container.hasChild(t)},i.prototype.getChildByIndex=function(t){return this._container.getChildByIndex(t)},i.prototype.getChildByName=function(t){return this._container.getChildByName(t)},i}(e.UIElement);e.UIPanel=r,__reflect(r.prototype,"egret3d.gui.UIPanel")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){var t=r.call(this)||this;return t._selected=!1,t._textPadding=5,t.textField.autoSize=e.UITextFieldAutoSize.LEFT,t.textWidth=45,t.onRender(),t}return __extends(i,r),Object.defineProperty(i.prototype,"buttonAndLabelWidth",{get:function(){return this._skin.width+this.textPadding+this.textWidth},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textPadding",{get:function(){return this._textPadding},set:function(t){this._textPadding=t,this.onRender()},enumerable:!0,configurable:!0}),i.prototype.onRender=function(){r.prototype.onRender.call(this),this.textField.x=this._skin.width+this._textPadding},Object.defineProperty(i.prototype,"selected",{get:function(){return this._selected},set:function(r){if(this._selected!==r){this._selected=r,this._selected?this.setMouseState(i.STATE_UP_AND_SELECTED):this.setMouseState(e.UIButton.STATE_UP);var a=new t.Event3D(t.Event3D.CHANGE);a.target=this,this.dispatchEvent(a)}},enumerable:!0,configurable:!0}),i.prototype.setMouseState=function(t){t===e.UIButton.STATE_DOWN?this._selected?r.prototype.setMouseState.call(this,i.STATE_DOWN_AND_SELECTED):r.prototype.setMouseState.call(this,e.UIButton.STATE_DOWN):t===e.UIButton.STATE_UP?this._selected?r.prototype.setMouseState.call(this,i.STATE_UP_AND_SELECTED):r.prototype.setMouseState.call(this,e.UIButton.STATE_UP):r.prototype.setMouseState.call(this,t)},i.prototype.startPress=function(){r.prototype.startPress.call(this),this._selected?this.setMouseState(i.STATE_DOWN_AND_SELECTED):this.setMouseState(e.UIButton.STATE_DOWN)},i.prototype.endPress=function(){r.prototype.endPress.call(this),this.selected=!this.selected,this._selected?this.setMouseState(i.STATE_UP_AND_SELECTED):this.setMouseState(e.UIButton.STATE_UP)},i}(e.UILabelButton);r.STATE_DOWN_AND_SELECTED="downAndSelected",r.STATE_UP_AND_SELECTED="upAndSelected",e.UIToggleButtonBase=r,__reflect(r.prototype,"egret3d.gui.UIToggleButtonBase")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.pointlight=0]="pointlight",t[t.directlight=1]="directlight",t[t.spotLightlight=2]="spotLightlight"}(e=t.LightType||(t.LightType={}));var r=function(e){function r(){var r=e.call(this)||this;return r.lightId=-1,r.lightType=-1,r._ambient=new t.Vector3D(0,0,0),r._diffuse=new t.Vector3D(1,1,1),r._specular=new t.Vector3D(1,1,1),r._halfVector=new t.Vector3D(1,1,1),r._intensity=1,r._radius=100,r._cutoff=.01,r._halfIntensity=0,r._spotExponent=1.1,r._spotCutoff=.7,r._spotCosCutoff=.1,r._constantAttenuation=.1,r._linearAttenuation=.1,r._quadraticAttenuation=.1,r._lightIndex=-1,r.len=25,r._change=!0,r.lightViewPos=new t.Vector3D,r}return __extends(r,e),Object.defineProperty(r.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!=t&&(this._intensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){this._halfIntensity!=t&&(this._halfIntensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"ambient",{get:function(){return 0},set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"diffuse",{get:function(){return 0},set:function(t){this._diffuse.w=(t>>24&255)/255,this._diffuse.x=(t>>16&255)/255,this._diffuse.y=(t>>8&255)/255,this._diffuse.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"specular",{get:function(){return 0},set:function(t){this._specular.w=(t>>24&255)/255,this._specular.x=(t>>16&255)/255,this._specular.y=(t>>8&255)/255,this._specular.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),r.prototype.init=function(){},r.prototype.updateLightData=function(t,e,r){},r}(t.Object3D);t.LightBase=r,__reflect(r.prototype,"egret3d.LightBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.updateTime=1e3,this.time=0}return e.prototype.show=function(t,e,r){this.time+=t,this.time<this.updateTime||(this.showPerformancePanel(e),this.showCollectionPanel(r),this.time=0)},e.prototype._createPerformancePanel=function(){var t=document.createElement("div");return t.style.position="absolute",t.style.background="rgba(0,0,0,0.5)",t.style.left="0px",t.style.top="0px",t.style.pointerEvents="none",t.style.color="white",document.body.appendChild(t),t},e.prototype._createCollectionPanel=function(){var t=document.createElement("div");return t.style.position="absolute",t.style.background="rgba(0,0,0,0.5)",t.style.left="0px",t.style.top="300px",t.style.pointerEvents="none",t.style.color="white",document.body.appendChild(t),t},e.prototype.showPerformancePanel=function(t){this.performancePanel||(this.performancePanel=this._createPerformancePanel(),t.enable=!0);var e="<span>Performance: </span><br/>",r=t.getFps();e+="<span>fps: </span>"+(r||"--")+"<br/>";for(var i in t.entities)if("fps"!==i&&t.entities[i]){var a=t.entities[i];e+="<span>"+i+": </span>"+Math.round(a.averageDelta)+"ms<br/>"}this.performancePanel.innerHTML=e},e.prototype.showCollectionPanel=function(e){this.collectionPanel||(this.collectionPanel=this._createCollectionPanel());for(var r="<span>Collection: </span><br/>",i=0,a=e.view3Ds,n=e.view3Ds.length;n>i;i++){var o=a[i].entityCollect;r+="<span>view"+i+"-drawCall: </span>"+o.numberDraw.toString()+"<br/>",r+="<span>view"+i+"-vertex  : </span>"+o.numberVertex.toString()+"<br/>",r+="<span>view"+i+"-tris    : </span>"+o.numberFace.toString()+"<br/>",r+="<span>view"+i+"-skin    : </span>"+o.numberSkin.toString()+"<br/>",r+="<span>view"+i+"-proAnim : </span>"+o.numberAnimation.toString()+"<br/>",r+="<span>view"+i+"-particleEmiter: </span>"+o.numberParticle.toString()+"<br/>";for(var s=0;s<t.Layer.layerType.length;s++)r+="<span>view"+i+"-"+t.Layer.layerType[s]+" layer: </span>"+o.softLayerRenderItems[t.Layer.layerType[s]].length.toString()+"<br/>"}this.collectionPanel.innerHTML=r},e}();t.Egret3DInspector=e,__reflect(e.prototype,"egret3d.Egret3DInspector")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this.taskDict={},this.type=t}return t}();e.TYPE_SCENE="scene",e.TYPE_SKIN_MESH="ShinnedMesh",e.TYPE_EFFECT_GROUP="EffectGroup",e.TYPE_PARTICLE="ParticleConfig",e.TYPE_TEXTUREPACKER="TexturePacker",t.IConfigParser=e,__reflect(e.prototype,"egret3d.IConfigParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this)||this;return i.container=null,i.loader=null,i.autoPlayAnimation=!1,i._pathRoot="",i._configParser=null,i._mapParser=null,i._particleParser=null,i._texturePackerParser=null,i._taskCount=0,i._event=new t.LoaderEvent3D,i._type="",i._taskDict={},i._textures={},i.skinClipDict={},i.proAnimDict={},i.unitLoaderList=[],i._dictUnitLoader={},i._unitQueue=[],i.huds=[],i.lightDict={},i.autoAnimationList=[],i.continueProgressEvent=[],r&&i.load(r),i}return __extends(r,e),Object.defineProperty(r.prototype,"configParser",{get:function(){return this._configParser},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pathRoot",{get:function(){return this._pathRoot},set:function(t){this._pathRoot=t},enumerable:!0,configurable:!0}),r.prototype.addAutoAnimation=function(t,e,r,i,a){void 0===e&&(e=1),void 0===r&&(r=!1),void 0===i&&(i=!1),void 0===a&&(a="");var n={};n.animation=t,n.speed=e,n.reset=r,n.prewarm=i,n.name=a,this.autoAnimationList.push(n)},r.prototype.getAssetURLLoader=function(e){return t.assetMgr.findAsset(e,this)},r.prototype.createObject=function(){return new t.Object3D},r.prototype.findTexture=function(t){return this._textures[t]},r.prototype.load=function(e){if(this.reset(),this.resourceName=t.StringUtil.getURLName(e),this.url=e,this.pathRoot=t.StringUtil.getPath(e),this._type=t.StringUtil.getFileFormat(e),this.taskTotal++,this._taskDict[this.url]={},this._taskDict[this.url].status=1,this._taskDict[this.url].currentProgress=0,this._type==t.ILoader.DATAFORMAT_E3DPACK){this.loader=this.doAssetLoader(this.url,this.onE3dPack);var r=this.pathRoot+"MapConfig.json";this.processUrlContinue(r)}else this.loader=this.doAssetLoader(this.url,this.onConfigLoad);this.processUrlContinue(e)},r.prototype.onE3dPack=function(e){var r=e.loader;this._type=t.ILoader.DATAFORMAT_JSON,this.pathRoot+=this.resourceName+"/";var i=this.pathRoot+"MapConfig.json";t.assetMgr.getByteArray(i)&&(this.taskTotal++,this._taskDict[i]={},this._taskDict[i].status=1,this._taskDict[i].currentProgress=0,this.doAssetLoader(i,this.onConfigLoad,this)),this.processTask(r)},r.prototype.processUrlContinue=function(e){var r=t.StringUtil.getFileFormat(e);r==t.ILoader.DATAFORMAT_E3DPACK&&this.continueProgressEvent.push(e),r==t.ILoader.DATAFORMAT_JSON&&this.continueProgressEvent.push(e)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this.reset(),this.container=null},r.prototype.onProgress=function(e){var r=e.target;if(this._taskDict[r.url]&&(this._taskDict[r.url].currentProgress=r.currentProgress,this.currentProgress=this.calculateProgress(),this.currentProgress<1)){var i=e.loader;this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.loader=i,this._event.data=i.data,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event)}},r.prototype.reset=function(){t.assetMgr.dispose(this),this.url&&(t.assetMgr.removeByteArray(this.url),t.textureResMgr.removeTexture(this.url),this.url=null),this.taskTotal=0,this.taskCurrent=0,this._taskCount=0,this._taskDict={},this._textures={},this.skinClipDict={},this.huds=[],this.lightDict={},this._mapParser=null,this._configParser=null,this._event.target=null,this._event.loader=null,this._event.data=null;for(var e=0;e<this.unitLoaderList.length;++e)this.unitLoaderList[e].dispose();this.unitLoaderList.length=0,this._dictUnitLoader={},this._unitQueue.length=0,this._currentUnitLoader=null,this.continueProgressEvent.length=0},r.prototype.parseParticle=function(){if(this.data=this._particleParser.data,this._particleParser.data.shape.meshFile||this._particleParser.data.property.meshFile){if(this._particleParser.data.shape.meshFile){var t=this._pathRoot+this._particleParser.data.shape.meshFile,e={};e.particle=this._particleParser.data,e.type="shape",this.doAssetLoader(t,this.onParticleEsmLoad1,e)}if(this._particleParser.data.property.meshFile){var t=this._pathRoot+this._particleParser.data.property.meshFile,e={};e.particle=this._particleParser.data,e.type="property",this.doAssetLoader(t,this.onParticleEsmLoad1,e)}}},r.prototype.parseUnit=function(){if(this.processNode(),this.processSkinClip(),this.processProAnim(),this.createLight(),this._mapParser.uv2){var t=this.pathRoot+this._mapParser.uv2;this.doAssetLoader(t,this.onCompleteUv2)}else this.onProcessNodeLoad()},r.prototype.onCompleteUv2=function(t){var e=t.loader;this.uv2Dict=t.data,this.onProcessNodeLoad(),this.processTask(e)},r.prototype.onProcessNodeLoad=function(){for(var e=0;e<this._mapParser.nodeList.length;e++){var r=this._mapParser.nodeList[e];switch(r.object3d.parent||this.container.addChild(r.object3d),r.type){case"Object3D":case"Camera3D":case"DirectLight":case"PointLight":this.doLoadEpa(r);break;case"CubeSky":case"SphereSky":case"Mesh":if(r.path){var i=this._pathRoot+r.path;this.doAssetLoader(i,this.onEsmLoad,r)}else r.geometry&&this.processMesh(r,t.GeometryUtil.createGemetryForType(r.geometry.type,r.geometry));break;case"Terrain":if(r.path){var i=this._pathRoot+r.path;this.doAssetLoader(i,this.onHeightImg,r)}break;case"ParticleEmitter":if(r.path){var i=this._pathRoot+r.path,a=this.doUnitLoader(i,this.onUnitLoader,r);1==this._configParser.version&&(a.pathRoot=this._pathRoot)}break;case"EffectGroup":if(r.path){var i=this._pathRoot+r.path;this.doUnitLoader(i,this.onUnitLoader,r)}}}for(var e=0;e<this._mapParser.textures.length;++e){var n=this._mapParser.textures[e],i=this._pathRoot+n.path;this.doAssetLoader(i,this.onTexture,n.name)}for(var e=0;e<this._mapParser.hudList.length;++e){var o=this._mapParser.hudList[e],s=new t.HUD;if(s.name=o.name,s.bothside=o.bothside,s.x=o.x,s.y=o.y,s.rotationX=o.rx,s.rotationY=o.ry,s.rotationZ=o.rz,s.width=o.width,s.height=o.height,o.vs&&(s.vsShader=o.vs),o.fs&&(s.fsShader=o.fs),this.huds.push(s),o.hud=s,o.texture){var i=this._pathRoot+o.texture;this.doAssetLoader(i,this.onHudTexture,o)}}},r.prototype.parseTexturePacker=function(){if(this._texturePackerParser.data.meta&&this._texturePackerParser.data.meta.image){var t=this._pathRoot+this._texturePackerParser.data.meta.image;this.doAssetLoader(t,this.onTexturePackerLoad)}},r.prototype.onTexturePackerLoad=function(e){var r=e.loader;this.data=r.data,t.textureResMgr.addTexture(this.url,this._texturePackerParser.data,r.data),this.processTask(r)},r.prototype.parseConfig=function(e,r){if(this._configParser=t.UnitParserUtils.parserConfig(e,r),!this._configParser)return!1;var i="";for(var a in this._configParser.taskDict)this.taskTotal++,i=this._pathRoot+a,this._taskDict[i]={},this._taskDict[i].status=1,this._taskDict[i].currentProgress=0;switch(this._configParser.type){case t.IConfigParser.TYPE_SCENE:this._mapParser=this._configParser,this.container=this.container||new t.Scene3D,this.parseUnit();break;case t.IConfigParser.TYPE_SKIN_MESH:this.container=this.container||new t.Role,this._mapParser=this._configParser,this.parseUnit();break;case t.IConfigParser.TYPE_EFFECT_GROUP:this.container=this.container||new t.EffectGroup,this._mapParser=this._configParser,this.parseUnit();break;case t.IConfigParser.TYPE_PARTICLE:this._particleParser=this._configParser,this.parseParticle();break;case t.IConfigParser.TYPE_TEXTUREPACKER:this._texturePackerParser=this._configParser,this.parseTexturePacker();break;default:return!1}return this.container&&(this.data=this.container),!0},r.prototype.processParticle=function(t,e){if(t.shape.meshFile||t.property.meshFile){if(t.shape.meshFile){var r=this._pathRoot+t.shape.meshFile,i={};i.particle=t,i.nodeData=e,i.type="shape",this.doAssetLoader(r,this.onParticleEsmLoad,i)}if(t.property.meshFile){var r=this._pathRoot+t.property.meshFile,i={};i.particle=t,i.nodeData=e,i.type="property",this.doAssetLoader(r,this.onParticleEsmLoad,i)}}else this.processParticleGeometry(t,e);return null},r.prototype.processParticleGeometry=function(e,r){e.materialData=this._mapParser.matDict[r.materialIDs[0]];var i=new t.ParticleEmitter(e,new t.TextureMaterial);r.visible=t.Egret3DPolicy.useParticle,this.processObject3d(r,i),(this.autoPlayAnimation||e.property.playOnAwake)&&this.addAutoAnimation(i,1,!1,e.property.prewarm),this.processMat(r)},r.prototype.processObject3d=function(t,e){e.name=t.object3d.name,e.visible=t.visible,e.position=t.object3d.position,e.orientation=t.object3d.orientation,e.scale=t.object3d.scale,""!=t.tagName&&(e.tag.name=t.object3d.tag.name),t.object3d.swapObject(e),t.object3d=e},r.prototype.onConfigLoad=function(e){var r=e.loader;switch(this._type){case t.ILoader.DATAFORMAT_XML:case t.ILoader.DATAFORMAT_JSON:this.parseConfig(r.data,this._type)||(this.data=r.data);break;default:this.data=r.data}this.processTask(r)},r.prototype.onHeightImg=function(e){var r=e.loader,i=e.param,a=i.geometry,n=new t.Terrain(r.data,a.width,a.height,a.depth,a.segmentsW,a.segmentsH,!1,new t.TextureMaterial(r.data));this.processHeightMesh(i,n);var o=i.grass;if(o)for(var s=0;s<o.length;++s){var l=o[s],h=this._pathRoot+l.detailTexture,u={};u.grassData=l,u.mapNodeData=i,this.doAssetLoader(h,this.onGrassDetailTexture,u)}this.processTask(r)},r.prototype.doAssetLoader=function(e,r,i){void 0===i&&(i=null),this.addTask();var a=t.assetMgr.loadAsset(e,r,this,i);return t.assetMgr.addEventListener(e,t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this),a},r.prototype.doUnitLoader=function(e,i,a){var n=this;void 0===a&&(a=null),this.addTask();var o=this._dictUnitLoader[e];return o||(o={pathRoot:null,loader:new r},this._dictUnitLoader[e]=o,o.loader.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onUnitComplete,this,a),this.unitLoaderList.push(o.loader),this._unitQueue.push(e),this._currentUnitLoader||(this._currentUnitLoader=o.loader,this._currentUnitLoader.load(e))),o.loader.data?setTimeout(function(){if(i){var e=new t.LoaderEvent3D;e.eventType=t.LoaderEvent3D.LOADER_COMPLETE,e.target=o.loader,e.loader=o.loader,e.data=o.loader.data,e.param=a,i.call(n,e)}},0):(o.loader.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,i,this,a),o.loader.addEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this)),o},r.prototype.onUnitComplete=function(t){if(this._unitQueue.shift(),this._unitQueue.length>0){var e=this._unitQueue[0],r=this._dictUnitLoader[e];this._currentUnitLoader=r.loader,this._currentUnitLoader.load(e),r.pathRoot&&(this._currentUnitLoader.pathRoot=r.pathRoot)}else this._currentUnitLoader=null},r.prototype.onTexture=function(t){var e=t.loader,r=t.param;this._textures[r]=e.data,this.processTask(e)},r.prototype.onHudTexture=function(t){var e=t.loader,r=t.param;r.hud.diffuseTexture=e.data,this.processTask(e)},r.prototype.onMaterialTexture=function(t){var e=t.loader,r=t.param,i=null,a=null,n=r.mapNodeData;i=n.object3d,a=i.getMaterial(r.matID),a[r.type]=e.data,this.processTask(e)},r.prototype.onMethodTexture=function(t){var e=t.loader,r=t.param;r.method[r.textureName]=e.data,this.processTask(e)},r.prototype.onGrassDetailTexture=function(e){var r=e.loader,i=e.param,a=i.grassData,n=i.mapNodeData,o=n.object3d,s=this.getGrassPositions(o,r.data);if(s.length>0){var l=new t.TextureMaterial;l.ambientColor=16777215,l.blendMode=t.BlendMode.NORMAL,l.cutAlpha=.4;var h=new t.Rectangle(o.x,o.z,2*o.x,2*o.z),u=new t.GrassMesh(s,l,a);u.method.setLightMapData(t.CheckerboardTexture.texture,h),o.addChild(u),o.x,o.y;var c=i.grassData;if(c.grassTexture){var d=this._pathRoot+c.grassTexture;this.doAssetLoader(d,this.onGrassDiffuseTexture,u.material)}}this.processTask(r)},r.prototype.getGrassPositions=function(t,e){for(var r,i,a,n,o,s=t.geometry,l=e.readPixels(0,0,e.width,e.height),h=l.width,u=l.height,c=1/16,d=[],p=0;u>p;p++)for(var f=0;h>f;f++)if(i=p*h+f,i*=4,r=l.data[i]*c,r=Math.round(r),r>0)for(var m=0;r>m;m++)n=f+Math.random()-.5,o=p+Math.random()-.5,0>n?n=0:n>=h&&(n=h-.01),0>o?o=0:o>=u&&(o-=.01),a=s.get3DCoordAtPixel(n,o,h,u),d.push(a);return d},r.prototype.onGrassDiffuseTexture=function(t){var e=t.loader;t.param.diffuseTexture=e.data,this.processTask(e)},r.prototype.doLoadEpa=function(e){if(e.propertyAnims)for(var r=0;r<e.propertyAnims.length;++r){e.object3d.proAnimation||(e.object3d.proAnimation=new t.PropertyAnimController(e.object3d));var i=e.propertyAnims[r],a=this._pathRoot+i.path;this.doAssetLoader(a,this.onEpaLoad,e)}var n=this.proAnimDict[e.propertyAnimsId];n&&(e.object3d.proAnimation=n)},r.prototype.processEpa=function(t,e){t.object3d.proAnimation.propertyAnimController.addPropertyAnim(e),this.autoPlayAnimation&&t.object3d.proAnimation&&this.addAutoAnimation(t.object3d.proAnimation)},r.prototype.processHeightMesh=function(t,e){this.processObject3d(t,e),this.processMat(t),this.doLoadEpa(t)},r.prototype.processMesh=function(e,r){var i=this.skinClipDict[e.skeletonAnimation],a=null;"Mesh"==e.type?a=new t.Mesh(r,new t.TextureMaterial,i):"CubeSky"==e.type?a=new t.Sky(r,new t.CubeTextureMaterial):"SphereSky"==e.type&&(a=new t.Sky(r,new t.TextureMaterial)),t.EUMVersion.fillGeometryUv2(e.uv2Id,this.uv2Dict,a.geometry),this.processObject3d(e,a),this.processMat(e);for(var n=0;n<e.skinClips.length;n++){var o=e.skinClips[n],s=this._pathRoot+o.path,l={};l.eamData=o,l.mapNodeData=e,this.doAssetLoader(s,this.onEamLoad,l)}this.doLoadEpa(e)},r.prototype.onEsmLoad=function(e){var r=e.loader,i=e.param;if(i){var a=r.data;this.uv2Dict&&this.uv2Dict[i.uv2Id]&&(a=new t.Geometry,a.copy(r.data)),this.processMesh(i,a)}this.processTask(r)},r.prototype.onParticleEsmLoad=function(t){var e=t.loader,r=t.param,i=r.particle,a=r.nodeData;switch(r.type){case"shape":i.shape.geometry=e.data;break;case"property":i.property.geometry=e.data}var n=0,o=0;i.shape.meshFile&&n++,i.property.meshFile&&n++,i.shape.geometry&&o++,i.property.geometry&&o++,o==n&&this.processParticleGeometry(i,a),this.processTask(e)},r.prototype.onParticleEsmLoad1=function(t){var e=t.loader,r=t.param,i=r.particle;switch(r.type){case"shape":i.shape.geometry=e.data;break;case"property":i.property.geometry=e.data}var a=0,n=0;i.shape.meshFile&&a++,i.property.meshFile&&a++,i.shape.geometry&&n++,i.property.geometry&&n++,n==a&&(this.data=i),this.processTask(e)},r.prototype.onEamLoad=function(t){var e=t.loader,r=t.param,i=e.data;i.animationName=r.eamData.name;var a=r.mapNodeData.object3d;a.animation.skeletonAnimationController.state.addAnimClip(i),this.autoPlayAnimation&&this.addAutoAnimation(a.animation,1,!1,!1,i.animationName),this.processTask(e)},r.prototype.onSkinClip=function(t){var e=t.loader,r=t.param,i=r.skinClip,a=r.skinData,n=r.clip,o=e.data;o.animationName=n.name,n.loop&&(o.isLoop="true"==n.loop?!0:!1),i.state.addAnimClip(o),this.autoPlayAnimation?this.addAutoAnimation(i,1,!1,!1,o.animationName):a.auto&&""!=a.auto&&this.addAutoAnimation(i,1,!1,!1,o.animationName),this.processTask(e)},r.prototype.onProAnim=function(t){var e=t.loader,r=t.param,i=r.proAnimation,a=r.proData,n=r.clip,o=e.data;o=o.clone(),n.loop&&(o.isLoop="true"==n.loop?!0:!1),n.name&&(o.name=n.name),i.addPropertyAnim(o),this.autoPlayAnimation?this.addAutoAnimation(i,1,!1,!1,n.name):a.auto&&""!=a.auto&&this.addAutoAnimation(i,1,!1,!1,a.auto),this.processTask(e)},r.prototype.onEpaLoad=function(t){var e=t.loader,r=t.param,i=e.data,a=i.clone();this.processEpa(r,a),this.processTask(e)},r.prototype.addTask=function(){this._taskCount++},r.prototype.calculateProgress=function(){var t=0;for(var e in this._taskDict){for(var r=!1,i=0;i<this.continueProgressEvent.length;++i)if(e==this.continueProgressEvent[i]){r=!0;break}t+=r?.1/this.continueProgressEvent.length*this._taskDict[e].currentProgress:.9/(this.taskTotal-this.continueProgressEvent.length)*this._taskDict[e].currentProgress}return t},r.prototype.processTaskCurrent=function(e){if(this._taskDict[e.url]&&1==this._taskDict[e.url].status){this.taskCurrent++,this._taskDict[e.url].status=2,this._taskDict[e.url].currentProgress=1,this._event.loader=e,this._event.data=e.data;this.currentProgress=this.calculateProgress(),this.currentProgress<1&&(this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event)),this._event.currentProgress=this.currentProgress,this._event.eventType=t.LoaderEvent3D.LOADER_ONCE_COMPLETE,this.dispatchEvent(this._event)}},r.prototype.processTask=function(e){this.processTaskCurrent(e),this._taskCount--,this._taskCount<=0&&(this.currentProgress=1,this.onLoaderComplete(),this._event.loader=this,this._event.data=this.data,this._event.currentProgress=this.currentProgress,this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this.dispatchEvent(this._event),this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE,this.dispatchEvent(this._event))},r.prototype.onLoaderComplete=function(){if(this._configParser){if(this._mapParser){this.data=this.container;for(var e=[],r=0;r<this._mapParser.nodeList.length;r++){var i=this._mapParser.nodeList[r];if(i.object3d instanceof t.ParticleEmitter)for(var a=i.object3d,n=0;n<i.childs.length;++n){var o=i.childs[n],s=this.container.findObject3D(o.name);e.push(s),s instanceof t.ParticleEmitter&&a.addSubEmitter(Number(t.ParticleDataSubEmitterPhase[o.phase]),s)}if(i.boneBind.skeletonAnimation){var l=Number(i.boneBind.skeletonAnimation),h=this.skinClipDict[l];h.bindToJointPose(i.boneBind.boneName,i.object3d)}}for(var u,r=0;r<e.length;r++)u=e[r],u&&u.parent&&u.parent.removeChild(u);var c=!0;if(c){var d=t.StaticMergeUtil.bacthingMesh(this._mapParser);for(var p in d)this.container.addChild(d[p])}}if(this.view3d)for(var r=0;r<this.huds.length;++r)this.view3d.addHUD(this.huds[r]);for(var r=0;r<this.autoAnimationList.length;++r){var f=this.autoAnimationList[r];f.animation instanceof t.SkeletonAnimation?f.animation.play(f.name,f.speed,f.reset,f.prewarm):f.animation instanceof t.PropertyAnimController?f.animation.play(f.name):f.animation instanceof t.MethodBase?f.animation.start(!0):f.animation instanceof t.ParticleEmitter?f.animation.play(f.speed,f.reset,f.prewarm):f.animation instanceof t.EffectGroup&&f.animation.play()}if(this._configParser.type==t.IConfigParser.TYPE_EFFECT_GROUP){var m=this.data;m&&(m.init(this._mapParser.loop),this._mapParser.auto&&m.play())}if(this._configParser.type==t.IConfigParser.TYPE_SKIN_MESH){var _=this.data;for(var v in this.skinClipDict){_.skeletonAnimation=this.skinClipDict[v];break}}}},r.prototype.addImaTask=function(t,e,r,i,a){var n=null,o=this._pathRoot+t,s={};return s.type=e,s.matID=r,s.mapNodeData=i,this.doAssetLoader(o,this.onMaterialTexture,s),n},r.prototype.addMethodImgTask=function(t,e,r){var i=this._pathRoot+t,a={};a.method=e,a.textureName=r;var n=this.doAssetLoader(i,this.onMethodTexture,a);return n},r.prototype.processMat=function(e){for(var r=e.object3d,i=0;i<e.materialIDs.length;++i){var a=this._mapParser.matDict[e.materialIDs[i]];if(a){var n=r.getMaterial(i);n||(n=new t.TextureMaterial,r.addSubMaterial(i,n));
var o=null;""!=a.diffuseTextureName&&(o=this.addImaTask(a.diffuseTextureName,"diffuseTexture",i,e,n)),""!=a.normalTextureName&&(o=this.addImaTask(a.normalTextureName,"normalTexture",i,e,n)),""!=a.specularTextureName&&(o=this.addImaTask(a.specularTextureName,"specularTexture",i,e,n)),""!=a.matcapTextureName&&(o=this.addImaTask(a.matcapTextureName,"matcapTexture",i,e,n)),n.diffuseColor=a.diffuseColor,n.ambientColor=a.ambientColor,n.specularColor=a.specularColor,n.tintColor=a.tintColor,n.alpha=a.alpha,n.specularLevel=a.specularLevel,n.gloss=a.gloss,n.gamma=a.gamma,n.refraction=a.refraction,n.refractionintensity=a.refractionintensity,n.castShadow=a.castShadow,n.acceptShadow=a.acceptShadow,n.repeat=a.repeat,n.bothside=a.bothside,n.drawMode=a.drawMode,n.cullMode=a.cullMode,n.blendMode=a.blendMode,n.cutAlpha=a.cutAlpha,n.uvRectangle.copyFrom(a.uvRectangle);for(var s=new t.LightGroup,l=0;l<a.lightIds.length;++l){var h=this.lightDict[a.lightIds[l]];h&&s.addLight(h)}s.lightNum>0&&(n.lightGroup=s),this.processMethod(n,a)}}for(var u=r.lightGroup||new t.LightGroup,i=0;i<e.lightIds.length;++i){var h=this.lightDict[e.lightIds[i]];h&&u.addLight(h)}u.lightNum>0&&(r.lightGroup=u)},r.prototype.processMethod=function(e,r){for(var i=null,a=0,n=r.methods;a<n.length;a++)i=n[a],t.MethodUtils.doMethod(e,i,this)},r.prototype.processNode=function(){for(var e=0;e<this._mapParser.nodeList.length;e++){var r=this._mapParser.nodeList[e];if("Camera3D"==r.type){var i=new t.Camera3D;i.fieldOfView=r.fov,i.near=r.clipNear,i.far=r.clipFar,r.object3d=i}else if("Billboard"==r.type)r.object3d=new t.Billboard(new t.TextureMaterial(t.CheckerboardTexture.texture));else if("Terrain"==r.type)r.object3d=new t.Object3D;else if("DirectLight"==r.type){var a=new t.DirectLight;r.object3d=a,a.lightId=r.lightData.id,a.diffuse=r.lightData.diffuseColor,a.ambient=r.lightData.ambientColor,a.halfIntensity=r.lightData.halfIntensity,a.intensity=r.lightData.intensity,this.lightDict[r.lightData.id]=a}else if("PointLight"==r.type){var n=new t.PointLight;r.object3d=n,n.lightId=r.lightData.id,n.ambient=r.lightData.ambientColor,n.diffuse=r.lightData.diffuseColor,n.radius=r.lightData.radius,n.cutoff=r.lightData.falloff,n.intensity=r.lightData.intensity,this.lightDict[r.lightData.id]=n}else r.object3d=new t.Object3D;r.object3d.name=r.name,r.object3d.visible=r.visible,r.object3d.position=new t.Vector3D(r.x,r.y,r.z),r.object3d.orientation=new t.Quaternion(r.rx,r.ry,r.rz,r.rw),r.object3d.scale=new t.Vector3D(r.sx,r.sy,r.sz),""!=r.tagName&&(r.object3d.tag.name=r.tagName)}for(var e=0;e<this._mapParser.nodeList.length;e++)for(var o=this._mapParser.nodeList[e],s=0;s<this._mapParser.nodeList.length;s++){var l=this._mapParser.nodeList[s];if(o.parent==l.insID){l.object3d.addChild(o.object3d);break}}},r.prototype.processSkinClip=function(){for(var e in this._mapParser.skeletonAnimationDict){var r=this._mapParser.skeletonAnimationDict[e],i=Number(e),a=new t.SkeletonAnimation(new t.SkeletonAnimationState);this.skinClipDict[i]=a;for(var n=0;n<r.clips.length;++n){var o=r.clips[n],s=this._pathRoot+o.path,l={};l.skinClip=a,l.skinData=r,l.clip=o,this.doAssetLoader(s,this.onSkinClip,l)}}},r.prototype.processProAnim=function(){for(var e in this._mapParser.proAnimationDict){var r=this._mapParser.proAnimationDict[e],i=Number(e),a=new t.PropertyAnimController;this.proAnimDict[i]=a;for(var n=0;n<r.clips.length;++n){var o=r.clips[n],s=this._pathRoot+o.path,l={};l.proAnimation=a,l.proData=r,l.clip=o,this.doAssetLoader(s,this.onProAnim,l)}}},r.prototype.createLight=function(){var e=null;for(var r in this._mapParser.lightDict)if(e=this._mapParser.lightDict[r],e.type==t.LightType.directlight&&this._mapParser.directLight){var i=new t.DirectLight(e.direction);i.lightId=e.id,i.diffuse=e.diffuseColor,i.ambient=e.ambientColor,i.halfIntensity=e.halfIntensity,i.intensity=e.intensity,this.lightDict[e.id]=i}else if(e.type==t.LightType.pointlight&&this._mapParser.pointLight){var a=new t.PointLight(0);a.lightId=e.id,a.position=e.position,a.ambient=e.ambientColor,a.diffuse=e.diffuseColor,a.radius=e.radius,a.cutoff=e.falloff,a.intensity=e.intensity,this.lightDict[e.id]=a}},r.prototype.onUnitLoader=function(e){var i=e.param,a=e.target;switch(a.removeEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onUnitLoader,this),i.type){case r.NODE_TYPE_EffectGroup:this.processObject3d(i,a.container);var n=a.container;n&&i.auto&&this.addAutoAnimation(n);break;case r.NODE_TYPE_ParticleEmitter:var o=a.data;o.materialData=this._mapParser.matDict[i.materialIDs[0]];var s=new t.ParticleEmitter(o,new t.TextureMaterial);i.visible=t.Egret3DPolicy.useParticle,this.processObject3d(i,s),(this.autoPlayAnimation||o.property.playOnAwake)&&this.addAutoAnimation(s,1,!1,o.property.prewarm),this.processMat(i)}this.doLoadEpa(i),this.processTask(a)},r}(t.ILoader);e.NODE_TYPE_Object3D="Object3D",e.NODE_TYPE_Camera3D="Camera3D",e.NODE_TYPE_CubeSky="CubeSky",e.NODE_TYPE_SphereSky="SphereSky",e.NODE_TYPE_MESH="Mesh",e.NODE_TYPE_Terrain="Terrain",e.NODE_TYPE_ParticleEmitter="ParticleEmitter",e.NODE_TYPE_EffectGroup="EffectGroup",t.UnitLoader=e,__reflect(e.prototype,"egret3d.UnitLoader")}(egret3d||(egret3d={}));var nid;!function(t){"use strict";var e=function(){function e(){this.decoder=new t.LzmaDecoder}return e.prototype.decode=function(e){this.data=e;var r,i=new Uint8Array(13);for(r=0;13>r;r++)i[r]=e[r];this.decoder.decodeProperties(i);var a=0,n=!1;for(r=0;8>r;r++){var o=i[5+r];255!=o&&(n=!0),a|=o<<8*r}this.decoder.markerIsMandatory=!n,n?console.log("Uncompressed Size : "+a+" bytes"):console.log("End marker is expected"),this.decoder.rangeDec.inStream=e,this.decoder.create();var s=this.decoder.decode(n,a);if(s==t.LZMAConfig.LZMA_RES_ERROR)throw"LZMA decoding error";if(s==t.LZMAConfig.LZMA_RES_FINISHED_WITHOUT_MARKER);else{if(s!=t.LZMAConfig.LZMA_RES_FINISHED_WITH_MARKER)throw"Internal Error";if(n&&this.decoder.outWindow.out_pos!=a)throw"Finished with end marker before than specified size"}return this.decoder.rangeDec.corrupted&&console.log("Warning: LZMA stream is corrupted"),this.decoder.outWindow.outStream},e}();t.LZMA=e,__reflect(e.prototype,"nid.LZMA")}(nid||(nid={}));var egret3d;!function(t){var e=function(e){function r(t,r){var i=e.call(this,t,r)||this;return i._mapConfigParser.version=Number(t.version),i._mapConfigParser.engineVersion=String(t.egret3DVersion),i}return __extends(r,e),r.prototype.parser=function(){void 0==this._mapConfigParser.engineVersion&&console.log("the resource engine Version is old , but the current engine Version is "+t.Egret3DPolicy.engineVersion);var e=t.Egret3DPolicy.exportToolsVersion.indexOf(this._mapConfigParser.engineVersion);if(-1==e&&console.log("the resource engine Version is "+this._mapConfigParser.engineVersion+", but the current engine Version is "+t.Egret3DPolicy.engineVersion),this._versionParser=t.UnitParserUtils.jsonVersion(this._mapConfigParser.version,this._data,this._mapConfigParser),this._versionParser.parseEnvironment(this._data.env),this._data.auto&&(this._mapConfigParser.auto="true"==this._data.auto?!0:!1),this._data.loop&&(this._mapConfigParser.loop="true"==this._data.loop?!0:!1),this._data.uv2&&(this._mapConfigParser.uv2=this._data.uv2),this._mapConfigParser.calculateTask(),this._data.propertyAnimations)for(var r=0;r<this._data.propertyAnimations.length;r++){var i=this._data.propertyAnimations[r],a=Number(i.id);i&&(this._mapConfigParser.proAnimationDict[a]=i,this._mapConfigParser.calculateProAnimationTask(i))}if(this._data.skeletonAnimations)for(var r=0;r<this._data.skeletonAnimations.length;r++){var n=this._data.skeletonAnimations[r],a=Number(n.id);n&&(this._mapConfigParser.skeletonAnimationDict[a]=n,this._mapConfigParser.calculateSkeletonAnimationTask(n))}if(this._data.mats)for(var r=0;r<this._data.mats.length;r++){var o=this._versionParser.parseMat(this._data.mats[r]);o&&(this._mapConfigParser.matDict[o.id]=o,this._mapConfigParser.calculateMatTask(o))}if(this._data.nodes)for(var r=0;r<this._data.nodes.length;r++){var s=this._versionParser.parseNode(this._data.nodes[r]);s&&(this._mapConfigParser.nodeList.push(s),this._mapConfigParser.calculateNodeTask(s))}if(this._data.textures)for(var r=0;r<this._data.textures.length;r++)this._versionParser.parseTexture(this._data.textures[r]);if(this._data.huds)for(var r=0;r<this._data.huds.length;r++){var l=this._versionParser.parseHud(this._data.huds[r]);l&&(this._mapConfigParser.hudList.push(l),this._mapConfigParser.calculateHudTask(l))}},r}(t.UnitParser);t.UnitJsonParser=e,__reflect(e.prototype,"egret3d.UnitJsonParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t,r){var i=e.call(this,t,r)||this,a=t.getElementsByTagName("version");return i._mapConfigParser.version=Number(a[0].textContent),i}return __extends(r,e),r.prototype.parser=function(){this._versionParser=t.UnitParserUtils.xmlVersion(this._mapConfigParser.version,this._data,this._mapConfigParser);var e=this._data.getElementsByTagName("mat"),r=this._data.getElementsByTagName("node"),i=this._data.getElementsByTagName("env"),a=(this._data.getElementsByTagName("cameraAnims"),this._data.getElementsByTagName("hud")),n=this._data.getElementsByTagName("texture");this.parseEnvironment(i);for(var o=0;o<e.length;o++){var s=this._versionParser.parseMat(e[o]);s&&(this._mapConfigParser.matDict[s.id]=s,this._mapConfigParser.calculateMatTask(s))}for(var o=0;o<r.length;o++){var l=this._versionParser.parseNode(r[o]);l&&(this._mapConfigParser.nodeList.push(l),this._mapConfigParser.calculateNodeTask(l))}for(var o=0;o<n.length;o++)this.parseTexture(n[o]);for(var o=0;o<a.length;o++){var h=this._versionParser.parseHud(a[o]);h&&(this._mapConfigParser.hudList.push(h),this._mapConfigParser.calculateHudTask(h))}},r.prototype.nodeFilter=function(t){return"#text"==t.nodeName||"#comment"==t.nodeName},r}(t.UnitParser);t.UnitXmlParser=e,__reflect(e.prototype,"egret3d.UnitXmlParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.passes={},null==e?this.setData(new t.MaterialData):this.setData(e)}return e.prototype.setData=function(e){this.materialData=e,this.initPass(),this.blendMode=t.BlendMode.NORMAL},e.prototype.getData=function(){return this.materialData},e.prototype.initPass=function(){this.creatPass(t.PassType.colorPass)},Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(e){if(this._lightGroup=e,this.passes[t.PassType.diffusePass]&&this.passes[t.PassType.diffusePass].length>0)for(var r=0;r<this.passes[t.PassType.diffusePass].length;r++)this.passes[t.PassType.diffusePass][r].lightGroup=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depth",{get:function(){return this.materialData.depthTest},set:function(t){this.materialData.depthTest=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthWrite",{get:function(){return this.materialData.depthWrite},set:function(t){this.materialData.depthWrite=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthMode",{get:function(){return this.materialData.depthMode},set:function(t){this.materialData.depthMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this.materialData.diffuseTexture},set:function(e){e&&(this.materialData.diffuseTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.diffuse_fragment),this.materialData.shaderPhaseTypes[t.PassType.shadowPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.shadowPass].push(t.ShaderPhaseType.diffuse_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffuseTexture3D",{get:function(){return this.materialData.diffuseTexture3D},set:function(e){e&&(this.materialData.diffuseTexture3D=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.diffuse_fragment),this.materialData.shaderPhaseTypes[t.PassType.shadowPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.shadowPass].push(t.ShaderPhaseType.diffuse_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalTexture",{get:function(){return this.materialData.normalTexture},set:function(e){e&&(this.materialData.normalTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.normal_fragment),this.passInvalid(t.PassType.diffusePass)),this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.normal_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.normal_fragment))},enumerable:!0,configurable:!0}),e.prototype.passInvalid=function(t){if(this.passes[t]&&this.passes[t].length>0)for(var e=0;e<this.passes[t].length;e++)this.passes[t][e].passInvalid()},Object.defineProperty(e.prototype,"matcapTexture",{get:function(){return this.materialData.normalTexture},set:function(e){e&&(this.materialData.matcapTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)&&(this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.matCap_fragment),this.passInvalid(t.PassType.diffusePass)),this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.matCap_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.matCap_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularTexture",{get:function(){return this.materialData.specularTexture},set:function(e){e&&(this.materialData.specularTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.specular_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"drawMode",{get:function(){return this.materialData.drawMode},set:function(t){this.materialData.drawMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cutAlpha",{get:function(){return this.materialData.cutAlpha},set:function(t){this.materialData.cutAlpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffuseColor",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ambientColor",{get:function(){return this.materialData.ambientColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.ambientColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularColor",{get:function(){return this.materialData.specularColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.specularColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tintColor",{get:function(){return this.materialData.tintColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.tintColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha!=t&&(this.materialData.alpha=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlending",{get:function(){return this.materialData.alphaBlending},set:function(t){this.materialData.alphaBlending!=t&&(this.materialData.alphaBlending=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularLevel",{get:function(){return this.materialData.specularLevel},set:function(t){this.materialData.specularLevel!=t&&(this.materialData.specularLevel=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gloss",{get:function(){return this.materialData.gloss},set:function(t){this.materialData.gloss!=t&&(this.materialData.gloss=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalDir",{get:function(){return this.materialData.normalDir},set:function(t){this.materialData.normalDir!=t&&(this.materialData.normalDir=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gamma",{get:function(){return this.materialData.gamma},set:function(t){this.materialData.gamma!=t&&(this.materialData.gamma=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refraction",{get:function(){return this.materialData.refraction},set:function(t){this.materialData.refraction!=t&&(this.materialData.refraction=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"refractionintensity",{get:function(){return this.materialData.refractionintensity},set:function(t){this.materialData.refractionintensity!=t&&(this.materialData.refractionintensity=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uvRectangle",{get:function(){return this.materialData.uvRectangle},set:function(t){this.materialData.uvRectangle.x=t.x,this.materialData.uvRectangle.y=t.y,this.materialData.uvRectangle.width=t.width,this.materialData.uvRectangle.height=t.height,this.materialData.materialDataNeedChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffusePass",{get:function(){return this.passes[t.PassType.diffusePass][0]},enumerable:!0,configurable:!0}),e.prototype.creatPass=function(e){this.passes[e]=t.PassUtil.CreatPass(e,this.materialData)},e.prototype.addDiffuseChilderPass=function(e){this.passes[t.PassType.diffusePass]&&(e.materialData=this.materialData,this.passes[t.PassType.diffusePass].push(e))},Object.defineProperty(e.prototype,"castShadow",{get:function(){return this.materialData.castShadow},set:function(e){this.materialData.castShadow=e,e?this.creatPass(t.PassType.shadowPass):this.passes[t.PassType.shadowPass]&&(this.disposePass(t.PassType.shadowPass),this.passes[t.PassType.shadowPass]=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"castPick",{set:function(e){e?(t.PickSystem.instance.enablePick=!0,this.creatPass(t.PassType.PickPass)):this.passes[t.PassType.PickPass]&&(this.disposePass(t.PassType.PickPass),this.passes[t.PassType.PickPass]=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"acceptShadow",{get:function(){return this.materialData.acceptShadow},set:function(t){this.materialData.acceptShadow!=t&&(this.materialData.acceptShadow=t,this.diffusePass&&this.diffusePass.addShadowMethod())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowColor",{get:function(){var t=0;return t|=255*this.materialData.shadowColor[0]<<16,t|=255*this.materialData.shadowColor[1]<<8,t|=255*this.materialData.shadowColor[2]},set:function(t){this.materialData.shadowColor[0]=(t>>16&255)/255,this.materialData.shadowColor[1]=(t>>8&255)/255,this.materialData.shadowColor[2]=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowOffset",{get:function(){return this.materialData.shadowColor[3]},set:function(t){this.materialData.shadowColor[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"repeat",{get:function(){return this.materialData.repeat},set:function(t){this.materialData.repeat=t,this.materialData.textureStateChage=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bothside",{get:function(){return this.materialData.bothside},set:function(t){this.materialData.textureStateChage=!0,this.materialData.bothside=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cullMode",{get:function(){return this.materialData.cullFrontOrBack},set:function(t){this.materialData.textureStateChage=!0,this.materialData.cullFrontOrBack=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendMode",{set:function(e){switch(this.materialData.textureStateChage=!0,this.materialData.blendMode=e,e){case t.BlendMode.NORMAL:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA,this.materialData.alphaBlending=!1;break;case t.BlendMode.LAYER:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA,this.materialData.blend_dest=t.ContextConfig.ZERO,this.materialData.alphaBlending=!0;break;case t.BlendMode.MULTIPLY:this.materialData.blend_src=t.ContextConfig.ZERO,this.materialData.blend_dest=t.ContextConfig.SRC_COLOR,this.materialData.alphaBlending=!0;break;case t.BlendMode.ADD:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA,this.materialData.blend_dest=t.ContextConfig.ONE,this.materialData.alphaBlending=!0;break;case t.BlendMode.SOFT_ADD:this.materialData.blend_src=t.ContextConfig.SRC_COLOR,this.materialData.blend_dest=t.ContextConfig.ONE,this.materialData.alphaBlending=!0;break;case t.BlendMode.ALPHA:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA,this.materialData.alphaBlending=!0;break;case t.BlendMode.SCREEN:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_COLOR}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointSize",{get:function(){return this.materialData.specularLevel},set:function(t){t!=this.materialData.specularLevel&&(this.materialData.specularLevel=t,this.materialData.textureStateChage=!0)},enumerable:!0,configurable:!0}),e.prototype.disposePass=function(t){for(var e=0;e<this.passes[t].length;e++)this.passes[t][e].dispose()},e.prototype.renderXRayPass=function(){},e.prototype.renderOutlinePass=function(){},e.prototype.renderNormalPass=function(){},e.prototype.renderDepthPass=function(){},e.prototype.renderPositionPass=function(){},e.prototype.renderUVPass=function(){},e.prototype.renderScendUVPass=function(){},e.prototype.renderVertexColorPass=function(){},e.prototype.renderLightingPass=function(){},e.prototype.dispose=function(){for(var t in this.passes)for(var e=0;e<this.passes[t].length;++e)this.passes[t][e].dispose()},e}();t.MaterialBase=e,__reflect(e.prototype,"egret3d.MaterialBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vsShaderList=[],this.fsShaderList=[]}return t.prototype.upload=function(t,e,r,i,a,n,o,s){},t.prototype.activeState=function(t,e,r,i,a,n,o,s){},t.prototype.dispose=function(){},t}();t.MethodBase=e,__reflect(e.prototype,"egret3d.MethodBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){void 0===t&&(t=null),this._passChange=!0,this._vs_shader_methods={},this._fs_shader_methods={},this.methodList=new Array,this.methodDatas=new Array,this.vsShaderNames=new Array,this.fsShaderNames=new Array,this.enable=!0,t&&(this.materialData=t)}return Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(e){this._lightGroup&&this._lightGroup.removeEventListener(t.LightGroup.EVENT_LIGHT_RESET,this.onLightReset,this),this._lightGroup=e,this._lightGroup&&this._lightGroup.addEventListener(t.LightGroup.EVENT_LIGHT_RESET,this.onLightReset,this)},enumerable:!0,configurable:!0}),e.prototype.onLightReset=function(t){this._passChange=!0},Object.defineProperty(e.prototype,"materialData",{set:function(t){this._materialData=t},enumerable:!0,configurable:!0}),e.prototype.addMethod=function(t){var e=this.methodList.indexOf(t);-1==e&&(this.methodList.push(t),t.materialData=this._materialData,this._passChange=!0)},e.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);-1!=e&&(this.methodList.splice(e,1),this._passChange=!0)},e.prototype.getMethod=function(t){for(var e=0;e<this.methodList.length;++e)if(this.methodList[e]instanceof t)return this.methodList[e];return null},e.prototype.addShadowMethod=function(){this._materialData.acceptShadow&&(this._shadowMethod=new t.ShadowMethod(this._materialData),this.addMethod(this._shadowMethod))},e.prototype.removShadowMethod=function(){this._shadowMethod&&(this.removeMethod(this._shadowMethod),this._shadowMethod.dispose(),this._shadowMethod=null)},e.prototype.materialDataChange=function(){this._materialData.materialDataNeedChange=!0},e.prototype.passInvalid=function(){this._passChange=!0},e.prototype.resetTexture=function(t){var e;for(var r in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[r],this._materialData[e.varName]&&(e.texture=this._materialData[e.varName]);var i;for(var r in this._passUsage.sampler3DList)i=this._passUsage.sampler3DList[r],this._materialData[i.varName]&&(i.texture=this._materialData[i.varName]);this._materialData.textureChange=!1},e.prototype.addMethodShaders=function(t,e){for(var r=0;r<e.length;r++)t.addUseShaderName(e[r])},e.prototype.addShaderPhase=function(e,r,i){var a,n,o;for(n in r){a=r[n];for(var s=0;s<a.length;s++){i[n]=i[n]||[],i[n].push(a[s]),o=t.ShaderPhaseType[n];var l=this._materialData.shaderPhaseTypes[e].indexOf(t.ShaderPhaseType[o]);-1!=l&&this._materialData.shaderPhaseTypes[e].splice(l,1)}}},e.prototype.initOthreMethods=function(){for(var t,e,r=0;r<this.methodList.length;r++){var i=this.methodList[r];for(t in i.vsShaderList){e=i.vsShaderList[t];for(var a=0;a<e.length;a++)this._vs_shader_methods[t]=this._vs_shader_methods[t]||[],this._vs_shader_methods[t].push(e[a])}for(t in i.fsShaderList){e=i.fsShaderList[t];for(var a=0;a<e.length;a++)this._fs_shader_methods[t]=this._fs_shader_methods[t]||[],this._fs_shader_methods[t].push(e[a])}}},e.prototype.initUseMethod=function(e,r){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),this._materialData.acceptShadow&&(this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[],this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]||[]),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.specular_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.specular_fragment].push("specularMap_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment].push("matCap_TextureMult_fs")),this.lightGroup&&(this._passUsage.maxDirectLight=this.lightGroup.directLightList.length,this._passUsage.maxSpotLight=this.lightGroup.spotLightList.length,this._passUsage.maxPointLight=this.lightGroup.pointLightList.length,this._vs_shader_methods[t.ShaderPhaseType.local_vertex]=this._vs_shader_methods[t.ShaderPhaseType.local_vertex]||[],this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("lightingBase_fs"),this.lightGroup.directLightList.length&&(this._passUsage.directLightData=new Float32Array(t.DirectLight.stride*this.lightGroup.directLightList.length),this._vs_shader_methods[t.ShaderPhaseType.local_vertex].push("varyingViewDir_vs"),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("directLight_fragment")),this.lightGroup.spotLightList.length&&(this._passUsage.spotLightData=new Float32Array(t.SpotLight.stride*this.lightGroup.spotLightList.length),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("spotLight_fragment")),this.lightGroup.pointLightList.length&&(this._passUsage.pointLightData=new Float32Array(t.PointLight.stride*this.lightGroup.pointLightList.length),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("pointLight_fragment"))),this.initOthreMethods(),this.phaseEnd(e)},e.prototype.phaseEnd=function(e){var r;r=this._vs_shader_methods[t.ShaderPhaseType.utils_vertex],r&&r.length>0&&this.addMethodShaders(this._passUsage.vertexShader,r),r=this._vs_shader_methods[t.ShaderPhaseType.base_vertex],r&&r.length>0?this.addMethodShaders(this._passUsage.vertexShader,r):(this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]),r=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],r&&r.length>0?this.addMethodShaders(this._passUsage.vertexShader,r):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vertex"]),r=this._vs_shader_methods[t.ShaderPhaseType.local_vertex],r&&r.length>0&&this.addMethodShaders(this._passUsage.vertexShader,r),r=this._vs_shader_methods[t.ShaderPhaseType.global_vertex],r&&r.length>0&&this.addMethodShaders(this._passUsage.vertexShader,r),r=this._vs_shader_methods[t.ShaderPhaseType.end_vertex],r&&r.length>0?this.addMethodShaders(this._passUsage.vertexShader,r):this.addMethodShaders(this._passUsage.vertexShader,["end_vs"]),this.addMethodShaders(this._passUsage.vertexShader,["out_vs"])),r=this._fs_shader_methods[t.ShaderPhaseType.utils_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.base_fragment],r&&r.length>0?this.addMethodShaders(this._passUsage.fragmentShader,r):(this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),r=this._fs_shader_methods[t.ShaderPhaseType.start_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.materialsource_fragment],r&&r.length>0?this.addMethodShaders(this._passUsage.fragmentShader,r):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),r=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment],r&&r.length>0?this.addMethodShaders(this._passUsage.fragmentShader,r):this.addMethodShaders(this._passUsage.fragmentShader,["diffuse_fragment"]),r=this._fs_shader_methods[t.ShaderPhaseType.normal_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.specular_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.end_fragment],r&&r.length>0?this.addMethodShaders(this._passUsage.fragmentShader,r):this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"]),r=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),r=this._fs_shader_methods[t.ShaderPhaseType.multi_end_fragment],r&&r.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,r),this.addMethodShaders(this._passUsage.fragmentShader,["out_fs"]))
},e.prototype.upload=function(e,r,i,a,n,o,s,l){this._passChange=!1,this.initUseMethod(o,s),this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage),this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage),this._passUsage.program3D=t.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id);for(var h in this._passUsage)-1!=h.indexOf("uniform")&&this._passUsage[h]&&(this._passUsage[h].uniformIndex=i.getUniformLocation(this._passUsage.program3D,h));var u;for(var c in this._passUsage.sampler2DList)u=this._passUsage.sampler2DList[c],u.uniformIndex=i.getUniformLocation(this._passUsage.program3D,u.varName),u.texture=this._materialData[u.varName];var d;for(var c in this._passUsage.sampler3DList)d=this._passUsage.sampler3DList[c],d.uniformIndex=i.getUniformLocation(this._passUsage.program3D,d.varName);if(this.methodList)for(var p=0;p<this.methodList.length;p++)this.methodList[p].upload(e,r,this._passUsage,null,i,a,n,l)},e.prototype.draw=function(e,r,i,a,n,o,s,l){if(this.enable){if(this._materialData.materialDataNeedChange){var h=this._materialData.tintColor,u=h>>24&255,c=h>>16&255,d=h>>8&255,p=255&h;u/=128,c/=128,d/=128,p/=128,this._materialData.materialSourceData[0]=c*(this._materialData.diffuseColor>>16&255)/255,this._materialData.materialSourceData[1]=d*(this._materialData.diffuseColor>>8&255)/255,this._materialData.materialSourceData[2]=p*(255&this._materialData.diffuseColor)/255,this._materialData.materialSourceData[3]=(this._materialData.ambientColor>>16&255)/255,this._materialData.materialSourceData[4]=(this._materialData.ambientColor>>8&255)/255,this._materialData.materialSourceData[5]=(255&this._materialData.ambientColor)/255,this._materialData.materialSourceData[6]=(this._materialData.specularColor>>16&255)/255,this._materialData.materialSourceData[7]=(this._materialData.specularColor>>8&255)/255,this._materialData.materialSourceData[8]=(255&this._materialData.specularColor)/255,this._materialData.materialSourceData[9]=u*this._materialData.alpha,this._materialData.materialSourceData[10]=this._materialData.cutAlpha,this._materialData.materialSourceData[11]=this._materialData.gloss,this._materialData.materialSourceData[12]=this._materialData.specularLevel,this._materialData.materialSourceData[13]=this._materialData.uvRectangle.x,this._materialData.materialSourceData[14]=-this._materialData.uvRectangle.y,this._materialData.materialSourceData[15]=this._materialData.uvRectangle.width,this._materialData.materialSourceData[16]=this._materialData.uvRectangle.height,this._materialData.materialSourceData[17]=this._materialData.gamma,this._materialData.materialSourceData[18]=this._materialData.refraction,this._materialData.materialSourceData[19]=this._materialData.refractionintensity}this._passChange&&this.upload(e,r,i,a,n,s.animation,o.geometry,l),i.setProgram(this._passUsage.program3D),o.activeState(e,r,this._passUsage,i),this._materialData.depthTest?(i.enableDepth(),i.depthFunc(t.ContextConfig.LEQUAL)):(i.disableDepth(),i.depthFunc(t.ContextConfig.LEQUAL)),this._materialData.acceptShadow&&l.renderDictionary[t.PassType.shadowPass]&&this._shadowMethod&&(this._shadowMethod.shadowMapTexture=l.renderDictionary[t.PassType.shadowPass].renderTexture),i.setCulling(this._materialData.cullFrontOrBack),this._materialData.bothside?i.disableCullFace():i.enableCullFace(),this._passID==t.PassType.shadowPass?(i.disableBlend(),i.setBlendFactors(t.ContextConfig.ONE,t.ContextConfig.ZERO)):(this._materialData.depthWrite||t.Context3DProxy.gl.depthMask(!1),i.enableBlend(),i.setBlendFactors(this._materialData.blend_src,this._materialData.blend_dest)),this._passUsage.uniform_materialSource&&i.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData),this._materialData.textureChange&&this.resetTexture(i);var f,m;for(var _ in this._passUsage.sampler2DList)f=this._passUsage.sampler2DList[_],f.texture=this._materialData[f.varName],f.texture&&(m=f.texture.parentTexture?f.texture.parentTexture:f.texture,m.upload(i),i.setTexture2DAt(f.activeTextureIndex,f.uniformIndex,f.index,m.texture2D),m.useMipmap&&(m.useMipmap=this._materialData.useMipmap),m.repeat=this._materialData.repeat,m.activeState(i),this._materialData.textureStateChage=!1);var v;for(var _ in this._passUsage.sampler3DList)v=this._passUsage.sampler3DList[_],v.texture=this._materialData[v.varName],v.texture&&(v.texture.upload(i),i.setCubeTextureAt(v.activeTextureIndex,v.uniformIndex,v.index,v.texture.texture3D));var g=0;if(this.lightGroup){for(g=0;g<this._passUsage.maxDirectLight;g++)this.lightGroup.directLightList[g].updateLightData(n,g,this._passUsage.directLightData);for(g=0;g<this._passUsage.maxSpotLight;g++)this.lightGroup.spotLightList[g].updateLightData(n,g,this._passUsage.spotLightData);for(g=0;g<this._passUsage.maxPointLight;g++)this.lightGroup.pointLightList[g].updateLightData(n,g,this._passUsage.pointLightData);this._passUsage.uniform_directLightSource&&i.uniform1fv(this._passUsage.uniform_directLightSource.uniformIndex,this._passUsage.directLightData),this._passUsage.uniform_sportLightSource&&i.uniform1fv(this._passUsage.uniform_sportLightSource.uniformIndex,this._passUsage.spotLightData),this._passUsage.uniform_pointLightSource&&i.uniform1fv(this._passUsage.uniform_pointLightSource.uniformIndex,this._passUsage.pointLightData)}if(this._passUsage.uniform_ModelMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),this._passUsage.uniform_ViewMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,!1,n.viewMatrix.rawData),this._passUsage.uniform_ProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,n.projectMatrix.rawData),this._passUsage.uniform_ViewProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,n.viewProjectionMatrix.rawData),this._passUsage.uniform_orthProjectMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_orthProjectMatrix.uniformIndex,!1,n.orthProjectionMatrix.rawData),s.animation&&s.animation.activeState(e,r,this._passUsage,o,i,a,n),this.methodList)for(var g=0;g<this.methodList.length;g++)this.methodList[g].activeState(e,r,this._passUsage,null,i,a,n,l);if(this._passUsage.uniform_eyepos&&i.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,n.x,n.y,n.z),this._passUsage.uniform_cameraMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,!1,n.modelMatrix.rawData),this._passUsage.uniform_billboardMatrix){var y;switch(s.billboard){case t.BillboardType.STANDARD:y=n.billboardXYZ;break;case t.BillboardType.X_AXIS:y=n.billboardX;break;case t.BillboardType.Y_AXIS:y=n.billboardY;break;case t.BillboardType.Z_AXIS:y=n.billboardZ;break;case t.BillboardType.DISABLE:y=t.Matrix4_4.helpMatrix,y.identity()}i.uniformMatrix4fv(this._passUsage.uniform_billboardMatrix.uniformIndex,!1,y.rawData)}if(this._passUsage.uniform_ObjectId){var x=t.Color.getColor(s.id,t.ContextConfig.ColorFormat_RGBA8888,t.Vector3D.HELP_0);i.uniform3fv(this._passUsage.uniform_ObjectId.uniformIndex,[x.x,x.y,x.z])}i.drawElement(this._materialData.drawMode,o.start*Uint16Array.BYTES_PER_ELEMENT,o.count),this._materialData.depthWrite||t.Context3DProxy.gl.depthMask(!0)}},e.prototype.deactiveState=function(t,e){var r;for(var i in t.sampler2DList)r=this._passUsage.sampler2DList[i],r.texture&&e.disableTexture2DAt(r.activeTextureIndex,r.uniformIndex,r.index)},e.prototype.dispose=function(){this._passUsage&&this._passUsage.dispose(),this._passUsage=null},e}();t.MaterialPass=e,__reflect(e.prototype,"egret3d.MaterialPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._entities={},this.enable=!1,this.prefix=""}return Object.defineProperty(t.prototype,"entities",{get:function(){return this._entities},enumerable:!0,configurable:!0}),t.prototype.getFps=function(){var t=this.getEntity("fps");return t&&t.averageDelta?Math.floor(1e3/t.averageDelta):0},t.prototype.updateFps=function(){this.enable&&(this.endCounter("fps"),this.startCounter("fps",60))},t.prototype.getNow=function(){return window.performance?window.performance.now():(new Date).getTime()},t.prototype.getEntity=function(t){return t=this.prefix+t,this._entities[t]},t.prototype.startCounter=function(t,e){if(this.enable){t=this.prefix+t;var r=this._entities[t];r||(r={start:0,end:0,delta:0,_cache:[],averageRange:1,averageDelta:0},this._entities[t]=r),r.start=this.getNow(),r.averageRange=e||1}},t.prototype.endCounter=function(t){if(this.enable){t=this.prefix+t;var e=this._entities[t];if(e&&(e.end=this.getNow(),e.delta=e.end-e.start,e.averageRange>1)){e._cache.push(e.delta);var r=e._cache.length;if(r>=e.averageRange){r>e.averageRange&&(e._cache.shift(),r--);for(var i=0,a=0;r>a;a++)i+=e._cache[a];e.averageDelta=i/r}}}},t}();t.Egret3DPerformance=e,__reflect(e.prototype,"egret3d.Egret3DPerformance")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.name="default",this.enabled=!0,this.viewPort=new t.Rectangle}return Object.defineProperty(e.prototype,"pass",{get:function(){return this._pass},set:function(t){this._pass=t},enumerable:!0,configurable:!0}),e.prototype.setRenderToTexture=function(e,r,i){void 0===i&&(i=t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.renderTexture&&this.renderTexture.dispose(),this.renderTexture=new t.RenderTexture(e,r,i)},e.prototype.draw=function(t,e,r,i,a,n,o){void 0===o&&(o=null)},e}();t.RenderBase=e,__reflect(e.prototype,"egret3d.RenderBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.varName="",this.name="",this.key="",this.valueType="",this.value="",this.activeTextureIndex=-1,this.index=-1,this.level="",this.size=0,this.dataType=0,this.normalized=!1,this.stride=0,this.offset=0,this.offsetIndex=0,this.offsetBytes=0}return t.prototype["var"]=function(t){return this.level+" "+this.valueType+" "+name+"."+t},t.prototype.use=function(t){return void 0===t&&(t=""),""!=t?this.name+"."+t:this.name},t.prototype.clone=function(){var e=new t;return e.name=this.name,e.valueType=this.valueType,e.level=this.level,e.varName=this.varName,e.value=this.value,e.key=this.key,e},t.prototype.computeVarName=function(){var t=this.name.indexOf("[");t>=0?this.varName=this.name.substr(0,t):this.varName=this.name},t}();t.VarRegister=e,__reflect(e.prototype,"egret3d.GLSL.VarRegister")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.width=32,r.height=32,r.uvRectangle=new t.Rectangle(0,0,1,1),r.buildCheckerboard(),r.texture2D=new t.ContextTexture2D,r}return __extends(r,e),r.prototype.upload=function(e){this.texture2D.textureBuffer||(this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture(),this.texture2D.border=0,this.texture2D.internalFormat=t.InternalFormat.PixelArray,this.texture2D.colorFormat=t.Context3DProxy.gl.RGBA,this.texture2D.mimapData=new Array,this.texture2D.mimapData.push(new t.MipmapData(this._pixelArray,this.width,this.height)),this.texture2D.width=this.width,this.texture2D.height=this.height,this.useMipmap=!1,this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE,e.upLoadTextureData(0,this))},r.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Uint8Array(this.width*this.height*4);for(var e=[t.Color.white(),t.Color.black()],r=0,i=4,a=0;a<this.height;a++)for(var n=0;n<this.width;n++){if(n%i==0&&(r=(r+1)%2),a%i==0&&0==n){var o=e[0];e[0]=e[1],e[1]=o,r=0}this._pixelArray[a*(4*this.width)+4*n+0]=e[r].r,this._pixelArray[a*(4*this.width)+4*n+1]=e[r].g,this._pixelArray[a*(4*this.width)+4*n+2]=e[r].b,this._pixelArray[a*(4*this.width)+4*n+3]=e[r].a}}},r.prototype.uploadForcing=function(t){},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._pixelArray&&delete this._pixelArray,this._pixelArray=null},r}(t.ITexture);e.texture=new e,t.CheckerboardTexture=e,__reflect(e.prototype,"egret3d.CheckerboardTexture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.findNameIndex=function(t,e){if(""==e)return-1;for(var r=0;r<t.length;++r)if(e==t[r])return r;return-1},e.parserVersion_1=function(r){var i=r.readUnsignedByte();r.readUnsignedByte();if(0>=i)return null;for(var a=new t.SkeletonAnimationClip,n=a.boneNameArray,o=new Array,s=0;i>s;s++)n.push(r.readUTF()),o.push(r.readUTF());for(var l=(r.readInt(),r.readInt()),h=new t.Quaternion,u=new t.Vector3D,c=new t.Vector3D,s=0;l>s;s++){var d=new t.SkeletonPose;d.frame=r.readInt()/60/80*1e3;for(var p=0;i>p;p++){var f=new t.Joint;f.index=p,f.parentIndex=e.findNameIndex(n,o[p]),h.fromEulerAngles(r.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,r.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,r.readFloat()*t.MathUtil.RADIANS_TO_DEGREES),u.x=r.readFloat(),u.y=r.readFloat(),u.z=r.readFloat(),c.x=r.readFloat(),c.y=r.readFloat(),c.z=r.readFloat(),f.buildLocalMatrix(u,h,c),d.joints.push(f)}d.calculateJointWorldMatrix(),a.addSkeletonPose(d)}return a},e.parserVersion_2=function(r){var i=r.readUnsignedByte();r.readUnsignedByte();if(0>=i)return null;for(var a=new t.SkeletonAnimationClip,n=a.boneNameArray,o=new Array,s=0;i>s;s++)n.push(r.readUTF()),o.push(r.readUTF());for(var l=(r.readInt(),r.readInt()),h=new t.Quaternion,u=new t.Vector3D,c=new t.Vector3D,d=0,s=0;l>s;s++){var p=new t.SkeletonPose;p.boneNameArray=n,p.frame=r.readInt(),d=Math.max(p.frameTime,d);for(var f=0;i>f;f++){var m=new t.Joint;m.index=f,m.parentIndex=e.findNameIndex(n,o[f]),h.x=r.readFloat(),h.y=r.readFloat(),h.z=r.readFloat(),h.w=r.readFloat(),u.x=r.readFloat(),u.y=r.readFloat(),u.z=r.readFloat(),c.x=r.readFloat(),c.y=r.readFloat(),c.z=r.readFloat(),m.buildLocalMatrix(u,h,c),p.joints.push(m)}a.addSkeletonPose(p)}return a.totalTime=l*a.frameRate,a.totalFrame=l,a},e.parserVersion_3=function(r){for(var i=r.readUnsignedByte(),a=(r.readUnsignedByte(),r.readInt(),r.readInt()),n=r.readInt(),o=new t.SkeletonAnimationClip,s=o.boneNameArray,l=new Array,h=0;i>h;h++)s.push(r.readUTF()),l.push(r.readUTF());for(var u=new t.Quaternion,c=new t.Vector3D,d=new t.Vector3D,p=0,h=0;n>h;h++){var f=new t.SkeletonPose;f.boneNameArray=s,f.frame=r.readInt(),p=Math.max(f.frameTime,p);for(var m=0;i>m;m++){var _=new t.Joint;_.index=m,_.parentIndex=e.findNameIndex(s,l[m]),u.x=r.readFloat(),u.y=r.readFloat(),u.z=r.readFloat(),u.w=r.readFloat(),c.x=r.readFloat(),c.y=r.readFloat(),c.z=r.readFloat(),d.x=r.readFloat(),d.y=r.readFloat(),d.z=r.readFloat(),_.buildLocalMatrix(c,u,d),f.joints.push(_)}o.addSkeletonPose(f)}return o.totalTime=a*o.frameRate,o.totalFrame=a,o},e}();e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)},3:function(t){return e.parserVersion_3(t)}},t.EAMVersion=e,__reflect(e.prototype,"egret3d.EAMVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n){void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=!1),void 0===n&&(n=!1);var o=e.call(this,r)||this;return o._origin=new t.Vector3D(0,0,0),o._lookAtPosition=new t.Vector3D,o._eyesPos=new t.Vector3D,o._up=t.Vector3D.Y_AXIS,o._eyesLength=100,o._rotaEyesLine=new t.Vector3D(0,0,1),o._rotaAngle=new t.Vector3D,o._matRot=new t.Matrix4_4,o._quaRot=new t.Quaternion,o._tempVec=new t.Vector3D,o._matTemp=new t.Matrix4_4,o._mouseDown=!1,o._mouseRightDown=!1,o._screenMoveStartDetail=new t.Point,o._screenMoveDelay=new t.Point,o._isUpdate=!1,o._elapsed=0,o._xAngle=0,o._ctl=!1,o._alt=!1,o._shift=!1,o._needctl=!1,o._needalt=!1,o._needshift=!1,o._keyArray=new Array,o.lookAtOffset=new t.Vector3D(0,0,0),o.firstCamera=!1,o._needctl=a,o._needalt=n,i?o.lookAtObject=i:o.lookAtPosition=new t.Vector3D,o._eyesPos.copyFrom(r.position),o._lookAtPosition.copyFrom(i.position.add(o.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D)),o._target.lookAt(o._eyesPos,o._lookAtPosition),t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,o.mouseMove,o),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,o.mouseWheel,o),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,o.mouseUp,o),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,o.mouseDown,o),t.Input.addEventListener(t.KeyEvent3D.KEY_UP,o.keyUp,o),t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,o.keyDown,o),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,o.touchUp,o),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,o.touchDown,o),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,o.touchMove,o),o}return __extends(r,e),r.prototype.mouseMove=function(e){this._mouseDown&&(this._needctl?this._ctl:!0)&&(this._rotaAngle.y+=t.Input.mouseOffsetX,this._rotaAngle.x+=t.Input.mouseOffsetY,this._rotaAngle.y%=360,this._rotaAngle.x%=360)},r.prototype.mouseWheel=function(e){if(this._target){var r=this._target;if(r){var i=.1*t.Input.wheelDelta,a=r.viewPort;switch(r.cameraType){case t.CameraType.orthogonal:var n=a.width-i,o=a.height-i;r.updateViewport(0,0,n,o);break;case t.CameraType.orthogonalToCenter:var s=a.x-i,l=a.y-i,n=a.width-i,o=a.height-i;r.updateViewport(s,l,n,o);break;case t.CameraType.perspective:this.distance=this._eyesLength-i}}}},r.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!1;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!1}},r.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!0;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!0}},r.prototype.touchMove=function(t){1==t.targetTouches.length?this.mouseMove(null):this.mouseWheel(null)},r.prototype.touchUp=function(t){this._mouseDown=!1},r.prototype.touchDown=function(t){this._mouseDown=!0},r.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0;break;case t.KeyCode.Key_Q:this._keyArray[4]=!0;break;case t.KeyCode.Key_E:this._keyArray[5]=!0;break;case t.KeyCode.Key_Control_L:this._ctl=!0;break;case t.KeyCode.Key_Alt_L:this._alt=!0}},r.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1;break;case t.KeyCode.Key_Q:this._keyArray[4]=!1;break;case t.KeyCode.Key_E:this._keyArray[5]=!1;break;case t.KeyCode.Key_Control_L:this._ctl=!1;break;case t.KeyCode.Key_Alt_L:this._alt=!1}},Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(e){this._lookAtObject&&(this._lookAtObject=null),this._lookAtPosition.copyFrom(e.add(this.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._eyesLength},set:function(t){this._eyesLength=t,this._eyesLength<1&&(this._eyesLength=1)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationX",{get:function(){return this._rotaAngle.x},set:function(t){this._rotaAngle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationY",{get:function(){return this._rotaAngle.y},set:function(t){this._rotaAngle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationZ",{get:function(){return this._rotaAngle.z},set:function(t){this._rotaAngle.z=t},enumerable:!0,configurable:!0}),r.prototype.update=function(e,r){if(void 0===e&&(e=16.6),void 0===r&&(r=0),this._target){if(0==this._target.isController)return;var i=this._speed*(e/1e3);this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._rotaEyesLine.copyFrom(this._quaRot.transformVector(t.Vector3D.Z_AXIS,t.MathUtil.CALCULATION_VECTOR3D)),this._rotaEyesLine.normalize(),this._keyArray[0]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._keyArray[1]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.createByRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._keyArray[2]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._keyArray[3]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.createByRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._keyArray[4]&&(this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS,t.MathUtil.CALCULATION_VECTOR3D)),this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._keyArray[5]&&(this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS,t.MathUtil.CALCULATION_VECTOR3D)),this._tempVec.normalize(),this._tempVec.scaleBy(i),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject.position=this._tempVec),this._lookAtPosition.copyFrom(this._lookAtObject.position),this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.scaleBy(this._eyesLength),this._eyesPos.copyFrom(this._lookAtPosition.subtract(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._lookAtObject&&this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset,t.MathUtil.CALCULATION_VECTOR3D)),this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z),this._tempVec.copyFrom(this._up),this._tempVec.copyFrom(this._quaRot.transformVector(this._tempVec,t.MathUtil.CALCULATION_VECTOR3D)),this._tempVec.normalize(),this.firstCamera&&(this._lookAtObject.rotationY=this._rotaAngle.y,this._lookAtObject.rotationX=this._rotaAngle.x),this._target.lookAt(this._eyesPos,this._lookAtPosition,this._tempVec)}},r}(t.ControllerBase);t.LookAtController=e,__reflect(e.prototype,"egret3d.LookAtController")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){var a=e.call(this,null,null)||this;return a._step=5,a._panAngle=0,a._down=!1,a._startVec3D=new t.Vector3D,a._endVec3D=new t.Vector3D,a._currentVec3D=new t.Vector3D,a._fixinterpolate=new t.Vector3D,a._fix=new t.Vector3D,a._final=new t.Vector3D,a._rotaAngle=new t.Vector3D,a._looat=new t.Vector3D,a._dir=new t.Vector3D,a._up=new t.Vector3D,a._pos=new t.Vector3D,a._maxFov=90,a._minFov=30,a._calQua=new t.Quaternion,a._useCompass=!1,a._gyroCtrlloer=new t.OrientationController,a._gyroCtrlloer.start(),a._target=i,a._view=r,a._currentVec3D.z=a._final.z=r.camera3D.fieldOfView,t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,a.mouseMove,a),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,a.mouseWheel,a),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,a.mouseUp,a),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,a.mouseDown,a),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,a.touchUp,a),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,a.touchDown,a),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,a.touchMove,a),a.useCompass(!0),a}return __extends(r,e),r.prototype.mouseDown=function(t){this._down=!0},r.prototype.mouseUp=function(t){this._down=!1},r.prototype.mouseMove=function(e){this._down&&(this._final.x-=t.Input.mouseOffsetX/(this._step*this._step),this._final.y-=t.Input.mouseOffsetY/(this._step*this._step)),this.useCompass(!1)},r.prototype.touchDown=function(t){this._down=!0},r.prototype.touchUp=function(t){this._down=!1},r.prototype.touchMove=function(e){1==e.targetTouches.length?this._down&&(this._final.x-=t.Input.mouseOffsetX/(this._step*this._step),this._final.y-=t.Input.mouseOffsetY/(this._step*this._step)):this.mouseWheel(null),this.useCompass(!1)},r.prototype.mouseWheel=function(e){this._final.z-=t.Input.wheelDelta/(this._step*this._step)},r.prototype.useCompass=function(t){t&&t!=this._useCompass?(this._useCompass=!0,this._target.rotationX=270):t||t==this._useCompass||(this._useCompass=!1,this._target.rotationX=0)},r.prototype.update=function(e){if(void 0===e&&(e=!0),this._useCompass)this._gyroCtrlloer.update(this._view);else{this._fix.x=this._final.x-this._currentVec3D.y,this._fix.y=this._final.y-this._currentVec3D.x,this._fix.z=this._final.z-this._currentVec3D.z,this._currentVec3D.y+=this._fix.x/this._step,this._currentVec3D.x+=this._fix.y/this._step,this._rotaAngle.x=this._currentVec3D.x,this._rotaAngle.y=this._currentVec3D.y,this._calQua.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._calQua.transformVector(t.Vector3D.Z_AXIS,this._dir),this._calQua.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z),this._calQua.transformVector(t.Vector3D.Y_AXIS,this._up),this._view.camera3D.lookAt(this._pos,this._dir,this._up);var r=this._currentVec3D.z+this._fix.z/this._step;this._maxFov>r&&r>this._minFov?this._currentVec3D.z=r:this._final.z=this._currentVec3D.z,this._view.camera3D.fieldOfView=this._currentVec3D.z}},r}(t.ControllerBase);t.PanController=e,__reflect(e.prototype,"egret3d.PanController")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.version="3.2.2",this.isLost=!1,this.DEPTH_TEST=!1,this.CULL_FACE=!1,this.BLEND=!1,this.blend_Factors_src=-1,this.blend_Factors_dst=-1,this.cullingMode=-1,this.depthCompareMode=-1,this.cacheVertexPoint=[],this.cacheVertexFormat=0}return e.prototype.reset=function(){this.DEPTH_TEST=!1,this.CULL_FACE=!1,this.BLEND=!1,this.blend_Factors_src=-1,this.blend_Factors_dst=-1,this.cullingMode=-1,this.depthCompareMode=-1,this.program=void 0,this.programChange=void 0},e.prototype.register=function(){var r;e.gl.getExtension("WEBGL_depth_texture")||e.gl.getExtension("MOZ_WEBGL_depth_texture")||e.gl.getExtension("WEBKIT_WEBGL_depth_texture"),e.gl.getExtension("EXT_texture_filter_anisotropic")||e.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),e.gl.getExtension("WEBGL_compressed_texture_pvrtc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),e.gl.getExtension("WEBGL_compressed_texture_etc1"),e.gl.getExtension("OES_element_index_uint"),e.gl.getExtension("OES_texture_float_linear"),r=e.gl.getExtension("OES_texture_float"),r=e.gl.getExtension("OES_texture_half_float"),e.gl.getExtension("OES_texture_half_float_linear"),e.gl.getExtension("OES_standard_derivatives"),e.gl.getExtension("GL_OES_standard_derivatives"),e.gl.getExtension("WEBGL_draw_buffers"),e.gl.getExtension("WEBGL_depth_texture"),e.gl.getExtension("WEBGL_lose_context"),r=e.gl.getExtension("WEBGL_compressed_texture_s3tc")||e.gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),r&&(t.ContextConfig.ColorFormat_DXT1_RGB=r.COMPRESSED_RGB_S3TC_DXT1_EXT,t.ContextConfig.ColorFormat_DXT1_RGBA=r.COMPRESSED_RGBA_S3TC_DXT1_EXT,t.ContextConfig.ColorFormat_DXT3_RGBA=r.COMPRESSED_RGBA_S3TC_DXT3_EXT,t.ContextConfig.ColorFormat_DXT5_RGBA=r.COMPRESSED_RGBA_S3TC_DXT5_EXT),t.ContextConfig.BLEND=e.gl.BLEND,t.DrawMode.TRIANGLES=e.gl.TRIANGLES,t.DrawMode.POINTS=e.gl.POINTS,t.DrawMode.LINES=e.gl.LINES,t.DrawMode.LINE_STRIP=e.gl.LINE_STRIP,t.ContextConfig.FLOAT=e.gl.FLOAT,t.ContextConfig.UNSIGNED_BYTE=e.gl.UNSIGNED_BYTE,t.ContextConfig.VERTEX_SHADER=e.gl.VERTEX_SHADER,t.ContextConfig.FRAGMENT_SHADER=e.gl.FRAGMENT_SHADER,t.ContextConfig.FRONT=e.gl.FRONT,t.ContextConfig.BACK=e.gl.BACK,t.ContextConfig.FRONT_AND_BACK=e.gl.FRONT_AND_BACK,t.ContextConfig.DEPTH_BUFFER_BIT=e.gl.DEPTH_BUFFER_BIT,t.ContextConfig.ELEMENT_ARRAY_BUFFER=e.gl.ELEMENT_ARRAY_BUFFER,t.ContextConfig.UNSIGNED_SHORT=e.gl.UNSIGNED_SHORT,t.ContextConfig.NEAREST=e.gl.NEAREST,t.ContextConfig.REPEAT=e.gl.REPEAT,t.ContextConfig.ONE=e.gl.ONE,t.ContextConfig.ZERO=e.gl.ZERO,t.ContextConfig.SRC_ALPHA=e.gl.SRC_ALPHA,t.ContextConfig.ONE_MINUS_SRC_ALPHA=e.gl.ONE_MINUS_SRC_ALPHA,t.ContextConfig.SRC_COLOR=e.gl.SRC_COLOR,t.ContextConfig.ONE_MINUS_SRC_COLOR=e.gl.ONE_MINUS_SRC_COLOR,t.ContextConfig.ColorFormat_RGB565=e.gl.RGB565,t.ContextConfig.ColorFormat_RGBA5551=e.gl.RGB5_A1,t.ContextConfig.ColorFormat_RGBA4444=e.gl.RGBA4,t.ContextConfig.ColorFormat_RGBA8888=e.gl.RGBA,t.ContextConfig.ColorFormat_RGB888=e.gl.RGB,t.ContextConfig.DEPTH_TEST=e.gl.DEPTH_TEST,t.ContextConfig.CULL_FACE=e.gl.CULL_FACE,t.ContextConfig.BLEND=e.gl.BLEND,t.ContextConfig.LEQUAL=e.gl.LEQUAL,t.ContextSamplerType.TEXTURE_0=e.gl.TEXTURE0,t.ContextSamplerType.TEXTURE_1=e.gl.TEXTURE1,t.ContextSamplerType.TEXTURE_2=e.gl.TEXTURE2,t.ContextSamplerType.TEXTURE_3=e.gl.TEXTURE3,t.ContextSamplerType.TEXTURE_4=e.gl.TEXTURE4,t.ContextSamplerType.TEXTURE_5=e.gl.TEXTURE5,t.ContextSamplerType.TEXTURE_6=e.gl.TEXTURE6,t.ContextSamplerType.TEXTURE_7=e.gl.TEXTURE7,t.ContextSamplerType.TEXTURE_8=e.gl.TEXTURE8,t.ShaderType.VertexShader=e.gl.VERTEX_SHADER,t.ShaderType.FragmentShader=e.gl.FRAGMENT_SHADER,console.log("requst GPU Config",e.gl),t.ShaderPool.register(this)},e.prototype.viewPort=function(r,i,a,n){e.gl.viewport(r,t.ContextConfig.canvasRectangle.height-n-i,a,n)},e.prototype.creatProgram=function(r,i){var a=e.gl.createProgram();e.gl.attachShader(a,r.shader),e.gl.attachShader(a,i.shader),e.gl.linkProgram(a);var n=e.gl.getProgramParameter(a,e.gl.LINK_STATUS);n||(console.log("vsShader error"+e.gl.getShaderInfoLog(r.shader)),console.log("fsShader error"+e.gl.getShaderInfoLog(i.shader)),console.log("program error"+e.gl.getProgramInfoLog(a)));var o=new t.Program3D(a);return o},e.prototype.creatIndexBuffer=function(r){var i=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,i),e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,r,e.gl.STATIC_DRAW);var a=new t.IndexBuffer3D(i);return a.arrayBuffer=r,a},e.prototype.uploadIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,t.buffer),e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)},e.prototype.creatVertexBuffer=function(r,i){void 0===i&&(i=e.gl.STATIC_DRAW);var a=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,a),e.gl.bufferData(e.gl.ARRAY_BUFFER,r,i);var n=new t.VertexBuffer3D(a);return n.arrayBuffer=r,n},e.prototype.uploadVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer),e.gl.bufferData(e.gl.ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)},e.prototype.texParameteri=function(t,r,i){e.gl.texParameteri(t,r,i)},e.prototype.upLoadTextureData=function(r,i){e.gl.bindTexture(e.gl.TEXTURE_2D,i.texture2D.textureBuffer),i.texture2D.internalFormat==t.InternalFormat.ImageData?e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,i.texture2D.dataFormat,i.texture2D.imageData):i.texture2D.internalFormat==t.InternalFormat.CompressData?this.upLoadCompressedTexture2D(r,i.texture2D):i.texture2D.internalFormat==t.InternalFormat.PixelArray&&e.gl.texImage2D(e.gl.TEXTURE_2D,r,i.texture2D.colorFormat,i.texture2D.mimapData[r].width,i.texture2D.mimapData[r].height,i.texture2D.border,i.texture2D.colorFormat,i.texture2D.dataFormat,i.texture2D.mimapData[r].data),i.useMipmap&&e.gl.generateMipmap(e.gl.TEXTURE_2D)
},e.prototype.upLoadCompressedTexture2D=function(t,r){e.gl.compressedTexImage2D(e.gl.TEXTURE_2D,t,r.colorFormat,r.mimapData[t].width,r.mimapData[t].height,r.border,r.mimapData[t].data)},e.prototype.creatTexture=function(){return e.gl.createTexture()},e.prototype.uploadCubetexture=function(t){e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,t.texture),t.image_right.mimapData&&t.image_right.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_left.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,t.image_up.mimapData[0].width,t.image_up.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,t.image_down.mimapData[0].width,t.image_down.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,t.image_back.mimapData[0].width,t.image_back.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,t.image_front.mimapData[0].width,t.image_front.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.imageData),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MAG_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MIN_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE)},e.prototype.createFramebuffer=function(r,i,a,n){var o=e.gl,s=o.createRenderbuffer(),l=o.createTexture();o.bindTexture(o.TEXTURE_2D,l),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,r,i,0,o.RGBA,o.UNSIGNED_BYTE,null);var h=o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,h),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,l,0),o.bindRenderbuffer(o.RENDERBUFFER,s),o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,r,i),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,s);var u=new t.ContextTexture2D;return u.width=r,u.height=i,u.textureBuffer=l,u.frameBuffer=h,u.renderbuffer=s,o.bindFramebuffer(o.FRAMEBUFFER,null),o.bindTexture(o.TEXTURE_2D,null),o.bindRenderbuffer(o.RENDERBUFFER,null),u},e.prototype.setRenderToTexture=function(t,r,i,a){void 0===r&&(r=!1),void 0===i&&(i=!1),void 0===a&&(a=0);var n=e.gl;e.gl.viewport(0,0,t.width,t.height),e.gl.scissor(0,0,t.width,t.height),n.bindFramebuffer(e.gl.FRAMEBUFFER,t.frameBuffer),n.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,t.textureBuffer,0),r&&(n.clearColor(0,0,0,0),n.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT))},e.prototype.setRenderToBackBuffer=function(){e.gl.bindTexture(e.gl.TEXTURE_2D,null),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)},e.prototype.creatVertexShader=function(r){var i=e.gl.createShader(e.gl.VERTEX_SHADER);e.gl.shaderSource(i,r),e.gl.compileShader(i);var a=new t.Shader(i);return a.id=(t.Shader.ID_COUNT++).toString(),a},e.prototype.creatFragmentShader=function(r){var i=e.gl.createShader(e.gl.FRAGMENT_SHADER);e.gl.shaderSource(i,r),e.gl.compileShader(i);var a=new t.Shader(i);return a.id=(t.Shader.ID_COUNT++).toString(),a},e.prototype.clear=function(t){e.gl.clear(t)},e.prototype.clearColor=function(t,r,i,a){e.gl.clearColor(t,r,i,a)},e.prototype.clearStencil=function(t){e.gl.clearStencil(t)},e.prototype.setProgram=function(t){this.programChange=!1,this.program!=t&&(this.programChange=!0,this.program=t,e.gl.useProgram(t.program))},e.prototype.getUniformLocation=function(t,r){return e.gl.getUniformLocation(t.program,r)},e.prototype.uniform1f=function(t,r){e.gl.uniform1f(t,r)},e.prototype.uniform1fv=function(t,r){e.gl.uniform1fv(t,r)},e.prototype.uniform1i=function(t,r){e.gl.uniform1i(t,r)},e.prototype.uniform1iv=function(t,r){e.gl.uniform1iv(t,r)},e.prototype.uniform2f=function(t,r,i){e.gl.uniform2f(t,r,i)},e.prototype.uniform2fv=function(t,r){e.gl.uniform2fv(t,r)},e.prototype.uniform2i=function(t,r,i){e.gl.uniform2i(t,r,i)},e.prototype.uniform2iv=function(t,r){e.gl.uniform2iv(t,r)},e.prototype.uniform3f=function(t,r,i,a){e.gl.uniform3f(t,r,i,a)},e.prototype.uniform3fv=function(t,r){e.gl.uniform3fv(t,r)},e.prototype.uniform3i=function(t,r,i,a){e.gl.uniform3i(t,r,i,a)},e.prototype.uniform3iv=function(t,r){e.gl.uniform3iv(t,r)},e.prototype.uniform4f=function(t,r,i,a,n){e.gl.uniform4f(t,r,i,a,n)},e.prototype.uniform4fv=function(t,r){e.gl.uniform4fv(t,r)},e.prototype.uniform4i=function(t,r,i,a,n){e.gl.uniform4i(t,r,i,a,n)},e.prototype.uniform4iv=function(t,r){e.gl.uniform4iv(t,r)},e.prototype.uniformMatrix2fv=function(t,r,i){e.gl.uniformMatrix2fv(t,r,i)},e.prototype.uniformMatrix3fv=function(t,r,i){e.gl.uniformMatrix3fv(t,r,i)},e.prototype.uniformMatrix4fv=function(t,r,i){e.gl.uniformMatrix4fv(t,r,i)},e.prototype.setBlendFactors=function(t,r){(this.blend_Factors_src!=t||this.blend_Factors_dst!=r)&&(this.blend_Factors_src=t,this.blend_Factors_dst=r,e.gl.blendFunc(t,r))},e.prototype.setCulling=function(t){this.cullingMode!=t&&(this.cullingMode=t,e.gl.cullFace(t))},e.prototype.enableDepth=function(){this.DEPTH_TEST||(this.DEPTH_TEST=!0,e.gl.enable(t.ContextConfig.DEPTH_TEST))},e.prototype.disableDepth=function(){this.DEPTH_TEST&&(this.DEPTH_TEST=!1,e.gl.disable(t.ContextConfig.DEPTH_TEST))},e.prototype.enableCullFace=function(){this.CULL_FACE||(this.CULL_FACE=!0,e.gl.enable(t.ContextConfig.CULL_FACE))},e.prototype.disableCullFace=function(){this.CULL_FACE&&(this.CULL_FACE=!1,e.gl.disable(t.ContextConfig.CULL_FACE))},e.prototype.enableBlend=function(){this.BLEND||(this.BLEND=!0,e.gl.enable(t.ContextConfig.BLEND))},e.prototype.disableBlend=function(){this.BLEND&&(this.BLEND=!1,e.gl.disable(t.ContextConfig.BLEND))},e.prototype.depthFunc=function(t){void 0===t&&(t=0),this.depthCompareMode!=t&&(this.depthCompareMode=t,e.gl.depthFunc(t))},e.prototype.enableDepthTest=function(t,r){void 0===r&&(r=0),t&&e.gl.enable(e.gl.DEPTH_TEST)},e.prototype.getShaderAttribLocation=function(t,r){return e.gl.getAttribLocation(t.program,r)},e.prototype.vertexAttribPointer=function(t,r,i,a,n,o){e.gl.vertexAttribPointer(t,r,i,a,n,o),e.gl.enableVertexAttribArray(t)},e.prototype.activeAttribPointer=function(t,e){for(var r=0;8>r;r++);return this.cacheVertexFormat=t,this.cacheVertexFormat==t},e.prototype.disAttribPointer=function(){for(var t=0;8>t;t++)e.gl.disableVertexAttribArray(t)},e.prototype.setVertexShaderConstData=function(t,r,i){e.gl.vertexAttrib4fv(r,t.subarray(r,i))},e.prototype.setFragmentShaderConstData=function(t,e,r){},e.prototype.setTexture2DAt=function(t,r,i,a){e.gl.activeTexture(t),e.gl.bindTexture(e.gl.TEXTURE_2D,a.textureBuffer),e.gl.uniform1i(r,i)},e.prototype.disableTexture2DAt=function(t,e,r){},e.prototype.setCubeTextureAt=function(t,r,i,a){a&&(e.gl.activeTexture(t),e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,a.texture),e.gl.uniform1i(r,i))},e.prototype.setScissorRectangle=function(r,i,a,n){e.gl.scissor(r,t.ContextConfig.canvasRectangle.height-n-i,a,n)},e.prototype.setStencilReferenceValue=function(){},e.prototype.setStencilActions=function(t,e,r,i,a){},e.prototype.bindVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer)},e.prototype.bindIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,t.buffer)},e.prototype.drawArrays=function(t,r,i){e.gl.drawArrays(t,r,i)},e.prototype.drawElement=function(t,r,i){e.gl.drawElements(t,i,e.gl.UNSIGNED_SHORT,r)},e.prototype.flush=function(){e.gl.flush()},e}();t.Context3DProxy=e,__reflect(e.prototype,"egret3d.Context3DProxy")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function t(){}return t.init=function(){},t.encode=function(t){return null},t.decode=function(e){return t.decoder.decode(new Uint8Array(e)).buffer},t.encodeAsync=function(t,e){},t.decodeAsync=function(e,r){null==t.callback?t.callback=r:console.log("Warning! Another LZMA decoding is running...")},t}();e.decoder=new t.LZMA,e.ENCODE=1,e.DECODE=2,t.LZMAHelper=e,__reflect(e.prototype,"nid.LZMAHelper")}(nid||(nid={})),nid.LZMAHelper.init();var egret3d;!function(t){var e=function(){function e(){this.border=0,this.useMipmap=!0,this.colorformat=t.ContextConfig.ColorFormat_RGBA8888,this.internalformat=t.InternalFormat.PixelArray,this.mimapData=new Array}return e.prototype.dispose=function(){this.texture&&(t.Context3DProxy.gl.deleteTexture(this.texture),this.texture=null),this.image_front&&(this.image_front.dispose(),this.image_front=null),this.image_back&&(this.image_back.dispose(),this.image_back=null),this.image_left&&(this.image_left.dispose(),this.image_left=null),this.image_right&&(this.image_right.dispose(),this.image_right=null),this.image_up&&(this.image_up.dispose(),this.image_up=null),this.image_down&&(this.image_down.dispose(),this.image_down=null)},e}();t.ContextTexture3D=e,__reflect(e.prototype,"egret3d.ContextTexture3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.FrameBuffer=e,__reflect(e.prototype,"egret3d.FrameBuffer")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.buffer=t}return e.prototype.dispose=function(){this.buffer&&(t.Context3DProxy.gl.deleteBuffer(this.buffer),this.buffer=null),this.arrayBuffer&&(delete this.arrayBuffer,this.arrayBuffer=null)},e}();t.IndexBuffer3D=e,__reflect(e.prototype,"egret3d.IndexBuffer3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,r){this.data=t,this.width=e,this.height=r}return t}();t.MipmapData=e,__reflect(e.prototype,"egret3d.MipmapData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.name="",this.program=t}return e.prototype.dispose=function(){this.program&&(t.Context3DProxy.gl.deleteProgram(this.program),this.program=null)},e}();t.Program3D=e,__reflect(e.prototype,"egret3d.Program3D")}(egret3d||(egret3d={}));var nid;!function(t){"use strict";var e=function(){function e(){this.command=null;var e=this;this.decoder=new t.LZMA,addEventListener("message",function(t){null==e.command?e.command=t.data:1==e.command.job?e.command=null:2==e.command.job&&e.decode(t.data)},!1)}return e.prototype.decode=function(t){this.time=Date.now();var e=this.decoder.decode(new Uint8Array(t));this.command.time=Date.now()-this.time,postMessage(this.command),postMessage(e.buffer,[e.buffer])},e}();e.ENCODE=1,e.DECODE=2,t.LZMAWorker=e,__reflect(e.prototype,"nid.LZMAWorker")}(nid||(nid={})),new nid.LZMAWorker;var egret3d;!function(t){var e=function(){function e(t){this._shader=t}return Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._shader&&(t.Context3DProxy.gl.deleteShader(this._shader),this._shader=null)},e}();e.vertex=0,e.fragment=1,e.ID_COUNT=0,t.Shader=e,__reflect(e.prototype,"egret3d.Shader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.buffer=t}return e.prototype.dispose=function(){this.buffer&&(t.Context3DProxy.gl.deleteBuffer(this.buffer),this.buffer=null),this.arrayBuffer&&(delete this.arrayBuffer,this.arrayBuffer=null)},e}();t.VertexBuffer3D=e,__reflect(e.prototype,"egret3d.VertexBuffer3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n){void 0===i&&(i=null),void 0===a&&(a=100),void 0===n&&(n=100);var o=this;return null==i&&(i=new t.PlaneGeometry(a,n,1,1,1,1,t.Vector3D.Z_AXIS)),o=e.call(this,i,r)||this,o.width=a,o.height=n,o.bound||(o.bound=o.buildBoundBox()),o}return __extends(r,e),r.prototype.update=function(t,r,i){e.prototype.update.call(this,t,r,i),this.globalOrientation=i.globalOrientation},r.prototype.copy=function(t){e.prototype.copy.call(this,t)},r.prototype.clone=function(){var t=new r(this.material,this.geometry,this.width,this.height);return t.copy(this),t},r}(t.Mesh);t.Billboard=e,__reflect(e.prototype,"egret3d.Billboard")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e}(t.Object3D);t.Entity=e,__reflect(e.prototype,"egret3d.Entity")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.LITTLE_ENDIAN="littleEndian",e.BIG_ENDIAN="bigEndian",t.Endian=e,__reflect(e.prototype,"egret3d.Endian");var r=function(){function t(t){this.BUFFER_EXT_SIZE=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=e.BIG_ENDIAN}return t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0},t.prototype.setArrayBuffer=function(t){},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t,this.write_position=t.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this.write_position=t>this.write_position?t:this.write_position},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.write_position=t;var e=new Uint8Array(new ArrayBuffer(t)),r=this.data.buffer.byteLength;r>t&&(this._position=t);var i=Math.min(r,t);e.set(new Uint8Array(this.data.buffer,0,i)),this.buffer=e.buffer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))},t.prototype.readBoolean=function(){return this.validate(t.SIZE_OF_BOOLEAN)?0!=this.data.getUint8(this.position++):null},t.prototype.readByte=function(){return this.validate(t.SIZE_OF_INT8)?this.data.getInt8(this.position++):null},t.prototype.readBytes=function(e,r,i){if(void 0===r&&(r=0),void 0===i&&(i=0),0==i)i=this.bytesAvailable;else if(!this.validate(i))return null;e?e.validateBuffer(r+i):e=new t(new ArrayBuffer(r+i));var a=new Uint8Array(e.buffer),n=new Uint8Array(this.data.buffer,this.position,i);a.set(n,e.position),this.position+=i},t.prototype.readDouble=function(){if(!this.validate(t.SIZE_OF_FLOAT64))return null;var r=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT64,r},t.prototype.uncompress=function(t){void 0===t&&(t="7z");var e=new nid.LZMA,r=e.decode(new Uint8Array(this.data.buffer)).buffer;this.buffer=r},t.prototype.compress=function(t){void 0===t&&(t="7z");var e=(new nid.LZMA,nid.LZMAHelper.encode(this.data.buffer));this.buffer=e},t.prototype.readFloat=function(){if(!this.validate(t.SIZE_OF_FLOAT32))return null;var r=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT32,r},t.prototype.readInt=function(){if(!this.validate(t.SIZE_OF_INT32))return null;var r=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT32,r},t.prototype.readShort=function(){if(!this.validate(t.SIZE_OF_INT16))return null;var r=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT16,r},t.prototype.readUnsignedByte=function(){return this.validate(t.SIZE_OF_UINT8)?this.data.getUint8(this.position++):null},t.prototype.readUnsignedInt=function(){if(!this.validate(t.SIZE_OF_UINT32))return null;var r=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT32,r},t.prototype.readUnsignedShort=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var r=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,r},t.prototype.readUTF=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var r=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,r>0?this.readUTFBytes(r):""},t.prototype.readUTFBytes=function(t){if(!this.validate(t))return null;var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)},t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,e?1:0)},t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8),this.data.setInt8(this.position++,e)},t.prototype.writeUnsignedByte=function(e){this.validateBuffer(t.SIZE_OF_UINT8),this.data.setUint8(this.position++,e)},t.prototype.writeBytes=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=0);var i;if(!(0>e)&&!(0>r)&&(i=0==r?t.length-e:Math.min(t.length-e,r),i>0)){this.validateBuffer(i);var a=new Uint8Array(this.buffer),n=new Uint8Array(t.buffer,e,i);a.set(n,this.position),this.position+=i}},t.prototype.writeDouble=function(r){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeFloat=function(r){this.validateBuffer(t.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT32},t.prototype.writeInt=function(r){this.validateBuffer(t.SIZE_OF_INT32),this.data.setInt32(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT32},t.prototype.writeShort=function(r){this.validateBuffer(t.SIZE_OF_INT16),this.data.setInt16(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUnsignedInt=function(r){this.validateBuffer(t.SIZE_OF_UINT32),this.data.setUint32(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT32},t.prototype.writeUnsignedShort=function(r){this.validateBuffer(t.SIZE_OF_UINT16),this.data.setUint16(this.position,r,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16},t.prototype.writeUTF=function(r){var i=this.encodeUTF8(r),a=i.length;this.validateBuffer(t.SIZE_OF_UINT16+a),this.data.setUint16(this.position,a,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16,this._writeUint8Array(i,!1)},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0),e&&this.validateBuffer(this.position+t.length);var r=new Uint8Array(this.buffer);r.set(t,this.position),this.position+=t.length},t.prototype.validate=function(t){return this.data.byteLength>0&&this._position+t<=this.data.byteLength?!0:void 0},t.prototype.validateBuffer=function(t,e){if(void 0===e&&(e=!1),this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this.data.byteLength<t||e){var r=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),i=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE),a=new Uint8Array(this.data.buffer,0,i);r.set(a),this.buffer=r.buffer}},t.prototype.encodeUTF8=function(t){for(var e=0,r=this.stringToCodePoints(t),i=[];r.length>e;){var a=r[e++];if(this.inRange(a,55296,57343))this.encoderError(a);else if(this.inRange(a,0,127))i.push(a);else{var n,o;for(this.inRange(a,128,2047)?(n=1,o=192):this.inRange(a,2048,65535)?(n=2,o=224):this.inRange(a,65536,1114111)&&(n=3,o=240),i.push(this.div(a,Math.pow(64,n))+o);n>0;){var s=this.div(a,Math.pow(64,n-1));i.push(128+s%64),n-=1}}}return new Uint8Array(i)},t.prototype.decodeUTF8=function(t){for(var e,r=!1,i=0,a="",n=0,o=0,s=0,l=0;t.length>i;){var h=t[i++];if(h==this.EOF_byte)e=0!=o?this.decoderError(r):this.EOF_code_point;else if(0==o)this.inRange(h,0,127)?e=h:(this.inRange(h,194,223)?(o=1,l=128,n=h-192):this.inRange(h,224,239)?(o=2,l=2048,n=h-224):this.inRange(h,240,244)?(o=3,l=65536,n=h-240):this.decoderError(r),n*=Math.pow(64,o),e=null);else if(this.inRange(h,128,191))if(s+=1,n+=(h-128)*Math.pow(64,o-s),s!==o)e=null;else{var u=n,c=l;n=0,o=0,s=0,l=0,e=this.inRange(u,c,1114111)&&!this.inRange(u,55296,57343)?u:this.decoderError(r,h)}else n=0,o=0,s=0,l=0,i--,e=this.decoderError(r,h);null!==e&&e!==this.EOF_code_point&&(65535>=e?e>0&&(a+=String.fromCharCode(e)):(e-=65536,a+=String.fromCharCode(55296+(e>>10&1023)),a+=String.fromCharCode(56320+(1023&e))))}return a},t.prototype.encoderError=function(t){},t.prototype.decoderError=function(t,e){return e||65533},t.prototype.inRange=function(t,e,r){return t>=e&&r>=t},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],r=0,i=t.length;r<t.length;){var a=t.charCodeAt(r);if(this.inRange(a,55296,57343))if(this.inRange(a,56320,57343))e.push(65533);else if(r==i-1)e.push(65533);else{var n=t.charCodeAt(r+1);if(this.inRange(n,56320,57343)){var o=1023&a,s=1023&n;r+=1,e.push(65536+(o<<10)+s)}else e.push(65533)}else e.push(a);r+=1}return e},t}();r.SIZE_OF_BOOLEAN=1,r.SIZE_OF_INT8=1,r.SIZE_OF_INT16=2,r.SIZE_OF_INT32=4,r.SIZE_OF_UINT8=1,r.SIZE_OF_UINT16=2,r.SIZE_OF_UINT32=4,r.SIZE_OF_FLOAT32=4,r.SIZE_OF_FLOAT64=8,t.ByteArray=r,__reflect(r.prototype,"egret3d.ByteArray")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.isDebug=!1,this._console=document.createElement("console"),document.body.appendChild(this._console),this._console.style.color="red",this._console.style.zIndex="1000",this._console.style.position="absolute",this._console.style.top="10px",this._console.style.left="10px"}return t.prototype.trace=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this.isDebug){this.reset();for(var r=t.length,i=0;r>i;i++)this._console.innerHTML+=t[i]+"</br>"}},t.prototype.reset=function(){this._console.innerHTML=""},Object.defineProperty(t,"instance",{get:function(){return null==this._instance&&(this._instance=new t),this._instance},enumerable:!0,configurable:!0}),t}();e._instance=null,t.Debug=e,__reflect(e.prototype,"egret3d.Debug")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,r,i){void 0===i&&(i=null);var a=t.call(this,e,r)||this;return a.camera=i,a.bound||(a.bound=a.buildBoundBox()),a}return __extends(e,t),e.prototype.update=function(e,r,i){t.prototype.update.call(this,e,r,i),this.camera&&(this.globalPosition=this.camera.globalPosition)},e.prototype.copy=function(e){t.prototype.copy.call(this,e)},e.prototype.clone=function(){var t=new e(this.geometry,this.material,this.camera);return t.copy(this),t},e}(t.Mesh);t.Sky=e,__reflect(e.prototype,"egret3d.Sky")}(egret3d||(egret3d={}));var nid;!function(t){var e=function(){function t(){}return t.allocateUint8=function(e){t.u8=new Uint8Array(e)},t.allocateUint16=function(e){t.u16=new Uint16Array(e)},t.allocateUint32=function(e){t.u32=new Uint32Array(e)},t.reset=function(){t.u8Index=0,t.u16Index=0,t.u32Index=0},t.getUint8=function(){return t.u8||t.allocateUint8(10),t.u8Index++},t.getUint16=function(){return t.u16||t.allocateUint16(24),t.u16Index++},t.getUint32=function(){return t.u32||t.allocateUint32(10),t.u32Index++},t}();e.u8Index=0,e.u16Index=0,e.u32Index=0,t.MEMORY=e,__reflect(e.prototype,"nid.MEMORY")}(nid||(nid={}));var egret3d;!function(t){var e=function(e){function r(t,r,i,a){void 0===i&&(i=4278255360),void 0===a&&(a=4278190335);var n=e.call(this)||this;return n._startColor=4278255360,n._endColor=4278190335,n._vb=new Array,n._ib=new Array,n.material.diffuseColor=4294967295,n.setStartAndEndPosition(t,r),n.setStartAndEndColor(i,a),n}return __extends(r,e),r.prototype.setStartAndEndPosition=function(t,e){this._start=t,this._end=e,this.updateLine()},r.prototype.setStartAndEndColor=function(t,e){this._startColor=t,this._endColor=e,this.updateLine()},r.prototype.updateLine=function(){this._vb.length=0,this._ib.length=0;var e=t.Color.getColor(this._startColor),r=t.Color.getColor(this._endColor);this._vb.push(this._start.x,this._start.y,this._start.z,e.x,e.y,e.z,e.w),this._vb.push(this._end.x,this._end.y,this._end.z,r.x,r.y,r.z,r.w);for(var i=0;i<this._vb.length/3;++i)this._ib.push(i);this.geometry.setVerticesForIndex(0,t.VertexFormat.VF_POSITION|t.VertexFormat.VF_COLOR,this._vb,this._vb.length/7),this.geometry.setVertexIndices(0,this._ib)},r}(t.Wireframe);t.WireframeLine=e,__reflect(e.prototype,"egret3d.WireframeLine")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r,i,a){void 0===e&&(e=null),void 0===r&&(r=null),void 0===i&&(i=0),void 0===a&&(a=0),this.lt=0,this.rt=0,this.lb=0,this.rb=0,this.tc=0,this.bc=0,this.lc=0,this.rc=0,this.oc=0,this.center=new t.Vector3D,this.center_0=new t.Vector3D,this.radius=0,this.dh0=0,this.dh1=0,this.dh2=0,this.dh3=0,this.dh4=0,this.dh5=0,this.minDH=0,this.maxDH=0,this.d=0,this.childs=[],this.level=0,this.isRender=!1,this.parent=e,this.lodQuadTree=r,this.parent&&(this.level=this.parent.level+1),0!=i&&0!=a&&this.createNode(0,i,(a+1)*i,(a+1)*(i+1)-1),this.parent||this.findNeighbour(this,i,a)}return e.prototype.calculateHeightDiff=function(){e.v0.length=0,e.v1.length=0,e.v2.length=0,e.v3.length=0,e.v4.length=0,e.v5.length=0,e.v6.length=0,e.v7.length=0,e.v8.length=0,e.getVertex(this.lt,e.v0,this.lodQuadTree.vertexDatas),e.getVertex(this.rt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.lb,e.v2,this.lodQuadTree.vertexDatas),e.getVertex(this.rb,e.v3,this.lodQuadTree.vertexDatas);var t=(this.lt+this.rt)/2,r=(this.lb+this.rb)/2,i=(this.lt+this.lb)/2,a=(this.rt+this.rb)/2,n=(this.lt+this.rb)/2;e.getVertex(t,e.v4,this.lodQuadTree.vertexDatas),e.getVertex(r,e.v5,this.lodQuadTree.vertexDatas),e.getVertex(i,e.v6,this.lodQuadTree.vertexDatas),e.getVertex(a,e.v7,this.lodQuadTree.vertexDatas),e.getVertex(n,e.v8,this.lodQuadTree.vertexDatas),this.dh0=(e.v0[2]+e.v1[2])/2-e.v4[2],this.dh1=(e.v2[2]+e.v3[2])/2-e.v5[2],this.dh2=(e.v0[2]+e.v2[2])/2-e.v6[2],this.dh3=(e.v1[2]+e.v3[2])/2-e.v7[2],this.dh4=(e.v0[2]+e.v3[2])/2-e.v8[2],this.dh5=(e.v1[2]+e.v2[2])/2-e.v8[2],this.minDH=Math.max(this.dh0,this.dh1),this.minDH=Math.max(this.minDH,this.dh2),this.minDH=Math.max(this.minDH,this.dh3),this.minDH=Math.max(this.minDH,this.dh4),this.minDH=Math.max(this.minDH,this.dh5),this.maxDH=Math.max(this.dh0,this.dh1),this.maxDH=Math.max(this.maxDH,this.dh2),this.maxDH=Math.max(this.maxDH,this.dh3),this.maxDH=Math.max(this.maxDH,this.dh4),this.maxDH=Math.max(this.maxDH,this.dh5),this.maxDH=Math.max(this.maxDH,1);var o=e.v1[0]-e.v0[0],s=e.v1[1]-e.v0[1],l=e.v1[2]-e.v0[2];this.d=Math.sqrt(o*o+s*s+l*l)},e.prototype.createNode=function(t,r,i,a){if(this.lt=t,this.rt=r,this.lb=i,this.rb=a,this.lodQuadTree.vertexDatas&&this.createBoundSphere(),this.rt-t>1){this.calculateHeightDiff();var n=null,o=(t+r)/2,s=(i+a)/2,l=(t+i)/2,h=(r+a)/2,u=(t+a)/2;this.tc=o,this.bc=s,this.lc=l,this.rc=h,this.oc=u,n=new e(this,this.lodQuadTree),this.childs[0]=n,n.createNode(t,o,l,u),n=new e(this,this.lodQuadTree),this.childs[1]=n,n.createNode(o,r,u,h),n=new e(this,this.lodQuadTree),this.childs[2]=n,n.createNode(l,u,i,s),n=new e(this,this.lodQuadTree),this.childs[3]=n,n.createNode(u,h,s,a)}},e.prototype.createBoundSphere=function(){e.v0.length=0,e.v1.length=0,e.v2.length=0,e.v3.length=0,e.getVertex(this.lt,e.v0,this.lodQuadTree.vertexDatas),e.getVertex(this.rt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.lb,e.v2,this.lodQuadTree.vertexDatas),e.getVertex(this.rb,e.v3,this.lodQuadTree.vertexDatas),e.v4[0]=Math.min(e.v0[0],e.v1[0]),e.v4[0]=Math.min(e.v4[0],e.v2[0]),e.v4[0]=Math.min(e.v4[0],e.v3[0]),e.v4[1]=Math.min(e.v0[1],e.v1[1]),e.v4[1]=Math.min(e.v4[1],e.v2[1]),e.v4[1]=Math.min(e.v4[1],e.v3[1]),e.v4[2]=Math.min(e.v0[2],e.v1[2]),e.v4[2]=Math.min(e.v4[2],e.v2[2]),e.v4[2]=Math.min(e.v4[2],e.v3[2]),e.v5[0]=Math.max(e.v0[0],e.v1[0]),e.v5[0]=Math.max(e.v5[0],e.v2[0]),e.v5[0]=Math.max(e.v5[0],e.v3[0]),e.v5[1]=Math.max(e.v0[1],e.v1[1]),e.v5[1]=Math.max(e.v5[1],e.v2[1]),e.v5[1]=Math.max(e.v5[1],e.v3[1]),e.v5[2]=Math.max(e.v0[2],e.v1[2]),e.v5[2]=Math.max(e.v5[2],e.v2[2]),e.v5[2]=Math.max(e.v5[2],e.v3[2]);var t=e.v5[0]-e.v4[0],r=e.v5[1]-e.v4[1],i=e.v5[2]-e.v4[2];this.radius=Math.sqrt(t*t+r*r+i*i)/2,this.center.x=e.v4[0]+t/2,this.center.y=e.v4[1]+r/2,this.center.z=e.v4[2]+i/2,this.center_0.copyFrom(this.center)},e.getVertex=function(t,e,r){e[0]=r[3*t+0],e[1]=r[3*t+1],e[2]=r[3*t+2]},e.prototype.isNeighbour=function(r,i,a,n){if(this.lt==r&&this.rt==i&&this.lb==a&&this.rb==n)return this;if(this.childs[0]){var o=(r+i+a+n)/4;if(e.v0.length=0,e.getVertex(o,e.v0,this.lodQuadTree.vertexDatas),e.v1.length=0,e.v2.length=0,e.getVertex(this.childs[0].lt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.childs[0].rb,e.v2,this.lodQuadTree.vertexDatas),t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2]))return this.childs[0].isNeighbour(r,i,a,n);if(e.v1.length=0,e.v2.length=0,e.getVertex(this.childs[1].lt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.childs[1].rb,e.v2,this.lodQuadTree.vertexDatas),t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2]))return this.childs[1].isNeighbour(r,i,a,n);if(e.v1.length=0,e.v2.length=0,e.getVertex(this.childs[2].lt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.childs[2].rb,e.v2,this.lodQuadTree.vertexDatas),t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2]))return this.childs[2].isNeighbour(r,i,a,n);if(e.v1.length=0,e.v2.length=0,e.getVertex(this.childs[3].lt,e.v1,this.lodQuadTree.vertexDatas),e.getVertex(this.childs[3].rb,e.v2,this.lodQuadTree.vertexDatas),t.Rectangle.pointInRect(e.v0[0],e.v0[2],e.v1[0],e.v1[2],e.v2[0],e.v2[2]))return this.childs[3].isNeighbour(r,i,a,n)}return null},e.prototype.findNeighbour=function(t,e,r){var i=this.rt-this.lt;if(!(1>=i)){var a=0,n=0,o=0,s=0,l=0;if(16350==this.lt&&16352==this.rt&&16608==this.lb&&16610==this.rb);for(var h=0;4>h;++h){switch(h){case 0:a=this.lt-i*(e+1),n=this.rt-i*(e+1),o=this.lt,s=this.rt;break;case 1:a=this.lb,n=this.rb,o=this.lb+i*(e+1),s=this.rb+i*(e+1);break;case 2:a=this.lt-i,n=this.lt,o=this.lb-i,s=this.lb;break;case 3:a=this.rt,n=this.rt+i,o=this.rb,s=this.rb+i}l=(a+n+o+s)/4,l>=0&&(e+1)*(r+1)-1>=l&&(this.childs[h+4]=t.isNeighbour(a,n,o,s))}this.childs[0]&&(this.childs[0].findNeighbour(t,e,r),this.childs[1].findNeighbour(t,e,r),this.childs[2].findNeighbour(t,e,r),this.childs[3].findNeighbour(t,e,r))}},e.prototype.isDivide=function(t,r){e.v0.length=0,e.getVertex(this.oc,e.v0,this.lodQuadTree.vertexDatas_0);var i=t.globalX-e.v0[0],a=t.globalY-e.v0[1],n=t.globalZ-e.v0[2],o=Math.sqrt(i*i+a*a+n*n);
return o/(this.d*r*this.maxDH)<1?!0:!1},e.prototype.setIsRender=function(t){this.isRender=t,this.childs[0]&&(this.childs[0].setIsRender(t),this.childs[1].setIsRender(t),this.childs[2].setIsRender(t),this.childs[3].setIsRender(t))},e}();e.v0=[],e.v1=[],e.v2=[],e.v3=[],e.v4=[],e.v5=[],e.v6=[],e.v7=[],e.v8=[],t.LODNode=e,__reflect(e.prototype,"egret3d.LODNode");var r=function(){function r(i,a){this.lodValue=16,this.offset=200,this.level=7,this.row=128,this.col=128,this.enable=!0,this.currentNodes=[],this.nextNodes=[],this.v0=new t.Vector3D,this.v1=new t.Vector3D,this.row=a,this.col=a,this.vertexDatas=i,this.vertexDatas_0=[];for(var n=0;n<i.length;++n)this.vertexDatas_0[0]=i[n];this.level=r.getOrder(a),this.root=new e(null,this,this.row,this.col)}return r.getOrder=function(t){var e=0;t=t-1>>0;do t>>=1,e++;while(t);return e},r.prototype.build=function(t,e,r){this.currentNodes.length=0,this.nextNodes.length=0,this.currentNodes.push(this.root);var i;this.root.setIsRender(!1);for(var a=this.level;a>=0;--a){for(var n=0;n<this.currentNodes.length;++n)i=this.currentNodes[n],r.frustum.inSphere(i.center_0,i.radius+this.offset)&&(i.rt-i.lt<=1?(e[t++]=i.lt,e[t++]=i.rb,e[t++]=i.lb,e[t++]=i.lt,e[t++]=i.rt,e[t++]=i.rb,i.isRender=!0):this.enable?i.isDivide(r,this.lodValue)?(this.nextNodes.push(i.childs[0]),this.nextNodes.push(i.childs[1]),this.nextNodes.push(i.childs[2]),this.nextNodes.push(i.childs[3])):i.setIsRender(!0):(this.nextNodes.push(i.childs[0]),this.nextNodes.push(i.childs[1]),this.nextNodes.push(i.childs[2]),this.nextNodes.push(i.childs[3])));var o=this.currentNodes;this.currentNodes=this.nextNodes,this.nextNodes=o,this.nextNodes.length=0}this.currentNodes.length=0,this.nextNodes.length=0,this.currentNodes.push(this.root);for(var a=this.level;a>=0;--a){for(var n=0;n<this.currentNodes.length;++n)if(i=this.currentNodes[n],i.isRender&&i.rt-i.lt>1){var s=!1,l=!1,h=!1,u=!1;if(s=i.childs[4]?i.childs[4].isRender:!0,l=i.childs[5]?i.childs[5].isRender:!0,h=i.childs[6]?i.childs[6].isRender:!0,u=i.childs[7]?i.childs[7].isRender:!0,s&&l&&h&&u){e[t++]=i.lt,e[t++]=i.rb,e[t++]=i.lb,e[t++]=i.lt,e[t++]=i.rt,e[t++]=i.rb;continue}s||!i.childs[4]?(e[t++]=i.oc,e[t++]=i.lt,e[t++]=i.rt):(t=this.mendCracks(t,e,i,i.childs[4].childs[2],4),t=this.mendCracks(t,e,i,i.childs[4].childs[3],4)),l||!i.childs[5]?(e[t++]=i.lb,e[t++]=i.oc,e[t++]=i.rb):(t=this.mendCracks(t,e,i,i.childs[5].childs[0],5),t=this.mendCracks(t,e,i,i.childs[5].childs[1],5)),h||!i.childs[6]?(e[t++]=i.lt,e[t++]=i.oc,e[t++]=i.lb):(t=this.mendCracks(t,e,i,i.childs[6].childs[1],6),t=this.mendCracks(t,e,i,i.childs[6].childs[3],6)),u||!i.childs[7]?(e[t++]=i.oc,e[t++]=i.rt,e[t++]=i.rb):(t=this.mendCracks(t,e,i,i.childs[7].childs[0],7),t=this.mendCracks(t,e,i,i.childs[7].childs[2],7))}else i.childs[0]&&(this.nextNodes.push(i.childs[0]),this.nextNodes.push(i.childs[1]),this.nextNodes.push(i.childs[2]),this.nextNodes.push(i.childs[3]));var o=this.currentNodes;this.currentNodes=this.nextNodes,this.nextNodes=o,this.nextNodes.length=0}return t},r.prototype.mendCracks=function(t,e,r,i,a){if(!i)return t;switch(a){case 4:i&&(i.isRender?(e[t++]=r.oc,e[t++]=i.lb,e[t++]=i.rb):(t=this.mendCracks(t,e,r,i.childs[2],4),t=this.mendCracks(t,e,r,i.childs[3],4)));break;case 5:i&&(i.isRender?(e[t++]=i.lt,e[t++]=r.oc,e[t++]=i.rt):(t=this.mendCracks(t,e,r,i.childs[0],5),t=this.mendCracks(t,e,r,i.childs[1],5)));break;case 6:i&&(i.isRender?(e[t++]=r.oc,e[t++]=i.rb,e[t++]=i.rt):(t=this.mendCracks(t,e,r,i.childs[1],6),t=this.mendCracks(t,e,r,i.childs[3],6)));break;case 7:i&&(i.isRender?(e[t++]=r.oc,e[t++]=i.lt,e[t++]=i.lb):(t=this.mendCracks(t,e,r,i.childs[0],7),t=this.mendCracks(t,e,r,i.childs[2],7)))}return t},r.prototype.onUpdate=function(t){this.currentNodes.length=0,this.nextNodes.length=0,this.currentNodes.push(this.root);for(var e,r=this.level;r>=0;--r){for(var i=0;i<this.currentNodes.length;++i)e=this.currentNodes[i],t.transformVector(e.center,e.center_0),this.nextNodes.push(e.childs[0]),this.nextNodes.push(e.childs[1]),this.nextNodes.push(e.childs[2]),this.nextNodes.push(e.childs[3]);var a=this.currentNodes;this.currentNodes=this.nextNodes,this.nextNodes=a,this.nextNodes.length=0}for(var r=0;r<this.vertexDatas.length/3;++r)this.v0.setTo(this.vertexDatas[3*r+0],this.vertexDatas[3*r+1],this.vertexDatas[3*r+2]),t.transformVector(this.v0,this.v0),this.vertexDatas_0[3*r+0]=this.v0.x,this.vertexDatas_0[3*r+1]=this.v0.y,this.vertexDatas_0[3*r+2]=this.v0.z},r}();t.LODQuadTree=r,__reflect(r.prototype,"egret3d.LODQuadTree")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n,o,s,l,h){void 0===i&&(i=1e3),void 0===a&&(a=100),void 0===n&&(n=1e3),void 0===o&&(o=128),void 0===s&&(s=128),void 0===l&&(l=!1),void 0===h&&(h=null);var u=e.call(this,new t.ElevationGeometry(r,i,a,n,o,s),h)||this;return u.useLod=l,l&&(o==s&&0==(o&o-1)?(u.vertex=u.geometry.getVertexForIndex(0,t.VertexFormat.VF_POSITION,null,u.geometry.vertexCount),u.lodQuadTree=new t.LODQuadTree(u.vertex,o),u.lodQuadTree.onUpdate(u.modelMatrix)):t.Egret3DLog.outError("地形宽高不相等或者不是2的N次方!")),u}return __extends(r,e),r.prototype.copy=function(t){e.prototype.copy.call(this,t)},r.prototype.clone=function(){var t=new r(this.terrainGeometry.heightmap,this.terrainGeometry.width,this.terrainGeometry.height,this.terrainGeometry.depth,this.terrainGeometry.segmentsW,this.terrainGeometry.segmentsH,this.useLod,this.material);return t.copy(this),t},Object.defineProperty(r.prototype,"terrainGeometry",{get:function(){return this.geometry},enumerable:!0,configurable:!0}),r.prototype.onUpdateTransform=function(){e.prototype.onUpdateTransform.call(this),this.lodQuadTree&&this.lodQuadTree.onUpdate(this.modelMatrix)},r.prototype.startLOD=function(e){if(e&&!this.lodQuadTree){var r=this.geometry;r.segmentsW==r.segmentsH&&0==(r.segmentsW&r.segmentsW-1)?(this.vertex=this.geometry.getVertexForIndex(0,t.VertexFormat.VF_POSITION,null,this.geometry.vertexCount),this.lodQuadTree=new t.LODQuadTree(this.vertex,r.segmentsW),this.lodQuadTree.onUpdate(this.modelMatrix)):t.Egret3DLog.outError("地形宽高不相等或者不是2的N次方!")}else this.lodQuadTree&&(this.lodQuadTree.enable=!1)},r.prototype.update=function(t,r,i){if(e.prototype.update.call(this,t,r,i),this.lodQuadTree){var a=0;a=this.lodQuadTree.build(a,this.geometry.indexArray,this.cullCamrea?this.cullCamrea:i),this.geometry.indexCount=a,this.geometry.bufferDiry=!0,this.geometry.subGeometrys[0].count=this.geometry.indexCount,this.lodQuadTree.enable||(this.lodQuadTree=null)}},r}(t.Mesh);t.Terrain=e,__reflect(e.prototype,"egret3d.Terrain")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){this.location=t,this.data=e}return t}();t.KDData=e,__reflect(e.prototype,"egret3d.KDData");var r=function(){function t(){}return t.prototype.buildTree=function(t){var e=t.map(function(t){var e=[t.location[0],t.location[1]];return e.datum=t,e});this.root=this.treeify(e,0)},t.prototype.treeify=function(t,e){try{var r=t[0].length}catch(a){return null}var n=e%r;t.sort(function(t,e){return t[n]-e[n]});var o=Math.floor(t.length/2),s=t[o],l=t.slice(0,o),h=t.slice(o+1);return new i(s,n,[this.treeify(l,e+1),this.treeify(h,e+1)],s.datum)},t}();t.KDTree=r,__reflect(r.prototype,"egret3d.KDTree");var i=function(){function t(t,e,r,i){this.location=t,this.axis=e,this.subnodes=r,this.datum=i}return t.prototype.find=function(e,r){function i(r){if(null!==r){var a=t.distance(r.location,e);if(n.add(r,a),e[r.axis]<r.location[r.axis]){i(r.subnodes[0]);var o=r.subnodes[1]}else{i(r.subnodes[1]);var o=r.subnodes[0]}var s=Math.abs(r.location[r.axis]-e[r.axis]);(!n.isFull()||s<n.maxPriority())&&i(o)}}r=r||1;var n=new a(r);return i(this),n.values},t.distance=function(t,e){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))},t}();t.KDNode=i,__reflect(i.prototype,"egret3d.KDNode");var a=function(){function t(t){this.capacity=t,this.elements=[]}return t.prototype.isFull=function(){return this.elements.length===this.capacity},t.prototype.isEmpty=function(){return 0===this.elements.length},t.prototype.maxPriority=function(){return this.elements[this.elements.length-1].priority},Object.defineProperty(t.prototype,"values",{get:function(){return this.elements.map(function(t){return t.value})},enumerable:!0,configurable:!0}),t.prototype.add=function(t,e){var r=this.elements,i={value:t,priority:e};if(this.isEmpty())r.push(i);else for(var a=0;a<r.length;a++){if(e<r[a].priority){r.splice(a,0,i);break}a!=r.length-1||this.isFull()||r.push(i)}this.elements=r.slice(0,this.capacity)},t}();__reflect(a.prototype,"BPQ")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.minPosX=0,this.minPosY=0,this.maxPosX=0,this.maxPosY=0,this.testID=0,this.points=new Array,this.offsetPosition=new t.Vector3D(0,0,0,0),this.clear()}return e.prototype.setAABox=function(t,r,i,a){this.minPosX=t-i/2-e.TINY,this.maxPosX=t+i/2+e.TINY,this.minPosY=r-a/2-e.TINY,this.maxPosY=r+a/2+e.TINY,this.offsetPosition.setTo(0,0,0)},e.prototype.setOffset=function(t){this.maxPosX+=t.x-this.offsetPosition.x,this.minPosX+=t.x-this.offsetPosition.x,this.minPosY+=t.z-this.offsetPosition.z,this.maxPosY+=t.z-this.offsetPosition.z,this.offsetPosition.copyFrom(t)},e.prototype.setContainRect=function(t,e,r,i){this.minPosX>t&&(this.minPosX=t),this.minPosY>e&&(this.minPosY=e),this.maxPosX<r&&(this.maxPosX=r),this.maxPosY<i&&(this.maxPosY=i)},e.prototype.clear=function(){var t=1e9;this.minPosX=this.minPosY=t,this.maxPosX=this.maxPosY=-t,this.points.length=0,this.testID=0,this.offsetPosition.setTo(0,0,0)},e.prototype.addPoint=function(t){-1==this.points.indexOf(t)&&(t.x<this.minPosX&&(this.minPosX=t.x-e.TINY),t.x>this.maxPosX&&(this.maxPosX=t.x+e.TINY),t.z<this.minPosY&&(this.minPosY=t.z-e.TINY),t.z>this.maxPosY&&(this.maxPosY=t.z+e.TINY),this.points.push(t))},e.prototype.clone=function(){var t=new e;return t.minPosX=this.minPosX,t.minPosY=this.minPosY,t.maxPosX=this.maxPosX,t.maxPosY=this.maxPosY,t},Object.defineProperty(e.prototype,"radius",{get:function(){return Math.sqrt((this.maxPosY-this.minPosY)*(this.maxPosY-this.minPosY)+(this.maxPosX-this.minPosX)*(this.maxPosX-this.minPosX))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sideX",{get:function(){return this.maxPosX-this.minPosX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sideY",{get:function(){return this.maxPosY-this.minPosY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centreX",{get:function(){return.5*(this.maxPosX-this.minPosX)+this.minPosX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centreY",{get:function(){return.5*(this.maxPosY-this.minPosY)+this.minPosY},enumerable:!0,configurable:!0}),e.prototype.overlapTest=function(t){return this.minPosY>=t.maxPosY||this.maxPosY<=t.minPosY||this.minPosX>=t.maxPosX||this.maxPosX<=t.minPosX?!1:!0},e.prototype.isPointInside=function(t){return t.x>=this.minPosX&&t.x<=this.maxPosX&&t.z>=this.minPosY&&t.z<=this.maxPosY},e.prototype.isIntersectLineSegment=function(t,e,r,i){var a=!1,n=e-i,o=r-t,s=t*i-r*e,l=(-s-n*this.minPosX)/o;l<=this.maxPosY&&l>=this.minPosY&&(a=!0),l=(-s-n*this.maxPosX)/o,l<=this.maxPosY&&l>=this.minPosY&&(a=!0);var h=(-s-o*this.minPosY)/n;return h<=this.maxPosX&&h>=this.minPosX&&(a=!0),h=(-s-o*this.maxPosY)/n,h<=this.maxPosX&&h>=this.minPosX&&(a=!0),a},e}();e.TINY=1e-6,t.QuadAABB=e,__reflect(e.prototype,"egret3d.QuadAABB")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r){void 0===e&&(e=10),void 0===r&&(r=500),this._maxNodesPerCell=e,this._minCellSize=r,this._segBox=new t.QuadAABB,this._collisionNodesIdx=new Array,this._collisionNodes=new Array}return e.prototype.createQuadTree=function(e){this._quadTree=new t.QuadTree,this._quadTree.initNodes(e),this._quadTree.buildQuadTree(this._maxNodesPerCell,this._minCellSize)},e.prototype.getNodesByAABB=function(t,e,r,i){this._segBox.clear(),this._segBox.maxPosX=r,this._segBox.maxPosY=i,this._segBox.minPosX=t,this._segBox.minPosY=e,this._collisionNodesIdx.length=0,this._collisionNodes.length=0;for(var a,n=(this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox),0);n<this._collisionNodesIdx.length;n++)a=this._quadTree.getQuadNode(this._collisionNodesIdx[n]),this._collisionNodes.push(a);return this._collisionNodes},e.prototype.getTriangleAtPoint=function(e,r){void 0===r&&(r=5),this._segBox.clear(),this._segBox.setAABox(e.x,e.z,1,1),this._collisionNodesIdx.length=0,this._collisionNodes.length=0;for(var i,a,n,o,s=(this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox),4294967295),l=0,h=0;h<this._collisionNodesIdx.length;h++)a=this._quadTree.getQuadNode(this._collisionNodesIdx[h]),o=a.aabb,t.PointUtils.pointInsideTriangle(e,o.points[0],o.points[1],o.points[2])&&(n=a,l=Math.abs(n.plane.distance(e)),l>r||(null==a||s>=l)&&(i=n,s=l));return i},e}();t.QuadRoot=e,__reflect(e.prototype,"egret3d.QuadRoot")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.logDeep=0,this._testID=0,this._cells=new Array,this._quadNodes=new Array,this._cellsToTest=new Array,this._aabb=new t.QuadAABB}return e.prototype.getQuadNode=function(t){return this._quadNodes[t]},e.prototype.clear=function(){this._cells.length=0,this._quadNodes.length=0},e.prototype.initNodes=function(t){this.clear();for(var e=0,r=t.length;r>e;)t[e].calcGlobalQuadAABB(),this._quadNodes.push(t[e]),e++},e.prototype.buildQuadTree=function(e,r){this._aabb.clear();for(var i=0,a=this._quadNodes;i<a.length;i++){var n=a[i];if(n.isTriangle)for(var o=0,s=n.aabb.points;o<s.length;o++){var l=s[o];this._aabb.addPoint(l)}else this._aabb.setContainRect(n.aabb.minPosX,n.aabb.minPosY,n.aabb.maxPosX,n.aabb.maxPosY)}this._cells.length=0,this._rootCell=new t.QuadTreeCell(this._aabb),this._cells.push(this._rootCell);for(var h=this._quadNodes.length,u=0;h>u;u++)this._cells[0].nodeIndices[u]=u;var c=new Array;c.push(0);for(var d,p,f;0!=c.length;)if(p=c.pop(),!(this._cells[p].nodeIndices.length<=e||this._cells[p].aabb.radius<r)){for(u=0;u<t.QuadTreeCell.NUM_CHILDREN;u++){this._cells[p].childCellIndices[u]=this._cells.length,c.push(this._cells.length),this._cells.push(new t.QuadTreeCell(this.createAABox(this._cells[p].aabb,u))),f=this._cells[this._cells.length-1],h=this._cells[p].nodeIndices.length;for(var m=0,_=0;h>_;_++)d=this._cells[p].nodeIndices[_],this.doesNodeIntersectCell(this._quadNodes[d],f)&&(m++,f.nodeIndices.push(d))}this._cells[p].nodeIndices.length=0}},e.prototype.createAABox=function(e,r){var i=e.centreX,a=e.centreY,n=e.sideX,o=e.sideY,s=new t.QuadAABB;switch(r){case 0:s.setAABox(i+n/4,a+o/4,n/2,o/2);break;case 1:s.setAABox(i-n/4,a+o/4,n/2,o/2);break;case 2:s.setAABox(i-n/4,a-o/4,n/2,o/2);break;case 3:s.setAABox(i+n/4,a-o/4,n/2,o/2);break;default:s.setAABox(i+n/4,a-o/4,n/2,o/2)}return s},e.prototype.doesNodeIntersectCell=function(t,e){var r=t.aabb;if(!r.overlapTest(e.aabb))return!1;if(!t.isTriangle)return!0;var i=r.points,a=i[0],n=i[1],o=i[2];if(e.aabb.isPointInside(a)||e.aabb.isPointInside(n)||e.aabb.isPointInside(o))return!0;var s=this.pointInTriangle(e.aabb.minPosX,e.aabb.minPosY,a,n,o)||this.pointInTriangle(e.aabb.minPosX,e.aabb.maxPosY,a,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.maxPosY,a,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.minPosY,a,n,o);return s?!0:s=e.aabb.isIntersectLineSegment(a.x,a.z,n.x,n.z)||e.aabb.isIntersectLineSegment(a.x,a.z,o.x,o.z)||e.aabb.isIntersectLineSegment(n.x,n.z,o.x,o.z)},e.prototype.getNodesIntersectingtAABox=function(e,r){if(0==this._cells.length)return 0;this._cellsToTest.length=0,this._cellsToTest.push(0),this.incrementTestCounter();for(var i,a,n,o,s=0;0!=this._cellsToTest.length;)if(i=this._cellsToTest.pop(),n=this._cells[i],r.overlapTest(n.aabb))if(n.isLeaf())for(a=n.nodeIndices.length,s=0;a>s;s++)o=this.getQuadNode(n.nodeIndices[s]).aabb,o.testID!=this._testID&&(o.testID=this._testID,r.overlapTest(o)&&e.push(n.nodeIndices[s]));else for(s=0;s<t.QuadTreeCell.NUM_CHILDREN;s++)this._cellsToTest.push(n.childCellIndices[s]);return e.length},e.prototype.pointInTriangle=function(t,e,r,i,a){var n=r,o=i,s=a,l=n.z-o.z,h=o.x-n.x,u=n.x*o.z-o.x*n.z,c=o.z-s.z,d=s.x-o.x,p=o.x*s.z-s.x*o.z,f=s.z-n.z,m=n.x-s.x,_=s.x*n.z-n.x*s.z,v=!1,g=l*t+h*e+u,y=c*t+d*e+p,x=f*t+m*e+_,b=.01;return(g>=-b&&y>=-b&&x>=-b||b>=g&&b>=y&&b>=x)&&(v=!0),v},e.prototype.incrementTestCounter=function(){if(++this._testID,0==this._testID){for(var t=this._quadNodes.length,e=0;t>e;e++)this._quadNodes[e].aabb.testID=0;this._testID=1}},e.prototype.logTree=function(t){if(!(0>t)){this.logDeep++;for(var e=this._cells[t],r="",i=0;i<this.logDeep-1;i++)r+="-|";console.log(r+"i="+t+" "+e.aabb.minPosX.toFixed(2)+" "+e.aabb.maxPosX.toFixed(2)+" "+e.aabb.minPosY.toFixed(2)+" "+e.aabb.maxPosY.toFixed(2));var a;for(a=0;a<e.nodeIndices.length;a++)if(e.nodeIndices[a]>=0){var n=this._quadNodes[e.nodeIndices[a]];console.log(r+" t="+e.nodeIndices[a]+" "+n.aabb.minPosX.toFixed(2)+" "+n.aabb.maxPosX.toFixed(2)+" "+n.aabb.minPosY.toFixed(2)+" "+n.aabb.maxPosY.toFixed(2))}for(a=0;a<e.childCellIndices.length;a++)e.childCellIndices[a]>=0&&this.logTree(e.childCellIndices[a]);this.logDeep--}},e}();t.QuadTree=e,__reflect(e.prototype,"egret3d.QuadTree")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(r){this.childCellIndices=new Array,this.childCellIndices.length=e.NUM_CHILDREN,this.nodeIndices=new Array,this.clear(),r?this.aabb=r.clone():this.aabb=new t.QuadAABB}return e.prototype.isLeaf=function(){return-1==this.childCellIndices[0]},e.prototype.clear=function(){for(var t=0;t<e.NUM_CHILDREN;t++)this.childCellIndices[t]=-1;this.nodeIndices.splice(0,this.nodeIndices.length)},e}();e.NUM_CHILDREN=4,t.QuadTreeCell=e,__reflect(e.prototype,"egret3d.QuadTreeCell")}(egret3d||(egret3d={}));var egret3d;!function(t){function e(t,e){return e.drawOrder-t.drawOrder}function r(t,e){return e.zIndex-t.zIndex}var i;!function(t){t[t.Shadow=0]="Shadow",t[t.Pick=1]="Pick"}(i=t.SpecialCast||(t.SpecialCast={}));var a=function(){function a(){this.numberVertex=0,this.numberFace=0,this.numberDraw=0,this.numberSkin=0,this.numberAnimation=0,this.numberParticle=0,this.numberCastShadow=0,this.numberAcceptShadow=0,this.numberPick=0,this.softLayerRenderItems={},this.specialCastItem={};for(var e=0;e<t.Layer.layerType.length;e++)this.softLayerRenderItems[t.Layer.layerType[e]]=[];this.specialCastItem[i.Shadow]=[],this.specialCastItem[i.Pick]=[],this.renderList=new Array}return Object.defineProperty(a.prototype,"root",{get:function(){return this.rootScene},set:function(t){this.rootScene=t},enumerable:!0,configurable:!0}),a.prototype.applyRender=function(t,e){if(t.enablePick&&(this.specialCastItem[i.Pick].push(t),this.numberPick++),t.visible){this.addRenderItem(t,e);for(var r=0;r<t.childs.length;r++)this.applyRender(t.childs[r],e)}},a.prototype.appendQuadList=function(e,r){for(var i,a,n=0,o=e;n<o.length;n++)a=o[n],a instanceof t.Mesh&&(i=a,i&&i.visible&&i.material&&this.addRenderItem(i,r,!1))},a.prototype.addRenderItem=function(e,r,a){if(void 0===a&&(a=!0),(!a||r.isVisibleToCamera(e))&&e.material){if(e.material.castShadow&&(this.specialCastItem[i.Shadow].push(e),this.numberCastShadow++),e.material.acceptShadow&&this.numberAcceptShadow++,e.material.materialData.alphaBlending&&e.tag.name==t.Layer.TAG_NAME_NORMAL_OBJECT){r.object3DToScreenRay(e.position,t.Vector3D.HELP_0);e.zIndex=t.Vector3D.HELP_0.z,this.softLayerRenderItems[t.Layer.TAG_NAME_ALPHA_OBJECT].push(e)}else for(var n=0;n<t.Layer.layerType.length;n++)e.tag.name==t.Layer.layerType[n]&&this.softLayerRenderItems[t.Layer.layerType[n]].push(e);t.Egret3DEngine.instance.debug&&(this.numberFace+=e.geometry.faceCount,this.numberVertex+=e.geometry.vertexCount,this.numberDraw+=1,e.animation&&(this.numberSkin+=1),e.proAnimation&&(this.numberAnimation+=1),e.type==t.IRender.TYPE_PARTICLE_EMIT&&(this.numberParticle+=1))}},a.prototype.update=function(i){if(i.modelMatrix,this.clear(),t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("entityCollect applyRender",60),this.rootScene.quad){var a=i.frustum.box,n=this.rootScene.quad.getNodesByAABB(a.min.x,a.min.y,a.max.x,a.max.y);this.appendQuadList(n,i)}else this.applyRender(this.rootScene,i);t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.endCounter("entityCollect applyRender");var o,s,l;s=t.Layer.TAG_NAME_ALPHA_OBJECT,o=this.softLayerRenderItems[s],o&&o.length&&(l=o.length,o.sort(r));for(var h=0;h<t.Layer.layerType.length;h++)if(s=t.Layer.layerType[h],o=this.softLayerRenderItems[s]){l=o.length,o.sort(e);for(var u=0;l>u;u++)this.renderList.push(o[u])}},a.prototype.clear=function(){this.numberFace=0,this.numberVertex=0,this.numberDraw=0,this.numberSkin=0,this.numberAnimation=0,this.numberParticle=0,this.numberCastShadow=0,this.numberPick=0,this.numberAcceptShadow=0;for(var e=0;e<t.Layer.layerType.length;e++)this.softLayerRenderItems[t.Layer.layerType[e]].length=0;for(var r in this.specialCastItem)this.specialCastItem[r].length=0;this.renderList.length=0},a.prototype.findRenderObject=function(t){for(var e=0;e<this.renderList.length;++e)if(this.renderList[e]===t)return e;return-1},a}();t.EntityCollect=a,__reflect(a.prototype,"egret3d.EntityCollect")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this._vtxNum=8,this._planeNum=6,this.nearCenter=new t.Vector3D,this.farCenter=new t.Vector3D,this._tempVector=new t.Vector3D,this.camera=e,this._vertex=new Array;for(var r=0;r<this._vtxNum;++r)this._vertex.push(new t.Vector3D);this._tempVertices=new Array;for(var r=0;r<this._vtxNum;++r)this._tempVertices.push(new t.Vector3D);this._pos=new t.Vector3D,this._plane=new Array;for(var r=0;6>r;++r)this._plane.push(new t.Plane3D);this.box=new t.BoundBox(null,new t.Vector3D,new t.Vector3D),this.center=new t.Vector3D}return Object.defineProperty(e.prototype,"vertices",{get:function(){return this._vertex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wireframe",{get:function(){return this._frustum},enumerable:!0,configurable:!0}),e.prototype.initFrustum=function(){null==this._frustum&&(this._frustum=new t.Wireframe,this._frustum.material.diffuseColor=16777215,this._frustum.name="CameraFrustum",this._frustum.geometry.vertexCount=8,this._frustum.geometry.indexCount=24,this._frustum.geometry.setVertexIndices(0,[0,1,1,2,2,3,0,3,4,5,5,6,6,7,4,7,0,4,1,5,3,7,2,6]))},Object.defineProperty(e.prototype,"visible",{get:function(){return null==this._frustum?!1:this._frustum.parent?!0:!1},set:function(t){this.initFrustum(),t?this._frustum.parent?this._frustum.parent!=this.camera&&(this._frustum.parent.removeChild(this._frustum),this.camera.addChild(this._frustum)):this.camera.addChild(this._frustum):this._frustum.parent&&this._frustum.parent.removeChild(this._frustum)},enumerable:!0,configurable:!0}),e.prototype.makeFrustum=function(t,e,r,i){var a=Math.tan(t/2*(Math.PI/180)),n=r*a,o=n*e,s=i*a,l=s*e;this._vertex[0].x=o,this._vertex[0].y=n,this._vertex[0].z=r,this._vertex[1].x=-o,this._vertex[1].y=n,this._vertex[1].z=r,this._vertex[2].x=-o,this._vertex[2].y=-n,this._vertex[2].z=r,this._vertex[3].x=o,this._vertex[3].y=-n,this._vertex[3].z=r,this._vertex[4].x=l,this._vertex[4].y=s,this._vertex[4].z=i,this._vertex[5].x=-l,this._vertex[5].y=s,this._vertex[5].z=i,this._vertex[6].x=-l,this._vertex[6].y=-s,this._vertex[6].z=i,this._vertex[7].x=l,this._vertex[7].y=-s,this._vertex[7].z=i},e.prototype.makeOrthoFrustum=function(t,e,r,i){this._vertex[0].x=t/2,this._vertex[0].y=e/2,this._vertex[0].z=r,this._vertex[1].x=-t/2,this._vertex[1].y=e/2,this._vertex[1].z=r,this._vertex[2].x=-t/2,this._vertex[2].y=-e/2,this._vertex[2].z=r,this._vertex[3].x=t/2,this._vertex[3].y=-e/2,this._vertex[3].z=r,this._vertex[4].x=t/2,this._vertex[4].y=e/2,this._vertex[4].z=i,this._vertex[5].x=-t/2,this._vertex[5].y=e/2,this._vertex[5].z=i,this._vertex[6].x=-t/2,this._vertex[6].y=-e/2,this._vertex[6].z=i,this._vertex[7].x=t/2,this._vertex[7].y=-e/2,this._vertex[7].z=i},e.prototype.makeOrthoToCenterFrustum=function(t,e,r,i,a,n){this._vertex[0].x=e,this._vertex[0].y=i,this._vertex[0].z=a,this._vertex[1].x=t,this._vertex[1].y=i,this._vertex[1].z=a,this._vertex[2].x=t,this._vertex[2].y=r,this._vertex[2].z=a,this._vertex[3].x=e,this._vertex[3].y=r,this._vertex[3].z=a,this._vertex[4].x=e,this._vertex[4].y=i,this._vertex[4].z=n,this._vertex[5].x=t,this._vertex[5].y=i,this._vertex[5].z=n,this._vertex[6].x=t,this._vertex[6].y=r,this._vertex[6].z=n,this._vertex[7].x=e,this._vertex[7].y=r,this._vertex[7].z=n},e.prototype.updateFrustum=function(){switch(this.camera.cameraType){case t.CameraType.perspective:this.makeFrustum(this.camera.fieldOfView,this.camera.aspectRatio,this.camera.near,this.camera.far);break;case t.CameraType.orthogonal:this.makeOrthoFrustum(this.camera.viewPort.width,this.camera.viewPort.height,this.camera.near,this.camera.far);break;case t.CameraType.orthogonalToCenter:this.makeOrthoToCenterFrustum(this.camera.viewPort.x,this.camera.viewPort.y,this.camera.viewPort.width,this.camera.viewPort.height,this.camera.near,this.camera.far)}if(null!=this._frustum)for(var e=0;e<this.vertices.length;++e)this._frustum.geometry.setVerticesForIndex(e,t.VertexFormat.VF_POSITION,[this.vertices[e].x,this.vertices[e].y,this.vertices[e].z],1)},e.prototype.update=function(){var e=t.Matrix4_4.helpMatrix;e.copyFrom(this.camera.modelMatrix);for(var r=0;r<this._vtxNum;++r)e.transformVector(this._vertex[r],this._tempVertices[r]);this.box.max.x=this.box.max.y=this.box.max.z=-t.MathUtil.MAX_VALUE,this.box.min.x=this.box.min.y=this.box.min.z=t.MathUtil.MAX_VALUE;for(var r=0;r<this._tempVertices.length;++r)this.box.max.x<this._tempVertices[r].x&&(this.box.max.x=this._tempVertices[r].x),this.box.max.y<this._tempVertices[r].y&&(this.box.max.y=this._tempVertices[r].y),this.box.max.z<this._tempVertices[r].z&&(this.box.max.z=this._tempVertices[r].z),this.box.min.x>this._tempVertices[r].x&&(this.box.min.x=this._tempVertices[r].x),this.box.min.y>this._tempVertices[r].y&&(this.box.min.y=this._tempVertices[r].y),this.box.min.z>this._tempVertices[r].z&&(this.box.min.z=this._tempVertices[r].z);this.box.calculateBox(),this._plane[0].fromPoints(this._tempVertices[4],this._tempVertices[5],this._tempVertices[6]),this._plane[1].fromPoints(this._tempVertices[1],this._tempVertices[6],this._tempVertices[5]),this._plane[2].fromPoints(this._tempVertices[0],this._tempVertices[4],this._tempVertices[7]),this._plane[3].fromPoints(this._tempVertices[1],this._tempVertices[0],this._tempVertices[3]),this._plane[4].fromPoints(this._tempVertices[1],this._tempVertices[5],this._tempVertices[4]),this._plane[5].fromPoints(this._tempVertices[3],this._tempVertices[7],this._tempVertices[6]);for(var r=0;r<this._planeNum;r++)this._plane[r].normalize();this.nearCenter.copyFrom(this._tempVertices[0].subtract(this._tempVertices[2],t.MathUtil.CALCULATION_VECTOR3D_0)),this.nearCenter.scaleBy(.5),this.nearCenter.copyFrom(this._tempVertices[2].add(this.nearCenter,t.MathUtil.CALCULATION_VECTOR3D_1)),this.farCenter.copyFrom(this._tempVertices[4].subtract(this._tempVertices[6],t.MathUtil.CALCULATION_VECTOR3D_2)),this.farCenter.scaleBy(.5),this.farCenter.copyFrom(this._tempVertices[6].add(this.farCenter,t.MathUtil.CALCULATION_VECTOR3D_0)),this.center.copyFrom(this.farCenter.subtract(this.nearCenter,t.MathUtil.CALCULATION_VECTOR3D_1)),this.center.scaleBy(.5),this.center.copyFrom(this.nearCenter.add(this.center,t.MathUtil.CALCULATION_VECTOR3D_2))},e.prototype.inPoint=function(t){for(var e=0,r=0;r<this._plane.length;++r)if(e=this._plane[r].distance(t),e>0)return!1;return!0},e.prototype.inSphere=function(t,e){for(var r=0,i=0;i<this._plane.length;++i)if(r=this._plane[i].distance(t),r>e)return!1;return!0},e.prototype.inBox=function(t){for(var e=0,r=this._plane.length,i=0;r>i;++i){for(var a=t.vexData.length/3,n=t.vexData.length,o=0;n>o;o+=3)this._tempVector.setTo(t.vexData[o],t.vexData[o+1],t.vexData[o+2]),t.transform.transformVector(this._tempVector,this._tempVector),e=this._plane[i].distance(this._tempVector),e>0&&a--;if(0>=a)return!1}return!0},e.prototype.dispose=function(){null!=this._frustum&&this._frustum.dispose(),this._frustum=null},e}();t.Frustum=e,__reflect(e.prototype,"egret3d.Frustum")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.TAG_NAME_NORMAL_OBJECT="normalObject",e.TAG_NAME_NORMAL_ALPHA_OBJECT="normalAlphaObject",e.TAG_NAME_ALPHA_OBJECT="alphaObject",e.TAG_NAME_DECAL="decal",e.TAG_NAME_EFFECT="effect",e.TAG_NAME_GUI="gui",e.layerType=["normalObject","normalAlphaObject","alphaObject","decal","effect","gui"],e.layerTypeThan=[3,2,1,0],e.layerNumber=5,t.Layer=e,__reflect(e.prototype,"egret3d.Layer")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.createRayToView=function(r,i){if(void 0===i&&(i=null),i||(i=e.ray),t.Input.mouseX<r.x||t.Input.mouseX>a+r.width||t.Input.mouseY<r.y||t.Input.mouseY>n+r.height)return null;var a=t.Input.mouseX-r.x,n=t.Input.mouseY-r.y;return i.CalculateAndTransformRay(r.width,r.height,r.camera3D.modelMatrix,r.camera3D.projectMatrix,a,n),i},e.pickObject3D=function(t,r,i){void 0===i&&(i=null),i=i||[],i.length=0;var a=e.createRayToView(t);return e.pickObject(a,r,i),i},e.pickObject=function(t,r,i){void 0===i&&(i=null),e.doPickerObject(t,r)&&i.push(r);for(var a=0;a<r.childs.length;++a)e.pickObject(t,r.childs[a],i);return i},e.doPickerObject=function(e,r){var i;switch(r.pickType){case t.PickType.BoundPick:if(null!=r.bound){var a=r.currentBound;if(a&&e.IntersectBound(a,r.pickResult))return!0}return!1;case t.PickType.PositionPick:if(r instanceof t.IRender){i=r;var n=0;i.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(n+=t.Geometry.positionSize),i.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(n+=t.Geometry.normalSize),i.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(n+=t.Geometry.tangentSize),i.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(n+=t.Geometry.colorSize);var o=i.bound,s=[];if(e.IntersectSphere(o.center,o.radius,s,i.modelMatrix)&&e.IntersectMeshEx(i,n,i.pickResult))return!0}return!1;case t.PickType.UVPick:if(r instanceof t.IRender){i=r;var n=0;i.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(n+=t.Geometry.positionSize),i.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(n+=t.Geometry.normalSize),i.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(n+=t.Geometry.tangentSize),i.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(n+=t.Geometry.colorSize);var o=i.bound;if(e.IntersectSphere(o.center,o.radius,s,o.transform)&&e.IntersectMeshEx(i,n,i.pickResult))return!0}return!1}return!1},e.pickObject3DList=function(t,r,i){void 0===i&&(i=null),i||(i=new Array),i.length=0;for(var a=e.createRayToView(t),n=0;n<r.length;++n)e.doPickerObject(a,r[n])&&i.push(r[n]);return i},e}();e.ray=new t.Ray,t.Picker=e,__reflect(e.prototype,"egret3d.Picker")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.name="normalObject",this.clearDepth=!1}return t}();t.Tag=e,__reflect(e.prototype,"egret3d.Tag")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._keys=new Array,this._values=new Array}return t.prototype.getIndexByKey=function(t){return this._keys.indexOf(t)},t.prototype.getValueByKey=function(t){var e=this.getIndexByKey(t);return e>-1?this._values[e]:null},t.prototype.put=function(t,e){if(null==t)return null;var r=this.remove(t);return this._keys.push(t),this._values.push(e),r},t.prototype.remove=function(t){var e,r=this._keys.indexOf(t);return r>-1&&(e=this._values[r],this._keys.splice(r,1),this._values.splice(r,1)),e},t.prototype.getValues=function(){return this._values},t.prototype.getKeys=function(){return this._keys},t.prototype.clear=function(){this._values.length=0,this._keys.length=0},t}();t.DoubleArray=e,__reflect(e.prototype,"egret3d.DoubleArray")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.Event3D);e.CYCLE="cycle",e.COMPLETE="complete",t.AnimationEvent3D=e,__reflect(e.prototype,"egret3d.AnimationEvent3D")
}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.bacthingMesh=function(t){var r,i,a=t.nodeList,n=(t.matDict,e.collectStaticMesh(a)),o=[],s=[];for(var l in n)r=Number(l),o=n[r],s=s.concat(this.batching(r,this.checkMaxBacthing(r,o)));for(var l in n){o=n[l];for(var h in o)i=o[h].object3d,i.parent&&i.parent.removeChild(i)}return o.length=0,s},e.checkMaxBacthing=function(t,e){for(var r,i=1e4,a=[],n=0,o=0,s=0;s<e.length;s++){r=e[s].object3d.geometry;for(var l=0;l<r.subGeometrys.length;l++)e[s].materialIDs[l]==t&&(n+r.subGeometrys[l].count<i?(a[o]=a[o]||[],a[o].push(e[s]),n+=r.subGeometrys[l].count):(o++,n=0,a[o]=a[o]||[],a[o].push(e[s]),n+=r.subGeometrys[l].count))}return a},e.collectStaticMesh=function(t){for(var e,r,i={},a=0,n=0;n<t.length;n++)if("Mesh"==t[n].type&&"Batching"==t[n].staticType){e=t[n].object3d,a=e.geometry.subGeometrys.length;for(var o=0;a>o;o++)r=t[n].materialIDs[e.geometry.subGeometrys[o].matID],i[r]=i[r]||[],i[r].push(t[n])}return i},e.sortByZ=function(t,e){return t.z-e.z},e.batching=function(e,r){for(var i,a,n,o,s,l,h,u,c=this,d=t.Matrix4_4.helpMatrix,p=t.Matrix4_4.helpMatrix2,f=t.Vector3D.HELP_0,m=new t.Vector3D,_=0,v=0,g=0,y=0,x=[],b=0,D=0,T=0,P=t.Quaternion.HELP_0,S=0;S<r.length;S++){for(s=r[S],g=0,y=0,s=s.sort(function(t,e){return c.sortByZ(t,e)}),n=0;n<s.length;n++){i=s[n].object3d,a=i.geometry.vertexAttLength;for(var w=0;w<i.geometry.subGeometrys.length;w++)h=i.geometry.subGeometrys[w],s[n].materialIDs[w]==e&&(u=w,g+=h.count,y+=h.count)}var A=new t.Geometry;A.vertexFormat=s[0].object3d.geometry.vertexFormat,A.vertexCount=g,A.indexCount=y,A.buildDefaultSubGeometry();var C=A.vertexArray,L=A.indexArray;for(_=0,v=0,o=0;o<s.length;o++){i=s[o].object3d;var E=d.decompose()[1];P.x=E.x,P.y=E.y,P.z=E.z,P.w=E.w,d.makeTransform(i.globalPosition,i.globalScale,i.globalOrientation),p.makeTransform(new t.Vector3D,i.globalScale,i.globalOrientation),a=i.geometry.vertexAttLength;for(var M,z,w=0;w<i.geometry.subGeometrys.length;w++)if(h=i.geometry.subGeometrys[w],s[o].materialIDs[w]==e){u=w,M=i.geometry.vertexArray,z=i.geometry.indexArray;for(var n=0;n<h.count;++n){b=z[h.start+n],D=_+n,f.x=M[b*a],f.y=M[b*a+1],f.z=M[b*a+2],m.x=M[b*a+3],m.y=M[b*a+4],m.z=M[b*a+5],d.transformVector(f,t.Vector3D.HELP_1),p.transformVector(m,t.Vector3D.HELP_2),C[D*a+0]=t.Vector3D.HELP_1.x,C[D*a+1]=t.Vector3D.HELP_1.y,C[D*a+2]=t.Vector3D.HELP_1.z,C[D*a+3]=t.Vector3D.HELP_2.x,C[D*a+4]=t.Vector3D.HELP_2.y,C[D*a+5]=t.Vector3D.HELP_2.z;for(var F=6;a>F;++F)C[D*a+F]=M[b*a+F]}for(var n=0;n<h.count;++n)T=_+n,L[T]=T;_+=h.count,v+=h.count}}l=i.getMaterial(u),x.push(new t.Mesh(A,l))}return x},e}();t.StaticMergeUtil=e,__reflect(e.prototype,"egret3d.StaticMergeUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r,i){void 0===r&&(r=55),void 0===i&&(i=70),this.eyeCross=70,this.eyeRay=new t.Vector3D,this.dir=new t.Vector3D,this.mainCamera=e,this.leftCamera=new t.Camera3D,this.rightCamera=new t.Camera3D}return e.prototype.update=function(){this.mainCamera.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir),this.dir.normalize(),this.leftCamera.modelMatrix=this.mainCamera.modelMatrix,this.rightCamera.modelMatrix=this.mainCamera.modelMatrix;var e=.5*this.eyeCross;this.leftCamera.x+=-this.dir.x*e,this.leftCamera.y+=-this.dir.y*e,this.leftCamera.z+=-this.dir.z*e,this.rightCamera.x+=this.dir.x*e,this.rightCamera.y+=this.dir.y*e,this.rightCamera.z+=this.dir.z*e},e}();t.EyesCamera=e,__reflect(e.prototype,"egret3d.EyesCamera");var r=function(r){function i(e,i,a,n){var o=r.call(this,e,i,a,n,new t.Camera3D(t.CameraType.perspective))||this;return o.w=0,o.h=0,o.w=a,o.h=n,o.init(),o}return __extends(i,r),i.prototype.init=function(){this.eyesCamera=new e(this.camera3D)},i.prototype.update=function(t,e){this.eyesCamera.update(),this.viewPort.width=.5*this.w,this.viewPort.height=this.h,this.viewPort.x=.5*this.w-this.viewPort.width-10,this.viewPort.y=.5*this.h-.5*this.viewPort.height,this.camera3D=this.eyesCamera.leftCamera,r.prototype.update.call(this,t,e),this.viewPort.width=.5*this.w,this.viewPort.height=this.h,this.viewPort.x=.5*this.w+10,this.viewPort.y=.5*this.h-.5*this.viewPort.height,this.camera3D=this.eyesCamera.rightCamera,r.prototype.update.call(this,t,e)},i}(t.View3D);t.VRView3D=r,__reflect(r.prototype,"egret3d.VRView3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this._retRenderList=new Array,this._ray=new t.Ray,this._canvas=e,this._pickEvent3d=new t.PickEvent3D,t.Input.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.onMouseClick,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.onMouseDown,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.onMouseWheel,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.onTouchDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.onTouchUp,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.onTouchMove,this)}return Object.defineProperty(e.prototype,"_view3ds",{get:function(){return this._canvas.view3Ds},enumerable:!0,configurable:!0}),e.prototype.onClear=function(){this._canvas=null},e.prototype.onClearListeners=function(){},e.prototype.sendEvent=function(e,r,i){var a=this._canvas;if(a)for(var n=0;n<this._view3ds.length;n++){var o=this._view3ds[n],s=o.entityCollect.specialCastItem[t.SpecialCast.Pick];if(o.entityCollect&&s){var l=null,h=null;this._retRenderList.length=0;for(var u=this._retRenderList,c=0;c<s.length;++c)l=s[c],(l.containEventListener(e.eventType)||l.containEventListener(r))&&(h||(h=t.Picker.createRayToView(o,this._ray)),t.Picker.doPickerObject(this._ray,l)&&u.push(l));var d=u.length;if(!(0>=d)){for(var p=null,f=t.MathUtil.MAX_VALUE,m=0,c=0;d>c;c++)l=u[c],m=t.Vector3D.distance(l.globalPosition,o.camera3D.globalPosition),f>m&&(f=m,p=l);p&&(p.dispatchEvent(e),p.dispatchEvent(i.call(this,r,e,p)))}}}},e.prototype.initPickEvent3D=function(t,e,r){return this._pickEvent3d.eventType=t,this._pickEvent3d.data=e,this._pickEvent3d.pickResult=r.pickResult,this._pickEvent3d},e.prototype.clearEvent=function(){this._pickEvent3d.target=null,this._pickEvent3d.data=null,this._pickEvent3d.pickResult=null,this._pickEvent3d.targetEvent=null},e.prototype.onTouchMove=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D),this.clearEvent()},e.prototype.onTouchUp=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D),this.clearEvent()},e.prototype.onTouchDown=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D),this.clearEvent()},e.prototype.onMouseClick=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_CLICK,this.initPickEvent3D),this.clearEvent()},e.prototype.onMouseDown=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D),this.clearEvent()},e.prototype.onMouseUp=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D),this.clearEvent()},e.prototype.onMouseMove=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D),this.clearEvent()},e.prototype.onMouseWheel=function(e){this._pickEvent3d.targetEvent=e,this.sendEvent(e,t.PickEvent3D.PICK_WHEEL,this.initPickEvent3D),this.clearEvent()},e}();t.EventManager=e,__reflect(e.prototype,"egret3d.EventManager")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.Key_BackSpace=8]="Key_BackSpace",t[t.Key_Tab=9]="Key_Tab",t[t.Key_Clear=12]="Key_Clear",t[t.Key_Enter=13]="Key_Enter",t[t.Key_Shift_L=16]="Key_Shift_L",t[t.Key_Control_L=17]="Key_Control_L",t[t.Key_Alt_L=18]="Key_Alt_L",t[t.Key_Pause=19]="Key_Pause",t[t.Key_CapsLock=20]="Key_CapsLock",t[t.Key_Escape=21]="Key_Escape",t[t.Key_Space=32]="Key_Space",t[t.Key_Prior=33]="Key_Prior",t[t.Key_Next=34]="Key_Next",t[t.Key_End=35]="Key_End",t[t.Key_Home=36]="Key_Home",t[t.Key_Left=37]="Key_Left",t[t.Key_Up=38]="Key_Up",t[t.Key_Right=39]="Key_Right",t[t.Key_Down=40]="Key_Down",t[t.Key_Select=41]="Key_Select",t[t.Key_Print=42]="Key_Print",t[t.Key_Execute=43]="Key_Execute",t[t.Key_Insert=45]="Key_Insert",t[t.Key_Delete=46]="Key_Delete",t[t.Key_Help=47]="Key_Help",t[t.Key_0=48]="Key_0",t[t.Key_1=49]="Key_1",t[t.Key_2=50]="Key_2",t[t.Key_3=51]="Key_3",t[t.Key_4=52]="Key_4",t[t.Key_5=53]="Key_5",t[t.Key_6=54]="Key_6",t[t.Key_7=55]="Key_7",t[t.Key_8=56]="Key_8",t[t.Key_9=57]="Key_9",t[t.Key_A=65]="Key_A",t[t.Key_B=66]="Key_B",t[t.Key_C=67]="Key_C",t[t.Key_D=68]="Key_D",t[t.Key_E=69]="Key_E",t[t.Key_F=70]="Key_F",t[t.Key_G=71]="Key_G",t[t.Key_H=72]="Key_H",t[t.Key_I=73]="Key_I",t[t.Key_J=74]="Key_J",t[t.Key_K=75]="Key_K",t[t.Key_L=76]="Key_L",t[t.Key_M=77]="Key_M",t[t.Key_N=78]="Key_N",t[t.Key_O=79]="Key_O",t[t.Key_P=80]="Key_P",t[t.Key_Q=81]="Key_Q",t[t.Key_R=82]="Key_R",t[t.Key_S=83]="Key_S",t[t.Key_T=84]="Key_T",t[t.Key_U=85]="Key_U",t[t.Key_V=86]="Key_V",t[t.Key_W=87]="Key_W",t[t.Key_X=88]="Key_X",t[t.Key_Y=89]="Key_Y",t[t.Key_Z=90]="Key_Z",t[t.Key_KP_0=96]="Key_KP_0",t[t.Key_KP_1=97]="Key_KP_1",t[t.Key_KP_2=98]="Key_KP_2",t[t.Key_KP_3=99]="Key_KP_3",t[t.Key_KP_4=100]="Key_KP_4",t[t.Key_KP_5=101]="Key_KP_5",t[t.Key_KP_6=102]="Key_KP_6",t[t.Key_KP_7=103]="Key_KP_7",t[t.Key_KP_8=104]="Key_KP_8",t[t.Key_KP_9=105]="Key_KP_9",t[t.Key_Multiply=106]="Key_Multiply",t[t.Key_Add=107]="Key_Add",t[t.Key_Separator=108]="Key_Separator",t[t.Key_Subtract=109]="Key_Subtract",t[t.Key_Decimal=110]="Key_Decimal",t[t.Key_Divide=111]="Key_Divide",t[t.Key_F1=112]="Key_F1",t[t.Key_F2=113]="Key_F2",t[t.Key_F3=114]="Key_F3",t[t.Key_F4=115]="Key_F4",t[t.Key_F5=116]="Key_F5",t[t.Key_F6=117]="Key_F6",t[t.Key_F7=118]="Key_F7",t[t.Key_F8=119]="Key_F8",t[t.Key_F9=120]="Key_F9",t[t.Key_F10=121]="Key_F10",t[t.Key_F11=122]="Key_F11",t[t.Key_F12=123]="Key_F12",t[t.Key_F13=124]="Key_F13",t[t.Key_F14=125]="Key_F14",t[t.Key_F15=126]="Key_F15",t[t.Key_F16=127]="Key_F16",t[t.Key_F17=128]="Key_F17",t[t.Key_F18=129]="Key_F18",t[t.Key_F19=130]="Key_F19",t[t.Key_F20=131]="Key_F20",t[t.Key_F21=132]="Key_F21",t[t.Key_F22=133]="Key_F22",t[t.Key_F23=134]="Key_F23",t[t.Key_F24=135]="Key_F24",t[t.Key_Num_Lock=136]="Key_Num_Lock",t[t.Key_Scroll_Lock=137]="Key_Scroll_Lock"}(e=t.KeyCode||(t.KeyCode={}));var r=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.keyCode=0,e}return __extends(e,t),e}(t.Event3D);r.KEY_DOWN="onKeyDown",r.KEY_UP="onKeyUp",t.KeyEvent3D=r,__reflect(r.prototype,"egret3d.KeyEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parseContent=function(t){for(var e=new Array,r="",i=";",a=-1,n=0;n<t.length;++n)if("{"==t.charAt(n)&&(a=r.indexOf("="),0>a&&(i="}")),(""!=r||" "!=t.charAt(n)&&"    "!=t.charAt(n)&&"	"!=t.charAt(n))&&(r+=t.charAt(n),"\n"!=i&&(r.indexOf("#extension")>=0?i="\n":r.indexOf("#define")>=0&&(i="\n")),i==t.charAt(n))){if("}"==i){for(var o=0,s=0,l=0;l<r.length;++l)"{"==r.charAt(l)?o++:"}"==r.charAt(l)&&s++;if(o!=s)continue;if(r.indexOf("struct")>=0){i=";";continue}}r.length>0&&e.push(r),r="",i=";"}return e},e.parseLines=function(t){for(var e=new Array,r="",i=!1,a=0;a<t.length;++a)if(i){if(";"==t.charAt(a)){i=!1,r.length>0&&(e.push(r),r="");break}r+=t.charAt(a)}else if(" "!=t.charAt(a)&&"	"!=t.charAt(a)&&","!=t.charAt(a)&&"\r"!=t.charAt(a)&&"\n"!=t.charAt(a)&&":"!=t.charAt(a)){if(";"==t.charAt(a)){r.length>0&&(e.push(r),r="");break}if("="==t.charAt(a)){r.length>0&&(e.push(r),r=""),e.push("="),i=!0;continue}r+=t.charAt(a),a==t.length-1&&""!=t&&(e.push(r),r="")}else""!=r&&(e.push(r),r="");return e},e.hasString=function(t,e){for(var r=0;r<t.length;++r)if(t[r]==e)return r;return-1},e.getVarName=function(t){var e=this.hasString(t,"=");if(e>=0){if(e-=1,e>=0&&e<t.length)return t[e]}else if(e=t.length-1,e>=0&&e<t.length)return t[e];return""},e.getVarValue=function(t){var e=this.hasString(t,"=");return e>=0&&(e+=1,e>=0&&e<t.length)?t[e]:""},e.getVarType=function(t){var e=this.hasString(t,"=");if(e>=0){if(e-=2,e>=0&&e<t.length)return t[e]}else if(e=t.length-2,e>=0&&e<t.length)return t[e];return""},e.getVarKey=function(t){var e=this.hasString(t,"=");return e>=0?(e-=3,e>=0&&e<t.length?t[e]:""):(e=t.length-3,e>=0&&e<t.length?t[e]:t[0])},e.processShaderFile=function(t){var e=["\n","\r"];e=[];for(var r=t,i=r;;){var a=r.indexOf("//");if(0>a)break;var n=r.indexOf("\r\n",a);-1==n&&(n=r.indexOf("\n",a));var o=r.slice(a,n);if(r=r.replace(o,""),r==i)break;i=r}for(var s=0;s<e.length;++s)for(;;){if(i=r.replace(e[s],""),r==i)break;r=i}return r},e.colorRgb=function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,r=t.toLowerCase();if(r&&e.test(r)){if(4===r.length){for(var i="#",a=1;4>a;a+=1)i+=r.slice(a,a+1).concat(r.slice(a,a+1));r=i}for(var n=[],a=1;7>a;a+=2)n.push(parseInt("0x"+r.slice(a,a+2)));return"RGB("+n.join(",")+")"}return r},e.getLineType=function(t){var e=t.indexOf("{");if(e>0){var r=t.substr(0,e);if(r.indexOf("struct")>=0){var i=r.lastIndexOf(" ");i++;var a=r.substr(i,r.length-i);return"struct "+a}if(r.indexOf("=")<0){var n=t.indexOf("("),i=t.lastIndexOf(" ",n);i++;var o=t.substr(i,n-i);return"function "+o}}return"unknown"},e.processStruct=function(t,r,i){var a=r.lastIndexOf("}");a++;for(var n=r.lastIndexOf(";"),o=r.substr(a,n-a),s=e.parseLines(o),l=0;l<s.length;++l){var h=e.getTemper(t+" "+s[l]+";");h&&i.addVar(h)}},e.getAttribute=function(r){var i,a,n,o=r,s=e.parseLines(o);return i=e.getVarName(s),a=e.getVarType(s),n=new t.GLSL.Attribute(i,a),n.value=e.getVarValue(s),n},e.getTemper=function(r){var i,a,n,o=r,s=e.parseLines(o);return i=e.getVarName(s),a=e.getVarType(s),n=new t.GLSL.TmpVar(i,a),n.value=e.getVarValue(s),n},e.getVarying=function(r){var i,a,n,o=r,s=e.parseLines(o);return i=e.getVarName(s),a=e.getVarType(s),n=new t.GLSL.Varying(i,a)},e.getUniform=function(r){var i,a,n,o=r,s=e.parseLines(o);return i=e.getVarName(s),a=e.getVarType(s),n=new t.GLSL.Uniform(i,a)},e.getConst=function(r){var i,a,n,o,s=r,l=e.parseLines(s);return i=e.getVarName(l),a=e.getVarType(l),n=e.getVarValue(l),o=new t.GLSL.ConstVar(i,a,n)},e.getExtension=function(r){var i=r.indexOf("#"),a=r.indexOf(" "),n=(r.substr(i,a),r.indexOf(":")),o=r.substr(a,n-a);o=e.replaceCharacter(o,[" "],""),n+=1;var s=r.substr(n,r.length-n);s=e.replaceCharacter(s,[" ",":","\n","\r"],"");var l=new t.GLSL.Extension(o);return l.value=s,l},e.getDefine=function(r){var i,a=r,n="",o="",s=e.parseLines(a);return n=s[1],s.length>=3&&(o=s[2]),i=new t.GLSL.DefineVar(n,o)},e.getSampler2D=function(r){var i,a,n=r,o=e.parseLines(n);return i=e.getVarName(o),a=new t.GLSL.Sampler2D(i)},e.getSampler3D=function(r){var i,a,n=r,o=e.parseLines(n);return i=e.getVarName(o),a=new t.GLSL.Sampler3D(i)},e.filterCharacter=function(t){for(var r=t,i=r,a=0;a<e._filterChar.length;++a)for(;;){if(i=r.replace(e._filterChar[a],""),r==i)break;r=i}return i},e.replaceCharacter=function(t,e,r){for(var i=t,a=!1;!a;){a=!0;for(var n=0;n<e.length;++n)if(i.indexOf(e[n])>=0){a=!1;break}for(var n=0;n<e.length;++n)i=i.replace(e[n],r)}return i},e.getURLName=function(t){var e=t.split(".");return e=e[0].split("/"),e[e.length-1]},e.getFileFormat=function(t){var e=t.lastIndexOf(".");e++;var r=(t.lastIndexOf("/"),t.substr(e,t.length-e));return r=r.toLowerCase()},e.getPath=function(t){var e=t.lastIndexOf("/");return e++,t.substr(0,e)},e.ab2str=function(t,e){void 0===e&&(e=65535);for(var r="",i=t.position,a=e;t.position<t.length;)a=e,t.length-t.position<a&&(a=t.length-t.position),r+=t.readUTFBytes(a);return t.position=i,r},e.str2ab=function(e){var r=new t.ByteArray;return r.writeUTFBytes(e),r},e}();e._filterChar=[" ","  ",";","\n","\r","	","\n","\r","	"],t.StringUtil=e,__reflect(e.prototype,"egret3d.StringUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.Mouse_Left=0]="Mouse_Left",t[t.Mouse_Mid=1]="Mouse_Mid",t[t.Mouse_Right=2]="Mouse_Right"}(e=t.MouseCode||(t.MouseCode={}));var r=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.mouseCode=0,e}return __extends(e,t),e}(t.Event3D);r.MOUSE_CLICK="onMouseClick",r.MOUSE_DOWN="onMouseDown",r.MOUSE_UP="onMouseUp",r.MOUSE_MOVE="onMouseMove",r.MOUSE_OVER="onMouseOver",r.MOUSE_OUT="onMouseOut",r.MOUSE_WHEEL="onMouseWheel",t.MouseEvent3D=r,__reflect(r.prototype,"egret3d.MouseEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.Portrait_Primary=0]="Portrait_Primary",t[t.Portrait_Secondary=180]="Portrait_Secondary",t[t.Landscape_Primary=-90]="Landscape_Primary",t[t.Landscape_Secondary=90]="Landscape_Secondary"}(e=t.Orientation||(t.Orientation={}));var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),Object.defineProperty(e.prototype,"orientation",{get:function(){var t=window.orientation;return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"acceleration",{get:function(){return this._acceleration},set:function(t){this._acceleration=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accelerationIncludingGravity",{get:function(){return this._accelerationIncludingGravity},set:function(t){this._accelerationIncludingGravity=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationRate",{get:function(){return this._rotationRate},set:function(t){this._rotationRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"absolute",{get:function(){return this._absolute},set:function(t){this._absolute=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"beta",{get:function(){return this._beta},set:function(t){this._beta=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gamma",{get:function(){return this._gamma},set:function(t){this._gamma=t},enumerable:!0,configurable:!0}),e}(t.Event3D);r.ORIENTATION_CHANGE="onOrientationChange",r.DEVICE_MOTION="onDeviceMotion",r.DEVICE_ORIENTATION="onDeviceOrientation",t.OrientationEvent3D=r,__reflect(r.prototype,"egret3d.OrientationEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.Event3D);e.PARSER_COMPLETE="onParserComplete",t.ParserEvent3D=e,__reflect(e.prototype,"egret3d.ParserEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.Event3D);e.PICK_CLICK="onPickClick",e.PICK_DOWN="onPickDown",e.PICK_UP="onPickUp",e.PICK_MOVE="onPickMove",e.PICK_WHEEL="onPickWheel",t.PickEvent3D=e,__reflect(e.prototype,"egret3d.PickEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.localPosition=new t.Vector3D,this.globalPosition=new t.Vector3D,this.uv=new t.Vector3D}return e}();t.PickResult=e,__reflect(e.prototype,"egret3d.PickResult")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(t.Event3D);e.TOUCH_MOVE="onTouchMove",e.TOUCH_START="onTouchStart",e.TOUCH_END="onTouchEnd",t.TouchEvent3D=e,__reflect(e.prototype,"egret3d.TouchEvent3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.prototype.calcLineX=function(e,r){for(var i,a,n=0,o=e.length-1;o>n&&(i=e[n],a=e[n+1],!(i.x<=r&&a.x>=r));n++);return t.MathUtil.mix(i.y,a.y,(r-i.x)/(r-a.x))},e.prototype.calcBezierY=function(t,e,r){for(var i,a,n,o,s=0;3>s;s++)if(r>=t[s].x&&r<=t[s+1].x){i=t[s],a=e[s],n=t[s+1],o=e[s+1];break}return i||(i=t[t.length-1]),a||(a=e[e.length-1]),n=n||i,o=o||a,r=(r-i.x)/(n.x-i.x),this.cubic_bezier(i.y,a.y,o.y,n.y,r)},e.prototype.calcBezierX=function(t,e,r){for(var i,a,n,o,s=0;3>s;s++)if(r>=t[s].x&&r<=t[s+1].x){i=t[s],a=e[s],n=t[s+1],o=e[s+1];break}return r=(r-i.x)/(n.x-i.x),this.cubic_bezier(i.x,a.x,o.x,n.x,r)},e.prototype.cubic_bezier=function(e,r,i,a,n){return e=t.MathUtil.mix(e,r,n),r=t.MathUtil.mix(r,i,n),i=t.MathUtil.mix(i,a,n),e=t.MathUtil.mix(e,r,n),r=t.MathUtil.mix(r,i,n),e=t.MathUtil.mix(e,r,n)},e}();t.BezierCurve=e,__reflect(e.prototype,"egret3d.BezierCurve");var r=function(){function e(){this.posPoints=[],this.ctrlPoints=[],this.lineMode=!1,this.linePoints=[]}return e.prototype.calc=function(t){var r;return r=this.lineMode?e.calc.calcLineX(this.linePoints,t):e.calc.calcBezierY(this.posPoints,this.ctrlPoints,t)},e.prototype.trySampler=function(){var t;if(this.lineMode){for(var e=0,r=this.linePoints.length;r>e;e++)if(0!=this.linePoints[e].y){t=!0;break}}else for(var e=0,r=this.posPoints.length;r>e;e++)if(0!=this.posPoints[e].y||0!=this.ctrlPoints[e].y){t=!0;break}return t?this.sampler():null},e.prototype.sampler=function(){return this.lineMode?this.samplerLine():this.samplerBezier()},e.prototype.samplerLine=function(){var t=8,e=new Float32Array(1+2*(2*t+1));e[e.length-1]=this.linePoints.length;for(var r=0,i=this.linePoints.length;i>r;r++)e[2*r]=this.linePoints[r].x,e[2*r+1]=this.linePoints[r].y;return e},e.prototype.samplerBezier=function(){var t,r,i,a,n=8,o=new Float32Array(1+2*(2*n+1)),s=0,l=0;for(o[l]=s,l++,o[l]=this.posPoints[0].y,l++,r=0,a=e.SegCount;a>r;r++)for(t=this.posPoints[2*r+1].x-this.posPoints[2*r].x,t/=n,i=0;n>i;i++)s+=t,s>1&&(s=1),o[l]=s,l++,o[l]=this.calc(s),l++;return o[l]=2*n+1,l++,o},e.prototype.validate=function(){var r=0,i=0;if(this.lineMode)for(null==this.linePoints&&(this.linePoints=[]),r=this.linePoints.length,i=17;i>r;r++)this.linePoints.push(new t.Point(1,0));else{for(null==this.posPoints&&(this.posPoints=[]),null==this.ctrlPoints&&(this.ctrlPoints=[]),r=this.posPoints.length/2,i=e.SegCount;i>r;r++)this.posPoints.push(new t.Point(0,0)),this.posPoints.push(new t.Point(1,0));for(r=this.ctrlPoints.length/2,i=e.SegCount;i>r;r++)this.ctrlPoints.push(new t.Point(0,0)),this.ctrlPoints.push(new t.Point(1,0));this.ctrlPoints.length=2*e.SegCount,this.posPoints.length=2*e.SegCount}},e}();r.SegCount=2,r.calc=new e,t.BezierData=r,__reflect(r.prototype,"egret3d.BezierData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.nodes=new Array,this._vertexAttributes={},this.nodes=new Array}return t.prototype.addNode=function(t){this.nodes.push(t)},t.prototype.removeNode=function(t){var e=this.nodes.indexOf(t);-1!=e&&this.nodes.splice(e,1)},t.prototype.getNodes=function(){return this.nodes},t.prototype.calculate=function(t){for(var e=t,r=0;r<this.nodes.length;r++)for(var i=0;i<this.nodes[r].attributes.length;++i)this.nodes[r].attributes[i].size>0&&(this.nodes[r].attributes[i].offset=e,this.nodes[r].attributes[i].stride=e*Float32Array.BYTES_PER_ELEMENT,e+=this.nodes[r].attributes[i].size);this.numberOfVertices=e,this.vertexSizeInBytes=e*Float32Array.BYTES_PER_ELEMENT},t}();t.AnimaNodeCollection=e,__reflect(e.prototype,"egret3d.AnimaNodeCollection")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=null);var n=e.call(this,r)||this;return n.min=new t.Vector3D,n.max=new t.Vector3D,n.width=0,n.heigth=0,n.depth=0,n.volume=0,n.center=new t.Vector3D,n.radius=0,i||(i=new t.Vector3D),a||(a=new t.Vector3D),n.min.copyFrom(i),n.max.copyFrom(a),n.calculateBox(),n}return __extends(r,e),r.prototype.copyFrom=function(t){this.min.copyFrom(t.min),this.max.copyFrom(t.max),this.calculateBox()},r.prototype.fillBox=function(t,e){this.min.copyFrom(t),this.max.copyFrom(e),this.calculateBox()},r.prototype.pointIntersect=function(t){return t.x<=this.max.x&&t.x>=this.min.x&&t.y<=this.max.y&&t.y>=this.min.y&&t.z<=this.max.z&&t.z>=this.min.z?!0:!1},r.prototype.intersectAABBs=function(t,e){return void 0===e&&(e=null),this.min.x>t.max.x?!1:this.max.x<t.min.x?!1:this.min.y>t.max.y?!1:this.max.y<t.min.y?!1:this.min.z>t.max.z?!1:this.max.z<t.min.z?!1:(null!=e&&(e.min.x=Math.max(this.min.x,t.min.x),e.max.x=Math.min(this.max.x,t.max.x),e.min.y=Math.max(this.min.y,t.min.y),e.max.y=Math.min(this.max.y,t.max.y),e.min.z=Math.max(this.min.z,t.min.z),e.max.z=Math.min(this.max.z,t.max.z),e.calculateBox()),!0)},r.prototype.intersect=function(t,e){return void 0===e&&(e=null),this._box0?(this._box0.copyVertex(this),this._box0.owner=this.owner):this._box0=this.clone(),this._box0.calculateTransform(),this._box0.updateAABB(),this._box1?(this._box1.copyVertex(this),this._box1.owner=t.owner):this._box1=t.clone(),this._box1.calculateTransform(),this._box1.updateAABB(),this._box0.intersectAABBs(this._box1,e)},r.prototype.toString=function(){return"BoundBox [min:("+this.min.x+", "+this.min.y+", "+this.min.z+") max:("+this.max.x+", "+this.max.y+", "+this.max.z+")]"},r.prototype.calculateBox=function(){var e=this.max.subtract(this.min,t.MathUtil.CALCULATION_VECTOR3D_0);this.vexData=this.vexData||new Float32Array(24),this.indexData=this.indexData||new Uint16Array(36),this.vexData[0]=this.min.x,this.vexData[1]=this.min.y,this.vexData[2]=this.min.z,this.vexData[3]=this.min.x,this.vexData[4]=this.min.y,this.vexData[5]=this.min.z+e.z,this.vexData[6]=this.min.x+e.x,this.vexData[7]=this.min.y,this.vexData[8]=this.min.z+e.z,this.vexData[9]=this.min.x+e.x,this.vexData[10]=this.min.y,this.vexData[11]=this.min.z,this.vexData[12]=this.max.x-e.x,this.vexData[13]=this.max.y,this.vexData[14]=this.max.z-e.z,this.vexData[15]=this.max.x-e.x,this.vexData[16]=this.max.y,this.vexData[17]=this.max.z,this.vexData[18]=this.max.x,this.vexData[19]=this.max.y,this.vexData[20]=this.max.z,this.vexData[21]=this.max.x,this.vexData[22]=this.max.y,this.vexData[23]=this.max.z-e.z,this.indexData[0]=0,this.indexData[1]=4,this.indexData[2]=7,this.indexData[3]=0,this.indexData[4]=7,this.indexData[5]=3,this.indexData[6]=2,this.indexData[7]=6,this.indexData[8]=5,this.indexData[9]=2,this.indexData[10]=5,this.indexData[11]=1,this.indexData[12]=4,this.indexData[13]=5,this.indexData[14]=6,this.indexData[15]=4,this.indexData[16]=6,this.indexData[17]=7,this.indexData[18]=0,this.indexData[19]=3,this.indexData[20]=2,this.indexData[21]=0,this.indexData[22]=2,this.indexData[23]=1,this.indexData[24]=0,this.indexData[25]=1,this.indexData[26]=5,this.indexData[27]=0,this.indexData[28]=5,this.indexData[29]=4,this.indexData[30]=3,this.indexData[31]=7,this.indexData[32]=6,this.indexData[33]=3,this.indexData[34]=6,this.indexData[35]=2,this.width=this.max.x-this.min.x,this.heigth=this.max.y-this.min.y,this.depth=this.max.z-this.min.z,this.volume=this.width*this.heigth*this.depth;var r=this.max.subtract(this.min,t.MathUtil.CALCULATION_VECTOR3D_1);r.scaleBy(.5),this.radius=r.length,this.center.copyFrom(this.min);var i=this.center.add(r,t.MathUtil.CALCULATION_VECTOR3D_2);if(this.center.copyFrom(i),null!=this._bound)for(var a=0;8>a;++a)this._bound.geometry.setVerticesForIndex(a,t.VertexFormat.VF_POSITION,[this.vexData[3*a+0],this.vexData[3*a+1],this.vexData[3*a+2]],1)},Object.defineProperty(r.prototype,"visible",{set:function(e){null==this._bound&&this.initBound();for(var r=0;8>r;++r)this._bound.geometry.setVerticesForIndex(r,t.VertexFormat.VF_POSITION,[this.vexData[3*r+0],this.vexData[3*r+1],this.vexData[3*r+2]],1);e?this._bound.parent?this._bound.parent!=this.owner&&(this._bound.parent.removeChild(this._bound),this.owner.addChild(this._bound)):this.owner.addChild(this._bound):this._bound.parent&&this._bound.parent.removeChild(this._bound)},enumerable:!0,configurable:!0}),r.prototype.inBound=function(e){this.transform.transformVector(this.center,t.MathUtil.CALCULATION_VECTOR3D);var r=this.transform.getMaxScaleOnAxis()*this.radius;return e.inSphere(t.MathUtil.CALCULATION_VECTOR3D,r)},r.prototype.updateAABB=function(){this.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE)),this.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var e=0;e<this.vexData.length;e+=this.vexLength)this.max.x<this.vexData[e]&&(this.max.x=this.vexData[e]),this.max.y<this.vexData[e+1]&&(this.max.y=this.vexData[e+1]),this.max.z<this.vexData[e+2]&&(this.max.z=this.vexData[e+2]),this.min.x>this.vexData[e]&&(this.min.x=this.vexData[e]),this.min.y>this.vexData[e+1]&&(this.min.y=this.vexData[e+1]),this.min.z>this.vexData[e+2]&&(this.min.z=this.vexData[e+2])},r.prototype.createChild=function(){this.childBound=new r(this.owner);var e=new t.Vector3D,i=new t.Vector3D;e.x=this.center.x+this.width/4,e.y=this.center.y+this.heigth/4,e.z=this.center.z+this.depth/4,i.x=this.center.x-this.width/4,i.y=this.center.y-this.heigth/4,i.z=this.center.z-this.depth/4,this.childBound.fillBox(i,e)},r.prototype.clone=function(){var t=new r(this.owner,this.min,this.max);return t},r}(t.Bound);t.BoundBox=e,__reflect(e.prototype,"egret3d.BoundBox")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.AnimationCurve=e,__reflect(e.prototype,"egret3d.AnimationCurve")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.colors=[],this.times=[]}return e.prototype.lerpColor=function(e,r){void 0===r&&(r=null),0>e?e=0:e>1&&(e=1),null==r&&(r=new t.Color);for(var i=0,a=this.times.length-1;a>i;i++)if(e>=this.times[i]&&e<this.times[i+1]){e=(e-this.times[i])/(this.times[i+1]-this.times[i]),r.lerp(this.colors[i],this.colors[i+1],e);break}return r},e}();t.ColorGradients=e,__reflect(e.prototype,"egret3d.ColorGradients")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.m44=new t.Matrix4_4,this.alpha=1}return e.prototype.scale=function(t,e,r,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===r&&(r=1),void 0===i&&(i=1),this.m44.appendScale(t,e,r),this.alpha*=i},e.prototype.offset=function(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.m44.appendTranslation(t,e,r),this.alpha+=i},e.prototype.gray=function(){var t=new Float32Array(16);t[0]=.2126,t[1]=.7152,t[2]=.0722,t[3]=1,t[4]=.2126,t[5]=.7152,t[6]=.0722,t[7]=1,t[8]=.2126,t[9]=.7152,t[10]=.0722,t[11]=1,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this.m44.copyRawDataFrom(t)},e.prototype.reset=function(){this.m44.identity(),this.alpha=1},e.prototype.multiply=function(t){this.m44.multiply(t.m44),this.alpha*=t.alpha},e.prototype.copyFrom=function(t){this.m44.copyFrom(t.m44),this.alpha=t.alpha},e.prototype.copyTo=function(t){t.copyFrom(this)},e.prototype.setColorRGB=function(t){var e=16711680&t;e>>=16;var r=65280&t;r>>=8;var i=255&t;e/=255,r/=255,i/=255,this.m44.identity(),this.scale(e,r,i,1)},e}();t.ColorTransform=e,__reflect(e.prototype,"egret3d.ColorTransform")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.FloatEqual=function(t,e){return Math.abs(t-e)<1e-8},e.quaternion2matrix=function(r,i){void 0===i&&(i=null);var a=r.x,n=r.y,o=r.z,s=r.w,l=a*a,h=a*n,u=a*o,c=a*s,d=n*n,p=n*o,f=n*s,m=o*o,_=o*s,v=e.RAW_DATA_CONTAINER;return v[0]=1-2*(d+m),v[1]=2*(h+_),v[2]=2*(u-f),v[4]=2*(h-_),v[5]=1-2*(l+m),v[6]=2*(p+c),v[8]=2*(u+f),v[9]=2*(p-c),v[10]=1-2*(l+d),v[3]=v[7]=v[11]=v[12]=v[13]=v[14]=0,v[15]=1,i?(i.copyRawDataFrom(v),i):new t.Matrix4_4(new Float32Array(v))},e.getForward=function(e,r){return void 0===r&&(r=null),null===r&&(r=new t.Vector3D(0,0,0)),e.copyRowTo(2,r),r.normalize(),r},e.getUp=function(e,r){return void 0===r&&(r=null),null===r&&(r=new t.Vector3D(0,0,0)),e.copyRowTo(1,r),r.normalize(),r},e.getRight=function(e,r){return void 0===r&&(r=null),null===r&&(r=new t.Vector3D(0,0,0)),e.copyRowTo(0,r),r.normalize(),r},e.compare=function(t,r){var i=e.RAW_DATA_CONTAINER,a=r.rawData;t.copyRawDataTo(i);for(var n=0;16>n;++n)if(i[n]!=a[n])return!1;return!0},e.reflection=function(r,i){void 0===i&&(i=null),null===i&&(i=new t.Matrix4_4);var a=r.a,n=r.b,o=r.c,s=r.d,l=e.RAW_DATA_CONTAINER,h=-2*a*n,u=-2*a*o,c=-2*n*o;return l[0]=1-2*a*a,l[4]=h,l[8]=u,l[12]=-2*a*s,l[1]=h,l[5]=1-2*n*n,l[9]=c,l[13]=-2*n*s,l[2]=u,l[6]=c,l[10]=1-2*o*o,l[14]=-2*o*s,l[3]=0,l[7]=0,l[11]=0,l[15]=1,i.copyRawDataFrom(l),i
},e.getTranslation=function(e,r){return void 0===r&&(r=null),r||(r=new t.Vector3D),e.copyRowTo(3,r),r},e.clampf=function(t,e,r){if(e>r){var i=e;e=r,r=i}return e>t?e:r>t?t:r},e.ScreenToPosition=function(t,e,r){return(t+.5*e)/r*2-1},e.PositionToScreen=function(t,e,r){return.5*(t+1)*r-.5*e},e.mix=function(t,e,r){return t*(1-r)+e*r},e.calcDegree=function(r,i){r.transformVector(t.Vector3D.Y_AXIS,this._tempVector),this._tempVector.x=0,this._tempVector.normalize();var a=t.Vector3D.Y_AXIS.dotProduct(this._tempVector),n=Math.acos(a)*e.RADIANS_TO_DEGREES;this._tempVector.z<0&&(n=180-n),r.transformVector(t.Vector3D.Z_AXIS,this._tempVector),this._tempVector.y=0,this._tempVector.normalize();var o=t.Vector3D.Z_AXIS.dotProduct(this._tempVector),s=Math.acos(o)*e.RADIANS_TO_DEGREES;this._tempVector.x<0&&(s=360-s),r.transformVector(t.Vector3D.X_AXIS,this._tempVector),this._tempVector.z=0,this._tempVector.normalize();var l=t.Vector3D.X_AXIS.dotProduct(this._tempVector),h=Math.acos(l)*e.RADIANS_TO_DEGREES;this._tempVector.y<0&&(h=360-h),n=this.clampAngle(n),s=this.clampAngle(s),h=this.clampAngle(h),i.setTo(n,s,h)},e.clampAngle=function(t){for(;-180>t;)t+=360;for(;t>180;)t-=360;return t},e}();e.RADIANS_TO_DEGREES=180/Math.PI,e.DEGREES_TO_RADIANS=Math.PI/180,e.MAX_VALUE=2147483647,e.MIN_VALUE=-2147483647,e.RAW_DATA_CONTAINER=new Float32Array(16),e.CALCULATION_MATRIX=new t.Matrix4_4,e.CALCULATION_QUATERNION=new t.Quaternion,e.CALCULATION_VECTOR3D=new t.Vector3D,e.CALCULATION_VECTOR3D_0=new t.Vector3D,e.CALCULATION_VECTOR3D_1=new t.Vector3D,e.CALCULATION_VECTOR3D_2=new t.Vector3D,e._tempVector=new t.Vector3D,t.MathUtil=e,__reflect(e.prototype,"egret3d.MathUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.outError=function(t){console.log("Error:"+t)},e.outWarn=function(t){console.log("Warning:"+t)},e.outDebug=function(e){t.Egret3DEngine.instance.debug&&console.log("Debug:"+e)},e}();t.Egret3DLog=e,__reflect(e.prototype,"egret3d.Egret3DLog")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.AXIS_ANGLE="axisAngle",e.EULER_ANGLES="eulerAngles",e.QUATERNION="quaternion",t.Orientation3D=e,__reflect(e.prototype,"egret3d.Orientation3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.a=t,this.b=e,this.c=r,this.d=i}return e.prototype.setTo=function(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.a=t,this.b=e,this.c=r,this.d=i},e.prototype.fromPoints=function(t,e,r){var i=e.x-t.x,a=e.y-t.y,n=e.z-t.z,o=r.x-t.x,s=r.y-t.y,l=r.z-t.z;this.a=a*l-n*s,this.b=n*o-i*l,this.c=i*s-a*o,this.d=-(this.a*t.x+this.b*t.y+this.c*t.z)},e.prototype.fromNormalAndPoint=function(t,e){this.a=t.x,this.b=t.y,this.c=t.z,this.d=-(this.a*e.x+this.b*e.y+this.c*e.z)},e.prototype.normalize=function(){var t=Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);if(t>0){var e=1/t;this.a*=e,this.b*=e,this.c*=e,this.d*=e}return t},e.prototype.distance=function(t){return this.a*t.x+this.b*t.y+this.c*t.z+this.d},e.prototype.classifyPoint=function(e,r){void 0===r&&(r=.01);var i=this.distance(e);return-r>i?t.PlaneClassification.BACK:i>r?t.PlaneClassification.FRONT:t.PlaneClassification.INTERSECT},e.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"},e}();e.ALIGN_ANY=0,e.ALIGN_XY_AXIS=1,e.ALIGN_YZ_AXIS=2,e.ALIGN_XZ_AXIS=3,t.Plane3D=e,__reflect(e.prototype,"egret3d.Plane3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.BACK=0,e.FRONT=1,e.IN=0,e.OUT=1,e.INTERSECT=2,t.PlaneClassification=e,__reflect(e.prototype,"egret3d.PlaneClassification")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.pointInsideTriangle=function(e,r,i,a){return t.pp.setTo(e.x,e.z),t.p1.setTo(r.x,r.z),t.p2.setTo(i.x,i.z),t.p3.setTo(a.x,a.z),t.pointInsideTriangle2d()},t.pointInsideTriangle2d=function(){return t.product2d(t.p1,t.p2,t.p3)>=0?t.product2d(t.p1,t.p2,t.pp)>=0&&t.product2d(t.p2,t.p3,t.pp)>=0&&t.product2d(t.p3,t.p1,t.pp)>=0:t.product2d(t.p1,t.p2,t.pp)<=0&&t.product2d(t.p2,t.p3,t.pp)<=0&&t.product2d(t.p3,t.p1,t.pp)<=0},t.product2d=function(t,e,r){var i=(t.x-r.x)*(e.y-r.y)-(t.y-r.y)*(e.x-r.x);return i>-1e-5&&1e-5>i&&(i=0),i},t}();e.p1=new t.Point,e.p2=new t.Point,e.p3=new t.Point,e.pp=new t.Point,t.PointUtils=e,__reflect(e.prototype,"egret3d.PointUtils")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.Line=0]="Line",t[t.BesselCurve=1]="BesselCurve"}(e=t.CurveType||(t.CurveType={}));var r=function(){function t(){this.type=e.Line,this.frame=0,this.value=0}return t}();t.AnimCurve=r,__reflect(r.prototype,"egret3d.AnimCurve")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.frameRate=16,this.speed=1,this.isLoop=!0,this.name="",this._propertyArray=[],this._play=!1,this._totalTime=0,this._changeFrameTime=0,this._oldFrameIndex=0,this.totalTime=0}return t.prototype.IsExist=function(t){for(var e=0;e<this._propertyArray.length;e++)if(this._propertyArray[e].property==t)return!0;return!1},t.prototype.addAnimCurve=function(t,e){if(this.IsExist(t))return!1;if(null==e||e.length<=0)return!1;var i=new r;i.keyFrames=e,i.property=t,i.target=this._target,i.isLoop=!0,i.timePosition=0,i.totalFrame=e[e.length-1].frame,i.totalTime=i.totalFrame*this.frameRate,this.totalTime=Math.max(this.totalTime,i.totalTime),this._propertyArray.push(i),this.updateBindData(i)},t.prototype.removeAnimCurve=function(t){for(var e=null,r=0;r<this._propertyArray.length;r++)if(this._propertyArray[r].property==t)return e=this._propertyArray[r],this._propertyArray.splice(r,1),e.keyFrames},t.prototype.setPropertyLoop=function(t,e){for(var r=null,i=0;i<this._propertyArray.length;i++)if(this._propertyArray[i].property==t){r=this._propertyArray[i],r.isLoop=e;break}},t.prototype.bindObject3D=function(t){this._target=t;for(var e=0;e<this._propertyArray.length;e++)this.updateBindData(this._propertyArray[e])},t.prototype.updateBindData=function(t){if(this._target){t.target=this._target;for(var e=t.property.split("."),r=0;r<e.length-1;r++)t.target=t.target[e[r]];t.name=e[e.length-1]}},t.prototype.play=function(t,e){if(!this._play||!e){for(var r=0;r<this._propertyArray.length;r++)this._propertyArray[r].play(t,e);this._play=!0}},t.prototype.stop=function(){this._play=!1},t.prototype.update=function(t){if(this._play&&this._target)for(var e=0;e<this._propertyArray.length;e++)this._propertyArray[e].update(0,t)},t.prototype.clone=function(){var e=new t;return e._propertyArray=this._propertyArray,e._totalTime=this._totalTime,e.isLoop=this.isLoop,e.speed=this.speed,e.name=this.name,e},t}();t.PropertyAnim=e,__reflect(e.prototype,"egret3d.PropertyAnim");var r=function(){function t(){this.totalFrame=0,this.totalTime=0,this.frameRate=16,this.time=0,this.offset=0,this._time=0,this._frame=0,this._weight=0,this._frameTime=0,this._speed=1,this._change=!1}return t.prototype.play=function(t,e){this._change=e,this._speed=t,e&&(this._time=0)},t.prototype.update=function(t,e){var r=this;this._change&&(this._change=!1,this.offset=r._time),r._time=r._time-this.offset,r.time=r._time%r.totalTime,r._frameTime=r.time/this.frameRate,r._frame=Math.floor(r._frameTime),r._weight=r._frameTime-r._frame,r.keyFrames[r._frame]&&(r.target[r.name]=r.keyFrames[r._frame].value),r._time+=e*this._speed},t}();__reflect(r.prototype,"PropertyData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.u=0,this.v=0,this.u=t,this.v=e}return t}();t.UV=e,__reflect(e.prototype,"egret3d.UV")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this)||this;return i._animTime=0,i.speed=1,i.loopTime=0,i.currentAnimName="",i._proAnimDict={},i._event3D=new t.AnimationEvent3D,i._target=r,i}return __extends(r,e),Object.defineProperty(r.prototype,"target",{get:function(){return this._target},set:function(t){if(this._target=t,t)for(var e in this._proAnimDict)this._proAnimDict[e].bindObject3D(this._target)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"animTime",{get:function(){return this._animTime},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"propertyAnimController",{get:function(){return this},enumerable:!0,configurable:!0}),r.prototype.isPlay=function(){return!0},r.prototype.play=function(t,e,r,i){if(void 0===t&&(t=""),void 0===e&&(e=1),void 0===r&&(r=!0),void 0===i&&(i=!0),this.current=this._proAnimDict[t],!this.current)for(var a in this._proAnimDict){this.current=this._proAnimDict[a];break}this.speed=e,this.current&&(this.current.speed=this.speed,this.target&&this.current.bindObject3D(this.target),this.currentAnimName=this.current.name,this.current.play(e,r))},r.prototype.stop=function(){this.current&&this.current.stop(),this.current=null},r.prototype.update=function(t,e,r){this.current&&this.current.update(e)},r.prototype.activeState=function(t,e,r,i,a,n,o){},r.prototype.clone=function(){var t=new r;for(var e in this._proAnimDict)t.addPropertyAnim(this._proAnimDict[e].clone());return t},Object.defineProperty(r.prototype,"animStateNames",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"animStates",{get:function(){return null},enumerable:!0,configurable:!0}),r.prototype.addAnimState=function(t){},r.prototype.removeAnimState=function(t){},r.prototype.addPropertyAnim=function(t){this._proAnimDict[t.name]=t,t.proAnimController=this,this.target&&t.bindObject3D(this.target),this.loopTime=Math.max(this.loopTime,t.totalTime),0==t.isLoop&&(this.isLoop=t.isLoop)},r.prototype.removePropertyAnim=function(t){delete this._proAnimDict[t.name]},r.prototype.doEvent=function(t,e){this._event3D.eventType=t,this._event3D.target=e,this.dispatchEvent(this._event3D)},r}(t.EventDispatcher);t.PropertyAnimController=e,__reflect(e.prototype,"egret3d.PropertyAnimController",["egret3d.IAnimation"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t,r,i){void 0===t&&(t=80),void 0===r&&(r=80),void 0===i&&(i=80);var a=e.call(this)||this;return a._width=80,a._height=80,a._depth=80,a._width=t,a._height=r,a._depth=i,a.buildGeomtry(!0),a}return __extends(r,e),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),r.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1,this.vertexCount=36,this.indexCount=36,this.vertexArray.set([.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0]),e?this.indexArray.set([0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34]):this.indexArray.set([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35]),this.buildDefaultSubGeometry()},r}(t.Geometry);t.CubeGeometry=e,__reflect(e.prototype,"egret3d.CubeGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t,r){void 0===t&&(t=100),void 0===r&&(r=200);var i=e.call(this)||this;return i._height=t,i._radius=r,i.buildGeomtry(),i}return __extends(r,e),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),r.prototype.buildGeomtry=function(){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var e=[],r=[],i=20,a=20,n=2*Math.PI/i;for(a=0;i>a;a++){var o=this._radius*Math.sin(a*n),s=this._radius*Math.cos(a*n);e.push(o,0+this._height/2,s,o,0,s,1,0,0,1,1,1,1,1,0,0,0,o,0-this._height/2,s,o,0,s,1,0,0,1,1,1,1,1,0,0,0)}var l=e.length/this.vertexAttLength,h=l;e.push(0,0-this._height/2,0,0,-1,0,1,0,0,1,1,1,1,1,0,0,0);var u=l+1;e.push(0,0+this._height/2,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0);for(var c=0;l>c;c++)0!=(1&c)?r.push(c,c+1>=l?c+1-l:c+1,c+2>=l?c+2-l:c+2,h,c,c+2>=l?c+2-l:c+2):r.push(c+1>=l?c+1-l:c+1,c,c+2>=l?c+2-l:c+2,c,u,c+2>=l?c+2-l:c+2);this.setVerticesForIndex(0,this.vertexFormat,e,e.length/this.vertexAttLength),this.setVertexIndices(0,r);var d=new t.SubGeometry;d.geometry=this,d.start=0,d.count=this.indexCount,this.subGeometrys.push(d)},r}(t.Geometry);t.CylinderGeometry=e,__reflect(e.prototype,"egret3d.CylinderGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t,r,i,a,n,o,s,l){void 0===r&&(r=1e3),void 0===i&&(i=100),void 0===a&&(a=1e3),void 0===n&&(n=30),void 0===o&&(o=30),void 0===s&&(s=255),void 0===l&&(l=0);var h=e.call(this)||this;return h._width=100,h._height=100,h._segmentsW=100,h._segmentsH=100,h._depth=100,h._minElevation=100,h._maxElevation=100,h._scaleU=1,h._scaleV=1,h._segmentsW=n,h._segmentsH=o,h._width=r,h._height=i,h._depth=a,h._minElevation=l,h._maxElevation=s,h._heightmap=t,h._imageData=t.readPixels(0,0,t.width,t.height),h._positionXYZ=[],h.buildGeomtry(!0),h}return __extends(r,e),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"heightmap",{get:function(){return this._heightmap},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),r.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var r,i,a,n,o,s,l,h=this._segmentsW+1,u=(this._segmentsH+1)*h,c=(this._heightmap.width-1)/this._segmentsW,d=(this._heightmap.height-1)/this._segmentsH;this.vertexCount=u,this.indexCount=this._segmentsH*this._segmentsW*6,u=0,a=0;for(var p=0;p<=this._segmentsH;++p)for(var f=0;f<=this._segmentsW;++f)r=(f/this._segmentsW-.5)*this._width,i=(p/this._segmentsH-.5)*this._depth,o=f*c,s=(this._segmentsH-p)*d,l=this.getHeightByPixel(o,s),this.vertexArray[u++]=r,this.vertexArray[u++]=l,this.vertexArray[u++]=i,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=-1,this.vertexArray[u++]=0,this.vertexArray[u++]=0,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=f/this._segmentsW*this._scaleU,this.vertexArray[u++]=1-p/this._segmentsH*this._scaleV,this.vertexArray[u++]=f/this._segmentsW,this.vertexArray[u++]=1-p/this._segmentsH,f!=this._segmentsW&&p!=this._segmentsH&&(n=f+p*h,this.indexArray[a++]=n,this.indexArray[a++]=n+h+1,this.indexArray[a++]=n+h,this.indexArray[a++]=n,this.indexArray[a++]=n+1,this.indexArray[a++]=n+h+1);this.updateFaceNormals(),this.buildDefaultSubGeometry()},r.prototype.getHeightByPixel=function(t,e){t=Math.floor(t),e=Math.floor(e),0>t?t=0:t>=this._imageData.width&&(t=this._imageData.width-1),0>e?e=0:e>this._imageData.height&&(e=this._imageData.height-1);var r=255&this.getPixelColor(t,e);return r>this._maxElevation?this._maxElevation/255*this._height:r<this._minElevation?this._minElevation/255*this._height:r/255*this._height},r.prototype.getPixelColor=function(t,e){var r=4*(e*this._heightmap.imageData.width+t),i=this._imageData.data[r+3]<<24|this._imageData.data[r+0]<<16|this._imageData.data[r+1]<<8|this._imageData.data[r+2];return i},r.prototype.get3DCoordAtPixel=function(e,r,i,a,n){return void 0===n&&(n=null),r=a-r,n=n||new t.Vector3D,e*=this._width/i,e-=.5*this._width,r*=this._depth/a,r-=.5*this._depth,n.setTo(e,0,r),n.y=this.getHeightBySceneCoord(e,r),n},r.prototype.getHeightBySceneCoord=function(e,r){if(e+=.5*this._width,r+=.5*this._depth,0>e||0>r)return 0;if(e>=this._width||r>=this._depth)return 0;r=this._depth-r,e*=this._imageData.width/this._width,r*=this._imageData.height/this._depth;var i=Math.floor(e),a=Math.floor(r),n=this.getHeightByPixel(i,a),o=this.getHeightByPixel(i+1,a),s=this.getHeightByPixel(i,a+1),l=this.getHeightByPixel(i+1,a+1),h=e-i,u=r-a;return n=t.MathUtil.mix(n,o,h),o=t.MathUtil.mix(s,l,h),n=t.MathUtil.mix(n,o,u)},r.prototype.updateFaceNormals=function(){for(var t,e,r,i,a,n,o,s,l,h,u,c,d,p,f,m,_,v,g,y,x=0,b=0,D=this.indexCount,T=17,P=0,S=[];D>x;)t=P+this.indexArray[x+0]*T,e=this.vertexArray[t],a=this.vertexArray[t+1],s=this.vertexArray[t+2],t=P+this.indexArray[x+1]*T,r=this.vertexArray[t],n=this.vertexArray[t+1],l=this.vertexArray[t+2],t=P+this.indexArray[x+2]*T,i=this.vertexArray[t],o=this.vertexArray[t+1],h=this.vertexArray[t+2],u=r-e,c=n-a,d=l-s,p=i-e,f=o-a,m=h-s,_=d*f-c*m,v=u*m-d*p,g=c*p-u*f,y=Math.sqrt(_*_+v*v+g*g),S[b++]=g*y,S[b++]=v*y,S[b++]=_*y,x+=3;x=0;for(var w=0,A=1,C=2,L=this.vertexAttLength,E=3;D>x;)t=E+this.indexArray[x++]*L,this.vertexArray[t++]=S[w],this.vertexArray[t++]=S[A],this.vertexArray[t++]=S[C],t=E+this.indexArray[x++]*L,this.vertexArray[t++]=S[w],this.vertexArray[t++]=S[A],this.vertexArray[t++]=S[C],t=E+this.indexArray[x++]*L,this.vertexArray[t++]=S[w],this.vertexArray[t++]=S[A],this.vertexArray[t++]=S[C],w+=3,A+=3,C+=3},r}(t.Geometry);t.ElevationGeometry=e,__reflect(e.prototype,"egret3d.ElevationGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._timeEvent=new t.Event3D,r._times=new Array,r._processTimes=new Array,r._timer=0,r._start=!1,r}return __extends(r,e),r.prototype.start=function(){this._timer=0,this._start=!0,this._processTimes.length=0;for(var t=0;t<this._times.length;++t)this._processTimes[t]=this._times[t]},r.prototype.addTimerAxis=function(t){this._times.push(t)},r.prototype.clearTimerAxis=function(){this._times.length=0,this._processTimes.length=0},r.prototype.reset=function(){this._processTimes.length=0,this._timer=0,this._start=!1;for(var t=0;t<this._times.length;++t)this._processTimes[t]=this._times[t]},r.prototype.update=function(t,e){if(this._start){this._timer+=t,console.log(this._timer+"update");for(var i=0;i<this._processTimes.length;++i)if(this._timer>=this._processTimes[i]){this._timeEvent.eventType=r.TIME_EVENT,this._timeEvent.data=this._processTimes[i],this.dispatchEvent(this._timeEvent),this._processTimes.splice(i,1);break}}},r}(t.EventDispatcher);e.TIME_EVENT="TimeEvent",t.TimerAxis=e,__reflect(e.prototype,"egret3d.TimerAxis")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.vertexAttLength=17,this.vertLen=0,this.faces=0,this.source_indexData=new Array,this.source_vertexData=new Array,this.source_vertexColorData=new Array,this.source_normalData=new Array,this.source_tangtData=new Array,this.source_uvData=new Array,this.source_uv2Data=new Array,this.source_skinData=new Array,this.vertexIndex=0,this.indices=new Array,this.vertices=new Array,this.normals=new Array,this.tangts=new Array,this.verticesColor=new Array,this.uvs=new Array,this.uv2s=new Array,this.skinMesh=new Array,this.faceNormals=new Array,this.faceWeights=new Array,this.vertexIndices=new Array,this.uvIndices=new Array,this.uv2Indices=new Array,this.normalIndices=new Array,this.colorIndices=new Array,this.indexIds=new Array,this.matCount=0,this.material={}}return e.buildGeomtry=function(e,r){var i=new t.Geometry;i.vertexFormat=r,i.vertexCount=3*e.faces,i.indexCount=3*e.faces,i.faceCount=e.faces,i.skeleton=e.skeleton;for(var a=new t.Vector3D,n=new t.Vector3D(1,1,1),o=new t.Vector3D(1,1,1,1),s={u:1,v:0},l={u:1,v:0},h=0,u=0,c=0,d=0;d<e.faces;d++){i.indexArray[3*d+0]=3*d+0,i.indexArray[3*d+1]=3*d+2,i.indexArray[3*d+2]=3*d+1;for(var p=0;3>p;p++)u=3*d+p,u*=i.vertexAttLength,c=0,h=e.vertexIndices[3*d+p]*t.Geometry.positionSize,r&t.VertexFormat.VF_POSITION&&(a.x=e.source_vertexData[h+0],a.y=e.source_vertexData[h+1],a.z=e.source_vertexData[h+2],i.vertexArray[u+c+0]=a.x,i.vertexArray[u+c+1]=a.y,i.vertexArray[u+c+2]=a.z,c+=t.Geometry.positionSize),r&t.VertexFormat.VF_NORMAL&&(e.normalIndices&&e.source_normalData&&e.source_normalData.length>0&&(h=e.normalIndices[3*d+p]*t.Geometry.normalSize,n.x=e.source_normalData[h+0],n.y=e.source_normalData[h+1],n.z=e.source_normalData[h+2]),i.vertexArray[u+c+0]=n.x,i.vertexArray[u+c+1]=n.y,i.vertexArray[u+c+2]=n.z,c+=t.Geometry.normalSize),r&t.VertexFormat.VF_TANGENT&&(i.vertexArray[u+c+0]=0,i.vertexArray[u+c+1]=0,i.vertexArray[u+c+2]=0,c+=t.Geometry.tangentSize),r&t.VertexFormat.VF_COLOR&&(e.colorIndices&&e.source_vertexColorData&&e.source_vertexColorData.length>0&&(h=e.colorIndices[3*d+p]*t.Geometry.colorSize,o.x=e.source_vertexColorData[h+0],o.y=e.source_vertexColorData[h+1],o.z=e.source_vertexColorData[h+2],o.w=e.source_vertexColorData[h+3]),i.vertexArray[u+c+0]=o.x,i.vertexArray[u+c+1]=o.y,i.vertexArray[u+c+2]=o.z,i.vertexArray[u+c+3]=o.w,c+=t.Geometry.colorSize),r&t.VertexFormat.VF_UV0&&(e.uvIndices&&e.source_uvData&&e.source_uvData.length>0&&(h=e.uvIndices[3*d+p]*t.Geometry.uvSize,s.u=e.source_uvData[h+0],s.v=e.source_uvData[h+1]),i.vertexArray[u+c+0]=s.u,i.vertexArray[u+c+1]=s.v,c+=t.Geometry.uvSize),r&t.VertexFormat.VF_UV1&&(e.uv2Indices&&e.source_uv2Data&&e.source_uv2Data.length>0&&(h=e.uv2Indices[3*d+p]*t.Geometry.uv2Size,l.u=e.source_uv2Data[h+0],l.v=e.source_uv2Data[h+1]),i.vertexArray[u+c+0]=l.u,i.vertexArray[u+c+1]=l.v,c+=t.Geometry.uv2Size),r&t.VertexFormat.VF_SKIN&&(null!=e.source_skinData&&e.source_skinData.length>0?(h=e.vertexIndices[3*d+p]*t.Geometry.skinSize,i.vertexArray[u+c+0]=e.source_skinData[h+0],i.vertexArray[u+c+1]=e.source_skinData[h+2],i.vertexArray[u+c+2]=e.source_skinData[h+4],i.vertexArray[u+c+3]=e.source_skinData[h+6],i.vertexArray[u+c+4]=e.source_skinData[h+1],i.vertexArray[u+c+5]=e.source_skinData[h+3],i.vertexArray[u+c+6]=e.source_skinData[h+5],i.vertexArray[u+c+7]=e.source_skinData[h+7]):(i.vertexArray[u+c+0]=0,i.vertexArray[u+c+1]=0,i.vertexArray[u+c+2]=0,i.vertexArray[u+c+3]=0,i.vertexArray[u+c+4]=0,i.vertexArray[u+c+5]=0,i.vertexArray[u+c+6]=0,i.vertexArray[u+c+7]=0))}for(var p=0;p<e.matCount;++p){var f=new t.SubGeometry;f.matID=p,f.geometry=i,f.start=3*e.material[p].start,f.count=3*e.material[p].count,f.textureDiffuse=e.material[p].textureDiffuse,f.textureNormal=e.material[p].textureNormal,f.textureSpecular=e.material[p].textureSpecular,i.subGeometrys.push(f)}return i},e.combinGeomtryData=function(t,e){void 0===e&&(e=!0);for(var r=0,i=0,a=0,n=0,o=0,s=0,l=0,h=t.vertexDatas;r<t.vertLen;)h[r++]=t.vertices[i++],h[r++]=t.vertices[i++],h[r++]=t.vertices[i++],t.normals&&t.normals.length?(h[r++]=t.normals[a++],h[r++]=t.normals[a++],h[r++]=t.normals[a++]):(h[r++]=0,h[r++]=0,h[r++]=0),t.tangts?(r++,r++,r++):(h[r++]=0,h[r++]=0,h[r++]=0),t.source_vertexColorData&&t.source_vertexColorData.length?(h[r++]=t.verticesColor[s++],h[r++]=t.verticesColor[s++],h[r++]=t.verticesColor[s++],h[r++]=t.verticesColor[s++]):(h[r++]=1,h[r++]=1,h[r++]=1,h[r++]=1),t.uvs&&t.uvs.length?(h[r++]=t.uvs[n++],h[r++]=t.uvs[n++],t.uv2s&&t.uv2s.length?(h[r++]=t.uv2s[o++],h[r++]=t.uv2s[o++]):(h[r++]=t.uvs[o++],h[r++]=t.uvs[o++])):(h[r++]=0,h[r++]=0,h[r++]=0,h[r++]=0),t.skinMesh&&t.skinMesh.length&&(h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++],h[r++]=t.skinMesh[l++])},e.updateFaceNormals=function(t){for(var e,r,i,a,n,o,s,l,h,u,c,d,p,f,m,_,v,g,y,x,b=0,D=0,T=0,P=t.indices.length,S=t.vertexDatas,w=17,A=3;P>b;){e=A+t.indices[b++]*w,r=S[e],n=S[e+1],l=S[e+2],e=A+t.indices[b++]*w,i=S[e],o=S[e+1],h=S[e+2],e=A+t.indices[b++]*w,a=S[e],s=S[e+1],u=S[e+2],c=a-r,d=s-n,p=u-l,f=i-r,m=o-n,_=h-l,v=p*m-d*_,g=c*_-p*f,y=d*f-c*m,x=Math.sqrt(v*v+g*g+y*y);var C=1e4*x;1>C&&(C=1),t.faceWeights[T++]=C,x=1/x,t.faceNormals[D++]=v*x,t.faceNormals[D++]=g*x,t.faceNormals[D++]=y*x}},e.updateVertexNormals=function(t){this.updateFaceNormals(t);for(var e,r,i=0,a=1,n=2,o=(t.vertexDatas.length,17),s=3,l=0,h=0,u=t.indices.length;u>l;)r=t.faceWeights[h++],e=s+t.indices[l++]*o,t.vertexDatas[e]+=t.faceNormals[i]*r,t.vertexDatas[e++]+=t.faceNormals[a]*r,t.vertexDatas[e++]+=t.faceNormals[n]*r,e=s+t.indices[l++]*o,t.vertexDatas[e]+=t.faceNormals[i]*r,t.vertexDatas[e++]+=t.faceNormals[a]*r,t.vertexDatas[e++]+=t.faceNormals[n]*r,e=s+t.indices[l++]*o,t.vertexDatas[e]+=t.faceNormals[i]*r,t.vertexDatas[e++]+=t.faceNormals[a]*r,t.vertexDatas[e++]+=t.faceNormals[n]*r,i+=3,a+=3,n+=3},e}();t.GeometryData=e,__reflect(e.prototype,"egret3d.GeometryData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.createGeometry=function(e){void 0===e&&(e=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1);var r=new t.Geometry;return r.vertexFormat=e,r},e.createGemetryForType=function(e,r){switch(e){case"CubeGeometry":return new t.CubeGeometry(r.width,r.height,r.depth);case"CylinderGeometry":return new t.CylinderGeometry(r.height,r.radius);case"ElevationGeometry":return new t.ElevationGeometry(r.heightmap,r.width,r.height,r.depth,r.segmentsW,r.segmentsH);case"PlaneGeometry":return new t.PlaneGeometry(r.width,r.height,r.segmentsW,r.segmentsH,r.uScale,r.vScale);case"SphereGeometry":return new t.SphereGeometry(r.r,r.segmentsW,r.segmentsH)}return null},e.fromVertexFormatToLength=function(e){var r=0;return e&t.VertexFormat.VF_POSITION&&(r+=t.Geometry.positionSize),e&t.VertexFormat.VF_NORMAL&&(r+=t.Geometry.normalSize),e&t.VertexFormat.VF_TANGENT&&(r+=t.Geometry.tangentSize),e&t.VertexFormat.VF_COLOR&&(r+=t.Geometry.colorSize),e&t.VertexFormat.VF_UV0&&(r+=t.Geometry.uvSize),e&t.VertexFormat.VF_UV1&&(r+=t.Geometry.uv2Size),e&t.VertexFormat.VF_SKIN&&(r+=t.Geometry.skinSize),e&t.VertexFormat.VF_QUAD_ORIGN&&(r+=t.QuadData.originalSize),e&t.VertexFormat.VF_QUAD_POS&&(r+=t.QuadData.posOffest),e&t.VertexFormat.VF_QUAD_UVREC&&(r+=t.QuadData.uvRectangleSize),e&t.VertexFormat.VF_QUAD_ROTATION&&(r+=t.QuadData.rotationSize),e&t.VertexFormat.VF_QUAD_MASK&&(r+=t.QuadData.maskSize),e&t.VertexFormat.VF_QUAD_COLOR&&(r+=t.QuadData.colorSize),r},e}();t.GeometryUtil=e,__reflect(e.prototype,"egret3d.GeometryUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){void 0===a&&(a=!1);var n=e.call(this)||this;return n.vector3_Down=new t.Vector3D(0,-1,0),n.vector3_Forward=new t.Vector3D(0,0,1),n.vector3_Up=new t.Vector3D(0,1,0),n.directions=[new t.Vector3D(-1,0,0),new t.Vector3D(0,0,-1),new t.Vector3D(1,0,0),new t.Vector3D(0,0,1)],0>r?(r=0,console.error("Sky Sphere subdivisions increased to minimum, which is 0.")):r>6&&(r=6,console.error("Sky Sphere subdivisions decreased to maximum, which is 6.")),n._subdivisions=r,n._radius=i,n.buildGeomtry(!1,a),n}return __extends(r,e),r.prototype.buildGeomtry=function(e,r){var i=[],a=[],n=1<<this._subdivisions,o=[],s=[];this.CreateOctahedron(o,s,n,r);for(var l=0;l<o.length;l++)console.log(o[l]);var h=[];this.Normalize(o,h,e);var u=[];if(this.CreateUV(o,u),1!=this._radius)for(var l=0;l<o.length;l++)o[l].x*=this._radius,o[l].y*=this._radius,o[l].z*=this._radius,console.log(o[l].x+" "+o[l].y+" "+o[l].z);this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;for(var l=0;l<o.length;l++){var c=o[l];i.push(c.x),i.push(c.y),i.push(c.z);var d=h[l];i.push(d.x),i.push(d.y),i.push(d.z),i.push(1,1,1,1);var p=u[l];i.push(p.u),i.push(1-p.v)}a=s,this.setVerticesForIndex(0,this.vertexFormat,i,i.length/this.vertexAttLength),this.setVertexIndices(0,a),this.buildDefaultSubGeometry()},r.prototype.CreateOctahedron=function(e,r,i,a){var n=0,o=0,s=0;if(0==a){for(var l=0;4>l;l++)e[n++]=this.vector3_Down.clone();for(var l=1;i>=l;l++){var h=l/i,u=new t.Vector3D,c=new t.Vector3D;c.lerp(this.vector3_Down,this.vector3_Forward,h),e[n++]=c;for(var d=0;4>d;d++)u=c.clone(),c.lerp(this.vector3_Down,this.directions[d],h),s=this.CreateLowerStrip(l,n,o,s,r),n=this.CreateVertexLine(u,c,l,n,e),o+=l>1?l-1:1;o=n-1-4*l}}for(var l=i-1;l>=1;l--){var u,h=l/i,c=new t.Vector3D;c.lerp(this.vector3_Up,this.vector3_Forward,h),e[n++]=c;for(var d=0;4>d;d++)u=c.clone(),c.lerp(this.vector3_Up,this.directions[d],h),s=this.CreateUpperStrip(l,n,o,s,r),n=this.CreateVertexLine(u,c,l,n,e),o+=l+1;o=n-1-4*l}for(var l=0;4>l;l++)r[s++]=o,r[s++]=n,r[s++]=++o,e[n++]=this.vector3_Up.clone()},r.prototype.CreateLowerStrip=function(t,e,r,i,a){for(var n=1;t>n;n++)a[i++]=r,a[i++]=e-1,a[i++]=e,a[i++]=r++,a[i++]=e++,a[i++]=r;return a[i++]=r,a[i++]=e-1,a[i++]=e,i},r.prototype.CreateVertexLine=function(e,r,i,a,n){for(var o=1;i>=o;o++){var s=new t.Vector3D;s.lerp(e,r,o/i),n[a++]=s}return a},r.prototype.CreateUpperStrip=function(t,e,r,i,a){a[i++]=r,a[i++]=e-1,a[i++]=++r;
for(var n=1;t>=n;n++)a[i++]=e-1,a[i++]=e,a[i++]=r,a[i++]=r,a[i++]=e++,a[i++]=++r;return i},r.prototype.Normalize=function(t,e,r){for(var i=0;i<t.length;i++){var a=t[i];a.normalize(),e[i]=a,t[i]=a}},r.prototype.CreateUV=function(t,e){for(var r=1,i=0;i<t.length;i++){var a=t[i];a.x==r&&(e[i-1].u=1),r=a.x;var n={u:Math.atan2(a.x,a.z)/(-2*Math.PI),v:Math.asin(a.y)/Math.PI+.5};n.u<0&&(n.u+=1),n.v=Math.asin(a.y)/Math.PI+.5,e[i]=n}e[t.length-4].u=e[0].u=.125,e[t.length-3].u=e[1].u=.375,e[t.length-2].u=e[2].u=.625,e[t.length-1].u=e[3].u=.875},r.prototype.CreateTangents=function(e,r){for(var i=0;i<e.length;i++){var a=e[i];a.y=0,a.normalize();var n=new t.Quaternion;n.x=-a.z,n.y=0,n.z=a.x,n.w=-1,r[i]=n}r[0]=new t.Quaternion(-1,0,-1),r[1]=new t.Quaternion(1,0,-1),r[2]=new t.Quaternion(1,0,1),r[3]=new t.Quaternion(-1,0,1),r[0].normalize(),r[1].normalize(),r[2].normalize(),r[3].normalize(),r[e.length-4]=r[0],r[e.length-3]=r[1],r[e.length-2]=r[2],r[e.length-1]=r[3];for(var i=0;4>i;i++)r[e.length-1-i].w=r[i].w=-1},r}(t.Geometry);t.OctahedronSphereGeometry=e,__reflect(e.prototype,"egret3d.OctahedronSphereGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n,o,s,l,h,u){void 0===r&&(r=500),void 0===i&&(i=500),void 0===a&&(a=1),void 0===n&&(n=1),void 0===o&&(o=1),void 0===s&&(s=1),void 0===l&&(l=t.Vector3D.Y_AXIS),void 0===h&&(h=!0),void 0===u&&(u=!0);var c=e.call(this)||this;return c._segmentsW=1,c._segmentsH=1,c._width=500,c._height=500,c._scaleU=1,c._scaleV=1,c._width=r,c._height=i,c._segmentsW=a,c._segmentsH=n,c._scaleU=o,c._scaleV=s,c._wCenter=h,c._hCenter=u,c.buildGeometry(l),c}return __extends(r,e),Object.defineProperty(r.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:!0,configurable:!0}),r.prototype.buildGeometry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;var r,i,a,n,o=this._segmentsW+1,s=(this._segmentsH+1)*o,l=this.vertexAttLength,h=l-15;a=this._segmentsH*this._segmentsW*6,this.vertexCount=s,this.indexCount=a,a=0;for(var u=(new t.Vector3D,0),c=0;c<=this._segmentsH;++c)for(var d=0;d<=this._segmentsW;++d){switch(r=(d/this._segmentsW-.5)*this._width,i=(c/this._segmentsH-.5)*this._height,0==this._wCenter&&(r+=this._width/2),0==this._hCenter&&(i+=this._height/2),e){case t.Vector3D.Y_AXIS:this.vertexArray[u++]=r,this.vertexArray[u++]=0,this.vertexArray[u++]=i,this.vertexArray[u++]=0,this.vertexArray[u++]=1,this.vertexArray[u++]=0;break;case t.Vector3D.Z_AXIS:this.vertexArray[u++]=r,this.vertexArray[u++]=i,this.vertexArray[u++]=0,this.vertexArray[u++]=0,this.vertexArray[u++]=0,this.vertexArray[u++]=-1;break;case t.Vector3D.X_AXIS:this.vertexArray[u++]=0,this.vertexArray[u++]=r,this.vertexArray[u++]=i,this.vertexArray[u++]=1,this.vertexArray[u++]=0,this.vertexArray[u++]=0;break;default:this.vertexArray[u++]=r,this.vertexArray[u++]=0,this.vertexArray[u++]=i,this.vertexArray[u++]=0,this.vertexArray[u++]=1,this.vertexArray[u++]=0}if(this.vertexArray[u++]=1,this.vertexArray[u++]=0,this.vertexArray[u++]=0,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=1,this.vertexArray[u++]=d/this._segmentsW*this._scaleU,this.vertexArray[u++]=(1-c/this._segmentsH)*this._scaleV,u+=h,d!=this._segmentsW&&c!=this._segmentsH){n=d+c*o;var p=1;this.indexArray[a++]=n*p,this.indexArray[a++]=(n+o+1)*p,this.indexArray[a++]=(n+o)*p,this.indexArray[a++]=n*p,this.indexArray[a++]=(n+1)*p,this.indexArray[a++]=(n+o+1)*p}}var f=new t.SubGeometry;f.geometry=this,f.start=0,f.count=this.indexCount,this.subGeometrys.push(f)},r}(t.Geometry);t.PlaneGeometry=e,__reflect(e.prototype,"egret3d.PlaneGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t,r,i){void 0===t&&(t=100),void 0===r&&(r=15),void 0===i&&(i=15);var a=e.call(this)||this;return a._segmentsW=50,a._segmentsH=50,a._radius=100,a._radius=t,a._segmentsW=r,a._segmentsH=i,a.buildSphere(!0),a}return __extends(r,e),Object.defineProperty(r.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),r.prototype.buildSphere=function(e){void 0===e&&(e=!0),this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var r=0,i=0,a=0,n=(this._segmentsH+1)*(this._segmentsW+1),o=this.vertexAttLength,s=o-9;this.vertexCount=n,this.indexCount=(this._segmentsH-1)*this._segmentsW*6;var l=0,h=0,u=0,c=0,d=0,p=0;for(i=0;i<=this._segmentsH;++i){l=h;var f=Math.PI*i/this._segmentsH,m=-this._radius*Math.cos(f),_=this._radius*Math.sin(f);for(r=0;r<=this._segmentsW;++r){var v=2*Math.PI*r/this._segmentsW,g=_*Math.cos(v),y=_*Math.sin(v),x=1/Math.sqrt(g*g+y*y+m*m),b=Math.sqrt(y*y+g*g);if(d=0,p=b>.007?g/b:0,u=-m,c=y,r==this._segmentsW?(this.vertexArray[h++]=this.vertexArray[l],this.vertexArray[h++]=this.vertexArray[l+1],this.vertexArray[h++]=this.vertexArray[l+2],this.vertexArray[h++]=g*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=c*x,this.vertexArray[h++]=b>.007?-y/b:1,this.vertexArray[h++]=d,this.vertexArray[h++]=p,this.vertexArray[h+0]=1,this.vertexArray[h+1]=1,this.vertexArray[h+2]=1,this.vertexArray[h+3]=1):(this.vertexArray[h++]=g,this.vertexArray[h++]=u,this.vertexArray[h++]=c,this.vertexArray[h++]=g*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=c*x,this.vertexArray[h++]=b>.007?-y/b:1,this.vertexArray[h++]=d,this.vertexArray[h++]=p,this.vertexArray[h]=1,this.vertexArray[h+1]=1,this.vertexArray[h+2]=1,this.vertexArray[h+3]=1),r>0&&i>0){var D=(this._segmentsW+1)*i+r,T=(this._segmentsW+1)*i+r-1,P=(this._segmentsW+1)*(i-1)+r-1,S=(this._segmentsW+1)*(i-1)+r;i==this._segmentsH?(this.vertexArray[h-9]=this.vertexArray[l],this.vertexArray[h-8]=this.vertexArray[l+1],this.vertexArray[h-7]=this.vertexArray[l+2],e?(this.indexArray[a++]=D,this.indexArray[a++]=S,this.indexArray[a++]=P):(this.indexArray[a++]=D,this.indexArray[a++]=P,this.indexArray[a++]=S)):1==i?e?(this.indexArray[a++]=D,this.indexArray[a++]=P,this.indexArray[a++]=T):(this.indexArray[a++]=D,this.indexArray[a++]=T,this.indexArray[a++]=P):e?(this.indexArray[a++]=D,this.indexArray[a++]=S,this.indexArray[a++]=P,this.indexArray[a++]=D,this.indexArray[a++]=P,this.indexArray[a++]=T):(this.indexArray[a++]=D,this.indexArray[a++]=P,this.indexArray[a++]=S,this.indexArray[a++]=D,this.indexArray[a++]=T,this.indexArray[a++]=P)}h+=s}}var o=17,s=((this._segmentsH+1)*(this._segmentsW+1)*o,o-2),h=13;for(i=0;i<=this._segmentsH;++i)for(r=0;r<=this._segmentsW;++r)this.vertexArray[h++]=r/this._segmentsW,this.vertexArray[h++]=i/this._segmentsH,h+=s;var w=new t.SubGeometry;w.geometry=this,w.start=0,w.count=this.indexCount,this.subGeometrys.push(w)},r}(t.Geometry);t.SphereGeometry=e,__reflect(e.prototype,"egret3d.SphereGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.useVertexAttributeList=[],this._start=0,this.count=0,this.matID=0,this.preAttList=new Array,this.localActive=!1}return Object.defineProperty(e.prototype,"start",{get:function(){return this._start},set:function(t){this._start=t},enumerable:!0,configurable:!0}),e.prototype.upload=function(e,r){e.attributeDiry=!1;var i=0;e.attributeList=[],this.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(e.attribute_position&&(e.attribute_position.uniformIndex||(e.attribute_position.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_position.varName)),e.attribute_position.size=t.Geometry.positionSize,e.attribute_position.dataType=t.ContextConfig.FLOAT,e.attribute_position.normalized=!1,e.attribute_position.stride=this.geometry.vertexSizeInBytes,e.attribute_position.offsetBytes=i,e.attributeList.push(e.attribute_position),this.useVertexAttributeList[e.attribute_position.uniformIndex]=e.attribute_position.uniformIndex),i+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(e.attribute_normal&&(e.attribute_normal.uniformIndex||(e.attribute_normal.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_normal.varName)),e.attribute_normal.size=t.Geometry.normalSize,e.attribute_normal.dataType=t.ContextConfig.FLOAT,e.attribute_normal.normalized=!1,e.attribute_normal.stride=this.geometry.vertexSizeInBytes,e.attribute_normal.offsetBytes=i,e.attributeList.push(e.attribute_normal),this.useVertexAttributeList[e.attribute_normal.uniformIndex]=e.attribute_normal.uniformIndex),i+=t.Geometry.normalSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(e.attribute_tangent&&(e.attribute_tangent.uniformIndex||(e.attribute_tangent.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_tangent.varName)),e.attribute_tangent.size=t.Geometry.tangentSize,e.attribute_tangent.dataType=t.ContextConfig.FLOAT,e.attribute_tangent.normalized=!1,e.attribute_tangent.stride=this.geometry.vertexSizeInBytes,e.attribute_tangent.offsetBytes=i,e.attributeList.push(e.attribute_tangent),this.useVertexAttributeList[e.attribute_tangent.uniformIndex]=e.attribute_tangent.uniformIndex),i+=t.Geometry.tangentSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(e.attribute_color&&(e.attribute_color.uniformIndex||(e.attribute_color.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_color.varName)),e.attribute_color.size=t.Geometry.colorSize,e.attribute_color.dataType=t.ContextConfig.FLOAT,e.attribute_color.normalized=!1,e.attribute_color.stride=this.geometry.vertexSizeInBytes,e.attribute_color.offsetBytes=i,e.attributeList.push(e.attribute_color),this.useVertexAttributeList[e.attribute_color.uniformIndex]=e.attribute_color.uniformIndex),i+=t.Geometry.colorSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_UV0&&(e.attribute_uv0&&(e.attribute_uv0.uniformIndex||(e.attribute_uv0.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_uv0.varName)),e.attribute_uv0.size=t.Geometry.uvSize,e.attribute_uv0.dataType=t.ContextConfig.FLOAT,e.attribute_uv0.normalized=!1,e.attribute_uv0.stride=this.geometry.vertexSizeInBytes,e.attribute_uv0.offsetBytes=i,e.attributeList.push(e.attribute_uv0),this.useVertexAttributeList[e.attribute_uv0.uniformIndex]=e.attribute_uv0.uniformIndex),i+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_UV1&&(e.attribute_uv1&&(e.attribute_uv1.uniformIndex||(e.attribute_uv1.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_uv1.varName)),e.attribute_uv1.size=t.Geometry.uv2Size,e.attribute_uv1.dataType=t.ContextConfig.FLOAT,e.attribute_uv1.normalized=!1,e.attribute_uv1.stride=this.geometry.vertexSizeInBytes,e.attribute_uv1.offsetBytes=i,e.attributeList.push(e.attribute_uv1),this.useVertexAttributeList[e.attribute_uv1.uniformIndex]=e.attribute_uv1.uniformIndex),i+=t.Geometry.uv2Size*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_SKIN&&(e.attribute_boneIndex&&(e.attribute_boneIndex.uniformIndex||(e.attribute_boneIndex.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_boneIndex.varName)),e.attribute_boneIndex.size=t.Geometry.skinSize/2,e.attribute_boneIndex.dataType=t.ContextConfig.FLOAT,e.attribute_boneIndex.normalized=!1,e.attribute_boneIndex.stride=this.geometry.vertexSizeInBytes,e.attribute_boneIndex.offsetBytes=i,e.attributeList.push(e.attribute_boneIndex),this.useVertexAttributeList[e.attribute_boneIndex.uniformIndex]=e.attribute_boneIndex.uniformIndex),i+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT,e.attribute_boneWeight&&(e.attribute_boneWeight.uniformIndex||(e.attribute_boneWeight.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_boneWeight.varName)),e.attribute_boneWeight.size=t.Geometry.skinSize/2,e.attribute_boneWeight.dataType=t.ContextConfig.FLOAT,e.attribute_boneWeight.normalized=!1,e.attribute_boneWeight.stride=this.geometry.vertexSizeInBytes,e.attribute_boneWeight.offsetBytes=i,e.attributeList.push(e.attribute_boneWeight),this.useVertexAttributeList[e.attribute_boneWeight.uniformIndex]=e.attribute_boneWeight.uniformIndex),i+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_POS&&(e.attribute_position&&(e.attribute_position.uniformIndex||(e.attribute_position.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_position.varName)),e.attribute_position.size=t.QuadData.posSize,e.attribute_position.dataType=t.ContextConfig.FLOAT,e.attribute_position.normalized=!1,e.attribute_position.stride=t.QuadData.vertexBytes,e.attribute_position.offsetBytes=i,e.attributeList.push(e.attribute_position),this.useVertexAttributeList[e.attribute_position.uniformIndex]=e.attribute_position.uniformIndex),i+=t.QuadData.posSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_ORIGN&&(e.attribute_shapePosition&&(e.attribute_shapePosition.uniformIndex||(e.attribute_shapePosition.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_shapePosition.varName)),e.attribute_shapePosition.size=t.QuadData.originalSize,e.attribute_shapePosition.dataType=t.ContextConfig.FLOAT,e.attribute_shapePosition.normalized=!1,e.attribute_shapePosition.stride=t.QuadData.vertexBytes,e.attribute_shapePosition.offsetBytes=i,e.attributeList.push(e.attribute_shapePosition),this.useVertexAttributeList[e.attribute_shapePosition.uniformIndex]=e.attribute_shapePosition.uniformIndex),i+=t.QuadData.originalSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_UVREC&&(e.attribute_uvRec&&(e.attribute_uvRec.uniformIndex||(e.attribute_uvRec.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_uvRec.varName)),e.attribute_uvRec.size=t.QuadData.uvRectangleSize,e.attribute_uvRec.dataType=t.ContextConfig.FLOAT,e.attribute_uvRec.normalized=!1,e.attribute_uvRec.stride=t.QuadData.vertexBytes,e.attribute_uvRec.offsetBytes=i,e.attributeList.push(e.attribute_uvRec),this.useVertexAttributeList[e.attribute_uvRec.uniformIndex]=e.attribute_uvRec.uniformIndex),i+=t.QuadData.uvRectangleSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_ROTATION&&(e.attribute_rotate&&(e.attribute_rotate.uniformIndex||(e.attribute_rotate.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_rotate.varName)),e.attribute_rotate.size=t.QuadData.rotationSize,e.attribute_rotate.dataType=t.ContextConfig.FLOAT,e.attribute_rotate.normalized=!1,e.attribute_rotate.stride=t.QuadData.vertexBytes,e.attribute_rotate.offsetBytes=i,e.attributeList.push(e.attribute_rotate),this.useVertexAttributeList[e.attribute_rotate.uniformIndex]=e.attribute_rotate.uniformIndex),i+=t.QuadData.rotationSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_MASK&&(e.attribute_maskRectangle&&(e.attribute_maskRectangle.uniformIndex||(e.attribute_maskRectangle.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_maskRectangle.varName)),e.attribute_maskRectangle.size=t.QuadData.maskSize,e.attribute_maskRectangle.dataType=t.ContextConfig.FLOAT,e.attribute_maskRectangle.normalized=!1,e.attribute_maskRectangle.stride=t.QuadData.vertexBytes,e.attribute_maskRectangle.offsetBytes=i,e.attributeList.push(e.attribute_maskRectangle),this.useVertexAttributeList[e.attribute_maskRectangle.uniformIndex]=e.attribute_maskRectangle.uniformIndex),i+=t.QuadData.maskSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_QUAD_COLOR&&(e.attribute_quad_color&&(e.attribute_quad_color.uniformIndex||(e.attribute_quad_color.uniformIndex=r.getShaderAttribLocation(e.program3D,e.attribute_quad_color.varName)),e.attribute_quad_color.size=t.QuadData.colorSize,e.attribute_quad_color.dataType=t.ContextConfig.FLOAT,e.attribute_quad_color.normalized=!1,e.attribute_quad_color.stride=t.QuadData.vertexBytes,e.attribute_quad_color.offsetBytes=i,e.attributeList.push(e.attribute_quad_color),this.useVertexAttributeList[e.attribute_quad_color.uniformIndex]=e.attribute_quad_color.uniformIndex),i+=t.QuadData.colorSize*Float32Array.BYTES_PER_ELEMENT);for(var a=0;a<this.preAttList.length;++a){var n=this.preAttList[a],o=e[n.name];o&&(o.uniformIndex||(o.uniformIndex=r.getShaderAttribLocation(e.program3D,o.varName),o.size=n.size,o.dataType=t.ContextConfig.FLOAT,o.normalized=!1,o.stride=this.geometry.vertexSizeInBytes,o.offsetBytes=i,e.attributeList.push(o),this.useVertexAttributeList[o.uniformIndex]=o.uniformIndex)),i+=n.size*Float32Array.BYTES_PER_ELEMENT}},e.prototype.activeState=function(t,e,r,i){r.attributeDiry&&this.upload(r,i);for(var a=(i.activeAttribPointer(this.geometry.vertexFormat,r.attributeList.length),0);a<r.attributeList.length;a++){var n=r.attributeList[a];n.uniformIndex>=0&&i.vertexAttribPointer(n.uniformIndex,n.size,n.dataType,n.normalized,n.stride,n.offsetBytes)}},e}();e.use=!1,t.SubGeometry=e,__reflect(e.prototype,"egret3d.SubGeometry")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.load=function(t){this._fontTextures=t},t.getTexture=function(t){var e=this._fontTextures[t];return e},t}();t.BitmapFont=e,__reflect(e.prototype,"egret3d.gui.BitmapFont")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.time=0,this.offset=0,this.speed=1,this.loop=!0,this._frameTime=0,this._frame=0,this._time=0,this._nextframe=0,this._lastframe=0,this._weight=0,this._reStart=!1,this._end=!1,this.cycleTime=0,this.clip=t,this.loop=this.clip.isLoop,this.totalFrame=t.totalFrame,this.totalTime=t.totalTime}return e.prototype.reset=function(t){this._reStart=!0,this._time=0,this._lastframe=0,this._end=!1},e.prototype.reStart=function(){this._reStart=!0},e.prototype.update=function(e,r){this._reStart&&(this._reStart=!1,this.offset=this._time),this.time=this._time-this.offset,this.time=this.time%this.totalTime,this._frameTime=this.time/this.clip.frameRate,this._frame=Math.floor(this._frameTime),this._weight=this._frameTime-this._frame,this._nextframe=this._frame+1,this._nextframe>=this.totalFrame&&(this._nextframe=this.loop?0:this.totalFrame-1),this._end?this._frame=this._nextframe=this.speed<0?0:this.totalFrame-1:(this.speed<0&&this._frame>this._lastframe||this.speed>0&&this._frame<this._lastframe)&&(this.loop?this.animation.dispatchCycle():(this._frame=this._nextframe=this.speed<0?0:this.totalFrame-1,this._end=!0,this.animation.dispatchComplete())),this._lastframe=this._frame,t.Egret3DPolicy.useAnimPoseInterpolation?r.getLerpSkeletonPose(this._frame,this._nextframe,this._weight,this.clip,r):r.copySkeletonPose(this.clip.getSkeletonPose(this._frame),r),this._time+=e*this.speed,this._time<0&&(this._time=this._time%this.totalTime,this._time=this.totalTime+this._time)},e}();t.AnimClipState=e,__reflect(e.prototype,"egret3d.AnimClipState")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this._mouseList=[],this._lastMouseList=[],this._quadStage=e,t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.MouseEvent3D.MOUSE_OVER,this.mouseOver,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.mouseClick,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.MouseEvent3D.MOUSE_OUT,this.mouseOut,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.mouseDown,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.mouseUp,this,null,Number.MAX_VALUE),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.mouseMove,this,null,Number.MAX_VALUE)}return e.prototype.dispatchMouseEvent=function(e){var r=e.eventType;r===t.TouchEvent3D.TOUCH_START?r=t.MouseEvent3D.MOUSE_DOWN:r===t.TouchEvent3D.TOUCH_END?r=t.MouseEvent3D.MOUSE_UP:r===t.TouchEvent3D.TOUCH_MOVE&&(r=t.MouseEvent3D.MOUSE_MOVE),r===t.MouseEvent3D.MOUSE_MOVE&&(this._lastMouseList=this._mouseList);var i,a,n=this.getMousePickList();if(0===n.length){var o=new t.MouseEvent3D(r);return void this._quadStage.dispatchEvent(o)}for(e.stopImmediatePropagation(),i=n[0],a=i;a;){var s=new t.MouseEvent3D(r);a.dispatchEvent(s),a=a.parentIsStage?null:a.parent}var l=new t.MouseEvent3D(r);this._quadStage.dispatchEvent(l)},e.prototype.onTouchStart=function(t){},e.prototype.onTouchEnd=function(t){},e.prototype.onTouchMove=function(t){},e.prototype.mouseOut=function(t){this.dispatchMouseEvent(t)},e.prototype.mouseDown=function(t){this.dispatchMouseEvent(t)},e.prototype.mouseUp=function(t){this.dispatchMouseEvent(t)},e.prototype.mouseOver=function(t){this.dispatchMouseEvent(t)},e.prototype.mouseMove=function(t){this.dispatchMouseEvent(t)},e.prototype.mouseClick=function(t){this.dispatchMouseEvent(t)},e.prototype.fire=function(){this._finalist=this._quadStage.quadList},e.prototype.getGlobalRect=function(e){var r=new t.Rectangle;for(r.copyFrom(e.aabb),e=e.parent;e;)r.x+=e.x,r.y+=e.y,e=e.parent;return r},e.prototype.getMousePickList=function(){var e;this._mouseList.length=0;var r;if(this._finalist)for(e=0;e<this._finalist.length;e++)r=this._finalist[e],r.globalVisible&&r.mouseEnable&&r.aabb.inner(t.Input.mouseX,t.Input.mouseY)&&this._mouseList.push(r);return this._mouseList.reverse(),this._mouseList},e}();t.GUIEventFire=e,__reflect(e.prototype,"egret3d.GUIEventFire")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(){function r(){this._defaultSkinTexture={}}return r.prototype.getDefaultSkin=function(t){return this._defaultSkinTexture[t]},r.prototype.initDefaultSkin=function(){var i=t.textureResMgr.getTexture("normal.png"),a=t.textureResMgr.getTexture("pressed.png"),n=t.textureResMgr.getTexture("hover.png"),o=t.textureResMgr.getTexture("default.png"),s=t.textureResMgr.getTexture("checked.png"),l=t.textureResMgr.getTexture("whitebackground.png"),h=t.textureResMgr.getTexture("backgroundpic.png"),u=t.textureResMgr.getTexture("blue.png"),c=t.textureResMgr.getTexture("unselected.png"),d=t.textureResMgr.getTexture("selected.png"),p=t.textureResMgr.getTexture("hover1.png"),f=t.textureResMgr.getTexture("bluebackground.png"),m=t.textureResMgr.getTexture("whitebackground.png");r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_UP,i),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_DOWN,a),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_BUTTON_OVER,n),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_LABEL_BUTTON_UP,i),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_LABE_BUTTON_DOWN,a),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_UP,o),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_DOWN,o),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_UP,s),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_DOWN,s),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_UP,c),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_DOWN,p),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_DOWN,p),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_UP,d),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_SLIDER_BAR,f),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_SLIDER_BACKGROUND,m),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PROGRESS_BAR,u),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PROGRESS_BAR_BACKGROUND,h),r.instance.setDefaultSkin(e.DefaultSkinName.DEFAULT_PANEL_BACKGROUND,l)},r.prototype.setDefaultSkin=function(e,r){"string"==typeof r&&(r=t.textureResMgr.getTexture(r)),this._defaultSkinTexture[e]=r},Object.defineProperty(r,"instance",{get:function(){return r._instance||(r._instance=new r),r._instance},enumerable:!0,configurable:!0}),r}();e.GUISkinManager=r,__reflect(r.prototype,"egret3d.gui.GUISkinManager");var i=function(){function t(){}return t}();i.DEFAULT_BUTTON_UP="defaultButtonUp",i.DEFAULT_BUTTON_DOWN="defaultButtonDown",i.DEFAULT_BUTTON_OVER="defaultButtonOver",i.DEFAULT_BUTTON_DISABLE="defaultButtonDisable",i.DEFAULT_LABEL_BUTTON_UP="defaultLabelButtonUp",i.DEFAULT_LABE_BUTTON_DOWN="defaultLabelButtonDown",i.DEFAULT_LABE_BUTTON_DISABLE="defaultLabelButtonDisable",i.DEFAULT_CHECK_BOX_UP="defaultCheckBoxUp",i.DEFAULT_CHECK_BOX_DOWN="defaultCheckBoxDown",i.DEFAULT_CHECK_BOX_SELECTED_UP="defaultCheckBoxSelectedUp",i.DEFAULT_CHECK_BOX_SELECTED_DOWN="defaultCheckBoxSelectedDown",i.DEFAULT_CHECK_BOX_DISABLE="defaultCheckBoxDisable",i.DEFAULT_PROGRESS_BAR="defaultProgressBar",i.DEFAULT_PROGRESS_BAR_BACKGROUND="defaultProgressBarBackground",i.DEFAULT_RADIO_BUTTON_UP="defaultRadioButtonUp",i.DEFAULT_RADIO_BUTTON_DOWN="defaultRadioButtonDown",i.DEFAULT_RADIO_BUTTON_SELECTED_UP="defaultRadioButtonSelectedUp",i.DEFAULT_RADIO_BUTTON_SELECTED_DOWN="defaultRadioButtonSelectedDown",i.DEFAULT_RADIO_BUTTON_DISABLE="defaultRadioButtonDisable",i.DEFAULT_SLIDER_BAR="defaultSliderBar",i.DEFAULT_SLIDER_BACKGROUND="defaultSliderBarBACKGROUND",i.DEFAULT_PANEL_BACKGROUND="defaultPanelBackground",e.DefaultSkinName=i,__reflect(i.prototype,"egret3d.gui.DefaultSkinName")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._nextIndex=0,this._textures=[];for(var r=0;r<e.MAX_COUNT;r++)this._textures[r]=t.CheckerboardTexture.texture}return e.prototype.register=function(t){return this._nextIndex>=e.MAX_COUNT?!1:this._textures.indexOf(t)>=0?!1:(this._textures[this._nextIndex]=t,t.guiIndex=this._nextIndex,this._nextIndex++,!0)},e.prototype.replace=function(t,r){if(0>r||r>=e.MAX_COUNT)throw new Error("index error");var i=this._textures[r];return this._textures[r]=t,i},e.prototype.activeTexture=function(t){for(var r=0;r<e.MAX_COUNT;r++)t.setTexture(r,this._textures[r])},e}();e.MAX_COUNT=7,t.GUITextureGroup=e,__reflect(e.prototype,"egret3d.GUITextureGroup")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._globalIndex=-1,r._boolArray=new t.BooleanArray,r}return __extends(r,e),Object.defineProperty(r.prototype,"texture",{get:function(){return this._texture},set:function(e){return e?void(e instanceof t.Texture&&this.setTexture(e)):void this.setTexture(e)},enumerable:!0,configurable:!0}),r.prototype.setTexture=function(t){t!==this._texture&&(this._texture=t,this._textureInvalid=!0)},r.prototype.updateVertices=function(e,i,a){if(i.sharedVertexBuffer&&i.sharedVertexBuffer.arrayBuffer){var n=this.globalPosition,o=(this.globalRotation,this.globalScale);this._globalIndex!=a&&(this._globalIndex=a,this._colorInvalid=this._transformInvalid=this._renderTextInvalid=this._textureInvalid=this._visibleInvalid=this._maskRectInvalid=!0,this._boolArray.clear()),this._visibleInvalid&&(this._visibleInvalid=!1,this._boolArray.setBoolean(r.FLAG_IS_VISIBLE,this.globalVisible)),this._boolArray.setBoolean(r.FLAG_VALLID_QUAD,!0);var s,l=0,h=i.vertexAttLength,u=i.sharedVertexBuffer.arrayBuffer;if(this._transformInvalid){this._transformInvalid=!1,s=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var c=0;4>c;c++)l=s+c*h,this._renderText?(u[l]=n.x>>0,u[l+1]=-n.y>>0):(u[l]=n.x,u[l+1]=-n.y);s=e*t.QuadData.quadVertexLen+t.QuadData.posOffest,l=s+0*h,u[l]=0,u[l+1]=0,l=s+1*h,u[l]=this.width,u[l+1]=0,l=s+2*h,u[l]=this.width,u[l+1]=-this.height,l=s+3*h,u[l]=0,u[l+1]=-this.height,s=e*t.QuadData.quadVertexLen+t.QuadData.uvRectangleOffest;for(var c=0;4>c;c++)l=s+c*h,u[l+2]=o.x,u[l+3]=o.y;var d=t.Quaternion.HELP_0;d.fromEulerAngles(this._globalRot.x,this._globalRot.y,this._globalRot.z),s=e*t.QuadData.quadVertexLen+t.QuadData.rotationOffest;for(var c=0;4>c;c++)l=s+c*h,u[l]=d.x,u[l+1]=d.y,u[l+2]=d.z,u[l+3]=d.w}if(this._renderTextInvalid&&(this._renderTextInvalid=!1,this._boolArray.setBoolean(r.FLAG_IS_TEXTFIELD,this._renderText)),this._textureInvalid){this._textureInvalid=!1,this._boolArray.setBoolean(r.FLAG_HAS_TEXTURE,null!=this._texture);var p,f=0;if(this._texture){p=this._texture.uvRectangle,f=this._texture.guiIndex,s=e*t.QuadData.quadVertexLen+t.QuadData.uvRectangleOffest,l=s+0*h,u[l]=p.x,u[l+1]=p.y,l=s+1*h,u[l]=p.x+p.width,u[l+1]=p.y,l=s+2*h,u[l]=p.x+p.width,u[l+1]=p.y+p.height,l=s+3*h,u[l]=p.x,u[l+1]=p.y+p.height,s=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var c=0;4>c;c++)l=s+c*h,u[l+2]=f}}if(this._maskRectInvalid){this._maskRectInvalid=!1;var m=this.globalMask;this._boolArray.setBoolean(r.FLAG_HAS_MASK,null!=m);var _,v,g,y;if(m){_=m.x,v=m.y,g=m.width,y=m.height,s=e*t.QuadData.quadVertexLen+t.QuadData.maskOffset;for(var c=0;4>c;c++)l=s+c*h,u[l+0]=_,u[l+1]=v,u[l+2]=g,u[l+3]=y}}if(this._colorInvalid){var x=this.globalColor.alpha,b=r.TempVector;this.globalColor.m44.transformVector(r.IdentityVector,b),s=e*t.QuadData.quadVertexLen+t.QuadData.colorOffest;for(var c=0;4>c;c++)l=s+c*h,u[l]=b.x,u[l+1]=b.y,u[l+2]=b.z,u[l+3]=x;this._colorInvalid=!1}if(this._boolArray.dirty){var D=this._boolArray.makeResult;s=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset;for(var c=0;4>c;c++)l=s+c*h,u[l+3]=D}}},r.prototype.onActiveStage=function(){e.prototype.onActiveStage.call(this),this._globalIndex=-1},r.clear=function(e,r){if(r.sharedVertexBuffer&&r.sharedVertexBuffer.arrayBuffer)for(var i,a=r.sharedVertexBuffer.arrayBuffer,n=e*t.QuadData.quadVertexLen+t.QuadData.originalOffset,o=0;4>o;o++)i=n+o*r.vertexAttLength,a[i+3]=0},r}(t.DisplayObject);e.FLAG_VALLID_QUAD=0,e.FLAG_IS_VISIBLE=1,e.FLAG_HAS_MASK=2,e.FLAG_HAS_TEXTURE=3,e.FLAG_IS_TEXTFIELD=4,e.IdentityVector=new t.Vector3D(1,1,1,1),e.TempVector=new t.Vector3D,e.DefaultUVRect=new t.Rectangle(0,0,1,1),t.Quad=e,__reflect(e.prototype,"egret3d.Quad")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.buildGeometry=function(r,i,a){var r=r;r.vertexFormat=t.VertexFormat.VF_QUAD_POS|t.VertexFormat.VF_QUAD_ORIGN|t.VertexFormat.VF_QUAD_UVREC|t.VertexFormat.VF_QUAD_ROTATION|t.VertexFormat.VF_QUAD_MASK|t.VertexFormat.VF_QUAD_COLOR;var n=new t.SubGeometry;r.vertexCount=4*a,r.indexCount=e.singleQuadIndex.length*a;for(var o=0,s=0,l=0;a>l;l++){o=l+i,e.singleQuadData[0*e.vertexLen+2]=o,e.singleQuadData[1*e.vertexLen+2]=o,e.singleQuadData[2*e.vertexLen+2]=o,e.singleQuadData[3*e.vertexLen+2]=o,s=4*l*r.vertexAttLength;for(var h=0;h<e.singleQuadData.length;h++)r.vertexArray[s+h]=e.singleQuadData[h];for(var u=0;u<e.singleQuadIndex.length;u++)r.indexArray[l*e.singleQuadIndex.length+u]=e.singleQuadIndex[u]+4*l}n.geometry=r,n.start=0,n.count=r.indexCount,r.subGeometrys.push(n),r.vertexAttLength=e.vertexLen},e}();e.singleQuadData=[0,0,1e5,0,0,0,0,0,0,0,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,1,0,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,1,1,1,1,0,0,0,1,-1,0,1,1,0,0,1,1,0,0,1e5,0,0,0,0,0,0,1,1,1,0,0,0,1,-1,0,1,1,0,0,1,1],e.vertexLen=24,e.posOffest=0,e.posSize=4,e.originalOffset=4,e.originalSize=4,e.uvRectangleOffest=8,e.uvRectangleSize=4,e.rotationOffest=12,e.rotationSize=4,e.maskOffset=16,e.maskSize=4,e.colorOffest=20,e.colorSize=4,e.singleQuadIndex=[0,2,1,0,3,2],e.vertexBytes=4*e.vertexLen,e.quadVertexLen=4*e.vertexLen,t.QuadData=e,__reflect(e.prototype,"egret3d.QuadData")
}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,new t.Geometry,new t.TextureMaterial)||this;return i.startQuad=0,i.numberQuad=0,i.quadList=[],i.startQuad=r,i.numberQuad=t.QuadStage.moreQuad,i.geometry.drawType=t.Context3DProxy.gl.DYNAMIC_DRAW,t.QuadData.buildGeometry(i.geometry,r,t.QuadStage.moreQuad),i.guiMethod=new t.GUIMethod,i.enableCulling=!1,i.uiMaterial=i.material,i.uiMaterial.blendMode=t.BlendMode.ALPHA,i.uiMaterial.repeat=!0,i.uiMaterial.diffusePass.addMethod(i.guiMethod),i.enablePick=!1,i.tag.name="gui",i}return __extends(r,e),r.prototype.setTexture=function(t,e){this.guiMethod.setTextures(t,e)},r}(t.Mesh);t.QuadMesh=e,__reflect(e.prototype,"egret3d.QuadMesh");var r=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.dispose=function(){},e}(t.Object3D);t.GUIRootContainer=r,__reflect(r.prototype,"egret3d.GUIRootContainer")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this)||this;return i._childList=[],i._quadMeshs=[],i._quadCurHistory=[],i._quadLastHistory=[],i._renderListInvalid=!1,i.x=0,i.y=0,i.width=0,i.height=0,i.quadList=[],i._view3D=r,i._guiEventFire=new t.GUIEventFire(i),i._textureGroup=new t.GUITextureGroup,i._guiContainer=new t.GUIRootContainer,i.changeCamera(),i}return __extends(r,e),r.prototype.registerTexture=function(t){return this._textureGroup.register(t)},r.prototype.changeCamera=function(){this._guiContainer.parent&&this._guiContainer.parent.removeChild(this._guiContainer),this._view3D.camera3D.addChild(this._guiContainer)},r.prototype.creatQuadMesh=function(){var e=new t.QuadMesh(this._quadMeshs.length*r.moreQuad);this._quadMeshs.push(e),this._guiContainer.addChild(e)},r.prototype.getChildQuads=function(e,r){var i,a,n=0;for(e instanceof t.Quad&&(a=e,r.push(a));n<e.childs.length;)i=e.childs[n++],this.getChildQuads(i,r)},r.prototype.addChild=function(t){if(!t)throw Error("This object is null");if(t.parent)throw Error("parent isn't null");this._childList.push(t),t.activeStage(this),t.parentIsStage=!0,this.setRenderListInvalid()},r.prototype.setRenderListInvalid=function(){this._renderListInvalid=!0},r.prototype.updateRenderList=function(){this.quadList.length=0;for(var t=0;t<this._childList.length;t++)this.getChildQuads(this._childList[t],this.quadList);if(this.quadList.length>this._quadMeshs.length*r.moreQuad)for(var e=Math.ceil(this.quadList.length/r.moreQuad)-this._quadMeshs.length,t=0;e>t;t++)this.creatQuadMesh()},r.prototype.removeChild=function(t){var e=this._childList.indexOf(t);-1!=e&&this._childList.splice(e,1),t.activeStage(null),t.parentIsStage=!1,this.setRenderListInvalid()},r.prototype.update=function(e,i,a,n){var o=this;o.x=n.x,o.y=n.y,o.width=n.width,o.height=n.height,this._renderListInvalid&&(this._renderListInvalid=!1,this.updateRenderList()),t.Context3DProxy.gl.disable(t.Context3DProxy.gl.DEPTH_TEST),t.Egret3DCanvas.context3DProxy.disAttribPointer();var s,l=o.quadList.length;for(s=0;l>s;s++)this.quadList[s].update(e,i);this._guiEventFire.fire();var h;for(s=0;l>s;s++)h=Math.floor(s/r.moreQuad),this.quadList[s].updateVertices(s%r.moreQuad,o._quadMeshs[h].geometry,s);this.clearInvalidVertices(l);var u;for(s=0;s<o._quadMeshs.length;s++)u=o._quadMeshs[s],u.geometry.upload(a,t.Context3DProxy.gl.DYNAMIC_DRAW),o._textureGroup.activeTexture(u);t.Context3DProxy.gl.enable(t.Context3DProxy.gl.DEPTH_TEST)},r.prototype.clearInvalidVertices=function(e){var i=this;this._quadCurHistory.length=0;for(var a=0;e>=r.moreQuad;)this._quadCurHistory[a]=r.moreQuad,e-=r.moreQuad,a++;e>0&&(i._quadCurHistory[a]=e),e=i._quadMeshs.length;var n=0,o=0;for(a=0;e>a;a++)if(n=i._quadLastHistory[a]||0,o=i._quadCurHistory[a]||0,n>o)for(var s=o;n>s;s++)t.Quad.clear(s,i._quadMeshs[a].geometry);var l=i._quadCurHistory;i._quadCurHistory=i._quadLastHistory,i._quadLastHistory=l},r}(t.EventDispatcher);e.moreQuad=400,t.QuadStage=e,__reflect(e.prototype,"egret3d.QuadStage")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.nextName="",this.crossA="",this.crossB="",this.blend_startFrame=0,this.blend_endFrame=0,this.crossB_startFrame=0,this.blendTime=0,this.blendStartTime=0,this.totalTime=0}return t}();t.CrossFadeNode=e,__reflect(e.prototype,"egret3d.CrossFadeNode");var r=function(){function t(){this._frameTime=0,this._frame=0,this._nextFrame=0,this._weight=0,this._offset=0,this._time=0,this._crossFades={}}return t.prototype.addCrossFadeNode=function(t){this._crossFades[t.crossA+t.crossB]=t},t.prototype.getNextAnim=function(){var t=this._crossFades.base;if(t)return"base";if(this._currentCrossFadeNode){if(""!=this._currentCrossFadeNode.nextName)return this._currentCrossFadeNode.nextName;if(""==this._currentCrossFadeNode.nextName&&this._currentCrossFadeNode.crossB_state.clip.isLoop)return this._currentCrossFadeNode.crossB}else console.warn("CrossFade: miss _currentCrossFadeNode!");return""},t.prototype.checkCrossFade=function(t,e,r){if(this._currentCrossFadeNode=this._crossFades[t+e],this._currentCrossFadeNode){var i=r[this._currentCrossFadeNode.crossA],a=r[this._currentCrossFadeNode.crossB];a.reStart(),this._currentCrossFadeNode.crossA_state=i,this._currentCrossFadeNode.crossB_state=a,this._currentCrossFadeNode.blendTime=33*(this._currentCrossFadeNode.blend_endFrame-this._currentCrossFadeNode.blend_startFrame),this._currentCrossFadeNode.blendStartTime=33*this._currentCrossFadeNode.blend_startFrame,this._currentCrossFadeNode.totalTime=Math.max(i.totalFrame,this._currentCrossFadeNode.crossB_startFrame+a.totalFrame)*i.clip.frameRate}return this._currentCrossFadeNode},t.prototype.update=function(t){},t}();t.CrossFade=r,__reflect(r.prototype,"egret3d.CrossFade")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(e){function r(){return e.call(this)||this}return __extends(r,e),r.prototype.getDefaultStyleNameByStyleName=function(e){var r={down:t.DefaultSkinName.DEFAULT_CHECK_BOX_DOWN,up:t.DefaultSkinName.DEFAULT_CHECK_BOX_UP,downAndSelected:t.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_DOWN,upAndSelected:t.DefaultSkinName.DEFAULT_CHECK_BOX_SELECTED_UP,disable:t.DefaultSkinName.DEFAULT_CHECK_BOX_DISABLE},i=r[e];return i||console.log(" ERROR!!! UICheckBox can't find default style : ",e),i},r}(t.UIToggleButtonBase);t.UICheckBox=e,__reflect(e.prototype,"egret3d.gui.UICheckBox")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.parent=null,this.index=0,this.parentIndex=-1,this.scale=new t.Vector3D(1,1,1),this.orientation=new t.Quaternion,this.translation=new t.Vector3D,this.localMatrix,this.worldMatrix,this.worldMatrixValid=!1}return e.prototype.buildLocalMatrix=function(e,r,i){this.scale.copyFrom(e),this.translation.copyFrom(i),r instanceof t.Vector3D?this.orientation.fromEulerAngles(r.x,r.y,r.z):this.orientation.copyFrom(r),this.worldMatrixValid=!1},e.prototype.buildInverseMatrix=function(e,r,i){this.inverseMatrix||(this.inverseMatrix=new t.Matrix4_4),r instanceof t.Vector3D?this.inverseMatrix.recompose([i,r,e]):this.inverseMatrix.makeTransform(i,e,r)},e.prototype.copyTo=function(e,r){switch(void 0===r&&(r=t.BindAnimType.all),r){case t.BindAnimType.all:e.localMatrix=this.worldMatrix}},e}();t.Joint=e,__reflect(e.prototype,"egret3d.Joint")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.joints=[]}return Object.defineProperty(t.prototype,"jointNum",{get:function(){return this.joints.length},enumerable:!0,configurable:!0}),t.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},t.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},t}();t.Skeleton=e,__reflect(e.prototype,"egret3d.Skeleton")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onRender=function(){},e.prototype.onUpdate=function(){},e.prototype.onEvent=function(){},e}(t.DisplayObject);e.UILayout=r,__reflect(r.prototype,"egret3d.gui.UILayout")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(e){function r(){var r=e.call(this)||this;return r._items=[],r._gap=5,r._selectedIndex=-1,r._selectedItem=null,r.addEventListener(t.MouseEvent3D.MOUSE_DOWN,r.onMouseDown,r),r._startDrag=!1,r._container.height=0,r}return __extends(r,e),r.prototype.onMouseDown=function(e){this._startDrag=!0,this.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this),this.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),this.stage&&this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)},r.prototype.onMouseUp=function(e){this._startDrag=!1,this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this),this.removeEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),this.stage&&this.stage.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)},r.prototype.onMouseMove=function(e){this._startDrag&&(this._container.y+=t.Input.mouseOffsetY,this._container.y>0?this._container.y=0:this._containerHeight<this.height?this._container.y=0:this._container.y<this.height-this._containerHeight&&(this._container.y=this.height-this._containerHeight))},r.prototype.updateView=function(){for(var t=0,e=0;e<this._items.length;e++){var r=this._items[e];r.y=t,t=r.y+r.height+this._gap}this._containerHeight=t},Object.defineProperty(r.prototype,"gap",{get:function(){return this._gap},set:function(t){this._gap=t,this.updateView()},enumerable:!0,configurable:!0}),r.prototype.addItem=function(t){this._items.push(t),this.addChildAt(t,this._container.childs.length),this.updateView()},r.prototype.removeItem=function(t){this.removeChild(t),this._items.splice(this._items.indexOf(t),1),this.updateView()},r}(t.gui.UIPanel);e.UIList=r,__reflect(r.prototype,"egret3d.gui.UIList")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.translate=0]="translate",t[t.rotation=1]="rotation",t[t.scale=2]="scale",t[t.translate_rotation=3]="translate_rotation",t[t.translate_scale=4]="translate_scale",t[t.all=5]="all"}(e=t.BindAnimType||(t.BindAnimType={}));var r=function(r){function i(e){void 0===e&&(e=null);var i=r.call(this)||this;return i.loopTime=0,i.animTime=0,i.speed=1,i.event3D=new t.AnimationEvent3D,i.isLoop=!0,i._loopTime=1,i._isPlay=!1,i._time=0,i._cacheTime=0,i._cycleEvent=new t.Event3D(t.AnimationEvent3D.CYCLE),i._completeEvent=new t.Event3D(t.AnimationEvent3D.COMPLETE),i._isPlay=!1,null==e&&(e=new t.SkeletonAnimationState),e.animation=i,i._skeletonAnimationState=e,i._movePosition=new t.Vector3D,i}return __extends(i,r),Object.defineProperty(i.prototype,"skeletonAnimationController",{get:function(){return this},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"state",{get:function(){return this._skeletonAnimationState},enumerable:!0,configurable:!0}),i.prototype.bindToJointPose=function(t,r,i){void 0===i&&(i=e.all),this._skeletonAnimationState.bindList=this._skeletonAnimationState.bindList||{},this._skeletonAnimationState.bindList[t]={node:r,type:i}},i.prototype.play=function(t,e,r,i){return void 0===e&&(e=1),void 0===r&&(r=!1),void 0===i&&(i=!0),this._skeletonAnimationState.play(t,e,r),this._isPlay=!0,!0},i.prototype.pause=function(){this._isPlay=!1},i.prototype.stop=function(){this._isPlay=!1},i.prototype.update=function(t,e,r){this._isPlay&&this._cacheTime!=t&&(this._cacheTime=t,this.time+=e,this._skeletonAnimationState.update(this.time,e))},Object.defineProperty(i.prototype,"time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),i.prototype.activeState=function(t,e,r,i,a,n,o){var s=this._skeletonAnimationState;s&&s.gpuSkeletonPose&&s.gpuSkeletonPose.updateGPUData(i.geometry.skeleton,i.geometry.skeletonGPUData,this._movePosition),r.uniform_time&&a.uniform1f(r.uniform_time.uniformIndex,t),r.uniform_PoseMatrix&&a.uniform4fv(r.uniform_PoseMatrix.uniformIndex,i.geometry.skeletonGPUData)},Object.defineProperty(i.prototype,"jointNum",{get:function(){return 48},enumerable:!0,configurable:!0}),i.prototype.isPlay=function(){return this._isPlay},i.prototype.clone=function(){var t=new i(this._skeletonAnimationState.clone());for(var e in t.state.animClip)t.state.animClip[e].animation=t;return t},i.prototype.addSkeletonAnimationClip=function(t){this.state.addAnimClip(t)},i.prototype.addAnimState=function(t){},i.prototype.removeAnimState=function(t){},i.prototype.addAnim=function(t){},i.prototype.dispatchCycle=function(){this.dispatchEvent(this._cycleEvent)},i.prototype.dispatchComplete=function(){this.dispatchEvent(this._completeEvent)},i}(t.EventDispatcher);r.fps=1e3/60,t.SkeletonAnimation=r,__reflect(r.prototype,"egret3d.SkeletonAnimation",["egret3d.IAnimation"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){var e=r.call(this)||this;return e._mask=new t.Rectangle,e._background=new t.Quad,e.addChild(e._background),e._bar=new t.Quad,e.addChild(e._bar),e._ratio=.5,e.updateStyle(),e}return __extends(i,r),Object.defineProperty(i.prototype,"ratio",{get:function(){return this._ratio},set:function(t){t>1?t=1:0>t&&(t=0),this._ratio=t,this.updateBar()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._background.width},set:function(t){this._background.width=this._bar.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._background.height},set:function(t){this._background.height=this._bar.height=t},enumerable:!0,configurable:!0}),i.prototype.setBarRect=function(t,e,r,i){this._bar.x=t,this._bar.y=e,this._bar.width=r,this._bar.height=i},Object.defineProperty(i.prototype,"bar",{get:function(){return this._bar},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"background",{get:function(){return this._background},enumerable:!0,configurable:!0}),i.prototype.updateBar=function(){this._mask.width=this._ratio*this._bar.width,this._mask.height=this._bar.height,this._bar.mask=this._mask},i.prototype.setStyle=function(t,e){r.prototype.setStyle.call(this,t,e),this.updateStyle(),this.updateBar()},i.prototype.getDefaultStyleNameByStyleName=function(t){var r={bar:e.DefaultSkinName.DEFAULT_PROGRESS_BAR,background:e.DefaultSkinName.DEFAULT_PROGRESS_BAR_BACKGROUND},i=r[t];return i||console.log(" ERROR!!! UISlider can't find default style : ",t),i},i.prototype.updateStyle=function(){this._background.texture=this.getStyle("background"),this._bar.texture=this.getStyle("bar")},i}(e.UIElement);e.UIProgressBar=r,__reflect(r.prototype,"egret3d.gui.UIProgressBar")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(e){function r(){return e.call(this)||this}return __extends(r,e),Object.defineProperty(r.prototype,"group",{set:function(t){this._group=t},enumerable:!0,configurable:!0}),r.prototype.getDefaultStyleNameByStyleName=function(e){var r={down:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_DOWN,up:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_UP,downAndSelected:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_DOWN,upAndSelected:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_SELECTED_UP,disable:t.DefaultSkinName.DEFAULT_RADIO_BUTTON_DISABLE},i=r[e];return i||console.log(" ERROR!!! UIRadioButton can't find default style : ",e),i},r}(t.UIToggleButtonBase);t.UIRadioButton=e,__reflect(e.prototype,"egret3d.gui.UIRadioButton")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(e){function r(){var t=e.call(this)||this;return t._items=[],t._enable=!0,t}return __extends(r,e),Object.defineProperty(r.prototype,"enable",{get:function(){return this._enable},set:function(t){if(this._enable!==t){this._enable=t;for(var e=0;e<this._items.length;e++){var r=this._items[e];r.enable=t}}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"selection",{get:function(){return this._selection},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"selectedIndex",{get:function(){return this._items.indexOf(this._selection)},set:function(t){var e=this._items[t];e&&(e.selected=!0)},enumerable:!0,configurable:!0}),r.prototype.addItem=function(e){this._items.push(e),e.enable=this._enable,e.addEventListener(t.Event3D.CHANGE,this.onItemChange,this)},r.prototype.removeItem=function(e){var r=this._items.indexOf(e);-1!==r&&(e.removeEventListener(t.Event3D.CHANGE,this.onItemChange,this),this._items.splice(r,1))},r.prototype.getRadioButtonAt=function(t){return this._items[t]},r.prototype.onItemChange=function(t){var e=t.target;this.changeSelectedItem(e)},r.prototype.changeSelectedItem=function(e){if(e.selected!==!1&&this._selection!==e){this._selection&&(this._selection.selected=!1),this._selection=e;var r=new t.Event3D(t.Event3D.CHANGE);r.target=this,this.dispatchEvent(r)}},r}(t.EventDispatcher);e.UIRadioButtonGroup=r,__reflect(r.prototype,"egret3d.gui.UIRadioButtonGroup")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r=function(r){function i(){var i=r.call(this)||this;return i._background=new t.Quad,i._bar=new t.Quad,i._text=new e.UITextField(e.UITextFieldType.DYNAMIC),i._text.autoSize=e.UITextFieldAutoSize.CENTER,i._text.textColor=4278190080,i.addChild(i._background),i.addChild(i._bar),i.addChild(i._text),i._minimum=0,i._maximum=100,i._snapInterval=10,i.value=50,i.addEventListener(t.MouseEvent3D.MOUSE_DOWN,i.onMouseDown,i),i.drawTexture(),i}return __extends(i,r),i.prototype.setStyle=function(t,e){r.prototype.setStyle.call(this,t,e),this.drawTexture(),this.onRender()},i.prototype.drawTexture=function(){this._bar.texture=this.getStyle("bar"),this._background.texture=this.getStyle("background")},i.prototype.getDefaultStyleNameByStyleName=function(t){var r={bar:e.DefaultSkinName.DEFAULT_SLIDER_BAR,background:e.DefaultSkinName.DEFAULT_SLIDER_BACKGROUND},i=r[t];return i||console.log(" ERROR!!! UISlider can't find default style : ",t),i},i.prototype.onMouseUp=function(e){this.removeEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),this.removeEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this)},i.prototype.onMouseDown=function(e){this.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),this.stage&&this.stage.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this);var r=this.mouseX;this.value=r/this._background.width*(this._maximum-this._minimum)+this._minimum},i.prototype.updateBar=function(){var t=Math.abs((this._value-this._minimum)/(this._maximum-this._minimum));this._bar.width=this._background.width*t,this._text.text=this.value.toString()},Object.defineProperty(i.prototype,"snapInterval",{get:function(){return this._snapInterval},set:function(t){this._snapInterval=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"value",{get:function(){return this._value},set:function(e){if(e%this._snapInterval!==0&&(e=Math.round(e/this._snapInterval)*this._snapInterval),this._value!==e){this._value=e;var r=new t.Event3D(t.Event3D.CHANGE);this.dispatchEvent(r),this.updateBar()}},enumerable:!0,configurable:!0}),i.prototype.onMouseMove=function(t){var e=this.mouseX;this.value=e/this._background.width*(this._maximum-this._minimum)+this._minimum},Object.defineProperty(i.prototype,"maximum",{get:function(){return this._maximum},set:function(t){this._maximum=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minimum",{get:function(){return this._minimum},set:function(t){this._minimum=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._background.width},set:function(t){this._background.width=this._text.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._background.height},set:function(t){this._background.height=this._text.height=this._bar.height=t},enumerable:!0,configurable:!0}),i}(e.UIElement);e.UISlider=r,__reflect(r.prototype,"egret3d.gui.UISlider")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var r;!function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.CENTER=3]="CENTER"}(r=e.UITextFieldAutoSize||(e.UITextFieldAutoSize={}));var i;!function(t){t[t.DYNAMIC=0]="DYNAMIC",t[t.INPUT=1]="INPUT"}(i=e.UITextFieldType||(e.UITextFieldType={}));var a=function(){function t(){}return t}();__reflect(a.prototype,"TextLineInfo");var n;!function(t){t[t.CENTER=0]="CENTER",t[t.JUSTIFY=1]="JUSTIFY",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT"}(n=e.UITextFormatAlign||(e.UITextFormatAlign={}));var o=function(){function t(){}return t}();e.UITextFormat=o,__reflect(o.prototype,"egret3d.gui.UITextFormat");var s=function(n){function o(e){void 0===e&&(e=i.DYNAMIC);var a=n.call(this)||this;return a._textLineInfo=[],a._text="",a._maxChars=0,a._restrict="",a._textWidth=0,a._textLine=[],a._quadPool=[],a._textHeight=0,a._fontQuadLine=[],a._multiline=!1,a._selectable=!1,a._type=e,a._textColor=52224,a._selectionEndIndex=-1,a._selectionBeginIndex=-1,a._displayAsPassword=!1,a._autoSize=r.LEFT,a._fontQuadPanel=new t.DisplayObject,a._blankQuad=a.createFontQuad("b".charCodeAt(0),!1),o.sharedHTMLInputElement||(o.sharedHTMLInputElement=document.createElement("input"),o.sharedHTMLInputElement.style.width=a.width+"px",o.sharedHTMLInputElement.style.height=a.height+"px",o.sharedHTMLInputElement.hidden=!0,o.sharedHTMLInputElement.style.color="#00ff00",o.sharedHTMLInputElement.style.border="0px",o.sharedHTMLInputElement.style.backgroundColor="transparent",document.getElementById("egret3D").parentElement.appendChild(o.sharedHTMLInputElement)),o.sharedHTMLTextAreaElement||(o.sharedHTMLTextAreaElement=document.createElement("textarea"),o.sharedHTMLTextAreaElement.style.width=a.width+"px",o.sharedHTMLTextAreaElement.style.height=a.height+"px",o.sharedHTMLTextAreaElement.hidden=!0,o.sharedHTMLTextAreaElement.style.color="#00ff00",o.sharedHTMLTextAreaElement.style.paddingLeft="0px",o.sharedHTMLTextAreaElement.style.paddingTop="0px",o.sharedHTMLTextAreaElement.style.margin="0px",o.sharedHTMLTextAreaElement.style.backgroundColor="transparent",document.getElementById("egret3D").parentElement.appendChild(o.sharedHTMLTextAreaElement)),a._bgQuad=new t.Quad,i.INPUT==a._type&&(a._bgQuad.mouseEnable=!0,a._bgQuad.width=a.width,a._bgQuad.height=a.height,a.addChild(a._bgQuad),a._bgQuad.addEventListener(t.TouchEvent3D.TOUCH_START,a.onShowInputAgent,a),a._bgQuad.addEventListener(t.MouseEvent3D.MOUSE_CLICK,a.onShowInputAgent,a)),a.width=100,a.height=20,a.addChild(a._fontQuadPanel),a}return __extends(o,n),o.prototype.onShowInputAgent=function(t){var e=this;this._multiline?(o.sharedHTMLTextAreaElement.hidden=!1,o.sharedHTMLTextAreaElement.style.position="absolute",o.sharedHTMLTextAreaElement.style.left=this.x+"px",o.sharedHTMLTextAreaElement.style.top=this.y+"px",o.sharedHTMLTextAreaElement.style.width=this.width+"px",o.sharedHTMLTextAreaElement.style.height=this.height+"px",o.sharedHTMLTextAreaElement.value=this._text,o.sharedHTMLTextAreaElement.focus(),o.sharedHTMLTextAreaElement.onblur=function(t){return e.onSharedHTMLTextLoseFocus(t)}):(o.sharedHTMLInputElement.hidden=!1,o.sharedHTMLInputElement.style.position="absolute",o.sharedHTMLInputElement.style.left=this.x+"px",o.sharedHTMLInputElement.style.top=this.y+"px",o.sharedHTMLInputElement.style.width=this.width+"px",o.sharedHTMLInputElement.style.height=this.height+"px",o.sharedHTMLInputElement.value=this._text,o.sharedHTMLInputElement.focus(),o.sharedHTMLInputElement.onblur=function(t){return e.onSharedHTMLTextLoseFocus(t)}),this._fontQuadPanel.visible=!1},o.prototype.onSharedHTMLTextLoseFocus=function(t){this.text=this._multiline?o.sharedHTMLTextAreaElement.value:o.sharedHTMLInputElement.value,o.sharedHTMLInputElement.onblur=o.sharedHTMLTextAreaElement.onblur=null,o.sharedHTMLInputElement.hidden=o.sharedHTMLTextAreaElement.hidden=!0,this._fontQuadPanel.visible=!0},Object.defineProperty(o.prototype,"width",{get:function(){return this._sca.z},set:function(t){t!=this._sca.z&&(this._fontQuadPanel.width=t,this._sca.z=t,this._transformChange=!0,this._bgQuad.width=t,this.refreshAlign())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"height",{get:function(){return this._sca.w},set:function(t){t!=this._sca.w&&(this._fontQuadPanel.height=t,this._sca.w=t,this._transformChange=!0,this._bgQuad.height=t,this.refreshAlign())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"displayAsPassword",{get:function(){return this._displayAsPassword},set:function(t){this._displayAsPassword=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"length",{get:function(){return this._text.length},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"maxChars",{get:function(){return this._maxChars},set:function(t){this._maxChars=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"multiline",{get:function(){return this._multiline},set:function(t){this._multiline=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"restrict",{get:function(){return this._restrict},set:function(t){this._restrict=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"selectable",{get:function(){return this._selectable},set:function(t){this._selectable=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"selectionBeginIndex",{get:function(){return this._selectionBeginIndex},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"selectionEndIndex",{get:function(){return this._selectionEndIndex},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"textColor",{get:function(){return this._textColor},set:function(t){this._textColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"textWidth",{get:function(){return this._textWidth},set:function(t){this._textWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"textHeight",{get:function(){return this._textHeight},set:function(t){this._textHeight=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(t){this.clearText(),this._text=t,this._textLine=t.split("\n"),this._multiline||(this._textLine[0]=this._textLine.join(""),this._textLine.length=1);for(var e=null,r=0;r<this._textLine.length;++r){var i=this._textLine[r];e=this.buildTextLineInfo(i),this._textLineInfo.push(e)}this.refreshAlign()},enumerable:!0,configurable:!0}),o.prototype.clearText=function(){for(var t=null,e=0;e<this._textLineInfo.length;++e){t=this._textLineInfo[e];for(var r=0;r<t.lineQuads.length;++r)this.deleteFontQuad(t.lineQuads[r]);t.lineQuads=null}this._textLineInfo=[]},Object.defineProperty(o.prototype,"autoSize",{get:function(){return this._autoSize},set:function(t){this._autoSize=t},enumerable:!0,configurable:!0}),o.prototype.refreshAlign=function(){var t,e,i=null,a=null;if(this._autoSize==r.LEFT){e=0,!this.multiline&&this._textLineInfo.length>=1&&(e=this.height/2-this._textLineInfo[0].lineHeight/2);for(var n=0;n<this._textLineInfo.length;++n){a=this._textLineInfo[n],t=0;for(var o=0;o<a.lineQuads.length;++o)i=a.lineQuads[o],i.x=t,i.y=e,t+=i.width,i.visible=i.x+i.width<=this.width;e+=a.lineHeight}}else if(this._autoSize==r.RIGHT){e=0,!this.multiline&&this._textLineInfo.length>=1&&(e=this.height/2-this._textLineInfo[0].lineHeight/2);for(var n=0;n<this._textLineInfo.length;++n){a=this._textLineInfo[n],t=this.width;for(var o=a.lineQuads.length-1;o>=0;--o)i=a.lineQuads[o],i.x=t-=i.width,i.y=e,i.visible=i.x+i.width>0;e+=a.lineHeight}}else if(this._autoSize==r.CENTER){e=0,!this.multiline&&this._textLineInfo.length>=1&&(e=this.height/2-this._textLineInfo[0].lineHeight/2);for(var n=0;n<this._textLineInfo.length;++n){a=this._textLineInfo[n],t=.5*this.width-.5*a.lineWidth;for(var o=0;o<a.lineQuads.length;++o)i=a.lineQuads[o],i.x=t,i.y=e,t+=i.width,i.visible=i.x+i.width<=this.width&&i.x+i.width>0;e+=a.lineHeight}}},o.prototype.buildTextLineInfo=function(t){var e=new a;e.lineText=t,e.lineWidth=0,e.lineHeight=0,e.lineQuads=[];for(var r=0;r<t.length;++r){var i=null,n=t.charCodeAt(r);i=32!=n?this.createFontQuad(n):this._blankQuad,e.lineQuads.push(i),e.lineWidth+=i.width,e.lineHeight<i.height&&(e.lineHeight=i.height)}return e},o.prototype.appendText=function(t){},o.prototype.getCharBoundaries=function(t){return null},o.prototype.getCharIndexAtPoint=function(t,e){return 0},o.prototype.replaceSelectedText=function(t){},o.prototype.replaceText=function(t,e,r){},o.prototype.setSelection=function(t,e){},o.prototype.createFontQuad=function(r,i){void 0===i&&(i=!0);var a;this._quadPool.length>0?(a=this._quadPool[this._quadPool.length-1],this._quadPool.splice(this._quadPool.length-1,1)):(a=new t.Quad,a.renderText=!0);var n=e.BitmapFont.getTexture(r);return n||(n=e.BitmapFont.getTexture("?".charCodeAt(0))),a.width=n.width,a.height=n.height,a.texture=n,a.color=this._textColor,i&&this._fontQuadPanel.addChild(a),a},o.prototype.deleteFontQuad=function(t){this._blankQuad!=t&&(this._fontQuadPanel.removeChild(t),this._quadPool.push(t))},o}(t.DisplayObject);e.UITextField=s,__reflect(s.prototype,"egret3d.gui.UITextField")}(e=t.gui||(t.gui={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.poseArray=[],this.boneNameArray=[],this.animationName="",this.isLoop=!1,this.sampling=0,this.boneCount=0,this.frameDataOffset=0,this.totalFrame=0,this.totalTime=0,this.frameRate=33,this.loopPose=!1,this.cycleOffset=0,this.sourceData=null,this._skeletonPose=null,this._temp_scale=new t.Vector3D,this._temp_translation=new t.Vector3D,this._temp_orientation=new t.Quaternion,this._cacheAnimationClip=null}return Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonPose},enumerable:!0,configurable:!0}),e.prototype.findJointIndex=function(t){return this._skeletonPose?this._skeletonPose.findJointIndex(t):this.poseArray.length<=0?-1:this.poseArray[0].findJointIndex(t)},e.prototype.addSkeletonPose=function(t){this.poseArray.push(t)},e.prototype.buildInitialSkeleton=function(e,r,i){if(!this._skeletonPose){this._skeletonPose=new t.SkeletonPose,this._skeletonPose.boneNameArray=e;for(var a=0;a<this.boneCount;a++){var n=new t.Joint;n.index=a,n.parentIndex=t.EAMVersion.findNameIndex(e,r[a]),this._skeletonPose.joints.push(n)}}},e.prototype.getSkeletonPose=function(t){return this.poseArray.length>0&&this.poseArray.length>t?this.poseArray[t]:null},e.prototype.readSkeletonPose=function(t,e){this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*t,e.frameTime=this.sourceData.readInt()/60/80*1e3;for(var r=0;r<this.boneCount;r++)this._temp_orientation.x=this.sourceData.readFloat(),this._temp_orientation.y=this.sourceData.readFloat(),this._temp_orientation.z=this.sourceData.readFloat(),this._temp_orientation.w=this.sourceData.readFloat(),this._temp_scale.x=this.sourceData.readFloat(),this._temp_scale.y=this.sourceData.readFloat(),this._temp_scale.z=this.sourceData.readFloat(),this._temp_translation.x=this.sourceData.readFloat(),this._temp_translation.y=this.sourceData.readFloat(),this._temp_translation.z=this.sourceData.readFloat(),e.joints[r].worldMatrixValid=!1,e.joints[r].buildLocalMatrix(this._temp_scale,this._temp_orientation,this._temp_translation);return e.calculateJointWorldMatrix(),e},Object.defineProperty(e.prototype,"jointNum",{get:function(){return this.poseArray.length>0?this.poseArray[0].joints.length:this.boneCount},enumerable:!0,configurable:!0}),e}();t.SkeletonAnimationClip=e,__reflect(e.prototype,"egret3d.SkeletonAnimationClip")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,r,i,a){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=100),void 0===a&&(a=100),this._rectangle=new t.Rectangle,this._transformMatrix=new t.Matrix4_4,this._change=!1,this._rotation=new t.Vector3D,this._scale=new t.Vector3D(1,1,1),this._position=new t.Vector3D,this._transformComponents=[],this._changeTexture=!1,this._textureStage=!1,this._vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0,this._uv_scale=new Float32Array(2),this.name="",this.bothside=!1,this.cullMode=t.ContextConfig.BACK,this.visible=!0,this.vsShader="hud_vs",this.fsShader="hud_V_fs",this._passUsage=new t.PassUsage,this._attList=new Array,this.uniformData={},this._transformComponents.push(this._position),this._transformComponents.push(this._rotation),this._transformComponents.push(this._scale),this.x=e,this.y=r,this.width=i,this.height=a,this._uv_scale[0]=1,this._uv_scale[1]=1
}return Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this._diffuseTexture},set:function(t){this._changeTexture=!0,this._diffuseTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._rectangle.x},set:function(t){this._change=!0,this._rectangle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._rectangle.y},set:function(t){this._change=!0,this._rectangle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._rectangle.width},set:function(t){this._change=!0,this._rectangle.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._rectangle.height},set:function(t){this._change=!0,this._rectangle.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{get:function(){return this._rotation.x},set:function(t){this._change=!0,this._rotation.x!=t&&(this._rotation.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotation.y},set:function(t){this._change=!0,this._rotation.y!=t&&(this._rotation.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{get:function(){return this._rotation.z},set:function(t){this._change=!0,this._rotation.z!=t&&(this._rotation.z=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewPort",{set:function(t){this._viewPort=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uScale",{get:function(){return this._uv_scale[0]},set:function(t){this._uv_scale[0]=t,this._uv_scale[0]>1&&(this._uv_scale[0]=1),this._uv_scale[0]<0&&(this._uv_scale[0]=0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vScale",{get:function(){return this._uv_scale[1]},set:function(t){this._uv_scale[1]=t,this._uv_scale[1]>1&&(this._uv_scale[1]=1),this._uv_scale[1]<0&&(this._uv_scale[1]=0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transformMatrix",{get:function(){return this._viewPort?(this._change&&(this._scale.x=this._rectangle.width/this._viewPort.width,this._scale.y=this._rectangle.height/this._viewPort.height,this._position.x=t.MathUtil.ScreenToPosition(this._rectangle.x,this._rectangle.width,this._viewPort.width),this._position.y=-t.MathUtil.ScreenToPosition(this._rectangle.y,this._rectangle.height,this._viewPort.height),this._transformMatrix.recompose(this._transformComponents),this._change=!1),this._transformMatrix):this._transformMatrix},enumerable:!0,configurable:!0}),e.prototype.updateTexture=function(t){var e;for(var r in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[r],e.uniformIndex=t.getUniformLocation(this._passUsage.program3D,e.varName),e.texture=this[e.varName];this._changeTexture=!1},e.prototype.upload=function(r){var i=this;i._vertexBuffer3D||(i._vertexBuffer3D=r.creatVertexBuffer(e.singleQuadData)),i._indexBuffer3D||(i._indexBuffer3D=r.creatIndexBuffer(e.singleQuadIndex)),i._passUsage.vertexShader.shaderType=t.Shader.vertex,i._passUsage.fragmentShader.shaderType=t.Shader.fragment,i._passUsage.vertexShader.addUseShaderName(i.vsShader),i._passUsage.fragmentShader.addUseShaderName(i.fsShader),i._passUsage.vertexShader.shader=i._passUsage.vertexShader.getShader(i._passUsage),i._passUsage.fragmentShader.shader=i._passUsage.fragmentShader.getShader(i._passUsage),i._passUsage.program3D=t.ShaderPool.getProgram(i._passUsage.vertexShader.shader.id,i._passUsage.fragmentShader.shader.id);for(var a in i._passUsage)-1!=a.indexOf("uniform")&&i._passUsage[a]&&(i._passUsage[a].uniformIndex=r.getUniformLocation(i._passUsage.program3D,a));for(var n in i.uniformData){var o=i.uniformData[n];o.uniformIndex=r.getUniformLocation(i._passUsage.program3D,n)}i._attList.length=0;var s=0;i._passUsage.attribute_position&&(i._passUsage.attribute_position.uniformIndex||(i._passUsage.attribute_position.uniformIndex=r.getShaderAttribLocation(i._passUsage.program3D,i._passUsage.attribute_position.varName)),i._attList.push(i._passUsage.attribute_position),i._passUsage.attribute_position.size=t.Geometry.positionSize,i._passUsage.attribute_position.dataType=t.ContextConfig.FLOAT,i._passUsage.attribute_position.normalized=!1,i._passUsage.attribute_position.stride=e.vertexBytes,i._passUsage.attribute_position.offset=s,s+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),i._passUsage.attribute_uv0&&(i._passUsage.attribute_uv0.uniformIndex||(i._passUsage.attribute_uv0.uniformIndex=r.getShaderAttribLocation(i._passUsage.program3D,i._passUsage.attribute_uv0.varName)),i._attList.push(i._passUsage.attribute_uv0),i._passUsage.attribute_uv0.size=t.Geometry.uvSize,i._passUsage.attribute_uv0.dataType=t.ContextConfig.FLOAT,i._passUsage.attribute_uv0.normalized=!1,i._passUsage.attribute_uv0.stride=e.vertexBytes,i._passUsage.attribute_uv0.offset=s,s+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),i._passUsage.uv_scale=r.getUniformLocation(i._passUsage.program3D,"uv_scale")},e.prototype.draw=function(e,r){void 0===r&&(r=null);var i=this;if(i.visible){i._passUsage.program3D||i.upload(e),e.setProgram(i._passUsage.program3D),e.bindVertexBuffer(i._vertexBuffer3D),e.bindIndexBuffer(i._indexBuffer3D);for(var a=0;a<i._attList.length;++a){var n=i._attList[a];n.uniformIndex>=0&&e.vertexAttribPointer(n.uniformIndex,n.size,n.dataType,n.normalized,n.stride,n.offset)}i._changeTexture&&i.updateTexture(e);for(var o in i.uniformData){var s=i.uniformData[o];switch(s.type){case t.UniformType.uniform1f:e.uniform1f(s.uniformIndex,s.data[0]);break;case t.UniformType.uniform1fv:e.uniform1fv(s.uniformIndex,s.data);break;case t.UniformType.uniform2f:e.uniform2f(s.uniformIndex,s.data[0],s.data[1]);break;case t.UniformType.uniform2fv:e.uniform2fv(s.uniformIndex,s.data);break;case t.UniformType.uniform3f:e.uniform3f(s.uniformIndex,s.data[0],s.data[1],s.data[2]);break;case t.UniformType.uniform3fv:e.uniform3fv(s.uniformIndex,s.data);break;case t.UniformType.uniform4f:e.uniform4f(s.uniformIndex,s.data[0],s.data[1],s.data[2],s.data[3]);break;case t.UniformType.uniform4fv:e.uniform4fv(s.uniformIndex,s.data)}}var l;for(var h in i._passUsage.sampler2DList)l=i._passUsage.sampler2DList[h],l.texture&&(l.texture.upload(e),e.setTexture2DAt(l.activeTextureIndex,l.uniformIndex,l.index,l.texture.texture2D),l.texture.activeState(e),i._textureStage=!1);i._passUsage.uniform_ViewProjectionMatrix&&e.uniformMatrix4fv(i._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,i.transformMatrix.rawData),i._passUsage.uniform_ViewMatrix&&r&&e.uniformMatrix4fv(i._passUsage.uniform_ViewMatrix.uniformIndex,!1,r.viewMatrix.rawData),i._passUsage.uniform_ProjectionMatrix&&r&&e.uniformMatrix4fv(i._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,r.projectMatrix.rawData),i._passUsage.uv_scale&&-1!=this._passUsage.uv_scale&&e.uniform2f(i._passUsage.uv_scale,i._uv_scale[0],i._uv_scale[1]),e.setCulling(i.cullMode),i.bothside?e.disableCullFace():e.enableCullFace(),e.enableBlend(),e.setBlendFactors(t.ContextConfig.SRC_ALPHA,t.ContextConfig.ONE_MINUS_SRC_ALPHA),e.drawElement(t.DrawMode.TRIANGLES,0,6),e.clear(t.ContextConfig.DEPTH_BUFFER_BIT)}},e}();e.singleQuadData=new Float32Array([-1,-1,0,0,1,1,-1,0,1,1,1,1,0,1,0,-1,1,0,0,0]),e.singleQuadIndex=new Uint16Array([0,1,2,0,2,3]),e.vertexBytes=20,t.HUD=e,__reflect(e.prototype,"egret3d.HUD")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this.canvasX=r.getX(t.clientX),this.canvasY=r.getY(t.clientY),this.identifier=t.identifier,this.clientX=t.clientX,this.clientY=t.clientY,this.pageX=t.pageX,this.pageY=t.pageY,this.screenX=t.screenX,this.screenY=t.screenY}return t}();t.TouchData=e,__reflect(e.prototype,"egret3d.TouchData");var r=function(r){function i(){var e=r.call(this)||this;return e._time=0,e._keyStatus={},e._mouseStatus={},e._isTouchStart=!1,e._mouseEvent3d=new t.MouseEvent3D,e._keyEvent3d=new t.KeyEvent3D,e._touchEvent3d=new t.TouchEvent3D,e._windowsEvent3d=new t.Event3D,e._orientationEvent3d=new t.OrientationEvent3D,e.onGamepadStick1=null,e.onGamepadStick2=null,e.disableWindowTouch=!1,e._gp=!1,e._oldPosition1=null,e._oldPosition2=null,window.addEventListener("click",function(t){!e.disableWindowTouch&&e.mouseClick(t)},!0),window.addEventListener("mousedown",function(t){!e.disableWindowTouch&&e.mouseStart(t)},!0),window.addEventListener("mouseup",function(t){!e.disableWindowTouch&&e.mouseEnd(t)},!0),window.addEventListener("mousewheel",function(t){!e.disableWindowTouch&&e.mouseWheel(t)},!0),window.addEventListener("mousemove",function(t){!e.disableWindowTouch&&e.mouseMove(t)},!0),window.addEventListener("mouseover",function(t){!e.disableWindowTouch&&e.mouseOver(t)},!0),window.addEventListener("keydown",function(t){return e.keyDown(t)},!0),window.addEventListener("keyup",function(t){return e.keyUp(t)},!0),e.canGame()&&(window.addEventListener("gamepadconnected",function(t){return e.ongamepadconnected(t)},!0),window.addEventListener("gamepaddisconnected",function(t){return e.ongamepaddisconnected(t)},!0)),window.addEventListener("touchstart",function(t){!e.disableWindowTouch&&e.touchStart(t)},!0),window.addEventListener("touchend",function(t){!e.disableWindowTouch&&e.touchEnd(t)},!0),window.addEventListener("touchmove",function(t){!e.disableWindowTouch&&e.touchMove(t)},!0),window.addEventListener("touchcancel",function(t){!e.disableWindowTouch&&e.touchEnd(t)},!0),window.addEventListener("resize",function(t){return e.onWindowsResize(t)},!0),e}return __extends(i,r),i.getX=function(t){return(t-i.canvas.x+i.canvas.offsetX)/i.scaleX},i.getY=function(t){return(t-i.canvas.y+i.canvas.offsetY)/i.scaleY},Object.defineProperty(i,"instance",{get:function(){return null==this._instance&&(this._instance=new i),this._instance},enumerable:!0,configurable:!0}),i.prototype.init=function(t){var e=this;this.disableWindowTouch=!0,t.addEventListener("click",function(t){return e.mouseClick(t)},!1),t.addEventListener("mousedown",function(t){return e.mouseStart(t)},!1),t.addEventListener("mouseup",function(t){return e.mouseEnd(t)},!1),t.addEventListener("mousewheel",function(t){return e.mouseWheel(t)},!1),t.addEventListener("mousemove",function(t){return e.mouseMove(t)},!1),t.addEventListener("mouseover",function(t){return e.mouseOver(t)},!1),t.addEventListener("touchstart",function(t){return e.touchStart(t)},!1),t.addEventListener("touchend",function(t){return e.touchEnd(t)},!1),t.addEventListener("touchmove",function(t){return e.touchMove(t)},!1),t.addEventListener("touchcancel",function(t){return e.touchEnd(t)},!1)},i.addEventListener=function(t,e,r,a,n){return void 0===a&&(a=null),void 0===n&&(n=0),i.instance.addEventListener(t,e,r,a,n)},i.prototype.addEventListener=function(e,i,a,n,o){var s=this;void 0===n&&(n=null),void 0===o&&(o=0),e!=t.OrientationEvent3D.ORIENTATION_CHANGE||this.containEventListener(t.OrientationEvent3D.ORIENTATION_CHANGE)?e!=t.OrientationEvent3D.DEVICE_MOTION||this.containEventListener(t.OrientationEvent3D.DEVICE_MOTION)?e!=t.OrientationEvent3D.DEVICE_ORIENTATION||this.containEventListener(t.OrientationEvent3D.DEVICE_ORIENTATION)||window.addEventListener("deviceorientation",function(t){return s.onDeviceOrientation(t)},!0):window.addEventListener("devicemotion",function(t){return s.onDeviceMotion(t)},!0):window.addEventListener("orientationchange",function(t){return s.onOrientationChange(t)},!0);var l=r.prototype.addEventListener.call(this,e,i,a,n,o);return l},i.removeEventListener=function(t,e,r){i.instance.removeEventListener(t,e,r)},i.removeEventListenerAt=function(t){i.instance.removeEventListenerAt(t)},i.getKeyPress=function(t){return i.instance._keyStatus[t]},i.getMousePress=function(t){return i.instance._mouseStatus[t]},i.prototype.ongamepaddisconnected=function(t){this._gp=!1},i.prototype.ongamepadconnected=function(t){this._gp=!0},i.prototype.getGamepadButtonState=function(t){return navigator.getGamepads()[0].buttons[t].pressed},i.prototype.getGamepadStick1=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[0],navigator.getGamepads()[0].axes[1],0)},i.prototype.getGamepadStick2=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[2],navigator.getGamepads()[0].axes[3],0)},i.prototype.canGame=function(){return"getGamepads"in navigator},i.reportOnGamepad=function(){i.instance.canGame()&&i.instance._gp&&(null!=i.instance.onGamepadStick1&&i.instance.onGamepadStick1(i.instance.getGamepadStick1()),null!=i.instance.onGamepadStick2&&i.instance.onGamepadStick2(i.instance.getGamepadStick2()))},i.prototype.printout=function(){var t="";t+="id: "+navigator.getGamepads()[0].id+"<br/>";for(var e=navigator.getGamepads()[0].buttons.length,r=0;e>r;r++)t+="Button "+(r+1)+": ",this.getGamepadButtonState(r)&&(t+=" pressed"),t+="<br/>";var i=this.getGamepadStick1();t+="Stick 1: "+i.x+","+i.y+"<br/>",i=this.getGamepadStick2(),t+="Stick 2: "+i.x+","+i.y+"<br/>"},i.prototype.onPinch=function(e,r,i,a){this._oldPosition1=new t.Point(e,r),this._oldPosition2=new t.Point(i,a)},i.prototype.onSwipe=function(t,e){i.mouseX=t,i.mouseY=e,this._oldPosition1=null,this._oldPosition2=null,this._time=(new Date).getTime()},i.prototype.touchStart=function(e){if(this.deliverMessage()){var r=i.getX(e.targetTouches[0].clientX),a=i.getY(e.targetTouches[0].clientY);if(2==e.targetTouches.length){var n=i.getX(e.targetTouches[1].clientX),o=i.getY(e.targetTouches[1].clientY);this.onPinch(r,a,n,o)}else 1==e.targetTouches.length&&(this.onSwipe(r,a),this._mouseStatus[t.MouseCode.Mouse_Left]=!0);this._touchEvent3d.reset(),this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches),this._touchEvent3d.target=this,this._isTouchStart||(this._isTouchStart=!0,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_START,this.dispatchEvent(this._touchEvent3d))}},i.prototype.touchEnd=function(e){if(e.targetTouches.length>1){var r=i.getX(e.targetTouches[0].clientX),a=i.getY(e.targetTouches[0].clientY),n=i.getX(e.targetTouches[1].clientX),o=i.getY(e.targetTouches[1].clientY);this.onPinch(r,a,n,o)}else 1==e.targetTouches.length?(this.onSwipe(i.getX(e.targetTouches[0].clientX),i.getY(e.targetTouches[0].clientY)),this._mouseStatus[t.MouseCode.Mouse_Left]=!1):(this._oldPosition1=null,this._oldPosition2=null,this._time=0);this._touchEvent3d.reset(),this._isTouchStart=!1,this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches),this._touchEvent3d.target=this,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_END,this.dispatchEvent(this._touchEvent3d)},i.prototype.touchMove=function(e){if(i.mouseLastX=i.mouseX,i.mouseLastY=i.mouseY,i.mouseX=i.getX(e.targetTouches[0].clientX),i.mouseY=i.getY(e.targetTouches[0].clientY),i.mouseOffsetX=i.mouseX-i.mouseLastX,i.mouseOffsetY=i.mouseY-i.mouseLastY,e.preventDefault(),e.targetTouches.length>1){var r=new t.Point(i.mouseX,i.mouseY),a=new t.Point(i.getX(e.targetTouches[1].clientX),i.getY(e.targetTouches[1].clientY));null==this._oldPosition1&&(this._oldPosition1=r),null==this._oldPosition2&&(this._oldPosition2=a),this.isEnlarge(this._oldPosition1,this._oldPosition2,r,a)?i.wheelDelta=120:i.wheelDelta=-120,this._oldPosition1=r,this._oldPosition2=a}this._touchEvent3d.reset(),this._touchEvent3d.targetTouches=this.GetTargetTouches(e.targetTouches),this._touchEvent3d.target=this,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_MOVE,this.dispatchEvent(this._touchEvent3d)},i.prototype.GetTargetTouches=function(t){for(var r=new Array,i=0;i<t.length;i++){var a=new e(t[i]);r.push(a)}return r},i.prototype.mouseClick=function(e){this.deliverMessage()&&(this._mouseEvent3d.reset(),this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_CLICK,this.dispatchEvent(this._mouseEvent3d))},i.prototype.mouseEnd=function(e){this._mouseEvent3d.reset(),this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseStatus[this._mouseEvent3d.mouseCode]=!1,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_UP,this.dispatchEvent(this._mouseEvent3d)},i.prototype.deliverMessage=function(){for(var t=i.canvas.view3Ds,e=0;e<t.length;++e)if(t[e].inView3D(i.mouseX,i.mouseY))return!0;return!1},i.prototype.mouseStart=function(e){this.deliverMessage()&&(this._mouseEvent3d.reset(),this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseStatus[this._mouseEvent3d.mouseCode]||(this._mouseStatus[this._mouseEvent3d.mouseCode]=!0,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_DOWN,this.dispatchEvent(this._mouseEvent3d)))},i.prototype.mouseMove=function(e){i.mouseLastX=i.mouseX,i.mouseLastY=i.mouseY,i.mouseX=i.getX(e.clientX),i.mouseY=i.getY(e.clientY),i.mouseOffsetX=i.mouseX-i.mouseLastX,i.mouseOffsetY=i.mouseY-i.mouseLastY,this._mouseEvent3d.reset(),this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_MOVE,this.dispatchEvent(this._mouseEvent3d)},i.prototype.mouseOver=function(e){this._mouseEvent3d.reset(),this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_OVER,this.dispatchEvent(this._mouseEvent3d)},i.prototype.mouseWheel=function(e){i.wheelDelta=e.wheelDelta,this._mouseEvent3d.reset(),this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_WHEEL,this.dispatchEvent(this._mouseEvent3d)},i.prototype.keyDown=function(e){this._keyEvent3d.reset(),this._keyEvent3d.keyCode=e.keyCode,this._keyEvent3d.target=this,this._keyStatus[e.keyCode]||(this._keyStatus[e.keyCode]=!0,this._keyEvent3d.eventType=t.KeyEvent3D.KEY_DOWN,this.dispatchEvent(this._keyEvent3d))},i.prototype.keyUp=function(e){this._keyEvent3d.reset(),this._keyEvent3d.keyCode=e.keyCode,this._keyEvent3d.target=this,this._keyStatus[e.keyCode]=!1,this._keyEvent3d.eventType=t.KeyEvent3D.KEY_UP,this.dispatchEvent(this._keyEvent3d)},i.prototype.onWindowsResize=function(e){this._windowsEvent3d.target=this,this._windowsEvent3d.eventType=t.Event3D.RESIZE,this.dispatchEvent(this._windowsEvent3d)},i.prototype.onOrientationChange=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.ORIENTATION_CHANGE,this.dispatchEvent(this._orientationEvent3d)},i.prototype.onDeviceMotion=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_MOTION,this._orientationEvent3d.acceleration=e.acceleration,this._orientationEvent3d.accelerationIncludingGravity=e.accelerationIncludingGravity,this._orientationEvent3d.rotationRate=e.rotationRate,this.dispatchEvent(this._orientationEvent3d)},i.prototype.onDeviceOrientation=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_ORIENTATION,this._orientationEvent3d.absolute=e.absolute,this._orientationEvent3d.alpha=e.alpha,this._orientationEvent3d.beta=e.beta,this._orientationEvent3d.gamma=e.gamma,this.dispatchEvent(this._orientationEvent3d)},i.prototype.GetSlideAngle=function(t,e){return 180*Math.atan2(e,t)/Math.PI},i.prototype.GetSlideDirection=function(t,e,r,i){var a=e-i,n=r-t,o=0;if(Math.abs(n)<2&&Math.abs(a)<2)return o;var s=this.GetSlideAngle(n,a);return s>=-45&&45>s?o=4:s>=45&&135>s?o=1:s>=-135&&-45>s?o=2:(s>=135&&180>=s||s>=-180&&-135>s)&&(o=3),o},i.prototype.isEnlarge=function(t,e,r,i){var a=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)),n=Math.sqrt((r.x-i.x)*(r.x-i.x)+(r.y-i.y)*(r.y-i.y));return n>a?!0:!1},i}(t.EventDispatcher);r.scaleX=1,r.scaleY=1,r.mouseX=0,r.mouseY=0,r.wheelDelta=0,r.mouseOffsetX=0,r.mouseOffsetY=0,r.mouseLastX=0,r.mouseLastY=0,r._instance=null,t.Input=r,__reflect(r.prototype,"egret3d.Input")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.orientation=new t.Vector3D,this.screenOrientation=0,this.openDebug=!1,this.offsetRotation=new t.Vector3D,this.fixOritation=new t.Vector3D,this.state=-1,this.degtorad=Math.PI/180,this.q=new t.Quaternion,this.q1=new t.Quaternion,this.outQ=new t.Quaternion,this.fix=new t.Vector3D,this.fixinterpolate=new t.Vector3D,this.fixAxis=new t.Vector3D,this.caheFixAxis=new t.Vector3D,this.steps=3.001,this.interpolate=!0,this.openDebug&&(this.accDiv=document.createElement("div"),this.accGravityDiv=document.createElement("div"),this.rotationRateDiv=document.createElement("div"),this.orientationRateDiv=document.createElement("div"),this.stateDiv=document.createElement("div"),this.accDiv.style.color="red",this.accGravityDiv.style.color="red",this.rotationRateDiv.style.color="red",this.orientationRateDiv.style.color="red",this.stateDiv.style.color="red",this.stateDiv.style.fontSize="52",document.body.appendChild(this.accDiv),document.body.appendChild(this.accGravityDiv),document.body.appendChild(this.rotationRateDiv),document.body.appendChild(this.orientationRateDiv),document.body.appendChild(this.stateDiv))}return e.prototype.start=function(){var t=this;this.orientationchangeHandler(),window.addEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.addEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.addEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.stop=function(){var t=this;window.removeEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.removeEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.removeEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.orientationchangeHandler=function(){void 0!=window.orientation&&(this.screenOrientation=window.orientation)},e.prototype.motionHandler=function(t){this.acc=t.acceleration,this.accGravity=t.accelerationIncludingGravity,this.rotationRate=t.rotationRate},e.prototype.orientationHandler=function(t){this.orientation.x=t.alpha,this.orientation.y=t.beta,this.orientation.z=t.gamma,this.openDebug&&this.debug()},e.prototype.debug=function(){this.accGravityDiv.innerHTML="<br><br> Gravity-x:"+this.orientation.x*t.MathUtil.RADIANS_TO_DEGREES+"<br>Gravity-y:"+this.orientation.y+"<br>Gravity-z:"+this.orientation.z,this.orientationRateDiv.innerHTML="<br> orientation-x:"+this.fixOritation.x+"<br>orientation-y:"+this.fixOritation.y+"<br>orientation-z:"+this.fixOritation.z,this.stateDiv.innerHTML="<br> state: "+this.state},e.prototype.getOrientation=function(){switch(window.screen.msOrientation){case"landscape-primary":return-90;case"landscape-secondary":return 90;case"portrait-secondary":return 180;case"portrait-primary":return 0}return 270},e.prototype.getQuaternion=function(e,r,i){var a=r?r*this.degtorad:0,n=i?i*this.degtorad:0,o=e?e*this.degtorad:0;a=Math.floor(100*a)/100,n=Math.floor(100*n)/100;var s=-this.getOrientation()*this.degtorad;this.state=this.getOrientation();var l=Math.cos(a/2),h=Math.cos(n/2),u=Math.cos(o/2),c=Math.sin(a/2),d=Math.sin(n/2),p=Math.sin(o/2);this.q.w=l*h*u-c*d*p,this.q.x=c*h*u-l*d*p,this.q.y=l*d*u+c*h*p,this.q.z=l*h*p+c*d*u;var f=new t.Vector3D(0,0,1),m=new t.Quaternion;return m.fromAxisAngle(f,s),this.q.multiply(this.q,m),f.setTo(-1,0,0),m.fromAxisAngle(f,90*this.degtorad),this.q.multiply(this.q,m),this.q},e.prototype.update=function(t){this.getBaseQuaternion(this.orientation.x,this.orientation.y,this.orientation.z),this.q.toEulerAngles(this.fixOritation),this.interpolate?(this.fixinterpolate.x=this.fixOritation.x-this.fix.x,this.fixinterpolate.y=this.fixOritation.y-this.fix.y,this.fixinterpolate.z=this.fixOritation.z-this.fix.z,this.caheFixAxis.x=this.fixOritation.x/Math.abs(this.fixOritation.x),this.caheFixAxis.y=this.fixOritation.y/Math.abs(this.fixOritation.y),this.caheFixAxis.z=this.fixOritation.z/Math.abs(this.fixOritation.z),Math.abs(this.fixinterpolate.x)>150||Math.abs(this.fixinterpolate.y)>150||Math.abs(this.fixinterpolate.z)>150?(this.fix.x=this.fixOritation.x,this.fix.y=this.fixOritation.y,this.fix.z=this.fixOritation.z):(this.fix.x+=this.fixinterpolate.x/this.steps,this.fix.y+=this.fixinterpolate.y/this.steps,this.fix.z+=this.fixinterpolate.z/this.steps),t.camera3D.rotationX=-this.fix.x,t.camera3D.rotationY=-this.fix.y,t.camera3D.rotationZ=this.fix.z):(t.camera3D.rotationX=-this.fixOritation.x,t.camera3D.rotationY=-this.fixOritation.y,t.camera3D.rotationZ=this.fixOritation.z)},e.prototype.getBaseQuaternion=function(t,e,r){var i=e?e*this.degtorad:0,a=r?r*this.degtorad:0,n=t?t*this.degtorad:0,o=Math.cos(i/2),s=Math.cos(a/2),l=Math.cos(n/2),h=Math.sin(i/2),u=Math.sin(a/2),c=Math.sin(n/2),d=o*s*l-h*u*c,p=h*s*l-o*u*c,f=o*u*l+h*s*c,m=o*s*c+h*u*l;return this.q.w=d,this.q.x=p,this.q.y=f,this.q.z=m,this.q},e}();t.OrientationController=e,__reflect(e.prototype,"egret3d.OrientationController")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(i){void 0===i&&(i=new t.Vector3D(0,0,1));var a=e.call(this)||this;return a._dir=new t.Vector3D(0,0,1),a._dir.copyFrom(i),a._dir.normalize(),t.Quaternion.fromToRotation(t.Vector3D.Z_AXIS,a._dir,r.q0),a.globalOrientation=r.q0,a.lightType=t.LightType.directlight,a}return __extends(r,e),Object.defineProperty(r.prototype,"ambient",{set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dir",{get:function(){return this._transformChange&&this.modelMatrix,this._dir},set:function(e){this._dir.copyFrom(e),this._dir.normalize(),t.Quaternion.fromToRotation(t.Vector3D.Z_AXIS,this._dir,r.q0),this.globalOrientation=r.q0},enumerable:!0,configurable:!0}),r.prototype.onUpdateTransform=function(){e.prototype.onUpdateTransform.call(this),this.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this._dir),this._dir.normalize()},r.prototype.updateLightData=function(t,e,i){var a=this.dir;i[e*r.stride+0]=a.x,i[e*r.stride+1]=a.y,i[e*r.stride+2]=a.z,i[e*r.stride+3]=this._diffuse.x,i[e*r.stride+4]=this._diffuse.y,i[e*r.stride+5]=this._diffuse.z,i[e*r.stride+6]=this._ambient.x,i[e*r.stride+7]=this._ambient.y,i[e*r.stride+8]=this._ambient.z,i[e*r.stride+9]=this._intensity},r}(t.LightBase);e.q0=new t.Quaternion,e.stride=10,t.DirectLight=e,__reflect(e.prototype,"egret3d.DirectLight")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._canTransitionToSelf=!1,this._atomic=!0,this._time=0,this._weight=0,this.gpuSkeletonPose=null,this.currentAnimName="",this.nextAnimName="",this._reset=!1,this._offset=0,this._defaultFade=new t.CrossFadeNode,this._animState={}}return e.prototype.addCrossFadeNode=function(e){e&&(this._crossFade=this._crossFade||new t.CrossFade),this._crossFade.addCrossFadeNode(e)},e.prototype.addAnimClip=function(e){if(e.animationName){var r=new t.AnimClipState(e);r.animation=this.animation,this._animState[e.animationName]=r,this._currentState=r}},Object.defineProperty(e.prototype,"animClip",{get:function(){return this._animState},enumerable:!0,configurable:!0}),e.prototype.getCurrentState=function(){return this._currentState},e.prototype.play=function(e,r,i){if(void 0===i&&(i=!1),this.currentAnimName!=e||i){var a,n,o=(this._currentCrossFadeNode,this._defaultFade);if(this._currentCrossFadeNode=null,this._crossFade&&(this._currentCrossFadeNode=this._crossFade.checkCrossFade(this.currentAnimName,e,this._animState)),!this._currentCrossFadeNode&&!i&&(a=this._animState[this.currentAnimName],n=this._animState[e],a&&n)){this._currentCrossFadeNode=o,o.crossA=this.currentAnimName,o.crossB=e,o.crossA_state=a,o.crossB_state=n;var s=300;o.blend_startFrame=Math.floor((a.totalTime-s)/a.clip.frameRate),o.blend_endFrame=a.totalFrame,o.crossB_startFrame=o.blend_startFrame,o.blendTime=s,o.blendStartTime=o.blend_startFrame*a.clip.frameRate,o.totalTime=o.blendStartTime+n.totalTime}this.currentAnimName=e,this._animState[e]&&(this._currentState=this._animState[e],this._currentState.speed=r,this._reset=!0,this.gpuSkeletonPose||(this.gpuSkeletonPose=new t.SkeletonPose,this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this.gpuSkeletonPose)),t.Egret3DPolicy.useAnimMixInterpolation&&!this._lerpAPose&&(this._lerpAPose=new t.SkeletonPose,this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this._lerpAPose)),t.Egret3DPolicy.useAnimMixInterpolation&&!this._lerpBPose&&(this._lerpBPose=new t.SkeletonPose,this.gpuSkeletonPose.initSkeletonPose(this._animState[e].clip.getSkeletonPose(0),this._lerpBPose)),a||this.update(0,0))}},e.prototype.update=function(e,r){if(this._reset&&(this._reset=!1,this._offset=e,this._currentState.reset(e)),t.Egret3DPolicy.useAnimMixInterpolation&&this._currentCrossFadeNode?this.mixUpdate(e,r):this._currentState&&this._currentState.update(r,this.gpuSkeletonPose),this.bindList)for(var i in this.bindList){var a=this.gpuSkeletonPose.jointsDictionary[i];a.copyTo(this.bindList[i].node,this.bindList[i].type)}},e.prototype.mixUpdate=function(t,e){var r=this._lerpAPose,i=this._lerpBPose,a=this.gpuSkeletonPose,n=this._currentCrossFadeNode,o=n.crossA_state||this._animState[n.crossA],s=n.crossB_state||this._animState[n.crossB],l=!1,h=!1,u=!1;this._time=t-this._offset+n.blendStartTime,this._time<=n.totalTime?(this._time<n.blendStartTime+n.blendTime&&(l=!0),this._time>=33*n.crossB_startFrame&&this._time<=33*n.crossB_startFrame+s.totalTime&&(h=!0),this._time<=n.blendStartTime+n.blendTime&&(u=!0),u?(this._weight=(this._time-n.blendStartTime)/n.blendTime,this._weight>1&&(this._weight=1),o.update(e,r),s.update(e,i),a.mixAnim(r,i,this._weight,a)):l&&!h?o.update(e,a):h&&!l&&s.update(e,a)):(this._crossFade&&this.play(this._crossFade.getNextAnim(),1),this._currentCrossFadeNode=null)},e.prototype.clone=function(){var t=new e;for(var r in this._animState)t.addAnimClip(this._animState[r].clip);return t._crossFade=this._crossFade,t},e}();t.SkeletonAnimationState=e,__reflect(e.prototype,"egret3d.SkeletonAnimationState")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.lightNum=0,r.event=new t.Event3D,r.directLightList=new Array,r.spotLightList=new Array,r.pointLightList=new Array,r}return __extends(r,e),r.prototype.addLight=function(e){switch(e.lightType){case t.LightType.directlight:this.directLightList.push(e),this.lightNum++,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event);break;case t.LightType.pointlight:this.pointLightList.push(e),this.lightNum++,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event);break;case t.LightType.spotLightlight:this.spotLightList.push(e),this.lightNum++,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event)}},r.prototype.removeLight=function(e){switch(e.lightType){case t.LightType.directlight:var i=this.directLightList.indexOf(e);i>=0&&i<this.directLightList.length&&(this.directLightList.splice(i,1),this.lightNum--,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event));break;case t.LightType.pointlight:var i=this.pointLightList.indexOf(e);i>=0&&i<this.pointLightList.length&&(this.pointLightList.splice(i,1),this.lightNum--,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event));break;case t.LightType.spotLightlight:var i=this.spotLightList.indexOf(e);i>=0&&i<this.spotLightList.length&&(this.spotLightList.splice(i,1),this.lightNum--,this.event.eventType=r.EVENT_LIGHT_RESET,this.dispatchEvent(this.event))}},r}(t.EventDispatcher);e.EVENT_LIGHT_RESET="Event_Light_Reset",t.LightGroup=e,__reflect(e.prototype,"egret3d.LightGroup")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=16777215);var i=e.call(this)||this;return i.scenePosMat=new t.Matrix4_4,i.lightType=t.LightType.pointlight,i.diffuse=r,i}return __extends(r,e),Object.defineProperty(r.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cutoff",{get:function(){return this._cutoff},set:function(t){this._cutoff=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"ambient",{set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1
},enumerable:!0,configurable:!0}),r.prototype.updateLightData=function(t,e,i){i[e*r.stride]=this.globalPosition.x,i[e*r.stride+1]=this.globalPosition.y,i[e*r.stride+2]=this.globalPosition.z,i[e*r.stride+3]=this._diffuse.x*this._intensity,i[e*r.stride+4]=this._diffuse.y*this._intensity,i[e*r.stride+5]=this._diffuse.z*this._intensity,i[e*r.stride+6]=this._ambient.x,i[e*r.stride+7]=this._ambient.y,i[e*r.stride+8]=this._ambient.z,i[e*r.stride+9]=this._intensity,i[e*r.stride+10]=this._radius,i[e*r.stride+11]=this._cutoff},r}(t.LightBase);e.scenePos=new t.Vector3D,e.stride=12,t.PointLight=e,__reflect(e.prototype,"egret3d.PointLight")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this)||this;return i.diffuse=r,i.lightType=t.LightType.spotLightlight,i}return __extends(r,e),Object.defineProperty(r.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:!0,configurable:!0}),r.prototype.updateLightData=function(e,i,a){a[i*r.stride]=this.globalPosition.x,a[i*r.stride+1]=this.globalPosition.y,a[i*r.stride+2]=this.globalPosition.z,a[i*r.stride+3]=this.globalRotation.x*t.MathUtil.DEGREES_TO_RADIANS,a[i*r.stride+4]=this.globalRotation.y*t.MathUtil.DEGREES_TO_RADIANS,a[i*r.stride+5]=this.globalRotation.z*t.MathUtil.DEGREES_TO_RADIANS,a[i*r.stride+6]=this._diffuse.x,a[i*r.stride+7]=this._diffuse.y,a[i*r.stride+8]=this._diffuse.z,a[i*r.stride+9]=this._spotExponent,a[i*r.stride+10]=this._spotCosCutoff,a[i*r.stride+11]=this._constantAttenuation,a[i*r.stride+12]=this._linearAttenuation,a[i*r.stride+13]=this._quadraticAttenuation},r}(t.LightBase);e.stride=14,t.SpotLight=e,__reflect(e.prototype,"egret3d.SpotLight")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._loaderDict={},this._queueLoader=[],this._loaderEvent=new t.LoaderEvent3D,this._binaryDict={},this._binaryUrlDict={}}return e.prototype.loadAsset=function(e,r,i,a){return void 0===a&&(a=null),this.addEventListener(e,t.LoaderEvent3D.LOADER_COMPLETE,r,i,a)},e.prototype.addEventListener=function(e,r,i,a,n){var o=this;void 0===n&&(n=null);var s=this._loaderDict[e];if(!s){s={},this._loaderDict[e]=s,this.getByteArray(e)?s.loader=new t.BinaryLoader:s.loader=new t.URLLoader,s.objects=[];var l=s.loader;l.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this),this._queueLoader.push(e),this._currentLoader||(this._currentLoader=l,this._currentLoader.load(e))}var l=s.loader;return l.param=n,n instanceof t.UnitNodeData&&(l.unitNodeData=n),l.data?setTimeout(function(){o._loaderEvent.eventType=r,o._loaderEvent.target=l,o._loaderEvent.loader=l,o._loaderEvent.data=l.data,o._loaderEvent.param=n,i&&i.call(a,o._loaderEvent),o._loaderEvent.target=null,o._loaderEvent.loader=null,o._loaderEvent.data=null,o._loaderEvent.param=null},0):i&&l.addEventListener(r,i,a,n),s.objects.indexOf(a)<0&&s.objects.push(a),l},e.prototype.findAsset=function(t,e){void 0===e&&(e=null);var r=this._loaderDict[t];return r?(e&&r.objects.indexOf(e)<0&&r.objects.push(e),r.loader):null},e.prototype.dispose=function(t){var e=[];for(var r in this._loaderDict){var i=this._loaderDict[r],a=i.objects.indexOf(t);a>=0&&i.objects.splice(a,1),i.objects.length<=0&&e.push(r)}for(var n=0;n<e.length;++n){var i=this._loaderDict[e[n]];i.loader.dispose(),i.loader=null,i.objects=null,delete this._loaderDict[e[n]]}e=null},e.prototype.onComplete=function(t){if(this._queueLoader.shift(),this._queueLoader.length>0){var e=this._loaderDict[this._queueLoader[0]],r=e.loader;r.load(this._queueLoader[0]),this._currentLoader=r}else this._currentLoader=null},e.prototype.addByteArray=function(t,e,r){this._binaryDict[t]=e;var i=this._binaryUrlDict[r];i||(i=[],this._binaryUrlDict[r]=i),i.push(t)},e.prototype.removeByteArray=function(t){var e=this._binaryUrlDict[t];if(e){for(var r=0;r<e.length;++r)delete this._binaryDict[e[r]];delete this._binaryUrlDict[t]}},e.prototype.getByteArray=function(t){return this._binaryDict[t]},e}();t.AssetManager=e,__reflect(e.prototype,"egret3d.AssetManager"),t.assetMgr=new e}(egret3d||(egret3d={}));var egret3d;!function(egret3d){var BinaryLoader=function(_super){function BinaryLoader(t){void 0===t&&(t=null);var e=_super.call(this)||this;return e._event=new egret3d.LoaderEvent3D,t&&e.load(t),e}return __extends(BinaryLoader,_super),BinaryLoader.prototype.load=function(t){this.data=null,this.url=t,this.resourceName=egret3d.StringUtil.getURLName(this.url),this.processFileFormat(),this.loadComplete()},BinaryLoader.prototype.loadComplete=function(){var _this=this,byte=egret3d.assetMgr.getByteArray(this.url);switch(this.dataformat){case egret3d.ILoader.DATAFORMAT_BINARY:this.data=byte;break;case egret3d.ILoader.DATAFORMAT_BITMAP:var blob=new Blob([byte.buffer]),img=document.createElement("img");return void 0!=window.createObjectURL?img.src=window.createObjectURL(blob):void 0!=window.URL?img.src=window.URL.createObjectURL(blob):void 0!=window.webkitURL&&(img.src=window.webkitURL.createObjectURL(blob)),void(img.onload=function(){return _this.onLoad(img)});case egret3d.ILoader.DATAFORMAT_DDS:this.data=egret3d.DDSParser.parse(byte.buffer),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_TGA:this.data=egret3d.TGAParser.parse(byte.buffer),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_HDR:this.data=egret3d.HDRParser.parse(byte.buffer),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_ESM:this.data=egret3d.ESMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_EAM:this.data=egret3d.EAMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_ECA:this.data=egret3d.ECAParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_EPA:this.data=egret3d.EPAParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_E3DPACK:this.data=egret3d.E3dPackParser.parse(byte.buffer,this.url);break;case egret3d.URLLoader.DATAFORMAT_EUM:this.data=egret3d.EUMParser.parse(byte.buffer);break;case egret3d.ILoader.DATAFORMAT_XML:this.data=egret3d.XMLParser.parse(egret3d.StringUtil.ab2str(byte));break;case egret3d.ILoader.DATAFORMAT_JSON:this.data=eval("("+egret3d.StringUtil.ab2str(byte)+")");break;default:this.data=byte.buffer}setTimeout(function(){_this.doLoadComplete()},0)},BinaryLoader.prototype.onLoad=function(t){this.data=new egret3d.ImageTexture(t),this.checkTexture(this.data),this.doLoadComplete(),void 0!=window.createObjectURL?window.revokeObjectURL(t.src):void 0!=window.URL?window.URL.revokeObjectURL(t.src):void 0!=window.webkitURL&&window.webkitURL.revokeObjectURL(t.src),t.onload=null},BinaryLoader.prototype.checkTexture=function(t){(0!=(t.width&t.width-1)||0!=(t.height&t.height-1))&&egret3d.Egret3DLog.outError("<"+this.url+"><贴图宽高不是2的N次方>")},BinaryLoader.prototype.doLoadComplete=function(){this.currentProgress=1,this._event.loader=this,this._event.data=this.data,this._event.currentProgress=this.currentProgress,this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS,this.dispatchEvent(this._event),this._event.eventType=egret3d.LoaderEvent3D.LOADER_ONCE_COMPLETE,this.dispatchEvent(this._event),this._event.eventType=egret3d.LoaderEvent3D.LOADER_COMPLETE,this.dispatchEvent(this._event)},BinaryLoader}(egret3d.ILoader);egret3d.BinaryLoader=BinaryLoader,__reflect(BinaryLoader.prototype,"egret3d.BinaryLoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.joints=[]}return e.prototype.calculateJointWorldMatrix=function(){var t=this.joints,e=t.length,r=0;for(r;e>r;++r)this.calculateAbsoluteMatrix(t[r],t)},e.prototype.calculateAbsoluteMatrix=function(e,r){e.parentIndex>=0&&this.calculateAbsoluteMatrix(r[e.parentIndex],r),e.worldMatrixValid||(e.worldMatrix||(e.worldMatrix=new t.Matrix4_4),e.localMatrix=e.localMatrix||new t.Matrix4_4,e.localMatrix.makeTransform(e.translation,e.scale,e.orientation),e.worldMatrix.copyFrom(e.localMatrix),e.parentIndex>=0&&e.worldMatrix.append(r[e.parentIndex].worldMatrix),e.worldMatrixValid=!0)},e.prototype.updateGPUData=function(e,r,i){for(var a=e.joints,n=a.length,o=this.joints,s=o.length,l=this.boneNameArray,h=0;n>h;++h)for(var u=0;s>u;++u)if(a[h].name==l[u]){t.Matrix4_4.helpMatrix.copyFrom(a[h].inverseMatrix),t.Matrix4_4.helpMatrix.append(o[u].worldMatrix);var c=t.Matrix4_4.helpMatrix.decompose(t.Orientation3D.QUATERNION);r[8*h+0]=c[1].x,r[8*h+1]=c[1].y,r[8*h+2]=c[1].z,r[8*h+3]=c[1].w,r[8*h+4]=c[0].x-i.x,r[8*h+5]=c[0].y-i.y,r[8*h+6]=c[0].z-i.z,r[8*h+7]=1;break}return r},e.prototype.findJoint=function(t){var e=this.findJointIndex(t);return e>=0?this.joints[e]:null},e.prototype.findJointIndex=function(t){if(""==t)return-1;for(var e=0;e<this.boneNameArray.length;e++)if(this.boneNameArray[e]==t)return e;return-1},e.prototype.resetWorldMatrix=function(){for(var t=this.joints,e=t.length,r=0;e>r;r++)t[r].worldMatrixValid=!1},e.prototype.getLerpSkeletonPose=function(t,e,r,i,a){var n,o;n=i.poseArray[t],o=i.poseArray[e],a.mixAnim(n,o,r,a)},e.prototype.mixAnim=function(t,e,r,i){for(var a,n,o=i.joints,s=0;s<t.joints.length;s++)a=t.joints[s],n=e.joints[s],o[s].translation.lerp(a.translation,n.translation,r),o[s].orientation.lerp(a.orientation,n.orientation,r),o[s].worldMatrixValid=!1;i.calculateJointWorldMatrix()},e.prototype.copySkeletonPose=function(t,e){for(var r=e.joints,i=t.joints,a=i.length,n=0;a>n;n++)r[n].translation=i[n].translation,r[n].orientation=i[n].orientation,r[n].scale=i[n].scale,r[n].worldMatrixValid=!1;e.calculateJointWorldMatrix()},e.prototype.initSkeletonPose=function(e,r){r.joints=r.joints||[],r.jointsDictionary=r.jointsDictionary||{},r.boneNameArray=e.boneNameArray;for(var i=0;i<e.joints.length;i++){var a=new t.Joint;r.joints.push(a),r.jointsDictionary[e.boneNameArray[i]]=a,a.parentIndex=e.joints[i].parentIndex,a.index=e.joints[i].index,a.worldMatrix=a.worldMatrix||new t.Matrix4_4}},e}();e._temp_jointMatrix=new t.Matrix4_4,e._temp_matrixDecomposeA=[new t.Vector3D,new t.Vector3D,new t.Vector3D],t.SkeletonPose=e,__reflect(e.prototype,"egret3d.SkeletonPose")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this)||this;return i.dictLoader={},i.currentLoader=null,i.dictProgress={},i.queueLoader=[],i._event=new t.LoaderEvent3D,i.taskTotal=0,i.taskCurrent=0,i.currentProgress=0,i.lastProgress=0,r&&i.load(r),i}return __extends(r,e),r.prototype.load=function(e){if(this.dictLoader[e])return t.Egret3DLog.outWarn("已经加载过["+e+"]"),this.dictLoader[e];this.taskTotal++;var r=new t.UnitLoader;return this.dictLoader[e]=r,r.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this),r.addEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this),this.dictProgress[e]=0,this.queueLoader.push(e),this.currentLoader||(this.currentLoader=this.dictLoader[e],this.currentLoader.load(e)),r},r.prototype.addAssetEventListener=function(t,e,r,i,a,n){void 0===a&&(a=null),void 0===n&&(n=0);var o=this.dictLoader[t];return o?o.addEventListener(e,r,i,a,n):0},r.prototype.removeAssetEventListener=function(t,e,r,i,a,n){void 0===a&&(a=null),void 0===n&&(n=0);var o=this.dictLoader[t];o&&o.removeEventListener(e,r,i)},r.prototype.getAsset=function(e){return this.dictLoader[e]?this.dictLoader[e].data:t.textureResMgr.getTexture(e)},r.prototype.getAnim=function(e){var r=this.getAsset(e);return r instanceof t.Mesh?this.getAsset(e):null},r.prototype.getTexture=function(e){var r=this.getAsset(e);return r instanceof t.ITexture?this.getAsset(e):null},r.prototype.getScene=function(e){var r=this.getAsset(e);return r instanceof t.Object3D?this.getAsset(e):null},r.prototype.getText=function(t){this.getAsset(t);return this.getAsset(t)},r.prototype.getGeometry=function(e){var r=this.getAsset(e);return r instanceof t.Geometry?this.getAsset(e):null},r.prototype.getAnimClip=function(e){var r=this.getAsset(e);return r instanceof t.SkeletonAnimationClip?this.getAsset(e):null},r.prototype.getAssetURLLoader=function(e){return t.assetMgr.findAsset(e,this)},r.prototype.getUnitLoader=function(t){return this.dictLoader[t]},r.prototype.onComplete=function(e){var r=e.loader;if(r.removeEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this),r.removeEventListener(t.LoaderEvent3D.LOADER_PROGRESS,this.onProgress,this),this.taskCurrent++,this.queueLoader.shift(),this._event.eventType=t.LoaderEvent3D.LOADER_ONCE_COMPLETE,this._event.loader=r,this._event.data=r.data,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event),this.queueLoader.length>0){var i=this.queueLoader[0];this.currentLoader=this.dictLoader[i],this.currentLoader.load(i)}else{this.guiComplete(),this.currentLoader=null,this.currentProgress=1,this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event);var a=(this.currentLoader,this.taskTotal),n=this.taskCurrent,o=[];for(var s in this.dictProgress)o.push(s);this.currentProgress,this.lastProgress;this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event),this.taskTotal=this.taskTotal-a,this.taskCurrent=this.taskCurrent-n;for(var l=0;l<o.length;++l)this.dictProgress[o[l]]>0&&delete this.dictProgress[o[l]];this.currentProgress=0,this.lastProgress=0}},r.prototype.onProgress=function(e){var r=e.target;if(void 0!=this.dictProgress[r.url]){this.dictProgress[r.url]=r.currentProgress,this.currentProgress=0;for(var i in this.dictProgress)this.currentProgress+=1/this.taskTotal*this.dictProgress[i];this.lastProgress<this.currentProgress&&(this.lastProgress=this.currentProgress,this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.loader=r,this._event.data=r.data,this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event))}},r.prototype.loadDefaultGUISkin=function(){this.load("resource/ui/fonts.json"),this.load("resource/ui/GUI.json")},r.prototype.guiComplete=function(){t.gui.BitmapFont.load(t.textureResMgr.getTextureDic()),t.gui.GUISkinManager.instance.initDefaultSkin()},r.prototype.dispose=function(){e.prototype.dispose.call(this);for(var r in this.dictLoader)this.dictLoader[r].dispose();t.assetMgr.dispose(this),this.dictLoader={}},r.prototype.disposeUnitLoader=function(t){this.dictLoader[t]&&(this.dictLoader[t].dispose(),delete this.dictLoader[t])},r}(t.EventDispatcher);t.QueueLoader=e,__reflect(e.prototype,"egret3d.QueueLoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t._textureDic={},t._urlTextureDic={},t._bigTextureDic={},t._count=0,t.resetCount(),t}return __extends(r,e),Object.defineProperty(r.prototype,"guiStage",{get:function(){return this._guiStage},set:function(t){this._guiStage=t},enumerable:!0,configurable:!0}),r.prototype.resetCount=function(){this._totalCount=0,this._loadedCount=0},Object.defineProperty(r.prototype,"totalCount",{get:function(){return this._totalCount},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"loadedCount",{get:function(){return this._loadedCount},enumerable:!0,configurable:!0}),r.prototype.loadTexture=function(e,r){var i=this,a=function(r,a){for(var n=a.frames,o=0;o<n.length;o++){var s=n[o],l=s.filename,h=s.frame,u=new t.Texture;u.copyFromTexture(r,h.x/r.width,h.y/r.height,h.w/r.width,h.h/r.height),u.width=h.w,u.height=h.h,i._textureDic[l]&&console.log("TextureResourceManager::loadTexture, 贴图缓存池里已经有相同名字的贴图. 请检查, name: "+l+" url:"+e),i._textureDic[l]=u}};this._count++,this._totalCount++;var n=function(r){var n=new t.URLLoader(e);n.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,function(e){r.useMipmap=!1,t.registGUITexture(r),a(r,JSON.parse(n.data)),i._count--,i._loadedCount++,i.dispatchEvent(new t.LoaderEvent3D(t.LoaderEvent3D.LOADER_PROGRESS)),0===i._count&&(i.resetCount(),setTimeout(function(){i.dispatchEvent(new t.LoaderEvent3D(t.LoaderEvent3D.LOADER_COMPLETE))},0))},i)},o=new t.URLLoader(r);o.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,function(t){n(o.data)},this)},r.prototype.getTextureDic=function(){return this._textureDic},r.prototype.getTexture=function(t){return this._textureDic[t]},r.prototype.addTexture=function(e,r,i){t.registGUITexture(i),this._bigTextureDic[e]=i;var a=[];this._urlTextureDic[e]=a;for(var n,o=r.frames,s=0;s<o.length;s++){var l=o[s];n=l.filename;var h=l.frame,u=new t.Texture;u.copyFromTexture(i,h.x/i.width,h.y/i.height,h.w/i.width,h.h/i.height),u.width=h.w,u.height=h.h,this._textureDic[n]&&console.log("TextureResourceManager::loadTexture, 贴图缓存池里已经有相同名字的贴图. 请检查, url: "+e),this._textureDic[n]=u,a.push(n)}},r.prototype.removeTexture=function(t){var e=this._urlTextureDic[t];if(e)for(var r=0;r<e.length;r++)delete this._textureDic[e[r]]},r}(t.EventDispatcher);t.TextureResourceManager=e,__reflect(e.prototype,"egret3d.TextureResourceManager"),t.textureResMgr=new e}(egret3d||(egret3d={}));var egret3d;!function(egret3d){var URLLoader=function(_super){function URLLoader(t,e){void 0===t&&(t=null),void 0===e&&(e=null);var r=_super.call(this)||this;return r._event=new egret3d.LoaderEvent3D,r.parentUrl="",t&&r.load(t,e),r}return __extends(URLLoader,_super),URLLoader.prototype.load=function(t,e){var r=this;return void 0===e&&(e=null),this.data=null,this.url=t,this.resourceName=egret3d.StringUtil.getURLName(this.url),this.dataformat=e,null==this._dataformat&&this.processFileFormat(),null==this._xhr&&(this._xhr=this.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&(this._xhr.abort(),this.disposeXhrEventListener()),this._xhr.open("GET",this.url,!0),this.progress=function(t){return r.onProgress(t)},this.readystatechange=function(t){return r.onReadyStateChange(t)},this.error=function(t){return r.onError(t)},this._xhr.addEventListener("progress",this.progress,!1),this._xhr.addEventListener("readystatechange",this.readystatechange,!1),this._xhr.addEventListener("error",this.error,!1),this.dataformat==URLLoader.DATAFORMAT_BITMAP?this._xhr.responseType="blob":this.dataformat!=URLLoader.DATAFORMAT_TEXT&&this.dataformat!=URLLoader.DATAFORMAT_JSON&&this.dataformat!=URLLoader.DATAFORMAT_XML&&(this._xhr.responseType="arraybuffer"),void this._xhr.send())},Object.defineProperty(URLLoader.prototype,"bytesLoaded",{get:function(){return this._progressEvent?this._progressEvent.loaded:0},enumerable:!0,configurable:!0}),Object.defineProperty(URLLoader.prototype,"bytesTotal",{get:function(){return this._progressEvent?this._progressEvent.total:0},enumerable:!0,configurable:!0}),URLLoader.prototype.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400?console.log(this.url,"load fail"):this.loadComplete())},URLLoader.prototype.loadComplete=function(){var _this=this;switch(this.dataformat){case egret3d.ILoader.DATAFORMAT_BINARY:this.data=new egret3d.ByteArray(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_SOUND:this.data=this._xhr.responseText;break;case egret3d.ILoader.DATAFORMAT_TEXT:this.data=this._xhr.responseText;break;case egret3d.ILoader.DATAFORMAT_BITMAP:var img=document.createElement("img");return void 0!=window.createObjectURL?img.src=window.createObjectURL(this._xhr.response):void 0!=window.URL?img.src=window.URL.createObjectURL(this._xhr.response):void 0!=window.webkitURL&&(img.src=window.webkitURL.createObjectURL(this._xhr.response)),void(img.onload=function(){return _this.onLoad(img)});case egret3d.ILoader.DATAFORMAT_DDS:this.data=egret3d.DDSParser.parse(this._xhr.response),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_TGA:this.data=egret3d.TGAParser.parse(this._xhr.response),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_HDR:this.data=egret3d.HDRParser.parse(this._xhr.response),this.checkTexture(this.data);break;case egret3d.ILoader.DATAFORMAT_ESM:this.data=egret3d.ESMParser.parse(this._xhr.response,this.unitNodeData);break;case egret3d.ILoader.DATAFORMAT_EAM:this.data=egret3d.EAMParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_ECA:this.data=egret3d.ECAParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_EPA:this.data=egret3d.EPAParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_E3DPACK:this.data=egret3d.E3dPackParser.parse(this._xhr.response,this.url);break;case URLLoader.DATAFORMAT_EUM:this.data=egret3d.EUMParser.parse(this._xhr.response);break;case egret3d.ILoader.DATAFORMAT_XML:this.data=egret3d.XMLParser.parse(this._xhr.responseText);break;case egret3d.ILoader.DATAFORMAT_JSON:this.data=eval("("+this._xhr.responseText+")");break;default:this.data=this._xhr.response}this.doLoadComplete()},URLLoader.prototype.onProgress=function(t){this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS,this._event.loader=this,this._event.total=t.total,this._event.loaded=t.loaded,this._progressEvent=t,this.currentProgress=t.loaded/t.total,this.currentProgress<1&&(this._event.currentProgress=this.currentProgress,this.dispatchEvent(this._event))},URLLoader.prototype.onError=function(t){this._event.eventType=egret3d.LoaderEvent3D.LOADER_ERROR,this._event.target=this,this._event.loader=this,this.dispatchEvent(this._event),console.log("load error",t),this.disposeXhrEventListener()},URLLoader.prototype.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},URLLoader.prototype.onLoad=function(t){this.data=new egret3d.ImageTexture(t),this.checkTexture(this.data),this.doLoadComplete(),void 0!=window.createObjectURL?window.revokeObjectURL(t.src):void 0!=window.URL?window.URL.revokeObjectURL(t.src):void 0!=window.webkitURL&&window.webkitURL.revokeObjectURL(t.src),t.onload=null},URLLoader.prototype.checkTexture=function(t){(0!=(t.width&t.width-1)||0!=(t.height&t.height-1))&&egret3d.Egret3DLog.outError("<"+this.url+"><贴图宽高不是2的N次方>")},URLLoader.prototype.doLoadComplete=function(){this.currentProgress=1,this.disposeXhrEventListener(),this._event.loader=this,this._event.data=this.data,this._event.total=this._progressEvent.total,this._event.loaded=this._progressEvent.loaded,this._event.currentProgress=this.currentProgress,this._event.eventType=egret3d.LoaderEvent3D.LOADER_ONCE_COMPLETE,this.dispatchEvent(this._event),this._event.eventType=egret3d.LoaderEvent3D.LOADER_PROGRESS,this.dispatchEvent(this._event),this._event.eventType=egret3d.LoaderEvent3D.LOADER_COMPLETE,this.dispatchEvent(this._event)},URLLoader.prototype.disposeXhrEventListener=function(){this.progress&&(this._xhr.removeEventListener("progress",this.progress,!1),this.progress=null),this.readystatechange&&(this._xhr.removeEventListener("readystatechange",this.readystatechange,!1),this.readystatechange=null),this.error&&(this._xhr.removeEventListener("error",this.error,!1),this.error=null)},URLLoader.prototype.dispose=function(){_super.prototype.dispose.call(this),this.data&&this.data.dispose&&this.data.dispose(),this.data=null,this._event=null,this.disposeXhrEventListener(),this._xhr=null},URLLoader}(egret3d.ILoader);egret3d.URLLoader=URLLoader,__reflect(URLLoader.prototype,"egret3d.URLLoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.RGB_S3TC_DXT1_FORMAT=2001]="RGB_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT1_FORMAT=2002]="RGBA_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT3_FORMAT=2003]="RGBA_S3TC_DXT3_FORMAT",t[t.RGBA_S3TC_DXT5_FORMAT=2003]="RGBA_S3TC_DXT5_FORMAT"}(e=t.DDSFormat||(t.DDSFormat={}));var r=function(){function r(){}return r.parse=function(i,a){void 0===a&&(a=!0);var n=31,o=0,s=542327876,l=131072,h=512,u=4,c=r.fourCCToInt32("DXT1"),d=r.fourCCToInt32("DXT3"),p=r.fourCCToInt32("DXT5"),f=1021,o=0,m=1,_=2,v=3,g=4,y=7,x=20,b=21,D=22,T=23,P=24,S=25,w=26,A=28,C=new Int32Array(i,0,n);if(C[o]!==s)return console.error("DDSParser.parse: Invalid magic number in DDS header."),null;if(!(C[x]&u))return console.error("DDSParser.parse: Unsupported format, must contain a FourCC code."),null;var L,E,M,z,F,R=C[b],V=!1,O=1;switch(R){case c:L=8,E=e.RGB_S3TC_DXT1_FORMAT;break;case d:L=16,E=e.RGBA_S3TC_DXT3_FORMAT;break;case p:L=16,E=e.RGBA_S3TC_DXT5_FORMAT;break;default:if(!(32==C[D]&&16711680&C[T]&&65280&C[P]&&255&C[S]&&4278190080&C[w]))return console.error("DDSParser.parse: Unsupported FourCC code ",r.int32ToFourCC(R)),null;V=!0,L=64,E=f}C[_]&l&&a!==!1&&(O=Math.max(1,C[y])),M=C[A]&h?!0:!1,z=C[g],F=C[v];var B=C[m]+4,I=M?6:1,N=new Array,U=!1;E==e.RGB_S3TC_DXT1_FORMAT&&0==t.ContextConfig.ColorFormat_DXT1_RGB?U=!0:E==e.RGBA_S3TC_DXT3_FORMAT&&0==t.ContextConfig.ColorFormat_DXT3_RGBA?U=!0:E==e.RGBA_S3TC_DXT5_FORMAT&&0==t.ContextConfig.ColorFormat_DXT5_RGBA&&(U=!0);var k=new t.Texture;k.width=z,k.height=F;for(var G=0;I>G;G++){for(var j=0;O>j;j++){var X;if(V){X=r.loadARGBMip(i,B,z,F);var Y=X.length}else{var Y=Math.max(4,z)/4*Math.max(4,F)/4*L;X=new Uint8Array(i,B,Y),U&&(X=r.softSolutionDXT(z,F,E,X))}var H=new t.MipmapData(X,z,F);N.push(H),B+=Y,z=Math.max(.5*z,1),F=Math.max(.5*F,1)}z=z,F=F}return U?(k.internalFormat=t.InternalFormat.PixelArray,k.colorFormat=t.ContextConfig.ColorFormat_RGBA8888):(k.internalFormat=t.InternalFormat.CompressData,c==R?k.colorFormat=t.ContextConfig.ColorFormat_DXT1_RGB:d==R?k.colorFormat=t.ContextConfig.ColorFormat_DXT3_RGBA:p==R&&(k.colorFormat=t.ContextConfig.ColorFormat_DXT5_RGBA)),k.mimapData=N,k},r.loadARGBMip=function(t,e,r,i){for(var a=r*i*4,n=new Uint8Array(t,e,a),o=new Uint8Array(a),s=0,l=0,h=0;i>h;h++)for(var u=0;r>u;u++){var c=n[l];l++;var d=n[l];l++;var p=n[l];l++;var f=n[l];l++,o[s]=p,s++,o[s]=d,s++,o[s]=c,s++,o[s]=f,s++}return o},r.fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},r.int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&65385)},r.softSolutionDXT=function(r,i,a,n){var o,s=new Uint8Array(r*i*4),l=[new t.Color,new t.Color,new t.Color,new t.Color],h=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];switch(a){case e.RGB_S3TC_DXT1_FORMAT:case e.RGBA_S3TC_DXT1_FORMAT:o=n.length/8;for(var u=0;o>u;u++){var c=n[8*u+0]|n[8*u+1]<<8,d=n[8*u+2]|n[8*u+3]<<8;l[0].r=c>>11&31,l[0].g=c>>5&63,l[0].b=31&c,l[0].a=255,l[1].r=d>>11&31,l[1].g=d>>5&63,l[1].b=31&d,l[1].a=255,c>d?(l[2].lerp(l[0],l[1],.33),l[3].lerp(l[0],l[1],.66)):l[2].lerp(l[0],l[1],.5);for(var p=0;4>p;p++)h[4*p+0]=3&n[8*u+4+p],h[4*p+1]=n[8*u+4+p]>>2&3,h[4*p+2]=n[8*u+4+p]>>4&3,h[4*p+3]=n[8*u+4+p]>>6&3;for(var f=0;f<l.length;f++)l[f].r=8*l[f].r,l[f].g=4*l[f].g,l[f].b=8*l[f].b;var m=u%(r/4)*4,_=4*Math.floor(u/(r/4));i>_+0&&(r>m+0&&(s[(_+0)*(4*r)+4*(m+0)+0]=l[h[0]].r,s[(_+0)*(4*r)+4*(m+0)+1]=l[h[0]].g,s[(_+0)*(4*r)+4*(m+0)+2]=l[h[0]].b,s[(_+0)*(4*r)+4*(m+0)+3]=l[h[0]].a),r>m+1&&(s[(_+0)*(4*r)+4*(m+1)+0]=l[h[1]].r,s[(_+0)*(4*r)+4*(m+1)+1]=l[h[1]].g,s[(_+0)*(4*r)+4*(m+1)+2]=l[h[1]].b,s[(_+0)*(4*r)+4*(m+1)+3]=l[h[1]].a),r>m+2&&(s[(_+0)*(4*r)+4*(m+2)+0]=l[h[2]].r,s[(_+0)*(4*r)+4*(m+2)+1]=l[h[2]].g,s[(_+0)*(4*r)+4*(m+2)+2]=l[h[2]].b,s[(_+0)*(4*r)+4*(m+2)+3]=l[h[2]].a),r>m+3&&(s[(_+0)*(4*r)+4*(m+3)+0]=l[h[3]].r,s[(_+0)*(4*r)+4*(m+3)+1]=l[h[3]].g,s[(_+0)*(4*r)+4*(m+3)+2]=l[h[3]].b,s[(_+0)*(4*r)+4*(m+3)+3]=l[h[3]].a)),i>_+1&&(r>m+0&&(s[(_+1)*(4*r)+4*(m+0)+0]=l[h[4]].r,s[(_+1)*(4*r)+4*(m+0)+1]=l[h[4]].g,s[(_+1)*(4*r)+4*(m+0)+2]=l[h[4]].b,s[(_+1)*(4*r)+4*(m+0)+3]=l[h[4]].a),r>m+1&&(s[(_+1)*(4*r)+4*(m+1)+0]=l[h[5]].r,s[(_+1)*(4*r)+4*(m+1)+1]=l[h[5]].g,s[(_+1)*(4*r)+4*(m+1)+2]=l[h[5]].b,s[(_+1)*(4*r)+4*(m+1)+3]=l[h[5]].a),r>m+2&&(s[(_+1)*(4*r)+4*(m+2)+0]=l[h[6]].r,s[(_+1)*(4*r)+4*(m+2)+1]=l[h[6]].g,s[(_+1)*(4*r)+4*(m+2)+2]=l[h[6]].b,s[(_+1)*(4*r)+4*(m+2)+3]=l[h[6]].a),r>m+3&&(s[(_+1)*(4*r)+4*(m+3)+0]=l[h[7]].r,s[(_+1)*(4*r)+4*(m+3)+1]=l[h[7]].g,s[(_+1)*(4*r)+4*(m+3)+2]=l[h[7]].b,s[(_+1)*(4*r)+4*(m+3)+3]=l[h[7]].a)),i>_+2&&(r>m+0&&(s[(_+2)*(4*r)+4*(m+0)+0]=l[h[8]].r,s[(_+2)*(4*r)+4*(m+0)+1]=l[h[8]].g,s[(_+2)*(4*r)+4*(m+0)+2]=l[h[8]].b,s[(_+2)*(4*r)+4*(m+0)+3]=l[h[8]].a),r>m+1&&(s[(_+2)*(4*r)+4*(m+1)+0]=l[h[9]].r,s[(_+2)*(4*r)+4*(m+1)+1]=l[h[9]].g,s[(_+2)*(4*r)+4*(m+1)+2]=l[h[9]].b,s[(_+2)*(4*r)+4*(m+1)+3]=l[h[9]].a),r>m+2&&(s[(_+2)*(4*r)+4*(m+2)+0]=l[h[10]].r,s[(_+2)*(4*r)+4*(m+2)+1]=l[h[10]].g,s[(_+2)*(4*r)+4*(m+2)+2]=l[h[10]].b,s[(_+2)*(4*r)+4*(m+2)+3]=l[h[10]].a),r>m+3&&(s[(_+2)*(4*r)+4*(m+3)+0]=l[h[11]].r,s[(_+2)*(4*r)+4*(m+3)+1]=l[h[11]].g,s[(_+2)*(4*r)+4*(m+3)+2]=l[h[11]].b,s[(_+2)*(4*r)+4*(m+3)+3]=l[h[11]].a)),i>_+3&&(r>m+0&&(s[(_+3)*(4*r)+4*(m+0)+0]=l[h[12]].r,s[(_+3)*(4*r)+4*(m+0)+1]=l[h[12]].g,s[(_+3)*(4*r)+4*(m+0)+2]=l[h[12]].b,s[(_+3)*(4*r)+4*(m+0)+3]=l[h[12]].a),r>m+1&&(s[(_+3)*(4*r)+4*(m+1)+0]=l[h[13]].r,s[(_+3)*(4*r)+4*(m+1)+1]=l[h[13]].g,s[(_+3)*(4*r)+4*(m+1)+2]=l[h[13]].b,s[(_+3)*(4*r)+4*(m+1)+3]=l[h[13]].a),r>m+2&&(s[(_+3)*(4*r)+4*(m+2)+0]=l[h[14]].r,s[(_+3)*(4*r)+4*(m+2)+1]=l[h[14]].g,s[(_+3)*(4*r)+4*(m+2)+2]=l[h[14]].b,s[(_+3)*(4*r)+4*(m+2)+3]=l[h[14]].a),r>m+3&&(s[(_+3)*(4*r)+4*(m+3)+0]=l[h[15]].r,s[(_+3)*(4*r)+4*(m+3)+1]=l[h[15]].g,s[(_+3)*(4*r)+4*(m+3)+2]=l[h[15]].b,s[(_+3)*(4*r)+4*(m+3)+3]=l[h[15]].a))}break;case e.RGBA_S3TC_DXT3_FORMAT:o=n.length/16;for(var u=0;o>u;u++){var c=n[16*u+8]|n[16*u+9]<<8,d=n[16*u+10]|n[16*u+11]<<8;l[0].r=c>>11&31,l[0].g=c>>5&63,l[0].b=31&c,l[0].a=255,l[1].r=d>>11&31,l[1].g=d>>5&63,l[1].b=31&d,l[1].a=255,c>d?(l[2].lerp(l[0],l[1],.33),l[3].lerp(l[0],l[1],.66)):(l[2].lerp(l[0],l[1],.5),l[3].a=0);for(var p=0;4>p;p++)h[4*p+0]=3&n[16*u+12+p],h[4*p+1]=n[16*u+12+p]>>2&3,h[4*p+2]=n[16*u+12+p]>>4&3,h[4*p+3]=n[16*u+12+p]>>6&3;for(var f=0;f<l.length;f++)l[f].r=8*l[f].r,l[f].g=4*l[f].g,l[f].b=8*l[f].b;var m=u%(r/4)*4,_=4*Math.floor(u/(r/4));i>_+0&&(r>m+0&&(s[(_+0)*(4*r)+4*(m+0)+0]=l[h[0]].r,s[(_+0)*(4*r)+4*(m+0)+1]=l[h[0]].g,s[(_+0)*(4*r)+4*(m+0)+2]=l[h[0]].b,s[(_+0)*(4*r)+4*(m+0)+3]=17*(15&n[16*u+0])),r>m+1&&(s[(_+0)*(4*r)+4*(m+1)+0]=l[h[1]].r,s[(_+0)*(4*r)+4*(m+1)+1]=l[h[1]].g,s[(_+0)*(4*r)+4*(m+1)+2]=l[h[1]].b,s[(_+0)*(4*r)+4*(m+1)+3]=17*(n[16*u+0]>>4&15)),r>m+2&&(s[(_+0)*(4*r)+4*(m+2)+0]=l[h[2]].r,s[(_+0)*(4*r)+4*(m+2)+1]=l[h[2]].g,s[(_+0)*(4*r)+4*(m+2)+2]=l[h[2]].b,s[(_+0)*(4*r)+4*(m+2)+3]=17*(15&n[16*u+1])),r>m+3&&(s[(_+0)*(4*r)+4*(m+3)+0]=l[h[3]].r,s[(_+0)*(4*r)+4*(m+3)+1]=l[h[3]].g,s[(_+0)*(4*r)+4*(m+3)+2]=l[h[3]].b,s[(_+0)*(4*r)+4*(m+3)+3]=17*(n[16*u+1]>>4&15))),i>_+1&&(r>m+0&&(s[(_+1)*(4*r)+4*(m+0)+0]=l[h[4]].r,s[(_+1)*(4*r)+4*(m+0)+1]=l[h[4]].g,s[(_+1)*(4*r)+4*(m+0)+2]=l[h[4]].b,s[(_+1)*(4*r)+4*(m+0)+3]=17*(15&n[16*u+2])),r>m+1&&(s[(_+1)*(4*r)+4*(m+1)+0]=l[h[5]].r,s[(_+1)*(4*r)+4*(m+1)+1]=l[h[5]].g,s[(_+1)*(4*r)+4*(m+1)+2]=l[h[5]].b,s[(_+1)*(4*r)+4*(m+1)+3]=17*(n[16*u+2]>>4&15)),r>m+2&&(s[(_+1)*(4*r)+4*(m+2)+0]=l[h[6]].r,s[(_+1)*(4*r)+4*(m+2)+1]=l[h[6]].g,s[(_+1)*(4*r)+4*(m+2)+2]=l[h[6]].b,s[(_+1)*(4*r)+4*(m+2)+3]=17*(15&n[16*u+3])),r>m+3&&(s[(_+1)*(4*r)+4*(m+3)+0]=l[h[7]].r,s[(_+1)*(4*r)+4*(m+3)+1]=l[h[7]].g,s[(_+1)*(4*r)+4*(m+3)+2]=l[h[7]].b,s[(_+1)*(4*r)+4*(m+3)+3]=17*(n[16*u+3]>>4&15))),i>_+2&&(r>m+0&&(s[(_+2)*(4*r)+4*(m+0)+0]=l[h[8]].r,s[(_+2)*(4*r)+4*(m+0)+1]=l[h[8]].g,s[(_+2)*(4*r)+4*(m+0)+2]=l[h[8]].b,s[(_+2)*(4*r)+4*(m+0)+3]=17*(15&n[16*u+4])),r>m+1&&(s[(_+2)*(4*r)+4*(m+1)+0]=l[h[9]].r,s[(_+2)*(4*r)+4*(m+1)+1]=l[h[9]].g,s[(_+2)*(4*r)+4*(m+1)+2]=l[h[9]].b,s[(_+2)*(4*r)+4*(m+1)+3]=17*(n[16*u+4]>>4&15)),r>m+2&&(s[(_+2)*(4*r)+4*(m+2)+0]=l[h[10]].r,s[(_+2)*(4*r)+4*(m+2)+1]=l[h[10]].g,s[(_+2)*(4*r)+4*(m+2)+2]=l[h[10]].b,s[(_+2)*(4*r)+4*(m+2)+3]=17*(15&n[16*u+5])),r>m+3&&(s[(_+2)*(4*r)+4*(m+3)+0]=l[h[11]].r,s[(_+2)*(4*r)+4*(m+3)+1]=l[h[11]].g,s[(_+2)*(4*r)+4*(m+3)+2]=l[h[11]].b,s[(_+2)*(4*r)+4*(m+3)+3]=17*(n[16*u+5]>>4&15))),i>_+3&&(r>m+0&&(s[(_+3)*(4*r)+4*(m+0)+0]=l[h[12]].r,s[(_+3)*(4*r)+4*(m+0)+1]=l[h[12]].g,s[(_+3)*(4*r)+4*(m+0)+2]=l[h[12]].b,s[(_+3)*(4*r)+4*(m+0)+3]=17*(15&n[16*u+6])),r>m+1&&(s[(_+3)*(4*r)+4*(m+1)+0]=l[h[13]].r,s[(_+3)*(4*r)+4*(m+1)+1]=l[h[13]].g,s[(_+3)*(4*r)+4*(m+1)+2]=l[h[13]].b,s[(_+3)*(4*r)+4*(m+1)+3]=17*(n[16*u+6]>>4&15)),r>m+2&&(s[(_+3)*(4*r)+4*(m+2)+0]=l[h[14]].r,s[(_+3)*(4*r)+4*(m+2)+1]=l[h[14]].g,s[(_+3)*(4*r)+4*(m+2)+2]=l[h[14]].b,s[(_+3)*(4*r)+4*(m+2)+3]=17*(15&n[16*u+7])),r>m+3&&(s[(_+3)*(4*r)+4*(m+3)+0]=l[h[15]].r,s[(_+3)*(4*r)+4*(m+3)+1]=l[h[15]].g,s[(_+3)*(4*r)+4*(m+3)+2]=l[h[15]].b,s[(_+3)*(4*r)+4*(m+3)+3]=17*(n[16*u+7]>>4&15)))
}break;case e.RGBA_S3TC_DXT5_FORMAT:}return s},r}();t.DDSParser=r,__reflect(r.prototype,"egret3d.DDSParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e,r){var i=new t.ByteArray(e),a=i.readByte();if(1==a){var n=i.readInt(),o=new t.ByteArray;i.readBytes(o,0,n),o.uncompress(),i=o}var s=new t.ByteArray;i.readBytes(s,0,7);var l=i.readUnsignedShort();if(!t.E3dPackVersion.versionDictionary[l])return console.log("egret3d engine not found "+l+" version"),null;var h=r.replace(".e3dPack","/");return t.E3dPackVersion.versionDictionary[l](i,h)},e}();t.E3dPackParser=e,__reflect(e.prototype,"egret3d.E3dPackParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e,r){for(var i={},a=(e.readUTF(),e.readUnsignedShort()),n=0;a>n;n++){var o=e.readUTF(),s=e.readUnsignedInt(),l=new t.ByteArray;e.readBytes(l,0,s),i[o]=l;var h=r+o;t.assetMgr.addByteArray(h,l,r)}return i},e}();e.versionDictionary={1:function(t,r){return e.parserVersion_1(t,r)}},t.E3dPackVersion=e,__reflect(e.prototype,"egret3d.E3dPackVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var r=new t.ByteArray(e),i=new t.ByteArray;r.readBytes(i,0,3);var a=r.readUnsignedInt();return t.EAMVersion.versionDictionary[a]?t.EAMVersion.versionDictionary[a](r):(console.log("egret3d engine not found "+a+" version"),null)},e}();t.EAMParser=e,__reflect(e.prototype,"egret3d.EAMParser")}(egret3d||(egret3d={}));var egret3d;!function(egret3d){function requestFullScreen(){var t=document.documentElement;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()}function exitFullscreen(){var t=document;t.exitFullscreen?t.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}function setObjectSrceenPos(t,e,r,i){i.object3DToScreenRay(new egret3d.Vector3D,egret3d.Vector3D.HELP_0),egret3d.Vector3D.HELP_0.setTo(t,e,egret3d.Vector3D.HELP_0.z),i.ScreenRayToObject3D(egret3d.Vector3D.HELP_0,egret3d.Vector3D.HELP_1),r.globalPosition=egret3d.Vector3D.HELP_1}var Egret3DPolicy=function(){function t(){}return t}();Egret3DPolicy.engineVersion="4.0.0",Egret3DPolicy.exportToolsVersion=["4.0.0","3.2.6"],Egret3DPolicy.useParticle=!0,Egret3DPolicy.useAnimEffect=!0,Egret3DPolicy.useEffect=!0,Egret3DPolicy.useRibbon=!0,Egret3DPolicy.useAnimPoseInterpolation=!0,Egret3DPolicy.useAnimMixInterpolation=!0,Egret3DPolicy.useAnimCache=!1,Egret3DPolicy.useLowLoop=!1,Egret3DPolicy.useLight=!0,Egret3DPolicy.usePost=!0,Egret3DPolicy.useCompress=!1,Egret3DPolicy.useLowLOD=!1,egret3d.Egret3DPolicy=Egret3DPolicy,__reflect(Egret3DPolicy.prototype,"egret3d.Egret3DPolicy"),egret3d.requestFullScreen=requestFullScreen,egret3d.exitFullscreen=exitFullscreen,egret3d.setObjectSrceenPos=setObjectSrceenPos;var Egret3DEngine=function(){function Egret3DEngine(){this.performance=new egret3d.Egret3DPerformance,this.inspector=new egret3d.Egret3DInspector,this.version="4.0.0",this.jsPath="js/",this.debug=!1,this._tsconfigs=[],this.importList=[],this._tsconfigs.push("Egret3D/tsconfig.json")}return Egret3DEngine.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},Egret3DEngine.prototype.useDevicePOLICY=function(t){switch(void 0===t&&(t=0),t){case 0:this.isWeiXin()&&(Egret3DPolicy.useAnimPoseInterpolation=!1,Egret3DPolicy.useAnimMixInterpolation=!1),this.isAndroid()&&(Egret3DPolicy.useAnimPoseInterpolation=!1,Egret3DPolicy.useAnimMixInterpolation=!1,Egret3DPolicy.useParticle=!1)}},Egret3DEngine.prototype.isWeiXin=function(){var t=self.navigator.userAgent.toLowerCase(),e=t.indexOf("micromessenger");return-1!=e?!0:!1},Egret3DEngine.prototype.isAndroid=function(){var t=self.navigator.userAgent.toLowerCase(),e=t.indexOf("android");return-1!=e?!0:!1},Egret3DEngine.prototype.addTsconfig=function(t){this._tsconfigs.push(t)},Egret3DEngine.prototype.setTsconfig=function(t,e){this._tsconfigs[t]=e},Egret3DEngine.prototype.clearTsconfig=function(){this._tsconfigs.length=0},Egret3DEngine.prototype.preload=function(t,e){void 0===e&&(e=null),this._complete=t,this._thisObject=e,this._tsconfigs.length>0?this.doLoader(this._tsconfigs[0]):this.onAllLoadComplete()},Egret3DEngine.prototype.addImportScript=function(t){this.importList.push(t)},Egret3DEngine.prototype.doLoader=function(t){var e=this;return this._currentConfig=t,null==this._xhr&&(this._xhr=Egret3DEngine.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&this._xhr.abort(),this._xhr.open("GET",t+"?"+1e5*Math.random(),!0),this._xhr.addEventListener("progress",function(t){return e.onProgress(t)},!1),this._xhr.addEventListener("readystatechange",function(t){return e.onReadyStateChange(t)},!1),this._xhr.addEventListener("error",function(t){return e.onError(t)},!1),this._xhr.responseType="text",void this._xhr.send())},Egret3DEngine.prototype.onProgress=function(t){t.loaded.toString()+t.total},Egret3DEngine.prototype.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400||0==this._xhr.status?console.log(this._currentConfig,"load fail"):this.onLoadComplete(this._xhr.responseText))},Egret3DEngine.prototype.onLoadComplete=function(source){for(var s_pos=this._currentConfig.lastIndexOf("/"),dir=this._currentConfig.substr(0,s_pos+1),obj=eval("("+source+")"),importName,i=0;i<obj.files.length;++i)importName=this.jsPath+dir,importName+=obj.files[i],importName=importName.replace(".ts",".js"),this.importList.push(importName);var index=this._tsconfigs.indexOf(this._currentConfig);index==this._tsconfigs.length-1?this.onAllLoadTsconfigComplete():(this._xhr=null,this.doLoader(this._tsconfigs[++index]))},Egret3DEngine.prototype.onError=function(t){},Egret3DEngine.prototype.onAllLoadTsconfigComplete=function(){this.onTsconfig&&this.onTsconfig(),this.startLoadScript(null)},Egret3DEngine.prototype.onAllLoadComplete=function(){this._complete&&(this._thisObject?this._complete.call(this._thisObject):this._complete())},Egret3DEngine.prototype.startLoadScript=function(t){var e=this;if(this.importList.length>0){var r=document.createElement("script");r.src=this.importList.shift(),r.onload=function(t){return e.startLoadScript(t)},r.onerror=function(t){return e.loadScriptError(t)},document.head.appendChild(r)}else console.log("all complete"),this.onAllLoadComplete()},Egret3DEngine.prototype.loadScriptError=function(t){var e="load Script Error \r\n no file:"+t.srcElement.src;alert(e),this.startLoadScript(null)},Egret3DEngine}();Egret3DEngine.instance=new Egret3DEngine,egret3d.Egret3DEngine=Egret3DEngine,__reflect(Egret3DEngine.prototype,"egret3d.Egret3DEngine")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var r=new t.ByteArray(e),i=new t.ByteArray;r.readBytes(i,0,3);var a=r.readUnsignedInt();return t.ECAVersion.versionDictionary[a]?t.ECAVersion.versionDictionary[a](r):(console.log("egret3d engine not found "+a+" version"),null)},e}();t.ECAParser=e,__reflect(e.prototype,"egret3d.ECAParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e){for(var r=new t.CameraAnimationController,i=e.readUnsignedInt(),a=null,n=new t.Vector3D(1,1,1,1);i--;)a=new t.CameraAnimationFrame,a.time=e.readInt(),a.fov=e.readFloat(),a.rotation=new t.Vector3D(e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES+90,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES),a.translation=new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()),a.matrix=new t.Matrix4_4,a.matrix.recompose([a.translation,a.rotation,n]),r.cameraAnimationFrames.push(a);return r},e}();e.versionDictionary={1:function(t){return e.parserVersion_1(t)}},t.ECAVersion=e,__reflect(e.prototype,"egret3d.ECAVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var r=new t.ByteArray(e);if(1701863680!=r.readUnsignedInt())return null;var i=r.readUnsignedInt();return t.EPAVersion.versionDictionary[i]?t.EPAVersion.versionDictionary[i](r):(console.log("egret3d engine not found "+i+" version"),null)},e}();t.EPAParser=e,__reflect(e.prototype,"egret3d.EPAParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(r){for(var i=new t.PropertyAnim,a=r.readUnsignedShort(),n=0;a>n;n++){for(var o=r.readUTF(),s=[],l=r.readUnsignedShort(),h=0;l>h;h++){var u=new t.AnimCurve;u.type=r.readUnsignedInt(),u.type&e.VALUE_TYPE_UINT?(u.frame=r.readFloat(),u.frame=Math.floor(u.frame/16),u.value=r.readUnsignedInt(),r.readFloat(),r.readUnsignedInt(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat()):(u.frame=r.readFloat(),u.frame=Math.floor(u.frame/16),u.value=r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat()),s.push(u)}i.addAnimCurve(o,s)}return i},e.parserVersion_2=function(r){for(var i=new t.PropertyAnim,a=(r.readFloat(),r.readUnsignedByte(),r.readUnsignedShort()),n=0;a>n;n++){for(var o=r.readUTF(),s=[],l=r.readUnsignedShort(),h=0;l>h;h++){var u=new t.AnimCurve;u.type=r.readUnsignedInt(),u.type&e.VALUE_TYPE_UINT?(u.frame=r.readFloat(),u.frame=Math.floor(u.frame/16),u.value=r.readUnsignedInt(),r.readFloat(),r.readUnsignedInt(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat()):(u.frame=r.readFloat(),u.frame=Math.floor(u.frame/16),u.value=r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat()),s.push(u)}i.addAnimCurve(o,s)}return i},e}();e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)}},e.VALUE_TYPE_UINT=1073741824,t.EPAVersion=e,__reflect(e.prototype,"egret3d.EPAVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e,r){void 0===r&&(r=null);var i=new t.ByteArray(e),a=new t.ByteArray;i.readBytes(a,0,3);var n=i.readUnsignedInt();if(!t.ESMVersion.versionDictionary[n])return console.log("egret3d engine not found "+n+" version"),null;var o=new t.GeometryData;t.ESMVersion.versionDictionary[n](i,o,r);var s,l=0;return o.source_skinData.length>0?(l=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_SKIN,s=t.GeometryData.buildGeomtry(o,l)):(l=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1,s=t.GeometryData.buildGeomtry(o,l)),o=null,s},e}();t.ESMParser=e,__reflect(e.prototype,"egret3d.ESMParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e,r,i){var a=e.readInt();r.matCount=e.readInt();for(var n=0;n<r.matCount;++n)r.material[n]={},r.material[n].matID=e.readInt(),r.material[n].start=e.readInt(),r.material[n].count=e.readInt(),r.material[n].textureDiffuse=e.readUTF(),r.material[n].textureNormal=e.readUTF(),r.material[n].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var o=e.readInt(),n=0;o>n;n++)r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL)for(var s=e.readInt(),n=0;s>n;n++)r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat());if(a&t.VertexFormat.VF_COLOR)for(var l=e.readInt(),n=0;l>n;n++)r.source_vertexColorData.push(e.readFloat()),r.source_vertexColorData.push(e.readFloat()),r.source_vertexColorData.push(e.readFloat()),r.source_vertexColorData.push(e.readFloat());if(a&t.VertexFormat.VF_UV0)for(var h=e.readInt(),n=0;h>n;n++)r.source_uvData.push(e.readFloat()),r.source_uvData.push(e.readFloat());if(a&t.VertexFormat.VF_UV1)for(var h=e.readInt(),n=0;h>n;n++)r.source_uv2Data.push(e.readFloat()),r.source_uv2Data.push(e.readFloat());r.faces=e.readInt();for(var n=0;n<r.faces;n++)r.vertexIndices.push(e.readUnsignedInt()),r.vertexIndices.push(e.readUnsignedInt()),r.vertexIndices.push(e.readUnsignedInt()),a&t.VertexFormat.VF_NORMAL&&(r.normalIndices.push(e.readUnsignedInt()),r.normalIndices.push(e.readUnsignedInt()),r.normalIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_COLOR&&(r.colorIndices.push(e.readUnsignedInt()),r.colorIndices.push(e.readUnsignedInt()),r.colorIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_UV0&&(r.uvIndices.push(e.readUnsignedInt()),r.uvIndices.push(e.readUnsignedInt()),r.uvIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_UV1&&(r.uv2Indices.push(e.readUnsignedInt()),r.uv2Indices.push(e.readUnsignedInt()),r.uv2Indices.push(e.readUnsignedInt()));var u=e.readUnsignedByte();u>0&&(r.skeleton=new t.Skeleton);for(var c=(new t.Quaternion,new t.Vector3D),d=new t.Vector3D,p=new t.Vector3D,n=0;u>n;++n){var f=new t.Joint;e.readInt(),f.parentIndex=e.readInt(),f.name=e.readUTF(),c.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),p.x=e.readFloat(),p.y=e.readFloat(),p.z=e.readFloat(),f.buildInverseMatrix(d,c,p),r.skeleton.joints.push(f)}for(var m=e.readInt(),n=0;m>n;n++){for(var _=e.readUnsignedByte(),v=0;_>v;v++)r.source_skinData.push(e.readUnsignedByte()),r.source_skinData.push(e.readFloat());for(var v=_;4>v;v++)r.source_skinData.push(0),r.source_skinData.push(0)}},e.parserVersion_2=function(e,r,i){var a=e.readInt();r.matCount=e.readInt();for(var n=0;n<r.matCount;++n)r.material[n]={},r.material[n].matID=e.readInt(),r.material[n].start=e.readInt(),r.material[n].count=e.readInt(),r.material[n].textureDiffuse=e.readUTF(),r.material[n].textureNormal=e.readUTF(),r.material[n].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var o=e.readInt(),n=0;o>n;n++)r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL)for(var s=e.readInt(),n=0;s>n;n++)r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat());if(a&t.VertexFormat.VF_COLOR)for(var l=e.readInt(),n=0;l>n;n++)r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255);if(a&t.VertexFormat.VF_UV0)for(var h=e.readInt(),n=0;h>n;n++)r.source_uvData.push(e.readFloat()),r.source_uvData.push(e.readFloat());if(a&t.VertexFormat.VF_UV1)for(var h=e.readInt(),n=0;h>n;n++)r.source_uv2Data.push(e.readFloat()),r.source_uv2Data.push(e.readFloat());r.faces=e.readInt();for(var n=0;n<r.faces;n++)r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),a&t.VertexFormat.VF_NORMAL&&(r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_COLOR&&(r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV0&&(r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV1&&(r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()));var u=e.readUnsignedByte();u>0&&(r.skeleton=new t.Skeleton);for(var c=(new t.Quaternion,new t.Vector3D),d=new t.Vector3D,p=new t.Vector3D,n=0;u>n;++n){var f=new t.Joint;e.readInt(),f.parentIndex=e.readInt(),f.name=e.readUTF(),c.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),p.x=e.readFloat(),p.y=e.readFloat(),p.z=e.readFloat(),f.buildInverseMatrix(d,c,p),r.skeleton.joints.push(f)}for(var m=e.readInt(),n=0;m>n;n++){for(var _=e.readUnsignedByte(),v=0;_>v;v++)r.source_skinData.push(e.readUnsignedByte()),r.source_skinData.push(e.readFloat());for(var v=_;4>v;v++)r.source_skinData.push(0),r.source_skinData.push(0)}},e.parserVersion_3=function(e,r,i){var a=e.readInt();r.matCount=e.readInt();for(var n=0,o=0,s=0,l=0,h=0;h<r.matCount;++h)r.material[h]={},r.material[h].matID=e.readInt(),r.material[h].start=e.readInt(),r.material[h].count=e.readInt(),r.material[h].textureDiffuse=e.readUTF(),r.material[h].textureNormal=e.readUTF(),r.material[h].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var u=e.readInt(),h=0;u>h;h++)r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var h=0;n>h;h++)r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat())}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var h=0;o>h;h++)r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255)}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var h=0;s>h;h++)r.source_uvData.push(e.readFloat()),r.source_uvData.push(e.readFloat())}if(a&t.VertexFormat.VF_UV1){l=e.readInt();for(var h=0;l>h;h++)r.source_uv2Data.push(e.readFloat()),r.source_uv2Data.push(e.readFloat())}r.faces=e.readInt();for(var h=0;h<r.faces;h++)r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),a&t.VertexFormat.VF_NORMAL&&(r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_COLOR&&(r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV0&&(r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV1&&(r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()));var c=e.readUnsignedByte();c>0&&(r.skeleton=new t.Skeleton);for(var d=new t.Quaternion,p=(new t.Vector3D,new t.Vector3D),f=new t.Vector3D,h=0;c>h;++h){var m=new t.Joint;e.readInt(),m.parentIndex=e.readInt(),m.name=e.readUTF(),d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),d.w=e.readFloat(),p.x=e.readFloat(),p.y=e.readFloat(),p.z=e.readFloat(),f.x=e.readFloat(),f.y=e.readFloat(),f.z=e.readFloat(),m.buildInverseMatrix(p,d,f),r.skeleton.joints.push(m)}for(var _=e.readInt(),h=0;_>h;h++){for(var v=e.readUnsignedByte(),g=0;v>g;g++)r.source_skinData.push(e.readUnsignedByte()),r.source_skinData.push(e.readFloat());for(var g=v;4>g;g++)r.source_skinData.push(0),r.source_skinData.push(0)}},e.parserVersion_4=function(e,r,i){var a=e.readInt();r.matCount=e.readInt();for(var n=0,o=0,s=0,l=0,h=0;h<r.matCount;++h)r.material[h]={},r.material[h].matID=e.readInt(),r.material[h].start=e.readInt(),r.material[h].count=e.readInt(),r.material[h].textureDiffuse=e.readUTF(),r.material[h].textureNormal=e.readUTF(),r.material[h].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var u=e.readInt(),h=0;u>h;h++)r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var h=0;n>h;h++)r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat()),r.source_normalData.push(e.readFloat())}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var h=0;o>h;h++)r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255)}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var h=0;s>h;h++)r.source_uvData.push(e.readFloat()),r.source_uvData.push(e.readFloat())}if(a&t.VertexFormat.VF_UV1){l=e.readInt();for(var h=0;l>h;h++)r.source_uv2Data.push(e.readFloat()),r.source_uv2Data.push(e.readFloat())}r.faces=e.readInt();for(var h=0;h<r.faces;h++)r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),r.vertexIndices.push(e.readUnsignedShort()),n>0&&a&t.VertexFormat.VF_NORMAL&&(r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort()),r.normalIndices.push(e.readUnsignedShort())),o>0&&a&t.VertexFormat.VF_COLOR&&(r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort()),r.colorIndices.push(e.readUnsignedShort())),s>0&&a&t.VertexFormat.VF_UV0&&(r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort()),r.uvIndices.push(e.readUnsignedShort())),l>0&&a&t.VertexFormat.VF_UV1&&(r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()),r.uv2Indices.push(e.readUnsignedShort()));var c=e.readUnsignedByte();c>0&&(r.skeleton=new t.Skeleton);for(var d=new t.Quaternion,p=(new t.Vector3D,new t.Vector3D),f=new t.Vector3D,h=0;c>h;++h){var m=new t.Joint;e.readInt(),m.parentIndex=e.readInt(),m.name=e.readUTF(),d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),d.w=e.readFloat(),p.x=e.readFloat(),p.y=e.readFloat(),p.z=e.readFloat(),f.x=e.readFloat(),f.y=e.readFloat(),f.z=e.readFloat(),m.buildInverseMatrix(p,d,f),r.skeleton.joints.push(m)}for(var _=e.readInt(),h=0;_>h;h++){for(var v=e.readUnsignedByte(),g=0;v>g;g++)r.source_skinData.push(e.readUnsignedByte()),r.source_skinData.push(e.readFloat());for(var g=v;4>g;g++)r.source_skinData.push(0),r.source_skinData.push(0)}},e.parserVersion_5=function(e,r,i){var a=e.readInt();r.matCount=e.readInt();for(var n=0,o=0,s=0,l=0,h=0;h<r.matCount;++h)r.material[h]={},r.material[h].matID=e.readInt(),r.material[h].start=e.readInt(),r.material[h].count=e.readInt(),r.material[h].textureDiffuse=e.readUTF(),r.material[h].textureNormal=e.readUTF(),r.material[h].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var u=e.readInt(),h=0;u>h;h++)r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat()),r.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL){n=e.readInt();for(var h=0;n>h;h++)r.source_normalData.push(e.readByte()/125),r.source_normalData.push(e.readByte()/125),r.source_normalData.push(e.readByte()/125)}if(a&t.VertexFormat.VF_COLOR){o=e.readInt();for(var h=0;o>h;h++)r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255),r.source_vertexColorData.push(e.readUnsignedByte()/255)}if(a&t.VertexFormat.VF_UV0){s=e.readInt();for(var h=0;s>h;h++)r.source_uvData.push(e.readFloat()),r.source_uvData.push(e.readFloat())}if(a&t.VertexFormat.VF_UV1){l=e.readInt();for(var h=0;l>h;h++)r.source_uv2Data.push(e.readFloat()),r.source_uv2Data.push(e.readFloat())}r.faces=e.readInt();for(var h=0;h<r.faces;h++){var c=e.readUnsignedShort(),d=e.readUnsignedShort(),p=e.readUnsignedShort();r.vertexIndices.push(c),r.vertexIndices.push(d),r.vertexIndices.push(p),n>0&&a&t.VertexFormat.VF_NORMAL&&(r.normalIndices.push(c),r.normalIndices.push(d),r.normalIndices.push(p)),o>0&&a&t.VertexFormat.VF_COLOR&&(r.colorIndices.push(c),r.colorIndices.push(d),r.colorIndices.push(p)),s>0&&a&t.VertexFormat.VF_UV0&&(r.uvIndices.push(c),r.uvIndices.push(d),r.uvIndices.push(p)),l>0&&a&t.VertexFormat.VF_UV1&&(r.uv2Indices.push(c),r.uv2Indices.push(d),r.uv2Indices.push(p))}var f=e.readUnsignedByte();f>0&&(r.skeleton=new t.Skeleton);for(var m=new t.Quaternion,_=(new t.Vector3D,new t.Vector3D),v=new t.Vector3D,h=0;f>h;++h){var g=new t.Joint;e.readInt(),g.parentIndex=e.readInt(),g.name=e.readUTF(),m.x=e.readFloat(),m.y=e.readFloat(),m.z=e.readFloat(),m.w=e.readFloat(),_.x=e.readFloat(),_.y=e.readFloat(),_.z=e.readFloat(),v.x=e.readFloat(),v.y=e.readFloat(),v.z=e.readFloat(),g.buildInverseMatrix(_,m,v),r.skeleton.joints.push(g)}for(var y=e.readInt(),h=0;y>h;h++){for(var x=e.readUnsignedByte(),b=0;x>b;b++)r.source_skinData.push(e.readUnsignedByte()),r.source_skinData.push(e.readFloat());for(var b=x;4>b;b++)r.source_skinData.push(0),r.source_skinData.push(0)}},e}();e.versionDictionary={1:function(t,r,i){return e.parserVersion_1(t,r,i)},2:function(t,r,i){return e.parserVersion_2(t,r,i)},3:function(t,r,i){return e.parserVersion_3(t,r,i)},4:function(t,r,i){return e.parserVersion_4(t,r,i)},5:function(t,r,i){return e.parserVersion_5(t,r,i)}},t.ESMVersion=e,__reflect(e.prototype,"egret3d.ESMVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var r=new t.ByteArray(e),i=new t.ByteArray;r.readBytes(i,0,3);var a=r.readUnsignedShort();return t.EUMVersion.versionDictionary[a]?(t.EUMVersion.versionValue=a,t.EUMVersion.versionDictionary[a](r)):(console.log("egret3d engine not found "+a+" version"),null)},e}();t.EUMParser=e,__reflect(e.prototype,"egret3d.EUMParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e){for(var r={},i=e.readUnsignedInt(),a=0;i>a;a++){var n=e.readUnsignedInt(),o=e.readUnsignedInt(),s=new t.ByteArray;e.readBytes(s,0,o),r[n]=s}return r},e.parserVersion_2=function(e){for(var r={},i=e.readUnsignedInt(),a=0;i>a;a++){var n=e.readUnsignedInt(),o=e.readUnsignedInt(),s=new t.ByteArray;e.readBytes(s,0,o),r[n]=s}return r},e.fillGeometryUv2=function(t,r,i){switch(e.versionValue){case 1:return e.fillGeometryUv2_1(t,r,i);case 2:return e.fillGeometryUv2_2(t,r,i);default:return null}},e.fillGeometryUv2_1=function(e,r,i){if(r&&r[e]){var a=r[e];a.position=0;for(var n=[],o=a.readUnsignedInt(),s=0;o>s;s++)n.push(a.readFloat()),n.push(a.readFloat());for(var l=0,h=a.readUnsignedInt(),s=0;h>s;s++)for(var u=0;3>u;++u){l=3*s+u;var c=a.readUnsignedShort(),d=n[c*t.Geometry.uv2Size+0],p=n[c*t.Geometry.uv2Size+1];i.setVerticesForIndex(l,t.VertexFormat.VF_UV1,[d,p])}}},e.fillGeometryUv2_2=function(e,r,i){if(r&&r[e]){var a=r[e];a.position=0;for(var n=a.readFloat(),o=a.readFloat(),s=a.readFloat(),l=a.readFloat(),h=0,u=i.faceCount,c=0;u>c;c++)for(var d=0;3>d;++d){h=3*c+d;var p=i.getVertexForIndex(h,t.VertexFormat.VF_UV1),f=p[0]*n+s,m=1-(p[1]*o+l);i.setVerticesForIndex(h,t.VertexFormat.VF_UV1,[f,m])}}},e}();e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)}},t.EUMVersion=e,__reflect(e.prototype,"egret3d.EUMVersion")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.ldexp=function(t,e){return e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):-1074>e?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e)},e.readPixelsRawRLE=function(t,e,r,i,a,n){function o(e){var r=0;do e[r++]=t[i];while(++i<m&&r<e.length);return r}function s(e,r,a){var n=0;do e[r+n++]=t[i];while(++i<m&&a>n);return n}function l(t,e,r,i){var a=4*i,n=s(e,r,a);if(a>n)throw new Error("Error reading raw pixels: got "+n+" bytes, expected "+a)}for(var h,u,c,d=new Array(4),p=null,f=new Array(2),m=t.length;n>0;){if(o(d)<d.length)throw new Error("Error reading bytes: expected "+d.length);if(2!=d[0]||2!=d[1]||0!=(128&d[2]))return e[r++]=d[0],e[r++]=d[1],e[r++]=d[2],e[r++]=d[3],void l(t,e,r,a*n-1);if(((255&d[2])<<8|255&d[3])!=a)throw new Error("Wrong scanline width "+((255&d[2])<<8|255&d[3])+", expected "+a);null==p&&(p=new Array(4*a)),h=0;for(var _=0;4>_;_++)for(u=(_+1)*a;u>h;){if(o(f)<f.length)throw new Error("Error reading 2-byte buffer");if((255&f[0])>128){if(c=(255&f[0])-128,0==c||c>u-h)throw new Error("Bad scanline data");for(;c-->0;)p[h++]=f[1]}else{if(c=255&f[0],0==c||c>u-h)throw new Error("Bad scanline data");if(p[h++]=f[1],--c>0){if(s(p,h,c)<c)throw new Error("Error reading non-run data");h+=c}}}for(var _=0;a>_;_++)e[r+0]=p[_],e[r+1]=p[_+a],e[r+2]=p[_+2*a],e[r+3]=p[_+3*a],r+=4;n--}},e.parse=function(r){function i(){var t="";do{var e=r[a];if(e==o){++a;break}t+=String.fromCharCode(e)}while(++a<n);return t}r instanceof ArrayBuffer&&(r=new Uint8Array(r));for(var a=0,n=r.length,o=10,s=0,l=0,h=1,u=!1,c=0;20>c;c++){var d,p=i();if(d=p.match(e.radiancePattern));else if(d=p.match(e.formatPattern))u=!0;else if(d=p.match(e.exposurePattern))h=Number(d[1]);else if(d=p.match(e.commentPattern));else if(d=p.match(e.widthHeightPattern)){l=Number(d[1]),s=Number(d[2]);break}}if(!u)throw new Error("File is not run length encoded!");var f=new Uint8Array(s*l*4),m=s,_=l;this.readPixelsRawRLE(r,f,0,a,m,_);var v=new t.MipmapData(f,s,l),g=new t.Texture;return g.internalFormat=t.InternalFormat.PixelArray,g.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,g.mimapData=[v],g.useMipmap=!1,g.width=s,g.height=l,g},e}();e.radiancePattern="#\\?RADIANCE",e.commentPattern="#.*",e.gammaPattern="GAMMA=",e.exposurePattern="EXPOSURE=\\s*([0-9]*[.][0-9]*)",e.formatPattern="FORMAT=32-bit_rle_rgbe",e.widthHeightPattern="-Y ([0-9]+) \\+X ([0-9]+)",t.HDRParser=e,__reflect(e.prototype,"egret3d.HDRParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.PVR=e,__reflect(e.prototype,"egret3d.PVR")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.RGB_PVRTC_4BPPV1_Format=2100]="RGB_PVRTC_4BPPV1_Format",t[t.RGB_PVRTC_2BPPV1_Format=2101]="RGB_PVRTC_2BPPV1_Format",t[t.RGBA_PVRTC_4BPPV1_Format=2102]="RGBA_PVRTC_4BPPV1_Format",t[t.RGBA_PVRTC_2BPPV1_Format=2103]="RGBA_PVRTC_2BPPV1_Format"}(e=t.PVRFormat||(t.PVRFormat={}));var r=function(){function r(){}return r.parse=function(e){var i,a=13,n=new Uint32Array(e,0,a),o={buffer:e,header:n};if(55727696===n[0])i=r._parseV3(o);else{if(559044176!==n[11])return console.log("PVRParser unknow pvr format. PVRParser::parse"),i;i=r._parseV2(o)}return i.internalFormat=t.InternalFormat.PixelArray,i.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,i.useMipmap=!1,i},r._parseV2=function(t){var i,a,n=t.header,o=n[0],s=n[1],l=n[2],h=n[3],u=n[4],i=(n[5],n[6]),c=(n[7],n[8],n[9],n[10]),d=(n[11],n[12]),p=255,f=24,m=25,_=u&p,v=c>0;if(_===m)a=v?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format,i=4;else{if(_!==f)throw new Error("pvrtc - unknown format "+_);a=v?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format,i=2}return t.dataPtr=o,t.bpp=i,t.format=a,t.width=l,t.height=s,t.numSurfaces=d,t.numMipmaps=h+1,t.isCubemap=6===d,r._extract(t)},r._parseV3=function(t){var i,a,n=t.header,o=n[12],s=n[2],l=n[6],h=n[7],u=(n[9],n[10]),c=n[11];switch(s){case 0:i=2,a=e.RGB_PVRTC_2BPPV1_Format;break;case 1:i=2,a=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:i=4,a=e.RGB_PVRTC_4BPPV1_Format;break;case 3:i=4,a=e.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+s)}return t.dataPtr=52+o,t.bpp=i,t.format=a,t.width=h,t.height=l,t.numSurfaces=u,t.numMipmaps=c,t.isCubemap=6===u,r._extract(t)},r._extract=function(e){var r=new t.Texture;r.width=e.width,r.height=e.height;var i=e.buffer,a=e.dataPtr,n=e.bpp,o=e.numSurfaces,s=0,l=0,h=0,u=0,c=0,d=0;2===n?(h=8,u=4):(h=4,u=4),l=h*u*n/8,r.mimapData=[];for(var p=0;p<e.numMipmaps;){var f=e.width>>p,m=e.height>>p;c=f/h,d=m/u,2>c&&(c=2),2>d&&(d=2),s=c*d*l;for(var _=0;o>_;_++){var v=new Uint8Array(i,a,s),g={data:v,width:f,height:m};r.mimapData[_*e.numMipmaps+p]=g,a+=s}p++}return r},r}();t.PVRParser=r,__reflect(r.prototype,"egret3d.PVRParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r._event=new t.ParserEvent3D,r}return __extends(r,e),r.prototype.parser=function(e){var r=this,i=new t.ByteArray(e),a=new t.ByteArray;i.readBytes(a,0,3),i.position=0;var n=0;switch(n|=a.readUnsignedByte()<<16,n|=a.readUnsignedByte()<<8,n|=a.readUnsignedByte()){case 4473939:this.datas=t.DDSParser.parse(e),this.dataFormat=".dds",this.doLoadComplete();
break;case 2:case 16:this.datas=t.TGAParser.parse(e),this.dataFormat=".tga",this.doLoadComplete();break;case 16767231:var o=new Blob([e]);this.dataFormat=".jpg";var s=document.createElement("img");void 0!=window.createObjectURL?s.src=window.createObjectURL(o):void 0!=window.URL?s.src=window.URL.createObjectURL(o):void 0!=window.webkitURL&&(s.src=window.webkitURL.createObjectURL(o)),s.onload=function(){return r.onLoad(s)};break;case 8998990:var o=new Blob([e]);this.dataFormat=".png";var s=document.createElement("img");void 0!=window.createObjectURL?s.src=window.createObjectURL(o):void 0!=window.URL?s.src=window.URL.createObjectURL(o):void 0!=window.webkitURL&&(s.src=window.webkitURL.createObjectURL(o)),s.onload=function(){return r.onLoad(s)};break;case 6648685:this.dataFormat=".esm",this.datas=t.ESMParser.parse(e),this.doLoadComplete();break;case 6644077:this.dataFormat=".eam",this.datas=t.EAMParser.parse(e),this.doLoadComplete();break;case 6644577:this.dataFormat=".eca",this.datas=t.ECAParser.parse(e),this.doLoadComplete();break;default:return!1}return!0},r.prototype.onLoad=function(e){this.datas=new t.ImageTexture(e),this.doLoadComplete(),window.URL.revokeObjectURL(e.src),e.onload=null},r.prototype.doLoadComplete=function(){this._event.eventType=t.ParserEvent3D.PARSER_COMPLETE,this._event.data=this,this._event.parser=this,this.dispatchEvent(this._event)},r}(t.EventDispatcher);t.ParserUtils=e,__reflect(e.prototype,"egret3d.ParserUtils")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){function r(t){switch(t.image_type){case d:case m:(t.colormap_length>256||24!==t.colormap_size||1!==t.colormap_type)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case p:case f:case _:case v:t.colormap_type&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case c:console.error("TGAParser.parse.tgaCheckHeader: No data");break;default:console.error('TGAParser.parse.tgaCheckHeader: Invalid type " '+t.image_type+'"')}(t.width<=0||t.height<=0)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid image size"),8!==t.pixel_size&&16!==t.pixel_size&&24!==t.pixel_size&&32!==t.pixel_size&&console.error('TGAParser.parse.tgaCheckHeader: Invalid pixel size "'+t.pixel_size+'"')}function i(t,e,r,i,a){var n,o,s,l;if(o=r.pixel_size>>3,s=r.width*r.height*o,e&&(l=a.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),t){n=new Uint8Array(s);for(var h,u,c,d=0,p=new Uint8Array(o);s>d;)if(h=a[i++],u=(127&h)+1,128&h){for(c=0;o>c;++c)p[c]=a[i++];for(c=0;u>c;++c)n.set(p,d+c*o);d+=o*u}else{for(u*=o,c=0;u>c;++c)n[d+c]=a[i++];d+=u}}else n=a.subarray(i,i+=e?r.width*r.height:s);return{pixel_data:n,palettes:l}}function a(t,e,r,i,a,n,o,s,l){var h,u,c,d=l,p=0,f=w.width;for(c=e;c!==i;c+=r)for(u=a;u!==o;u+=n,p++)h=s[p],t[4*(u+f*c)+3]=255,t[4*(u+f*c)+2]=d[3*h+0],t[4*(u+f*c)+1]=d[3*h+1],t[4*(u+f*c)+0]=d[3*h+2];return t}function n(t,e,r,i,a,n,o,s){var l,h,u,c=0,d=w.width;for(u=e;u!==i;u+=r)for(h=a;h!==o;h+=n,c+=2)l=s[c+0]+(s[c+1]<<8),t[4*(h+d*u)+0]=(31744&l)>>7,t[4*(h+d*u)+1]=(992&l)>>2,t[4*(h+d*u)+2]=(31&l)>>3,t[4*(h+d*u)+3]=32768&l?0:255;return t}function o(t,e,r,i,a,n,o,s){var l,h,u=0,c=w.width;for(h=e;h!==i;h+=r)for(l=a;l!==o;l+=n,u+=3)t[4*(l+c*h)+3]=255,t[4*(l+c*h)+2]=s[u+0],t[4*(l+c*h)+1]=s[u+1],t[4*(l+c*h)+0]=s[u+2];return t}function s(t,e,r,i,a,n,o,s){var l,h,u=0,c=w.width;for(h=e;h!==i;h+=r)for(l=a;l!==o;l+=n,u+=4)t[4*(l+c*h)+2]=s[u+0],t[4*(l+c*h)+1]=s[u+1],t[4*(l+c*h)+0]=s[u+2],t[4*(l+c*h)+3]=s[u+3];return t}function l(t,e,r,i,a,n,o,s){var l,h,u,c=0,d=w.width;for(u=e;u!==i;u+=r)for(h=a;h!==o;h+=n,c++)l=s[c],t[4*(h+d*u)+0]=l,t[4*(h+d*u)+1]=l,t[4*(h+d*u)+2]=l,t[4*(h+d*u)+3]=255;return t}function h(t,e,r,i,a,n,o,s){var l,h,u=0,c=w.width;for(h=e;h!==i;h+=r)for(l=a;l!==o;l+=n,u+=2)t[4*(l+c*h)+0]=s[u+0],t[4*(l+c*h)+1]=s[u+0],t[4*(l+c*h)+2]=s[u+0],t[4*(l+c*h)+3]=s[u+1];return t}function u(t,e,r,i){var u,c,d,p,f,m,_=new Uint8Array(t*e*4);switch((w.flags&g)>>y){default:case D:u=0,d=1,f=t,c=0,p=1,m=e;break;case x:u=0,d=1,f=t,c=e-1,p=-1,m=-1;break;case T:u=t-1,d=-1,f=-1,c=0,p=1,m=e;break;case b:u=t-1,d=-1,f=-1,c=e-1,p=-1,m=-1}if(L)switch(w.pixel_size){case 8:l(_,c,p,m,u,d,f,r);break;case 16:h(_,c,p,m,u,d,f,r);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}else switch(w.pixel_size){case 8:a(_,c,p,m,u,d,f,r,i);break;case 16:n(_,c,p,m,u,d,f,r);break;case 24:o(_,c,p,m,u,d,f,r);break;case 32:s(_,c,p,m,u,d,f,r);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}return _}var c=0,d=1,p=2,f=3,m=9,_=10,v=11,g=48,y=4,x=0,b=1,D=2,T=3;e.byteLength<19&&console.error("TGAParser.parse: Not enough data to contain header.");var P=new Uint8Array(e),S=0,w={id_length:P[S++],colormap_type:P[S++],image_type:P[S++],colormap_index:P[S++]|P[S++]<<8,colormap_length:P[S++]|P[S++]<<8,colormap_size:P[S++],origin:[P[S++]|P[S++]<<8,P[S++]|P[S++]<<8],width:P[S++]|P[S++]<<8,height:P[S++]|P[S++]<<8,pixel_size:P[S++],flags:P[S++]};r(w),w.id_length+S>e.byteLength&&console.error("TGAParser.parse: No data"),S+=w.id_length;var A=!1,C=!1,L=!1;switch(w.image_type){case m:A=!0,C=!0;break;case d:C=!0;break;case _:A=!0;break;case p:break;case v:A=!0,L=!0;break;case f:L=!0}var E=i(A,C,w,S,P),M=u(w.width,w.height,E.pixel_data,E.palettes),z=new t.Texture;return z.width=w.width,z.height=w.height,z.internalFormat=t.InternalFormat.PixelArray,z.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,z.mimapData=[new t.MipmapData(M,w.width,w.height)],z},e}();t.TGAParser=e,__reflect(e.prototype,"egret3d.TGAParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.parse=function(t){var e=null;if(!window.DOMParser&&window.ActiveXObject)for(var r=["MSXML.2.DOMDocument.6.0","MSXML.2.DOMDocument.3.0","Microsoft.XMLDOM"],i=0;i<r.length;i++)try{e=new ActiveXObject(r[i]),e.async=!1,e.loadXML(t);break}catch(a){}else{if(!(window.DOMParser&&document.implementation&&document.implementation.createDocument))return null;try{var n=new DOMParser;e=n.parseFromString(t,"text/xml")}catch(a){}}return e},t.eachXmlAttr=function(t,e){if(null!=t&&null!=e)for(var r,i=0,a=t.attributes.length;a>i;i++)r=t.attributes[i],e(r.name,r.value)},t}();t.XMLParser=e,__reflect(e.prototype,"egret3d.XMLParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t){void 0===t&&(t=null);var r=e.call(this,t)||this;return r.container=r.createObject(),r}return __extends(r,e),r.prototype.createObject=function(){return this.scene=new t.Scene3D,this.scene},r.prototype.onLoaderComplete=function(){e.prototype.onLoaderComplete.call(this)},r}(t.UnitLoader);t.MapLoader=e,__reflect(e.prototype,"egret3d.MapLoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.prototype.parse=function(t,e){this._particleData=e,this.engineVersion=t.engineVersion+"",this.version=t.version+"";var r=t.property;this.parseProperty(r);var i=t.emission;this.parseEmission(i);var a=t.life;this.parseLife(a);var n=t.shape;this.parseShape(n);var o=t.rotationBirth;this.parseRotationBirth(o);var s=t.scaleBirth;this.parseScaleBirth(s);var l=t.geometry;this.parseGeometry(l);var h=t.moveSpeed;this.parseMoveSpeed(h);var u=t.followTarget;this.parseFollowTarget(u);var c=t.scaleSize,d=t.scaleBezier;c?this.parseScaleSize(c):this.parseScaleBeizer(d);var p=t.rotationSpeed;this.parseRotationSpeed(p);var f=t.colorOffset;this.parseColorOffset(f);var m=(t.mat,t.textureSheet);this.parseTextureSheet(m)},e.prototype.parseProperty=function(e){var r=this._particleData.property;r.particleCount=Number(e.particleCount),r.prewarm=e.prewarm,void 0!=e.playOnAwake&&(r.playOnAwake=e.playOnAwake),r.bounds=this.parseVector3D(e.bounds,r.bounds),r.colorType=t.ParticleBirthColorType[e.colorType+""];var i=e.colorConst1,a=e.colorConst2,n=e.colorGradients1,o=e.colorGradients2;this.parseColorProperty(r,i,a,n,o),r.gravity=Number(e.gravity);var s=e.transform,l=s.rotation,h=s.scale,u=s.position;r.rotation=this.parseVector3D(l,r.rotation),r.scale=this.parseVector3D(h,r.scale),r.position=this.parseVector3D(u,r.position);var c=e.render;r.renderMode=t.ParticleRenderModeType[c.renderMode+""],r.lengthScale=Number(c.lengthScale),r.cameraScale=Number(c.cameraScale),r.speedScale=Number(c.speedScale),r.meshFile=c.meshFile,""==r.meshFile&&(r.meshFile=null),r.sortingFudge=Number(e.sortingFudge)},e.prototype.parseColorProperty=function(e,r,i,a,n){r&&(e.colorConst1=t.Color.createColor(Number(r))),i&&(e.colorConst2=t.Color.createColor(Number(i))),a&&(e.colorGradients1=this.parseGradientsColor(a.item,e.colorGradients1)),n&&(e.colorGradients2=this.parseGradientsColor(n.item,e.colorGradients2))},e.prototype.parseEmission=function(e){var r=this._particleData.emission;r.type=t.ParticleValueType[e.type+""],r.rate=Number(e.rate);var i,a,n=e.bursts,o=0,s=0;if(n)for(r.bursts=[],o=0,s=n?n.length:0;s>o;o++)a=n[o],i=new t.Point,i.x=Number(a[0]),i.y=Number(a[1]),r.bursts.push(i);r.type==t.ParticleValueType.OneBezier&&(r.bezier=this.parseFoldLine(e.line)||this.parseBezierData(e.bezier))},e.prototype.parseLife=function(e){var r=this._particleData.life;r.type=t.ParticleValueType[e.type+""],r.min=Number(e.min),r.max=Number(e.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2),r.duration=Number(e.duration),r.delay=Number(e.delay),r.loop=e.loop},e.prototype.parseShape=function(e){if(null!=e){var r=this._particleData.shape;r.type=t.ParticleDataShapeType[e.type+""],r.randomDirection=e.randomDirection,r.emitFromShell=e.emitFromShell;var i=e.cube;if(i&&(r.cubeW=Number(i[0]),r.cubeH=Number(i[1]),r.cubeD=Number(i[2])),r.sphereRadius=Number(e.sphereRadius),r.hemiSphereRadius=Number(e.hemiSphereRadius),r.type==t.ParticleDataShapeType.Cone){var a=e.cone;r.coneType=t.ParticleConeShapeType[a.type+""],r.coneLength=Number(a.length),r.coneRadius=Number(a.radius),r.coneAngle=Number(a.angle)}r.meshType=t.ParticleMeshShapeType[e.meshType+""],r.meshFile=e.meshFile,""==r.meshFile&&(r.meshFile=null)}},e.prototype.parseRotationBirth=function(e){var r=this._particleData.rotationBirth;r.type=t.ParticleValueType[e.type+""],r.min=Number(e.min),r.max=Number(e.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)},e.prototype.parseScaleBirth=function(e){var r=this._particleData.scaleBirth;r.type=t.ParticleValueType[e.type+""],r.min=Number(e.min),r.max=Number(e.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)},e.prototype.parseGeometry=function(t){var e=this._particleData.geometry,r=t.plane;e.planeW=Number(r[0]),e.planeH=Number(r[1])},e.prototype.parseMoveSpeed=function(e){var r=this._particleData.moveSpeed;r.type=t.ParticleValueType[e.type+""],r.min=Number(e.min),r.max=Number(e.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2);var i=e.velocityOver;if(i){var a=new t.VelocityOverLifeTimeData;a.type=t.ParticleValueType[i.type+""],a.min=this.parseVector3D(i.min,a.min),a.max=this.parseVector3D(i.max,a.max),a.worldSpace=i.worldSpace,a.xBezier1=this.parseFoldLine(e.xLine1)||this.parseBezierData(i.xBezier1),a.yBezier1=this.parseFoldLine(e.yLine1)||this.parseBezierData(i.yBezier1),a.zBezier1=this.parseFoldLine(e.zLine1)||this.parseBezierData(i.zBezier1),a.xBezier2=this.parseFoldLine(e.xLine2)||this.parseBezierData(i.xBezier2),a.yBezier2=this.parseFoldLine(e.yLine2)||this.parseBezierData(i.yBezier2),a.zBezier2=this.parseFoldLine(e.zLine2)||this.parseBezierData(i.zBezier2),r.velocityOver=a}var n=e.velocityForce;if(n){var o=new t.VelocityForceLifeTimeData;o.type=t.ParticleValueType[n.type+""],o.min=this.parseVector3D(n.min,o.min),o.max=this.parseVector3D(n.max,o.max),o.worldSpace=n.worldSpace,o.xBezier1=this.parseFoldLine(e.xLine1)||this.parseBezierData(n.xBezier1),o.yBezier1=this.parseFoldLine(e.yLine1)||this.parseBezierData(n.yBezier1),o.zBezier1=this.parseFoldLine(e.zLine1)||this.parseBezierData(n.zBezier1),o.xBezier2=this.parseFoldLine(e.xLine2)||this.parseBezierData(n.xBezier2),o.yBezier2=this.parseFoldLine(e.yLine2)||this.parseBezierData(n.yBezier2),o.zBezier2=this.parseFoldLine(e.zLine2)||this.parseBezierData(n.zBezier2),r.velocityForce=o}var s=e.velocityLimit;if(s){var l=new t.VelocityLimitLifeTimeData;l.type=t.ParticleValueType[s.type+""],l.min=Number(s.min),l.max=Number(s.max),l.dampen=Number(s.dampen),l.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(s.bezier1),l.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(s.bezier2),r.velocityLimit=l}},e.prototype.parseFollowTarget=function(e){if(null!=e){var r=this._particleData.followTarget=new t.ParticleDataFollowTarget;r.followRotation=e.followRotation,r.followScale=e.followScale}},e.prototype.parseScaleBeizer=function(e){if(null!=e){var r=this._particleData.scaleSize=new t.ParticleDataScaleSize;r.type=t.ParticleValueType.OneBezier,r.bezier1=this.parseFoldLine(e.line)||this.parseBezierData(e.bezier)}},e.prototype.parseScaleSize=function(e){if(null!=e){var r=this._particleData.scaleSize=new t.ParticleDataScaleSize;r.type=t.ParticleValueType[e.type+""],r.min=Number(e.min),r.max=Number(e.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)}},e.prototype.parseRotationSpeed=function(e){if(null!=e){var r=this._particleData.rotationSpeed=new t.ParticleDataRotationSpeed;r.type=t.ParticleValueType[e.type+""],r.min=this.parseVector3D(e.min,r.min),r.max=this.parseVector3D(e.max,r.max),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2)}},e.prototype.parseColorOffset=function(e){if(null!=e){var r=this._particleData.colorOffset=new t.ParticleDataColorOffset;r.data=this.parseGradientsColor(e.item,r.data)}},e.prototype.parseTextureSheet=function(e){if(null==e)return null;var r=this._particleData.textureSheet=new t.ParticleDataTextureSheet;return r.frameType=t.ParticleValueType[e.frameType+""],r.tileX=Number(e.tileX),r.tileY=Number(e.tileY),r.whole=e.whole,r.row=Number(e.row),r.min=Number(e.min),r.max=Number(e.max),r.circles=Number(e.circles),r.bezier1=this.parseFoldLine(e.line1)||this.parseBezierData(e.bezier1),r.bezier2=this.parseFoldLine(e.line2)||this.parseBezierData(e.bezier2),r},e.prototype.parseGradientsColor=function(e,r){r||(r=new t.ColorGradients);var i,a,n=0,o=0;for(n=0,o=e?e.length:0;o>n;n++)i=e[n],r.times.push(Number(i[0])),a=t.Color.createColor(Number(i[1])),r.colors.push(a);var s=r.times.slice(),l=r.colors.slice();for(s.sort(function(t,e){return t-e}),n=0,o=r?r.times.length:0;o>n;n++){var h=s.indexOf(r.times[n]);r.colors[n]=l[h]}return r.times=s,r},e.prototype.parseBezierData=function(e){var r=new t.BezierData;if(r.lineMode=!1,null==e)return r;var i,a,n=0,o=0;for(n=0,o=e?e.length:0;o>n;n++)i=e[n],a=new t.Point,a.x=Number(i[1]),a.y=Number(i[2]),"pos"==i[0]?r.posPoints.push(a):r.ctrlPoints.push(a);return r},e.prototype.parseFoldLine=function(e){if(null==e)return null;var r=new t.BezierData;r.lineMode=!0;var i,a,n=0,o=0;for(n=0,o=e?e.length:0;o>n;n++)i=e[n],a=new t.Point,a.x=Number(i[0]),a.y=Number(i[1]),r.linePoints.push(a);return r},e.prototype.parseVector3D=function(e,r){return null==r&&(r=new t.Vector3D),e&&(r.x=Number(e[0]),r.y=Number(e[1]),r.z=Number(e[2])),r},e}();t.ParticleJsonParser=e,__reflect(e.prototype,"egret3d.ParticleJsonParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){void 0===a&&(a=t.IConfigParser.TYPE_PARTICLE);var n=e.call(this,a)||this;switch(i){case"xml":n.data=n.parseXml(r);break;case"json":n.data=n.parseJson(r)}return n.data.shape.meshFile&&(n.taskDict[n.data.shape.meshFile]=0),n.data.property.meshFile&&(n.taskDict[n.data.property.meshFile]=0),n}return __extends(r,e),r.prototype.parseJson=function(e){this.data=new t.ParticleData;var r=new t.ParticleJsonParser;return r.parse(e,this.data),this.version=Number(r.version),this.engineVersion=String(r.engineVersion),this.data.validate(),this.data},r.prototype.parseXml=function(e){this.data=new t.ParticleData;var r=new t.ParticleXmlParser;return r.parse(e,this.data),this.version=Number(r.version),this.data.validate(),this.data},r}(t.IConfigParser);t.ParticleParser=e,__reflect(e.prototype,"egret3d.ParticleParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.prototype.parse=function(t,e){this._particleData=e,this.version=this.getNode(t,"version").textContent;var r=this.getNode(t,"property");this.parseProperty(r);var i=this.getNode(t,"emission");this.parseEmission(i);var a=this.getNode(t,"life");this.parseLife(a);var n=this.getNode(t,"shape");this.parseShape(n);var o=this.getNode(t,"rotationBirth");this.parseRotationBirth(o);var s=this.getNode(t,"scaleBirth");this.parseScaleBirth(s);var l=this.getNode(t,"geometry");this.parseGeometry(l);var h=this.getNode(t,"moveSpeed");this.parseMoveSpeed(h);var u=this.getNode(t,"followTarget");this.parseFollowTarget(u);var c=this.getNode(t,"scaleBezier");this.parseScaleBeizer(c);var d=this.getNode(t,"rotationSpeed");this.parseRotationSpeed(d);var p=this.getNode(t,"colorOffset");this.parseColorOffset(p);var f=(this.getNode(t,"mat"),this.getNode(t,"textureSheet"));this.parseTextureSheet(f)},e.prototype.parseProperty=function(e){var r=this._particleData.property;r.particleCount=Number(this.getNode(e,"particleCount").textContent),r.prewarm="true"==this.getNode(e,"prewarm").textContent,r.playOnAwake="true"==this.getNode(e,"playOnAwake").textContent;var i=this.getNode(e,"bounds");r.bounds=this.parseVector3D(i,r.bounds),r.colorType=t.ParticleBirthColorType[this.getNode(e,"colorType").textContent];var a=this.getNode(e,"colorConst1"),n=this.getNode(e,"colorConst2"),o=this.getNode(e,"colorGradients1"),s=this.getNode(e,"colorGradients2");this.parseColorProperty(r,a,n,o,s),r.gravity=Number(this.getNode(e,"gravity").textContent);var l=this.getNode(e,"transform"),h=this.getNode(l,"rotation"),u=this.getNode(l,"scale"),c=this.getNode(l,"position");r.rotation=this.parseVector3D(h,r.rotation),r.scale=this.parseVector3D(u,r.scale),r.position=this.parseVector3D(c,r.position);var d=this.getNode(e,"render"),p=this.getNode(d,"renderMode");p&&(r.renderMode=t.ParticleRenderModeType[p.textContent]);var f=this.getNode(d,"lengthScale");f&&(r.lengthScale=Number(f.textContent));var m=this.getNode(d,"cameraScale");m&&(r.cameraScale=Number(m.textContent));var _=this.getNode(d,"speedScale");_&&(r.speedScale=Number(_.textContent));var v=this.getNode(d,"meshFile");v&&""!=v.textContent&&(r.meshFile=v.textContent);var g=this.getNode(e,"sortingFudge");g&&(r.sortingFudge=Number(g.textContent))},e.prototype.parseColorProperty=function(e,r,i,a,n){if(r&&(e.colorConst1=t.Color.createColor(Number(r.textContent))),i&&(e.colorConst2=t.Color.createColor(Number(i.textContent))),a){var o=this.getNodeList(a,"item");e.colorGradients1=this.parseGradientsColor(o,e.colorGradients1)}if(n){var o=this.getNodeList(n,"item");e.colorGradients2=this.parseGradientsColor(o,e.colorGradients2)}},e.prototype.parseEmission=function(e){var r=this._particleData.emission;r.type=t.ParticleValueType[this.getNode(e,"type").textContent],r.rate=Number(this.getNode(e,"rate").textContent);var i,a,n=this.getNode(e,"bursts"),o=0,s=0;if(n){r.bursts=[];var l=this.getNodeList(n,"item");for(o=0,s=l?l.length:0;s>o;o++)i=l[o],a=new t.Point,r.bursts.push(a),this.eachAttr(i,function(t,e){"time"==t?a.x=Number(e):"count"==t&&(a.y=Number(e))})}var h=this.getNode(e,"bezier");r.type==t.ParticleValueType.OneBezier&&(r.bezier=this.parseBezierData(h))},e.prototype.parseLife=function(e){var r=this._particleData.life;r.type=t.ParticleValueType[this.getNode(e,"type").textContent],r.min=Number(this.getNode(e,"min").textContent),r.max=Number(this.getNode(e,"max").textContent),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2")),r.duration=Number(this.getNode(e,"duration").textContent),r.delay=Number(this.getNode(e,"delay").textContent),r.loop="true"==this.getNode(e,"loop").textContent},e.prototype.parseShape=function(e){if(null!=e){var r=this._particleData.shape;r.type=t.ParticleDataShapeType[this.getNode(e,"type").textContent],r.randomDirection="true"==this.getNode(e,"randomDirection").textContent;var i=this.getNode(e,"emitFromShell");r.emitFromShell=i&&"true"==i.textContent;var a=this.getNode(e,"cube");this.eachAttr(a,function(t,e){"width"==t?r.cubeW=Number(e):"height"==t?r.cubeH=Number(e):"depth"==t&&(r.cubeD=Number(e))});var n=this.getNode(e,"sphereRadius");n&&(r.sphereRadius=Number(n.textContent));var o=this.getNode(e,"hemiSphereRadius");o&&(r.hemiSphereRadius=Number(o.textContent));var s=this.getNode(e,"cone");this.eachAttr(s,function(e,i){"type"==e?r.coneType=t.ParticleConeShapeType[i]:"length"==e?r.coneLength=Number(i):"radius"==e?r.coneRadius=Number(i):"angle"==e&&(r.coneAngle=Number(i))});var l=this.getNode(e,"meshType");l&&(r.meshType=t.ParticleMeshShapeType[l.textContent]);var h=this.getNode(e,"meshFile");h&&""!=h.textContent&&(r.meshFile=h.textContent)}},e.prototype.parseRotationBirth=function(e){var r=this._particleData.rotationBirth;r.type=t.ParticleValueType[this.getNode(e,"type").textContent],r.min=Number(this.getNode(e,"min").textContent),r.max=Number(this.getNode(e,"max").textContent),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))},e.prototype.parseScaleBirth=function(e){var r=this._particleData.scaleBirth;r.type=t.ParticleValueType[this.getNode(e,"type").textContent],r.min=Number(this.getNode(e,"min").textContent),r.max=Number(this.getNode(e,"max").textContent),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))},e.prototype.parseGeometry=function(t){var e=this._particleData.geometry,r=this.getNode(t,"plane");this.eachAttr(r,function(t,r){"width"==t?e.planeW=Number(r):"height"==t&&(e.planeH=Number(r))})},e.prototype.parseMoveSpeed=function(e){var r=this._particleData.moveSpeed;r.type=t.ParticleValueType[this.getNode(e,"type").textContent],r.min=Number(this.getNode(e,"min").textContent),r.max=Number(this.getNode(e,"max").textContent),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2"));var i=this.getNode(e,"velocityOver");if(i){var a=new t.VelocityOverLifeTimeData;a.type=t.ParticleValueType[this.getNode(i,"type").textContent];var n=this.getNode(i,"min"),o=this.getNode(i,"max");a.min=this.parseVector3D(n,a.min),a.max=this.parseVector3D(o,a.max),a.worldSpace="true"==this.getNode(i,"worldSpace").textContent,a.xBezier1=this.parseBezierData(this.getNode(i,"xBezier1")),a.yBezier1=this.parseBezierData(this.getNode(i,"yBezier1")),a.zBezier1=this.parseBezierData(this.getNode(i,"zBezier1")),a.xBezier2=this.parseBezierData(this.getNode(i,"xBezier2")),a.yBezier2=this.parseBezierData(this.getNode(i,"yBezier2")),a.zBezier2=this.parseBezierData(this.getNode(i,"zBezier2")),r.velocityOver=a}var s=this.getNode(e,"velocityForce");if(s){var l=new t.VelocityForceLifeTimeData;l.type=t.ParticleValueType[this.getNode(s,"type").textContent];var n=this.getNode(s,"min"),o=this.getNode(s,"max");l.min=this.parseVector3D(n,l.min),l.max=this.parseVector3D(o,l.max),l.worldSpace="true"==this.getNode(s,"worldSpace").textContent,l.xBezier1=this.parseBezierData(this.getNode(s,"xBezier1")),l.yBezier1=this.parseBezierData(this.getNode(s,"yBezier1")),l.zBezier1=this.parseBezierData(this.getNode(s,"zBezier1")),l.xBezier2=this.parseBezierData(this.getNode(s,"xBezier2")),l.yBezier2=this.parseBezierData(this.getNode(s,"yBezier2")),l.zBezier2=this.parseBezierData(this.getNode(s,"zBezier2")),r.velocityForce=l}var h=this.getNode(e,"velocityLimit");if(h){var u=new t.VelocityLimitLifeTimeData;u.type=t.ParticleValueType[this.getNode(h,"type").textContent];var n=this.getNode(h,"min"),o=this.getNode(h,"max"),c=this.getNode(h,"dampen");u.min=Number(n.textContent),u.max=Number(o.textContent),u.dampen=c?Number(c.textContent):0,u.bezier1=this.parseBezierData(this.getNode(h,"bezier1")),u.bezier2=this.parseBezierData(this.getNode(h,"bezier2")),r.velocityLimit=u}},e.prototype.parseFollowTarget=function(e){if(null!=e){var r=this._particleData.followTarget=new t.ParticleDataFollowTarget;r.followRotation="true"==this.getNode(e,"followRotation").textContent,r.followScale="true"==this.getNode(e,"followScale").textContent}},e.prototype.parseScaleBeizer=function(e){if(null!=e){var r=this._particleData.scaleSize=new t.ParticleDataScaleSize;r.bezier1=this.parseBezierData(this.getNode(e,"bezier"))}},e.prototype.parseRotationSpeed=function(e){if(null!=e){var r=this._particleData.rotationSpeed=new t.ParticleDataRotationSpeed;r.type=t.ParticleValueType[this.getNode(e,"type").textContent];var i=this.getNode(e,"min"),a=this.getNode(e,"max");r.min=this.parseVector3D(i,r.min),r.max=this.parseVector3D(a,r.max),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))}},e.prototype.parseColorOffset=function(e){if(null!=e){var r=this._particleData.colorOffset=new t.ParticleDataColorOffset,i=this.getNodeList(e,"item");r.data=this.parseGradientsColor(i,r.data)}},e.prototype.parseTextureSheet=function(e){if(null==e)return null;var r=this._particleData.textureSheet=new t.ParticleDataTextureSheet;return r.frameType=t.ParticleValueType[this.getNode(e,"frameType").textContent],r.tileX=Number(this.getNode(e,"tileX").textContent),r.tileY=Number(this.getNode(e,"tileY").textContent),r.whole="true"==this.getNode(e,"whole").textContent,r.row=Number(this.getNode(e,"row").textContent),r.min=Number(this.getNode(e,"min").textContent),r.max=Number(this.getNode(e,"max").textContent),r.circles=Number(this.getNode(e,"circles").textContent),r.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),r.bezier2=this.parseBezierData(this.getNode(e,"bezier2")),r},e.prototype.parseGradientsColor=function(e,r){r||(r=new t.ColorGradients);var i,a,n=0,o=0;for(n=0,o=e?e.length:0;o>n;n++)i=e[n],this.eachAttr(i,function(e,i){"time"==e?r.times.push(Number(i)):"color"==e&&(a=t.Color.createColor(Number(i)),r.colors.push(a))});var s=r.times.slice(),l=r.colors.slice();for(s.sort(function(t,e){return t-e}),n=0,o=r?r.times.length:0;o>n;n++){var h=s.indexOf(r.times[n]);r.colors[n]=l[h]}return r.times=s,r},e.prototype.parseBezierData=function(e){var r=new t.BezierData;if(null==e)return r;var i,a,n=this.getNodeList(e,"pos"),o=this.getNodeList(e,"ctrl"),s=0,l=0;for(s=0,l=n?n.length:0;l>s;s++)i=n[s],a=new t.Point,r.posPoints.push(a),this.eachAttr(i,function(t,e){"x"==t?a.x=Number(e):"y"==t&&(a.y=Number(e))});for(s=0,l=o?o.length:0;l>s;s++)i=o[s],a=new t.Point,r.ctrlPoints.push(a),this.eachAttr(i,function(t,e){"x"==t?a.x=Number(e):"y"==t&&(a.y=Number(e))});return r},e.prototype.parseVector3D=function(e,r){return null==r&&(r=new t.Vector3D),this.eachAttr(e,function(t,e){"x"==t?r.x=Number(e):"y"==t?r.y=Number(e):"z"==t&&(r.z=Number(e))}),r},e.prototype.getNode=function(t,e){if(null==t)return null;var r=t.getElementsByTagName(e);return null==r||0==r.length?null:r[0]},e.prototype.getNodeList=function(t,e){if(null==t)return null;var r=t.getElementsByTagName(e);return null==r||0==r.length?null:r},e.prototype.eachAttr=function(e,r){t.XMLParser.eachXmlAttr(e,r)},e}();t.ParticleXmlParser=e,__reflect(e.prototype,"egret3d.ParticleXmlParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.avatar={},t}return __extends(r,e),r.prototype.setAvatar=function(t,r){var i=this.avatar[t];i&&i.parent.removeChild(i),this.avatar[t]=r,e.prototype.addChild.call(this,r)},r.prototype.delAvatar=function(t){this.avatar[t]&&delete this.avatar[t]},r.prototype.play=function(t,e,r){this.skeletonAnimation.play(t,e,r)},r.prototype.addChild=function(r){return r instanceof t.Mesh?this.setAvatar(r.name,r):e.prototype.addChild.call(this,r),r},r.prototype.addChildAt=function(r,i){return r instanceof t.Mesh?this.setAvatar(r.name,r):e.prototype.addChildAt.call(this,r,i),r},r.prototype.removeChild=function(t){return this.delAvatar(t.name),e.prototype.removeChild.call(this,t)},r.prototype.removeChildAt=function(t){var r=this.getChild(t);return r&&this.delAvatar(r.name),e.prototype.removeChildAt.call(this,t)},r.prototype.update=function(t,e){},r.prototype.copy=function(t){e.prototype.copy.call(this,t)},r.prototype.clone=function(){var e=new r,i=this.skeletonAnimation.clone();e.skeletonAnimation=i;for(var a=0;a<this.childs.length;a++)if(this.childs[a]instanceof t.Mesh){var n=this.childs[a].clone();n.animation=i,e.setAvatar(n.name,n)}return e},r}(t.Object3D);t.Role=e,__reflect(e.prototype,"egret3d.Role")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(t){void 0===t&&(t=null);var r=e.call(this,t)||this;return r.container=r.createObject(),r}return __extends(r,e),r.prototype.createObject=function(){return this.role=new t.Role,this.role},r}(t.UnitLoader);t.RoleLoader=e,__reflect(e.prototype,"egret3d.RoleLoader")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,r,i){var a=t.call(this,i)||this;switch(a.data=e,r){case"json":a.data.meta&&a.data.meta.image&&(a.taskDict[a.data.meta.image]=0)}return a}return __extends(e,t),e}(t.IConfigParser);t.TexturePackerParser=e,__reflect(e.prototype,"egret3d.TexturePackerParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.volume=1,this.codecs=null,this.hasAudioContext()&&"undefined"!=typeof AudioContext&&(this.context=new AudioContext)}return e.prototype.hasAudio=function(){return"undefined"!=typeof Audio},e.prototype.hasAudioContext=function(){return!("undefined"==typeof AudioContext)},e.prototype.isSupported=function(t,e){null==this.codecs&&(null==e&&(e=new Audio),this.codecs={mp3:!!e.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")});var r=t.match(/^data:audio\/([^;,]+);/i);return r||(r=t.split("?",1)[0].match(/\.([^.]+)$/)),r&&(r=r[1].toLowerCase()),this.codecs[r]},e.prototype.createSound=function(e,r,i){return void 0===r&&(r=null),void 0===i&&(i=null),new t.Sound(e,r,i)},e.prototype.playSound=function(e,r){r=r||{};var i=new t.Channel(e,r);return i.play(),i},e.prototype.playSound3d=function(e,r,i){i=i||{};var a=new t.Channel3d(e,i);return a.position=r,i.volume&&(a.volume=i.volume),i.loop&&(a.loop=i.loop),i.maxDistance&&(a.maxDistance=i.maxDistance),i.minDistance&&(a.minDistance=i.minDistance),i.rollOffFactor&&(a.rollOffFactor=i.rollOffFactor),a.play(),a},Object.defineProperty(e,"instance",{get:function(){return null==this._instance&&(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e}();t.AudioManager=e,__reflect(e.prototype,"egret3d.AudioManager")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.doMethod=function(e,r,i){var a=t.CheckerboardTexture.texture,n=null;switch(r.type){case t.UnitMatMethodData.methodType.lightmapMethod:var o=new t.LightmapMethod(r.usePower);n=o,e.diffusePass.addMethod(o),o.lightTexture=a;var s=r.texturesData[0];i.addMethodImgTask(s.path,o,s.attributeName);break;case t.UnitMatMethodData.methodType.uvRollMethod:var l=new t.UVRollMethod;
n=l,e.diffusePass.addMethod(l),l.speedU=r.uSpeed,l.speedV=r.vSpeed,e.repeat=!0;break;case t.UnitMatMethodData.methodType.uvSpriteSheetMethod:var h=new t.UVSpriteSheetMethod(r.frameNum,r.row,r.col,r.totalTime);n=h,e.diffusePass.addMethod(h),h.isLoop=r.loop,h.delayTime=r.delayTime;break;case t.UnitMatMethodData.methodType.mulUvRollMethod:var u=new t.MulUVRollMethod;n=u,e.diffusePass.addMethod(u),u.diffuseTexture1=a,u.setSpeedU(0,r.uSpeed),u.setSpeedV(0,r.vSpeed);var s=r.texturesData[0];u.setSpeedU(1,s.uSpeed),u.setSpeedV(1,s.vSpeed),i.addMethodImgTask(s.path,u,s.attributeName),e.repeat=!0;break;case t.UnitMatMethodData.methodType.alphaMaskMethod:var c=new t.AlphaMaskMethod;n=c,e.diffusePass.addMethod(c),c.maskTexture=a;var s=r.texturesData[0];i.addMethodImgTask(s.path,c,s.attributeName);break;case t.UnitMatMethodData.methodType.streamerMethod:var d=new t.StreamerMethod;n=d,e.diffusePass.addMethod(d),d.steamerTexture=a;var s=r.texturesData[0];i.addMethodImgTask(s.path,d,s.attributeName),d.speedU=r.uSpeed,d.speedV=r.vSpeed;break;case t.UnitMatMethodData.methodType.terrainARGBMethod:var p=new t.TerrainARGBMethod(a,a,a,a,a);n=p,e.diffusePass.addMethod(p);for(var s=null,f=0;f<r.texturesData.length;++f)s=r.texturesData[f],i.addMethodImgTask(s.path,p,s.attributeName),0!=f&&p.setUVTitling(f-1,Number(s.uvTitlingX),Number(s.uvTitlingY));break;case t.UnitMatMethodData.methodType.waterWaveMethod:var m=new t.WaterWaveMethod;n=m,e.diffusePass.addMethod(m),r.deepWaterColor&&(m.deepWaterColor=Number(r.deepWaterColor)),r.shallowWaterColor&&(m.shallowWaterColor=Number(r.shallowWaterColor)),e.repeat=!0;break;case t.UnitMatMethodData.methodType.waterNormalMethod:var _=new t.WaterNormalMethod;n=_,e.diffusePass.addMethod(_),_.normalTextureA=a,_.normalTextureB=a,r.uScale&&r.vScale&&_.setUvScale(Number(r.uScale),Number(r.vScale));for(var s=null,f=0;f<r.texturesData.length;++f)s=r.texturesData[f],_.setUvSpeed(f,Number(s.uSpeed),Number(s.vSpeed)),i.addMethodImgTask(s.path,_,s.attributeName)}r.play&&n.start&&i.addAutoAnimation(n)},e}();t.MethodUtils=e,__reflect(e.prototype,"egret3d.MethodUtils")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){var n=e.call(this,a)||this;return n.nodeList=new Array,n.hudList=new Array,n.auto=!1,n.loop=!1,n.matDict={},n.lightDict={},n.skeletonAnimationDict={},n.proAnimationDict={},n.directLight=!1,n.pointLight=!1,n.textures=[],t.UnitParserUtils.mapParser(i,r,n),n}return __extends(r,e),r.prototype.calculateTask=function(){this.uv2&&(this.taskDict[this.uv2]=0)},r.prototype.calculateProAnimationTask=function(t){for(var e=0;e<t.clips;++e){var r=t.clips[e];r.path&&(this.taskDict[t.path]=0)}},r.prototype.calculateSkeletonAnimationTask=function(t){for(var e=0;e<t.clips;++e){var r=t.clips[e];r.path&&(this.taskDict[t.path]=0)}},r.prototype.calculateMatTask=function(t){""!=t.diffuseTextureName&&(this.taskDict[t.diffuseTextureName]=0),""!=t.normalTextureName&&(this.taskDict[t.normalTextureName]=0),""!=t.specularTextureName&&(this.taskDict[t.specularTextureName]=0);for(var e=0;e<t.methods.length;++e)for(var r=t.methods[e],i=0;i<r.texturesData.length;++i){var a=r.texturesData[i];a.path&&(this.taskDict[a.path]=0)}},r.prototype.calculateNodeTask=function(t){t.path&&(this.taskDict[t.path]=0);for(var e=0;e<t.skinClips.length;e++){var r=t.skinClips[e];r.path&&(this.taskDict[r.path]=0)}for(var e=0;e<t.propertyAnims.length;++e){var i=t.propertyAnims[e];i.path&&(this.taskDict[i.path]=0)}for(var e=0;e<t.grass.length;++e){var a=t.grass[e];a.detailTexture&&(this.taskDict[a.detailTexture]=0),a.grassTexture&&(this.taskDict[a.detailTexture]=0)}},r.prototype.calculateHudTask=function(t){t.texture&&(this.taskDict[t.texture]=0)},r.prototype.calculateTextureTask=function(t){t.path&&(this.taskDict[t.path]=0)},r}(t.IConfigParser);t.UnitConfigParser=e,__reflect(e.prototype,"egret3d.UnitConfigParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.bothside=!1}return t}();t.UnitHUDData=e,__reflect(e.prototype,"egret3d.UnitHUDData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.id=0,this.type=0,this.diffuseColor=16777215,this.ambientColor=16777215,this.intensity=1,this.halfIntensity=0,this.direction=new t.Vector3D(-.5,-.6,.2),this.position=new t.Vector3D,this.falloff=0,this.radius=100}return e}();t.UnitLightData=e,__reflect(e.prototype,"egret3d.UnitLightData")}(egret3d||(egret3d={}));var egret3d;!function(t){t.registGUITexture=function(t){t.upload(e.context3DProxy);for(var r=0,i=e._instance.view3Ds;r<i.length;r++){var a=i[r];a.getGUIStage().registerTexture(t)}};var e=function(e){function r(i){var a=e.call(this)||this;if(a.canvas3DRectangle=new t.Rectangle,a._view3DS=new Array,a.sizeDiry=!0,a._time=0,a._delay=0,a._renderer=0,a.offsetX=0,a.offsetY=0,a._start=!1,a.blend2D=!1,r._instance)throw new Error("不能重复实例化这个类!");return r._instance=a,t.ShaderUtil.instance.load(),a._envetManager=new t.EventManager(a),a.stage2D=i,a.blend2D=!!i,a.blend2D?a.canvas=i.$screen.canvas:(a.canvas=document.createElement("canvas"),a.canvas.style.position="absolute",a.canvas.style.zIndex="-1",document.getElementsByClassName("egret-player").length>0?document.getElementsByClassName("egret-player")[0].appendChild(a.canvas):document.body.appendChild(a.canvas),a.canvas.id="egret3D"),a.canvas.oncontextmenu=function(){return!1},r.context3DProxy=new t.Context3DProxy,t.Context3DProxy.gl=a.canvas.getContext("webgl"),t.Context3DProxy.gl||(t.Context3DProxy.gl=a.canvas.getContext("experimental-webgl")),t.Context3DProxy.gl||alert("you drivers not suport webgl"),a.create2dContext(),r.context3DProxy.register(),console.log("this.context3D ==>",t.Context3DProxy.gl),t.Input.canvas=a,a.blend2D&&(t.Input.instance.init(a.canvas),a.resizeBlend2D()),a.initEvent(),a}return __extends(r,e),r.prototype.getExtension=function(e){var r=t.Context3DProxy.gl.getExtension(e);return r||alert("you drivers not suport "+e),r},r.prototype.initEvent=function(){this._enterFrameEvent3D=new t.Event3D(t.Event3D.ENTER_FRAME),this._enterFrameEvent3D.target=this},r.prototype.create2dContext=function(){r._canvas2D=document.createElement("canvas"),r._canvas2D.hidden=!0,r._ctx2D=r._canvas2D.getContext("2d")},r.draw2DImage=function(t,e,r,i,a){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),void 0===a&&(a=1),document.body.appendChild(this._canvas2D),this._canvas2D.width=t.width,this._canvas2D.height=t.height,this._ctx2D.drawImage(t,e,e,i,a);var n=this._ctx2D.getImageData(0,0,i,a);return document.body.removeChild(this._canvas2D),n},Object.defineProperty(r.prototype,"x",{get:function(){return this.canvas3DRectangle.x},set:function(t){this.canvas3DRectangle.x==t||this.blend2D||this.resize(t,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this.canvas3DRectangle.y},set:function(t){this.canvas3DRectangle.y==t||this.blend2D||this.resize(this.canvas3DRectangle.x,t,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this.canvas3DRectangle.width},set:function(t){this.canvas3DRectangle.width==t||this.blend2D||this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,t,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this.canvas3DRectangle.height},set:function(t){this.canvas3DRectangle.height==t||this.blend2D||this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"view3Ds",{get:function(){return this._view3DS},enumerable:!0,configurable:!0}),r.prototype.addView3D=function(t){var e=this._view3DS.indexOf(t);-1==e&&this._view3DS.push(t)},r.prototype.removeView3D=function(t){var e=this._view3DS.indexOf(t);-1!=e&&this._view3DS.splice(e,1)},r.prototype.$render=function(){var e=t.Egret3DEngine.instance.performance.getNow();this._delay=e-this._time,this._time=e,t.Egret3DEngine.instance.debug&&t.Egret3DEngine.instance.performance.startCounter("renderer",60),this._enterFrameEvent3D.time=this._time,this._enterFrameEvent3D.delay=this._delay,this.dispatchEvent(this._enterFrameEvent3D),t.CameraManager.instance.update(this._time,this._delay);for(var r=0;r<this._view3DS.length;r++)t.Egret3DEngine.instance.debug&&(t.Egret3DEngine.instance.performance.startCounter("view3D-"+r.toString(),60),t.Egret3DEngine.instance.performance.prefix="view3D-"+r.toString()+"-"),this._view3DS[r].update(this._time,this._delay),t.Egret3DEngine.instance.debug&&(t.Egret3DEngine.instance.performance.prefix="",t.Egret3DEngine.instance.performance.endCounter("view3D-"+r.toString()));t.Egret3DEngine.instance.debug&&(t.Egret3DEngine.instance.performance.updateFps(),t.Egret3DEngine.instance.performance.endCounter("renderer"),t.Egret3DEngine.instance.inspector.show(this._delay,t.Egret3DEngine.instance.performance,this)),this.afterRender&&this.afterRender()},r.prototype.render=function(){if(this.blend2D){var e=r.context3DProxy;t.Context3DProxy.gl;e.reset(),e.enableDepth(),e.enableCullFace(),e.enableBlend(),t.Context3DProxy.gl.enable(t.Context3DProxy.gl.SCISSOR_TEST),this.$render(),e.disableDepth(),e.disableCullFace()}},r.prototype.resizeBlend2D=function(){if(this.blend2D){t.Input.scaleX=this.stage2D.$screen.webTouchHandler.scaleX,t.Input.scaleY=this.stage2D.$screen.webTouchHandler.scaleY,this.resize(0,0,this.canvas.width,this.canvas.height);var e=this.canvas.getBoundingClientRect();this.offsetX=-e.left,this.offsetY=-e.top}},r.prototype.start=function(){this.blend2D||(this._start=!0,this.update(0),r.context3DProxy.enableBlend(),r.context3DProxy.enableCullFace(),t.Context3DProxy.gl.enable(t.Context3DProxy.gl.SCISSOR_TEST))},r.prototype.stop=function(){this._start=!1},r.prototype.update=function(e){var r=this;this._start&&(this.$render(),t.Context3DProxy.gl.flush(),requestAnimationFrame(function(t){return r.update(t)}))},r.prototype.resize=function(e,r,i,a){this.canvas3DRectangle.x=e,this.canvas3DRectangle.y=r,this.canvas3DRectangle.width=i,this.canvas3DRectangle.height=a,t.ContextConfig.canvasRectangle=this.canvas3DRectangle,this.blend2D?(t.Input.scaleX=this.stage2D.$screen.webTouchHandler.scaleX,t.Input.scaleY=this.stage2D.$screen.webTouchHandler.scaleY):(this.canvas.style.left=this.canvas3DRectangle.x.toString()+"px",this.canvas.style.top=this.canvas3DRectangle.y.toString()+"px",this.canvas.width=this.canvas3DRectangle.width,this.canvas.height=this.canvas3DRectangle.height)},r.prototype.onStart=function(t){t.setAutoClear(!1)},r.prototype.onRender=function(t){t.save(),this.render(),t.restore()},r.prototype.onStop=function(){},r.prototype.onResize=function(){this.resizeBlend2D()},r}(t.EventDispatcher);t.Egret3DCanvas=e,__reflect(e.prototype,"egret3d.Egret3DCanvas"),t.Stage3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.type="",this.usePower=!1,this.texturesData=[],this.uSpeed=0,this.vSpeed=0,this.play=!0,this.loop=!0,this.frameNum=0,this.row=0,this.col=0,this.delayTime=0,this.totalTime=0}return t}();e.methodType={lightmapMethod:"lightmapMethod",uvRollMethod:"uvRollMethod",uvSpriteSheetMethod:"uvSpriteSheetMethod",mulUvRollMethod:"mulUvRollMethod",alphaMaskMethod:"alphaMaskMethod",streamerMethod:"streamerMethod",terrainARGBMethod:"terrainARGBMethod",waterWaveMethod:"waterWaveMethod",waterNormalMethod:"waterNormalMethod",particleUVRoll:"particleUVRoll"},t.UnitMatMethodData=e,__reflect(e.prototype,"egret3d.UnitMatMethodData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.id=0,this.diffuseTextureName="",this.normalTextureName="",this.specularTextureName="",this.matcapTextureName="",this.diffuseColor=0,this.ambientColor=0,this.specularColor=0,this.tintColor=2155905152,this.alpha=0,this.specularLevel=0,this.gloss=0,this.gamma=1,this.refraction=1.9,this.refractionintensity=2,this.ambientPower=0,this.diffusePower=0,this.normalPower=0,this.castShadow=!1,this.acceptShadow=!1,this.smooth=!1,this.repeat=!1,this.bothside=!1,this.drawMode=0,this.cullMode=0,this.blendMode=0,this.cutAlpha=.7,this.methods=[],this.lightIds=[],this.uvRectangle=new t.Rectangle(0,0,1,1)}return e}();t.UnitMatSphereData=e,__reflect(e.prototype,"egret3d.UnitMatSphereData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.type="",this.insID=0,this.parent=0,this.name="",this.staticType="",this.path="",this.fov=0,this.clipNear=0,this.clipFar=0,this.tagName="",this.materialIDs=[],this.skinClips=[],this.propertyAnims=[],this.billboard=!1,this.visible=!0,this.x=0,this.y=0,this.z=0,this.rx=0,this.ry=0,this.rz=0,this.rw=0,this.sx=1,this.sy=1,this.sz=1,this.skeletonAnimation=-1,this.propertyAnimsId=-1,this.geometry=[],this.grass=[],this.childs=[],this.boneBind={},this.lightIds=[],this.auto=!1,this.loop=!1,this.uv2Id=-1}return t}();t.UnitNodeData=e,__reflect(e.prototype,"egret3d.UnitNodeData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){var a=e.call(this,r,i)||this;return a._position=new t.Vector3D,a._velocity=new t.Vector3D,t.AudioManager.instance.hasAudioContext()&&(a._panner=a.context.createPanner()),a._maxDistance=1e4,a._minDistance=1,a._rollOffFactor=1,a._listener=new t.Vector3D,a}return __extends(r,e),Object.defineProperty(r.prototype,"listener",{get:function(){return this._listener},set:function(e){if(this._listener.copyFrom(e),t.AudioManager.instance.hasAudio()&&this.source){var r=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*r}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setPosition(e.x,e.y,e.z),t.AudioManager.instance.hasAudio()&&this.source){var r=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*r}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setVelocity(e.x,e.y,e.z)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.maxDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.refDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t,this._panner&&(this._panner.rolloffFactor=t)},enumerable:!0,configurable:!0}),r.prototype.createSource=function(){this.sound.buffer&&(this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this._panner),this._panner.connect(this.gain),this.gain.connect(this.context.destination))},r.prototype.fallOff=function(e,r,i,a,n){var o=t.Vector3D.distance(e,r);return i>o?1:o>a?0:1-o/(a-i)},r}(t.Channel);t.Channel3d=e,__reflect(e.prototype,"egret3d.Channel3d")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserType=function(e,r){switch(r){case"xml":break;case"json":return e.type?e.type:e.meta&&e.meta.smartupdate?(e.meta.smartupdate.indexOf(t.IConfigParser.TYPE_TEXTUREPACKER),t.IConfigParser.TYPE_TEXTUREPACKER):e.property&&e.emission&&e.life?t.IConfigParser.TYPE_PARTICLE:""}return""},e.parserConfig=function(r,i){var a=e.parserType(r,i);switch(a){case t.IConfigParser.TYPE_SCENE:case t.IConfigParser.TYPE_SKIN_MESH:case t.IConfigParser.TYPE_EFFECT_GROUP:return new t.UnitConfigParser(r,i,a);case t.IConfigParser.TYPE_PARTICLE:return new t.ParticleParser(r,i,a);case t.IConfigParser.TYPE_TEXTUREPACKER:return new t.TexturePackerParser(r,i,a)}return null},e.mapParser=function(e,r,i){var a;switch(e){case"xml":a=new t.UnitXmlParser(r,i);break;case"json":a=new t.UnitJsonParser(r,i)}a&&a.parser()},e.particleParser=function(e,r){return new t.ParticleParser(r,e).data},e.jsonVersion=function(e,r,i){var a;switch(e){case 1:a=new t.UnitJsonParser_1(r,i);break;default:a=new t.UnitJsonParser_1(r,i)}return a},e.xmlVersion=function(e,r,i){var a;switch(e){case 1:a=new t.UnitXmlParser_1(r,i)}return a},e.binVersion=function(t,e,r){return null},e}();t.UnitParserUtils=e,__reflect(e.prototype,"egret3d.UnitParserUtils")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,r){return t.call(this,e,r)||this}return __extends(e,t),e}(t.UnitParser);t.UnitBinParser=e,__reflect(e.prototype,"egret3d.UnitBinParser")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(i,a,n){void 0===a&&(a=null),void 0===n&&(n=null);var o=e.call(this)||this;if(o.audio=null,o._event=new t.Event3D,o._success=a,o._error=n,o.isLoaded=!1,t.AudioManager.instance.hasAudioContext())t.AudioManager.instance.isSupported(i,o.audio)?t.AudioManager.instance.context&&o.loadAudioFile(i):(console.warn("Audio format not supported"),o._event.eventType=r.SOUND_ERROR,o._event.target=o,o.dispatchEvent(o._event),n(o));else if(t.AudioManager.instance.hasAudio()){try{o.audio=new Audio}catch(s){return console.warn("No support for Audio element"),o._event.eventType=r.SOUND_ERROR,o._event.target=o,o.dispatchEvent(o._event),n&&n(o),o}t.AudioManager.instance.isSupported(i,o.audio)?(o.audio.src=i,o.audio.addEventListener("canplaythrough",function(t){return o.oncanplaythrough(t)}),o.audio.addEventListener("ended",function(t){return o.onended(t)}),o.audio.load()):(console.warn("Audio format not supported"),o._event.eventType=r.SOUND_ERROR,o._event.target=o,o.dispatchEvent(o._event),n&&n(o))}return o}return __extends(r,e),Object.defineProperty(r.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),r.prototype.loadAudioFile=function(t){var e=this;null==this.xhr&&(this.xhr=new XMLHttpRequest),this.xhr.open("GET",t,!0),this.xhr.responseType="arraybuffer",this.xhr.onload=function(t){return e.audioLoadend(t)},this.xhr.send()},r.prototype.audioLoadend=function(e){var r=this;t.AudioManager.instance.context.decodeAudioData(this.xhr.response,function(t){return r.decodeSuccessCallback(t)})},r.prototype.decodeSuccessCallback=function(t){this._buffer=t,this._event.eventType=r.SOUND_SUCCESS,this._event.target=this,this._event.data=t,this.dispatchEvent(this._event),this._success&&this._success(this)},r.prototype.onended=function(t){},r.prototype.oncanplaythrough=function(t){this.isLoaded||(this.isLoaded=!0,this._event.eventType=r.SOUND_SUCCESS,this._event.target=this,this._event.data=t,this.dispatchEvent(this._event),this._success&&this._success(this))},r}(t.EventDispatcher);e.SOUND_SUCCESS="SoundSuccess",e.SOUND_ERROR="SoundError",t.Sound=e,__reflect(e.prototype,"egret3d.Sound")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return __extends(r,e),r.prototype.parseMethod=function(e){var r,i=[];for(var a in e){r=new t.UnitMatMethodData,r.type=a;var n=e[a];for(var o in n)if("textures"==o)for(var s in n.textures){var l={};for(var h in n.textures[s])l[h]=n.textures[s][h];r.texturesData.push(l)}else{var u=typeof r[o];"string"==u?r[o]=n[o]:"number"==u?r[o]=Number(n[o]):"boolean"==u?r[o]="true"==n[o]?!0:!1:r[o]=n[o]}i.push(r)}return i},r.prototype.parseMat=function(e){var r=new t.UnitMatSphereData;for(var i in e)switch(i){case"uvRectangle":r.uvRectangle.x=Number(e.uvRectangle.x),r.uvRectangle.y=Number(e.uvRectangle.y),r.uvRectangle.width=Number(e.uvRectangle.width),r.uvRectangle.height=Number(e.uvRectangle.height);break;case"methods":r.methods=this.parseMethod(e.methods);break;case"blendMode":r.blendMode=Number(t.BlendMode[e[i]]);break;case"lightIds":for(var a=e[i].split(","),n=0;n<a.length;++n)r.lightIds.push(Number(a[n]));break;default:var o=typeof r[i];"number"==o?r[i]=Number(e[i]):"boolean"==o?r[i]="true"==e[i]:"string"==o&&(r[i]=e[i])}return r},r.prototype.parseNode=function(e){var r=new t.UnitNodeData;for(var i in e)if("pos"==i||"rot"==i||"scale"==i)for(var a in e[i])r[a]=Number(e[i][a]);else if("geometry"==i)for(var n in e[i])"type"==n?r.geometry[n]=e[i][n]:r.geometry[n]=Number(e[i][n]);else if("skinClips"==i)for(var o=0;o<e.skinClips.length;++o)r.skinClips.push(e.skinClips[o]);else if("propertyAnims"==i)for(var o=0;o<e.propertyAnims.length;++o)r.propertyAnims.push(e.propertyAnims[o]);else if("grass"==i)for(var o=0;o<e.grass.length;++o)r.grass.push(e.grass[o]);else if("mats"==i)r.materialIDs=(e[i]+"").split(",");else if("subs"==i)for(var o=0;o<e.subs.length;++o)r.childs.push(e.subs[o]);else if("boneBind"==i)r.boneBind=e.boneBind;else if("lightInfo"==i)r.lightData=this.parseLight(e.lightInfo);else if("lightIds"==i)r.lightIds=(e[i]+"").split(",");else{var s=typeof r[i];"number"==s?r[i]=Number(e[i]):"boolean"==s?r[i]="true"==e[i]?!0:!1:r[i]=e[i]}return r},r.prototype.parseEnvironment=function(t){if(t&&(t&&(this._mapConfigParser.isFogOpen=Boolean(t.isFogOpen),this._mapConfigParser.isFogOpen&&(this._mapConfigParser.fogColor=Number(t.fogColor),this._mapConfigParser.fogMode=String(t.fogMode),this._mapConfigParser.fogDensity=Number(t.fogDensity),this._mapConfigParser.linearFogStart=Number(t.linearFogStart),this._mapConfigParser.linearFogEnd=Number(t.linearFogEnd))),t.directLight&&(this._mapConfigParser.directLight="open"==t.directLight),t.pointLight&&(this._mapConfigParser.pointLight="open"==t.pointLight),t.lightList))for(var e=0;e<t.lightList.length;++e){var r=this.parseLight(t.lightList[e]);this._mapConfigParser.lightDict[r.id]=r}},r.prototype.parseHud=function(e){var r=new t.UnitHUDData;for(var i in e)if("pos"==i||"rot"==i||"size"==i)for(var a in e[i])r[a]=Number(e[i][a]);else"bothside"==i?r[i]="true"==e[i]:r[i]=e[i];return r},r.prototype.parseTexture=function(t){this._mapConfigParser.textures.push(t),this._mapConfigParser.calculateTextureTask(t)},r.prototype.parseLight=function(e){var r=new t.UnitLightData;for(var i in e)switch(i){case"id":case"diffuseColor":case"ambientColor":case"intensity":case"halfIntensity":case"falloff":case"radius":r[i]=Number(e[i]);break;case"type":r.type=Number(t.LightType[e.type]);break;case"direction":r.direction.x=Number(e[i].x),r.direction.y=Number(e[i].y),r.direction.z=Number(e[i].z);break;case"position":r.position.x=Number(e[i].x),r.position.y=Number(e[i].y),r.position.z=Number(e[i].z)}return r},r}(t.UnitJsonParser);t.UnitJsonParser_1=e,__reflect(e.prototype,"egret3d.UnitJsonParser_1")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.perspective=0]="perspective",t[t.orthogonal=1]="orthogonal",t[t.orthogonalToCenter=2]="orthogonalToCenter"}(e=t.CameraType||(t.CameraType={}));var r=function(r){function i(i){void 0===i&&(i=e.perspective);var a=r.call(this)||this;return a.projectMatrix=new t.Matrix4_4,a._orthProjectMatrix=new t.Matrix4_4,a._viewPort=new t.Rectangle,a._scissorRect=new t.Rectangle,a._aspectRatio=1,a._fovY=45,a._near=1,a._far=1e4,a.temp=new t.Matrix4_4,a._lookAtPosition=new t.Vector3D,a._up=new t.Vector3D(0,1,0),a._cameraType=0,a._cameraMatrixChange=!1,a._viewMatrix=new t.Matrix4_4,a._tempQuat=new t.Quaternion,a._normalMatrix=new t.Matrix4_4,a._unprojection=new t.Matrix4_4,a._animation=[],a.orthProjectChange=!0,a._mat=new t.Matrix4_4,a._maxBest=!1,a._maxBestPoint=new t.Point,a._angleVector=new t.Vector3D,a.billboardX=new t.Matrix4_4,a.billboardY=new t.Matrix4_4,a.billboardZ=new t.Matrix4_4,a.billboardXYZ=new t.Matrix4_4,a.raw=new Float32Array(16),a.v=new t.Vector3D,a.p=new t.Vector3D,a.frustum=new t.Frustum(a),a._orthProjectMatrix.ortho(a._viewPort.width,a._viewPort.height,a._near,a._far),a.cameraType=i,t.CameraManager.instance.addCamera(a),a._viewMatrix.identity(),a}return __extends(i,r),Object.defineProperty(i.prototype,"cameraType",{get:function(){return this._cameraType},set:function(t){switch(this._cameraType=t,t){case e.orthogonal:this.projectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far);break;case e.orthogonalToCenter:this.projectMatrix.orthoOffCenter(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height,this._near,this._far);break;case e.perspective:this.projectMatrix.perspective(this._fovY,this._aspectRatio,this._near,this._far)}this._orthProjectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far),this.frustum.updateFrustum()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxWidthAndHeight",{get:function(){return this._maxBest||(this._maxBest=!0,this._maxBestPoint.x=t.sizeUtil.getBestPowerOf2(this.viewPort.width),this._maxBestPoint.y=t.sizeUtil.getBestPowerOf2(this.viewPort.height)),this._maxBestPoint},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!=t&&(this._aspectRatio=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fieldOfView",{get:function(){return this._fovY},set:function(t){this._fovY!=t&&(this._fovY=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"near",{get:function(){return this._near},set:function(t){this._near!=t&&(this._near=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"far",{get:function(){return this._far},set:function(t){this._far!=t&&(this._far=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"viewProjectionMatrix",{get:function(){return this.temp.copyFrom(this.viewMatrix),this.temp.multiply(this.projectMatrix),this.temp},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"orthProjectionMatrix",{get:function(){return this.orthProjectChange&&(this.orthProjectChange=!1,this._orthProjectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far)),this._orthProjectMatrix},enumerable:!0,configurable:!0}),i.prototype.updateScissorRect=function(t,e,r,i){this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=r,this._scissorRect.height=i},i.prototype.updateViewport=function(t,r,i,a){if(t!=this._viewPort.x||r!=this._viewPort.y||i!=this._viewPort.width||a!=this._viewPort.height)switch(this.orthProjectChange=!0,this._viewPort.x=t,this._viewPort.y=r,this._viewPort.width=i,this._viewPort.height=a,this.cameraType){case e.orthogonal:case e.orthogonalToCenter:this.cameraType=this.cameraType}},i.prototype.lookAt=function(e,r,i){void 0===i&&(i=t.Vector3D.Y_AXIS),this.globalPosition=e,this._lookAtPosition.copyFrom(r),this._up.copyFrom(i),this._viewMatrix.lookAt(e,r,i),this._mat.copyFrom(this._viewMatrix),this._mat.invert();var a=this._mat.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=a[1].x,this._tempQuat.y=a[1].y,this._tempQuat.z=a[1].z,this._tempQuat.w=a[1].w,this.globalOrientation=this._tempQuat},i.prototype.lookAtLocal=function(e,r,i){void 0===i&&(i=t.Vector3D.Y_AXIS),this.position=e,this._lookAtPosition.copyFrom(r),this._up.copyFrom(i),this._viewMatrix.lookAt(e,r,i),this._mat.copyFrom(this._viewMatrix),this._mat.invert();var a=this._mat.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=a[1].x,this._tempQuat.y=a[1].y,this._tempQuat.z=a[1].z,this._tempQuat.w=a[1].w,this.orientation=this._tempQuat},i.prototype.onMakeTransform=function(){t.Vector3D.HELP_1.setTo(1,1,1,1),t.Vector3D.HELP_0.setTo(0,0,0,1),this._modelMatrix3D.makeTransform(this._pos,t.Vector3D.HELP_1,this._orientation),this._modelMatrix3D.makeTransform(this._globalPos,t.Vector3D.HELP_1,this._globalOrientation),t.MathUtil.calcDegree(this._globalOrientation,this._angleVector),this.billboardY.identity(),this.billboardY.createByRotation(this._angleVector.y,t.Vector3D.Y_AXIS),this.billboardXYZ.makeTransform(t.Vector3D.HELP_0,t.Vector3D.HELP_1,this._globalOrientation)},i.prototype.onUpdateTransform=function(){this._viewMatrix.copyFrom(this._modelMatrix3D),this._viewMatrix.invert(),this.frustum.update()},Object.defineProperty(i.prototype,"viewMatrix",{get:function(){return this._transformChange&&this.modelMatrix,this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:!0,configurable:!0}),i.prototype.updataOrth=function(t){var e,r,i,a,n=2e3,o=.5*n,s=o*this._aspectRatio;if(0==this._scissorRect.x&&0==this._scissorRect.y&&this._scissorRect.width==this._viewPort.width&&this._scissorRect.height==this._viewPort.height)e=-s,r=s,i=-o,a=o,this.raw[0]=2/(n*this._aspectRatio),this.raw[5]=2/n,this.raw[10]=1/(this._far-this._near),this.raw[14]=this._near/(this._near-this._far),this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=this.raw[12]=this.raw[13]=0,this.raw[15]=1;else{var l=s*(this._viewPort.width/this._scissorRect.width),h=o*(this._viewPort.height/this._scissorRect.height),u=s*(2*this._scissorRect.x-this._viewPort.width)/this._scissorRect.width+s,c=-o*(2*this._scissorRect.y-this._viewPort.height)/this._scissorRect.height-o;e=u-l,r=u+l,i=c-h,a=c+h,this.raw[0]=2/(r-e),this.raw[5]=-2/(i-a),this.raw[10]=1/(this._far-this._near),this.raw[12]=(r+e)/(r-e),this.raw[13]=(a+i)/(a-i),this.raw[14]=this._near/(this.near-this.far),this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=0,this.raw[15]=1}t.copyRawDataFrom(this.raw)},i.prototype.isVisibleToCamera=function(t){t.modelMatrix,this.modelMatrix;var e=!0;return t.bound&&(e=t.bound.inBound(this.frustum)||!t.enableCulling),t.inFrustum=e,e},i.prototype.addAnimation=function(t,e){this._animation[t]=e},i.prototype.play=function(t,e){void 0===e&&(e=!1),this._animation[t]&&(this._animation[t].bindCamera(this),this._animation[t].play(e))},i.prototype.update=function(t,e,i){r.prototype.update.call(this,t,e,i);for(var a in this._animation)this._animation[a].update(t,e)},i.prototype.object3DToScreenRay=function(e,r){return void 0===r&&(r=null),r||(r=new t.Vector3D),this._halfw=.5*this.viewPort.width,this._halfh=.5*this.viewPort.height,r=this.viewMatrix.transformVector(e,r),this.project(r,r),r.x=this._halfw+r.x*this._halfw,r.y=this.viewPort.height-(this._halfh-r.y*this._halfh),r},i.prototype.ScreenRayToObject3D=function(e,r){return void 0===r&&(r=null),r||(r=new t.Vector3D),this._halfw=.5*this.viewPort.width,this._halfh=.5*this.viewPort.height,r.x=(e.x-this._halfw)/this._halfw,r.y=(this._halfh-(this.viewPort.height-e.y))/this._halfh,this.unproject(r.x,r.y,e.z,r),this.modelMatrix.transformVector(r,r),r},i.prototype.unproject=function(t,e,r,i){return i.x=t,i.y=-e,i.z=r,i.w=1,i.x*=r,i.y*=r,this._unprojection.copyFrom(this.projectMatrix),this._unprojection.invert(),this._unprojection.transformVector(i,i),i.z=r,i},i.prototype.project=function(t,e){return e=this.projectMatrix.transformVector(t,e),e.x=e.x/e.w,e.y=-e.y/e.w,e.z=t.z,e},i.prototype.dispose=function(){t.CameraManager.instance.removeCamera(this),r.prototype.dispose.call(this),this.frustum&&this.frustum.dispose(),this.frustum=null},i.prototype.clone=function(){var t=new i;return t.copy(this),t},i}(t.Object3D);t.Camera3D=r,__reflect(r.prototype,"egret3d.Camera3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return __extends(r,e),r.prototype.parseTexture=function(t){if(1==t.childNodes.length)return null;var e,r=null,i=0,a=0;
for(i=0,a=t.childNodes.length;a>i;i++)if(e=t.childNodes[i],!this.nodeFilter(e)){for(var n={},o=0;o<e.attributes.length;++o)r=e.attributes[o],n[r.name]=r.value;this._mapConfigParser.textures.push(n),this._mapConfigParser.calculateTextureTask(n)}},r.prototype.parseMethod=function(e){if(e.childNodes.length<=1)return null;for(var r,i,a,n=[],o=0,s=null,l=0,o=e.childNodes.length;o>l;l++)if(r=e.childNodes[l],i=r.nodeName,!this.nodeFilter(r)){a=new t.UnitMatMethodData,a.type=i;for(var h=0;h<r.attributes.length;++h){s=r.attributes[h];var u=typeof a[s.name];"string"==u?a[s.name]=s.value:"number"==u?a[s.name]=Number(s.value):"boolean"==u?a[s.name]="true"==s.value?!0:!1:a[s.name]=s.value}for(var h=0;h<r.childNodes.length;++h){var c=r.childNodes[h];if(!this.nodeFilter(c)){for(var d={},p=0;p<c.attributes.length;++p)s=c.attributes[p],d[s.name]=s.value;a.texturesData.push(d)}}n.push(a)}return n},r.prototype.parseMat=function(e){if(0==e.childNodes.length)return null;for(var r=new t.UnitMatSphereData,i=null,a=0;a<e.attributes.length;++a)i=e.attributes[a],r[i.name]=i.value;for(var n,o,s=0,a=0,s=e.childNodes.length;s>a;a++)if(n=e.childNodes[a],o=n.nodeName,!this.nodeFilter(n))if("methods"==o)r.methods=this.parseMethod(n);else if("uvRectangle"==o)for(var l=0;l<n.attributes.length;++l)r.uvRectangle[n.attributes[l].name]=Number(n.attributes[l].value);else if("blendMode"==o)r[n.nodeName]=t.BlendMode[n.textContent];else if("lightIds"==o){if(n.textContent)for(var h=n.textContent.split(","),l=0;l<h.length;++l)r.lightIds.push(Number(h[l]))}else{var u=typeof r[n.nodeName];"string"==u?r[n.nodeName]=n.textContent:"number"==u?r[n.nodeName]=Number(n.textContent):"boolean"==u&&(r[n.nodeName]="true"==n.textContent?!0:!1)}return r},r.prototype.parseNode=function(e){if(1==e.childNodes.length)return null;for(var r=null,i=new t.UnitNodeData,a=0;a<e.attributes.length;++a){r=e.attributes[a];var n=typeof i[r.name];"number"==n?i[r.name]=Number(r.value):"boolean"==n?i[r.name]="true"==r.value?!0:!1:i[r.name]=r.value}var o,s,a=0,l=0;for(a=0,l=e.childNodes.length;l>a;a++)if(o=e.childNodes[a],s=o.nodeName,!this.nodeFilter(o))if("pos"==s)for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],i[r.nodeName]=Number(r.value);else if("rot"==s)for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],i[r.nodeName]=Number(r.value);else if("scale"==s)for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],i[r.nodeName]=Number(r.value);else if("mat"==s)for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],"id"==r.nodeName&&(i.materialIDs=(r.value+"").split(","));else if("skinClip"==s){var u={};i.skinClips.push(u);for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],u[r.nodeName]=r.value}else if("propertyAnim"==s){var c={};i.propertyAnims.push(c);for(var h=0;h<o.attributes.length;++h)r=o.attributes[h],c[r.nodeName]=r.value}else if("geometry"==s){for(var d={},h=0;h<o.attributes.length;++h)r=o.attributes[h],"type"==r.name?d[r.name]=r.value:d[r.name]=Number(r.value);i.geometry=d}else if("sub"==s){for(var p={},h=0;h<o.attributes.length;++h)r=o.attributes[h],p[r.name]=r.value;i.childs.push(p)}return i},r.prototype.parseEnvironment=function(e){if(!(e.length<=0)){for(var r,i,a,n=null,o=0;o<e[0].attributes.length;++o)n=e[0].attributes[o],this._mapConfigParser[n.name]="open"==n.value;for(var s=0,l=e.length;l>s;s++){r=e[s];for(var h=0;h<r.childNodes.length;++h)if(i=r.childNodes[h],!this.nodeFilter(i))if("light"==i.nodeName){for(var u=new t.UnitLightData,o=0;o<i.attributes.length;++o)n=i.attributes[o],"id"==n.name?u[n.name]=Number(n.value):u[n.name]=n.value;this._mapConfigParser.lightDict[u.id]=u;for(var o=0;o<i.childNodes.length;++o)if(a=i.childNodes[o],!this.nodeFilter(a))if("direction"==a.nodeName)for(var c=0;c<a.attributes.length;++c)n=a.attributes[c],u.direction[n.name]=Number(n.value);else if("position"==a.nodeName)for(var c=0;c<a.attributes.length;++c)n=a.attributes[c],u.position[n.name]=Number(n.value);else"type"==a.nodeName?u.type=t.LightType[a.textContent]:u[a.nodeName]=Number(a.textContent)}else"fog"==i.nodeName}}},r.prototype.parseHud=function(e){if(1==e.childNodes.length)return null;for(var r=null,i=new t.UnitHUDData,a=0;a<e.attributes.length;++a)r=e.attributes[a],"bothside"==r.nodeName?i[r.nodeName]="true"==r.value:i[r.nodeName]=r.value;var n,o,a=0,s=0;for(a=0,s=e.childNodes.length;s>a;a++)if(n=e.childNodes[a],o=n.nodeName,!this.nodeFilter(n))for(var l=0;l<n.attributes.length;++l)r=n.attributes[l],"shader"==o?i[r.nodeName]=r.value:i[r.nodeName]=Number(r.value);return i},r}(t.UnitXmlParser);t.UnitXmlParser_1=e,__reflect(e.prototype,"egret3d.UnitXmlParser_1")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=13421772);var i=e.call(this)||this;return i.color=r,i.diffuseTexture=t.CheckerboardTexture.texture,i.initMatPass(),i}return __extends(r,e),r.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass),this.diffusePass.addMethod(new t.ColorMethod)},Object.defineProperty(r.prototype,"color",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha=t},enumerable:!0,configurable:!0}),r}(t.MaterialBase);t.ColorMaterial=e,__reflect(e.prototype,"egret3d.ColorMaterial")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===r&&(r=null),void 0===i&&(i=null);var a=e.call(this,i)||this;return a.initMatPass(),r||(r=t.CubeTexture.createCubeTextureByImageTexture(t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture,t.CheckerboardTexture.texture)),a.materialData.diffuseTexture3D=r,a}return __extends(r,e),r.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass),this.diffusePass.addMethod(new t.CubeMethod)},r.prototype.clone=function(){var t=new r(this.diffuseTexture,this.materialData.clone());return t},r}(t.MaterialBase);t.CubeTextureMaterial=e,__reflect(e.prototype,"egret3d.CubeTextureMaterial")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===r&&(r=null),void 0===i&&(i=null);var a=e.call(this,i)||this;return r?a.diffuseTexture=r:a.diffuseTexture=t.CheckerboardTexture.texture,a.initMatPass(),a}return __extends(r,e),r.prototype.initMatPass=function(){this._fakePBR=new t.FakePBRPass(this.materialData),this.materialData.shaderPhaseTypes[t.PassType.diffusePass]=[],this.passes[t.PassType.diffusePass]=[this._fakePBR]},Object.defineProperty(r.prototype,"albedoTexture",{set:function(t){this._fakePBR.setTexture("albedoTex",t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"normalTexture",{set:function(t){this._fakePBR.setTexture("normalTex",t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"glossTexture",{set:function(t){this._fakePBR.setTexture("glossTex",t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"specularTexture",{set:function(t){this._fakePBR.setTexture("specularTex",t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"opacityTexture",{set:function(t){this._fakePBR.setTexture("opacityTex ",t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"reflectionTexture",{set:function(t){this._fakePBR.setTexture("reflectionMap",t)},enumerable:!0,configurable:!0}),r.prototype.clone=function(){var e=new t.TextureMaterial(this.diffuseTexture,this.materialData.clone());return e},r}(t.MaterialBase);t.FakePBRMaterial=e,__reflect(e.prototype,"egret3d.FakePBRMaterial")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.cameras=new Array}return t.prototype.addCamera=function(t){this.cameras.push(t)},t.prototype.removeCamera=function(t){var e=this.cameras.indexOf(t);e>=0&&this.cameras.splice(e,1)},t.prototype.update=function(t,e){},t}();e.instance=new e,t.CameraManager=e,__reflect(e.prototype,"egret3d.CameraManager")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.shaderPhaseTypes={},r.matID=0,r.drawMode=t.DrawMode.TRIANGLES,r.useMipmap=!0,r.normalTexture=t.CheckerboardTexture.texture,r.matcapTexture=t.CheckerboardTexture.texture,r.specularTexture=t.CheckerboardTexture.texture,r.lightTexture=t.CheckerboardTexture.texture,r.maskTexture=t.CheckerboardTexture.texture,r.aoTexture=t.CheckerboardTexture.texture,r.environmentTexture=t.CheckerboardTexture.texture,r.blendMaskTexture=t.CheckerboardTexture.texture,r.splat_0Tex=t.CheckerboardTexture.texture,r.splat_1Tex=t.CheckerboardTexture.texture,r.splat_2Tex=t.CheckerboardTexture.texture,r.splat_3Tex=t.CheckerboardTexture.texture,r.layer=0,r.castShadow=!1,r.acceptShadow=!1,r.shadowColor=new Float32Array([.2,.2,.2,.003]),r.depthTest=!0,r.depthWrite=!0,r.depthMode=0,r.blendMode=t.BlendMode.NORMAL,r.alphaBlending=!1,r.ambientColor=0,r.diffuseColor=16777215,r.specularColor=16777215,r.tintColor=2155905152,r.specularLevel=1,r.gamma=1,r.refraction=1.9,r.refractionintensity=0,r.gloss=10,r.cutAlpha=0,r.repeat=!1,r.bothside=!1,r.alpha=1,r.albedo=.95,r.normalDir=-1,r.uvRectangle=new t.Rectangle(0,0,1,1),r.materialDataNeedChange=!0,r.textureChange=!1,r.textureStateChage=!0,r.cullFrontOrBack=t.ContextConfig.BACK,r.materialSourceData=new Float32Array(20),r.colorGradientsSource=new Float32Array(6),r}return __extends(r,e),r.prototype.clone=function(){var t=new r;t.drawMode=this.drawMode,t.diffuseTexture=this.diffuseTexture,t.shadowMapTexture=this.shadowMapTexture;for(var e=0;4>e;++e)t.shadowColor[e]=this.shadowColor[e];return t.layer=this.layer,t.castShadow=this.castShadow,t.acceptShadow=this.acceptShadow,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.blendMode=this.blendMode,t.blend_src=this.blend_src,t.blend_dest=this.blend_dest,t.ambientColor=this.ambientColor,t.diffuseColor=this.diffuseColor,t.specularColor=this.specularColor,t.cutAlpha=this.cutAlpha,t.alpha=this.alpha,t.specularLevel=this.specularLevel,t.gloss=this.gloss,t.albedo=this.albedo,t.gamma=this.gamma,t.refraction=this.refraction,t.refractionintensity=this.refractionintensity,t.materialDataNeedChange=this.materialDataNeedChange,t.textureChange=!0,t.cullFrontOrBack=this.cullFrontOrBack,t.colorTransform=this.colorTransform,t},r.prototype.dispose=function(){},r}(Object);t.MaterialData=e,__reflect(e.prototype,"egret3d.MaterialData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===r&&(r=null),void 0===i&&(i=null);var a=e.call(this,i)||this;return r?a.diffuseTexture=r:a.diffuseTexture=t.CheckerboardTexture.texture,a.initMatPass(),a}return __extends(r,e),r.prototype.initMatPass=function(){this.creatPass(t.PassType.diffusePass)},r.prototype.clone=function(){var t=new r(this.diffuseTexture,this.materialData.clone());return t},r}(t.MaterialBase);t.TextureMaterial=e,__reflect(e.prototype,"egret3d.TextureMaterial")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.aoPower=1,r.fsShaderList[t.ShaderPhaseType.shadow_fragment]=r.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],r.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("AOMap_fs"),r}return __extends(r,e),Object.defineProperty(r.prototype,"lightTexture",{set:function(t){this.texture=t,this.materialData.aoTexture=this.texture,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.aoPower=a.getUniformLocation(r.program3D,"aoPower")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1f(r.aoPower,this.aoPower)},r.prototype.dispose=function(){},r}(t.MethodBase);t.AOMapMethod=e,__reflect(e.prototype,"egret3d.AOMapMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.fsShaderList[t.ShaderPhaseType.shadow_fragment]=r.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],r.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("alphaMask_fs"),r}return __extends(r,e),Object.defineProperty(r.prototype,"maskTexture",{set:function(t){this.texture=t,this.materialData.maskTexture=this.texture,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){},r.prototype.activeState=function(t,e,r,i,a,n,o){},r}(t.MethodBase);t.AlphaMaskMethod=e,__reflect(e.prototype,"egret3d.AlphaMaskMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._posStart=0,r._posEnd=0,r._color=new t.Color,r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],r.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorGradients_fs"),r}return __extends(r,e),r.prototype.setStartData=function(t,e,r){this._color.copyFrom(r),this._posStart=t,this._posEnd=e},r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_colorGradientsSource=a.getUniformLocation(r.program3D,"uniform_colorGradientsSource")},r.prototype.activeState=function(t,e,r,i,a,n,o){this.materialData.colorGradientsSource[0]=this._posStart,this.materialData.colorGradientsSource[1]=this._posEnd,this.materialData.colorGradientsSource[2]=this._color.r,this.materialData.colorGradientsSource[3]=this._color.g,this.materialData.colorGradientsSource[4]=this._color.b,this.materialData.colorGradientsSource[5]=this._color.a,a.uniform1fv(r.uniform_colorGradientsSource,this.materialData.colorGradientsSource)},r}(t.MethodBase);t.ColorGradientsMethod=e,__reflect(e.prototype,"egret3d.ColorGradientsMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],r.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("color_fragment"),r}return __extends(r,e),r.prototype.upload=function(t,e,r,i,a,n,o){},r.prototype.activeState=function(t,e,r,i,a,n,o){},r}(t.MethodBase);t.ColorMethod=e,__reflect(e.prototype,"egret3d.ColorMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],r.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorTransform_fs"),r}return __extends(r,e),Object.defineProperty(r.prototype,"colorTransform",{get:function(){return this.materialData.colorTransform},set:function(t){this.materialData.colorTransform=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_colorTransformAlpha=a.getUniformLocation(r.program3D,"uniform_colorTransformAlpha"),r.uniform_colorTransformM44=a.getUniformLocation(r.program3D,"uniform_colorTransformM44")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1f(r.uniform_colorTransformAlpha,this.colorTransform.alpha),a.uniformMatrix4fv(r.uniform_colorTransformM44,!1,this.colorTransform.m44.rawData)},r}(t.MethodBase);t.ColorTransformMethod=e,__reflect(e.prototype,"egret3d.ColorTransformMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.vsShaderList[t.ShaderPhaseType.global_vertex]=r.fsShaderList[t.ShaderPhaseType.global_vertex]||[],r.vsShaderList[t.ShaderPhaseType.global_vertex].push("cube_vertex"),r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],r.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("cube_fragment"),r}return __extends(r,e),r.prototype.upload=function(t,e,r,i,a,n,o){},r.prototype.activeState=function(t,e,r,i,a,n,o){},r}(t.MethodBase);t.CubeMethod=e,__reflect(e.prototype,"egret3d.CubeMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.reflectValue=.3,r.fsShaderList[t.ShaderPhaseType.lighting_fragment]=r.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[],r.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("environmentMapping_fragment"),r}return __extends(r,e),Object.defineProperty(r.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"environmentTexture",{set:function(t){this.texture=t,t&&this.materialData.environmentMapTex!=this.texture&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.reflectValue=a.getUniformLocation(r.program3D,"reflectValue")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1f(r.reflectValue,this.reflectValue)},r}(t.MethodBase);t.EnvironmentMethod=e,__reflect(e.prototype,"egret3d.EnvironmentMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r="expHeightFog_fs");var i=e.call(this)||this;return i.uniform_globalFog=new Float32Array(7),i._fogColor=204,i._globalDensity=1,i._fogStartDistance=1e3,i._fogDistanceScale=.5,i._height=500,i._fogAlpha=1,i.vsShaderList[t.ShaderPhaseType.local_vertex]=i.vsShaderList[t.ShaderPhaseType.local_vertex]||[],i.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs"),"line"==r?i.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("lineFog"):"exp"==r?i.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expFog_fs"):"expHeightFog_fs"==r&&(i.fsShaderList[t.ShaderPhaseType.lighting_fragment]=i.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[],i.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expHeightFog_fs")),i.uniform_globalFog[0]=.5,i.uniform_globalFog[1]=.6,i.uniform_globalFog[2]=.7,i.uniform_globalFog[3]=i._globalDensity,i.uniform_globalFog[4]=i._fogStartDistance,i.uniform_globalFog[5]=i._height,i.uniform_globalFog[6]=i._fogAlpha,i}return __extends(r,e),Object.defineProperty(r.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t,this.uniform_globalFog[0]=(this._fogColor>>16&255)/255,this.uniform_globalFog[1]=(this._fogColor>>8&255)/255,this.uniform_globalFog[2]=(255&this._fogColor)/255},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t,this.uniform_globalFog[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t,this.uniform_globalFog[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogHeight",{get:function(){return this._height},set:function(t){this._height=t,this.uniform_globalFog[5]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogAlpha",{get:function(){return this._height},set:function(t){this._height=t,this.uniform_globalFog[6]=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_globalFog=a.getUniformLocation(r.program3D,"uniform_globalFog")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1fv(r.uniform_globalFog,this.uniform_globalFog)},r.prototype.dispose=function(){},r}(t.MethodBase);t.FogMethod=e,__reflect(e.prototype,"egret3d.FogMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.vsShaderList[t.ShaderPhaseType.base_vertex]=r.vsShaderList[t.ShaderPhaseType.base_vertex]||[],r.vsShaderList[t.ShaderPhaseType.base_vertex].push("gui_vs"),r.fsShaderList[t.ShaderPhaseType.base_fragment]=r.fsShaderList[t.ShaderPhaseType.base_fragment]||[],r.fsShaderList[t.ShaderPhaseType.base_fragment].push("gui_fs"),r}return __extends(r,e),r.prototype.setTextures=function(t,e){var r="uiTexture_"+t.toString();this.materialData[r]=e,this.materialData[r].useMipmap=!1},r.prototype.upload=function(t,e,r,i,a,n,o){},r.prototype.activeState=function(t,e,r,i,a,n,o){},r}(t.MethodBase);t.GUIMethod=e,__reflect(e.prototype,"egret3d.GUIMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=!0);var i=e.call(this)||this;return i._globalColorData=new Float32Array(3),i.vsShaderList[t.ShaderPhaseType.local_vertex]=i.vsShaderList[t.ShaderPhaseType.local_vertex]||[],i.vsShaderList[t.ShaderPhaseType.local_vertex].push("secondaryUV_vs"),i.fsShaderList[t.ShaderPhaseType.lighting_fragment]=i.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[],i.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("lightingBase_fs"),r?(i.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=i.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],i.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("lightMapSpecularPower_fs")):(i.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=i.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],i.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("lightMap_fs")),i}return __extends(r,e),Object.defineProperty(r.prototype,"lightTexture",{set:function(t){this.texture=t,this.materialData.lightTexture!=this.texture&&(this.materialData.lightTexture=this.texture,this.materialData.lightTexture.useMipmap=!1,this.materialData.lightTexture.smooth=!0,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){},r.prototype.activeState=function(t,e,r,i,a,n,o){},r}(t.MethodBase);t.LightmapMethod=e,__reflect(e.prototype,"egret3d.LightmapMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.uniform_globalFog=new Float32Array(7),r._fogColor=204,r._fogStartDistance=100,r._fogFarDistance=1e3,r._fogAlpha=1,r.vsShaderList[t.ShaderPhaseType.local_vertex]=r.vsShaderList[t.ShaderPhaseType.local_vertex]||[],r.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs"),r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],r.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("lineFog"),r.uniform_globalFog[0]=.5,r.uniform_globalFog[1]=.6,r.uniform_globalFog[2]=.7,r.uniform_globalFog[3]=1,r.uniform_globalFog[4]=r._fogStartDistance,r.uniform_globalFog[5]=r._fogFarDistance,r.uniform_globalFog[6]=r._fogAlpha,r}return __extends(r,e),Object.defineProperty(r.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t,this.uniform_globalFog[0]=(this._fogColor>>16&255)/255,this.uniform_globalFog[1]=(this._fogColor>>8&255)/255,this.uniform_globalFog[2]=(255&this._fogColor)/255},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t,this.uniform_globalFog[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogFarDistance",{get:function(){return this._fogFarDistance},set:function(t){this._fogFarDistance=t,this.uniform_globalFog[5]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogAlpha",{get:function(){return this._fogAlpha},set:function(t){this._fogAlpha=t,this.uniform_globalFog[6]=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_globalFog=a.getUniformLocation(r.program3D,"uniform_globalFog")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1fv(r.uniform_globalFog,this.uniform_globalFog)},r.prototype.dispose=function(){},r}(t.MethodBase);t.LineFogMethod=e,__reflect(e.prototype,"egret3d.LineFogMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.Face=e,__reflect(e.prototype,"egret3d.Face");var r=function(){function r(e){this.height=0,this.selectFaces=[],this.mesh=e,this._offsetPos=new t.Vector3D,this._offsetPos.copyFrom(e.globalPosition),this._geometry=e.geometry,this.buildFace()}return r.prototype.buildFace=function(){for(var r=0,i=0,a=0,n=[],o=0;o<this._geometry.indexCount/3;o++){var s=new e;s.v_0=new t.Vector3D,s.v_1=new t.Vector3D,s.v_2=new t.Vector3D,s.min=new t.Vector3D,s.max=new t.Vector3D,s.centre=new t.Vector3D,r=this._geometry.indexArray[3*o+0],i=this._geometry.indexArray[3*o+1],a=this._geometry.indexArray[3*o+2],s.v_0.x=this._offsetPos.x+this._geometry.vertexArray[r*this._geometry.vertexAttLength+0],s.v_0.y=this._offsetPos.y+this._geometry.vertexArray[r*this._geometry.vertexAttLength+1],s.v_0.z=this._offsetPos.z+this._geometry.vertexArray[r*this._geometry.vertexAttLength+2],s.v_1.x=this._offsetPos.x+this._geometry.vertexArray[i*this._geometry.vertexAttLength+0],s.v_1.y=this._offsetPos.y+this._geometry.vertexArray[i*this._geometry.vertexAttLength+1],s.v_1.z=this._offsetPos.z+this._geometry.vertexArray[i*this._geometry.vertexAttLength+2],s.v_2.x=this._offsetPos.x+this._geometry.vertexArray[a*this._geometry.vertexAttLength+0],s.v_2.y=this._offsetPos.y+this._geometry.vertexArray[a*this._geometry.vertexAttLength+1],s.v_2.z=this._offsetPos.z+this._geometry.vertexArray[a*this._geometry.vertexAttLength+2],s.min.x=Math.min(s.v_0.x,s.v_1.x,s.v_2.x),s.min.y=Math.min(s.v_0.y,s.v_1.y,s.v_2.y),s.min.z=Math.min(s.v_0.z,s.v_1.z,s.v_2.z),s.max.x=Math.max(s.v_0.x,s.v_1.x,s.v_2.x),s.max.y=Math.max(s.v_0.y,s.v_1.y,s.v_2.y),s.max.z=Math.max(s.v_0.z,s.v_1.z,s.v_2.z),s.centre.x=s.min.x+.5*(s.max.x-s.min.x),s.centre.y=s.min.y+.5*(s.max.y-s.min.y),s.centre.z=s.min.z+.5*(s.max.z-s.min.z),n.push(new t.KDData([s.centre.x,s.centre.z,s.centre.y],s))}this._kdTree=new t.KDTree,this._kdTree.buildTree(n)},r.prototype.getTerrainCollisionHeight=function(t,e){var r,i=this._kdTree.root.find([t,e],3);this.selectFaces.length=0;for(var a=0;a<i.length;a++)if(r=i[a].datum.data,this.selectFaces.push(r),this.checkPointInTriangle(t,e,r))return this.height=this.getHeightInTriangle(t,e,r);return this.height},r.prototype.checkPointInTriangle=function(t,e,r){var i=r.v_0,a=r.v_1,n=r.v_2,o=i.z-a.z,s=a.x-i.x,l=i.x*a.z-a.x*i.z,h=a.z-n.z,u=n.x-a.x,c=a.x*n.z-n.x*a.z,d=n.z-i.z,p=i.x-n.x,f=n.x*i.z-i.x*n.z,m=!1,_=o*t+s*e+l,v=h*t+u*e+c,g=d*t+p*e+f,y=.01;return(_>=-y&&v>=-y&&g>=-y||y>=_&&y>=v&&y>=g)&&(m=!0),m},r.prototype.getHeightInTriangle=function(e,r,i){var a=i.v_0,n=i.v_1,o=i.v_2,s=t.Vector3D.HELP_2;if(a.x>=e)o.x>=e?(s=o,o=n,n=s):n.x>=e||(s=o,o=a,a=s);else{if(!(a.x<e))return a.y;o.x<e?(s=o,o=n,n=s):n.x<e||(s=o,o=a,a=s)}var l=t.Vector3D.HELP_0,h=t.Vector3D.HELP_1;l.x=e,a.x-o.x==0?(l.y=o.y,l.z=o.z):(l.y=(a.y-o.y)*(e-o.x)/(a.x-o.x)+o.y,l.z=(a.z-o.z)*(e-o.x)/(a.x-o.x)+o.z),h.x=e,n.x-o.x==0?(h.y=o.y,h.z=o.z):(h.y=(n.y-o.y)*(e-o.x)/(n.x-o.x)+o.y,h.z=(n.z-o.z)*(e-o.x)/(n.x-o.x)+o.z);var u;return u=l.z==h.z?h.y:(l.y-h.y)*(r-h.z)/(l.z-h.z)+h.y},r}();t.TerrainCollision=r,__reflect(r.prototype,"egret3d.TerrainCollision")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvRoll=new Float32Array(4),r._uvSpeed=new Float32Array(4),r._time=0,r._start=!1,r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],r.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("mulUvRoll_fs"),r._uvSpeed[0]=5e-5,r._uvSpeed[1]=0,r._uvSpeed[2]=5e-5,r._uvSpeed[3]=0,r}return __extends(r,e),r.prototype.setSpeedU=function(t,e){this._uvSpeed[2*t+0]=e},r.prototype.getSpeedU=function(t){return this._uvSpeed[2*t+0]},r.prototype.setSpeedV=function(t,e){this._uvSpeed[2*t+1]=e},r.prototype.getSpeedV=function(t){return this._uvSpeed[2*t+1]},r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},Object.defineProperty(r.prototype,"diffuseTexture1",{get:function(){return this._diffuseTexture1},set:function(t){this._diffuseTexture1=t,this.materialData.diffuseTexture1=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.mulUvRoll=a.getUniformLocation(r.program3D,"mulUvRoll")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e);for(var s=0;4>s;++s)this._uvRoll[s]=this._time*this._uvSpeed[s];a.uniform1fv(r.mulUvRoll,this._uvRoll)},r}(t.MethodBase);t.MulUVRollMethod=e,__reflect(e.prototype,"egret3d.MulUVRollMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n){void 0===n&&(n=!0);var o=e.call(this)||this;return o._isRandom=!0,o._multiData=new Float32Array(4),o._multiData[0]=r,o._multiData[1]=i,o._multiData[2]=a,o._isRandom=n,o.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=o.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],o.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("MultiUVSprite_fs"),o}return __extends(r,e),Object.defineProperty(r.prototype,"row",{get:function(){return this._multiData[0]},set:function(t){this._multiData[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"column",{get:function(){return this._multiData[1]},set:function(t){this._multiData[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"sum",{get:function(){return this._multiData[2]},set:function(t){this._multiData[2]=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.multiUV=a.getUniformLocation(r.program3D,"multiUV"),this._isRandom&&(this._multiData[3]=Math.floor(Math.random()*this.sum))},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform4fv(r.multiUV,this._multiData)},r}(t.MethodBase);t.MultiUVSpriteMethod=e,__reflect(e.prototype,"egret3d.MultiUVSpriteMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.uniform_rimData=new Float32Array(6),r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],r.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("rimlight_fs"),r.uniform_rimData[0]=.99,r.uniform_rimData[1]=0,r.uniform_rimData[2]=0,r.uniform_rimData[3]=1,r.uniform_rimData[4]=5,r.uniform_rimData[5]=1,r}return __extends(r,e),Object.defineProperty(r.prototype,"rimColor",{get:function(){return t.Color.RGBAToColor(this.uniform_rimData[0],this.uniform_rimData[1],this.uniform_rimData[2],this.uniform_rimData[3])},set:function(e){var r=t.Color.getColor(e);this.uniform_rimData[0]=r.x,this.uniform_rimData[1]=r.y,this.uniform_rimData[2]=r.z,this.uniform_rimData[3]=r.w},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rimPow",{get:function(){return this.uniform_rimData[4]},set:function(t){this.uniform_rimData[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"strength",{get:function(){return this.uniform_rimData[5]},set:function(t){this.uniform_rimData[5]=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_rimData=a.getUniformLocation(r.program3D,"uniform_rimData")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1fv(r.uniform_rimData,this.uniform_rimData)},r.prototype.dispose=function(){},r}(t.MethodBase);t.RimlightMethod=e,__reflect(e.prototype,"egret3d.RimlightMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this)||this;return r&&(i.materialData=r),i.vsShaderList[t.ShaderPhaseType.local_vertex]=i.vsShaderList[t.ShaderPhaseType.local_vertex]||[],i.vsShaderList[t.ShaderPhaseType.local_vertex].push("shadowMapping_vs"),i.fsShaderList[t.ShaderPhaseType.shadow_fragment]=i.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],i.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("shadowMapping_fs"),i}return __extends(r,e),Object.defineProperty(r.prototype,"shadowMapTexture",{get:function(){return this.materialData.shadowMapTexture},set:function(t){this.materialData.shadowMapTexture!=t&&(this.materialData.shadowMapTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o,s){r.uniform_ShadowMatrix&&(r.uniform_ShadowMatrix.uniformIndex=a.getUniformLocation(r.program3D,"uniform_ShadowMatrix"))
},r.prototype.activeState=function(e,r,i,a,n,o,s,l){var h=l.renderDictionary[t.PassType.shadowPass].camera;h&&i.uniform_ShadowMatrix&&i.uniform_ShadowMatrix.uniformIndex&&n.uniformMatrix4fv(i.uniform_ShadowMatrix.uniformIndex,!1,h.viewProjectionMatrix.rawData),n.uniform4fv(i.uniform_ShadowColor.uniformIndex,this.materialData.shadowColor)},r}(t.MethodBase);t.ShadowMethod=e,__reflect(e.prototype,"egret3d.ShadowMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvRoll=new Float32Array(3),r._speedU=1e-4,r._speedV=1e-4,r._intensity=.9,r._time=0,r._start=!1,r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],r.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvStreamerRoll_fs"),r.start(),r}return __extends(r,e),Object.defineProperty(r.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"steamerTexture",{get:function(){return this._steamerTexture},set:function(t){this._steamerTexture=t,this.materialData.streamerTexture=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.upload=function(t,e,r,i,a,n,o){r.uvRoll=a.getUniformLocation(r.program3D,"uvRoll")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),this._uvRoll[0]=this._time*this._speedU,this._uvRoll[1]=this._time*this._speedV,this._uvRoll[2]=this._intensity,a.uniform1fv(r.uvRoll,this._uvRoll)},r}(t.MethodBase);t.StreamerMethod=e,__reflect(e.prototype,"egret3d.StreamerMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n,o){void 0===r&&(r=t.CheckerboardTexture.texture),void 0===i&&(i=t.CheckerboardTexture.texture),void 0===a&&(a=t.CheckerboardTexture.texture),void 0===n&&(n=t.CheckerboardTexture.texture),void 0===o&&(o=t.CheckerboardTexture.texture);var s=e.call(this)||this;return s.uvs=new Float32Array(8),s.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=s.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],s.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("terrainRGBA_fragment"),s.controlTex=r,s.splat_0=i,s.splat_1=a,s.splat_2=n,s.splat_3=o,s.uvs[0]=1,s.uvs[1]=1,s.uvs[2]=1,s.uvs[3]=1,s.uvs[4]=1,s.uvs[5]=1,s.uvs[6]=1,s.uvs[7]=1,s}return __extends(r,e),r.prototype.setUVTitling=function(t,e,r){this.uvs[2*t]=e,this.uvs[2*t+1]=r},Object.defineProperty(r.prototype,"splat_0_Texture",{set:function(t){this.splat_0=t,this.materialData.splat_0Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"splat_1_Texture",{set:function(t){this.splat_1=t,this.materialData.splat_1Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"splat_2_Texture",{set:function(t){this.splat_2=t,this.materialData.splat_2Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"splat_3_Texture",{set:function(t){this.splat_3=t,this.materialData.splat_3Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"controlTexture",{set:function(t){this.controlTex=t,this.materialData.blendMaskTexture=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uvs=a.getUniformLocation(r.program3D,"uvs")},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform1fv(r.uvs,this.uvs)},r.prototype.dispose=function(){},r}(t.MethodBase);t.TerrainARGBMethod=e,__reflect(e.prototype,"egret3d.TerrainARGBMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvRoll=new Float32Array(2),r._speedU=5e-5,r._speedV=0,r._time=0,r._start=!1,r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=r.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],r.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvRoll_fs"),r}return __extends(r,e),Object.defineProperty(r.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:!0,configurable:!0}),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.upload=function(t,e,r,i,a,n,o){r.uvRoll=a.getUniformLocation(r.program3D,"uvRoll")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),this._uvRoll[0]=this._time*this._speedU,this._uvRoll[1]=this._time*this._speedV,a.uniform1fv(r.uvRoll,this._uvRoll)},r}(t.MethodBase);t.UVRollMethod=e,__reflect(e.prototype,"egret3d.UVRollMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n){var o=e.call(this)||this;return o._uvSpriteSheet=new Float32Array(4),o._uvRectangle=new t.Rectangle,o._speed=0,o._time=0,o._numTime=.4,o._start=!1,o._frameNum=12,o._row=4,o._column=4,o._currentFrame=0,o.frameList=[],o._change=!0,o._delayTime=0,o._isLoop=!0,o._currentDelay=0,o.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=o.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],o.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvSpriteSheet_fs"),o.frameNum=r,o.row=i,o.column=a,o.numTime=n,o}return __extends(r,e),r.prototype.caculate=function(){this._change=!1,this._speed=1e3*this._numTime/this._frameNum,this._uvRectangle.x=0,this._uvRectangle.y=0,this._uvRectangle.width=1/this._row,this._uvRectangle.height=1/this._column,this.frameList.length=this._frameNum;for(var e=0,r=0,i=0;i<this._frameNum;i++){e=i%this._row,r=Math.floor(i/this._column);var a=new t.Rectangle;a.x=e*this._uvRectangle.width+this._uvRectangle.x,a.y=r*this._uvRectangle.height+this._uvRectangle.y,a.width=this._uvRectangle.width,a.height=this._uvRectangle.height,this.frameList[i]=a}},Object.defineProperty(r.prototype,"numTime",{get:function(){return this._numTime},set:function(t){this._numTime!=t&&(this._change=!0,this._numTime=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"frameNum",{get:function(){return this._frameNum},set:function(t){this._frameNum!=t&&(this._change=!0,this._frameNum=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"row",{get:function(){return this._row},set:function(t){this._row!=t&&(this._change=!0,this._row=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"column",{get:function(){return this._column},set:function(t){this._column!=t&&(this._change=!0,this._column=t)},enumerable:!0,configurable:!0}),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0,this._currentDelay=0,this._currentFrame=0),this._start=!0},r.prototype.stop=function(){this._start=!1},Object.defineProperty(r.prototype,"delayTime",{get:function(){return this._delayTime/1e3},set:function(t){this._delayTime!=t&&(this._change=!0,this._delayTime=1e3*t,this._currentDelay=0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLoop",{get:function(){return this._isLoop},set:function(t){this._isLoop!=t&&(this._change=!0,this._isLoop=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentFrame",{get:function(){return this._currentFrame},set:function(t){this._currentFrame=t},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uvSpriteSheet=a.getUniformLocation(r.program3D,"uvSpriteSheet")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._change&&this.caculate(),this._start&&(this._currentDelay+=e,this._currentDelay>=this._delayTime&&(this._time+=e,this._time/this._speed>1&&(this._currentFrame+1>=this._frameNum?this._isLoop?this._currentFrame=0:this._start=!1:this._currentFrame++,this._time=0))),this._currentFrame=this._currentFrame%this._frameNum,this._uvSpriteSheet[0]=this.frameList[this._currentFrame].x,this._uvSpriteSheet[1]=this.frameList[this._currentFrame].y,this._uvSpriteSheet[2]=this.frameList[this._currentFrame].width,this._uvSpriteSheet[3]=this.frameList[this._currentFrame].height,a.uniform1fv(r.uvSpriteSheet,this._uvSpriteSheet)},r}(t.MethodBase);t.UVSpriteSheetMethod=e,__reflect(e.prototype,"egret3d.UVSpriteSheetMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvData=new Float32Array(8),r._horizonColor=new Float32Array(4),r._time=0,r._start=!1,r._distion_intensity=new t.Point(.02,.02),r.fsShaderList[t.ShaderPhaseType.normal_fragment]=r.fsShaderList[t.ShaderPhaseType.normal_fragment]||[],r.fsShaderList[t.ShaderPhaseType.normal_fragment].push("waterBump_fs"),r.start(),r._horizonColor[0]=217/255,r._horizonColor[1]=235/255,r._horizonColor[2]=1,r._horizonColor[3]=1,r._uvData[0]=2.5*-5e-6,r._uvData[1]=0,r._uvData[2]=25e-6,r._uvData[3]=0,r._uvData[4]=r._distion_intensity.x,r._uvData[5]=r._distion_intensity.y,r._uvData[6]=1,r._uvData[7]=1,r}return __extends(r,e),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.setUvSpeed=function(t,e,r){switch(t){case 0:this._uvData[0]=e,this._uvData[1]=r;break;case 1:this._uvData[2]=e,this._uvData[3]=r}},r.prototype.setUvScale=function(t,e){},Object.defineProperty(r.prototype,"bumpTexture",{set:function(t){this._bumpTexture=t,this.materialData.bumpTexture!=this._bumpTexture&&(this.materialData.bumpTexture=this._bumpTexture,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"colorTexture",{set:function(t){this._colorControlTexture=t,this.materialData.colorControlTexture!=this._colorControlTexture&&(this.materialData.colorControlTexture=this._colorControlTexture,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.waterNormalData=a.getUniformLocation(r.program3D,"waterNormalData"),r.horizonColor=a.getUniformLocation(r.program3D,"horizonColor"),r.time=a.getUniformLocation(r.program3D,"time")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),a.uniform4fv(r.horizonColor,this._horizonColor),a.uniform2fv(r.waterNormalData,this._uvData),a.uniform1f(r.time,this._time)},r}(t.MethodBase);t.WaterBumpMethod=e,__reflect(e.prototype,"egret3d.WaterBumpMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvData=new Float32Array(8),r._time=0,r._start=!1,r._speedU_0=new t.Point(-5e-6,0),r._speedU_1=new t.Point(1e-5,0),r._distion_intensity=new t.Point(.02,.02),r._normal_0_UVScale=2,r._normal_1_UVScale=2,r.fsShaderList[t.ShaderPhaseType.normal_fragment]=r.fsShaderList[t.ShaderPhaseType.normal_fragment]||[],r.fsShaderList[t.ShaderPhaseType.normal_fragment].push("waterNormal_fs"),r.start(),r._uvData[0]=2.5*r._speedU_0.x,r._uvData[1]=2.5*r._speedU_0.y,r._uvData[2]=2.5*r._speedU_1.x,r._uvData[3]=2.5*r._speedU_1.y,r._uvData[4]=r._distion_intensity.x,r._uvData[5]=r._distion_intensity.y,r._uvData[6]=r._normal_0_UVScale,r._uvData[7]=r._normal_1_UVScale,r}return __extends(r,e),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.setUvSpeed=function(t,e,r){switch(t){case 0:this._speedU_0.x=e,this._speedU_0.y=r,this._uvData[0]=2.5*this._speedU_0.x,this._uvData[1]=2.5*this._speedU_0.y;break;case 1:this._speedU_1.x=e,this._speedU_1.y=r,this._uvData[2]=2.5*this._speedU_1.x,this._uvData[3]=2.5*this._speedU_1.y}},r.prototype.setUvScale=function(t,e){this._normal_0_UVScale=t,this._normal_1_UVScale=e,this._uvData[6]=this._normal_0_UVScale,this._uvData[7]=this._normal_1_UVScale},Object.defineProperty(r.prototype,"normalTextureA",{set:function(t){this._normalTexture_0=t,this.materialData.normalTextureA!=this._normalTexture_0&&(this.materialData.normalTextureA=this._normalTexture_0,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"normalTextureB",{set:function(t){this._normalTexture_1=t,this.materialData.normalTextureB!=this._normalTexture_1&&(this.materialData.normalTextureB=this._normalTexture_1,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.waterNormalData=a.getUniformLocation(r.program3D,"waterNormalData"),r.time=a.getUniformLocation(r.program3D,"time")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),a.uniform2fv(r.waterNormalData,this._uvData),a.uniform1f(r.time,this._time)},r}(t.MethodBase);t.WaterNormalMethod=e,__reflect(e.prototype,"egret3d.WaterNormalMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._waveVSData=new Float32Array(12),r._waveFSData=new Float32Array(8),r._time=0,r._start=!1,r._wave_xyz_intensity_0=new t.Vector3D(120,50,70),r._wave_xyz_intensity_1=new t.Vector3D(80,40,80),r._wave_xyz_speed_0=new t.Vector3D(.001,.001,-.001),r._wave_xyz_speed_1=new t.Vector3D(.001,.001,.001),r.vsShaderList[t.ShaderPhaseType.start_vertex]=r.vsShaderList[t.ShaderPhaseType.start_vertex]||[],r.vsShaderList[t.ShaderPhaseType.start_vertex].push("wave_vs"),r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=r.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],r.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("wave_fs"),r.start(),r._waveVSData[0]=r._wave_xyz_intensity_0.x,r._waveVSData[1]=r._wave_xyz_intensity_0.y,r._waveVSData[2]=r._wave_xyz_intensity_0.z,r._waveVSData[3]=r._wave_xyz_intensity_1.x,r._waveVSData[4]=r._wave_xyz_intensity_1.y,r._waveVSData[5]=r._wave_xyz_intensity_1.z,r._waveVSData[6]=r._wave_xyz_speed_0.x,r._waveVSData[7]=r._wave_xyz_speed_0.y,r._waveVSData[8]=r._wave_xyz_speed_0.z,r._waveVSData[9]=r._wave_xyz_speed_1.x,r._waveVSData[10]=r._wave_xyz_speed_1.y,r._waveVSData[11]=r._wave_xyz_speed_1.z,r._waveFSData[0]=0,r._waveFSData[1]=63/255,r._waveFSData[2]=77/255,r._waveFSData[3]=1,r._waveFSData[4]=71/255,r._waveFSData[5]=118/255,r._waveFSData[6]=138/255,r._waveFSData[7]=1,r}return __extends(r,e),Object.defineProperty(r.prototype,"deepWaterColor",{get:function(){var t=255*this._waveFSData[0],e=255*this._waveFSData[1],r=255*this._waveFSData[2],i=255*this._waveFSData[3];return i<<24|t<<16|e<<8|r},set:function(t){var e=t>>24&255,r=t>>16&255,i=t>>8&255,a=255&t;this._waveFSData[0]=r/255,this._waveFSData[1]=i/255,this._waveFSData[2]=a/255,this._waveFSData[3]=e/255},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shallowWaterColor",{get:function(){var t=255*this._waveFSData[4],e=255*this._waveFSData[5],r=255*this._waveFSData[6],i=255*this._waveFSData[7];return i<<24|t<<16|e<<8|r},set:function(t){var e=t>>24&255,r=t>>16&255,i=t>>8&255,a=255&t;this._waveFSData[4]=r/255,this._waveFSData[5]=i/255,this._waveFSData[6]=a/255,this._waveFSData[7]=e/255},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"waveTexture",{set:function(t){this._waveTexture=t,t&&this.materialData.waveTexture!=this._waveTexture&&(this.materialData.waveTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.upload=function(t,e,r,i,a,n,o){r.waveVSData=a.getUniformLocation(r.program3D,"waveVSData"),r.waveFSData=a.getUniformLocation(r.program3D,"waveFSData"),r.time=a.getUniformLocation(r.program3D,"time")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),a.uniform3fv(r.waveVSData,this._waveVSData),a.uniform4fv(r.waveFSData,this._waveFSData),a.uniform1f(r.time,this._time)},r}(t.MethodBase);t.WaterWaveMethod=e,__reflect(e.prototype,"egret3d.WaterWaveMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._speed=new t.Vector3D,r._time=0,r._windData=new Float32Array(4),r.vsShaderList[t.ShaderPhaseType.local_vertex]=r.vsShaderList[t.ShaderPhaseType.local_vertex]||[],r.vsShaderList[t.ShaderPhaseType.local_vertex].push("detail_Bending_vs"),r}return __extends(r,e),Object.defineProperty(r.prototype,"windDirAndSpeed",{get:function(){return this._speed},set:function(t){this._speed=t,this._windData[1]=t.x,this._windData[2]=t.y,this._windData[3]=t.z},enumerable:!0,configurable:!0}),r.prototype.upload=function(t,e,r,i,a,n,o){r.uniformTime=a.getUniformLocation(r.program3D,"uniformTime")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._time+=e,this._windData[0]=this._time,a.uniform1fv(r.uniformTime,this._windData)},r}(t.MethodBase);t.PlantDistortedMethod=e,__reflect(e.prototype,"egret3d.PlantDistortedMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.colorPass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1,this._passUsage=new t.PassUsage,this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")),this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("colorPassEnd_fs"),this.phaseEnd(e)},r}(t.MaterialPass);t.ColorPass=e,__reflect(e.prototype,"egret3d.ColorPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.diffusePass,i}return __extends(r,e),r.prototype.initUseMethod=function(t,r){e.prototype.initUseMethod.call(this,t,r)},r}(t.MaterialPass);t.DiffusePass=e,__reflect(e.prototype,"egret3d.DiffusePass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.diffusePass,i}return __extends(r,e),r.prototype.setTexture=function(t,e){this._materialData[t]=e},r.prototype.initUseMethod=function(e,r){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},this.lightGroup&&(this._passUsage.maxDirectLight=this.lightGroup.directLightList.length,this._passUsage.maxSpotLight=this.lightGroup.spotLightList.length,this._passUsage.maxPointLight=this.lightGroup.pointLightList.length,this.lightGroup.directLightList.length&&(this._passUsage.directLightData=new Float32Array(t.DirectLight.stride*this.lightGroup.directLightList.length))),this.addMethodShaders(this._passUsage.vertexShader,["FakePBR_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),this.addMethodShaders(this._passUsage.fragmentShader,["FakePBR_fs"])},r}(t.MaterialPass);t.FakePBRPass=e,__reflect(e.prototype,"egret3d.FakePBRPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.CubePass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),this._materialData.acceptShadow&&(this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[],this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]||[]),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.specular_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.specular_fragment].push("specularMap_fragment")),this._vs_shader_methods[t.ShaderPhaseType.end_vertex]=this._vs_shader_methods[t.ShaderPhaseType.end_vertex]||[],this._vs_shader_methods[t.ShaderPhaseType.end_vertex].push("positionEndPass_vs"),this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("Gbuffer"),this.initOthreMethods(),this.phaseEnd(e)},r}(t.MaterialPass);t.GbufferPass=e,__reflect(e.prototype,"egret3d.GbufferPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.matCapPass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e&&e.skeletonAnimationController&&(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")),this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment"),this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment].push("matCap_TextureAdd_fs"),this._materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1!=this._materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment"));var i;this.addMethodShaders(this._passUsage.vertexShader,["base_vs","tangent_vs"]),i=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],i&&i.length>0?this.addMethodShaders(this._passUsage.vertexShader,i):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vertex"]),i=this._vs_shader_methods[t.ShaderPhaseType.local_vertex],i&&i.length>0&&this.addMethodShaders(this._passUsage.vertexShader,i),this.addMethodShaders(this._passUsage.vertexShader,["end_vs"]),this.addMethodShaders(this._passUsage.vertexShader,["out_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),i=this._fs_shader_methods[t.ShaderPhaseType.materialsource_fragment],i&&i.length>0?this.addMethodShaders(this._passUsage.fragmentShader,i):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),i=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment],i&&i.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,i),i=this._fs_shader_methods[t.ShaderPhaseType.normal_fragment],i&&i.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,i),i=this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment],i&&i.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,i),this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"]),this.addMethodShaders(this._passUsage.fragmentShader,["out_fs"])},r}(t.MaterialPass);t.MatCapPass=e,__reflect(e.prototype,"egret3d.MatCapPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.ShaderType=e,__reflect(e.prototype,"egret3d.ShaderType");var r;!function(t){t[t.uniform1f=0]="uniform1f",t[t.uniform1fv=1]="uniform1fv",t[t.uniform1i=2]="uniform1i",t[t.uniform1iv=3]="uniform1iv",t[t.uniform2f=4]="uniform2f",t[t.uniform2fv=5]="uniform2fv",t[t.uniform2i=6]="uniform2i",t[t.uniform2iv=7]="uniform2iv",t[t.uniform3f=8]="uniform3f",t[t.uniform3fv=9]="uniform3fv",t[t.uniform3i=10]="uniform3i",t[t.uniform3iv=11]="uniform3iv",t[t.uniform4f=12]="uniform4f",t[t.uniform4fv=13]="uniform4fv",t[t.uniform4i=14]="uniform4i",t[t.uniform4iv=15]="uniform4iv",t[t.uniformMatrix2fv=16]="uniformMatrix2fv",t[t.uniformMatrix3fv=17]="uniformMatrix3fv",t[t.uniformMatrix4fv=18]="uniformMatrix4fv"}(r=t.UniformType||(t.UniformType={}));var i;!function(t){t[t.PixelArray=0]="PixelArray",t[t.CompressData=1]="CompressData",t[t.ImageData=2]="ImageData"}(i=t.InternalFormat||(t.InternalFormat={}));var a;!function(t){t[t.shadowFrameBufrfer=0]="shadowFrameBufrfer",t[t.defaultFrameBuffer=1]="defaultFrameBuffer",t[t.positionFrameBuffer=2]="positionFrameBuffer",t[t.normalFrameBuffer=3]="normalFrameBuffer",t[t.specularFrameBuffer=4]="specularFrameBuffer",t[t.leftEyeFrameBuffer=5]="leftEyeFrameBuffer",t[t.rightEyeFrameBuffer=6]="rightEyeFrameBuffer",t[t.nextFrameBuffer=7]="nextFrameBuffer"}(a=t.FrameBufferType||(t.FrameBufferType={}));var n;!function(t){t[t.FLOAT_RGB=0]="FLOAT_RGB",t[t.FLOAT_RGBA=1]="FLOAT_RGBA",t[t.UNSIGNED_BYTE_RGB=2]="UNSIGNED_BYTE_RGB",t[t.UNSIGNED_BYTE_RGBA=3]="UNSIGNED_BYTE_RGBA"}(n=t.FrameBufferFormat||(t.FrameBufferFormat={}));var o;!function(t){t[t.ALPHA=0]="ALPHA",t[t.LAYER=1]="LAYER",t[t.NORMAL=2]="NORMAL",t[t.MULTIPLY=3]="MULTIPLY",t[t.ADD=4]="ADD",t[t.SUB=5]="SUB",t[t.DIV=6]="DIV",t[t.SCREEN=7]="SCREEN",t[t.SOFT_ADD=8]="SOFT_ADD"}(o=t.BlendMode||(t.BlendMode={}));var s=function(){function t(){}return t}();t.ContextSamplerType=s,__reflect(s.prototype,"egret3d.ContextSamplerType");var l=function(){function t(){}return t}();t.DrawMode=l,__reflect(l.prototype,"egret3d.DrawMode");var h=function(){function t(){}return t}();h.Direct3D_Opengl_Auto="Direct3D_Opengl_Auto",h.Direct3D_9_0="Direct3D_9_0",h.Direct3D_10_0="Direct3D_10_0",h.Direct3D_11_0="Direct3D_11_0",h.OpenGLES_2_0="OpenGLES_2_0",h.OpenGLES_3_0="OpenGLES_3_0",h.OpenGL="OpenGL",h.ColorFormat_DXT1_RGB=0,h.ColorFormat_DXT1_RGBA=0,h.ColorFormat_DXT3_RGBA=0,h.ColorFormat_DXT5_RGBA=0,t.ContextConfig=h,__reflect(h.prototype,"egret3d.ContextConfig")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.CubePass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1,this._passUsage=new t.PassUsage,this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")),this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("normalPassEnd_fs"),this.phaseEnd(e)},r}(t.MaterialPass);t.NormalPass=e,__reflect(e.prototype,"egret3d.NormalPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this,null)||this;return r.outline=new Float32Array(5),r._passID=t.PassType.colorPass,r.outline[0]=.2,r.outline[1]=1,r.outline[2]=0,r.outline[3]=0,r.outline[4]=1,r}return __extends(r,e),Object.defineProperty(r.prototype,"outLineColor",{get:function(){return t.Color.RGBAToColor(this.outline[1],this.outline[2],this.outline[3],this.outline[4])},set:function(e){var r=t.Color.getColor(e);this.outline[1]=r.x,this.outline[2]=r.y,this.outline[3]=r.z,this.outline[4]=r.w},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"outLineSize",{get:function(){return this.outline[0]},set:function(t){this.outline[0]=t},enumerable:!0,configurable:!0}),r.prototype.initUseMethod=function(e,r){this._passChange=!1,this._passUsage=new t.PassUsage,this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[],this._vs_shader_methods[t.ShaderPhaseType.global_vertex].push("outLine_vs"),this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("outLine_fs"),this.phaseEnd(e)},r.prototype.upload=function(t,r,i,a,n,o,s,l){e.prototype.upload.call(this,t,r,i,a,n,o,s,l)},r.prototype.draw=function(e,r,i,a,n,o,s,l){if(this.enable){if(this._passChange&&this.upload(e,r,i,a,n,s.animation,o.geometry,l),i.setProgram(this._passUsage.program3D),o.activeState(e,r,this._passUsage,i),t.Context3DProxy.gl.depthMask(!1),this._passUsage.uniform_materialSource&&i.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData),this._passUsage.uniform_ModelMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,!1,a.rawData),this._passUsage.uniform_ViewMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,!1,n.viewMatrix.rawData),this._passUsage.uniform_ProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,n.projectMatrix.rawData),this._passUsage.uniform_ViewProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,n.viewProjectionMatrix.rawData),this._passUsage.uniform_orthProjectMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_orthProjectMatrix.uniformIndex,!1,n.orthProjectionMatrix.rawData),this._passUsage.uniform_ouline&&i.uniform1fv(this._passUsage.uniform_ouline.uniformIndex,this.outline),s.animation&&s.animation.activeState(e,r,this._passUsage,o,i,a,n),this.methodList)for(var h=0;h<this.methodList.length;h++)this.methodList[h].activeState(e,r,this._passUsage,null,i,a,n,l);
this._passUsage.uniform_eyepos&&i.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,n.x,n.y,n.z),this._passUsage.uniform_cameraMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,!1,n.modelMatrix.rawData),i.drawElement(this._materialData.drawMode,o.start,o.count),t.Context3DProxy.gl.depthMask(!0)}},r}(t.MaterialPass);t.OutLinePass=e,__reflect(e.prototype,"egret3d.OutLinePass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.sampler2DList=new Array,this.sampler3DList=new Array,this.vertexShader=new t.ShaderBase(t.Shader.vertex),this.fragmentShader=new t.ShaderBase(t.Shader.fragment),this.maxDirectLight=0,this.maxSpotLight=0,this.maxPointLight=0,this.maxBone=0,this.attributeDiry=!0}return e.prototype.dispose=function(){this.program3D&&this.program3D.dispose(),this.program3D=null,this.vertexShader&&this.vertexShader.shader&&this.vertexShader.shader.dispose(),this.vertexShader=null,this.fragmentShader&&this.fragmentShader.shader&&this.fragmentShader.shader.dispose(),this.fragmentShader=null},e}();t.PassUsage=e,__reflect(e.prototype,"egret3d.PassUsage")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.diffusePass=0]="diffusePass",t[t.colorPass=1]="colorPass",t[t.normalPass=2]="normalPass",t[t.shadowPass=3]="shadowPass",t[t.lightPass=4]="lightPass",t[t.matCapPass=5]="matCapPass",t[t.depthPass_8=6]="depthPass_8",t[t.depthPass_32=7]="depthPass_32",t[t.CubePass=8]="CubePass",t[t.Gbuffer=9]="Gbuffer",t[t.PickPass=10]="PickPass",t[t.OutLinePass=11]="OutLinePass",t[t.position=12]="position"}(e=t.PassType||(t.PassType={}));var r=function(){function r(){}return r.CreatPass=function(r,i){switch(r){case e.colorPass:return i.shaderPhaseTypes[e.colorPass]=[],[new t.ColorPass(i)];case e.diffusePass:return i.shaderPhaseTypes[e.diffusePass]=[],[new t.DiffusePass(i)];case e.shadowPass:return i.shaderPhaseTypes[e.shadowPass]=[],[new t.ShadowPass(i)];case e.depthPass_8:return i.shaderPhaseTypes[e.depthPass_8]=[],[new t.PositionPass(i)];case e.normalPass:return i.shaderPhaseTypes[e.normalPass]=[],[new t.NormalPass(i)];case e.Gbuffer:return i.shaderPhaseTypes[e.Gbuffer]=[],[new t.GbufferPass(i)];case e.PickPass:return i.shaderPhaseTypes[e.PickPass]=[],[new t.PickPass(i)];case e.OutLinePass:return i.shaderPhaseTypes[e.OutLinePass]=[],[new t.OutLinePass]}return null},r}();r.PassAuto=[!0,!0,!0,!1,!1,!0,!0,!0,!0,!0,!1,!0,!0],t.PassUtil=r,__reflect(r.prototype,"egret3d.PassUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.PickPass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e?e.skeletonAnimationController&&(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this.addMethodShaders(this._passUsage.vertexShader,["pickPass_skeleton_vs"])):this.addMethodShaders(this._passUsage.vertexShader,["pickPass_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["pickPass_fs"])},r}(t.MaterialPass);t.PickPass=e,__reflect(e.prototype,"egret3d.PickPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.CubePass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1,this._passUsage=new t.PassUsage,this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),this._vs_shader_methods[t.ShaderPhaseType.end_vertex]=this._vs_shader_methods[t.ShaderPhaseType.end_vertex]||[],this._vs_shader_methods[t.ShaderPhaseType.end_vertex].push("positionEndPass_vs"),this._fs_shader_methods[t.ShaderPhaseType.end_fragment]=this._fs_shader_methods[t.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[t.ShaderPhaseType.end_fragment].push("positionEndPass_fs"),this.phaseEnd(e)},r}(t.MaterialPass);t.PositionPass=e,__reflect(e.prototype,"egret3d.PositionPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this,r)||this;return i._passID=t.PassType.shadowPass,i}return __extends(r,e),r.prototype.initUseMethod=function(e,r){this._passChange=!1;if(this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e){if(e.skeletonAnimationController)this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_skeleton_vs"]);else if(e.particleAnimationController){this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]);var i;i=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],i&&i.length>0&&this.addMethodShaders(this._passUsage.vertexShader,i),i=this._vs_shader_methods[t.ShaderPhaseType.local_vertex],i&&i.length>0&&this.addMethodShaders(this._passUsage.vertexShader,i),i=this._vs_shader_methods[t.ShaderPhaseType.global_vertex],i&&i.length>0&&this.addMethodShaders(this._passUsage.vertexShader,i),i=this._vs_shader_methods[t.ShaderPhaseType.end_vertex],i&&i.length>0&&this.addMethodShaders(this._passUsage.vertexShader,i)}}else this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_vs"]);this.addMethodShaders(this._passUsage.fragmentShader,["shadowPass_fs"])},r}(t.MaterialPass);t.ShadowPass=e,__reflect(e.prototype,"egret3d.ShadowPass")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r._animations=[],r._proAnimations=[],r._animCount=0,r._loopTime=1,r._animTime=0,r._speed=1,r._noLoopAnims=[],r.liveTime=-1,r.isOriginal=!0,r._event3D=new t.AnimationEvent3D,r._lastAnimTime=0,r}return __extends(r,e),r.prototype.init=function(t){void 0===t&&(t=!1),this._animations=[],this._loop=t,this.collectAnimations(this,this._animations),this._timeOffset=[],this._animCount=this._timeOffset.length=this._animations.length;for(var e=0;e<this._animCount;e++)this._timeOffset[e]=0},r.prototype.collectAnimations=function(e,r){var i,a;e instanceof t.Mesh&&(i=e,a=i.animation,a&&(r.push(a),a.isLoop||this._noLoopAnims.push(a))),e.proAnimation&&(this._proAnimations.push(e.proAnimation),e.proAnimation.isLoop||this._noLoopAnims.push(e.proAnimation));for(var n=e.childs.length,o=0;n>o;o++)this.collectAnimations(e.childs[o],r);if(this._loop)for(var s=0,l=this._noLoopAnims;s<l.length;s++)a=l[s],this._loopTime=Math.max(this._loopTime,1e3*a.loopTime)},r.prototype.play=function(t,e,r){t=t||1,e=e||!1,r=r||!1;for(var i=0;i<this._animCount;i++){var a=this._animations[i];a.play("",t,e,r)}for(var i=0;i<this._proAnimations.length;i++){var a=this._proAnimations[i];a.play("",t,e,r)}this._isPlay=!0,this._prewarm=r,this._speed=t,e&&(this._animTime=0)},r.prototype.resetTime=function(t){void 0===t&&(t=0);for(var e;e<this._animCount;e++){var r=this._animations[e];r.animTime=this._timeOffset[e]+t}for(var e;e<this._proAnimations.length;e++){var r=this._proAnimations[e];r.animTime=this._timeOffset[e]+t}},Object.defineProperty(r.prototype,"speed",{get:function(){return this._speed},set:function(t){1e-7>t&&(t=1e-7),this._speed=t},enumerable:!0,configurable:!0}),r.prototype.stop=function(){for(var t=0;t<this._animCount;t++)this._animations[t].stop();for(var t=0;t<this._proAnimations.length;t++){var e=this._proAnimations[t];e.stop()}this._isPlay=!1},r.prototype.isPlay=function(){return this._isPlay},r.prototype.update=function(r,i,a){if(e.prototype.update.call(this,r,i,a),this._loop&&this._animTime>this._loopTime){this._animTime-=this._loopTime;for(var n,o=0,s=this._noLoopAnims;o<s.length;o++)n=s[o],n.play("",this._speed,!0,this._prewarm)}if(this._animTime+=this._speed*i,!this._loop){var l=1e3*this._loopTime;this._lastAnimTime<=l&&this._animTime>l&&(this._event3D.eventType=t.AnimationEvent3D.COMPLETE,this._event3D.target=this,this.dispatchEvent(this._event3D))}this._lastAnimTime=this._animTime},r.prototype.dispose=function(){this.stop(),this._animations&&(this._animations.length=0,delete this._animations),this._noLoopAnims&&(this._noLoopAnims.length=0,delete this._noLoopAnims)},r.prototype.copy=function(t){e.prototype.copy.call(this,t)},r.prototype.clone=function(){var t=new r;return t.copy(this),t},r.prototype.deepClone=function(){var t=e.prototype.deepClone.call(this);return t.init(this._loop),t},r}(t.Object3D);t.EffectGroup=e,__reflect(e.prototype,"egret3d.EffectGroup")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this)||this;return i.animTime=0,i._event3D=new t.AnimationEvent3D,i._lastAnimTime=0,i.delay=0,i.loopTime=0,i.speed=1,i._play=!1,i.animStates=[],i.particleAnimationState=new t.ParticleAnimationState("particle",r),i.addAnimState(i.particleAnimationState),i}return __extends(r,e),r.prototype.update=function(e,i,a){if(r.Reset&&(this.animTime=0),this._play&&0!=this.speed){if(this.animTime+=i*this.speed,this.particleAnimationState.update(this.animTime,i,a),0==this.isLoop){var n=1e3*this.loopTime;this._lastAnimTime<=n&&this.animTime>n&&(this._event3D.eventType=t.AnimationEvent3D.COMPLETE,this._event3D.target=this,this.dispatchEvent(this._event3D))}this._lastAnimTime=this.animTime}},r.prototype.activeState=function(t,e,r,i,a,n,o){this.particleAnimationState&&this.particleAnimationState.activeState(t,this.animTime,e,e,r,i,a,o)},r.prototype.play=function(t,e,r,i){void 0===e&&(e=1),void 0===r&&(r=!0),void 0===i&&(i=!0),this._play=!0,r&&(this.animTime=0),i&&(this.animTime=this.particleAnimationState.modTime),(i||r)&&this.particleAnimationState.onAnimTimeChange(),this.speed=e},r.prototype.stop=function(){this._play=!1},r.prototype.isPlay=function(){return this._play},r.prototype.addAnimState=function(t){var e=this.animStates.indexOf(t);-1==e&&this.animStates.push(t)},r.prototype.removeAnimState=function(t){var e=this.animStates.indexOf(t);-1!=e&&this.animStates.splice(e,1)},r.prototype.getAnimList=function(){return[]},r.prototype.getAnimNode=function(){return[]},r.prototype.clone=function(){return null},r}(t.EventDispatcher);t.ParticleAnimation=e,__reflect(e.prototype,"egret3d.ParticleAnimation",["egret3d.IAnimation"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e){this.numberOfVertices=0,this.vertexSizeInBytes=0,this.vertex_shaders={},this.fragment_shaders={},this.modTime=0,this.reverse=1,this.followTarget=null,this._particleProperty=new Float32Array(27),this._emitter=e,this.name=t,this.animNodes=[],this.keyFrames=[]}return Object.defineProperty(e.prototype,"emitter",{get:function(){return this._emitter},enumerable:!0,configurable:!0}),e.prototype.addNode=function(t){t.state=this,this.animNodes.push(t)},e.prototype.removeNode=function(t){var e=this.animNodes.indexOf(t);-1!=e&&this.animNodes.splice(e,1)},e.prototype.onAnimTimeChange=function(){for(var t=0,e=this.animNodes.length;e>t;t++)this.animNodes[t].onAnimTimeChange()},e.prototype.clean=function(){this.animNodes.length=0},e.prototype.addShaderPhase=function(t,e){var r,i;for(i in t){r=t[i];for(var a=0;a<r.length;a++)e[i]=e[i]||[],e[i].push(r[a])}},e.prototype.calculate=function(t){for(var e=0;e<this.animNodes.length;e++){this.addShaderPhase(this.animNodes[e].vertex_ShaderName,this.vertex_shaders),this.addShaderPhase(this.animNodes[e].fragment_ShaderName,this.fragment_shaders);for(var r=t.vertexAttLength,i=0;i<this.animNodes[e].attributes.length;++i)this.animNodes[e].attributes[i].size>0&&(this.animNodes[e].attributes[i].offsetIndex=r,t.vertexAttLength+=this.animNodes[e].attributes[i].size,t.vertexSizeInBytes+=4*this.animNodes[e].attributes[i].size,t.subGeometrys[0].preAttList.push(this.animNodes[e].attributes[i])),r=t.vertexAttLength}},e.prototype.fill=function(t,e){for(var r=0;r<this.animNodes.length;r++)this.animNodes[r].build(t,e);for(var r=0;r<this.animNodes.length;r++)this.animNodes[r].afterBuild()},e.prototype.update=function(t,e,r){for(var i=0;i<this.animNodes.length;i++)this.animNodes[i].update(t,e,r)},e.prototype.activeState=function(e,r,i,a,n,o,s,l){var h,u,c,d=this._emitter.data;d.followTarget&&this._emitter.followTarget?(h=this._emitter.followTarget.globalScale,u=this._emitter.followTarget.globalOrientation,c=this._emitter.followTarget.globalPosition):(h=this._emitter.globalScale,u=this._emitter.globalOrientation,c=this._emitter.globalPosition);var p=this._emitter.material.materialData.blendMode==t.BlendMode.ALPHA;this._particleProperty[0]=.001*r,this._particleProperty[1]=d.life.loop?1:0,this._particleProperty[2]=d.followTarget?1:0,this._particleProperty[3]=h.x,this._particleProperty[4]=h.y,this._particleProperty[5]=h.z,this._particleProperty[6]=u.x,this._particleProperty[7]=u.y,this._particleProperty[8]=u.z,this._particleProperty[9]=u.w,this._particleProperty[10]=c.x,this._particleProperty[11]=c.y,this._particleProperty[12]=c.z,this._particleProperty[13]=this.modTime,this._particleProperty[14]=d.life.delay,this._particleProperty[15]=d.life.duration,this._particleProperty[16]=d.property.gravity,this._particleProperty[17]=d.moveSpeed.velocityOver&&d.moveSpeed.velocityOver.worldSpace?1:0,this._particleProperty[18]=d.moveSpeed.velocityForce&&d.moveSpeed.velocityForce.worldSpace?1:0,this._particleProperty[19]=d.moveSpeed.velocityLimit?d.moveSpeed.velocityLimit.dampen:0,this._particleProperty[20]=d.property.cameraScale,this._particleProperty[21]=d.property.speedScale,this._particleProperty[22]=d.property.lengthScale,this._particleProperty[23]=d.property.renderMode,this._particleProperty[24]=d.property.stayAtEnd?1:0,this._particleProperty[25]=p?1:0,this._particleProperty[26]=d.shape.type,s.uniform1fv(n.uniform_particleState.uniformIndex,this._particleProperty);for(var f=0;f<this.animNodes.length;f++)this.animNodes[f].activeState(e,r,i,a,n,o,s)},e.prototype.dispose=function(){for(var t,e=0,r=this.animNodes;e<r.length;e++)t=r[e],t.dispose();this.animNodes.length=0,this.animNodes=null,this.keyFrames.length=0,this.keyFrames=null},e}();t.ParticleAnimationState=e,__reflect(e.prototype,"egret3d.ParticleAnimationState",["egret3d.IAnimationState"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.Property=0]="Property",t[t.Emission=1]="Emission",t[t.Life=2]="Life",t[t.Shape=3]="Shape",t[t.RotationBirth=4]="RotationBirth",t[t.ScaleBirth=5]="ScaleBirth",t[t.Geometry=6]="Geometry",t[t.MoveSpeed=7]="MoveSpeed",t[t.FollowTarget=8]="FollowTarget",t[t.ScaleSize=9]="ScaleSize",t[t.RotationSpeed=10]="RotationSpeed",t[t.ColorOffset=11]="ColorOffset",t[t.TextureSheet=12]="TextureSheet"}(e=t.ParticleDataNodeType||(t.ParticleDataNodeType={}));var r;!function(t){t[t.BIRTH=0]="BIRTH",t[t.COLLISION=1]="COLLISION",t[t.DEATH=2]="DEATH"}(r=t.ParticleDataSubEmitterPhase||(t.ParticleDataSubEmitterPhase={}));var i;!function(t){t[t.Const=0]="Const",t[t.RandomConst=1]="RandomConst",t[t.OneBezier=2]="OneBezier",t[t.TwoBezier=3]="TwoBezier"}(i=t.ParticleValueType||(t.ParticleValueType={}));var a;!function(t){t[t.Billboard=0]="Billboard",t[t.StretchedBillboard=1]="StretchedBillboard",t[t.HorizontalBillboard=2]="HorizontalBillboard",t[t.VerticalBillboard=3]="VerticalBillboard",t[t.Mesh=4]="Mesh"}(a=t.ParticleRenderModeType||(t.ParticleRenderModeType={}));var n;!function(t){t[t.Const=0]="Const",t[t.RandomConst=1]="RandomConst",t[t.OneGradients=2]="OneGradients",t[t.TwoGradients=3]="TwoGradients"}(n=t.ParticleBirthColorType||(t.ParticleBirthColorType={}));var o;!function(t){t[t.Point=0]="Point",t[t.Cube=1]="Cube",t[t.Sphere=2]="Sphere",t[t.HemiSphere=3]="HemiSphere",t[t.Cone=4]="Cone",t[t.Mesh=5]="Mesh",t[t.External=6]="External"}(o=t.ParticleDataShapeType||(t.ParticleDataShapeType={}));var s;!function(t){t[t.Vertex=0]="Vertex",t[t.Triangle=1]="Triangle",t[t.Edge=2]="Edge"}(s=t.ParticleMeshShapeType||(t.ParticleMeshShapeType={}));var l;!function(t){t[t.Base=0]="Base",t[t.BaseShell=1]="BaseShell",t[t.Volume=2]="Volume",t[t.VolumeShell=3]="VolumeShell"}(l=t.ParticleConeShapeType||(t.ParticleConeShapeType={}));var h=function(){function t(){this.property=new c,this.emission=new d,this.life=new p,this.shape=new f,this.rotationBirth=new m,this.scaleBirth=new _,this.geometry=new v,this.moveSpeed=new g}return t.prototype.validate=function(){this.property.validate(),this.emission.validate(),this.life.validate(),this.shape.validate(),this.rotationBirth.validate(),this.scaleBirth.validate(),this.geometry.validate(),this.moveSpeed.validate(),this.scaleSize&&this.scaleSize.validate(),this.rotationSpeed&&this.rotationSpeed.validate(),this.colorOffset&&this.colorOffset.validate(),this.followTarget&&this.followTarget.validate(),this.textureSheet&&this.textureSheet.validate()},t}();t.ParticleData=h,__reflect(h.prototype,"egret3d.ParticleData");var u=function(){function t(t){this._nodeType=t}return Object.defineProperty(t.prototype,"nodeType",{get:function(){return this._nodeType},enumerable:!0,configurable:!0}),t}();t.ParticleDataNode=u,__reflect(u.prototype,"egret3d.ParticleDataNode");var c=function(r){function i(){var i=r.call(this,e.Property)||this;return i.particleCount=10,i.bounds=new t.Vector3D(10,10,10),i.colorType=n.Const,i.colorConst1=new t.Color(255,255,255,255),i.colorConst2=new t.Color(255,255,255,255),i.gravity=0,i.prewarm=!1,i.playOnAwake=!0,i.rotation=new t.Vector3D(0,0,0,1),i.scale=new t.Vector3D(1,1,1,1),i.position=new t.Vector3D(0,0,0,1),i.sortingFudge=0,i.renderMode=a.Billboard,i.cameraScale=0,i.speedScale=0,i.lengthScale=1,i}return __extends(i,r),i.prototype.validate=function(){null==this.bounds&&(this.bounds=new t.Vector3D(10,10,10)),this.bounds.x<0&&(this.bounds.x=1),this.bounds.y<0&&(this.bounds.y=1),this.bounds.z<0&&(this.bounds.z=1),this.particleCount<0&&(this.particleCount=10),null==this.colorConst1&&(this.colorConst1=new t.Color(255,255,255,255)),null==this.colorConst2&&(this.colorConst2=new t.Color(255,255,255,255)),(this.colorType==n.OneGradients||this.colorType==n.TwoGradients)&&null==this.colorGradients1&&(this.colorGradients1=new t.ColorGradients),this.colorType==n.TwoGradients&&null==this.colorGradients2&&(this.colorGradients2=new t.ColorGradients),null==this.rotation&&(this.rotation=new t.Vector3D(0,0,0,1)),null==this.scale&&(this.scale=new t.Vector3D(1,1,1,1)),null==this.position&&(this.rotation=new t.Vector3D(0,0,0,1))},i}(u);t.ParticleDataProperty=c,__reflect(c.prototype,"egret3d.ParticleDataProperty");var d=function(r){function a(){var a=r.call(this,e.Emission)||this;return a.rate=10,a.type=i.Const,a.bezier=new t.BezierData,a}return __extends(a,r),a.prototype.validate=function(){this.rate<0&&(this.rate=1e-5),this.type==i.OneBezier&&(null==this.bezier&&(this.bezier=new t.BezierData),this.bezier.validate())},a}(u);t.ParticleDataEmission=d,__reflect(d.prototype,"egret3d.ParticleDataEmission");var p=function(r){function a(){var t=r.call(this,e.Life)||this;return t.type=i.Const,t.max=0,t.min=0,t.duration=5,t.delay=0,t.loop=!0,t}return __extends(a,r),a.prototype.validate=function(){this.max<=0&&(this.max=1e-6),this.min<=0&&(this.min=1e-6),this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst,(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate()),this.delay<0&&(this.delay=0),this.duration<0&&(this.duration=5)},a}(u);t.ParticleDataLife=p,__reflect(p.prototype,"egret3d.ParticleDataLife");var f=function(t){function r(){var r=t.call(this,e.Shape)||this;return r.type=o.Point,r.randomDirection=!1,r.emitFromShell=!1,r.cubeW=0,r.cubeH=0,r.cubeD=0,r.sphereRadius=10,r.hemiSphereRadius=10,r.coneType=l.Volume,r.coneLength=10,r.coneRadius=10,r.coneAngle=30,r.meshType=s.Vertex,r}return __extends(r,t),r.prototype.validate=function(){this.type==o.Cube?(this.cubeW<0&&(this.cubeW=0),this.cubeH<0&&(this.cubeH=0),this.cubeD<0&&(this.cubeD=0)):this.type==o.Sphere&&this.sphereRadius<0&&(this.sphereRadius=10)},r}(u);t.ParticleDataShape=f,__reflect(f.prototype,"egret3d.ParticleDataShape");var m=function(r){function a(){var t=r.call(this,e.RotationBirth)||this;return t.type=i.Const,t.max=0,t.min=0,t}return __extends(a,r),a.prototype.validate=function(){this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst,(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},a}(u);t.ParticleDataRotationBirth=m,__reflect(m.prototype,"egret3d.ParticleDataRotationBirth");var _=function(r){function a(){var t=r.call(this,e.ScaleBirth)||this;return t.type=i.Const,t.max=1,t.min=1,t}return __extends(a,r),a.prototype.validate=function(){this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst,(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},a}(u);t.ParticleDataScaleBirth=_,__reflect(_.prototype,"egret3d.ParticleDataScaleBirth");var v=function(t){function r(){var r=t.call(this,e.Geometry)||this;return r.planeW=10,r.planeH=10,r}return __extends(r,t),r.prototype.validate=function(){this.planeW<0&&(this.planeW=10),this.planeH<0&&(this.planeH=10)},r}(u);t.ParticleDataGeometry=v,__reflect(v.prototype,"egret3d.ParticleDataGeometry");var g=function(r){function a(){var t=r.call(this,e.MoveSpeed)||this;return t.type=i.Const,t.max=0,t.min=0,t}return __extends(a,r),a.prototype.validate=function(){this.velocityOver&&this.velocityOver.validate(),this.velocityLimit&&this.velocityLimit.validate(),this.velocityForce&&this.velocityForce.validate(),this.type==i.Const&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},a}(u);t.ParticleDataMoveSpeed=g,__reflect(g.prototype,"egret3d.ParticleDataMoveSpeed");var y=function(){function e(){this.type=i.Const,this.max=0,this.min=0,this.dampen=0,this.bezier1=new t.BezierData,this.bezier2=new t.BezierData}return e.prototype.validate=function(){this.max<0&&(this.max=0),this.min<0&&(this.min=0),this.dampen=this.dampen||0,this.type==i.Const&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},e}();t.VelocityLimitLifeTimeData=y,__reflect(y.prototype,"egret3d.VelocityLimitLifeTimeData");var x=function(){function e(){this.type=i.Const,this.max=new t.Vector3D,this.min=new t.Vector3D,this.worldSpace=!1,this.xBezier1=new t.BezierData,this.yBezier1=new t.BezierData,this.zBezier1=new t.BezierData,this.xBezier2=new t.BezierData,this.yBezier2=new t.BezierData,this.zBezier2=new t.BezierData}return e.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.xBezier1&&(this.xBezier1=new t.BezierData),null==this.yBezier1&&(this.yBezier1=new t.BezierData),null==this.zBezier1&&(this.zBezier1=new t.BezierData),this.xBezier1.validate(),this.yBezier1.validate(),this.zBezier1.validate()),this.type==i.TwoBezier&&(null==this.xBezier2&&(this.xBezier2=new t.BezierData),null==this.yBezier2&&(this.yBezier2=new t.BezierData),null==this.zBezier2&&(this.zBezier2=new t.BezierData),this.xBezier2.validate(),this.yBezier2.validate(),this.zBezier2.validate())},e}();t.VelocityOverLifeTimeData=x,__reflect(x.prototype,"egret3d.VelocityOverLifeTimeData");var b=function(){function e(){this.type=i.Const,this.max=new t.Vector3D,this.min=new t.Vector3D,this.worldSpace=!1,this.xBezier1=new t.BezierData,this.yBezier1=new t.BezierData,this.zBezier1=new t.BezierData,this.xBezier2=new t.BezierData,this.yBezier2=new t.BezierData,this.zBezier2=new t.BezierData}return e.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.xBezier1&&(this.xBezier1=new t.BezierData),null==this.yBezier1&&(this.yBezier1=new t.BezierData),null==this.zBezier1&&(this.zBezier1=new t.BezierData),this.xBezier1.validate(),this.yBezier1.validate(),this.zBezier1.validate()),this.type==i.TwoBezier&&(null==this.xBezier2&&(this.xBezier2=new t.BezierData),null==this.yBezier2&&(this.yBezier2=new t.BezierData),null==this.zBezier2&&(this.zBezier2=new t.BezierData),this.xBezier2.validate(),this.yBezier2.validate(),this.zBezier2.validate())},e}();t.VelocityForceLifeTimeData=b,__reflect(b.prototype,"egret3d.VelocityForceLifeTimeData");var D=function(r){function a(){var a=r.call(this,e.ScaleSize)||this;return a.type=i.Const,a.max=1,a.min=1,a.bezier1=new t.BezierData,a.bezier2=new t.BezierData,a}return __extends(a,r),a.prototype.validate=function(){this.max<=0&&(this.max=1e-6),this.min<=0&&(this.min=1e-6),this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst,(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},a}(u);t.ParticleDataScaleSize=D,__reflect(D.prototype,"egret3d.ParticleDataScaleSize");var T=function(r){function a(){var a=r.call(this,e.RotationSpeed)||this;return a.max=new t.Vector3D,a.min=new t.Vector3D,a.type=i.Const,a.bezier1=new t.BezierData,a.bezier2=new t.BezierData,a.rot3Axis=!1,a}return __extends(a,r),a.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},a}(u);t.ParticleDataRotationSpeed=T,__reflect(T.prototype,"egret3d.ParticleDataRotationSpeed");var P=function(r){function i(){var i=r.call(this,e.ColorOffset)||this;return i.data=new t.ColorGradients,i}return __extends(i,r),i.prototype.validate=function(){null==this.data.colors&&(this.data.colors=[]),null==this.data.times&&(this.data.times=[])},i}(u);t.ParticleDataColorOffset=P,__reflect(P.prototype,"egret3d.ParticleDataColorOffset");var S=function(t){function r(){var r=t.call(this,e.FollowTarget)||this;return r.followRotation=!0,r.followScale=!0,r}return __extends(r,t),r.prototype.validate=function(){},r}(u);t.ParticleDataFollowTarget=S,__reflect(S.prototype,"egret3d.ParticleDataFollowTarget");var w=function(r){function a(){var a=r.call(this,e.TextureSheet)||this;return a.tileX=1,a.tileY=1,a.whole=!0,a.frameType=i.Const,a.randomRow=!1,a.row=0,a.min=0,a.max=0,a.circles=1,a.bezier1=new t.BezierData,a.bezier2=new t.BezierData,a}return __extends(a,r),a.prototype.validate=function(){this.tileX<0&&(this.tileX=1),this.tileX=Math.floor(this.tileX),this.tileY<0&&(this.tileY=1),this.tileY=Math.floor(this.tileY),this.max<0&&(this.max=0),this.min>this.max&&(this.min=this.max),(this.frameType==i.OneBezier||this.frameType==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.frameType==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate()),this.circles<1&&(this.circles=1)},a}(u);t.ParticleDataTextureSheet=w,__reflect(w.prototype,"egret3d.ParticleDataTextureSheet")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===i&&(i=null);var a=e.call(this,null,i)||this;return a._isEmitterDirty=!0,a._userNodes=[],a.material.depthWrite=!1,a.tag.name="effect",a.type=t.IRender.TYPE_PARTICLE_EMIT,a._data=r,a._externalGeometry=r.property.geometry,a.animation=a._particleAnimation=new t.ParticleAnimation(a),a.animation.particleAnimationController=a._particleAnimation,a._particleState=a._particleAnimation.particleAnimationState,a._generator=new t.ParticleLifeGenerator,a._particleAnimation.emit=a,a.buildParticle(),a.animation.isLoop=a._data.life.loop,a}return __extends(r,e),r.prototype.trackPosition=function(t,e){this._trackPositionNode&&(this.animation.animTime=0,this._trackPositionNode.trackPosition(t,e))},Object.defineProperty(r.prototype,"trackEndCoords",{get:function(){return this._trackPositionNode?this._trackPositionNode.endCoords:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"generator",{get:function(){return this._generator},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"drawOrder",{get:function(){return this._data.property.sortingFudge},enumerable:!0,configurable:!0}),r.prototype.addSubEmitter=function(t,e){e.animation.stop(),this._subEmitterNode.importSubEmitter(t,e)},r.prototype.buildParticle=function(){null==this._externalGeometry?this._geometryShape=this.createPlane():this._geometryShape=this._externalGeometry;var e=this._data.property.renderMode;e==t.ParticleRenderModeType.Billboard?this.billboard=t.BillboardType.STANDARD:e==t.ParticleRenderModeType.VerticalBillboard||e==t.ParticleRenderModeType.StretchedBillboard?this.billboard=t.BillboardType.Y_AXIS:this.billboard=t.BillboardType.DISABLE,this.initialize(),this.initBoudBox(this._data.property.bounds),this._isEmitterDirty=!1},r.prototype.createPlane=function(){var e,r=this._data.geometry,i=t.Vector3D.Z_AXIS,a=!0,n=!0;return this._data.property.renderMode==t.ParticleRenderModeType.StretchedBillboard&&(a=!1,n=!0),e=new t.PlaneGeometry(r.planeW,r.planeH,1,1,1,1,i,a,n)},Object.defineProperty(r.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"timeNode",{get:function(){return this._timeNode},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"positionNode",{get:function(){return this._positionNode},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"followTarget",{get:function(){return this._particleState.followTarget},set:function(t){this._particleState.followTarget=t},enumerable:!0,configurable:!0}),r.prototype.addAnimNode=function(t){var e=this._userNodes.indexOf(t);-1==e&&(this._userNodes.push(t),this._isEmitterDirty=!0)},r.prototype.removeAnimNode=function(t){var e=this._userNodes.indexOf(t);-1!=e&&(this._userNodes.slice(e),this._isEmitterDirty=!0)},r.prototype.play=function(t,e,r){void 0===t&&(t=1),void 0===e&&(e=!1),void 0===r&&(r=!1),this.animation.play("",t,e,r)},r.prototype.stop=function(){this.animation.stop()},r.prototype.initialize=function(){this._particleAnimation.particleAnimationState.clean(),this._generator.generator(this._data);var e=this._generator.planes.length;this.geometry=new t.Geometry,this.geometry.buildDefaultSubGeometry(),this.geometry.subGeometrys[0].count=e*this._geometryShape.indexCount;var r=0,i=new Array,a=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_NORMAL;this.geometry.vertexFormat=a,this.initMainAnimNode(),this.initUserAnimNode(),this.initEndNode(),this.geometry.vertexCount=e*this._geometryShape.vertexCount,this.geometry.indexCount=e*this._geometryShape.indexCount,this._geometryShape.getVertexForIndex(0,a,i,this._geometryShape.vertexCount);
for(var n=0;e>n;++n)r=n*this._geometryShape.vertexCount,this.geometry.setVerticesForIndex(r,a,i,this._geometryShape.vertexCount);for(var n=0;e>n;++n)for(var o=0;o<this._geometryShape.indexArray.length;++o)this.geometry.indexArray[n*this._geometryShape.indexArray.length+o]=this._geometryShape.indexArray[o]+n*this._geometryShape.vertexCount;this._particleAnimation.particleAnimationState.fill(this.geometry,e)},r.prototype.initMainAnimNode=function(){var e=[];this._timeNode=new t.ParticleTime,this._timeNode.initNode(this._data.life),e.push(this._timeNode),this._positionNode=new t.ParticlePosition,this._positionNode.initNode(this._data.shape,this._data.property),e.push(this._positionNode);var r=new t.ParticleVelocityNode;r.initNode(this._data.moveSpeed),e.push(r),this._subEmitterNode=new t.ParticleSubEmitterNode,this._subEmitterNode.initNode(null,this),this._particleAnimation.particleAnimationState.addNode(this._subEmitterNode);var i=this._data.moveSpeed.velocityOver;if(i)if(i.type==t.ParticleValueType.Const||i.type==t.ParticleValueType.RandomConst){var a=new t.ParticleVelocityOverConstNode;a.initNode(this._data.moveSpeed),e.push(a)}else if(i.type==t.ParticleValueType.OneBezier){var n=new t.ParticleVelocityOverOneBezierNode;n.initNode(this._data.moveSpeed),e.push(n)}else if(i.type==t.ParticleValueType.TwoBezier){var o=new t.ParticleVelocityOverTwoBezierNode;o.initNode(this._data.moveSpeed),e.push(o)}var s=this._data.moveSpeed.velocityLimit;if(s)if(s.type==t.ParticleValueType.Const||s.type==t.ParticleValueType.RandomConst){var l=new t.ParticleVelocityLimitConstNode;l.initNode(this._data.moveSpeed),e.push(l)}else if(s.type==t.ParticleValueType.OneBezier){var h=new t.ParticleVelocityLimitOneBezierNode;h.initNode(this._data.moveSpeed),e.push(h)}else if(s.type==t.ParticleValueType.TwoBezier){var u=new t.ParticleVelocityLimitTwoBezierNode;u.initNode(this._data.moveSpeed),e.push(u)}var c=this._data.moveSpeed.velocityForce;if(c)if(c.type==t.ParticleValueType.Const||c.type==t.ParticleValueType.RandomConst){var d=new t.ParticleVelocityForceConstNode;d.initNode(this._data.moveSpeed),e.push(d)}else if(c.type==t.ParticleValueType.OneBezier){var p=new t.ParticleVelocityForceOneBezierNode;p.initNode(this._data.moveSpeed),e.push(p)}else if(c.type==t.ParticleValueType.TwoBezier){var f=new t.ParticleVelocityForceTwoBezierNode;f.initNode(this._data.moveSpeed),e.push(f)}var m=new t.ParticleRotation;m.initNode(this._data.rotationBirth),e.push(m);var _=new t.ParticleScale;_.initNode(this._data.scaleBirth),e.push(_);var v=new t.ParticleSizeGlobalNode;v.initNode(this._data.scaleSize),e.push(v);var g=new t.ParticleStartColor;if(g.initNode(this._data.property),e.push(g),this._data.followTarget){var y=new t.ParticleFollowNode;y.initNode(this._data.followTarget),e.push(y)}if(this._data.rotationSpeed)if(this._data.rotationSpeed.rot3Axis){var x=new t.ParticleRotationXYZConstNode;x.initNode(this._data.rotationSpeed),e.push(x)}else if(this._data.rotationSpeed.type==t.ParticleValueType.Const||this._data.rotationSpeed.type==t.ParticleValueType.RandomConst){var b=new t.ParticleRotationConstNode;b.initNode(this._data.rotationSpeed),e.push(b)}else if(this._data.rotationSpeed.type==t.ParticleValueType.OneBezier){var D=new t.ParticleRotationOneBezierNode;D.initNode(this._data.rotationSpeed),e.push(D)}else if(this._data.rotationSpeed.type==t.ParticleValueType.TwoBezier){var T=new t.ParticleRotationTwoBezierNode;T.initNode(this._data.rotationSpeed),e.push(T)}if(this._data.colorOffset){var P=new t.ParticleColorGlobalNode;P.initNode(this._data.colorOffset),e.push(P)}if(this._data.materialData)for(var S,w=0,A=this._data.materialData.methods;w<A.length;w++)if(S=A[w],S.type==t.UnitMatMethodData.methodType.lightmapMethod);else if(S.type==t.UnitMatMethodData.methodType.uvRollMethod){var C=new t.ParticleUVRollNode;C.initNode(null,S),e.push(C)}else S.type==t.UnitMatMethodData.methodType.alphaMaskMethod||S.type==t.UnitMatMethodData.methodType.streamerMethod;if(this._data.textureSheet){var L=new t.ParticleTextureSheetNode;L.initNode(null,this._data.textureSheet),e.push(L)}this._data.property.trackPosition&&(this._trackPositionNode=new t.ParticleTrackPositionNode,this._trackPositionNode.initNode(null),e.push(this._trackPositionNode));for(var E=0,M=e.length;M>E;E++)this._particleAnimation.particleAnimationState.addNode(e[E])},r.prototype.initUserAnimNode=function(){for(var t=0;t<this._userNodes.length;t++)this._particleAnimation.particleAnimationState.addNode(this._userNodes[t])},r.prototype.initEndNode=function(){var e=new t.ParticleEndNode;this._particleAnimation.particleAnimationState.addNode(e),this._particleAnimation.particleAnimationState.calculate(this.geometry)},r.prototype.initBoudBox=function(e){var r=new t.BoundBox(this);r.fillBox(new t.Vector3D(-e.x/2,-e.y/2,-e.z/2),new t.Vector3D(e.x/2,e.y/2,e.z/2)),this.bound=r,this.initAABB()},Object.defineProperty(r.prototype,"loopProgress",{get:function(){var t;return t=this.animation.animTime/(1e3*this.animation.loopTime)},enumerable:!0,configurable:!0}),r.prototype.update=function(t,r,i){this._isEmitterDirty&&this.buildParticle(),e.prototype.update.call(this,t,r,i)},r.prototype.copy=function(r){e.prototype.copy.call(this,r);var i=[t.ParticleDataSubEmitterPhase.BIRTH,t.ParticleDataSubEmitterPhase.COLLISION,t.ParticleDataSubEmitterPhase.DEATH];if(r._subEmitterNode)for(var a=0;a<i.length;a++){var n=i[a],o=r._subEmitterNode.getSubEmitters(n);if(o&&o.length>0)for(var s=0;s<o.length;s++)this.addSubEmitter(n,o[s])}},r.prototype.clone=function(){var t;return t=new r(this.data,this.material),t.copy(this),t},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._generator&&(this._generator.dispose(),this._generator=null),this._timeNode=null,this._positionNode=null,this._geometryShape&&(this._geometryShape.dispose(),this._geometryShape=null),this._externalGeometry&&(this._externalGeometry.dispose(),this._externalGeometry=null),this._particleAnimation=null,this._particleState&&(this._particleState.dispose(),this._particleState=null),this._subEmitterNode=null,this._userNodes=null,this._data=null},r}(t.Mesh);t.ParticleEmitter=e,__reflect(e.prototype,"egret3d.ParticleEmitter")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t["float"]=0]="float",t[t.vec2=1]="vec2",t[t.vec3=2]="vec3",t[t.vec4=3]="vec4"}(e=t.ValueType||(t.ValueType={}));var r=function(){function t(){}return t.prototype.calculate=function(t,e){return void 0===e&&(e=null),new Error("asd"),null},t.prototype.dispose=function(){},t}();t.ValueShape=r,__reflect(r.prototype,"egret3d.ValueShape");var i=function(t){function r(){var r=null!==t&&t.apply(this,arguments)||this;return r.valueType=e["float"],r.value=5,r}return __extends(r,t),r.prototype.calculate=function(t){for(var e=[],r=0;t>r;r++)e.push(this.value);return e},r}(r);t.ConstValueShape=i,__reflect(i.prototype,"egret3d.ConstValueShape");var a=function(t){function r(){var r=null!==t&&t.apply(this,arguments)||this;return r.valueType=e["float"],r.min=0,r.max=100,r}return __extends(r,t),r.prototype.calculate=function(t){for(var e=[],r=0;t>r;r++)e.push(this.min+Math.random()*(this.max-this.min));return e},r}(r);t.ConstRandomValueShape=a,__reflect(a.prototype,"egret3d.ConstRandomValueShape");var n=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec2,t.minX=0,t.minY=0,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r=[],i=0;e>i;i++){var a=new t.Point;a.x=this.minX,a.y=this.minY,r.push(a)}return r},i}(r);t.Vec2ConstValueShape=n,__reflect(n.prototype,"egret3d.Vec2ConstValueShape");var o=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec2,t.minX=0,t.minY=0,t.maxX=100,t.maxY=100,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r=[],i=0;e>i;i++){var a=new t.Point;a.x=this.minX+Math.random()*(this.maxX-this.minX),a.y=this.minY+Math.random()*(this.maxY-this.minY),r.push(a)}return r},i}(r);t.Vec2ConstRandomValueShape=o,__reflect(o.prototype,"egret3d.Vec2ConstRandomValueShape");var s=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.minX=0,t.minY=0,t.minZ=0,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r=[],i=0;e>i;i++){var a=new t.Vector3D;a.x=this.minX,a.y=this.minY,a.z=this.minZ,r.push(a)}return r},i}(r);t.Vec3ConstValueShape=s,__reflect(s.prototype,"egret3d.Vec3ConstValueShape");var l=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.minX=-50,t.minY=-50,t.minZ=-50,t.maxX=50,t.maxY=50,t.maxZ=50,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r=[],i=0;e>i;i++){var a=new t.Vector3D;a.x=this.minX+Math.random()*(this.maxX-this.minX),a.y=this.minY+Math.random()*(this.maxY-this.minY),a.z=this.minZ+Math.random()*(this.maxZ-this.minZ),r.push(a)}return r},i}(r);t.Vec3ConstRandomValueShape=l,__reflect(l.prototype,"egret3d.Vec3ConstRandomValueShape");var h=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.width=100,t.height=100,t.depth=100,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r,i=[],a=0;e>a;a++)r=new t.Vector3D,r.x=Math.random()*this.width-.5*this.width,r.y=Math.random()*this.height-.5*this.height,r.z=Math.random()*this.depth-.5*this.depth,i.push(r);return i},i}(r);t.CubeVector3DValueShape=h,__reflect(h.prototype,"egret3d.CubeVector3DValueShape");var u=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.width=100,t.height=100,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r,i=[],a=0;e>a;a++)r=new t.Vector3D,r.x=Math.random()*this.width-.5*this.width,r.y=0,r.z=Math.random()*this.height-.5*this.height,i.push(r);return i},i}(r);t.PlaneValueShape=u,__reflect(u.prototype,"egret3d.PlaneValueShape");var c=function(r){function i(){var i=null!==r&&r.apply(this,arguments)||this;return i.valueType=e.vec3,i.radius=20,i.angle=20,i.length=20,i.coneType=t.ParticleConeShapeType.Volume,i}return __extends(i,r),i.prototype.dispose=function(){this.directions&&(this.directions.length=0),this.origPoint=null,this.directions=null},i.prototype.calculate=function(e){this.angle>90&&(this.angle=90),this.radius<=0&&(this.radius=.01),90==this.angle?this.origPoint=new t.Vector3D:0==this.angle?this.origPoint=null:(this.origPoint=new t.Vector3D,this.origPoint.z=-this.radius/Math.tan(this.angle*Math.PI/180));var r;return this.directions=[],this.coneType==t.ParticleConeShapeType.Volume?r=90==this.angle?this.calculateBase(e):this.calculateVolume(e):this.coneType==t.ParticleConeShapeType.VolumeShell?r=90==this.angle?this.calculateBaseShell(e):this.calculateVolumeShell(e):this.coneType==t.ParticleConeShapeType.Base?r=this.calculateBase(e):this.coneType==t.ParticleConeShapeType.BaseShell&&(r=this.calculateBaseShell(e)),r},i.prototype.calculateBase=function(e){for(var r,i,a,n,o=[],s=0;e>s;s++)a=Math.random()*Math.PI*2,r=new t.Vector3D,r.z=0,n=Math.random()*this.radius,r.x=Math.sin(a)*n,r.y=Math.cos(a)*n,this.origPoint?(i=r.subtract(this.origPoint),i.normalize()):i=new t.Vector3D(0,0,1),o.push(r),this.directions.push(i);return o},i.prototype.calculateBaseShell=function(e){for(var r,i,a,n,o=[],s=0;e>s;s++)a=Math.random()*Math.PI*2,r=new t.Vector3D,r.z=0,n=this.radius,r.x=Math.sin(a)*n,r.y=Math.cos(a)*n,this.origPoint?(i=r.subtract(this.origPoint),i.normalize()):i=new t.Vector3D(0,0,1),o.push(r),this.directions.push(i);return o},i.prototype.calculateVolume=function(e){for(var r,i,a,n,o=[],s=0;e>s;s++)a=Math.random()*Math.PI*2,r=new t.Vector3D,r.z=this.length*Math.random(),n=this.radius*Math.random(),this.origPoint&&(n*=(r.z-this.origPoint.z)/-this.origPoint.z),r.x=Math.sin(a)*n,r.y=Math.cos(a)*n,this.origPoint?(i=r.subtract(this.origPoint),i.normalize()):i=new t.Vector3D(0,0,1),o.push(r),this.directions.push(i);return o},i.prototype.calculateVolumeShell=function(e){for(var r,i,a,n,o=[],s=0;e>s;s++)a=Math.random()*Math.PI*2,r=new t.Vector3D,r.z=this.length*Math.random(),n=this.radius,this.origPoint&&(n*=(r.z-this.origPoint.z)/-this.origPoint.z),r.x=Math.sin(a)*n,r.y=Math.cos(a)*n,this.origPoint?(i=r.subtract(this.origPoint),i.normalize()):i=new t.Vector3D(0,0,1),o.push(r),this.directions.push(i);return o},i.prototype.randomPosAtTop=function(){var t,e,r=i.randomPosTop;t=Math.random()*Math.PI*2,r.z=this.length,this.origPoint?(e=this.radius*Math.random(),e*=(r.z-this.origPoint.z)/-this.origPoint.z,r.x=Math.sin(t)*e,r.y=Math.cos(t)*e,r.decrementBy(this.origPoint)):r.x=r.y=0},i.prototype.randomDirectionToTop=function(t){this.randomPosAtTop(),t.copyFrom(i.randomPosTop),t.normalize()},i}(r);c.randomPosTop=new t.Vector3D,t.ConeValueShape=c,__reflect(c.prototype,"egret3d.ConeValueShape");var d=function(r){function i(){var i=null!==r&&r.apply(this,arguments)||this;return i.valueType=e.vec3,i.points=[new t.Vector3D,new t.Vector3D(100,0,0),new t.Vector3D(100,200,0)],i}return __extends(i,r),i.prototype.calculate=function(e){if(1==this.points.length)return this.points;for(var r=[],i=0,a=0,n=1;n<this.points.length;n++)i+=t.Vector3D.distance(this.points[n-1],this.points[n]);a=i/e;for(var o=new t.Vector3D,s=0,l=0,h=0,n=1;n<this.points.length;n++)o.x=this.points[n].x-this.points[n-1].x,o.y=this.points[n].y-this.points[n-1].y,o.z=this.points[n].z-this.points[n-1].z,o.normalize(),o.scaleBy(a+h),s=t.Vector3D.distance(this.points[n-1],this.points[n]),l=t.Vector3D.distance(o,this.points[n]),l>s&&(h+=l);return r},i}(r);__reflect(d.prototype,"LineValueShape");var p=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.r=10,t.fromShell=!1,t}return __extends(i,r),i.prototype.calculate=function(t){var e=[];return e=this.getPoints1(t,this.r)},i.prototype.getPoints1=function(e,r){for(var i,a,n,o,s=[],l=new t.Vector3D(0,0,0),h=0;e>h;h++)i=2*Math.random()*r-r,a=2*Math.random()*r-r,n=2*Math.random()*r-r,o=new t.Vector3D(i,a,n),this.fromShell&&o.normalize(this.r),t.Vector3D.distance(l,o)>r?h--:s.push(o);return s},i}(r);t.BallValueShape=p,__reflect(p.prototype,"egret3d.BallValueShape");var f=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t.r=10,t.fromShell=!1,t}return __extends(i,r),i.prototype.calculate=function(t){var e=[];return e=this.getPoints(t,this.r)},i.prototype.getPoints=function(e,r){for(var i,a,n,o,s=[],l=new t.Vector3D(0,0,0),h=0;e>h;h++)i=2*Math.random()*r-r,a=2*Math.random()*r-r,n=Math.abs(2*Math.random()*r-r),o=new t.Vector3D(i,a,n),this.fromShell&&o.normalize(this.r),t.Vector3D.distance(l,o)>r?h--:s.push(o);return s},i}(r);t.HemiBallValueShape=f,__reflect(f.prototype,"egret3d.HemiBallValueShape");var m=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t}return __extends(i,r),i.prototype.calculate=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var i,a=e[0],n=a[0];return i=this.createRandomPoint1(t,n)},i.prototype.createRandomPoint1=function(e,r){for(var i=[],a=2*r,n=0;e>n;n++){var o=Math.random()*a-r,s=Math.random()*a-r;o*o+s*s>r*r?n--:i.push(new t.Vector3D(o,0,s))}return i},i.prototype.createRandomPoint2=function(e,r){for(var i,a,n,o=[],s=0;e>s;s++)i=new t.Vector3D,a=Math.sqrt(Math.random())*r,n=360*Math.random(),i.x=a*Math.sin(n),i.z=a*Math.cos(n),i.y=0,o.push(i);return o},i}(r);__reflect(m.prototype,"CircleValueShape");var _=function(r){function i(){var i=null!==r&&r.apply(this,arguments)||this;return i.valueType=e.vec3,i.normalList=[],i.type=t.ParticleMeshShapeType.Edge,i.scale=1,i}return __extends(i,r),i.prototype.calculate=function(e){var r=[];if(this.type==t.ParticleMeshShapeType.Edge?this.edgePosition(r,e):this.type==t.ParticleMeshShapeType.Triangle?this.trianglePosition(r,e):this.type==t.ParticleMeshShapeType.Vertex&&this.vertexPosition(r,e),1!=this.scale&&0!=this.scale)for(var i,a=0,n=r;a<n.length;a++)i=n[a],i.scaleBy(this.scale);return r},i.prototype.edgePosition=function(e,r){for(var a,n,o,s,l,h=this.geometry.faceCount,u=[],c=[],d=0;r>d;d++){a=new t.Vector3D,e.push(a),u.length=0;var p=3*Math.floor(h*Math.random());this.geometry.getVertexIndices(p,3,u),c.length=0,this.geometry.getVertexForIndex(u[0],t.VertexFormat.VF_POSITION,c),i.vct1.setTo(c[0],c[1],c[2]),c.length=0,this.geometry.getVertexForIndex(u[1],t.VertexFormat.VF_POSITION,c),i.vct2.setTo(c[0],c[1],c[2]),c.length=0,this.geometry.getVertexForIndex(u[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,c),i.vct3.setTo(c[0],c[1],c[2]),n=new t.Vector3D,n.setTo(c[3],c[4],c[5]),this.normalList.push(n),l=Math.random(),.333>l?(o=i.vct1,s=i.vct2):.666>l?(o=i.vct2,s=i.vct3):(o=i.vct3,s=i.vct1),o.lerp(o,s,Math.random()),a.copyFrom(o)}},i.prototype.trianglePosition=function(e,r){for(var a,n,o=this.geometry.faceCount,s=new t.Vector3D,l=new t.Vector3D,h=[],u=[],c=0;r>c;c++){a=new t.Vector3D,e.push(a),u.length=0;var d=3*Math.floor(o*Math.random());this.geometry.getVertexIndices(d,3,u),h.length=0,this.geometry.getVertexForIndex(u[0],t.VertexFormat.VF_POSITION,h),i.vct1.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(u[1],t.VertexFormat.VF_POSITION,h),i.vct2.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(u[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,h),i.vct3.setTo(h[0],h[1],h[2]),n=new t.Vector3D,n.setTo(h[3],h[4],h[5]),this.normalList.push(n),s.lerp(i.vct1,i.vct2,Math.random()),l.lerp(i.vct2,i.vct3,Math.random()),a.lerp(s,l,Math.random())}},i.prototype.vertexPosition=function(e,r){for(var a,n,o,s=this.geometry.faceCount,l=[],h=[],u=0;r>u;u++){a=new t.Vector3D,e.push(a);var c=3*Math.floor(s*Math.random());l.length=0,this.geometry.getVertexIndices(c,3,l),h.length=0,this.geometry.getVertexForIndex(l[0],t.VertexFormat.VF_POSITION,h),i.vct1.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(l[1],t.VertexFormat.VF_POSITION,h),i.vct2.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(l[2],t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL,h),i.vct3.setTo(h[0],h[1],h[2]),n=new t.Vector3D,n.setTo(h[3],h[4],h[5]),this.normalList.push(n),o=Math.random(),.333>o?a.copyFrom(i.vct1):.666>o?a.copyFrom(i.vct2):a.copyFrom(i.vct3)}},i.prototype.calcNormal=function(t,e,r){return i.crsVector1.setTo(e.x-t.x,e.y-t.y,e.z-t.z),i.crsVector2.setTo(r.x-t.x,r.y-t.y,r.z-t.z),i.crsVector1.normalize(),i.crsVector2.normalize(),this.normal=i.crsVector2.crossProduct(i.crsVector1),this.normal.normalize(),this.normal},i}(r);_.vct1=new t.Vector3D,_.vct2=new t.Vector3D,_.vct3=new t.Vector3D,_.crsVector1=new t.Vector3D,_.crsVector2=new t.Vector3D,t.Mesh3DValueShape=_,__reflect(_.prototype,"egret3d.Mesh3DValueShape");var v=function(r){function i(){var t=null!==r&&r.apply(this,arguments)||this;return t.valueType=e.vec3,t}return __extends(i,r),i.prototype.calculate=function(e){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var a=[],n=[];n.push(new t.Vector3D(0,0,0)),n.push(new t.Vector3D(-200,1e3,700)),n.push(new t.Vector3D(200,-50,300)),n.push(new t.Vector3D(-300,-220,500));for(var o,s,l,h,u,c=n[0],d=n[1],p=n[2],f=n[3],m=0;e>m;m++)o=Math.random(),s=1-o,l=c.x*s*s*s+3*d.x*s*s*o+3*p.x*s*o*o+f.x*o*o*o,h=c.y*s*s*s+3*d.y*s*s*o+3*p.y*s*o*o+f.y*o*o*o,u=c.z*s*s*s+3*d.z*s*s*o+3*p.z*s*o*o+f.z*o*o*o,a.push(new t.Vector3D(l,h,u));return a},i}(r);__reflect(v.prototype,"BezierCurveValueShape");var g=function(t){function r(){var r=null!==t&&t.apply(this,arguments)||this;return r.valueType=e.vec3,r}return __extends(r,t),r.prototype.calculate=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var i=this.positionList.slice();return i},r}(r);t.ValueShapeExternal=g,__reflect(g.prototype,"egret3d.ValueShapeExternal");var y=function(){function t(){this.emitter={}}return t.calculate=function(t,e){return e.calculate(t,e)},t.getValues=function(t,e,r){},t}();y._instance=new y,t.Value=y,__reflect(y.prototype,"egret3d.Value")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var i=e.call(this)||this;i._colorSegment=new Float32Array(2*r.MaxColor),i.name="ParticleColorGlobalNode",i.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_color_vs");var a=t.Egret3DPolicy.useLowLoop?"particle_color_fs_low":"particle_color_fs";return i.importShader(!1,t.ShaderPhaseType.end_fragment,a),i}return __extends(r,e),r.prototype.initNode=function(t){var e=t,i=r.MaxColor,a=e.data;a.colors.length=a.times.length=i;for(var n,o=0;i>o;o++)n=a.colors[o],n?(this._colorSegment[o]=this.getGpuColor(n.r,n.g,n.b),this._colorSegment[o+i]=this.getTimeAndAlpha(a.times[o],n.a)):(this._colorSegment[o]=0,this._colorSegment[o+i]=0)},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){a.uniform_colorTransform&&o.uniform1fv(a.uniform_colorTransform.uniformIndex,this._colorSegment)},r.prototype.getGpuColor=function(t,e,r){var i;return t=this.normalizeChannel(t),e=this.normalizeChannel(e),r=this.normalizeChannel(r),i=256*t+e+r/256},r.prototype.normalizeChannel=function(t){return t>255?t=255:0>t&&(t=0),t=Math.floor(t)},r.prototype.normalizeTime=function(t){return t>=1?t=.9999:0>t&&(t=0),t},r.prototype.getTimeAndAlpha=function(t,e){return e=this.normalizeChannel(e),t=this.normalizeTime(t),e+t},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._colorSegment=null},r}(t.AnimationNode);e.MaxColor=20,t.ParticleColorGlobalNode=e,__reflect(e.prototype,"egret3d.ParticleColorGlobalNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleEndNode",r.importShader(!0,t.ShaderPhaseType.end_vertex,"particle_end_vs"),r.importShader(!1,t.ShaderPhaseType.end_fragment,"particle_end_fs"),r}return __extends(r,e),r.prototype.build=function(t,e){},r}(t.AnimationNode);t.ParticleEndNode=e,__reflect(e.prototype,"egret3d.ParticleEndNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._count=0,r._followRotation=!1,r._followScale=!1,r.bornTime=0,r.life=0,r.id=0,r.timeIndex=0,r._verticesDataDirty=!1,r.name="ParticleFollowNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_follow_vs"),r.attribute_followPosition=new t.GLSL.VarRegister,r.attribute_followPosition.name="attribute_followPosition",r.attribute_followPosition.size=3,r.attributes.push(r.attribute_followPosition),r.attribute_followRotation=new t.GLSL.VarRegister,r.attribute_followRotation.name="attribute_followRotation",r.attribute_followRotation.size=4,r.attributes.push(r.attribute_followRotation),r.attribute_followScale=new t.GLSL.VarRegister,r.attribute_followScale.name="attribute_followScale",r.attribute_followScale.size=3,r.attributes.push(r.attribute_followScale),r}return __extends(r,e),r.prototype.initNode=function(t){var e=t;this._followScale=e.followScale,this._followRotation=e.followRotation},r.prototype.onAnimTimeChange=function(){e.prototype.onAnimTimeChange.call(this),this.resetCircleData()},r.prototype.build=function(t,e){this._count=e,this._animationState=this.state,this._lifeCircles=[],this.resetCircleData()},r.prototype.resetCircleData=function(){for(var t=0;t<this._count;t++)this._lifeCircles[t]=-1},r.prototype.update=function(t,e,r){this._verticesDataDirty=this._verticesDataDirty;var i=this._animationState.emitter.data,a=i.life.loop,n=this._animationState.modTime+i.life.duration+i.life.delay;if(a||!(.001*t>=n)){for(var o=0,s=r.vertexCount/this._count,l=0,h=!1,u=this._animationState.emitter.timeNode.offsetIndex,c=.001*t-i.life.delay,d=r.sharedVertexBuffer?r.sharedVertexBuffer.arrayBuffer:r.vertexArray,p=this._animationState.followTarget||this._animationState.emitter,f=0;f<this._count;++f){l=f*s,this.timeIndex=l*r.vertexAttLength+u,this.bornTime=d[this.timeIndex+0],this.life=d[this.timeIndex+1];var m=-1;if(c>=this.bornTime){if(c>this.bornTime+this.life&&!a)continue;if(m=Math.floor((c-this.bornTime)/this._animationState.modTime),(c-this.bornTime)%this._animationState.modTime>this.life)continue;if(m!=this._lifeCircles[f]){this._lifeCircles[f]=m,h=!0;for(var _=0;s>_;++_)o=l+_,o=o*r.vertexAttLength+this.attribute_followPosition.offsetIndex,d[o+0]=p.globalPosition.x,d[o+1]=p.globalPosition.y,d[o+2]=p.globalPosition.z,o=l+_,o=o*r.vertexAttLength+this.attribute_followRotation.offsetIndex,this._followRotation?(d[o+0]=p.globalOrientation.x,d[o+1]=p.globalOrientation.y,d[o+2]=p.globalOrientation.z,d[o+3]=p.globalOrientation.w):(d[o+0]=0,d[o+1]=0,d[o+2]=0,d[o+3]=0),o=l+_,o=o*r.vertexAttLength+this.attribute_followScale.offsetIndex,this._followScale?(d[o+0]=p.globalScaleX,d[o+1]=p.globalScaleY,d[o+2]=p.globalScaleZ):(d[o+0]=0,d[o+1]=0,d[o+2]=0)}}}this._verticesDataDirty=h}},r.prototype.activeState=function(t,e,r,i,a,n,o){this._verticesDataDirty&&(n.geometry.upload(o),this._verticesDataDirty=!1)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._lifeCircles=null},r}(t.AnimationNode);t.ParticleFollowNode=e,__reflect(e.prototype,"egret3d.ParticleFollowNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._tiny=.001}return e.prototype.generator=function(e){this._inputCount=2e3,this._data=e,this._node=e.life,this._burstsClone=e.emission.bursts,this._burstsClone&&(this._burstsClone=this._burstsClone.slice()),this.planes=[],this.loopTime=this.circleTime=0,this._data.emission.type==t.ParticleValueType.Const?this.generatorConst():this.generatorBezier(),this.planes.sort(function(t,e){return t.x-e.x});for(var r,i=0,a=0,n=this.planes;a<n.length;a++)r=n[a],this.circleTime=Math.max(this.circleTime,r.x+r.y),this.loopTime=Math.max(this.loopTime,r.y),i=r.x;i>this.loopTime&&(this.loopTime=i),this.loopTime<this._data.life.duration&&(this.loopTime=this._data.life.duration),this.circleTime+=this._data.life.delay},e.prototype.burstPlanes=function(t,e){for(var r,i,a,n,o=0,s=this._burstsClone.length;s>o;o++){if(r=this._burstsClone[o],i=r.x,n=!1,i>=t&&e>=i){a=Math.min(r.y,this._data.property.particleCount);for(var l=0;a>l;l++)this.tryCreatePlane(i);n=!0}else i>=this._data.life.duration&&(n=!0);n&&(this._burstsClone.splice(o,1),o--,s--)}},e.prototype.generatorConst=function(){this._data.emission.type==t.ParticleValueType.Const&&this._data.life.type==t.ParticleValueType.Const&&(this._data.life.duration=Math.ceil(this._data.life.duration/this._data.life.max)*this._data.life.max);var e=this._data.emission.rate;if(0!=e)for(var r=Math.max(1/e,this._tiny),i=(this._data.life.duration,0),a=r;i<=this._data.life.duration&&this.planes.length<this._inputCount;)this.tryCreatePlane(i),a=i+r,this._burstsClone&&this._burstsClone.length>0&&this.burstPlanes(i,a),i=a;else for(;this._burstsClone&&this._burstsClone.length>0&&this.planes.length<this._inputCount;)this.burstPlanes(0,t.MathUtil.MAX_VALUE)},e.prototype.generatorBezier=function(){for(var t=.05,e=this._data.life.duration,r=t,i=r,a=0,n=0,o=0;e>r&&this.planes.length<this._inputCount;)if(a+=this._data.emission.bezier.calc(r/e)*t,n=Math.floor(a),a-=n,n>0)for(o=t/n;n>0;)i+=o,this.tryCreatePlane(r),this._burstsClone&&this._burstsClone.length>0&&this.burstPlanes(r,i),r=i,n--;else i=r+t,this._burstsClone&&this._burstsClone.length>0&&this.burstPlanes(r,i),r=i},e.prototype.tryCreatePlane=function(e){for(var r,i,a=0,n=this._data.property.particleCount,o=0,s=this.planes.length;s>o;o++)i=this.planes[o],r=i.x,i.x+i.y>e+.01&&a++;n>a&&(i=new t.Point(e,this.getLifeTime(e)),this.planes.push(i))},e.prototype.getLifeTime=function(e){var r,i,a=(this._data.life.type,this._data.life);return a.type==t.ParticleValueType.Const?r=i=a.max:a.type==t.ParticleValueType.RandomConst?(r=a.max,i=a.min):a.type==t.ParticleValueType.OneBezier?r=i=a.bezier1.calc(e/a.duration):(r=a.bezier1.calc(e/a.duration),i=a.bezier2.calc(e/a.duration)),Math.random()*(r-i)+i},e.prototype.dispose=function(){this._data=null,this._node=null,this._burstsClone=null,this.planes=null},e}();t.ParticleLifeGenerator=e,__reflect(e.prototype,"egret3d.ParticleLifeGenerator")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticlePosition",r.attribute_offsetPosition=new t.GLSL.VarRegister,r.attribute_offsetPosition.name="attribute_offsetPosition",r.attribute_offsetPosition.size=3,r.attributes.push(r.attribute_offsetPosition),r}return __extends(r,e),r.prototype.initNode=function(e,r){var i=r.renderMode;i==t.ParticleRenderModeType.StretchedBillboard&&this.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_stretched_mode");var a=this._node=e;if(a.type==t.ParticleDataShapeType.Point){var n=new t.Vec3ConstValueShape;n.minX=0,n.minY=0,n.minZ=0,this._positions=n}else if(a.type==t.ParticleDataShapeType.Cube){var o=new t.CubeVector3DValueShape;o.width=a.cubeW,o.height=a.cubeH,o.depth=a.cubeD,this._positions=o}else if(a.type==t.ParticleDataShapeType.Sphere){var s=new t.BallValueShape;s.r=a.sphereRadius,s.fromShell=a.emitFromShell,this._positions=s}else if(a.type==t.ParticleDataShapeType.HemiSphere){var l=new t.HemiBallValueShape;l.r=a.hemiSphereRadius,l.fromShell=a.emitFromShell,this._positions=l}else if(a.type==t.ParticleDataShapeType.Cone){var h=new t.ConeValueShape;h.angle=a.coneAngle,h.length=a.coneLength,h.radius=a.coneRadius,h.coneType=a.coneType,this._positions=h}else if(a.type==t.ParticleDataShapeType.Mesh){var u=new t.Mesh3DValueShape;u.geometry=a.geometry,u.type=a.meshType,this._positions=u}else if(a.type==t.ParticleDataShapeType.External){var c=new t.ValueShapeExternal;c.positionList=a.externalPositionList,this._positions=c}},Object.defineProperty(r.prototype,"offsetIndex",{get:function(){return this.attribute_offsetPosition.offsetIndex},enumerable:!0,configurable:!0}),r.prototype.build=function(e,r){this._animationState=this.state;var i,a=this._positions.calculate(r),n=this._animationState.directionArray=[];this._node.type==t.ParticleDataShapeType.Mesh&&(i=this._positions.normalList);for(var o=e.vertexCount/r,s=0,l=this._animationState.emitter.data,h=new t.Vector3D,u=this._positions,c=0;r>c;++c){var d=a[c];h.copyFrom(d);var p=new t.Vector3D;l.shape.randomDirection?this._node.type!=t.ParticleDataShapeType.Cone||this._node.coneType!=t.ParticleConeShapeType.Base&&this._node.coneType!=t.ParticleConeShapeType.BaseShell?p.setTo(Math.random()-.5,Math.random()-.5,Math.random()-.5):this._positions.randomDirectionToTop(p):this._node.type==t.ParticleDataShapeType.Point?p.setTo(0,0,1,1):this._node.type==t.ParticleDataShapeType.Cube?p.setTo(0,0,1,1):this._node.type==t.ParticleDataShapeType.Sphere?p.copyFrom(h):this._node.type==t.ParticleDataShapeType.HemiSphere?p.copyFrom(h):this._node.type==t.ParticleDataShapeType.Cone?p=u.directions[c]:this._node.type==t.ParticleDataShapeType.Mesh?p.copyFrom(i[c]):this._node.type==t.ParticleDataShapeType.External&&p.setTo(0,0,1,1),p.normalize(),n.push(p);for(var f=0;o>f;++f)s=c*o+f,s=s*e.vertexAttLength+this.attribute_offsetPosition.offsetIndex,e.vertexArray[s+0]=d.x,e.vertexArray[s+1]=d.y,e.vertexArray[s+2]=d.z}},r.prototype.afterBuild=function(){this._positions.dispose(),this._positions=null,this._animationState.directionArray.length=0,this._animationState.directionArray=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._positions=null,this._animationState=null,this._node=null},r}(t.AnimationNode);t.ParticlePosition=e,__reflect(e.prototype,"egret3d.ParticlePosition")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleRotation",r.attribute_rotationBirth=new t.GLSL.VarRegister,r.attribute_rotationBirth.name="attribute_rotationBirth",r.attribute_rotationBirth.size=1,r.attributes.push(r.attribute_rotationBirth),r}return __extends(r,e),r.prototype.initNode=function(e){var r=this._node=e;this._rotations=new t.ConstRandomValueShape,this._rotations.max=r.max,this._rotations.min=r.min},r.prototype.build=function(e,r){this._animationState=this.state;var i=this._animationState.emitter.data.property.renderMode;if(i!=t.ParticleRenderModeType.StretchedBillboard)for(var a,n,o,s=this._rotations.calculate(r),l=e.vertexCount/r,h=0,u=(new t.Vector3D,0),c=this._animationState.emitter.data.life.duration,d=this._animationState.emitter.timeNode.offsetIndex,p=0,f=0;r>f;++f){if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(n=p*e.vertexAttLength+d,o=e.vertexArray[n+0],u=o/c,u-=Math.floor(u),a=this._node.bezier1.calc(u),this._node.type==t.ParticleValueType.TwoBezier){var m=Math.random();
a*=m,a+=this._node.bezier2.calc(u)*(1-m)}}else a=s[f];for(var _=0;l>_;++_)h=f*l+_,h=h*e.vertexAttLength+this.attribute_rotationBirth.offsetIndex,e.vertexArray[h+0]=a}},r.prototype.afterBuild=function(){this._rotations.dispose(),this._rotations=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._node=null,this._rotations=null},r}(t.AnimationNode);t.ParticleRotation=e,__reflect(e.prototype,"egret3d.ParticleRotation")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleRotationConstNode",r.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_rotationConst"),r.attribute_Rotation=new t.GLSL.VarRegister,r.attribute_Rotation.name="attribute_rotationZ",r.attribute_Rotation.size=1,r.attributes.push(r.attribute_Rotation),r}return __extends(r,e),r.prototype.initNode=function(e){var r=e;this._rotation=new t.ConstRandomValueShape,this._rotation.max=r.max.z,this._rotation.min=r.min.z},r.prototype.build=function(t,e){for(var r=0,i=t.vertexCount/e,a=this._rotation.calculate(e),n=0;e>n;++n)for(var o=a[n],s=0;i>s;++s)r=n*i+s,r=r*t.vertexAttLength+this.attribute_Rotation.offsetIndex,t.vertexArray[r+0]=o},r.prototype.afterBuild=function(){this._rotation.dispose(),this._rotation=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._rotation=null},r}(t.AnimationNode);t.ParticleRotationConstNode=e,__reflect(e.prototype,"egret3d.ParticleRotationConstNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleRotationOneBezierNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_rotationOneBezier"),r}return __extends(r,e),r.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.bezier1.sampler()},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){o.uniform1fv(a.uniform_rotationBezier.uniformIndex,this._floatCompressData)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressData=null,this._node=null},r}(t.AnimationNode);t.ParticleRotationOneBezierNode=e,__reflect(e.prototype,"egret3d.ParticleRotationOneBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleRotationTwoBezierNode",r.attribute_randomSeed=new t.GLSL.VarRegister,r.attribute_randomSeed.name="attribute_rotationRandomSeed",r.attribute_randomSeed.size=1,r.attributes.push(r.attribute_randomSeed),r}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this._floatCompressData=this._node.bezier1.sampler(),this._floatCompressData2=this._node.bezier2.sampler(),this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_rotationTwoBezier")},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=0;e>a;++a)for(var n=Math.random(),o=0;r>o;++o)i=a*r+o,i=i*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.vertexArray[i+0]=n},r.prototype.activeState=function(t,e,r,i,a,n,o){o.uniform1fv(a.uniform_rotationBezier.uniformIndex,this._floatCompressData),o.uniform1fv(a.uniform_rotationBezier2.uniformIndex,this._floatCompressData2)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressData=null,this._floatCompressData2=null,this._animationState=null,this._node=null},r}(t.AnimationNode);t.ParticleRotationTwoBezierNode=e,__reflect(e.prototype,"egret3d.ParticleRotationTwoBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleRotationXYZConstNode",r.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_rotationXYZConst"),r.attribute_rotBirthXYZ=new t.GLSL.VarRegister,r.attribute_rotBirthXYZ.name="attribute_rotBirthXYZ",r.attribute_rotBirthXYZ.size=3,r.attributes.push(r.attribute_rotBirthXYZ),r.attribute_rotSpeedXYZ=new t.GLSL.VarRegister,r.attribute_rotSpeedXYZ.name="attribute_rotSpeedXYZ",r.attribute_rotSpeedXYZ.size=3,r.attributes.push(r.attribute_rotSpeedXYZ),r}return __extends(r,e),r.prototype.initNode=function(e){var r=e;this._rotationSpeed=new t.Vec3ConstRandomValueShape,this._rotationSpeed.maxX=r.max.x,this._rotationSpeed.maxY=r.max.y,this._rotationSpeed.maxZ=r.max.z,this._rotationSpeed.minX=r.min.x,this._rotationSpeed.minY=r.min.y,this._rotationSpeed.minZ=r.min.z},r.prototype.build=function(t,e){for(var r,i,a,n=0,o=t.vertexCount/e,s=this._rotationSpeed.calculate(e),l=0;e>l;++l){var h=s[l];r=360*Math.random()-180,i=360*Math.random()-180,a=360*Math.random()-180;for(var u=0;o>u;++u)n=l*o+u,n=n*t.vertexAttLength+this.attribute_rotSpeedXYZ.offsetIndex,t.vertexArray[n+0]=h.x,t.vertexArray[n+1]=h.y,t.vertexArray[n+2]=h.z,n=l*o+u,n=n*t.vertexAttLength+this.attribute_rotBirthXYZ.offsetIndex,t.vertexArray[n+0]=r,t.vertexArray[n+1]=i,t.vertexArray[n+2]=a}},r.prototype.afterBuild=function(){this._rotationSpeed.dispose(),this._rotationSpeed=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._rotationSpeed=null},r}(t.AnimationNode);t.ParticleRotationXYZConstNode=e,__reflect(e.prototype,"egret3d.ParticleRotationXYZConstNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.name="ParticleScale",t}return __extends(r,e),r.prototype.initNode=function(e){var r=this._node=e;this._scaleValue=new t.ConstRandomValueShape,this._scaleValue.max=r.max,this._scaleValue.min=r.min},r.prototype.build=function(e,r){this._animationState=this.state;for(var i,a,n=this._scaleValue.calculate(r),o=(e.vertexCount/r,0),s=this._animationState.emitter.data.life.duration,l=this._animationState.emitter.timeNode.offsetIndex,h=0,u=0,c=0;r>c;++c)if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(i=h*e.vertexAttLength+l,a=e.vertexArray[i+0],o=a/s,o-=Math.floor(o),u=this._node.bezier1.calc(o),this._node.type==t.ParticleValueType.TwoBezier){var d=Math.random();u*=d,u+=this._node.bezier2.calc(o)*(1-d)}n[c]=u}else u=n[c];this._animationState.scaleBirthArray=n},r.prototype.afterBuild=function(){this._scaleValue.dispose(),this._scaleValue=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._node=null,this._scaleValue=null},r}(t.AnimationNode);t.ParticleScale=e,__reflect(e.prototype,"egret3d.ParticleScale")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.name="ParticleSizeGlobalNode",t}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this.attribute_scaleSizeConst=new t.GLSL.VarRegister,this.attribute_scaleSizeConst.name="attribute_scaleSizeConst",this.attribute_scaleSizeConst.size=1,this.attributes.push(this.attribute_scaleSizeConst),this.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_scaleSizeConst"),this._node&&(this._sizeScale=new t.ConstRandomValueShape,this._sizeScale.max=this._node.max,this._sizeScale.min=this._node.min,this._node.type==t.ParticleValueType.OneBezier?(this._floatCompressData1=this._node.bezier1.sampler(),this.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_scaleSizeBezier1")):this._node.type==t.ParticleValueType.TwoBezier&&(this.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_scaleSizeBezier2"),this._floatCompressData2=this._node.bezier1.sampler(),this._floatCompressData2=this._node.bezier2.sampler(),this.attribute_bezierRandomSeed=new t.GLSL.VarRegister,this.attribute_bezierRandomSeed.name="attribute_bezierRandomSeed",this.attribute_bezierRandomSeed.size=1,this.attributes.push(this.attribute_bezierRandomSeed)))},r.prototype.build=function(e,r){var i=this.state;this._scaleResult=i.scaleBirthArray;var a=0,n=e.vertexCount/r;if(this._node){if(this._node.type==t.ParticleValueType.TwoBezier)for(var o=0;r>o;++o)for(var s=Math.random(),l=0;n>l;++l)a=o*n+l,a=a*e.vertexAttLength+this.attribute_bezierRandomSeed.offsetIndex,e.vertexArray[a+0]=s;if(this._node.type==t.ParticleValueType.Const||this._node.type==t.ParticleValueType.RandomConst)for(var h=this._sizeScale.calculate(r),o=0;r>o;o++)this._scaleResult[o]*=h[o]}for(var o=0;r>o;++o)for(var l=0;n>l;++l)a=o*n+l,a=a*e.vertexAttLength+this.attribute_scaleSizeConst.offsetIndex,e.vertexArray[a+0]=this._scaleResult[o]},r.prototype.activeState=function(t,e,r,i,a,n,o){this._floatCompressData1&&o.uniform1fv(a.uniform_scaleSizeBezier1.uniformIndex,this._floatCompressData1),this._floatCompressData2&&o.uniform1fv(a.uniform_scaleSizeBezier2.uniformIndex,this._floatCompressData2)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressData1=null,this._floatCompressData2=null,this._node=null},r}(t.AnimationNode);t.ParticleSizeGlobalNode=e,__reflect(e.prototype,"egret3d.ParticleSizeGlobalNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.bornTime=0,t.life=0,t.id=0,t.timeIndex=0,t.name="ParticleStartColor",t}return __extends(r,e),r.prototype.initNode=function(t){this._node=t},r.prototype.build=function(e,r){this._animationState=this.state;for(var i=6,a=e.vertexCount/r,n=0,o=this._animationState.emitter.timeNode.offsetIndex,s=0,l=new t.Color,h=new t.Color,u=0,c=this._animationState.emitter.data.life.duration,d=1/255,p=0;r>p;++p){s=p*a,this.timeIndex=s*e.vertexAttLength+o,this.bornTime=e.vertexArray[this.timeIndex+0],u=this.bornTime/c,u-=Math.floor(u),this.lerpBirthColor(l,h,u),l.scaleBy(d);for(var f=0;a>f;++f)n=p*a+f,n=n*e.vertexAttLength+i,e.vertexArray[n+0]=l.r,e.vertexArray[n+1]=l.g,e.vertexArray[n+2]=l.b,e.vertexArray[n+3]=l.a}},r.prototype.lerpBirthColor=function(e,r,i){this._node.colorType==t.ParticleBirthColorType.Const?e.copyFrom(this._node.colorConst1):this._node.colorType==t.ParticleBirthColorType.RandomConst?e.randomColor(this._node.colorConst1,this._node.colorConst2,!0):this._node.colorType==t.ParticleBirthColorType.OneGradients?this._node.colorGradients1.lerpColor(i,e):this._node.colorType==t.ParticleBirthColorType.TwoGradients&&(this._node.colorGradients1.lerpColor(i,e),this._node.colorGradients2.lerpColor(i,r),e.lerp(e,r,.5))},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._node=null},r}(t.AnimationNode);t.ParticleStartColor=e,__reflect(e.prototype,"egret3d.ParticleStartColor")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return i._empty=!0,i.bornTime=0,i.life=0,i.id=0,i.timeIndex=0,i.count=0,i.position=new t.Vector3D,i._added=!1,i._orientation=new t.Quaternion,i._birthPhase=new r(t.ParticleDataSubEmitterPhase.BIRTH),i._collisionPhase=new r(t.ParticleDataSubEmitterPhase.COLLISION),i._deathPhase=new r(t.ParticleDataSubEmitterPhase.DEATH),i.name="ParticleSubEmitterNode",i}return __extends(i,e),i.prototype.initNode=function(t,e){void 0===e&&(e=null),this._parent=e},i.prototype.importSubEmitter=function(e,r){var i;e==t.ParticleDataSubEmitterPhase.BIRTH?i=this._birthPhase:e==t.ParticleDataSubEmitterPhase.COLLISION?i=this._collisionPhase:e==t.ParticleDataSubEmitterPhase.DEATH&&(i=this._deathPhase),i&&(this._empty=!1,i.importSubEmitter(r))},i.prototype.getSubEmitters=function(e){return e==t.ParticleDataSubEmitterPhase.BIRTH?this._birthPhase.playing.getKeys():e==t.ParticleDataSubEmitterPhase.COLLISION?this._collisionPhase.playing.getKeys():e==t.ParticleDataSubEmitterPhase.DEATH?this._deathPhase.playing.getKeys():null},i.prototype.build=function(t,e){this.count=e,this._animationState=this.state,this._lifeCircles=[],this.resetCircleData()},i.prototype.resetCircleData=function(){for(var t=0;t<this.count;t++)this._lifeCircles[t]=-1},i.prototype.update=function(t,e,r){if(!this._empty){this.recycleParticle(),this.ignoreEmit=e>25;var i=this._animationState.emitter.data,a=i.life.loop,n=this._animationState.modTime+i.life.duration+i.life.delay;if(a||!(.001*t>=n))for(var o=0,s=r.vertexCount/this.count,l=0,h=this._animationState.emitter.positionNode.offsetIndex,u=this._animationState.emitter.timeNode.offsetIndex,c=.001*t-i.life.delay,d=r.sharedVertexBuffer?r.sharedVertexBuffer.arrayBuffer:r.vertexArray,p=(this._animationState.followTarget||this._animationState.emitter,0);p<this.count;++p){l=p*s,this.timeIndex=l*r.vertexAttLength+u,this.bornTime=d[this.timeIndex+0],this.life=d[this.timeIndex+1];var f=-1;if(c>=this.bornTime){if(c>this.bornTime+this.life&&!a)continue;if(f=Math.floor((c-this.bornTime)/this._animationState.modTime),f!=this._lifeCircles[p]){if(this._lifeCircles[p]=f,this.ignoreEmit)continue;o=l*r.vertexAttLength+h,this.position.x=d[o+0],this.position.y=d[o+1],this.position.z=d[o+2],this.emitParticleAtPhase(this._birthPhase,this.position)}}}}},i.prototype.emitParticleAtPhase=function(e,r){var i,a,n,o,s=e.playing.getKeys();this._orientation.copyFrom(this._parent.orientation),this._orientation.w*=-1;for(var l=0,h=s.length;h>l;l++)i=s[l],n=e.recycle.getValueByKey(i),a=e.playing.getValueByKey(i),o=n.shift(),null==o&&(o=new t.ParticleEmitter(i.data,i.material)),a.push(o),o.play(1,!0,i.data.property.prewarm),o.position=r,o.orientation=this._orientation,this._parent.addChild(o)},i.prototype.recycleParticle=function(){this.recycleParticleAtPhase(this._birthPhase),this.recycleParticleAtPhase(this._collisionPhase),this.recycleParticleAtPhase(this._deathPhase)},i.prototype.recycleParticleAtPhase=function(t){for(var e,r,i,a,n,o=t.playing.getKeys(),s=0,l=o.length;l>s;s++)for(e=o[s],r=t.playing.getValueByKey(e),i=t.recycle.getValueByKey(e),n=r.length-1;n>=0;n--)a=r[n],a.loopProgress>1&&(r.splice(n,1),a.stop(),this._parent.removeChild(a),i.push(a))},i.prototype.activeState=function(t,e,r,i,a,n,o){},i.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._birthPhase&&this._birthPhase.dispose(),this._birthPhase=null,this._collisionPhase&&this._collisionPhase.dispose(),this._collisionPhase=null,this._deathPhase&&this._deathPhase.dispose(),this._deathPhase=null,this._lifeCircles=null,this._orientation=null,this._parent=null},i}(t.AnimationNode);t.ParticleSubEmitterNode=e,__reflect(e.prototype,"egret3d.ParticleSubEmitterNode");var r=function(){function e(e){this.playing=new t.DoubleArray,this.recycle=new t.DoubleArray,this._phase=e}return e.prototype.importSubEmitter=function(t){this.playing.getKeys().indexOf(t)>=0||(this.playing.put(t,[]),this.recycle.put(t,[]))},e.prototype.dispose=function(){for(var t,e=0,r=this.playing.getValues();e<r.length;e++)t=r[e],t.dispose();for(var i=0,a=this.recycle.getValues();i<a.length;i++)t=a[i],t.dispose();this.playing.clear(),this.recycle.clear(),this.playing=this.recycle=null},e}();t.ParticleSubEmitterNodePhase=r,__reflect(r.prototype,"egret3d.ParticleSubEmitterNodePhase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._sheetFloatData=new Float32Array(5),r.name="ParticleTextureSheetNode",r.attribute_textureSheetData=new t.GLSL.VarRegister,r.attribute_textureSheetData.name="attribute_textureSheetData",r.attribute_textureSheetData.size=3,r.attributes.push(r.attribute_textureSheetData),r.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_textureSheet_vs"),r}return __extends(r,e),r.prototype.initNode=function(e,r){this._sheetData=r,this._sheetFloatData[0]=this._sheetData.tileX,this._sheetFloatData[1]=this._sheetData.tileY,this._sheetFloatData[2]=this._sheetData.circles,this._sheetData.whole?(this._sheetFloatData[3]=0,this._sheetFloatData[4]=this._sheetData.tileX*this._sheetData.tileY-1):(this._sheetFloatData[3]=0,this._sheetFloatData[4]=this._sheetData.tileY-1),this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst?this.importShader(!1,t.ShaderPhaseType.start_fragment,"particle_textureSheetConst"):this._sheetData.frameType==t.ParticleValueType.OneBezier?(this.importShader(!1,t.ShaderPhaseType.start_fragment,"particle_textureSheetOneBezier"),this._floatCompressData1=this._sheetData.bezier1.sampler()):this._sheetData.frameType==t.ParticleValueType.TwoBezier&&(this.importShader(!1,t.ShaderPhaseType.start_fragment,"particle_textureSheetTwoBezier"),this._floatCompressData1=this._sheetData.bezier1.sampler(),this._floatCompressData2=this._sheetData.bezier2.sampler())},r.prototype.build=function(e,r){for(var i=0,a=0,n=0,o=0,s=e.vertexCount/r,l=0;r>l;++l){i=this._sheetData.whole?0:this._sheetData.randomRow?Math.floor(this._sheetData.tileY*Math.random())*this._sheetData.tileX:this._sheetData.row*this._sheetData.tileX,this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst?(a=(this._sheetData.max-this._sheetData.min)*Math.random()+this._sheetData.min,a=Math.floor(a)):a=0,n=this._sheetData.frameType==t.ParticleValueType.TwoBezier?Math.random():1;for(var h=0;s>h;++h)o=l*s+h,o=o*e.vertexAttLength+this.attribute_textureSheetData.offsetIndex,e.vertexArray[o+0]=i+.001,e.vertexArray[o+1]=a,e.vertexArray[o+2]=n}},r.prototype.activeState=function(e,r,i,a,n,o,s){s.uniform1fv(n.uniform_textureSheet.uniformIndex,this._sheetFloatData),this._sheetData.frameType==t.ParticleValueType.OneBezier?s.uniform1fv(n.uniform_frameBezier.uniformIndex,this._floatCompressData1):this._sheetData.frameType==t.ParticleValueType.TwoBezier&&(s.uniform1fv(n.uniform_frameBezier1.uniformIndex,this._floatCompressData1),s.uniform1fv(n.uniform_frameBezier2.uniformIndex,this._floatCompressData2))},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._floatCompressData1=this._floatCompressData2=null,this._sheetData=null,this._sheetFloatData=null},r}(t.AnimationNode);t.ParticleTextureSheetNode=e,__reflect(e.prototype,"egret3d.ParticleTextureSheetNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;r.name="ParticleSpeedNode";var i=t.Egret3DPolicy.useLowLoop?"particle_bezier_low":"particle_bezier";return r.importShader(!0,t.ShaderPhaseType.utils_vertex,i),r.importShader(!1,t.ShaderPhaseType.utils_fragment,i),r.importShader(!1,t.ShaderPhaseType.diffuse_fragment,"particle_diffuse_fragment"),r.attribute_time=new t.GLSL.VarRegister,r.attribute_time.name="attribute_time",r.attribute_time.size=3,r.attributes.push(r.attribute_time),r}return __extends(r,e),r.prototype.initNode=function(t){},r.prototype.build=function(t,e){this._animationState=this.state;for(var r,i=this._animationState.emitter.generator,a=t.vertexCount/e,n=0,o=i.planes,s=0;e>s;++s){r=o[s];for(var l=0;a>l;++l)n=s*a+l,n=n*t.vertexAttLength+this.attribute_time.offsetIndex,t.vertexArray[n+0]=r.x,t.vertexArray[n+1]=r.y,t.vertexArray[n+2]=s}this._animationState.modTime=i.loopTime,this._animationState.emitter.animation.loopTime=i.circleTime},r.prototype.afterBuild=function(){},Object.defineProperty(r.prototype,"offsetIndex",{get:function(){return this.attribute_time.offsetIndex},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null},r}(t.AnimationNode);t.ParticleTime=e,__reflect(e.prototype,"egret3d.ParticleTime")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._verticesDataDirty=!0,r.name="ParticleTrackPositionNode",r.importShader(!0,t.ShaderPhaseType.local_vertex,"particle_trackPosition"),r.attribute_trackPosition=new t.GLSL.VarRegister,r.attribute_trackPosition.name="attribute_trackPosition",r.attribute_trackPosition.size=3,r.attributes.push(r.attribute_trackPosition),r}return __extends(r,e),Object.defineProperty(r.prototype,"endCoords",{get:function(){return this._toCoords},enumerable:!0,configurable:!0}),r.prototype.trackPosition=function(t,e){if(t.length!=this._count||e.length!=this._count)throw new Error("count don't match!");for(var r,i=this._animationState.emitter.positionNode.offsetIndex,a=this._animationState.emitter.geometry,n=a.vertexCount/this._count,o=0;o<this._count;++o)for(var s=t[o],l=e[o],h=0;n>h;++h)r=o*n+h,r=r*a.vertexAttLength+i,a.vertexArray[r+0]=s.x,a.vertexArray[r+1]=s.y,a.vertexArray[r+2]=s.z,r=o*n+h,r=r*a.vertexAttLength+this.attribute_trackPosition.offsetIndex,a.vertexArray[r+0]=l.x,a.vertexArray[r+1]=l.y,a.vertexArray[r+2]=l.z;this._toCoords=e,this._verticesDataDirty=!0},r.prototype.activeState=function(t,e,r,i,a,n,o){this._verticesDataDirty&&(n.geometry.upload(o),this._verticesDataDirty=!1)},r.prototype.initNode=function(e){this._trackPosition=new t.CubeVector3DValueShape,this._trackPosition.depth=200,this._trackPosition.width=300,this._trackPosition.height=100},r.prototype.build=function(t,e){this._animationState=this.state,this._count=e},r.prototype.afterBuild=function(){this._trackPosition.dispose(),this._trackPosition=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._trackPosition=null},r}(t.AnimationNode);t.ParticleTrackPositionNode=e,__reflect(e.prototype,"egret3d.ParticleTrackPositionNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._uvRollData=new Float32Array(2),r.name="ParticleUVRollNode",r.importShader(!1,t.ShaderPhaseType.start_fragment,"particle_uv_roll_fs"),r}return __extends(r,e),r.prototype.initNode=function(t,e){this._methodData=e,this._uvRollData[0]=this._methodData.uSpeed,this._uvRollData[1]=this._methodData.vSpeed},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){o.uniform1fv(a.uniform_particleUVRoll.uniformIndex,this._uvRollData)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._methodData=null,this._uvRollData=null},r}(t.AnimationNode);t.ParticleUVRollNode=e,__reflect(e.prototype,"egret3d.ParticleUVRollNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityForceConstNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceConst"),r.attribute_accelerationSpeed=new t.GLSL.VarRegister,r.attribute_accelerationSpeed.name="attribute_velocityForceConst",r.attribute_accelerationSpeed.size=3,r.attributes.push(r.attribute_accelerationSpeed),r}return __extends(r,e),r.prototype.initNode=function(e){this._node=e;var r=this._node.velocityForce;this._forceValue=new t.Vec3ConstRandomValueShape,this._forceValue.maxX=r.max.x,this._forceValue.maxY=r.max.y,this._forceValue.maxZ=r.max.z,this._forceValue.minX=r.min.x,this._forceValue.minY=r.min.y,this._forceValue.minZ=r.min.z},r.prototype.build=function(t,e){for(var r=t.vertexCount/e,i=0,a=this._forceValue.calculate(e),n=0;e>n;++n)for(var o=a[n],s=0;r>s;++s)i=n*r+s,i=i*t.vertexAttLength+this.attribute_accelerationSpeed.offsetIndex,t.vertexArray[i+0]=o.x,t.vertexArray[i+1]=o.y,t.vertexArray[i+2]=o.z},r.prototype.afterBuild=function(){this._forceValue.dispose(),this._forceValue=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._forceValue=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityForceConstNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityForceConstNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.name="ParticleVelocityForceOneBezierNode",t}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this._floatCompressDataX=this._node.velocityForce.xBezier1.trySampler(),this._floatCompressDataY=this._node.velocityForce.yBezier1.trySampler(),this._floatCompressDataZ=this._node.velocityForce.zBezier1.trySampler(),this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezier"),this._floatCompressDataX&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierX"),this._floatCompressDataY&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierY"),this._floatCompressDataZ&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceOneBezierZ")},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){this._floatCompressDataX&&o.uniform1fv(a.uniform_velocityForceX.uniformIndex,this._floatCompressDataX),this._floatCompressDataY&&o.uniform1fv(a.uniform_velocityForceY.uniformIndex,this._floatCompressDataY),this._floatCompressDataZ&&o.uniform1fv(a.uniform_velocityForceZ.uniformIndex,this._floatCompressDataZ)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressDataX=this._floatCompressDataY=this._floatCompressDataZ=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityForceOneBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityForceOneBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityForceTwoBezierNode",r.attribute_randomSeed=new t.GLSL.VarRegister,r.attribute_randomSeed.name="attribute_velocityForceRandomSeed",r.attribute_randomSeed.size=1,r.attributes.push(r.attribute_randomSeed),r}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this._floatCompressDataX1=this._node.velocityForce.xBezier1.trySampler(),this._floatCompressDataY1=this._node.velocityForce.yBezier1.trySampler(),this._floatCompressDataZ1=this._node.velocityForce.zBezier1.trySampler(),this._floatCompressDataX2=this._node.velocityForce.xBezier2.trySampler(),this._floatCompressDataY2=this._node.velocityForce.yBezier2.trySampler(),this._floatCompressDataZ2=this._node.velocityForce.zBezier2.trySampler(),this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezier"),this._floatCompressDataX1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierX1"),this._floatCompressDataX2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierX2"),this._floatCompressDataY1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierY1"),this._floatCompressDataY2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierY2"),this._floatCompressDataZ1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierZ1"),this._floatCompressDataZ2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityForceTwoBezierZ2")},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=0;e>a;++a)for(var n=Math.random(),o=0;r>o;++o)i=a*r+o,i=i*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.vertexArray[i+0]=n},r.prototype.activeState=function(t,e,r,i,a,n,o){this._floatCompressDataX1&&o.uniform1fv(a.uniform_velocityForceX1.uniformIndex,this._floatCompressDataX1),this._floatCompressDataX2&&o.uniform1fv(a.uniform_velocityForceX2.uniformIndex,this._floatCompressDataX2),this._floatCompressDataY1&&o.uniform1fv(a.uniform_velocityForceY1.uniformIndex,this._floatCompressDataY1),this._floatCompressDataY2&&o.uniform1fv(a.uniform_velocityForceY2.uniformIndex,this._floatCompressDataY2),this._floatCompressDataZ1&&o.uniform1fv(a.uniform_velocityForceZ1.uniformIndex,this._floatCompressDataZ1),this._floatCompressDataZ2&&o.uniform1fv(a.uniform_velocityForceZ2.uniformIndex,this._floatCompressDataZ2)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressDataX1=this._floatCompressDataY1=this._floatCompressDataZ1=null,this._floatCompressDataX2=this._floatCompressDataY2=this._floatCompressDataZ2=null,this._node=null,this._animationState=null},r}(t.AnimationNode);t.ParticleVelocityForceTwoBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityForceTwoBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityLimitConstNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityLimitConst"),r.attribute_velocityLimit=new t.GLSL.VarRegister,r.attribute_velocityLimit.name="attribute_velocityLimit",r.attribute_velocityLimit.size=1,r.attributes.push(r.attribute_velocityLimit),r}return __extends(r,e),r.prototype.initNode=function(e){var r=e;this._limitValue=new t.ConstRandomValueShape,this._limitValue.max=r.velocityLimit.max,this._limitValue.min=r.velocityLimit.min},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=this._limitValue.calculate(e),n=0;e>n;++n)for(var o=a[n],s=0;r>s;++s)i=n*r+s,i=i*t.vertexAttLength+this.attribute_velocityLimit.offsetIndex,t.vertexArray[i+0]=o},r.prototype.afterBuild=function(){this._limitValue.dispose(),this._limitValue=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._animationState=null,this._limitValue=null},r}(t.AnimationNode);t.ParticleVelocityLimitConstNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityLimitConstNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityLimitOneBezierNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityLimitOneBezier"),r}return __extends(r,e),r.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.velocityLimit.bezier1.sampler()},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){o.uniform1fv(a.uniform_velocityLimit.uniformIndex,this._floatCompressData)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressData=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityLimitOneBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityLimitOneBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityLimitTwoBezierNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityLimitTwoBezier"),r.attribute_randomSeed=new t.GLSL.VarRegister,r.attribute_randomSeed.name="attribute_velocityLimitRandomSeed",r.attribute_randomSeed.size=1,r.attributes.push(r.attribute_randomSeed),r}return __extends(r,e),r.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.velocityLimit.bezier1.sampler(),this._floatCompressData2=this._node.velocityLimit.bezier2.sampler()},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=0;e>a;++a)for(var n=Math.random(),o=0;r>o;++o)i=a*r+o,i=i*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.vertexArray[i+0]=n},r.prototype.activeState=function(t,e,r,i,a,n,o){o.uniform1fv(a.uniform_velocityLimit.uniformIndex,this._floatCompressData),o.uniform1fv(a.uniform_velocityLimit2.uniformIndex,this._floatCompressData2)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressData=null,this._floatCompressData2=null,this._animationState=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityLimitTwoBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityLimitTwoBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocity"),r.attribute_velocity=new t.GLSL.VarRegister,r.attribute_velocity.name="attribute_velocity",r.attribute_velocity.size=3,r.attributes.push(r.attribute_velocity),r}return __extends(r,e),r.prototype.initNode=function(e){var r=this._node=e;(r.type==t.ParticleValueType.Const||r.type==t.ParticleValueType.RandomConst)&&(this._constValue=new t.ConstRandomValueShape,this._constValue.max=r.max,this._constValue.min=r.min)},r.prototype.build=function(e,r){this._animationState=this.state;var i,a=e.vertexCount/r,n=0;this._constValue&&(i=this._constValue.calculate(r));for(var o,s,l,h=this._animationState.directionArray,u=new t.Vector3D,c=0,d=this._animationState.emitter.data.life.duration,p=this._animationState.emitter.timeNode.offsetIndex,f=0,m=0;r>m;++m){if(f=m*a,this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(o=f*e.vertexAttLength+p,s=e.vertexArray[o+0],c=s/d,c-=Math.floor(c),l=this._node.bezier1.calc(c),this._node.type==t.ParticleValueType.TwoBezier){var _=Math.random();
l*=_,l+=this._node.bezier2.calc(c)*(1-_)}}else l=i[m];u.copyFrom(h[m]),u.scaleBy(l);for(var v=0;a>v;++v)n=m*a+v,n=n*e.vertexAttLength+this.attribute_velocity.offsetIndex,e.vertexArray[n+0]=u.x,e.vertexArray[n+1]=u.y,e.vertexArray[n+2]=u.z}},r.prototype.afterBuild=function(){this._constValue&&this._constValue.dispose(),this._constValue=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._constValue=null,this._animationState=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityOverConstNode",r.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverConst"),r.attribute_velocityOver=new t.GLSL.VarRegister,r.attribute_velocityOver.name="attribute_velocityOverConst",r.attribute_velocityOver.size=3,r.attributes.push(r.attribute_velocityOver),r}return __extends(r,e),r.prototype.initNode=function(e){var r=e;this._overValue=new t.Vec3ConstRandomValueShape,this._overValue.maxX=r.velocityOver.max.x,this._overValue.maxY=r.velocityOver.max.y,this._overValue.maxZ=r.velocityOver.max.z,this._overValue.minX=r.velocityOver.min.x,this._overValue.minY=r.velocityOver.min.y,this._overValue.minZ=r.velocityOver.min.z},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=this._overValue.calculate(e),n=0;e>n;++n)for(var o=a[n],s=0;r>s;++s)i=n*r+s,i=i*t.vertexAttLength+this.attribute_velocityOver.offsetIndex,t.vertexArray[i+0]=o.x,t.vertexArray[i+1]=o.y,t.vertexArray[i+2]=o.z},r.prototype.afterBuild=function(){this._overValue.dispose(),this._overValue=null},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._overValue=null,this._animationState=null},r}(t.AnimationNode);t.ParticleVelocityOverConstNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityOverConstNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.name="ParticleVelocityOverOneBezierNode",t}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this._floatCompressDataX=this._node.velocityOver.xBezier1.trySampler(),this._floatCompressDataY=this._node.velocityOver.yBezier1.trySampler(),this._floatCompressDataZ=this._node.velocityOver.zBezier1.trySampler(),this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezier"),this._floatCompressDataX&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierX"),this._floatCompressDataY&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierY"),this._floatCompressDataZ&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverOneBezierZ")},r.prototype.build=function(t,e){},r.prototype.activeState=function(t,e,r,i,a,n,o){this._floatCompressDataX&&o.uniform1fv(a.uniform_velocityOverX.uniformIndex,this._floatCompressDataX),this._floatCompressDataY&&o.uniform1fv(a.uniform_velocityOverY.uniformIndex,this._floatCompressDataY),this._floatCompressDataZ&&o.uniform1fv(a.uniform_velocityOverZ.uniformIndex,this._floatCompressDataZ)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressDataX=this._floatCompressDataY=this._floatCompressDataZ=null,this._node=null},r}(t.AnimationNode);t.ParticleVelocityOverOneBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityOverOneBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.name="ParticleVelocityOverTwoBezierNode",r.attribute_randomSeed=new t.GLSL.VarRegister,r.attribute_randomSeed.name="attribute_velocityOverRandomSeed",r.attribute_randomSeed.size=1,r.attributes.push(r.attribute_randomSeed),r}return __extends(r,e),r.prototype.initNode=function(e){this._node=e,this._floatCompressDataX1=this._node.velocityOver.xBezier1.trySampler(),this._floatCompressDataY1=this._node.velocityOver.yBezier1.trySampler(),this._floatCompressDataZ1=this._node.velocityOver.zBezier1.trySampler(),this._floatCompressDataX2=this._node.velocityOver.xBezier2.trySampler(),this._floatCompressDataY2=this._node.velocityOver.yBezier2.trySampler(),this._floatCompressDataZ2=this._node.velocityOver.zBezier2.trySampler(),this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezier"),this._floatCompressDataX1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierX1"),this._floatCompressDataX2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierX2"),this._floatCompressDataY1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierY1"),this._floatCompressDataY2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierY2"),this._floatCompressDataZ1&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierZ1"),this._floatCompressDataZ2&&this.importShader(!0,t.ShaderPhaseType.global_vertex,"particle_velocityOverTwoBezierZ2")},r.prototype.build=function(t,e){this._animationState=this.state;for(var r=t.vertexCount/e,i=0,a=0;e>a;++a)for(var n=Math.random(),o=0;r>o;++o)i=a*r+o,i=i*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.vertexArray[i+0]=n},r.prototype.activeState=function(t,e,r,i,a,n,o){this._floatCompressDataX1&&o.uniform1fv(a.uniform_velocityOverX1.uniformIndex,this._floatCompressDataX1),this._floatCompressDataX2&&o.uniform1fv(a.uniform_velocityOverX2.uniformIndex,this._floatCompressDataX2),this._floatCompressDataY1&&o.uniform1fv(a.uniform_velocityOverY1.uniformIndex,this._floatCompressDataY1),this._floatCompressDataY2&&o.uniform1fv(a.uniform_velocityOverY2.uniformIndex,this._floatCompressDataY2),this._floatCompressDataZ1&&o.uniform1fv(a.uniform_velocityOverZ1.uniformIndex,this._floatCompressDataZ1),this._floatCompressDataZ2&&o.uniform1fv(a.uniform_velocityOverZ2.uniformIndex,this._floatCompressDataZ2)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._floatCompressDataX1=this._floatCompressDataY1=this._floatCompressDataZ1=null,this._floatCompressDataX2=this._floatCompressDataY2=this._floatCompressDataZ2=null,this._node=null,this._animationState=null},r}(t.AnimationNode);t.ParticleVelocityOverTwoBezierNode=e,__reflect(e.prototype,"egret3d.ParticleVelocityOverTwoBezierNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.enablePick=!1}return Object.defineProperty(e,"instance",{get:function(){return e._instance||(e._instance=new e),e._instance},enumerable:!0,configurable:!0}),e.prototype.update=function(e,r,i,a,n){t.Egret3DCanvas.context3DProxy.clearColor(1,1,1,1),t.Egret3DCanvas.context3DProxy.clear(t.Context3DProxy.gl.COLOR_BUFFER_BIT|t.Context3DProxy.gl.DEPTH_BUFFER_BIT)},e.prototype.drawOver=function(e,r,i,a,n){t.Context3DProxy.gl.readPixels(0,0,this.pickRender.renderTexture.width,this.pickRender.renderTexture.height,t.Context3DProxy.gl.RGBA,t.Context3DProxy.gl.UNSIGNED_BYTE,this.piexs)},e.prototype.getObjectId=function(t,e,r,i){var a=t-i.x,n=e-i.y;n=i.height-n;var o=Math.floor(a/i.width*this.pickRender.renderTexture.width),s=Math.floor(n/i.height*this.pickRender.renderTexture.height),l=s*this.pickRender.renderTexture.width+o;return this.piexs[4*l+0]<<16|this.piexs[4*l+1]<<8|this.piexs[4*l+2]},e}();t.PickSystem=e,__reflect(e.prototype,"egret3d.PickSystem");var r=function(e){function r(){var r=e.call(this)||this;return r.useDelay=1e3,r._select=!1,r._selectSure=!1,r._count=0,r._pickProgressEvent=new t.PickEvent3D("pick_Progress"),r._pickSureEvent=new t.PickEvent3D("pick_Sure"),r._pickCancleEvent=new t.PickEvent3D("pick_cancle"),r._sceneRay=new t.Ray,r}return __extends(r,e),r.prototype.update=function(e,r,i){this._sceneRay.CalculateAndTransformRay(e.width,e.height,e.camera3D.modelMatrix,e.camera3D.projectMatrix,.5*e.width,.5*e.height);var a,n=e.entityCollect.specialCastItem[t.SpecialCast.Pick],o=t.MathUtil.MAX_VALUE;this._selection&&(o=t.Vector3D.distance(e.camera3D.position,this._selection.position));var s=0;this._select=!1;for(var l=0;l<n.length;l++)a=n[l].bound,this._sceneRay.IntersectMesh(a.vexData,a.indexData,a.vexLength,a.indexData.length/3,0,n[l].modelMatrix,n[l].pickResult)&&(this._select=!0,s=t.Vector3D.distance(e.camera3D.position,n[l].position),o>s&&(this._count=0,o=s,this._selection&&(this._pickCancleEvent.pickTarget=this._selection,this.dispatchEvent(this._pickCancleEvent)),this._selection=n[l]));this._select&&this._selection?(this._count++,this._pickProgressEvent.pickTarget=this._selection,this._pickProgressEvent.delay=this._count,this.dispatchEvent(this._pickProgressEvent),this._count>this.useDelay&&!this._selectSure&&(this._selectSure=!0,this._pickSureEvent.pickTarget=this._selection,this.dispatchEvent(this._pickSureEvent))):this._selection&&(this._pickCancleEvent.pickTarget=this._selection,this.dispatchEvent(this._pickCancleEvent),this._selectSure=!1,this._selection=null,this._select=!1,this._count=0)},r}(t.EventDispatcher);r.PICK_PROGRESS="pick_Progress",r.PICK_SURE="pick_Sure",r.PICK_CANCLE="pick_cancle",t.EyePick=r,__reflect(r.prototype,"egret3d.EyePick")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){var n=e.call(this,null,i)||this;return i.bothside=!0,n._method=new t.GrassMethod(a),i.diffusePass.addMethod(n._method),n._data=a,n._birthPoints=r,n._count=r.length,n._plantShape=new t.PlaneGeometry(1,1,1,1,1,1,t.Vector3D.Z_AXIS,!0,!1),n.initialize(),n.initBoudBox(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE)),n}return __extends(r,e),Object.defineProperty(r.prototype,"method",{get:function(){return this._method},enumerable:!0,configurable:!0}),r.prototype.initialize=function(){this.geometry=new t.Geometry,this.geometry.buildDefaultSubGeometry(),this.geometry.subGeometrys[0].count=this._count*this._plantShape.indexCount;var e=0,r=[],i=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_NORMAL;this.geometry.vertexFormat=i,this.initGeometryAttr(this.geometry),this.geometry.vertexCount=this._count*this._plantShape.vertexCount,this.geometry.indexCount=this._count*this._plantShape.indexCount,this._plantShape.getVertexForIndex(0,i,r,this._plantShape.vertexCount);for(var a=0;a<this._count;++a)e=a*this._plantShape.vertexCount,this.geometry.setVerticesForIndex(e,i,r,this._plantShape.vertexCount);for(var a=0;a<this._count;++a)for(var n=0;n<this._plantShape.indexArray.length;++n)this.geometry.indexArray[a*this._plantShape.indexArray.length+n]=this._plantShape.indexArray[n]+a*this._plantShape.vertexCount;this.initPostionData(this.geometry,this._count)},r.prototype.initGeometryAttr=function(e){this._attrPosition=new t.GLSL.VarRegister,this._attrPosition.name="attribute_grassOffset",this._attrPosition.size=3;var r=e.vertexAttLength;this._attrPosition.offsetIndex=r,e.vertexAttLength+=this._attrPosition.size,e.vertexSizeInBytes+=4*this._attrPosition.size,e.subGeometrys[0].preAttList.push(this._attrPosition),this._attrAngleY=new t.GLSL.VarRegister,this._attrAngleY.name="attribute_grassAngleY",this._attrAngleY.size=1;var r=e.vertexAttLength;this._attrAngleY.offsetIndex=r,e.vertexAttLength+=this._attrAngleY.size,e.vertexSizeInBytes+=4*this._attrAngleY.size,e.subGeometrys[0].preAttList.push(this._attrAngleY)},r.prototype.initBoudBox=function(e){var r=new t.BoundBox(this);r.fillBox(new t.Vector3D(-e.x/2,-e.y/2,-e.z/2),new t.Vector3D(e.x/2,e.y/2,e.z/2)),this.bound=r,this.initAABB()},r.prototype.update=function(t,r,i){e.prototype.update.call(this,t,r,i)},r.prototype.initPostionData=function(e,r){for(var i=this._birthPoints,a=e.vertexCount/r,n=0,o=this._attrPosition.offsetIndex,s=0;r>s;++s)for(var l=i[s],h=0;a>h;++h)n=s*a+h,n=n*e.vertexAttLength+o,e.vertexArray[n+0]=l.x,e.vertexArray[n+1]=l.y,e.vertexArray[n+2]=l.z;var u,c;if(1!=this._data.maxWidth||1!=this._data.minWidth||1!=this._data.maxHeight||1!=this._data.minHeight)for(var s=0;r>s;++s){u=t.MathUtil.mix(this._data.minWidth,this._data.maxWidth,Math.random()),c=t.MathUtil.mix(this._data.minHeight,this._data.maxHeight,Math.random());for(var h=0;a>h;++h)n=s*a+h,n=n*e.vertexAttLength+0,e.vertexArray[n+0]*=u,e.vertexArray[n+1]*=c}var d,p=6,f=new t.Color,m=10*Math.abs(this._data.noiseSpread),_=1/255,v=new t.Color,g=new t.Color;v.setColorRGB(Number(this._data.healthyColor)),g.setColorRGB(Number(this._data.dryColor));for(var s=0;r>s;++s){d=Math.random()*m,d>1&&(d=1),d*=d,f.lerp(v,g,d),f.scaleBy(_);for(var h=0;a>h;++h)n=s*a+h,n=n*e.vertexAttLength+p,e.vertexArray[n+0]*=f.r,e.vertexArray[n+1]*=f.g,e.vertexArray[n+2]*=f.b,e.vertexArray[n+3]=1}if(!this._data.billboard)for(var y,x=this._attrAngleY.offsetIndex,s=0;r>s;++s){y=2*Math.random()*Math.PI;for(var h=0;a>h;++h)n=s*a+h,n=n*e.vertexAttLength+x,e.vertexArray[n+0]=y}this.billboard=this._data.billboard?t.BillboardType.Y_AXIS:t.BillboardType.DISABLE},r.prototype.clone=function(){var t;return t=new r(this._birthPoints.slice(),this.material,this._data),t.position=this.position,t.orientation=this.orientation,t.scale=this.scale,t},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._plantShape&&(this._plantShape.dispose(),this._plantShape=null),this._birthPoints=null,this._data=null},r}(t.Mesh);t.GrassMesh=e,__reflect(e.prototype,"egret3d.GrassMesh");var r=function(){function t(){this.minWidth=100,this.maxWidth=100,this.minHeight=100,this.maxHeight=100,this.noiseSpread=0,this.billboard=!0}return t}();t.GrassData=r,__reflect(r.prototype,"egret3d.GrassData")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this)||this;return i._time=0,i._windSpeed=200,i._windStrength=.2,i._shakeScale=.1,i._windDirection=new t.Vector3D(1,0,0),i._windSpace=new t.Vector3D(400,0,300),i._windData=new Float32Array(9),i._squeezeData=new Float32Array(6),i._lightMapData=new Float32Array(5),i._lightMapTexture=t.CheckerboardTexture.texture,i._data=r,i.vsShaderList[t.ShaderPhaseType.start_vertex]=i.vsShaderList[t.ShaderPhaseType.start_vertex]||[],i.vsShaderList[t.ShaderPhaseType.start_vertex].push("grass_vs"),i.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=i.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],i.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("grass_fs"),i.fillGrassData(),i.start(),i}return __extends(r,e),r.prototype.setLightMapData=function(e,r){this._lightMapRect=r,this._lightMapTexture=e||t.CheckerboardTexture.texture,this.updateLightMapData()},r.prototype.updateLightMapData=function(){this._lightMapTexture&&this._lightMapTexture!=t.CheckerboardTexture.texture&&this._lightMapRect?(this._lightMapData[0]=1,this._lightMapData[1]=this._lightMapRect.x,this._lightMapData[2]=this._lightMapRect.y,this._lightMapData[3]=this._lightMapRect.width,this._lightMapData[4]=this._lightMapRect.height):this._lightMapData[0]=0,this.materialData.lightMapTexture=this._lightMapTexture,this.materialData.textureChange=!0},r.prototype.setWind=function(t,e,r,i,a){void 0===r&&(r=100),void 0===i&&(i=.1),void 0===a&&(a=1),t.y=0,this._windDirection.copyFrom(t),this._windDirection.normalize(),this._windSpace.copyFrom(e),this._windStrength=i,this._windSpeed=r,this._shakeScale=a,this.fillGrassData()},r.prototype.updateSqueezeData=function(t,e,r,i){void 0===r&&(r=20),void 0===i&&(i=1),this._squeezeData[0]=e?1:0,this._squeezeData[1]=t.x,this._squeezeData[2]=t.y,this._squeezeData[3]=t.z,this._squeezeData[4]=r,this._squeezeData[5]=i},r.prototype.fillGrassData=function(){this._windData[0]=this._windDirection.x,this._windData[1]=this._windDirection.z,this._windData[2]=this._windSpace.x,this._windData[3]=this._windSpace.z,this._windData[4]=this._windStrength,this._windData[5]=this._windSpeed,this._windData[6]=this._shakeScale},r.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},r.prototype.stop=function(){this._start=!1},r.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_grass_data.uniformIndex=a.getUniformLocation(r.program3D,"uniform_grass_data"),r.uniform_squeeze_data.uniformIndex=a.getUniformLocation(r.program3D,"uniform_squeeze_data"),r.uniform_lightMap_data.uniformIndex=a.getUniformLocation(r.program3D,"uniform_lightMap_data")},r.prototype.activeState=function(t,e,r,i,a,n,o){this._start&&(this._time+=e),this._windData[7]=this._time/1e3,this._windData[8]=this._data.billboard?1:0,a.uniform1fv(r.uniform_grass_data.uniformIndex,this._windData),a.uniform1fv(r.uniform_squeeze_data.uniformIndex,this._squeezeData),a.uniform1fv(r.uniform_lightMap_data.uniformIndex,this._lightMapData)},r}(t.MethodBase);t.GrassMethod=e,__reflect(e.prototype,"egret3d.GrassMethod")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=.15),this._debugHud=new t.HUD,this.bloom_amount=e,this.postRender=new t.PostRender("hud_vs","bloom_fs"),this.postRender.hud.uniformData.bloom_amount={uniformIndex:-1,type:t.UniformType.uniform1f,data:[e]}}return e.prototype.setRenderTexture=function(e,r,i){(!this.postRender.renderTexture||i)&&this.postRender.setRenderToTexture(e,r,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)},e.prototype.draw=function(t,e,r,i,a,n,o){var s=this;s.postRender.camera=a,s.postRender.needClean=!0,this.postRender.hud.uniformData.bloom_amount.data[0]=s.bloom_amount,s.postRender.draw(t,e,r,i,n,o),o["final"]=this.postRender.renderTexture},e}();t.BloomPost=e,__reflect(e.prototype,"egret3d.BloomPost",["egret3d.IPost"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.postRender=new t.PostRender("hud_vs","colorCorrection_fs")}return e.prototype.setRenderTexture=function(t,e){this.postRender.setRenderToTexture(t,e)},Object.defineProperty(e.prototype,"lutTexture",{get:function(){return this._lutTexture},set:function(t){this._lutTexture=t,this.postRender.hud.lutTexture=t},enumerable:!0,configurable:!0}),e.prototype.draw=function(t,e,r,i,a,n,o){this.postRender.camera=a,this.postRender.needClean=!0,this.postRender.draw(t,e,r,i,n,o),o["final"]=this.postRender.renderTexture},e}();t.ColorCorrectionPost=e,__reflect(e.prototype,"egret3d.ColorCorrectionPost",["egret3d.IPost"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._debugHud=new t.HUD,this._h_postRender=new t.PostRender("hud_vs","gaussian_H_fs"),this._h_postRender.setRenderToTexture(2048,2048,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this._v_postRender=new t.PostRender("hud_vs","gaussian_V_fs")}return e.prototype.setRenderTexture=function(e,r){this._v_postRender.setRenderToTexture(e,r,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)},e.prototype.draw=function(t,e,r,i,a,n,o){this._h_postRender.camera=a,this._h_postRender.needClean=!0,this._h_postRender.draw(t,e,r,i,n,o),o["final"]=this._h_postRender.renderTexture,this._v_postRender.camera=a,this._v_postRender.needClean=!0,this._v_postRender.draw(t,e,r,i,n,o),this._v_postRender.color=o.source,o["final"]=this._v_postRender.renderTexture},e}();t.GaussPost=e,__reflect(e.prototype,"egret3d.GaussPost",["egret3d.IPost"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._debugHud=new t.HUD,this.postRender=new t.PostRender("hud_vs","gaussian_H_fs")}return e.prototype.setRenderTexture=function(t,e){this.postRender.setRenderToTexture(t,e)},e.prototype.draw=function(t,e,r,i,a,n,o){this.postRender.camera=a,this.postRender.needClean=!0,this.postRender.draw(t,e,r,i,n,o),o["final"]=this.postRender.renderTexture},e}();t.Gbuffer=e,__reflect(e.prototype,"egret3d.Gbuffer",["egret3d.IPost"])}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.prototype.isDimensionValid=function(e){return e>=1&&e<=t.MAX_SIZE&&this.isPowerOfTwo(e)},t.prototype.isPowerOfTwo=function(t){return t?(t&-t)==t:!1},t.prototype.getBestPowerOf2=function(e){for(var r=1;e>r;)r<<=1;return r>t.MAX_SIZE&&(r=t.MAX_SIZE),r},t}();e.MAX_SIZE=2048,t.SizeUtil=e,__reflect(e.prototype,"egret3d.SizeUtil"),t.sizeUtil=new e;var r=function(){function e(e){this.posTex={},this.hud=new t.HUD,this._sizeChange=!1,this._renderQuen=e,this.postArray=[]}return e.prototype.draw=function(e,r,i,a,n,o){var s,l,h=this;if(h._renderQuen.mainRender.renderTexture||(l=n.maxWidthAndHeight,this._renderQuen.mainRender.setRenderToTexture(l.x,l.y,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)),h.finalTexture=h.posTex["final"]=h.posTex.source=h._renderQuen.mainRender.renderTexture,h.postArray.length>2)for(var u=0;u<h.postArray.length-1;u++)s=h.postArray[u],s.renderQuen=h._renderQuen,s.setRenderTexture(l.x,l.y),s.draw(e,r,i,a,n,o,h.posTex),h.finalTexture=h.posTex["final"];s=h.postArray[h.postArray.length-1],s.renderQuen=h._renderQuen,s.draw(e,r,i,a,n,o,h.posTex)},e}();t.PostProcessing=r,__reflect(r.prototype,"egret3d.PostProcessing")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.useDepthPass=!1,this.useNormalPass=!1,this.useColorPass=!1,this.useSpecularPass=!1,this.debugHUD=new t.HUD}return e.prototype.drawRenderBuffer=function(t,e,r,i,a,n){void 0===n&&(n=null)},e}();t.PostRenderBuffer=e,__reflect(e.prototype,"egret3d.PostRenderBuffer")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){t[t.diffuse=0]="diffuse",t[t.normal=1]="normal",t[t.specular=2]="specular",t[t.color=3]="color",t[t.shadow=4]="shadow"}(e=t.TextureMethodType||(t.TextureMethodType={}));var r;!function(t){t[t.utils_vertex=0]="utils_vertex",t[t.base_vertex=1]="base_vertex",t[t.start_vertex=2]="start_vertex",t[t.local_vertex=3]="local_vertex",t[t.global_vertex=4]="global_vertex",t[t.end_vertex=5]="end_vertex",t[t.utils_fragment=6]="utils_fragment",t[t.base_fragment=7]="base_fragment",t[t.start_fragment=8]="start_fragment",t[t.materialsource_fragment=9]="materialsource_fragment",t[t.diffuse_fragment=10]="diffuse_fragment",t[t.normal_fragment=11]="normal_fragment",t[t.matCap_fragment=12]="matCap_fragment",t[t.specular_fragment=13]="specular_fragment",t[t.shadow_fragment=14]="shadow_fragment",t[t.lighting_fragment=15]="lighting_fragment",t[t.multi_end_fragment=16]="multi_end_fragment",t[t.end_fragment=17]="end_fragment"}(r=t.ShaderPhaseType||(t.ShaderPhaseType={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=t.PassType.diffusePass);var i=e.call(this)||this;return i.pass=r,i}return __extends(r,e),r.prototype.draw=function(e,r,i,a,n,o,s){void 0===s&&(s=null),this.renderTexture?(this.renderTexture.upload(i),this.renderTexture.useMipmap=!1,i.setRenderToTexture(this.renderTexture.texture2D,!0,!0,0),this.viewPort.setTo(0,0,this.renderTexture.texture2D.width,this.renderTexture.texture2D.height)):this.viewPort.copyFrom(n);for(var l=0,h=a.renderList.length;h>l;l++){var u=a.renderList[l];u.geometry.activeState(e,r,t.Egret3DCanvas.context3DProxy,this.camera);for(var c=0;c<u.geometry.subGeometrys.length;c++){var d=u.geometry.subGeometrys[c],p=d.matID,f=u.multiMaterial[p];if(null!=f&&(f.passes[this._pass]||t.PassUtil.PassAuto[this._pass])){f.passes[this._pass]||f.creatPass(this._pass);for(var m=f.passes[this._pass].length-1;m>=0;m--)f.passes[this._pass][m].draw(e,r,i,u.modelMatrix,this.camera,d,u,o)}}}this.renderTexture&&(this.viewPort.copyFrom(n),i.setRenderToBackBuffer(),i.viewPort(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height),i.setScissorRectangle(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height))},r}(t.RenderBase);t.MultiRender=e,__reflect(e.prototype,"egret3d.MultiRender")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){var a=e.call(this)||this;return a.hud=new t.HUD,a.needClean=!1,a.hud.vsShader=r,a.hud.fsShader=i,a}return __extends(r,e),r.prototype.setRenderToTexture=function(e,r,i){void 0===i&&(i=t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.renderTexture=new t.RenderTexture(e,r,i)},r.prototype.draw=function(t,e,r,i,a,n){i.renderList.length;this.renderTexture&&(this.renderTexture.upload(r),r.setRenderToTexture(this.renderTexture.texture2D,this.needClean,!0,0)),this.hud.viewPort=this.camera.viewPort,this.hud.x=this.camera.viewPort.x,this.hud.y=this.camera.viewPort.y,this.hud.width=this.camera.viewPort.width,this.hud.height=this.camera.viewPort.height,this.hud.diffuseTexture=n["final"],this.hud.colorTexture=n.source,this.hud.draw(r,this.camera),this.renderTexture&&r.setRenderToBackBuffer(),a&&(r.viewPort(a.x,a.y,a.width,a.height),r.setScissorRectangle(a.x,a.y,a.width,a.height))},r}(t.RenderBase);t.PostRender=e,__reflect(e.prototype,"egret3d.PostRender")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.cameraAnimationFrames=[],this._playing=!1,this._playTime=0,this._currentFrameIndex=0,this._loop=!0,this._smooth=!0,this._cameraAnimationFrame=new r,this._event=new t.Event3D,this._quatCurrentFrame=new t.Quaternion,this._quatnNextFrame=new t.Quaternion,this._quatn=new t.Quaternion,this._camera=e,this._cameraAnimationFrame.fov=45,this._cameraAnimationFrame.rotation=new t.Vector3D,this._cameraAnimationFrame.translation=new t.Vector3D}return e.prototype.bindCamera=function(t){this._camera=t},e.prototype.play=function(t){this.cameraAnimationFrames.length<=0||(this._loop=t,this._playTime=0,this._camera.isController=!1,this._playing=!0)},e.prototype.stop=function(){this._camera.isController=!0,this._playing=!1},e.prototype.update=function(t,r){if(this._playing){this._playTime+=5*r;var i=this._playTime%(this.cameraAnimationFrames[this.cameraAnimationFrames.length-1].time-this.cameraAnimationFrames[0].time+160),a=Math.floor(i/160)%this.cameraAnimationFrames.length;this._currentFrameIndex>a&&(this._loop||(this._playing=!1,this._camera.isController=!0),this._camera&&(this._event.eventType=e.EVENT_CAMERA_COMPLETE,this._camera.dispatchEvent(this._event))),this._currentFrameIndex=a;var n=this.cameraAnimationFrames[a];if(this._smooth){var o=(a+1)%this.cameraAnimationFrames.length,s=this.cameraAnimationFrames[o],l=(i-n.time)/Math.abs(s.time-n.time);this._cameraAnimationFrame.fov=(s.fov-n.fov)*l+n.fov,this._quatCurrentFrame.fromEulerAngles(n.rotation.x,n.rotation.y,n.rotation.z),this._quatnNextFrame.fromEulerAngles(s.rotation.x,s.rotation.y,s.rotation.z),this._quatn.lerp(this._quatCurrentFrame,this._quatnNextFrame,l),this._quatn.toEulerAngles(this._cameraAnimationFrame.rotation),this._cameraAnimationFrame.translation.lerp(n.translation,s.translation,l)}else this._cameraAnimationFrame.fov=n.fov,this._cameraAnimationFrame.rotation.copyFrom(n.rotation),this._cameraAnimationFrame.translation.copyFrom(n.translation);this._camera.rotation=this._cameraAnimationFrame.rotation,this._camera.position=this._cameraAnimationFrame.translation}},e}();e.EVENT_CAMERA_COMPLETE="event_camera_complete",t.CameraAnimationController=e,__reflect(e.prototype,"egret3d.CameraAnimationController");var r=function(){function t(){}return t}();t.CameraAnimationFrame=r,__reflect(r.prototype,"egret3d.CameraAnimationFrame")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.renderDictionary=[],this.renderArray=[];var e=new t.MultiRender(t.PassType.diffusePass);this.setMainRender(e)}return e.prototype.setMainRender=function(t){this.mainRender=t},e.prototype.addRender=function(t,e){void 0===e&&(e=-1);var e=this.renderArray.indexOf(t);this.renderDictionary[t.name]=t,-1==e&&(-1==e?this.renderArray.push(t):this.renderArray.splice(e,-1,t))},e.prototype.removeRender=function(t){var e=this.renderArray.indexOf(t);this.renderDictionary[t.name]&&delete this.renderDictionary[t.name],-1!=e&&this.renderArray.splice(e,1,t)},e.prototype.draw=function(t,e,r,i,a,n){void 0===n&&(n=null);var o;for(o=0;o<this.renderArray.length;o++)this.renderArray[o].enabled&&this.renderArray[o].draw(t,e,r,i,a,this,n);this.mainRender&&this.mainRender.draw(t,e,r,i,a,this,n)},e}();t.RenderQuen=e,__reflect(e.prototype,"egret3d.RenderQuen")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r._tree=new t.TreeBase(r),r}return __extends(r,e),Object.defineProperty(r.prototype,"quad",{get:function(){return this._quad},enumerable:!0,configurable:!0}),r.prototype.infrustumList=function(t){return this._tree.infrustumList(t)},r.prototype.createQuadTree=function(){this._quad=new t.QuadRoot(16,2500);var e=new Array;this.collectQuadList(e,this),this._quad.createQuadTree(e)},r.prototype.collectQuadList=function(e,r){e=e||new Array;var i;r instanceof t.Mesh&&(i=r,i.aabb&&e.push(i));var a;if(r.childs&&r.childs.length>0)for(var n=0,o=r.childs;n<o.length;n++)a=o[n],this.collectQuadList(e,a);return e},r.prototype.clone=function(){var t=new r;return t.copy(this),t},r}(t.Object3D);t.Scene3D=e,__reflect(e.prototype,"egret3d.Scene3D")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this._searchList=new Array,this._root=t}return t.prototype.infrustumList=function(t){return this._searchList.length=0,this._searchList},t}();t.TreeBase=e,__reflect(e.prototype,"egret3d.TreeBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.addProgram=function(e){t.programlib.add(e.name,e)},t.removeProgram=function(e){var r=t.getProgram(e);r.dispose(),t.programlib.remove(e)},t.getProgram=function(e){return t.programlib.getValue(e)},t}();e.programlib=new t.HashMap,t.ShaderCache=e,__reflect(e.prototype,"egret3d.ShaderCache")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.name="",this.source="",this.funcNames=new Array,this.funcDict={},this.structDict={},this.structNames=new Array,this.attributeList=new Array,this.varyingList=new Array,this.uniformList=new Array,this.constList=new Array,this.tempList=new Array,this.sampler2DList=new Array,this.sampler3DList=new Array,this.extensionList=new Array,this.defineList=new Array}return t.prototype.addVar=function(t){"attribute"==t.key?this.attributeList.push(t):"varying"==t.key?this.varyingList.push(t):"uniform"==t.key?this.uniformList.push(t):"const"==t.key?this.constList.push(t):"sampler2D"==t.key?this.sampler2DList.push(t):"samplerCube"==t.key?this.sampler3DList.push(t):"#extension"==t.key?this.extensionList.push(t):"#define"==t.key?this.defineList.push(t):this.tempList.push(t)},t.prototype.addFunc=function(t,e){if(this.funcDict[t]){var r=this.mergeMainFunc(this.funcDict[t],e);this.funcDict[t]=r}else this.funcDict[t]=e,this.funcNames.push(t);if(this.funcDict.main){var i=this.funcNames.indexOf("main");this.funcNames.splice(i,1),this.funcNames.push("main")}},t.prototype.addStruct=function(t,e){this.structDict[t]?console.log("<"+t+">struct重复"):(this.structDict[t]=e,this.structNames.push(t))},t.prototype.addContent=function(t){for(var e=0;e<t.structNames.length;++e)this.addStruct(t.structNames[e],t.structDict[t.structNames[e]]);for(var e=0;e<t.funcNames.length;++e)this.addFunc(t.funcNames[e],t.funcDict[t.funcNames[e]]);for(var e=0;e<t.attributeList.length;++e){for(var r=!0,i=0;i<this.attributeList.length;++i)if(t.attributeList[e].name==this.attributeList[i].name){t.attributeList[e].valueType!=this.attributeList[i].valueType||t.attributeList[e].key!=this.attributeList[i].key,r=!1;break}r&&this.attributeList.push(t.attributeList[e].clone())}for(var e=0;e<t.varyingList.length;++e){for(var r=!0,i=0;i<this.varyingList.length;++i)if(t.varyingList[e].name==this.varyingList[i].name){t.varyingList[e].valueType!=this.varyingList[i].valueType||t.varyingList[e].key!=this.varyingList[i].key,r=!1;break}r&&this.varyingList.push(t.varyingList[e].clone())}for(var e=0;e<t.uniformList.length;++e){for(var r=!0,i=0;i<this.uniformList.length;++i)if(t.uniformList[e].name==this.uniformList[i].name){t.uniformList[e].valueType!=this.uniformList[i].valueType||t.uniformList[e].key!=this.uniformList[i].key,r=!1;break}r&&this.uniformList.push(t.uniformList[e].clone())}for(var e=0;e<t.constList.length;++e){for(var r=!0,i=0;i<this.constList.length;++i)if(t.constList[e].name==this.constList[i].name){t.constList[e].valueType!=this.constList[i].valueType||t.constList[e].key!=this.constList[i].key,r=!1;
break}r&&this.constList.push(t.constList[e].clone())}for(var e=0;e<t.tempList.length;++e){for(var r=!0,i=0;i<this.tempList.length;++i)if(t.tempList[e].name==this.tempList[i].name){t.tempList[e].valueType!=this.tempList[i].valueType||t.tempList[e].key!=this.tempList[i].key,r=!1;break}r&&this.tempList.push(t.tempList[e].clone())}for(var e=0;e<t.sampler2DList.length;++e){for(var r=!0,i=0;i<this.sampler2DList.length;++i)if(t.sampler2DList[e].name==this.sampler2DList[i].name){t.sampler2DList[e].valueType!=this.sampler2DList[i].valueType||t.sampler2DList[e].key!=this.sampler2DList[i].key,r=!1;break}r&&this.sampler2DList.push(t.sampler2DList[e].clone())}for(var e=0;e<t.sampler3DList.length;++e){for(var r=!0,i=0;i<this.sampler3DList.length;++i)if(t.sampler3DList[e].name==this.sampler3DList[i].name){t.sampler2DList[e].valueType!=this.sampler3DList[i].valueType||t.sampler3DList[e].key!=this.sampler3DList[i].key,r=!1;break}r&&this.sampler3DList.push(t.sampler3DList[e].clone())}for(var e=0;e<t.extensionList.length;++e){for(var r=!0,i=0;i<this.extensionList.length;++i)if(t.extensionList[e].name==this.extensionList[i].name){r=!1;break}r&&this.extensionList.push(t.extensionList[e].clone())}for(var e=0;e<t.defineList.length;++e){for(var r=!0,i=0;i<this.defineList.length;++i)if(t.defineList[e].name==this.defineList[i].name){r=!1;break}r&&this.defineList.push(t.defineList[e].clone())}},t.prototype.mergeMainFunc=function(t,e){var r=t,i="",a=e.indexOf("{"),n=e.lastIndexOf("}");a++,i=e.slice(a,n),a=r.lastIndexOf("}");var o=r.substr(0,a),s=r.substr(a,r.length-a);r=o,r+=i;var l="";return r+=l,r+=s},t.prototype.clone=function(){var e=new t;e.name=this.name,e.source=this.source;for(var r=0;r<this.funcNames.length;++r)e.funcNames.push(this.funcNames[r]);for(var i in this.funcDict)e.funcDict[i]=this.funcDict[i];for(var r=0;r<this.structNames.length;++r)e.structNames.push(this.structNames[r]);for(var i in this.structDict)e.structDict[i]=this.structDict[i];for(var r=0;r<this.attributeList.length;++r)e.attributeList.push(this.attributeList[r].clone());for(var r=0;r<this.varyingList.length;++r)e.varyingList.push(this.varyingList[r].clone());for(var r=0;r<this.uniformList.length;++r)e.uniformList.push(this.uniformList[r].clone());for(var r=0;r<this.constList.length;++r)e.constList.push(this.constList[r].clone());for(var r=0;r<this.tempList.length;++r)e.tempList.push(this.tempList[r].clone());for(var r=0;r<this.sampler2DList.length;++r)e.sampler2DList.push(this.sampler2DList[r].clone());for(var r=0;r<this.sampler3DList.length;++r)e.sampler3DList.push(this.sampler3DList[r].clone());for(var r=0;r<this.attributeList.length;++r)e.attributeList.push(this.attributeList[r].clone());for(var r=0;r<this.extensionList.length;++r)e.extensionList.push(this.extensionList[r].clone());for(var r=0;r<this.defineList.length;++r)e.defineList.push(this.defineList[r].clone());return e},t}();t.ShaderContent=e,__reflect(e.prototype,"egret3d.GLSL.ShaderContent")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.createProgram=function(r,i,a){var n=e.generateShaderSource(r,i),o=e.createShader(n,t.ShaderType.VertexShader,r.toName()+i),s=(e.generateShaderSource(r,a),e.createShader(n,t.ShaderType.FragmentShader,r.toName()+a)),l=e.createProgramLogic(o,s);return o.dispose(),s.dispose(),l.name},e.createShader=function(e,r,i){var a=t.Context3DProxy.gl.createShader(r);t.Context3DProxy.gl.shaderSource(a,e),t.Context3DProxy.gl.compileShader(a);var n=new t.Shader(a);return n.name=i,n},e.createProgramLogic=function(e,r){var i=t.Context3DProxy.gl.createProgram();if(t.Context3DProxy.gl.attachShader(i,e.shader),t.Context3DProxy.gl.attachShader(i,r.shader),t.Context3DProxy.gl.linkProgram(i),t.Egret3DEngine.instance.debug){var a=t.Context3DProxy.gl.getProgramParameter(i,t.Context3DProxy.gl.LINK_STATUS);a||(console.log("vsShader error"+t.Context3DProxy.gl.getShaderInfoLog(e.shader)),console.log("fsShader error"+t.Context3DProxy.gl.getShaderInfoLog(r.shader)),console.log("program error"+t.Context3DProxy.gl.getProgramInfoLog(i)))}var n=new t.Program3D(i);return n.name=e.name+r.name,t.ShaderCache.addProgram(n),n},e.generateShaderSource=function(r,i){for(var a=r.keys(),n=a.length,o="",s=0;n>s;s++)1==r[a[s]]&&(o+="#define "+a[s]+"\n");var l="";return e._processIncludes(t.ShaderStore.lib[i],function(t){o+=t,l=o}),l},e._processIncludes=function(r,i){for(var a=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,n=a.exec(r),o=new String(r);null!=n;){var s=n[1];if(t.ShaderStore.lib[s]){var l=t.ShaderStore.lib[s];if(n[2])for(var h=n[3].split(","),u=0;u<h.length;u+=2){var c=new RegExp(h[u],"g"),d=h[u+1];l=l.replace(c,d)}if(n[4]){var p=n[5];if(-1!==p.indexOf("..")){var f=p.split(".."),m=parseInt(f[0]),_=parseInt(f[1]),v=l.slice(0);l="",isNaN(_)&&(_=e._indexParameters[f[1]]);for(var g=m;_>=g;g++)l+=v.replace(/\{X\}/g,g.toString())+"\n"}else l=l.replace(/\{X\}/g,p)}o=o.replace(n[0],l)}n=a.exec(r)}i(o)},e}();e._indexParameters={},t.ShaderGenerator=e,__reflect(e.prototype,"egret3d.ShaderGenerator")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.lib={AOMap_fs:"uniform sampler2D aoTexture ;\nuniform float aoPower ;\nvoid main(void){\n    float ao = texture2D( aoTexture , varying_uv1 ).x ;\n	diffuseColor.xyz *= (ao * aoPower) ; \n}\n",AmbientOcclusion:"varying vec2 varying_uv0;\nuniform sampler2D positionPass;\nuniform sampler2D normalPass;\nvoid main(){\n    gl_FragColor = texture2D(positionPass,varying_uv0) + texture2D(normalPass,varying_uv0) ;\n}\n",FakePBR_fs:"#extension GL_OES_standard_derivatives:enable\n#define max_directLight 1 \nstruct DirectLight{\n   vec3 direction;\n	 vec3 diffuse;\n	 vec3 ambient;\n};\nuniform float uniform_directLightSource[9*max_directLight] ;\nvarying vec4 varying_mvPose; \nvarying vec3 varying_eyeNormal; \nvarying vec2 varying_uv0; \nuniform sampler2D albedoTex; \nuniform sampler2D normalTex; \nuniform sampler2D glossTex; \nuniform sampler2D specularTex; \nuniform sampler2D opacityTex; \nuniform samplerCube reflectionMap;\nuniform mat4 uniform_ViewMatrix; \nmat3 TBN; \nmat4 normalMatrix ;\nvec3 normalDirection;\nvec3 light;\nvec3 normalTexColor ;\nvec4 opacityTexColor ;\nvec4 glossTexColor ;\nvec4 specularTexColor ;\nvec4 albedoTexColor ;\nvec2 uv_0;\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvec3 unpackNormal(vec4 packednormal)\n{\n	return packednormal.xyz * 2.0 - 1.0;\n}\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \nvec3 dp1 = dFdx(p); \nvec3 dp2 = dFdy(p); \nvec2 duv1 = dFdx(uv); \nvec2 duv2 = dFdy(uv);  \nvec3 dp2perp = cross(dp2, N); \nvec3 dp1perp = cross(N, dp1); \nvec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \nvec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \nfloat invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \nreturn mat3(T * invmax, B * invmax, N); \n}\nvec3 fakePBRLight( vec3 lightDir , vec3 viewDir , vec3 lightColor , vec3 ambient ){\n    vec3 lightDirection = mat3(uniform_ViewMatrix) * normalize(lightDir);\n    vec3 halfDirection = normalize( lightDirection + viewDir) ;\n    float attenuation = 1.0 ;    vec3 attenColor = attenuation * lightColor;\n    float Pi = 3.141592654;\n    float InvPi = 0.31830988618;\n    float gloss = glossTexColor.r;\n    float specPow = exp2( gloss * 10.0 + 1.0 );\n    float NdotL = max(0.0, dot( normalDirection, lightDirection ));\n    float specularMonochrome = max( max(specularTexColor.r, specularTexColor.g), specularTexColor.b);\n    float normTerm = (specPow + 8.0 ) / (8.0 * Pi);\n    vec3 directSpecular =  (floor(attenuation) * lightColor ) * pow(max(0.0,dot(halfDirection,normalDirection)),normTerm) * specularTexColor.xyz * normTerm ;\n    vec3 specular = directSpecular;\n    NdotL = max(0.0,dot( normalDirection , normalize(lightDirection) ));\n    vec3 directDiffuse = max( 0.0, NdotL) * attenColor;\n    vec3 indirectDiffuse = vec3(0.0,0.0,0.0);\n		 indirectDiffuse +=  ambient ;    vec3 diffuseColor = albedoTexColor.rgb;\n    diffuseColor *= 1.0-specularMonochrome;\n    vec3 diffuse = (directDiffuse + indirectDiffuse) * diffuseColor;\n    vec3 finalColor = diffuse + specular ;\n    return finalColor ;\n}\nvoid calculateDirectLight(  ){\n    float lambertTerm , specular ; \n    vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    for(int i = 0 ; i < max_directLight ; i++){ \n         DirectLight directLight ; \n         directLight.direction = vec3(uniform_directLightSource[i*10],uniform_directLightSource[i*10+1],uniform_directLightSource[i*10+2]); \n         directLight.diffuse = vec3(uniform_directLightSource[i*10+3],uniform_directLightSource[i*10+4],uniform_directLightSource[i*10+5]); \n         directLight.ambient = vec3(uniform_directLightSource[i*10+6],uniform_directLightSource[i*10+7],uniform_directLightSource[i*10+8]); \n         dir = normalize(directLight.direction) ; \n         light.xyz += fakePBRLight( dir , viewDir , directLight.diffuse , directLight.ambient); \n    }\n}\nvoid main(void){ \n     TBN = cotangentFrame(normalize(varying_eyeNormal), normalize(-varying_mvPose.xyz) , uv_0); \n  \n     albedoTexColor = texture2D(albedoTex, varying_uv0 );\n      normalTexColor = unpackNormal(texture2D(normalTex, uv_0 )) ; \n     opacityTexColor = texture2D(opacityTex, uv_0 ) ; \n     glossTexColor = texture2D(glossTex, uv_0 );\n     specularTexColor = texture2D(specularTex, uv_0 );\n     normalDirection = TBN * normalTexColor.xyz ;\n     if( (step(materialSource.cutAlpha,opacityTexColor.g) - 0.5) < 0.0 ){\n        discard;\n     }\n     calculateDirectLight();\n     vec4 finalRGBA = vec4(light,1.0) ;     gl_FragColor = finalRGBA;   \n}",FakePBR_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec4 varying_mvPose;\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvec4 outPosition; \nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvoid main(void){ \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    varying_mvPose = mvMatrix * vec4( attribute_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    varying_uv0 = attribute_uv0 ;\n    \n    outPosition = uniform_ProjectionMatrix * varying_mvPose ; \n    gl_Position = outPosition; \n}",MultiUVSprite_fs:"uniform vec4 multiUV ; \nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    vec2 scale = vec2(1.0/multiUV.xy) ; \n    float a = mod(multiUV.w , multiUV.x) ;\n    float b = (multiUV.w / multiUV.x) - fract(multiUV.w / multiUV.x) ; \n    vec2 rec = scale * vec2(a,b) + uv_0 * scale;\n	diffuseColor = texture2D(diffuseTexture , rec ); \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n}\n",SSAO:"#define DL 2.399963229728653\n#define EULER 2.718281828459045\nvarying vec2 varying_uv0; \nfloat aoClamp =  0.5 ; \nfloat lumInfluence =  0.5 ; \nconst vec2 size =  vec2(512.0,512.0); \nconst int samples =  64; \nconst float radius =  2.0; \nconst bool useNoise =  false; \nconst float noiseAmount =  0.00000003; \nconst float diffArea =  0.4; \nconst float gDisplace =  0.4; \nuniform sampler2D positionPass; \nuniform sampler2D normalPass; \nuniform sampler2D colorPass; \nvec2 rand( vec2 coord ) { \nvec2 noise; \nif ( useNoise ) { \nfloat nx = dot ( coord, vec2( 12.9898, 78.233 ) ); \nfloat ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 ); \nnoise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 ); \n} else { \nfloat ff = fract( 1.0 - coord.s * ( size.x / 2.0 ) ); \nfloat gg = fract( coord.t * ( size.y / 2.0 ) ); \nnoise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg; \n} \nreturn ( noise * 2.0  - 1.0 ) * noiseAmount; \n}\nfloat readDepth(vec2 coord){ \nfloat cameraNear = 1.0 ; \nfloat cameraFar = 10000.0; \nfloat cameraFarPlusNear = cameraFar + cameraNear; \nfloat cameraFarMinusNear = cameraFar - cameraNear; \nfloat cameraCoef = 2.0 * cameraNear; \nreturn texture2D(positionPass,coord).z / (cameraFar-cameraNear); \n}\nfloat compareDepths( const in float depth1, const in float depth2, inout int far ) { \nfloat garea = 2.0; \nfloat diff = ( depth1 - depth2 ) * 100.0; \nif ( diff < gDisplace ) { \ngarea = diffArea; \n} else { \nfar = 1; \n} \nfloat dd = diff - gDisplace; \nfloat gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) ); \nreturn gauss; \n}\nfloat calcAO( float depth, float dw, float dh ) { \nfloat dd = radius - depth * radius; \nvec2 vv = vec2( dw, dh ); \nvec2 vUv = varying_uv0 ; \nvec2 coord1 = vUv + dd * vv; \nvec2 coord2 = vUv - dd * vv; \nfloat temp1 = 0.0; \nfloat temp2 = 0.0; \nint far = 0; \ntemp1 = compareDepths( depth, readDepth( coord1 ), far ); \nif ( far > 0 ) { \ntemp2 = compareDepths( readDepth( coord2 ), depth, far ); \ntemp1 += ( 1.0 - temp1 ) * temp2; \n} \nreturn temp1; \n}\nvoid main(){ \nvec2 noise = rand( varying_uv0 ); \nfloat depth = readDepth( varying_uv0 ); \nfloat tt = clamp( depth, aoClamp, 1.0 ); \nfloat w = ( 1.0 / size.x )  / tt + ( noise.x * ( 1.0 - noise.x ) ); \nfloat h = ( 1.0 / size.y ) / tt + ( noise.y * ( 1.0 - noise.y ) ); \nfloat ao = 0.0; \nfloat dz = 1.0 / float( samples ); \nfloat z = 1.0 - dz / 2.0; \nfloat l = 0.0; \nfor ( int i = 0; i <= samples; i ++ ) { \nfloat r = sqrt( 1.0 - z ); \nfloat pw = cos( l ) * r; \nfloat ph = sin( l ) * r; \nao += calcAO( depth, pw * w, ph * h ); \nz = z - dz; \nl = l + DL; \n} \nao /= float( samples ); \nao = 1.0 - ao; \nvec3 color = texture2D(colorPass,varying_uv0).xyz ; \nvec3 lumcoeff = vec3( 0.299, 0.587, 0.114 ); \nfloat lum = dot( color.rgb, lumcoeff ); \nvec3 luminance = vec3( lum ); \nvec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) ); \ngl_FragColor = vec4( final, 1.0 ); \n}",alphaMask_fs:"uniform sampler2D maskTexture ;\nvoid main(void){\n	float maskAlpha = texture2D( maskTexture , uv_0 ).x;\n	if(maskAlpha * diffuseColor.w < 0.001){\n		discard;\n	}\n    materialSource.alpha *= maskAlpha;\n}\n",baseShadowPass_fs:"varying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec4 outColor ; \nvec2 uv_0;\nvoid main() {\n	uv_0 = varying_uv0;\n}",baseShadowPass_vs:"attribute vec3 attribute_position;\nattribute vec2 attribute_uv0;\nattribute vec4 attribute_color;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec4 outPosition ;\nvoid main(void){\n    e_position = attribute_position;\n    varying_color = attribute_color;\n    varying_uv0 = attribute_uv0;\n}",base_fs:"#extension GL_OES_standard_derivatives : enable\nvarying vec3 varying_eyeNormal  ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nuniform mat4 uniform_ViewMatrix ;\nstruct SurfaceOutput{\n  vec3 Albedo;\n  vec3 Normal;\n  vec4 Specular;\n  float Alpha ;\n};\nSurfaceOutput s ;\nvec4 outColor ;\nvec4 diffuseColor ;\nvec4 light ;\nvec3 normal;\nvec2 uv_0;\nvec3 flatNormals(vec3 pos) {\n  vec3 fdx = dFdx(pos);\n  vec3 fdy = dFdy(pos);\n  return normalize(cross(fdx, fdy));\n}\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n  return F0 + (1.0-F0) * pow( 1.0 - cosT, 5.0);\n}\nvoid main() {\n	diffuseColor  = vec4(1.0);\n	light         = vec4(0.0,0.0,0.0,-1.0); \n     \n    normal = normalize(varying_eyeNormal) ;\n	uv_0 = varying_uv0;\n}",base_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec3 e_normal = vec3(0.0, 0.0, 0.0);\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec3 varying_eyeNormal  ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec4 outPosition ;\nmat4 rotVertexMatrix;\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvoid main(void){\n	e_position = attribute_position;\n	e_normal = attribute_normal;\n	varying_color = attribute_color;\n	varying_uv0 = attribute_uv0;\n}",bezier:"vec2 quadratic_bezier(vec2 A, vec2 B, vec2 C, float t)\n{\n    vec2 D = mix(A, B, t);\n    vec2 E = mix(B, C, t); \n    return mix(D, E, t);\n}\nvec2 cubic_bezier(vec2 A, vec2 B, vec2 C, vec2 D, float t)\n{\n    vec2 E = mix(A, B, t);\n    vec2 F = mix(B, C, t);\n    vec2 G = mix(C, D, t);\n    return quadratic_bezier(E, F, G, t);\n}",bloom_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nuniform float bloom_amount = 0.15;\nvoid main(void) { \n	vec2 uv = vec2( varying_uv0.x , 1.0-varying_uv0.y );\n	vec4 color = texture2D(diffuseTexture, uv); \n  	vec4 sum = vec4(0), add = vec4(0), val = texture2D(diffuseTexture, uv);\n  \n        for( int i = -4 ; i < 4; i++) {\n             for ( int j = -4; j < 4; j++) {\n                 add += texture2D(diffuseTexture, uv + vec2(j, i)*0.002) * bloom_amount;\n             }\n        }\n	if (val.r < 0.2) { sum = add*add*0.012 + val; } else \n	if (val.r < 0.5) { sum = add*add*0.009 + val; } else {\n      sum = add*add*0.0075 + val;\n  }\n	gl_FragColor = vec4(sum.rgb, 1.0);\n}",colorCorrectionRamp_fs:"precision highp float;            	\nvarying vec2 varying_uv0; \nuniform float saturation; \nuniform sampler2D diffuseTexture; \nuniform sampler2D lutTexture; \nfloat Luminance( vec3 c ){ \nreturn dot( c , vec3(0.22,0.707,0.071) ); \n}\nvoid main() \n{ \nvec2 uv = varying_uv0 ; \nvec4 color = texture2D(diffuseTexture, uv); \nfloat red = texture2D(lutTexture, color.rr).r ;\nfloat green = texture2D(lutTexture,color.gg ).g ;\nfloat blue = texture2D(lutTexture, color.bb ).b ;\ncolor = vec4(red,green,blue, color.a); \ngl_FragColor = color ; \n}",colorCorrection_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform sampler2D lutTexture;\nuniform float saturation ;\nfloat Luminance( vec3 c ){\n    return dot( c , vec3(0.22,0.707,0.071) );\n}\nvoid main()\n{\n     vec2 uv = varying_uv0 ; \n	 vec4 color = texture2D(diffuseTexture, uv); \n		\n	 vec3 red = texture2D(lutTexture, vec2(color.r, 0.5/4.0)).rgb * vec3(1.0,0.0,0.0);\n	 vec3 green = texture2D(lutTexture, vec2(color.g, 1.5/4.0)).rgb * vec3(0.0,1.0,0.0);\n	 vec3 blue = texture2D(lutTexture, vec2(color.b, 2.5/4.0)).rgb * vec3(0.0,0.0,1.0);\n	 \n	 color = vec4(red+green+blue, color.a);\n	 float lum = Luminance(color.rgb);\n     gl_FragColor = color ;\n}",colorGradients_fs:"varying vec4 varying_mvPose;\nuniform float uniform_colorGradientsSource[6] ;\nvoid main(void){\n	float posStartY = uniform_colorGradientsSource[0]; \n	float posEndY = uniform_colorGradientsSource[1]; \n	vec4 color = vec4(uniform_colorGradientsSource[2], uniform_colorGradientsSource[3], uniform_colorGradientsSource[4], uniform_colorGradientsSource[5]); \n	color.w *= clamp((varying_mvPose.y - posStartY) / (posEndY - posStartY), 0.0, 1.0); \n	color.xyz *= color.w;\n	outColor.xyz = outColor.xyz * (1.0 - color.w) + color.xyz * color.w; \n	\n}\n ",colorPassEnd_fs:"void main() {\n	 gl_FragColor = vec4(diffuseColor.xyz,1.0);\n}",colorTransform_fs:"uniform float uniform_colorTransformAlpha ;\nuniform mat4 uniform_colorTransformM44 ;\nvoid main(){\n	diffuseColor.xyz = (uniform_colorTransformM44 * vec4(diffuseColor.xyz, 1.0)).xyz;\n	diffuseColor.w *= diffuseColor.w * uniform_colorTransformAlpha;\n}\n",color_fragment:"void main() {\n	s.Albedo.xyz = vec3(1.0, 1.0, 1.0);\n	s.Alpha = 1.0 ; \n  \n	if( varying_color.w < materialSource.cutAlpha ){ \n		discard; \n	}\n}",combin_fs:"uniform sampler2D colorTexture;\nvoid main(void){\n}",cube_fragment:"uniform samplerCube diffuseTexture3D ;\nvarying vec3 varying_pos;\nvec4 diffuseColor ;\nvoid main() {\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	vec3 uvw = normalize(varying_pos.xyz);\n	diffuseColor = vec4(textureCube(diffuseTexture3D, uvw.xyz));\n    \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}else\n		diffuseColor.xyz *= diffuseColor.w ;\n}",cube_vertex:"varying vec3 varying_pos;\nvoid main(void){\n   varying_pos =  e_position;\n} ",detail_Bending_vs:"uniform float uniformTime[4] ;\nvoid main(void){\n	e_position = attribute_position; \nvarying_uv0 = attribute_uv0; \n  \n  varying_color = attribute_color; \nvec4 curve = SmoothTriangleWave(vec4(sin(uniformTime[0]*0.001),1.0,1.0,1.0));\n e_position.xyz += curve.x * vec3(1.0,0.5,0.0) * ( attribute_color.xyz) ;\n}",diffuse_fragment:"uniform sampler2D diffuseTexture;\nvarying vec4 varying_mvPose;\nvoid main() {\n  	vec3 fc = vec3(0.0, 0.0, 0.0);\n	vec4 c = texture2D( diffuseTexture , uv_0 );\n	c.a = materialSource.alpha * c.a;\n    c.xyz = c.xyz * materialSource.diffuse * c.a; \n	if (c.a < materialSource.cutAlpha)\n		discard;\n	if(materialSource.refraction<2.41){ \n       float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n       fc = Fresnel_Schlick(vl,vec3(materialSource.refraction)) * materialSource.refractionintensity ; \n       fc.xyz = max(fc,vec3(0.0)) ; \n    } \n	s.Normal = normal;\n	s.Specular = vec4(1.0) ;\n	s.Albedo = c.rgb + fc.xyz * c.rgb + materialSource.ambient * c.rgb;\n    s.Albedo.x = pow(s.Albedo.x, materialSource.gamma);\n    s.Albedo.y = pow(s.Albedo.y, materialSource.gamma);\n    s.Albedo.z = pow(s.Albedo.z, materialSource.gamma);\n	s.Alpha = c.a;\n	outColor.xyz = s.Albedo * 0.5 ;\n	outColor.w = s.Alpha;\n}\n",diffuse_vertex:"attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_mvPose; \nvoid main(void){\n    \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    \n    outPosition = varying_mvPose ; \n    varying_color = attribute_color; \n    \n}\n",directLight_fragment:"const int max_directLight = 0 ;\nuniform float uniform_directLightSource[10*max_directLight] ;\nvarying vec4 varying_mvPose; \nuniform mat4 uniform_ViewMatrix;\nmat4 normalMatrix ;\nstruct DirectLight{\n    vec3 direction;\n	vec3 diffuse;\n	vec3 ambient;\n    float intensity;\n};\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvec4 calculateDirectLight( MaterialSource materialSource ){ \n    float lambertTerm , specular ; \n    vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    diffuseColor = vec4(0.0,0.0,0.0,1.0);\n    for(int i = 0 ; i < max_directLight ; i++){ \n        DirectLight directLight ; \n        directLight.direction = (normalMatrix * vec4(uniform_directLightSource[i*10],uniform_directLightSource[i*10+1],uniform_directLightSource[i*10+2],0.0)).xyz; \n		directLight.diffuse = vec3(uniform_directLightSource[i*10+3],uniform_directLightSource[i*10+4],uniform_directLightSource[i*10+5]); \n		directLight.ambient = vec3(uniform_directLightSource[i*10+6],uniform_directLightSource[i*10+7],uniform_directLightSource[i*10+8]); \n		directLight.intensity = uniform_directLightSource[i*10+9] ; \n		dir = normalize(directLight.direction) ; \n		diffuseColor += LightingBlinnPhong(dir,directLight.diffuse,directLight.ambient,s.Normal,viewDir,directLight.intensity); \n    } \n    return diffuseColor ;\n}\nvoid main() {\n	normalMatrix = inverse(uniform_ViewMatrix);\n	normalMatrix = transpose(normalMatrix);\n	light += calculateDirectLight( materialSource ).xyzw ; \n}\n",endShadowPass_fs:"void main() {\n    if(varying_color.w<=0.0){\n       discard;\n    }\n    outColor.x =  outColor.y = outColor.z = varying_ViewPose.z/varying_ViewPose.w  ;\n    outColor.w = 1.0 ;\n    gl_FragColor = outColor ;\n}\n",endShadowPass_vs:"void main() {\n	 outPosition = uniform_ProjectionMatrix * outPosition ;\n     gl_Position = outPosition ;\n}\n                      ",end_fs:"varying vec4 varying_mvPose; \nvec4 diffuseColor ;\nvec4 specularColor ;\nvec4 ambientColor;\nvec4 light ;\nvoid main() {\n	if(light.w < 0.0 ){\n	   outColor.xyz = s.Albedo.xyz ; \n	}else{\n	   outColor.xyzw = light ; \n	}\n    outColor.xyzw *= varying_color.xyzw;\n}\n",end_vs:"vec4 endPosition ;\nuniform float uniform_materialSource[20];\nvoid main() {\n	 gl_PointSize = uniform_materialSource[17];\n     outPosition = uniform_ProjectionMatrix * outPosition ;\n}\n                      ",environmentDiffuse_vertex:"\nvoid main(){\n}\n",environmentMapping_fragment:"uniform samplerCube environmentMapTex ;\nuniform float reflectValue;\nvarying vec3 varying_ViewDir ;\nvoid main(){\n	 vec3 N = normalize(normal);\n	vec3 V = normalize(varying_mvPose.xyz/varying_mvPose.w);\n	float dotNV = clamp(dot(N,V), 0.0, 1.0);	float FV = pow((1.0 - dotNV), 2.0);\n	\n	mat4 invViewMatrix = inverse(uniform_ViewMatrix);\n	vec3 ecReflected = reflect(normalize(varying_ViewDir.xyz), normalize(mat3(invViewMatrix)*normal));	vec4 reflectiveColor = textureCube(environmentMapTex,-normalize(ecReflected.xyz)); \n	diffuseColor.xyz = mix( diffuseColor.xyz,reflectiveColor.xyz, reflectValue + FV );  \n	\n}\n         ",expFog_fs:"struct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   vec3 distance ;\n};\nvarying vec4 varying_pos;\nuniform float uniform_globalFog[7];\nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.distance = vec2(uniform_globalFog[4], uniform_globalFog[5]); \n    float d = distance(uniform_eyepos,varying_pos.xyz); \n    float distFog = max( 0.0 , d - fog.distance.x )* fog.distance.y; \n    float fogFactor = (1.0-exp( -distFog * 0.000001 * fog.globalDensity )) ; \n    diffuseColor.xyz = mix( diffuseColor.xyz  , fog.fogColor , min(fogFactor,1.0) ); \n}\n ",expHeightFog_fs:"struct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   float fogStartDistance ;\n   float fogHeightStart ;\n   float fogAlpha ;\n};\nvarying vec4 varying_pos;\nuniform float uniform_globalFog[7];\nvec3 applyFog( float yDistance, vec3  vpos , Fog fog ) \n{\n    float d = distance(uniform_eyepos,varying_pos.xyz); \n    float distFog = max( 0.0 , d - fog.fogStartDistance ) ; \n    float yFog = max(0.0, (vpos.y - fog.fogHeightStart - yDistance) )  ; \n    float fogAmount =  1.0-(exp(-distFog * fog.globalDensity )) + (exp(-yFog * fog.globalDensity )); \n    return mix( diffuseColor.xyz,fog.fogColor, clamp(fogAmount,0.0,fog.fogAlpha) );\n}\n \nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.fogStartDistance = uniform_globalFog[4] ; \n    fog.fogHeightStart = uniform_globalFog[5] ;\n    fog.fogAlpha = uniform_globalFog[6] ; \n    fog.fogColor *= diffuseColor.w;\n    float yd = uniform_eyepos.y - varying_pos.y ;\n    diffuseColor.xyz = applyFog( yd , varying_pos.xyz , fog );\n}\n ",flatNormal_fs:"#extension GL_OES_standard_derivatives : enable\nvec3 flatNormal(vec3 pos){\n    vec3 fdx = dFdx(pos);\n    vec3 fdy = dFdy(pos);\n    return normalize(cross(fdx, fdy));\n}",gamma_fs:"\nconst float gamma = 2.2;\nfloat toLinear_float_v1(float v) {\n  return pow(v, gamma);\n}\nvec2 toLinear_vec2_v1(vec2 v) {\n  return pow(v, vec2(gamma));\n}\nvec3 toLinear_vec3_v1(vec3 v) {\n  return pow(v, vec3(gamma));\n}\nvec4 toLinear_vec4_v1(vec4 v) {\n  return vec4(toLinear_vec3_v1(v.rgb), v.a);\n}\nfloat toGamma_float_v2(float v) {\n  return pow(v, 1.0 / gamma);\n}\nvec2 toGamma_vec2_v2(vec2 v) {\n  return pow(v, vec2(1.0 / gamma));\n}\nvec3 toGamma_vec3_v2(vec3 v) {\n  return pow(v, vec3(1.0 / gamma));\n}\nvec4 toGamma_vec4_v2(vec4 v) {\n  return vec4(toGamma_vec3_v2(v.rgb), v.a);\n}\nvec4 textureLinear(sampler2D uTex, vec2 uv) {\n  return toLinear_vec4_v1(texture2D(uTex, uv));\n}",gaussian_H_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) {\n    vec4 color = vec4(0.0);\n    vec2 tc = uv;\n    float blur = radius/resolution ; \n    float hstep = dir.x;\n    float vstep = dir.y;\n    color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162;\n    color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270;\n    color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162;\n  return color;\n}\nvoid main(void) { \n	vec4 color = vec4(0.0,0.0,0.0,0.0); \n	color =blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(0.0,1.0));\n	gl_FragColor  = color; \n}",gaussian_V_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform sampler2D colorTexture;\nvec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) {\n    vec4 color = vec4(0.0);\n    vec2 tc = uv;\n    float blur = radius/resolution ; \n    float hstep = dir.x;\n    float vstep = dir.y;\n    color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162;\n    color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270;\n    color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162;\n  return color;\n}\nvoid main(void) { \n	vec4 color = vec4(0.0,0.0,0.0,0.0); \n	vec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y);\n	color = blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(1.0,0.0));\n	color += texture2D(colorTexture,uv);\n	gl_FragColor  = color; \n}",grass_fs:"uniform float uniform_lightMap_data[5];\nuniform sampler2D diffuseTexture;\nuniform sampler2D lightMapTexture;\nvarying vec4 varying_scenePose;\nvec4 diffuseColor;\nvoid main() {\n	vec2 lightUV;\n	diffuseColor = texture2D(diffuseTexture, varying_uv0);\n	if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n	if(uniform_lightMap_data[0] > 0.5){\n		lightUV.x = (varying_scenePose.x + uniform_lightMap_data[1]) / uniform_lightMap_data[3]; \n		lightUV.y = (varying_scenePose.z + uniform_lightMap_data[2]) / uniform_lightMap_data[4]; \n		diffuseColor *= texture2D(lightMapTexture, lightUV); \n	}\n	outColor = diffuseColor;\n}",grass_vs:"attribute vec3 attribute_grassOffset;\nattribute float attribute_grassAngleY;\nuniform float uniform_grass_data[9];\nuniform float uniform_squeeze_data[6];\nuniform float uniform_lightMap_data[5];\nuniform mat4 uniform_cameraMatrix;\nuniform mat4 uniform_billboardMatrix;\nvarying vec4 varying_mvPose; \nvarying vec4 varying_scenePose;\nconst float TrueOrFalse = 0.5;\nconst float PI_2 = 6.283;\nstruct SqueezeData{\n	float enable;\n	vec3 position;\n	float strength;\n	float radius;\n};\nSqueezeData squeezeData;\nmat4 buildRotMat4(vec3 rot)\n{\n	float s;\n	float c;\n	s = sin(rot.x);\n	c = cos(rot.x);\n	\n	mat4 ret = mat4(\n	vec4(1.0, 0.0, 0.0, 0.0),\n	vec4(0.0, c, s, 0.0),\n	vec4(0.0, -s, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	);\n	\n	s = sin(rot.y);\n	c = cos(rot.y);\n	\n	ret = mat4(\n	vec4(c, 0.0, -s, 0.0),\n	vec4(0.0, 1.0, 0.0, 0.0),\n	vec4(s, 0.0, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	s = sin(rot.z);\n	c = cos(rot.z);\n	ret = mat4(\n	vec4(c, s, 0.0, 0.0),\n	vec4(-s, c, 0.0, 0.0),\n	vec4(0.0, 0.0, 1.0, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	return ret;\n}\nvec4 buildQuat(vec3 axis, float angle){\n  axis = normalize(axis);\n  vec4 ret;\n  \n  float halfAngle = angle * 0.5;\n  float sin_a = sin(angle);\n  ret.w = cos(halfAngle);\n  ret.x = axis.x * sin_a;\n  ret.y = axis.y * sin_a;\n  ret.z = axis.z * sin_a;\n  \n  ret = normalize(ret);\n  return ret;\n}\nmat4 buildMat4Quat(vec4 quat)\n{\n	float xx = quat.x * quat.x;\n	float xy = quat.x * quat.y;\n	float xz = quat.x * quat.z;\n	float xw = quat.x * quat.w;\n	float yy = quat.y * quat.y;\n	float yz = quat.y * quat.z;\n	float yw = quat.y * quat.w;\n	float zz = quat.z * quat.z;\n	float zw = quat.z * quat.w;\n	return mat4(\n		1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n		2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n		2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n		0.0,							0.0,					0.0,					1\n	);\n}\nvoid main(void){\n	\n	if(uniform_grass_data[8] > TrueOrFalse){\n		rotVertexMatrix = uniform_billboardMatrix;\n	}else{\n		rotVertexMatrix = buildRotMat4(vec3(0.0, attribute_grassAngleY, 0.0));\n	}\n	e_position.xyz = (rotVertexMatrix * vec4(e_position, 1.0)).xyz;\n	e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz;\n	if(e_position.y > 0.0){ \n		float windDirectionX			= uniform_grass_data[0];\n		float windDirectionZ			= uniform_grass_data[1];\n		float windSpaceX				= uniform_grass_data[2];\n		float windSpaceZ				= uniform_grass_data[3];\n		float windStrength				= uniform_grass_data[4];\n		float windSpeed					= uniform_grass_data[5];\n		float shakeScale				= uniform_grass_data[6];\n		float grassTime					= uniform_grass_data[7];\n		squeezeData.enable			= uniform_squeeze_data[0];\n		squeezeData.position.x		= uniform_squeeze_data[1];\n		squeezeData.position.y		= uniform_squeeze_data[2];\n		squeezeData.position.z		= uniform_squeeze_data[3];\n		squeezeData.radius			= uniform_squeeze_data[4];\n		squeezeData.strength		= uniform_squeeze_data[5];\n		windSpaceX = PI_2 * (attribute_grassOffset.x + abs(windDirectionX) * windSpeed * grassTime) / windSpaceX;\n		windSpaceZ = PI_2 * (attribute_grassOffset.z + abs(windDirectionZ) * windSpeed * grassTime) / windSpaceZ;\n		\n		float angle = sin(windSpaceX + windSpaceZ) * shakeScale + windStrength;\n		angle = clamp(angle, -1.57, 1.57);\n    \n		vec3 windDir = vec3(windSpaceX, 0.0, windSpaceZ);\n		vec3 windDirY = vec3(0.0, 1.0, 0.0);\n		windDir = normalize(windDir);\n    \n		vec3 axis = cross(windDirY,windDir); \n		vec4 quat = buildQuat(axis, angle);\n		mat4 matrix = buildMat4Quat(quat);\n    \n		vec2 orgXZ = vec2(e_position.x, e_position.z);\n		e_position.x = e_position.z = 0.0;\n		e_position = (matrix * vec4(e_position, 1.0)).xyz;\n   \n		e_position.xz += orgXZ;\n		if(squeezeData.enable > TrueOrFalse){\n			vec3 distanceVec3 = squeezeData.position - attribute_grassOffset;\n			vec2 distance2D = vec2(distanceVec3.x, distanceVec3.z);\n			float distanceFloat = sqrt(dot(distance2D, distance2D));\n			if(distanceFloat < squeezeData.radius){\n				float ratio = distanceFloat / squeezeData.radius;\n				ratio = 1.0 - ratio;\n				distanceVec3 = normalize(distanceVec3);\n				distanceVec3 *= squeezeData.strength * ratio * abs(e_position.y - squeezeData.position.y);\n				e_position -= distanceVec3;\n			}\n		}\n	}\n	e_position += attribute_grassOffset;\n	mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix);\n	varying_mvPose = outPosition = mvMatrix * vec4( e_position , 1.0 ); \n    varying_scenePose = vec4( e_position, 1.0 );\n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n    varying_color = attribute_color; \n    \n}\n",gui_fs:"varying vec4 varying_uv; \nvarying vec4 varying_color; \nvarying vec4 varying_pos; \nvarying vec4 varying_mask; \nvec4 diffuseColor; \nuniform sampler2D uiTexture_0; \nuniform sampler2D uiTexture_1; \nuniform sampler2D uiTexture_2; \nuniform sampler2D uiTexture_3; \nuniform sampler2D uiTexture_4; \nuniform sampler2D uiTexture_5; \nuniform sampler2D uiTexture_6; \nconst int FLAG_VALLID_QUAD = 0;\nconst int FLAG_IS_VISIBLE = 1;\nconst int FLAG_HAS_MASK = 2;\nconst int FLAG_HAS_TEXTURE = 3;\nconst int FLAG_IS_TEXTFIELD = 4;\nbool booleanArray[5];\nvoid decodeBooleanArray(float data){\n	float headData;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[0] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[1] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[2] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[3] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[4] = (headData - data) > 0.2;\n}\nvoid main(void){\n	decodeBooleanArray(varying_pos.w);\n	\n	\n	if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){\n		discard;\n	}\n	if(booleanArray[FLAG_HAS_MASK]){\n      vec4 mask = varying_mask;\n      if( (2.0*mask.x-1.0) > varying_pos.x){ \n		discard; \n      } \n      if( (-2.0*mask.y+1.0) < varying_pos.y){\n		discard; \n      }\n      if( (2.0*mask.z-1.0) < varying_pos.x){\n		discard; \n      }\n      if( (-2.0*mask.w+1.0) > varying_pos.y){\n		discard; \n      }\n	}\n	vec2 uv = varying_uv.xy ;\n	int index = int(floor(varying_pos.z)); \n	if(booleanArray[FLAG_HAS_TEXTURE] == false){\n		diffuseColor = vec4(1.0, 1.0, 1.0, 1.0);	}\n	else{\n		if(index==0){\n			diffuseColor = texture2D(uiTexture_0, uv ); \n		}\n		else if(index==1){\n			diffuseColor = texture2D(uiTexture_1, uv ); \n		}\n		else if(index==2){\n			diffuseColor = texture2D(uiTexture_2, uv ); \n		}\n		else if(index==3){\n			diffuseColor = texture2D(uiTexture_3, uv ); \n		}\n		else if(index==4){\n			diffuseColor = texture2D(uiTexture_4, uv ); \n		}\n		else if(index==5){\n			diffuseColor = texture2D(uiTexture_5, uv ); \n		}\n		else if(index==6){\n			diffuseColor = texture2D(uiTexture_6, uv ); \n		}\n		if(booleanArray[FLAG_IS_TEXTFIELD]){\n			int clrChannel = int(uv.x);\n			uv.x -= float(clrChannel);\n			float fontAlpha = 1.0;\n			if(clrChannel == 0){\n				fontAlpha = diffuseColor.x;\n			}else if(clrChannel == 1){\n				fontAlpha = diffuseColor.y;\n			} else if(clrChannel == 2){\n				fontAlpha = diffuseColor.z;\n			}else if(clrChannel == 3){\n				fontAlpha = diffuseColor.w;\n			}\n			if(fontAlpha > 0.9){\n				fontAlpha = 1.0;\n			}\n			diffuseColor = vec4(1.0, 1.0, 1.0, fontAlpha);\n		}\n	}\n \n	if(diffuseColor.w < 0.01 || varying_color.w < 0.01){\n		discard;\n	}\n	diffuseColor.xyz *= varying_color.xyz;\n	diffuseColor.w *= varying_color.w;\n	diffuseColor.xyz *= diffuseColor.w;\n	diffuseColor = clamp(diffuseColor, 0.0, 1.0); \n	gl_FragColor = diffuseColor; \n}",gui_vs:"attribute vec4 attribute_position; \nattribute vec4 attribute_shapePosition; \nattribute vec4 attribute_uvRec; \nattribute vec4 attribute_rotate; \nattribute vec4 attribute_maskRectangle; \nattribute vec4 attribute_quad_color; \nvarying vec4 varying_uv; \nvarying vec4 varying_color; \nvarying vec4 varying_pos; \nvarying vec4 varying_mask; \nvarying float varying_boolList;\nvec4 outPosition; \nuniform mat4 uniform_ModelMatrix; \nuniform mat4 uniform_ViewMatrix; \nuniform mat4 uniform_ProjectionMatrix; \nuniform mat4 uniform_orthProjectMatrix; \nuniform float uniform_materialSource[20]; \nmat4 buildMat4Quat(vec4 quat){ \nfloat xx = quat.x * quat.x; \nfloat xy = quat.x * quat.y; \nfloat xz = quat.x * quat.z; \nfloat xw = quat.x * quat.w; \nfloat yy = quat.y * quat.y; \nfloat yz = quat.y * quat.z; \nfloat yw = quat.y * quat.w; \nfloat zz = quat.z * quat.z; \nfloat zw = quat.z * quat.w; \nreturn mat4( \n1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0, \n2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0, \n2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0, \n0.0,							0.0,					0.0,					1 \n); \n}\nconst int FLAG_VALLID_QUAD = 0;\nconst int FLAG_IS_VISIBLE = 1;\nconst int FLAG_HAS_MASK = 2;\nconst int FLAG_HAS_TEXTURE = 3;\nconst int FLAG_IS_TEXTFIELD = 4;\nbool booleanArray[5];\nvoid decodeBooleanArray(float data){\n	float headData;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[0] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[1] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[2] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[3] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[4] = (headData - data) > 0.2;\n}\nvoid main(void){\n	gl_PointSize = uniform_materialSource[18];\n	varying_pos.zw = attribute_shapePosition.zw;\n	decodeBooleanArray(attribute_shapePosition.w);\n	if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){\n		outPosition = vec4(0.0,0.0,0.0,1.0);\n		gl_Position = outPosition; \n		return;\n	}\n    float devicePixelRatio = 1.0;    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    mat4 po = buildMat4Quat(attribute_rotate.xyzw); \n    mat4 oth = uniform_orthProjectMatrix; \n    float px = oth[0].x ;\n    float py = oth[1].y ;\n    \n    oth[0].x = oth[0].x / devicePixelRatio ; \n    oth[1].y = oth[1].y / devicePixelRatio ; \n    \n    vec3 pos = mat3(po) * (attribute_position.xyz * vec3(attribute_uvRec.zw,1.0) ) + vec3(attribute_shapePosition.xy,1.0) ; \n    vec3 sceneWH = vec3( 1.0/ oth[0].x, -1.0/oth[1].y , 0.0 )  ; \n    outPosition = mvMatrix * vec4( pos - sceneWH , 1.0 ) ; \n    varying_color = attribute_quad_color ; \n    \n    outPosition = oth * outPosition ; \n	varying_pos.xy = outPosition.xy;\n    vec4 maskk = attribute_maskRectangle;\n    \n    sceneWH = vec3(2.0/px*devicePixelRatio,2.0/py*devicePixelRatio,1.0) ;\n    \n    varying_mask = vec4(maskk.xy/sceneWH.xy,(maskk.x+maskk.z)/sceneWH.x, (maskk.y+maskk.w)/(sceneWH.y)) ; \n    varying_uv = attribute_uvRec; \n	gl_Position = outPosition; \n    \n}",hud_H_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvoid main(void) {\n	vec2 uv = vec2(varying_uv0.x ,1.0-varying_uv0.y);\n	vec4 color = texture2D(diffuseTexture, uv);\n	gl_FragColor  = color;\n}\n",hud_V_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvoid main(void) {\n	vec4 color = texture2D(diffuseTexture, varying_uv0);\n	gl_FragColor  = color;\n}\n",hud_cull_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform vec2 uv_scale;\nvoid main(void) {\n	vec2 uv_0 = varying_uv0;\n	uv_0 *= uv_scale;\n	vec4 color = texture2D(diffuseTexture, varying_uv0);\n	float mask = 1.0;\n	float f = uv_scale.y - varying_uv0.y;\n	if (varying_uv0.y < uv_scale.y){\n		if(f < 0.03 && f > 0.0){\n			mask =1.0 - (f / 0.03 * 0.9 + 0.1);\n		}\n		else{\n			mask = 0.1;\n		}\n	}\n	color.xyz *= mask;\n	gl_FragColor  = color;\n}\n",hud_vs:"attribute vec3 attribute_position;\nattribute vec2 attribute_uv0;\nvarying  vec2 varying_uv0;                      \nuniform  mat4 uniform_ViewProjectionMatrix;\nvoid main(void) {\n    vec4 pos = vec4(attribute_position, 1.0);\n    gl_Position = uniform_ViewProjectionMatrix * pos;\n    varying_uv0 = attribute_uv0;\n}",lightMapSpecularPower_fs:"uniform sampler2D lightTexture ;\nvarying vec2 varying_uv1 ;\nvec4 decode_hdr( vec4 data ){ \n    data.w = data.w * 255.0 - 128.0 ; \n    data.w = pow( 2.0 ,data.w); \n    data.xyz *= data.w ; \n    return data ; \n}\nvoid main(void){\n	vec4 lightmap = texture2D( lightTexture , varying_uv1 );\n    lightmap.xyz = decode_hdr(lightmap).xyz ;\n	outColor.xyz *= lightmap.xyz ;\n}\n ",lightMap_fs:"uniform sampler2D lightTexture ;\nvarying vec2 varying_uv1 ;\nvec4 decode_hdr( vec4 data ){ \n    data.w = data.w * 255.0 - 128.0 ; \n    data.w = pow( 2.0 ,data.w); \n    data.xyz *= data.w ; \n    return data ; \n}\nvoid main(void){\n	vec4 lightmap = texture2D( lightTexture , varying_uv1 );\n	lightmap.xyz = decode_hdr(lightmap).xyz  ;\n    outColor.xyz *= lightmap.xyz ; \n}\n",lightingBase_fs:"vec4 LightingBlinnPhong(vec3 lightDir, vec3 lightColor , vec3 lightAmbient , vec3 normal , vec3 viewDir, float atten){ \n	vec3 h = normalize(lightDir + normalize(viewDir)); \n	float diff = max(dot(normal, lightDir),0.0); \n	float nh = max(dot(normal,h),0.0); \n	float spec = pow(nh, materialSource.shininess ) * materialSource.specularScale ; \n	vec4 c ; \n	c.rgb = (s.Albedo * lightColor * diff + lightColor * materialSource.specular.rgb * s.Specular.rgb * spec) * (atten * 2.0); \n	c.a = s.Alpha + spec * atten; \n	return c; \n}\nvoid main(void) {\n}\n",lineFog:" \nstruct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   float fogStartDistance ;\n   float fogFarDistance ;\n   float fogAlpha ;\n};\nuniform float uniform_globalFog[7];\nvarying vec4 varying_mvPose;\nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.fogStartDistance = uniform_globalFog[4] ;\n    fog.fogFarDistance = uniform_globalFog[5] ;\n    fog.fogAlpha = uniform_globalFog[6] ;\n    \n	fog.fogColor *= outColor.w;\n	float d = varying_mvPose.z ; \n	float distFog = max( 0.0 , d -  fog.fogStartDistance ) ; \n	outColor.xyz = mix( outColor.xyz,fog.fogColor, clamp(distFog/fog.fogFarDistance,0.0,1.0) * fog.fogAlpha ) ; \n}\n",matCapPass_vs:"varying vec2 capCoord ;\nvoid main(void){\n        capCoord.x = dot(normalMatrix[0].xyz,normal);\n        capCoord.y = dot(normalMatrix[1].xyz,normal);\n        capCoord = capCoord * 0.5 + 0.5;\n        ambientColor.xyz +=  + capCoord.xyz * 2.0 - 1.0 ;\n}",matCap_TextureAdd_fs:"uniform sampler2D matcapTexture;\nvoid main() {\n  	vec4 capCoord ; \n	capCoord.x = -normal.x; \n	capCoord.y = normal.y; \n	capCoord.xy = capCoord.xy * 0.5 + 0.5; \n	capCoord = texture2D(matcapTexture , capCoord.xy ) * 2.0 - 1.0 ; \n	ambientColor.xyz += capCoord.xyz ; \n}\n",matCap_TextureMult_fs:"uniform sampler2D matcapTexture;\nvoid main() {\n  	vec4 capCoord ; \n	capCoord.x = -normal.x; \n	capCoord.y = normal.y; \n	capCoord.xy = capCoord.xy * 0.5 + 0.5; \n	capCoord = texture2D(matcapTexture , capCoord.xy ) ; \n	diffuseColor.xyz *= capCoord.xyz * 2.0 ; \n}\n",materialSource_fs:"struct MaterialSource{\n    vec3 diffuse;\n    vec3 ambient;\n    vec3 specular;\n    float alpha;\n    float cutAlpha;\n    float shininess;\n    float normalDir;\n    vec4 uvRectangle;\n    float gamma;\n    float specularScale;\n    float refraction;\n    float refractionintensity;\n}; \nuniform float uniform_materialSource[20] ;\nMaterialSource materialSource ;\nvec2 uv_0 ;\nvoid main(){\n	materialSource.diffuse.x = uniform_materialSource[0];\n	materialSource.diffuse.y = uniform_materialSource[1];\n	materialSource.diffuse.z = uniform_materialSource[2];\n	\n	materialSource.ambient.x = uniform_materialSource[3];\n	materialSource.ambient.y = uniform_materialSource[4];\n	materialSource.ambient.z = uniform_materialSource[5];\n	\n	materialSource.specular.x = uniform_materialSource[6];\n	materialSource.specular.y = uniform_materialSource[7];\n	materialSource.specular.z = uniform_materialSource[8];\n	\n	materialSource.alpha = uniform_materialSource[9];\n	materialSource.cutAlpha = uniform_materialSource[10];\n	materialSource.shininess = uniform_materialSource[11];\n	materialSource.specularScale = uniform_materialSource[12];\n	materialSource.normalDir = 1.0 ;    \n	materialSource.uvRectangle.x = uniform_materialSource[13];\n	materialSource.uvRectangle.y = uniform_materialSource[14];\n	materialSource.uvRectangle.z = uniform_materialSource[15];\n	materialSource.uvRectangle.w = uniform_materialSource[16];\n	materialSource.gamma = uniform_materialSource[17];\n	materialSource.refraction = uniform_materialSource[18];\n	materialSource.refractionintensity = uniform_materialSource[19];\n	uv_0 = varying_uv0.xy * materialSource.uvRectangle.zw + materialSource.uvRectangle.xy ;\n}",mulUvRoll_fs:"uniform float mulUvRoll[4] ;\nuniform sampler2D diffuseTexture;\nuniform sampler2D diffuseTexture1;\nvec4 diffuseColor ;\nvec2 uv_1;\nvoid main() {\n	uv_1 = varying_uv0;\n    uv_0.xy += vec2(mulUvRoll[0],mulUvRoll[1]);\n	uv_1.xy += vec2(mulUvRoll[2],mulUvRoll[3]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 ) * texture2D(diffuseTexture1 , uv_1 );\n	diffuseColor.xyz = clamp(diffuseColor.xyz / diffuseColor.w,0.0,1.0);\n}",normalMap_fragment:"uniform sampler2D normalTexture;\nvarying vec2 varying_uv0        ;\nvarying vec4 varying_mvPose        ;\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n  vec3 dp1 = dFdx(p);\n  vec3 dp2 = dFdy(p);\n  vec2 duv1 = dFdx(uv);\n  vec2 duv2 = dFdy(uv);\n  vec3 dp2perp = cross(dp2, N);\n  vec3 dp1perp = cross(N, dp1);\n  vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n  vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n  float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n  return mat3(T * invmax, B * invmax, N);\n}\nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) {\n  mat3 TBN = cotangentFrame(N, -V, texcoord);\n  return normalize(TBN * map);\n}\nvoid main(){\n   s.Normal = texture2D(normalTexture,uv_0).xyz *2.0 - 1.0; \n   s.Normal = tbn( s.Normal.xyz , normal.xyz , varying_mvPose.xyz , uv_0 ) ; \n}\n",normalPassEnd_fs:"void main() {\n    outColor = vec4(normal,1.0);\n}\n",outLine_fs:"uniform float uniform_ouline[5] ;\nvoid main(){\n     diffuseColor = vec4(uniform_ouline[1],\n                    uniform_ouline[2],\n                    uniform_ouline[3],\n                    uniform_ouline[4]) ;\n    outColor = diffuseColor; \n}",outLine_vs:"attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_mvPose; \nuniform float uniform_ouline[5] ;\nvoid main(void){\n    outPosition.xy -= normalize(varying_eyeNormal.xyz).xy * uniform_ouline[0]; \n}",out_fs:"void main(){\n    gl_FragColor = outColor;\n}",out_vs:"void main(){\n     gl_Position = outPosition ;\n}",particle_bezier:"float calcBezierArea(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float v0;\n	float v1;\n	float t0;\n	float t1;\n	float deltaTime = 0.0;\n	float a_deltaTime;\n	for(int i = 0; i < 16; i ++)\n	{\n		t0 = bzData[i * 2 + 0] * tTotal;\n		v0 = bzData[i * 2 + 1];\n		t1 = bzData[i * 2 + 2] * tTotal;\n		v1 = bzData[i * 2 + 3];\n		deltaTime = t1 - t0;\n			a_deltaTime = 0.5 * (v1 - v0);\n			if(tCurrent >= t1)\n			{\n				res += deltaTime * (v0 + a_deltaTime);\n			}else\n			{\n				deltaTime = tCurrent - t0;\n				res += deltaTime * (v0 + a_deltaTime);\n				break;\n			}\n	}\n	return res;\n}\nfloat calcBezierSize(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float y0;\n	float y1;\n	float t0;\n	float t1;\n	float deltaTime = 0.0;\n	float v;\n	for(int i = 0; i < 16; i ++)\n	{\n		t0 = bzData[i * 2 + 0] * tTotal;\n		y0 = bzData[i * 2 + 1];\n		t1 = bzData[i * 2 + 2] * tTotal;\n		y1 = bzData[i * 2 + 3];\n		deltaTime = t1 - t0;\n			if(tCurrent <= t1)\n			{\n				v = (y1 - y0) / deltaTime;\n				deltaTime = tCurrent - t0;\n				res = y0 + v * deltaTime;\n				break;\n			}\n	}\n	return res;\n}\n",particle_bezier_low:"float calcBezierArea(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float v0;\n	float v1;\n	float t0;\n	float t1;\n	float breakFlag = 1.0;\n	for (int i = 0; i < 3; i++) {\n		t1 = bzData[i * 4];\n		v1 = bzData[i * 4 + 1];\n		t0 = bzData[(i - 1) * 4];\n		v0 = bzData[(i - 1) * 4 + 1];\n		res += (min(tCurrent, t1) - t0) * (0.5 * (v1 + v0)) * breakFlag;\n		if(t1 >= tCurrent) {\n			breakFlag = 0.0;\n		}\n	}\n	return res;\n}\nfloat calcBezierSize(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float y0;\n	float y1;\n	float t0;\n	float t1;\n	\n	for (int i = 1; i < 4; i ++) {\n		t1 = bzData[i * 4];\n		y1 = bzData[i * 4 + 1];\n		if(t1 >= tCurrent) {\n			t0 = bzData[(i - 1) * 4];\n			y0 = bzData[(i - 1) * 4 + 1];\n			float age = (tCurrent - t0) / (t1 - t0);\n			res = y0 + (y1 - y0) * age;\n		}\n	}\n	return res;\n}\n",particle_color_fs:"//##FilterBegin## ##Particle##\r\nuniform float uniform_colorTransform[40];\r\n//ѹ��������ɫ,rg.b�ĸ�ʽ\r\nvec3 unpack_color(float rgb_data)\r\n{\r\n    vec3 res;\r\n    res.z = fract( rgb_data );\r\n    rgb_data -= res.z;\r\n    \r\n    rgb_data = rgb_data/256.0;\r\n    res.y = fract( rgb_data );\r\n    rgb_data -= res.y;\r\n    \r\n    res.x = rgb_data/256.0;\r\n    return res;\r\n}\r\n\r\nvoid main() {\r\n    float startColor ;\r\n    float startSegment ;\r\n    \r\n    float nextColor ;\r\n    float nextSegment ;\r\n\r\n    float startAlpha;\r\n	float nextAlpha;\r\n\r\n    float progress = varying_particleData.x/varying_particleData.y;\r\n	const int maxColorCount = 20;\r\n	const int loopCount = 20;\r\n    for( int i = 1 ; i < loopCount ; i++ ){\r\n       if( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){\r\n          startColor = uniform_colorTransform[i-1] ;\r\n          startSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ;\r\n          nextColor = uniform_colorTransform[i];\r\n          nextSegment = fract(uniform_colorTransform[i+maxColorCount]) ;\r\n\r\n		  startAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment;\r\n		  nextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment;\r\n       }else{\r\n          break;\r\n       }\r\n    } \r\n    \r\n    float len = nextSegment - startSegment ;\r\n    float ws = ( progress - startSegment ) / len ;\r\n	ws = clamp(ws,0.0,1.0);\r\n    globalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ;\r\n	globalColor = clamp(globalColor,0.0,1.0);\r\n}\r\n//##FilterEnd##",particle_color_fs_low:"//##FilterBegin## ##Particle##\r\nuniform float uniform_colorTransform[40];\r\n//ѹ��������ɫ,rg.b�ĸ�ʽ\r\nvec3 unpack_color(float rgb_data)\r\n{\r\n    vec3 res;\r\n    res.z = fract( rgb_data );\r\n    rgb_data -= res.z;\r\n    \r\n    rgb_data = rgb_data/256.0;\r\n    res.y = fract( rgb_data );\r\n    rgb_data -= res.y;\r\n    \r\n    res.x = rgb_data/256.0;\r\n    return res;\r\n}\r\n\r\nvoid main() {\r\n    float startColor ;\r\n    float startSegment ;\r\n    \r\n    float nextColor ;\r\n    float nextSegment ;\r\n\r\n    float startAlpha;\r\n	float nextAlpha;\r\n\r\n    float progress = varying_particleData.x/varying_particleData.y;\r\n	const int maxColorCount = 20;\r\n	const int loopCount = 4;\r\n    for( int i = 1 ; i < loopCount ; i++ ){\r\n       if( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){\r\n          startColor = uniform_colorTransform[i-1] ;\r\n          startSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ;\r\n          nextColor = uniform_colorTransform[i];\r\n          nextSegment = fract(uniform_colorTransform[i+maxColorCount]) ;\r\n\r\n		  startAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment;\r\n		  nextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment;\r\n       }else{\r\n          break;\r\n       }\r\n    } \r\n    \r\n    float len = nextSegment - startSegment ;\r\n    float ws = ( progress - startSegment ) / len ;\r\n	ws = clamp(ws,0.0,1.0);\r\n    globalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ;\r\n	globalColor = clamp(globalColor,0.0,1.0);\r\n}\r\n//##FilterEnd##",particle_color_vs:"void getNodeData(){\n	\n}\n//##FilterEnd##",particle_diffuse_fragment:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvec4 globalColor = vec4(1.0, 1.0, 1.0, 1.0);\nvoid calcUVCoord(){\n}\nvoid main() {\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	calcUVCoord();\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n    \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n}\n",particle_end_fs:"varying vec4 varying_particleData;\nvarying vec4 varying_mvPose;\nvoid main() {\n	vec3 fc ;\n	if(materialSource.refraction<2.41){ \n	   float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n	   fc = Fresnel_Schlick(vl,vec3(materialSource.refraction)) * materialSource.refractionintensity ; \n	   fc.xyz = max(fc,vec3(0.0)) ; \n	} \n  \n	s.Albedo = diffuseColor.rgb * globalColor.xyz ;	s.Albedo.x = pow(s.Albedo.x, materialSource.gamma);\n    s.Albedo.y = pow(s.Albedo.y, materialSource.gamma);\n    s.Albedo.z = pow(s.Albedo.z, materialSource.gamma);\n	s.Albedo = s.Albedo * varying_color.xyz;\n	s.Alpha = diffuseColor.a * globalColor.w * materialSource.alpha * varying_color.w ; \n	outColor.xyz = s.Albedo ; \n	outColor.w = s.Alpha; \n	if(varying_particleData.w > 0.5){ \n	outColor.xyz *= outColor.w; \n	} \n	outColor = clamp(outColor, 0.0, 1.0) ; \n}\n",particle_end_vs:"varying vec4 varying_pos;\nmat4 buildModelMatrix(vec4 quat, vec3 scale, vec3 position)\n{\n	mat4 ret = mat4( \n		vec4(scale.x, 0.0, 0.0, 0.0), \n		vec4(0.0, scale.y, 0.0, 0.0), \n		vec4(0.0, 0.0, scale.z, 0.0), \n		vec4(0.0, 0.0, 0.0, 1.0) \n	);\n	ret = buildMat4Quat(quat) * ret; \n	 \n	ret[3][0] = position.x;\n	ret[3][1] = position.y;\n	ret[3][2] = position.z;\n	return ret;\n}\nvec3 calcParticleMove(vec3 distanceXYZ){\n	if(velocityLimitVec2.y > TrueOrFalse){\n		vec3 temp = distanceXYZ * distanceXYZ;\n		float distanceCurrent = sqrt(temp.x + temp.y + temp.z);\n		float distanceLimit = velocityLimitVec2.x;\n		if(distanceLimit < Tiny){\n			return vec3(0.0);\n		}\n		if(distanceCurrent > distanceLimit){\n			float nowFrame = currentTime / 0.017;\n			float dampen = 1.0 - particleStateData.velocityLimitDampen;\n			float startDistance = (distanceCurrent - distanceLimit) / nowFrame;\n			float distanceResult = 0.0;\n			float tempDistance = startDistance;\n			for(int i = 1; i < 600; i++){\n				distanceResult += tempDistance;\n				tempDistance *= dampen;\n				if(float(i) > nowFrame)\n					break;\n			}\n			distanceXYZ *= (distanceResult + distanceLimit) / distanceCurrent;\n		}\n	}\n	return distanceXYZ;\n}\nbool updateStretchedBillBoard(vec3 moveVector){\n	return true;	\n}\nvoid main(void) {\n	\n	vec3 position_emitter = attribute_offsetPosition;\n	vec3 velocityLocalVec3 = velocityBaseVec3 * currentTime;\n	vec3 velocityWorldVec3 = vec3(0.0,0.0,0.0);\n	vec3 velocityMultiVec3 = vec3(0.0,0.0,0.0);\n	if(particleStateData.velocityOverWorldSpace < TrueOrFalse){\n		velocityLocalVec3 += velocityOverVec3;		\n	}else{\n		velocityWorldVec3 += velocityOverVec3;\n	}\n	if(particleStateData.velocityForceWorldSpace < TrueOrFalse){\n		velocityLocalVec3 += velocityForceVec3;\n	}else{\n		velocityWorldVec3 += velocityForceVec3;\n	}\n	position_emitter *= vec3(particleStateData.scaleX, particleStateData.scaleY, particleStateData.scaleZ);\n	if(particleStateData.worldSpace > TrueOrFalse){\n	}else{\n		followTargetPosition.x = particleStateData.positionX;\n		followTargetPosition.y = particleStateData.positionY;\n		followTargetPosition.z = particleStateData.positionZ;\n		followTargetRotation.x = particleStateData.rotationX;\n		followTargetRotation.y = particleStateData.rotationY;\n		followTargetRotation.z = particleStateData.rotationZ;\n		followTargetRotation.w = particleStateData.rotationW;\n	}\n	mat4 followRotQuat = buildMat4Quat(followTargetRotation);\n	velocityLocalVec3 = (followRotQuat * vec4(velocityLocalVec3, 1.0)).xyz;\n	if(particleStateData.renderMode == Mesh){ \n		rotVertexMatrix = followRotQuat * rotVertexMatrix; \n	}\n	localPosition.xyz *= scaleSize;\n	localPosition = rotVertexMatrix * localPosition; \n	trackPosition();\n	mat4 modelMatrix = buildModelMatrix(followTargetRotation, followTargetScale, followTargetPosition);\n	position_emitter = (modelMatrix * vec4(position_emitter, 1.0)).xyz; \n	velocityMultiVec3 = velocityLocalVec3 + velocityWorldVec3;\n	velocityMultiVec3 = calcParticleMove(velocityMultiVec3);\n	velocityMultiVec3.y -= 4.9 * currentTime * currentTime * particleStateData.gravity;		\n	position_emitter += velocityMultiVec3; \n	if(particleStateData.renderMode == StretchedBillboard){\n		discard_particle = discard_particle || updateStretchedBillBoard(velocityMultiVec3) == false; \n		outPosition = localPosition;\n		rotVertexMatrix = rotVertexMatrix * uniform_billboardMatrix; \n	}else{\n		outPosition = uniform_billboardMatrix * localPosition;\n	}\n	if(discard_particle){\n		outPosition = vec4(0.0,0.0,0.0,0.0); \n	}else{\n		\n		outPosition.xyz += position_emitter.xyz;\n		outPosition = uniform_ViewMatrix * outPosition;\n		e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz;\n		e_normal = normalize(e_normal);\n		mat4 mvMatrix = mat4(uniform_ViewMatrix * modelMatrix);\n		varying_mvPose = outPosition;\n    	\n		mat4 normalMatrix = inverse(mvMatrix) ;\n		normalMatrix = transpose(normalMatrix); \n		\n		varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n	}\n	varying_pos = outPosition = uniform_ProjectionMatrix * outPosition;\n}\n	\n//##FilterEnd##",particle_follow_vs:"attribute vec3 attribute_followPosition ;\nattribute vec4 attribute_followRotation ;\nattribute vec3 attribute_followScale;\nvoid getNodeData(){\n	 followTargetPosition = attribute_followPosition;\n	 followTargetRotation = attribute_followRotation;\n}\n	\n//##FilterEnd##",particle_rotationConst:"attribute float attribute_rotationZ ;\nvoid getUnitRotate(){\n	rotResultVec3.z = currentTime * attribute_rotationZ;\n}\n",particle_rotationOneBezier:"uniform float uniform_rotationBezier[35];\nvoid getUnitRotate(){\n	float rot = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life);\n	rotResultVec3.z = rot;\n}\n",particle_rotationTwoBezier:"attribute float attribute_rotationRandomSeed;\nuniform float uniform_rotationBezier[35];\nuniform float uniform_rotationBezier2[35];\nvoid getUnitRotate(){\n	vec2 rotationTwoBezier = vec2(0.0);\n	rotationTwoBezier.x = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life);\n	rotationTwoBezier.y = calcBezierArea(uniform_rotationBezier2, currentTime, curParticle.life);\n	float rot = mix(rotationTwoBezier.x, rotationTwoBezier.y, attribute_rotationRandomSeed);\n	rotResultVec3.z = rot;\n}\n",particle_rotationXYZConst:"attribute vec3 attribute_rotSpeedXYZ ;\nattribute vec3 attribute_rotBirthXYZ ;\nvoid getUnitRotate(){\n	rotResultVec3 = (attribute_rotBirthXYZ + particleStateData.time * attribute_rotSpeedXYZ);\n	rotResultVec3 = mod(rotResultVec3, 360.0);\n}\n",particle_scaleSizeBezier1:"uniform float uniform_scaleSizeBezier1[35];\nvoid main() {\n	scaleSize *= calcBezierSize(uniform_scaleSizeBezier1, currentTime, curParticle.life);\n}\n",particle_scaleSizeBezier2:"attribute float attribute_bezierRandomSeed;\nuniform float uniform_scaleSizeBezier1[35];\nuniform float uniform_scaleSizeBezier2[35];\nvoid main() {\n	vec2 scaleVec2 = vec2(0.0);\n	scaleVec2.x = calcBezierArea(uniform_scaleSizeBezier1, currentTime, curParticle.life);\n	scaleVec2.y = calcBezierArea(uniform_scaleSizeBezier2, currentTime, curParticle.life);\n	scaleSize * = mix(scaleVec2.x, scaleVec2.y, attribute_bezierRandomSeed);\n}\n",particle_scaleSizeConst:"attribute float attribute_scaleSizeConst;\nvoid main() {\n	scaleSize *= attribute_scaleSizeConst;\n}\n//##FilterEnd##",particle_stretched_mode:"\nbool updateStretchedBillBoard(vec3 moveVector){\n	if(currentTime < 0.016){\n		return false;\n	}\n	float speed = dot(moveVector, moveVector); \n	speed = sqrt(speed) / currentTime; \n	speed /= 100.0;\n	if(speed < Tiny){\n		return false;\n	}\n	localPosition.y = localPosition.y * particleStateData.lengthScale + speed * particleStateData.speedScale * localPosition.y / scaleSize;\n	vec3 dir1 = vec3(0.0, 1.0, 0.0);\n	vec3 dir2 = normalize(moveVector);\n	vec3 axis = normalize(cross(dir1, dir2));\n    float angle = acos(dot(dir1, dir2));\n	vec4 quat = vec4(0.0, 0.0, 0.0, 1.0);\n    float halfAngle = angle * 0.5;\n    float sin_a = sin(halfAngle);\n    quat.w = cos(halfAngle);\n    quat.x = axis.x * sin_a;\n    quat.y = axis.y * sin_a;\n    quat.z = axis.z * sin_a;\n    quat = normalize(quat);\n	\n	localPosition = uniform_billboardMatrix * localPosition;\n	rotVertexMatrix = buildMat4Quat(quat); \n	localPosition = rotVertexMatrix * localPosition;\n	return true;\n}\n",particle_textureSheetConst:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	frame = clamp(frame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheetOneBezier:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nuniform float uniform_frameBezier[35];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	float currentTime = varying_particleData.x * uniform_textureSheet[2];\n	currentTime = mod(currentTime, varying_particleData.y);\n	float bezierFrame = calcBezierSize(uniform_frameBezier, currentTime, varying_particleData.y);\n	bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	frame += bezierFrame;\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheetTwoBezier:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nuniform float uniform_frameBezier1[35];\nuniform float uniform_frameBezier2[35];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	float currentTime = varying_particleData.x * uniform_textureSheet[2];\n	currentTime = mod(currentTime, varying_particleData.y);\n	float b1 = calcBezierSize(uniform_frameBezier1, currentTime2, varying_particleData.y);\n	float b2 = calcBezierSize(uniform_frameBezier2, currentTime2, varying_particleData.y);\n	float bezierFrame = mix(b1, b2, varying_particleData.z);\n	bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	frame += bezierFrame;\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheet_vs:"attribute vec3 attribute_textureSheetData;\nvarying vec3 varying_textureSheetData;\nvoid getNodeData(){\n	varying_textureSheetData = attribute_textureSheetData;\n}\n	\n",particle_trackPosition:"\nattribute vec3 attribute_trackPosition;\nvoid calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos){ \n \n	vec3 distanceVec3 = endPos - fromPos; \n	float distanceFloat = dot(distanceVec3, distanceVec3); \n	distanceFloat = sqrt(distanceFloat); \n	float t = time / totalTime; \n	t = easeInOut(t); \n	vec3 centerPos = distanceVec3 * 0.5 + fromPos; \n	vec3 zeroPos = vec3(0.0, distanceFloat * 0.05, 0.0); \n	zeroPos = mix(centerPos, zeroPos, 0.6); \n	vec3 bezier1 = mix(fromPos, zeroPos, t); \n	vec3 bezier2 = mix(zeroPos, endPos, t); \n	vec3 bezier3 = mix(bezier1, bezier2, t); \n	cubicPos = bezier3 - fromPos; \n	t = clamp(time / totalTime, 0.0, 1.0); \n	if(t > 0.8){ \n	t = (1.0 - t) * 5.0; \n	}else if(t > 0.2){ \n	t = 1.0; \n	}else{ \n	t *= 5.0; \n	} \n	t = 0.5 * (1.0 - cos(t * PI)); \n	vec4 nrmVec4 = rotVertexMatrix * vec4(attribute_normal, 1.0); \n	vec3 nrmPos = normalize(nrmVec4.xyz); \n	nrmPos = nrmPos * t * distanceFloat * 0.04; \n	t = clamp(time / totalTime, 0.0, 1.0); \n	float heightOffset = 0.0; \n	heightOffset = sin(t * 3.0 * PI) * distanceFloat * 0.2 * sqrt(t * (1.0 - t)); \n	cubicPos += nrmPos; \n	cubicPos.y += heightOffset; \n}\nvoid trackPosition(){ \n \n	calcCubicPos(currentTime - 0.017, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n	vec3 lastOffset = cubicPos; \n	calcCubicPos(currentTime, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n	vec3 curOffset = cubicPos; \n	vec3 trackVec3 = curOffset - lastOffset; \n	trackVec3 = normalize(trackVec3); \n	float ratio = dot(localPosition.xyz, trackVec3); \n	float t = clamp(currentTime / curParticle.life, 0.0, 1.0); \n	t = 0.5 * (1.0 - cos(t * PI * 2.0)); \n	t = sqrt(t); \n	float speed = sqrt(dot(curOffset - lastOffset, curOffset - lastOffset)); \n	trackVec3 *= speed * 2.0 * t; \n	localPosition.xyz += ratio * trackVec3; \n	localPosition.xyz += curOffset; \n}\n",particle_uv_roll_fs:"\nuniform float uniform_particleUVRoll[2];\nvoid calcUVCoord() {\n	uv_0.xy += vec2(varying_particleData.x * uniform_particleUVRoll[0], varying_particleData.x * uniform_particleUVRoll[1]);\n}\n",particle_velocity:"\nattribute vec3 attribute_velocity;\nvoid getNodeData(){\n	velocityBaseVec3 = attribute_velocity;\n}\n",particle_velocityForceConst:"attribute vec3 attribute_velocityForceConst ;\nvoid getNodeData(){\n	velocityForceVec3 = 0.5 * attribute_velocityForceConst * currentTime * currentTime;\n}\n",particle_velocityForceOneBezier:"\nvec3 velocityForceOneBezier = vec3(0.0);\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	velocityForceVec3.xyz = velocityForceOneBezier.xyz;\n	calcVelocityForceBezier(currentTime, curParticle.life);\n}\n",particle_velocityForceOneBezierX:"\nuniform float uniform_velocityForceX[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.x = calcBezierArea(uniform_velocityForceX, curTime, totalTime);\n}\n",particle_velocityForceOneBezierY:"\nuniform float uniform_velocityForceY[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.y = calcBezierArea(uniform_velocityForceY, curTime, totalTime);\n}\n",particle_velocityForceOneBezierZ:"\nuniform float uniform_velocityForceZ[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.z = calcBezierArea(uniform_velocityForceZ, curTime, totalTime);\n}\n",particle_velocityForceTwoBezier:"\nattribute float attribute_velocityForceRandomSeed;\nvec3 velocityForceTwoBezier1 = vec3(0.0);\nvec3 velocityForceTwoBezier2 = vec3(0.0);\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityForceBezier(currentTime, curParticle.life);\n	velocityForceVec3.x = mix(velocityForceTwoBezier1.x, velocityForceTwoBezier2.x, attribute_velocityForceRandomSeed);\n	velocityForceVec3.y = mix(velocityForceTwoBezier1.y, velocityForceTwoBezier2.y, attribute_velocityForceRandomSeed);\n	velocityForceVec3.z = mix(velocityForceTwoBezier1.z, velocityForceTwoBezier2.z, attribute_velocityForceRandomSeed);\n}\n",particle_velocityForceTwoBezierX1:"\nuniform float uniform_velocityForceX1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.x = calcBezierArea(uniform_velocityForceX1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierX2:"\nuniform float uniform_velocityForceX2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.x = calcBezierArea(uniform_velocityForceX2, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierY1:"\nuniform float uniform_velocityForceY1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.y = calcBezierArea(uniform_velocityForceY1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierY2:"\nuniform float uniform_velocityForceY2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.y = calcBezierArea(uniform_velocityForceY2, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierZ1:"\nuniform float uniform_velocityForceZ1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.z = calcBezierArea(uniform_velocityForceZ1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierZ2:"\nuniform float uniform_velocityForceZ2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.z = calcBezierArea(uniform_velocityForceZ2, curTime, totalTime);\n}\n",particle_velocityLimitConst:"\nattribute float attribute_velocityLimit;\nvoid getNodeData(){\n	velocityLimitVec2.x = attribute_velocityLimit * currentTime;\n	if(velocityLimitVec2.x < 0.0){\n		velocityLimitVec2.x = 0.0;\n	}\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityLimitOneBezier:"\nuniform float uniform_velocityLimit[35];\nvoid main() {\n	velocityLimitVec2.x = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life);\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityLimitTwoBezier:"\nuniform float uniform_velocityLimit[35];\nuniform float uniform_velocityLimit2[35];\nattribute float attribute_velocityLimitRandomSeed;\nvoid main() {\n	float velocity2Limit1 = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life);\n	float velocity2Limit2 = calcBezierArea(uniform_velocityLimit2, currentTime, curParticle.life);\n	velocityLimitVec2.x = mix(velocity2Limit1, velocity2Limit1, attribute_velocityLimitRandomSeed);\n	if(velocityLimitVec2.x < 0.0){\n		velocityLimitVec2.x = 0.0;\n	}\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityOverConst:"\nattribute vec3 attribute_velocityOverConst;\nvoid getNodeData(){\n	velocityOverVec3 = attribute_velocityOverConst * currentTime;\n}\n",particle_velocityOverOneBezier:"\nvec3 velocityTwoBezier = vec3(0.0);\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityOverBezier(currentTime, curParticle.life);\n	velocityOverVec3.xyz = velocityTwoBezier.xyz;\n}\n",particle_velocityOverOneBezierX:"\nuniform float uniform_velocityOverX[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.x = calcBezierArea(uniform_velocityOverX, curTime, totalTime);\n}\n",particle_velocityOverOneBezierY:"\nuniform float uniform_velocityOverY[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.y = calcBezierArea(uniform_velocityOverY, curTime, totalTime);\n}\n",particle_velocityOverOneBezierZ:"\nuniform float uniform_velocityOverZ[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.z = calcBezierArea(uniform_velocityOverZ, curTime, totalTime);\n}\n",particle_velocityOverTwoBezier:"\nattribute float attribute_velocityOverRandomSeed;\nvec3 velocityOverTwoBezier1 = vec3(0.0);\nvec3 velocityOverTwoBezier2 = vec3(0.0);\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityOverBezier(currentTime, curParticle.life);\n	velocityOverVec3.x = mix(velocityOverTwoBezier1.x, velocityOverTwoBezier2.x, attribute_velocityOverRandomSeed);\n	velocityOverVec3.y = mix(velocityOverTwoBezier1.y, velocityOverTwoBezier2.y, attribute_velocityOverRandomSeed);\n	velocityOverVec3.z = mix(velocityOverTwoBezier1.z, velocityOverTwoBezier2.z, attribute_velocityOverRandomSeed);\n}\n",particle_velocityOverTwoBezierX1:"\nuniform float uniform_velocityOverX1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.x = calcBezierArea(uniform_velocityOverX1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierX2:"\nuniform float uniform_velocityOverX2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.x = calcBezierArea(uniform_velocityOverX2, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierY1:"\nuniform float uniform_velocityOverY1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.y = calcBezierArea(uniform_velocityOverY1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierY2:"\nuniform float uniform_velocityOverY2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.y = calcBezierArea(uniform_velocityOverY2, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierZ1:"\nuniform float uniform_velocityOverZ1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.z = calcBezierArea(uniform_velocityOverZ1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierZ2:"\nuniform float uniform_velocityOverZ2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.z = calcBezierArea(uniform_velocityOverZ2, curTime, totalTime);\n}\n",particle_vs:"float currentTime = 0.0;\nfloat totalTime = 0.0;\nbool discard_particle = true;\nconst float PI = 3.1415926;\nconst float TrueOrFalse = 0.5;\nconst float Tiny = 0.0001;\nvarying vec4 varying_particleData;\nvarying vec4 varying_mvPose;\nattribute vec3 attribute_time;attribute vec4 attribute_color;\nattribute vec3 attribute_offsetPosition;\nattribute float attribute_rotationBirth;\nuniform mat4 uniform_cameraMatrix;\nuniform mat4 uniform_billboardMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform float uniform_particleState[27];\nvec3 cubicPos = vec3(1.0,1.0,1.0);\nvec3 rotResultVec3 = vec3(0.0);\nvec4 localPosition = vec4(0.0,0.0,0.0,1.0);\nvec3 velocityBaseVec3 = vec3(0.0,0.0,0.0);\nvec3 velocityOverVec3 = vec3(0.0,0.0,0.0);\nvec3 velocityForceVec3 = vec3(0.0,0.0,0.0);\nvec2 velocityBezierWeightVec2 = vec2(1.0, 1.0);\nvec2 velocityLimitVec2 = vec2(0.0,0.0);\nvec3 followTargetPosition = vec3(0.0,0.0,0.0);\nvec3 followTargetScale = vec3(1.0,1.0,1.0);\nvec4 followTargetRotation = vec4(0.0,0.0,0.0,0.0);\nfloat scaleSize = 1.0;\nconst float Billboard				= 0.0;\nconst float StretchedBillboard		= 1.0;\nconst float HorizontalBillboard		= 2.0;\nconst float VerticalBillboard		= 3.0;\nconst float Mesh					= 4.0;\nstruct ParticleData{\n	float bornTime;	float life;	float index;};                   \nParticleData curParticle;\nstruct ParticleStateData{\n	float time;						\n	float loop;						\n	float worldSpace;				\n	float scaleX;					\n	float scaleY;					\n	float scaleZ;					\n	float rotationX;				\n	float rotationY;				\n	float rotationZ;				\n	float rotationW;\n	float positionX;				\n	float positionY;				\n	float positionZ;				\n	float loopTime;					\n	float delay;					\n	float duration;					\n	float gravity;					\n	float velocityOverWorldSpace;	\n	float velocityForceWorldSpace;	\n	float velocityLimitDampen;\n	float cameraScale;\n	float speedScale;\n	float lengthScale;\n	float renderMode;\n	float stayAtEnd;\n	float blendMode;\n	float shapeType;\n};\nParticleStateData particleStateData;\nmat4 buildRotMat4(vec3 rot)\n{\n	float s;\n	float c;\n	s = sin(rot.x);\n	c = cos(rot.x);\n	\n	mat4 ret = mat4(\n	vec4(1.0, 0.0, 0.0, 0.0),\n	vec4(0.0, c, s, 0.0),\n	vec4(0.0, -s, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	);\n	\n	s = sin(rot.y);\n	c = cos(rot.y);\n	\n	ret = mat4(\n	vec4(c, 0.0, -s, 0.0),\n	vec4(0.0, 1.0, 0.0, 0.0),\n	vec4(s, 0.0, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	s = sin(rot.z);\n	c = cos(rot.z);\n	ret = mat4(\n	vec4(c, s, 0.0, 0.0),\n	vec4(-s, c, 0.0, 0.0),\n	vec4(0.0, 0.0, 1.0, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	return ret;\n}\nmat4 buildMat4Quat(vec4 quat)\n{\n	float xx = quat.x * quat.x;\n	float xy = quat.x * quat.y;\n	float xz = quat.x * quat.z;\n	float xw = quat.x * quat.w;\n	float yy = quat.y * quat.y;\n	float yz = quat.y * quat.z;\n	float yw = quat.y * quat.w;\n	float zz = quat.z * quat.z;\n	float zw = quat.z * quat.w;\n	return mat4(\n		1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n		2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n		2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n		0.0,							0.0,					0.0,					1\n	);\n}\nfloat easeInOut(float t)\n{\n	t = clamp(t, 0.0, 1.0);\n	float p0;\n	float p1;\n	float p2;\n	if(t <= 0.5){ \n		p0 = 0.0; \n		p1 = 0.0; \n		p2 = 0.5; \n	}else{ \n		p0 = 0.5; \n		p1 = 1.0; \n		p2 = 1.0; \n		t -= 0.5;\n	}\n	t *= 2.0;\n	\n	p0 = mix(p0, p1, t);\n	p1 = mix(p1, p2, t);\n	\n	p0 = mix(p0, p1, t);\n	return p0;\n}\nvoid calcParticleTime()\n{\n	discard_particle = true;\n	curParticle.bornTime = attribute_time.x; \n	curParticle.life = attribute_time.y; \n	curParticle.index = attribute_time.z; \n	float time = particleStateData.time - particleStateData.delay;\n	currentTime = time - curParticle.bornTime;\n	if(currentTime <= 0.0){\n		return;\n	}\n	if(particleStateData.stayAtEnd > TrueOrFalse){\n		if(currentTime >= curParticle.life){\n			currentTime = curParticle.life * 0.99999;\n		}\n	}\n	if(particleStateData.loop < TrueOrFalse){\n		if(curParticle.bornTime >= particleStateData.duration){\n			return;\n		}\n		if(currentTime >= curParticle.life){\n			return;\n		}\n		\n	}\n	currentTime = mod(currentTime, particleStateData.loopTime);\n	if(currentTime > curParticle.life || currentTime <= 0.0){\n		return;\n	}\n	discard_particle = false;\n}\nvoid calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos)\n{\n}\nvoid trackPosition()\n{\n}\nvoid getUnitRotate(){\n}\nvoid getNodeData(){\n}\nvoid rotateParticleUnit()\n{\n	rotResultVec3.z += attribute_rotationBirth; \n	rotResultVec3 *= PI / 180.0; \n	if(particleStateData.renderMode == Mesh){\n		if(particleStateData.shapeType > 0.5){ \n			rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n			rotVertexMatrix = buildRotMat4(rotResultVec3); \n	  }else{ \n		  rotResultVec3 = vec3(0.0, 0.0, rotResultVec3.z); \n		  rotVertexMatrix = buildRotMat4(rotResultVec3); \n	  } \n	}else if(particleStateData.renderMode == HorizontalBillboard){ \n		rotVertexMatrix = buildRotMat4(vec3(0.5 * PI, 0.0, 0.0)); \n		rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n		rotVertexMatrix = buildRotMat4(rotResultVec3) * rotVertexMatrix; \n	}else if(particleStateData.renderMode == StretchedBillboard){\n		rotResultVec3 = vec3(0.0, 0.0, -0.5 * PI); \n		rotVertexMatrix = buildRotMat4(rotResultVec3);\n	}else{\n		rotVertexMatrix = buildRotMat4(rotResultVec3); \n	} \n	\n}\nvoid main(void) \n{\n	localPosition = vec4(e_position, 1.0);\n	particleStateData.time							= uniform_particleState[0];\n	particleStateData.loop							= uniform_particleState[1];\n	particleStateData.worldSpace					= uniform_particleState[2];\n	particleStateData.scaleX						= uniform_particleState[3];\n	particleStateData.scaleY						= uniform_particleState[4];\n	particleStateData.scaleZ						= uniform_particleState[5];\n	particleStateData.rotationX						= uniform_particleState[6];\n	particleStateData.rotationY						= uniform_particleState[7];\n	particleStateData.rotationZ						= uniform_particleState[8];\n	particleStateData.rotationW						= uniform_particleState[9];\n	particleStateData.positionX						= uniform_particleState[10];\n	particleStateData.positionY						= uniform_particleState[11];\n	particleStateData.positionZ						= uniform_particleState[12];\n	particleStateData.loopTime						= uniform_particleState[13];\n	particleStateData.delay							= uniform_particleState[14];\n	particleStateData.duration						= uniform_particleState[15];\n	particleStateData.gravity						= uniform_particleState[16];\n	particleStateData.velocityOverWorldSpace		= uniform_particleState[17];\n	particleStateData.velocityForceWorldSpace		= uniform_particleState[18];\n	particleStateData.velocityLimitDampen			= uniform_particleState[19];\n	particleStateData.cameraScale					= uniform_particleState[20];\n	particleStateData.speedScale					= uniform_particleState[21];\n	particleStateData.lengthScale					= uniform_particleState[22];\n	particleStateData.renderMode					= uniform_particleState[23];\n	particleStateData.stayAtEnd						= uniform_particleState[24];\n	particleStateData.blendMode						= uniform_particleState[25];\n	particleStateData.shapeType						= uniform_particleState[26];\n	\n	calcParticleTime();\n	varying_particleData.x = currentTime;\n	varying_particleData.y = curParticle.life;\n	varying_particleData.z = curParticle.index;\n	varying_particleData.w = particleStateData.blendMode;\n	if(discard_particle){\n		varying_particleData.x = currentTime = 0.0;\n		gl_Position = varying_pos = vec4(0.0, 0.0, 0.0, 1.0);\n		return;\n	}\n	getNodeData();\n	getUnitRotate();\n	rotateParticleUnit();\n}\n",pointLight_fragment:"const int max_pointLight = 0 ;\nuniform float uniform_pointLightSource[12*max_pointLight] ;\nvarying vec4 varying_mvPose; \nstruct PointLight{\n        vec3 position ;\n        vec3 diffuse ;\n        vec3 ambient ;\n        float intensity;\n        float radius;\n        float cutoff;\n};\nvoid calculatePointLight(MaterialSource materialSource){\n    vec3 N = normal; \n	vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n	for(int i = 0 ; i < max_pointLight ; i++){\n		PointLight pointLight;\n		pointLight.position = vec3(uniform_pointLightSource[i*12],uniform_pointLightSource[i*12+1],uniform_pointLightSource[i*12+2]);\n		pointLight.diffuse = vec3(uniform_pointLightSource[i*12+3],uniform_pointLightSource[i*12+4],uniform_pointLightSource[i*12+5]);\n		pointLight.ambient = vec3(uniform_pointLightSource[i*12+6],uniform_pointLightSource[i*12+7],uniform_pointLightSource[i*12+8]);\n	    pointLight.intensity = uniform_pointLightSource[i*12+9];\n	    pointLight.radius = uniform_pointLightSource[i*12+10];\n	    pointLight.cutoff = uniform_pointLightSource[i*12+11];\n		\n		vec3 lightCentre = (mat4(uniform_ViewMatrix) * vec4(pointLight.position.xyz,1.0) ).xyz ; \n		float r = pointLight.radius * 0.5 ;\n		vec3 ldir = varying_mvPose.xyz - lightCentre ;\n		float distance = length(ldir);\n		float d = max(distance - r, 0.0);\n		vec3 L = ldir / distance;\n		\n		float denom = d/r + 1.0;\n		float attenuation = 1.0 / (denom*denom);\n		\n		float cutoff = pointLight.cutoff ;\n		attenuation = (attenuation - cutoff) / (1.0 - cutoff);\n		attenuation = max(attenuation*pointLight.intensity, 0.0);\n		LightingBlinnPhong(normalize(ldir),pointLight.diffuse,pointLight.ambient,N,(viewDir),attenuation); \n	};\n}\nvoid main() {\n   calculatePointLight(materialSource);\n}\n",positionEndPass_fs:"varying vec4 varying_position ;\nvoid main(){\n     outColor = vec4(varying_position.xyz,1.0);\n}",positionEndPass_vs:"varying vec4 varying_position ;\nvoid main(){\n		outPosition = uniform_ProjectionMatrix * outPosition ; \n		varying_position = outPosition.xyzw; \n}",rimlight_fs:"uniform float uniform_rimData[6] ;\nvoid main(){\n    float rim = 1.0 - clamp(dot (vec3(0.0,0.0,1.0), normal ) ,0.0,1.0);  \n    vec3 emission = vec3(uniform_rimData[0],uniform_rimData[1],uniform_rimData[2]) * pow(rim, uniform_rimData[4]);  \n    outColor.xyz += emission * uniform_rimData[3] * uniform_rimData[5] ;\n}",secondaryUV_vs:"attribute vec2 attribute_uv1;\nvarying vec2 varying_uv1 ;\nvoid main(void){\n	varying_uv1 = attribute_uv1 ; \n}",shadowMapping_fs:"uniform sampler2D shadowMapTexture;\nuniform vec4 uniform_ShadowColor;\nvarying vec4 varying_ShadowCoord;\nfloat unpackDepth(vec4 rgbaDepth){\n    vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) );\n    float depth = dot(rgbaDepth,bitShift);\n    return depth ;\n}\nvoid main() {\n	vec3 shadowColor = vec3(1.0,1.0,1.0); \n	float offset = uniform_ShadowColor.w; \n	vec2 sample = varying_ShadowCoord.xy / varying_ShadowCoord.w * 0.5 + 0.5; \n	if (sample.x >=0.0 && sample.x <= 1.0 && sample.y >=0.0 && sample.y <= 1.0) {\n		vec4 sampleDepth = texture2D(shadowMapTexture, sample).xyzw; \n		float depth = varying_ShadowCoord.z;\n	\n		if (sampleDepth.z != 0.0) {\n			if( sampleDepth.z < depth - offset) { \n				shadowColor = uniform_ShadowColor.xyz; \n			}\n		}\n	}\n	outColor.xyz = outColor.xyz * shadowColor; \n}\n",shadowMapping_vs:"uniform mat4 uniform_ShadowMatrix;\nuniform mat4 uniform_ModelMatrix;\nvarying vec4 varying_ShadowCoord;\nvoid main() {\n	varying_ShadowCoord = uniform_ShadowMatrix * uniform_ModelMatrix * vec4(e_position, 1.0);\n}",shadowPass_fs:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nfloat unpackDepth(vec4 rgbaDepth){\n    vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) );\n    float depth = dot(rgbaDepth,bitShift);\n    return depth ;\n}\nvoid main() {\n	diffuseColor = varying_color ;\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	diffuseColor = texture2D(diffuseTexture , varying_uv0 );\n    if( diffuseColor.w <= 0.3 ){\n			discard;\n	}\n    gl_FragColor = vec4(varying_pos.zzz, 1.0);\n}\n",shadowPass_skeleton_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nattribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 outPosition = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xy2 = 2.0 * quat.x * quat.y;\n  float xz2 = 2.0 * quat.x * quat.z;\n  float xw2 = 2.0 * quat.x * quat.w;\n  float yz2 = 2.0 * quat.y * quat.z;\n  float yw2 = 2.0 * quat.y * quat.w;\n  float zw2 = 2.0 * quat.z * quat.w;\n  float xx = quat.x * quat.x;\n  float yy = quat.y * quat.y;\n  float zz = quat.z * quat.z;\n  float ww = quat.w * quat.w;\n  mat4 matrix = mat4(\n	   xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0,\n	   xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0,\n	   xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0,\n	   translation.x, translation.y, translation.z, 1\n   );\n   return matrix;\n}\nvoid main(void){\n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	e_position = outPosition.xyz;\n	\n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n	varying_color = attribute_color; \n	varying_uv0 = attribute_uv0 ;\n	varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0);\n	gl_Position = varying_pos;\n}",shadowPass_vs:"attribute vec3 attribute_position;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(void){\n	mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n	varying_color = attribute_color; \n	varying_uv0 = attribute_uv0 ;\n	varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(attribute_position, 1.0);\n	gl_Position = varying_pos;\n}",skeletonShadowPass_vs:"attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec4 attribute_color;\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xx = quat.x * quat.x;\n  float xy = quat.x * quat.y;\n  float xz = quat.x * quat.z;\n  float xw = quat.x * quat.w;\n  float yy = quat.y * quat.y;\n  float yz = quat.y * quat.z;\n  float yw = quat.y * quat.w;\n  float zz = quat.z * quat.z;\n  float zw = quat.z * quat.w;\n   return mat4(\n	   1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n	   2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n	   2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n	   translation.x,				translation.y,			translation.z,			1\n   );\n}\nvoid main(void){\n	varying_color = attribute_color; \n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	\n	e_position = outPosition.xyz;\n	outPosition = uniform_ModelMatrix * uniform_ViewMatrix *  outPosition; \n    \n}",skeleton_vs:"attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec4 varying_mvPose  ;\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xy2 = 2.0 * quat.x * quat.y;\n  float xz2 = 2.0 * quat.x * quat.z;\n  float xw2 = 2.0 * quat.x * quat.w;\n  float yz2 = 2.0 * quat.y * quat.z;\n  float yw2 = 2.0 * quat.y * quat.w;\n  float zw2 = 2.0 * quat.z * quat.w;\n  float xx = quat.x * quat.x;\n  float yy = quat.y * quat.y;\n  float zz = quat.z * quat.z;\n  float ww = quat.w * quat.w;\n  mat4 matrix = mat4(\n	   xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0,\n	   xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0,\n	   xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0,\n	   translation.x, translation.y, translation.z, 1\n   );\n   return matrix;\n}\nvoid main(void){\n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	vec4 temp_normal = vec4(attribute_normal, 0.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	e_position = outPosition.xyz;\n	vec4 temp_n ;\n	temp_n  = m0 * temp_normal * e_boneWeight.x;\n	temp_n += m1 * temp_normal * e_boneWeight.y;\n	temp_n += m2 * temp_normal * e_boneWeight.z;\n	temp_n += m3 * temp_normal * e_boneWeight.w;\n	\n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 ) ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -temp_n.xyz ; \n    \n    outPosition.xyzw = varying_mvPose.xyzw ; \n    varying_color = attribute_color; \n}",specularMap_fragment:"uniform sampler2D specularTexture;\nvoid main(void){\n   	s.Specular = texture2D(specularTexture, uv_0).xyzx ;\n}\n",sportLight:"lightingInfo computeSpotLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 lightDirection, vec3 diffuseColor, vec3 specularColor, float range, float roughness, float NdotV) {\n    lightingInfo result;\n    vec3 direction = lightData.xyz - vPositionW;\n    vec3 lightVectorW = normalize(direction);\n    float attenuation = max(0., 1.0 - length(direction) / range);\n    float cosAngle = max(0.0000001, dot(-lightDirection.xyz, lightVectorW));\n    float spotAtten = 0.0;\n    if (cosAngle >= lightDirection.w)\n    {\n        cosAngle = max(0., pow(cosAngle, lightData.w));\n        spotAtten = clamp((cosAngle - lightDirection.w) / (1. - cosAngle), 0.0, 1.0);\n        vec3 H = normalize(viewDirectionW - lightDirection.xyz);\n        float NdotL = max(0.00000000001, dot(vNormal, -lightDirection.xyz));\n        float VdotH = clamp(dot(viewDirectionW, H), 0.00000000001, 1.0);\n        float diffuseTerm = computeDiffuseTerm(NdotL, NdotV, VdotH, roughness);\n        result.diffuse = diffuseTerm * diffuseColor * attenuation * spotAtten;\n#ifdef SPECULARTERM\n        float NdotH = max(0.00000000001, dot(vNormal, H));\n        vec3 specTerm = computeSpecularTerm(NdotH, NdotL, NdotV, VdotH, roughness, specularColor);\n        result.specular = specTerm  * attenuation * spotAtten;\n#endif\n        return result;\n    }\n    result.diffuse = vec3(0.);\n#ifdef SPECULARTERM\n    result.specular = vec3(0.);\n#endif\n    return result;\n}",tangent_vs:"attribute vec3 attribute_tangent;\nvoid main(void){\n} ",terrainRGBA_fragment:"uniform sampler2D blendMaskTexture ;\nuniform sampler2D splat_0Tex ;\nuniform sampler2D splat_1Tex ;\nuniform sampler2D splat_2Tex ;\nuniform sampler2D splat_3Tex ;\nuniform float uvs[8];\nvoid main() {\n	materialSource.refraction = 3.0 ;\n	vec4 splat_control = texture2D ( blendMaskTexture , varying_uv0 );\n	vec4 cc = vec4(0.0,0.0,0.0,1.0);\n	vec2 uv = varying_uv0 ;\n	cc.xyz = splat_control.x * texture2D (splat_0Tex, uv * vec2(uvs[0],uvs[1])).xyz ;\n	cc.xyz += splat_control.y * texture2D (splat_1Tex, uv * vec2(uvs[2],uvs[3]) ).xyz;\n	cc.xyz += splat_control.z * vec4(texture2D (splat_2Tex, uv* vec2(uvs[4],uvs[5]))).xyz;\n	cc.xyz += (1.0-splat_control.w) * vec4(texture2D (splat_3Tex, uv* vec2(uvs[6],uvs[7]))).xyz; \n	s.Albedo.xyz = cc.xyz ; \n	outColor.xyz = s.Albedo.xyz;\n	outColor.w = 1.0;\n}\n",uvRoll_fs:"uniform float uvRoll[2] ;\nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    uv_0.xy += vec2(uvRoll[0],uvRoll[1]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n}",uvSpriteSheet_fs:"uniform float uvSpriteSheet[4] ;\nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    uv_0.xy *= vec2(uvSpriteSheet[2],uvSpriteSheet[3]);\n    uv_0.xy += vec2(uvSpriteSheet[0],uvSpriteSheet[1]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n}",uvStreamerRoll_fs:"uniform float uvRoll[3] ;\nuniform sampler2D diffuseTexture;\nuniform sampler2D streamerTexture;\nvec4 diffuseColor ;\nvoid main() {\n    \n	diffuseColor = texture2D(diffuseTexture , varying_uv0 );\n    \n    vec2 rollUV = varying_uv0 + vec2(uvRoll[0],uvRoll[1]) + vec2(normal.xz) * 0.5 ;\n	diffuseColor.xyz += texture2D(streamerTexture , rollUV ).xyz * uvRoll[2] ;\n    \n}",varyingViewDir_vs:"varying vec3 varying_ViewDir; \nuniform vec3 uniform_eyepos; \nvoid main(void){ \n    varying_ViewDir = (uniform_eyepos.xyz - e_position) ; \n}",vertexPos_vs:"uniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nvarying vec4 varying_mvPose;\nvoid main() {\n       varying_mvPose = uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0) ; \n}\n                      ",waterBump_fs:"uniform vec2 waterNormalData[4];\nuniform vec4 horizonColor;\nuniform float time ;\nuniform sampler2D bumpTexture;\nuniform sampler2D colorControlTexture;\nvarying vec2 varying_uv0        ;\nvarying vec2 varying_uv0        ;\nvec4 UnpackNormal( vec4 nT ){\n    vec4 t ;\n    t.xyzw = nT.xyzw * 2.0 - 1.0 ;\n    return t ;\n}\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n    vec3 dp1 = dFdx(p);\n    vec3 dp2 = dFdy(p);\n    vec2 duv1 = dFdx(uv);\n    vec2 duv2 = dFdy(uv);\n    vec3 dp2perp = cross(dp2, N);\n    vec3 dp1perp = cross(N, dp1);\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n    return mat3(T * invmax, B * invmax, N);\n}\nvoid main(void){\n    float tempTime = mod(time,10000000.0); \n    vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n    vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n    TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ;\n    vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w) ;\n    vec3 bump1 = UnpackNormal(texture2D( bumpTexture, uvA )).rgb;\n	vec3 bump2 = UnpackNormal(texture2D( bumpTexture, uvB )).rgb;\n	vec3 bump = (bump1 + bump2) * 0.5;\n    normal = TBN * bump ;\n	\n	float fresnel = dot( viewDir, bump );\n	vec4 water = texture2D( colorControlTexture, vec2(fresnel,fresnel) );\n	\n	vec4 col;\n	diffuseColor.rgb = mix( water.rgb, horizonColor.rgb, water.a );\n	diffuseColor.a = horizonColor.a;\n}",waterDiffuse_fs:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n			diffuseColor.xyz *= diffuseColor.w ;\n}\n",waterNormal_fs:"uniform vec2 waterNormalData[4];\nuniform float time ;\nuniform sampler2D normalTextureA;\nuniform sampler2D normalTextureB;\nvarying vec4 varying_mvPose;\nvarying vec2 varying_uv0;\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n    vec3 dp1 = dFdx(p);\n    vec3 dp2 = dFdy(p);\n    vec2 duv1 = dFdx(uv);\n    vec2 duv2 = dFdy(uv);\n    vec3 dp2perp = cross(dp2, N);\n    vec3 dp1perp = cross(N, dp1);\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n    return mat3(T * invmax, B * invmax, N);\n}\nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) {\n    mat3 TBN = cotangentFrame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\nvoid main(void){\n    TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ;\n    float tempTime = mod(time,100000.0); \n    vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n    vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n    vec3 bump1 = texture2D( normalTextureA, uvA ).rgb * 2.0-1.0 ; \n    bump1.y *= -1.0;\n    bump1.xyz = TBN * bump1 ; \n    normal.xyz = bump1.xyz ;\n    \n    vec3 bump2 = texture2D( normalTextureB, uvB ).rgb * 2.0-1.0 ; \n    bump2.y *= -1.0;\n    bump2.xyz = TBN * bump2 ; \n    normal.xyz = (normal.xyz + bump2.xyz)*0.5 ;\n    \n} ",wave_fs:"uniform sampler2D diffuseTexture;\nuniform vec3 uniform_eyepos; \nuniform vec4 waveFSData[2]; \nvarying vec4 varying_mvPose;\nvec4 diffuseColor ;\nvoid main(void){\n    vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    diffuseColor.xyz = vec3(1.0,1.0,1.0) ; \n    vec3 shallowWaterColor = waveFSData[0].xyz * waveFSData[0].w ;\n    vec3 deepWaterColor = waveFSData[1].xyz * waveFSData[1].w;\n    float facing = clamp(dot( -normalize(viewDir),normal),0.0,1.0);\n    vec3 waterColor = mix(shallowWaterColor,deepWaterColor,facing);\n    diffuseColor.xyz *= waterColor ;\n} ",wave_vs:"#define VERTEX_TEXTURES\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nvarying vec4 varying_mvPose;\nuniform vec3 waveVSData[4];\nuniform float time ;\nstruct wave{\n    vec3 wave_xyz_intensity_0 ;\n    vec3 wave_xyz_intensity_1 ;\n    vec3 wave_xyz_speed_0 ;\n    vec3 wave_xyz_speed_1 ;\n};\nconst float pi = 3.14 ;\nvec3 calcWave2( float t , vec3 x, float amplitude, float waveLength ,float angularVelocity ,  vec3 waveDir ){\n  \n   angularVelocity = angularVelocity * 0.1;\n   vec3 waveVector = waveDir ;\n   float waveNumber = pi / waveLength;\n   waveVector *= waveNumber ;\n  \n  vec3 temp ; \n   float kDotX0SubWt = dot(waveVector , x ) - angularVelocity * t  * 0.001;\n   float A = amplitude * sin(kDotX0SubWt) ;\n   temp.xz = waveDir.xz * A ;\n   temp.y += amplitude * cos(kDotX0SubWt);\n   temp = x - temp ;\n   return temp ;\n}\nvoid main(void){\n   wave wa ; \n    wa.wave_xyz_intensity_0 = vec3(waveVSData[0]) ; \n    wa.wave_xyz_intensity_1 = vec3(waveVSData[1]) ; \n    wa.wave_xyz_speed_0 = vec3(waveVSData[2]) ; \n    wa.wave_xyz_speed_1 = vec3(waveVSData[3]) ; \n    \n    float tempTime = mod( time , 1000000.0 ); \n	vec3 newPose1 = calcWave2(tempTime,e_position,40.0, 20.0, 10.0,vec3(1.0,0.0,1.0)); \n	newPose1 += calcWave2(tempTime,e_position,20.0, 10.0, 10.0,vec3(1.0,0.0,-0.5)); \n	newPose1 += calcWave2(tempTime,e_position,1.0, 1.0, 10.0,vec3(1.0,0.0,-1.5)); \n    e_position = newPose1 ; \n    \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    \n    outPosition = varying_mvPose ; \n    varying_color = attribute_color; \n} "},t.ShaderLib=e,__reflect(e.prototype,"egret3d.ShaderLib")
}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.register=function(t){this.context=t},e.getGPUShader=function(e,r,i){var a=this.vsShaderHashMap.getValue(r);return a||(a=this.fsShaderHashMap.getValue(r)),a||(e==t.Shader.vertex?(a=this.context.creatVertexShader(i),a.id=r,this.vsShaderHashMap.add(r,a)):e==t.Shader.fragment&&(a=this.context.creatFragmentShader(i),a.id=r,this.fsShaderHashMap.add(r,a))),a},e.getProgram=function(t,e){var r,i=this.vsShaderHashMap.getValue(t),a=this.fsShaderHashMap.getValue(e),n=i.id+"_"+a.id;return this.programlib.isHas(n)?r=this.programlib.getValue(n):(r=this.registerProgram(i,a),this.programlib.add(n,r)),this.programlib.getValue(n)},e.unRegisterShader=function(t){},e.registerProgram=function(t,e){var r=this.context.creatProgram(t,e);return r},e.unRegisterProgram=function(t,e){},e}();e.programlib=new t.HashMap,e.vsShaderHashMap=new t.HashMap,e.fsShaderHashMap=new t.HashMap,t.ShaderPool=e,__reflect(e.prototype,"egret3d.ShaderPool")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();e.lib={AOMap_fs:"uniform sampler2D aoTexture ;\nuniform float aoPower ;\nvoid main(void){\n    float ao = texture2D( aoTexture , varying_uv1 ).x ;\n	diffuseColor.xyz *= (ao * aoPower) ; \n}\n",AmbientOcclusion:"varying vec2 varying_uv0;\nuniform sampler2D positionPass;\nuniform sampler2D normalPass;\nvoid main(){\n    gl_FragColor = texture2D(positionPass,varying_uv0) + texture2D(normalPass,varying_uv0) ;\n}\n",FakePBR_fs:"#extension GL_OES_standard_derivatives:enable\n#define max_directLight 1 \nstruct DirectLight{\n   vec3 direction;\n	 vec3 diffuse;\n	 vec3 ambient;\n};\nuniform float uniform_directLightSource[9*max_directLight] ;\nvarying vec4 varying_mvPose; \nvarying vec3 varying_eyeNormal; \nvarying vec2 varying_uv0; \nuniform sampler2D albedoTex; \nuniform sampler2D normalTex; \nuniform sampler2D glossTex; \nuniform sampler2D specularTex; \nuniform sampler2D opacityTex; \nuniform samplerCube reflectionMap;\nuniform mat4 uniform_ViewMatrix; \nmat3 TBN; \nmat4 normalMatrix ;\nvec3 normalDirection;\nvec3 light;\nvec3 normalTexColor ;\nvec4 opacityTexColor ;\nvec4 glossTexColor ;\nvec4 specularTexColor ;\nvec4 albedoTexColor ;\nvec2 uv_0;\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvec3 unpackNormal(vec4 packednormal)\n{\n	return packednormal.xyz * 2.0 - 1.0;\n}\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \nvec3 dp1 = dFdx(p); \nvec3 dp2 = dFdy(p); \nvec2 duv1 = dFdx(uv); \nvec2 duv2 = dFdy(uv);  \nvec3 dp2perp = cross(dp2, N); \nvec3 dp1perp = cross(N, dp1); \nvec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \nvec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \nfloat invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \nreturn mat3(T * invmax, B * invmax, N); \n}\nvec3 fakePBRLight( vec3 lightDir , vec3 viewDir , vec3 lightColor , vec3 ambient ){\n    vec3 lightDirection = mat3(uniform_ViewMatrix) * normalize(lightDir);\n    vec3 halfDirection = normalize( lightDirection + viewDir) ;\n    float attenuation = 1.0 ;    vec3 attenColor = attenuation * lightColor;\n    float Pi = 3.141592654;\n    float InvPi = 0.31830988618;\n    float gloss = glossTexColor.r;\n    float specPow = exp2( gloss * 10.0 + 1.0 );\n    float NdotL = max(0.0, dot( normalDirection, lightDirection ));\n    float specularMonochrome = max( max(specularTexColor.r, specularTexColor.g), specularTexColor.b);\n    float normTerm = (specPow + 8.0 ) / (8.0 * Pi);\n    vec3 directSpecular =  (floor(attenuation) * lightColor ) * pow(max(0.0,dot(halfDirection,normalDirection)),normTerm) * specularTexColor.xyz * normTerm ;\n    vec3 specular = directSpecular;\n    NdotL = max(0.0,dot( normalDirection , normalize(lightDirection) ));\n    vec3 directDiffuse = max( 0.0, NdotL) * attenColor;\n    vec3 indirectDiffuse = vec3(0.0,0.0,0.0);\n		 indirectDiffuse +=  ambient ;    vec3 diffuseColor = albedoTexColor.rgb;\n    diffuseColor *= 1.0-specularMonochrome;\n    vec3 diffuse = (directDiffuse + indirectDiffuse) * diffuseColor;\n    vec3 finalColor = diffuse + specular ;\n    return finalColor ;\n}\nvoid calculateDirectLight(  ){\n    float lambertTerm , specular ; \n    vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    for(int i = 0 ; i < max_directLight ; i++){ \n         DirectLight directLight ; \n         directLight.direction = vec3(uniform_directLightSource[i*9],uniform_directLightSource[i*9+1],uniform_directLightSource[i*9+2]); \n         directLight.diffuse = vec3(uniform_directLightSource[i*9+3],uniform_directLightSource[i*9+4],uniform_directLightSource[i*9+5]); \n         directLight.ambient = vec3(uniform_directLightSource[i*9+6],uniform_directLightSource[i*9+7],uniform_directLightSource[i*9+8]); \n         dir = normalize(directLight.direction) ; \n         light.xyz += fakePBRLight( dir , viewDir , directLight.diffuse , directLight.ambient); \n    }\n}\nvoid main(void){ \n     TBN = cotangentFrame(normalize(varying_eyeNormal), normalize(-varying_mvPose.xyz) , uv_0); \n  \n     albedoTexColor = texture2D(albedoTex, varying_uv0 );\n      normalTexColor = unpackNormal(texture2D(normalTex, uv_0 )) ; \n     opacityTexColor = texture2D(opacityTex, uv_0 ) ; \n     glossTexColor = texture2D(glossTex, uv_0 );\n     specularTexColor = texture2D(specularTex, uv_0 );\n     normalDirection = TBN * normalTexColor.xyz ;\n     if( (step(materialSource.cutAlpha,opacityTexColor.g) - 0.5) < 0.0 ){\n        discard;\n     }\n     calculateDirectLight();\n     vec4 finalRGBA = vec4(light,1.0) ;     gl_FragColor = finalRGBA;   \n}",FakePBR_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec4 varying_mvPose;\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvec4 outPosition; \nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvoid main(void){ \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    varying_mvPose = mvMatrix * vec4( attribute_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    varying_uv0 = attribute_uv0 ;\n    \n    outPosition = uniform_ProjectionMatrix * varying_mvPose ; \n    gl_Position = outPosition; \n}",MultiUVSprite_fs:"uniform vec4 multiUV ; \nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    vec2 scale = vec2(1.0/multiUV.xy) ; \n    float a = mod(multiUV.w , multiUV.x) ;\n    float b = (multiUV.w / multiUV.x) - fract(multiUV.w / multiUV.x) ; \n    vec2 rec = scale * vec2(a,b) + uv_0 * scale;\n	diffuseColor = texture2D(diffuseTexture , rec ); \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n}\n",SSAO:"#define DL 2.399963229728653\n#define EULER 2.718281828459045\nvarying vec2 varying_uv0; \nfloat aoClamp =  0.5 ; \nfloat lumInfluence =  0.5 ; \nconst vec2 size =  vec2(512.0,512.0); \nconst int samples =  64; \nconst float radius =  2.0; \nconst bool useNoise =  false; \nconst float noiseAmount =  0.00000003; \nconst float diffArea =  0.4; \nconst float gDisplace =  0.4; \nuniform sampler2D positionPass; \nuniform sampler2D normalPass; \nuniform sampler2D colorPass; \nvec2 rand( vec2 coord ) { \nvec2 noise; \nif ( useNoise ) { \nfloat nx = dot ( coord, vec2( 12.9898, 78.233 ) ); \nfloat ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 ); \nnoise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 ); \n} else { \nfloat ff = fract( 1.0 - coord.s * ( size.x / 2.0 ) ); \nfloat gg = fract( coord.t * ( size.y / 2.0 ) ); \nnoise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg; \n} \nreturn ( noise * 2.0  - 1.0 ) * noiseAmount; \n}\nfloat readDepth(vec2 coord){ \nfloat cameraNear = 1.0 ; \nfloat cameraFar = 10000.0; \nfloat cameraFarPlusNear = cameraFar + cameraNear; \nfloat cameraFarMinusNear = cameraFar - cameraNear; \nfloat cameraCoef = 2.0 * cameraNear; \nreturn texture2D(positionPass,coord).z / (cameraFar-cameraNear); \n}\nfloat compareDepths( const in float depth1, const in float depth2, inout int far ) { \nfloat garea = 2.0; \nfloat diff = ( depth1 - depth2 ) * 100.0; \nif ( diff < gDisplace ) { \ngarea = diffArea; \n} else { \nfar = 1; \n} \nfloat dd = diff - gDisplace; \nfloat gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) ); \nreturn gauss; \n}\nfloat calcAO( float depth, float dw, float dh ) { \nfloat dd = radius - depth * radius; \nvec2 vv = vec2( dw, dh ); \nvec2 vUv = varying_uv0 ; \nvec2 coord1 = vUv + dd * vv; \nvec2 coord2 = vUv - dd * vv; \nfloat temp1 = 0.0; \nfloat temp2 = 0.0; \nint far = 0; \ntemp1 = compareDepths( depth, readDepth( coord1 ), far ); \nif ( far > 0 ) { \ntemp2 = compareDepths( readDepth( coord2 ), depth, far ); \ntemp1 += ( 1.0 - temp1 ) * temp2; \n} \nreturn temp1; \n}\nvoid main(){ \nvec2 noise = rand( varying_uv0 ); \nfloat depth = readDepth( varying_uv0 ); \nfloat tt = clamp( depth, aoClamp, 1.0 ); \nfloat w = ( 1.0 / size.x )  / tt + ( noise.x * ( 1.0 - noise.x ) ); \nfloat h = ( 1.0 / size.y ) / tt + ( noise.y * ( 1.0 - noise.y ) ); \nfloat ao = 0.0; \nfloat dz = 1.0 / float( samples ); \nfloat z = 1.0 - dz / 2.0; \nfloat l = 0.0; \nfor ( int i = 0; i <= samples; i ++ ) { \nfloat r = sqrt( 1.0 - z ); \nfloat pw = cos( l ) * r; \nfloat ph = sin( l ) * r; \nao += calcAO( depth, pw * w, ph * h ); \nz = z - dz; \nl = l + DL; \n} \nao /= float( samples ); \nao = 1.0 - ao; \nvec3 color = texture2D(colorPass,varying_uv0).xyz ; \nvec3 lumcoeff = vec3( 0.299, 0.587, 0.114 ); \nfloat lum = dot( color.rgb, lumcoeff ); \nvec3 luminance = vec3( lum ); \nvec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) ); \ngl_FragColor = vec4( final, 1.0 ); \n}",alphaMask_fs:"uniform sampler2D maskTexture ;\nvoid main(void){\n	float maskAlpha = texture2D( maskTexture , uv_0 ).x;\n	if(maskAlpha * diffuseColor.w < 0.001){\n		discard;\n	}\n    materialSource.alpha *= maskAlpha;\n}\n",baseShadowPass_fs:"varying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec4 outColor ; \nvec2 uv_0;\nvoid main() {\n	uv_0 = varying_uv0;\n}",baseShadowPass_vs:"attribute vec3 attribute_position;\nattribute vec2 attribute_uv0;\nattribute vec4 attribute_color;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec4 outPosition ;\nvoid main(void){\n    e_position = attribute_position;\n    varying_color = attribute_color;\n    varying_uv0 = attribute_uv0;\n}",base_fs:"#extension GL_OES_standard_derivatives : enable\nvarying vec3 varying_eyeNormal  ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nuniform mat4 uniform_ViewMatrix ;\nstruct SurfaceOutput{\n  vec3 Albedo;\n  vec3 Normal;\n  vec4 Specular;\n  float Alpha ;\n};\nSurfaceOutput s ;\nvec4 outColor ;\nvec4 diffuseColor ;\nvec4 light ;\nvec3 normal;\nvec2 uv_0;\nvec3 flatNormals(vec3 pos) {\n  vec3 fdx = dFdx(pos);\n  vec3 fdy = dFdy(pos);\n  return normalize(cross(fdx, fdy));\n}\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n  return F0 + (1.0-F0) * pow( 1.0 - cosT, 5.0);\n}\nvoid main() {\n	diffuseColor  = vec4(1.0);\n	light         = vec4(0.0,0.0,0.0,-1.0); \n     \n    normal = normalize(varying_eyeNormal) ;\n	uv_0 = varying_uv0;\n}",base_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec3 e_normal = vec3(0.0, 0.0, 0.0);\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec3 varying_eyeNormal  ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec4 outPosition ;\nmat4 rotVertexMatrix;\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvoid main(void){\n	e_position = attribute_position;\n	e_normal = attribute_normal;\n	varying_color = attribute_color;\n	varying_uv0 = attribute_uv0;\n}",bezier:"vec2 quadratic_bezier(vec2 A, vec2 B, vec2 C, float t)\n{\n    vec2 D = mix(A, B, t);\n    vec2 E = mix(B, C, t); \n    return mix(D, E, t);\n}\nvec2 cubic_bezier(vec2 A, vec2 B, vec2 C, vec2 D, float t)\n{\n    vec2 E = mix(A, B, t);\n    vec2 F = mix(B, C, t);\n    vec2 G = mix(C, D, t);\n    return quadratic_bezier(E, F, G, t);\n}",bloom_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nuniform float bloom_amount = 0.15;\nvoid main(void) { \n	vec2 uv = vec2( varying_uv0.x , 1.0-varying_uv0.y );\n	vec4 color = texture2D(diffuseTexture, uv); \n  	vec4 sum = vec4(0), add = vec4(0), val = texture2D(diffuseTexture, uv);\n  \n        for( int i = -4 ; i < 4; i++) {\n             for ( int j = -4; j < 4; j++) {\n                 add += texture2D(diffuseTexture, uv + vec2(j, i)*0.002) * bloom_amount;\n             }\n        }\n	if (val.r < 0.2) { sum = add*add*0.012 + val; } else \n	if (val.r < 0.5) { sum = add*add*0.009 + val; } else {\n      sum = add*add*0.0075 + val;\n  }\n	gl_FragColor = vec4(sum.rgb, 1.0);\n}",colorCorrectionRamp_fs:"precision highp float;            	\nvarying vec2 varying_uv0; \nuniform float saturation; \nuniform sampler2D diffuseTexture; \nuniform sampler2D lutTexture; \nfloat Luminance( vec3 c ){ \nreturn dot( c , vec3(0.22,0.707,0.071) ); \n}\nvoid main() \n{ \nvec2 uv = varying_uv0 ; \nvec4 color = texture2D(diffuseTexture, uv); \nfloat red = texture2D(lutTexture, color.rr).r ;\nfloat green = texture2D(lutTexture,color.gg ).g ;\nfloat blue = texture2D(lutTexture, color.bb ).b ;\ncolor = vec4(red,green,blue, color.a); \ngl_FragColor = color ; \n}",colorCorrection_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform sampler2D lutTexture;\nuniform float saturation ;\nfloat Luminance( vec3 c ){\n    return dot( c , vec3(0.22,0.707,0.071) );\n}\nvoid main()\n{\n     vec2 uv = varying_uv0 ; \n	 vec4 color = texture2D(diffuseTexture, uv); \n		\n	 vec3 red = texture2D(lutTexture, vec2(color.r, 0.5/4.0)).rgb * vec3(1.0,0.0,0.0);\n	 vec3 green = texture2D(lutTexture, vec2(color.g, 1.5/4.0)).rgb * vec3(0.0,1.0,0.0);\n	 vec3 blue = texture2D(lutTexture, vec2(color.b, 2.5/4.0)).rgb * vec3(0.0,0.0,1.0);\n	 \n	 color = vec4(red+green+blue, color.a);\n	 float lum = Luminance(color.rgb);\n     gl_FragColor = color ;\n}",colorGradients_fs:"varying vec4 varying_mvPose;\nuniform float uniform_colorGradientsSource[6] ;\nvoid main(void){\n	float posStartY = uniform_colorGradientsSource[0]; \n	float posEndY = uniform_colorGradientsSource[1]; \n	vec4 color = vec4(uniform_colorGradientsSource[2], uniform_colorGradientsSource[3], uniform_colorGradientsSource[4], uniform_colorGradientsSource[5]); \n	color.w *= clamp((varying_mvPose.y - posStartY) / (posEndY - posStartY), 0.0, 1.0); \n	color.xyz *= color.w;\n	outColor.xyz = outColor.xyz * (1.0 - color.w) + color.xyz * color.w; \n	\n}\n ",colorPassEnd_fs:"void main() {\n	 gl_FragColor = vec4(diffuseColor.xyz,1.0);\n}",colorTransform_fs:"uniform float uniform_colorTransformAlpha ;\nuniform mat4 uniform_colorTransformM44 ;\nvoid main(){\n	diffuseColor.xyz = (uniform_colorTransformM44 * vec4(diffuseColor.xyz, 1.0)).xyz;\n	diffuseColor.w *= diffuseColor.w * uniform_colorTransformAlpha;\n}\n",color_fragment:"void main() {\n	s.Albedo.xyz = vec3(1.0, 1.0, 1.0);\n	s.Alpha = 1.0 ; \n  \n	if( varying_color.w < materialSource.cutAlpha ){ \n		discard; \n	}\n}",combin_fs:"uniform sampler2D colorTexture;\nvoid main(void){\n}",cube_fragment:"uniform samplerCube diffuseTexture3D ;\nvarying vec3 varying_pos;\nvec4 diffuseColor ;\nvoid main() {\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	vec3 uvw = normalize(varying_pos.xyz);\n	diffuseColor = vec4(textureCube(diffuseTexture3D, uvw.xyz));\n    \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}else\n		diffuseColor.xyz *= diffuseColor.w ;\n}",cube_vertex:"varying vec3 varying_pos;\nvoid main(void){\n   varying_pos =  e_position;\n} ",default_fragment:"#extension GL_OES_standard_derivatives:enable\nprecision highp float;              \n \nstruct SurfaceOutput{\n  vec3 Albedo;\n  vec3 Normal;\n  vec4 Specular;\n  float Alpha ;\n}; \nstruct MaterialSource{\n    vec3 diffuse;\n    vec3 ambient;\n    vec3 specular;\n    float alpha;\n    float cutAlpha;\n    float shininess;\n    float normalDir;\n    vec4 uvRectangle;\n    float gamma;\n    float specularScale;\n    float refraction;\n    float refractionintensity;\n}; \nvarying vec3 varying_eyeNormal; \nvarying vec2 varying_uv0; \nvarying vec4 varying_color; \nvarying vec4 varying_mvPose; \nSurfaceOutput s; \nvec4 outColor; \nvec4 diffuseColor; \nvec4 light; \nvec3 normal; \nvec2 uv_0; \nMaterialSource materialSource; \nvec4 specularColor; \nvec4 ambientColor; \nuniform mat4 uniform_ViewMatrix; \nuniform float uniform_materialSource[20]; \nuniform sampler2D diffuseTexture; \n \nvec3 flatNormals(vec3 pos) {\n  vec3 fdx = dFdx(pos);\n  vec3 fdy = dFdy(pos);\n  return normalize(cross(fdx, fdy));\n}\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n  return F0 + (1.0-F0) * pow( 1.0 - cosT, 5.0);\n}\nvoid main() {\n    diffuseColor  = vec4(1.0);\n    light         = vec4(0.0,0.0,0.0,-1.0); \n      \n    normal = normalize(varying_eyeNormal) ;\n    uv_0 = varying_uv0;\n \n    materialSource.diffuse.x = uniform_materialSource[0];\n    materialSource.diffuse.y = uniform_materialSource[1];\n    materialSource.diffuse.z = uniform_materialSource[2];\n     \n    materialSource.ambient.x = uniform_materialSource[3];\n    materialSource.ambient.y = uniform_materialSource[4];\n    materialSource.ambient.z = uniform_materialSource[5];\n     \n    materialSource.specular.x = uniform_materialSource[6];\n    materialSource.specular.y = uniform_materialSource[7];\n    materialSource.specular.z = uniform_materialSource[8];\n     \n    materialSource.alpha = uniform_materialSource[9];\n    materialSource.cutAlpha = uniform_materialSource[10];\n    materialSource.shininess = uniform_materialSource[11];\n    materialSource.specularScale = uniform_materialSource[12];\n    materialSource.normalDir = 1.0 ;    \n    materialSource.uvRectangle.x = uniform_materialSource[13];\n    materialSource.uvRectangle.y = uniform_materialSource[14];\n    materialSource.uvRectangle.z = uniform_materialSource[15];\n    materialSource.uvRectangle.w = uniform_materialSource[16];\n    materialSource.gamma = uniform_materialSource[17];\n    materialSource.refraction = uniform_materialSource[18];\n    materialSource.refractionintensity = uniform_materialSource[19];\n    uv_0 = varying_uv0.xy * materialSource.uvRectangle.zw + materialSource.uvRectangle.xy ;\n \n    vec3 fc = vec3(0.0, 0.0, 0.0);\n    vec4 c = texture2D( diffuseTexture , uv_0 );\n    c.xyz = c.xyz * materialSource.diffuse * c.a ; \n    if (c.a < materialSource.cutAlpha)\n        discard;\n    if(materialSource.refraction<2.41){ \n       float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n       fc = Fresnel_Schlick(vl,vec3(materialSource.refraction)) * materialSource.refractionintensity ; \n       fc.xyz = max(fc,vec3(0.0)) ; \n    } \n    s.Normal = normal;\n    s.Specular = vec4(1.0) ;\n    s.Albedo = c.rgb + fc.xyz * c.rgb + materialSource.ambient * c.rgb;\n    s.Albedo.x = pow(s.Albedo.x, materialSource.gamma);\n    s.Albedo.y = pow(s.Albedo.y, materialSource.gamma);\n    s.Albedo.z = pow(s.Albedo.z, materialSource.gamma);\n    s.Alpha = c.a;\n    outColor.xyz = s.Albedo * 0.5 ;\n    outColor.w = s.Alpha;\n \n    if(light.w < 0.0 ){\n       outColor.xyz = s.Albedo.xyz ; \n    }else{\n       outColor.xyzw = light ; \n    }\n    outColor.xyzw *= varying_color.xyzw;\n \n    gl_FragColor = outColor;\n}",default_vertex:"precision highp float;              \nattribute vec3 attribute_position; \nattribute vec3 attribute_normal; \nattribute vec4 attribute_color; \nattribute vec2 attribute_uv0; \nvarying vec3 varying_eyeNormal; \nvarying vec2 varying_uv0; \nvarying vec4 varying_color; \nvarying vec4 varying_mvPose; \nvec3 e_position =  vec3(0.0, 0.0, 0.0); \nvec3 e_normal =  vec3(0.0, 0.0, 0.0); \nvec4 outPosition; \nmat4 rotVertexMatrix; \nvec4 endPosition; \nuniform mat4 uniform_ModelMatrix; \nuniform mat4 uniform_ViewMatrix; \nuniform mat4 uniform_ProjectionMatrix; \nuniform float uniform_materialSource[20]; \n \nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvoid main(void){\n    e_position = attribute_position;\n    e_normal = attribute_normal;\n    varying_color = attribute_color;\n    varying_uv0 = attribute_uv0;\n \n     \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n     \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n     \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n     \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n     \n    outPosition = varying_mvPose ; \n    varying_color = attribute_color; \n     \n \n     gl_PointSize = uniform_materialSource[17];\n     outPosition = uniform_ProjectionMatrix * outPosition ;\n \n     gl_Position = outPosition ;\n}",detail_Bending_vs:"uniform float uniformTime[4] ;\nvoid main(void){\n	e_position = attribute_position; \nvarying_uv0 = attribute_uv0; \n  \n  varying_color = attribute_color; \nvec4 curve = SmoothTriangleWave(vec4(sin(uniformTime[0]*0.001),1.0,1.0,1.0));\n e_position.xyz += curve.x * vec3(1.0,0.5,0.0) * ( attribute_color.xyz) ;\n}",diffuse_fragment:"uniform sampler2D diffuseTexture;\nvarying vec4 varying_mvPose;\nvoid main() {\n  	vec3 fc = vec3(0.0, 0.0, 0.0);\n	vec4 c = texture2D( diffuseTexture , uv_0 );\n    c.xyz = c.xyz * materialSource.diffuse * c.a ; \n	if (c.a < materialSource.cutAlpha)\n		discard;\n	if(materialSource.refraction<2.41){ \n       float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n       fc = Fresnel_Schlick(vl,vec3(materialSource.refraction)) * materialSource.refractionintensity ; \n       fc.xyz = max(fc,vec3(0.0)) ; \n    } \n	s.Normal = normal;\n	s.Specular = vec4(1.0) ;\n	s.Albedo = c.rgb + fc.xyz * c.rgb + materialSource.ambient * c.rgb;\n    s.Albedo.x = pow(s.Albedo.x, materialSource.gamma);\n    s.Albedo.y = pow(s.Albedo.y, materialSource.gamma);\n    s.Albedo.z = pow(s.Albedo.z, materialSource.gamma);\n	s.Alpha = c.a;\n	outColor.xyz = s.Albedo * 0.5 ;\n	outColor.w = s.Alpha;\n}\n",diffuse_vertex:"attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_mvPose; \nvoid main(void){\n    \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    \n    outPosition = varying_mvPose ; \n    varying_color = attribute_color; \n    \n}\n",directLight_fragment:"const int max_directLight = 0 ;\nuniform float uniform_directLightSource[10*max_directLight] ;\nvarying vec4 varying_mvPose; \nuniform mat4 uniform_ViewMatrix;\nmat4 normalMatrix ;\nstruct DirectLight{\n    vec3 direction;\n	vec3 diffuse;\n	vec3 ambient;\n    float intensity;\n};\nmat4 transpose(mat4 inMatrix) {\n    vec4 i0 = inMatrix[0];\n    vec4 i1 = inMatrix[1];\n    vec4 i2 = inMatrix[2];\n    vec4 i3 = inMatrix[3];\n    mat4 outMatrix = mat4(\n                 vec4(i0.x, i1.x, i2.x, i3.x),\n                 vec4(i0.y, i1.y, i2.y, i3.y),\n                 vec4(i0.z, i1.z, i2.z, i3.z),\n                 vec4(i0.w, i1.w, i2.w, i3.w)\n                 );\n    return outMatrix;\n}\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\nvec4 calculateDirectLight( MaterialSource materialSource ){ \n    float lambertTerm , specular ; \n    vec3 dir ,viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    diffuseColor = vec4(0.0,0.0,0.0,1.0);\n    for(int i = 0 ; i < max_directLight ; i++){ \n        DirectLight directLight ; \n        directLight.direction = (normalMatrix * vec4(uniform_directLightSource[i*9],uniform_directLightSource[i*9+1],uniform_directLightSource[i*9+2],1.0)).xyz; \n		directLight.diffuse = vec3(uniform_directLightSource[i*9+3],uniform_directLightSource[i*9+4],uniform_directLightSource[i*9+5]); \n		directLight.ambient = vec3(uniform_directLightSource[i*9+6],uniform_directLightSource[i*9+7],uniform_directLightSource[i*9+8]); \n		directLight.intensity = uniform_directLightSource[i*9+9] ; \n		dir = normalize(directLight.direction) ; \n		diffuseColor += LightingBlinnPhong(dir,directLight.diffuse,directLight.ambient,s.Normal,viewDir,directLight.intensity); \n    } \n    return diffuseColor ;\n}\nvoid main() {\n	normalMatrix = inverse(uniform_ViewMatrix);\n	normalMatrix = transpose(normalMatrix);\n	light += calculateDirectLight( materialSource ).xyzw ; \n}\n",endShadowPass_fs:"void main() {\n    if(varying_color.w<=0.0){\n       discard;\n    }\n    outColor.x =  outColor.y = outColor.z = varying_ViewPose.z/varying_ViewPose.w  ;\n    outColor.w = 1.0 ;\n    gl_FragColor = outColor ;\n}\n",endShadowPass_vs:"void main() {\n	 outPosition = uniform_ProjectionMatrix * outPosition ;\n     gl_Position = outPosition ;\n}\n                      ",end_fs:"varying vec4 varying_mvPose; \nvec4 diffuseColor ;\nvec4 specularColor ;\nvec4 ambientColor;\nvec4 light ;\nvoid main() {\n	if(light.w < 0.0 ){\n	   outColor.xyz = s.Albedo.xyz ; \n	}else{\n	   outColor.xyzw = light ; \n	}\n    outColor.xyzw *= varying_color.xyzw;\n}\n",end_vs:"vec4 endPosition ;\nuniform float uniform_materialSource[20];\nvoid main() {\n	 gl_PointSize = uniform_materialSource[17];\n     outPosition = uniform_ProjectionMatrix * outPosition ;\n}\n                      ",environmentDiffuse_vertex:"\nvoid main(){\n}\n",environmentMapping_fragment:"uniform samplerCube environmentMapTex ;\nuniform float reflectValue;\nvarying vec3 varying_ViewDir ;\nvoid main(){\n	 vec3 N = normalize(normal);\n	vec3 V = normalize(varying_mvPose.xyz/varying_mvPose.w);\n	float dotNV = clamp(dot(N,V), 0.0, 1.0);	float FV = pow((1.0 - dotNV), 2.0);\n	\n	mat4 invViewMatrix = inverse(uniform_ViewMatrix);\n	vec3 ecReflected = reflect(normalize(varying_ViewDir.xyz), normalize(mat3(invViewMatrix)*normal));	vec4 reflectiveColor = textureCube(environmentMapTex,-normalize(ecReflected.xyz)); \n	diffuseColor.xyz = mix( diffuseColor.xyz,reflectiveColor.xyz, reflectValue + FV );  \n	\n}\n         ",expFog_fs:"struct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   vec3 distance ;\n};\nvarying vec4 varying_pos;\nuniform float uniform_globalFog[7];\nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.distance = vec2(uniform_globalFog[4], uniform_globalFog[5]); \n    float d = distance(uniform_eyepos,varying_pos.xyz); \n    float distFog = max( 0.0 , d - fog.distance.x )* fog.distance.y; \n    float fogFactor = (1.0-exp( -distFog * 0.000001 * fog.globalDensity )) ; \n    diffuseColor.xyz = mix( diffuseColor.xyz  , fog.fogColor , min(fogFactor,1.0) ); \n}\n ",expHeightFog_fs:"struct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   float fogStartDistance ;\n   float fogHeightStart ;\n   float fogAlpha ;\n};\nvarying vec4 varying_pos;\nuniform float uniform_globalFog[7];\nvec3 applyFog( float yDistance, vec3  vpos , Fog fog ) \n{\n    float d = distance(uniform_eyepos,varying_pos.xyz); \n    float distFog = max( 0.0 , d - fog.fogStartDistance ) ; \n    float yFog = max(0.0, (vpos.y - fog.fogHeightStart - yDistance) )  ; \n    float fogAmount =  1.0-(exp(-distFog * fog.globalDensity )) + (exp(-yFog * fog.globalDensity )); \n    return mix( diffuseColor.xyz,fog.fogColor, clamp(fogAmount,0.0,fog.fogAlpha) );\n}\n \nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.fogStartDistance = uniform_globalFog[4] ; \n    fog.fogHeightStart = uniform_globalFog[5] ;\n    fog.fogAlpha = uniform_globalFog[6] ; \n    fog.fogColor *= diffuseColor.w;\n    float yd = uniform_eyepos.y - varying_pos.y ;\n    diffuseColor.xyz = applyFog( yd , varying_pos.xyz , fog );\n}\n ",flatNormal_fs:"#extension GL_OES_standard_derivatives : enable\nvec3 flatNormal(vec3 pos){\n    vec3 fdx = dFdx(pos);\n    vec3 fdy = dFdy(pos);\n    return normalize(cross(fdx, fdy));\n}",gamma_fs:"\nconst float gamma = 2.2;\nfloat toLinear_float_v1(float v) {\n  return pow(v, gamma);\n}\nvec2 toLinear_vec2_v1(vec2 v) {\n  return pow(v, vec2(gamma));\n}\nvec3 toLinear_vec3_v1(vec3 v) {\n  return pow(v, vec3(gamma));\n}\nvec4 toLinear_vec4_v1(vec4 v) {\n  return vec4(toLinear_vec3_v1(v.rgb), v.a);\n}\nfloat toGamma_float_v2(float v) {\n  return pow(v, 1.0 / gamma);\n}\nvec2 toGamma_vec2_v2(vec2 v) {\n  return pow(v, vec2(1.0 / gamma));\n}\nvec3 toGamma_vec3_v2(vec3 v) {\n  return pow(v, vec3(1.0 / gamma));\n}\nvec4 toGamma_vec4_v2(vec4 v) {\n  return vec4(toGamma_vec3_v2(v.rgb), v.a);\n}\nvec4 textureLinear(sampler2D uTex, vec2 uv) {\n  return toLinear_vec4_v1(texture2D(uTex, uv));\n}",gaussian_H_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) {\n    vec4 color = vec4(0.0);\n    vec2 tc = uv;\n    float blur = radius/resolution ; \n    float hstep = dir.x;\n    float vstep = dir.y;\n    color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162;\n    color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270;\n    color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162;\n  return color;\n}\nvoid main(void) { \n	vec4 color = vec4(0.0,0.0,0.0,0.0); \n	color =blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(0.0,1.0));\n	gl_FragColor  = color; \n}",gaussian_V_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform sampler2D colorTexture;\nvec4 blur9_1_0(sampler2D image, vec2 uv, float radius , float resolution, vec2 dir) {\n    vec4 color = vec4(0.0);\n    vec2 tc = uv;\n    float blur = radius/resolution ; \n    float hstep = dir.x;\n    float vstep = dir.y;\n    color += texture2D(image, vec2(tc.x - 4.0*blur*hstep, tc.y - 4.0*blur*vstep)) * 0.0162162162;\n    color += texture2D(image, vec2(tc.x - 3.0*blur*hstep, tc.y - 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x - 2.0*blur*hstep, tc.y - 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x - 1.0*blur*hstep, tc.y - 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x, tc.y)) * 0.2270270270;\n    color += texture2D(image, vec2(tc.x + 1.0*blur*hstep, tc.y + 1.0*blur*vstep)) * 0.1945945946;\n    color += texture2D(image, vec2(tc.x + 2.0*blur*hstep, tc.y + 2.0*blur*vstep)) * 0.1216216216;\n    color += texture2D(image, vec2(tc.x + 3.0*blur*hstep, tc.y + 3.0*blur*vstep)) * 0.0540540541;\n    color += texture2D(image, vec2(tc.x + 4.0*blur*hstep, tc.y + 4.0*blur*vstep)) * 0.0162162162;\n  return color;\n}\nvoid main(void) { \n	vec4 color = vec4(0.0,0.0,0.0,0.0); \n	vec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y);\n	color = blur9_1_0(diffuseTexture,varying_uv0,3.0,2048.0,vec2(1.0,0.0));\n	color += texture2D(colorTexture,uv);\n	gl_FragColor  = color; \n}",grass_fs:"uniform float uniform_lightMap_data[5];\nuniform sampler2D diffuseTexture;\nuniform sampler2D lightMapTexture;\nvarying vec4 varying_scenePose;\nvec4 diffuseColor;\nvoid main() {\n	vec2 lightUV;\n	diffuseColor = texture2D(diffuseTexture, varying_uv0);\n	if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n	if(uniform_lightMap_data[0] > 0.5){\n		lightUV.x = (varying_scenePose.x + uniform_lightMap_data[1]) / uniform_lightMap_data[3]; \n		lightUV.y = (varying_scenePose.z + uniform_lightMap_data[2]) / uniform_lightMap_data[4]; \n		diffuseColor *= texture2D(lightMapTexture, lightUV); \n	}\n	outColor = diffuseColor;\n}",grass_vs:"attribute vec3 attribute_grassOffset;\nattribute float attribute_grassAngleY;\nuniform float uniform_grass_data[9];\nuniform float uniform_squeeze_data[6];\nuniform float uniform_lightMap_data[5];\nuniform mat4 uniform_cameraMatrix;\nuniform mat4 uniform_billboardMatrix;\nvarying vec4 varying_mvPose; \nvarying vec4 varying_scenePose;\nconst float TrueOrFalse = 0.5;\nconst float PI_2 = 6.283;\nstruct SqueezeData{\n	float enable;\n	vec3 position;\n	float strength;\n	float radius;\n};\nSqueezeData squeezeData;\nmat4 buildRotMat4(vec3 rot)\n{\n	float s;\n	float c;\n	s = sin(rot.x);\n	c = cos(rot.x);\n	\n	mat4 ret = mat4(\n	vec4(1.0, 0.0, 0.0, 0.0),\n	vec4(0.0, c, s, 0.0),\n	vec4(0.0, -s, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	);\n	\n	s = sin(rot.y);\n	c = cos(rot.y);\n	\n	ret = mat4(\n	vec4(c, 0.0, -s, 0.0),\n	vec4(0.0, 1.0, 0.0, 0.0),\n	vec4(s, 0.0, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	s = sin(rot.z);\n	c = cos(rot.z);\n	ret = mat4(\n	vec4(c, s, 0.0, 0.0),\n	vec4(-s, c, 0.0, 0.0),\n	vec4(0.0, 0.0, 1.0, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	return ret;\n}\nvec4 buildQuat(vec3 axis, float angle){\n  axis = normalize(axis);\n  vec4 ret;\n  \n  float halfAngle = angle * 0.5;\n  float sin_a = sin(angle);\n  ret.w = cos(halfAngle);\n  ret.x = axis.x * sin_a;\n  ret.y = axis.y * sin_a;\n  ret.z = axis.z * sin_a;\n  \n  ret = normalize(ret);\n  return ret;\n}\nmat4 buildMat4Quat(vec4 quat)\n{\n	float xx = quat.x * quat.x;\n	float xy = quat.x * quat.y;\n	float xz = quat.x * quat.z;\n	float xw = quat.x * quat.w;\n	float yy = quat.y * quat.y;\n	float yz = quat.y * quat.z;\n	float yw = quat.y * quat.w;\n	float zz = quat.z * quat.z;\n	float zw = quat.z * quat.w;\n	return mat4(\n		1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n		2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n		2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n		0.0,							0.0,					0.0,					1\n	);\n}\nvoid main(void){\n	\n	if(uniform_grass_data[8] > TrueOrFalse){\n		rotVertexMatrix = uniform_billboardMatrix;\n	}else{\n		rotVertexMatrix = buildRotMat4(vec3(0.0, attribute_grassAngleY, 0.0));\n	}\n	e_position.xyz = (rotVertexMatrix * vec4(e_position, 1.0)).xyz;\n	e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz;\n	if(e_position.y > 0.0){ \n		float windDirectionX			= uniform_grass_data[0];\n		float windDirectionZ			= uniform_grass_data[1];\n		float windSpaceX				= uniform_grass_data[2];\n		float windSpaceZ				= uniform_grass_data[3];\n		float windStrength				= uniform_grass_data[4];\n		float windSpeed					= uniform_grass_data[5];\n		float shakeScale				= uniform_grass_data[6];\n		float grassTime					= uniform_grass_data[7];\n		squeezeData.enable			= uniform_squeeze_data[0];\n		squeezeData.position.x		= uniform_squeeze_data[1];\n		squeezeData.position.y		= uniform_squeeze_data[2];\n		squeezeData.position.z		= uniform_squeeze_data[3];\n		squeezeData.radius			= uniform_squeeze_data[4];\n		squeezeData.strength		= uniform_squeeze_data[5];\n		windSpaceX = PI_2 * (attribute_grassOffset.x + abs(windDirectionX) * windSpeed * grassTime) / windSpaceX;\n		windSpaceZ = PI_2 * (attribute_grassOffset.z + abs(windDirectionZ) * windSpeed * grassTime) / windSpaceZ;\n		\n		float angle = sin(windSpaceX + windSpaceZ) * shakeScale + windStrength;\n		angle = clamp(angle, -1.57, 1.57);\n    \n		vec3 windDir = vec3(windSpaceX, 0.0, windSpaceZ);\n		vec3 windDirY = vec3(0.0, 1.0, 0.0);\n		windDir = normalize(windDir);\n    \n		vec3 axis = cross(windDirY,windDir); \n		vec4 quat = buildQuat(axis, angle);\n		mat4 matrix = buildMat4Quat(quat);\n    \n		vec2 orgXZ = vec2(e_position.x, e_position.z);\n		e_position.x = e_position.z = 0.0;\n		e_position = (matrix * vec4(e_position, 1.0)).xyz;\n   \n		e_position.xz += orgXZ;\n		if(squeezeData.enable > TrueOrFalse){\n			vec3 distanceVec3 = squeezeData.position - attribute_grassOffset;\n			vec2 distance2D = vec2(distanceVec3.x, distanceVec3.z);\n			float distanceFloat = sqrt(dot(distance2D, distance2D));\n			if(distanceFloat < squeezeData.radius){\n				float ratio = distanceFloat / squeezeData.radius;\n				ratio = 1.0 - ratio;\n				distanceVec3 = normalize(distanceVec3);\n				distanceVec3 *= squeezeData.strength * ratio * abs(e_position.y - squeezeData.position.y);\n				e_position -= distanceVec3;\n			}\n		}\n	}\n	e_position += attribute_grassOffset;\n	mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix);\n	varying_mvPose = outPosition = mvMatrix * vec4( e_position , 1.0 ); \n    varying_scenePose = vec4( e_position, 1.0 );\n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n    varying_color = attribute_color; \n    \n}\n",gui_fs:"varying vec4 varying_uv; \nvarying vec4 varying_color; \nvarying vec4 varying_pos; \nvarying vec4 varying_mask; \nvec4 diffuseColor; \nuniform sampler2D uiTexture_0; \nuniform sampler2D uiTexture_1; \nuniform sampler2D uiTexture_2; \nuniform sampler2D uiTexture_3; \nuniform sampler2D uiTexture_4; \nuniform sampler2D uiTexture_5; \nuniform sampler2D uiTexture_6; \nconst int FLAG_VALLID_QUAD = 0;\nconst int FLAG_IS_VISIBLE = 1;\nconst int FLAG_HAS_MASK = 2;\nconst int FLAG_HAS_TEXTURE = 3;\nconst int FLAG_IS_TEXTFIELD = 4;\nbool booleanArray[5];\nvoid decodeBooleanArray(float data){\n	float headData;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[0] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[1] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[2] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[3] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[4] = (headData - data) > 0.2;\n}\nvoid main(void){\n	decodeBooleanArray(varying_pos.w);\n	\n	\n	if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){\n		discard;\n	}\n	if(booleanArray[FLAG_HAS_MASK]){\n      vec4 mask = varying_mask;\n      if( (2.0*mask.x-1.0) > varying_pos.x){ \n		discard; \n      } \n      if( (-2.0*mask.y+1.0) < varying_pos.y){\n		discard; \n      }\n      if( (2.0*mask.z-1.0) < varying_pos.x){\n		discard; \n      }\n      if( (-2.0*mask.w+1.0) > varying_pos.y){\n		discard; \n      }\n	}\n	vec2 uv = varying_uv.xy ;\n	int index = int(floor(varying_pos.z)); \n	if(booleanArray[FLAG_HAS_TEXTURE] == false){\n		diffuseColor = vec4(1.0, 1.0, 1.0, 1.0);	}\n	else{\n		if(index==0){\n			diffuseColor = texture2D(uiTexture_0, uv ); \n		}\n		else if(index==1){\n			diffuseColor = texture2D(uiTexture_1, uv ); \n		}\n		else if(index==2){\n			diffuseColor = texture2D(uiTexture_2, uv ); \n		}\n		else if(index==3){\n			diffuseColor = texture2D(uiTexture_3, uv ); \n		}\n		else if(index==4){\n			diffuseColor = texture2D(uiTexture_4, uv ); \n		}\n		else if(index==5){\n			diffuseColor = texture2D(uiTexture_5, uv ); \n		}\n		else if(index==6){\n			diffuseColor = texture2D(uiTexture_6, uv ); \n		}\n		if(booleanArray[FLAG_IS_TEXTFIELD]){\n			int clrChannel = int(uv.x);\n			uv.x -= float(clrChannel);\n			float fontAlpha = 1.0;\n			if(clrChannel == 0){\n				fontAlpha = diffuseColor.x;\n			}else if(clrChannel == 1){\n				fontAlpha = diffuseColor.y;\n			} else if(clrChannel == 2){\n				fontAlpha = diffuseColor.z;\n			}else if(clrChannel == 3){\n				fontAlpha = diffuseColor.w;\n			}\n			if(fontAlpha > 0.9){\n				fontAlpha = 1.0;\n			}\n			diffuseColor = vec4(1.0, 1.0, 1.0, fontAlpha);\n		}\n	}\n \n	if(diffuseColor.w < 0.01 || varying_color.w < 0.01){\n		discard;\n	}\n	diffuseColor.xyz *= varying_color.xyz;\n	diffuseColor.w *= varying_color.w;\n	diffuseColor.xyz *= diffuseColor.w;\n	diffuseColor = clamp(diffuseColor, 0.0, 1.0); \n	gl_FragColor = diffuseColor; \n}",gui_vs:"attribute vec4 attribute_position; \nattribute vec4 attribute_shapePosition; \nattribute vec4 attribute_uvRec; \nattribute vec4 attribute_rotate; \nattribute vec4 attribute_maskRectangle; \nattribute vec4 attribute_quad_color; \nvarying vec4 varying_uv; \nvarying vec4 varying_color; \nvarying vec4 varying_pos; \nvarying vec4 varying_mask; \nvarying float varying_boolList;\nvec4 outPosition; \nuniform mat4 uniform_ModelMatrix; \nuniform mat4 uniform_ViewMatrix; \nuniform mat4 uniform_ProjectionMatrix; \nuniform mat4 uniform_orthProjectMatrix; \nuniform float uniform_materialSource[20]; \nmat4 buildMat4Quat(vec4 quat){ \nfloat xx = quat.x * quat.x; \nfloat xy = quat.x * quat.y; \nfloat xz = quat.x * quat.z; \nfloat xw = quat.x * quat.w; \nfloat yy = quat.y * quat.y; \nfloat yz = quat.y * quat.z; \nfloat yw = quat.y * quat.w; \nfloat zz = quat.z * quat.z; \nfloat zw = quat.z * quat.w; \nreturn mat4( \n1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0, \n2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0, \n2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0, \n0.0,							0.0,					0.0,					1 \n); \n}\nconst int FLAG_VALLID_QUAD = 0;\nconst int FLAG_IS_VISIBLE = 1;\nconst int FLAG_HAS_MASK = 2;\nconst int FLAG_HAS_TEXTURE = 3;\nconst int FLAG_IS_TEXTFIELD = 4;\nbool booleanArray[5];\nvoid decodeBooleanArray(float data){\n	float headData;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[0] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[1] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[2] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[3] = (headData - data) > 0.2;\n	data *= 0.5;\n	headData = data;\n	data = floor(data);\n	booleanArray[4] = (headData - data) > 0.2;\n}\nvoid main(void){\n	gl_PointSize = uniform_materialSource[18];\n	varying_pos.zw = attribute_shapePosition.zw;\n	decodeBooleanArray(attribute_shapePosition.w);\n	if(booleanArray[FLAG_VALLID_QUAD] == false || booleanArray[FLAG_IS_VISIBLE] == false || booleanArray[FLAG_HAS_TEXTURE] == false){\n		outPosition = vec4(0.0,0.0,0.0,1.0);\n		gl_Position = outPosition; \n		return;\n	}\n    float devicePixelRatio = 1.0;    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    mat4 po = buildMat4Quat(attribute_rotate.xyzw); \n    mat4 oth = uniform_orthProjectMatrix; \n    float px = oth[0].x ;\n    float py = oth[1].y ;\n    \n    oth[0].x = oth[0].x / devicePixelRatio ; \n    oth[1].y = oth[1].y / devicePixelRatio ; \n    \n    vec3 pos = mat3(po) * (attribute_position.xyz * vec3(attribute_uvRec.zw,1.0) ) + vec3(attribute_shapePosition.xy,1.0) ; \n    vec3 sceneWH = vec3( 1.0/ oth[0].x, -1.0/oth[1].y , 0.0 )  ; \n    outPosition = mvMatrix * vec4( pos - sceneWH , 1.0 ) ; \n    varying_color = attribute_quad_color ; \n    \n    outPosition = oth * outPosition ; \n	varying_pos.xy = outPosition.xy;\n    vec4 maskk = attribute_maskRectangle;\n    \n    sceneWH = vec3(2.0/px*devicePixelRatio,2.0/py*devicePixelRatio,1.0) ;\n    \n    varying_mask = vec4(maskk.xy/sceneWH.xy,(maskk.x+maskk.z)/sceneWH.x, (maskk.y+maskk.w)/(sceneWH.y)) ; \n    varying_uv = attribute_uvRec; \n	gl_Position = outPosition; \n    \n}",hud_H_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvoid main(void) {\n	vec2 uv = vec2(varying_uv0.x ,1.0-varying_uv0.y);\n	vec4 color = texture2D(diffuseTexture, uv);\n	gl_FragColor  = color;\n}\n",hud_V_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nvoid main(void) {\n	vec4 color = texture2D(diffuseTexture, varying_uv0);\n	gl_FragColor  = color;\n}\n",hud_cull_fs:"varying vec2 varying_uv0;\nuniform sampler2D diffuseTexture;\nuniform vec2 uv_scale;\nvoid main(void) {\n	vec2 uv_0 = varying_uv0;\n	uv_0 *= uv_scale;\n	vec4 color = texture2D(diffuseTexture, varying_uv0);\n	float mask = 1.0;\n	float f = uv_scale.y - varying_uv0.y;\n	if (varying_uv0.y < uv_scale.y){\n		if(f < 0.03 && f > 0.0){\n			mask =1.0 - (f / 0.03 * 0.9 + 0.1);\n		}\n		else{\n			mask = 0.1;\n		}\n	}\n	color.xyz *= mask;\n	gl_FragColor  = color;\n}\n",hud_vs:"attribute vec3 attribute_position;\nattribute vec2 attribute_uv0;\nvarying  vec2 varying_uv0;                      \nuniform  mat4 uniform_ViewProjectionMatrix;\nvoid main(void) {\n    vec4 pos = vec4(attribute_position, 1.0);\n    gl_Position = uniform_ViewProjectionMatrix * pos;\n    varying_uv0 = attribute_uv0;\n}",lightMapSpecularPower_fs:"uniform sampler2D lightTexture ;\nvarying vec2 varying_uv1 ;\nvec4 decode_hdr( vec4 data ){ \n    data.w = data.w * 255.0 - 128.0 ; \n    data.w = pow( 2.0 ,data.w); \n    data.xyz *= data.w ; \n    return data ; \n}\nvoid main(void){\n	vec4 lightmap = texture2D( lightTexture , varying_uv1 );\n    lightmap.xyz = decode_hdr(lightmap).xyz ;\n	outColor.xyz *= lightmap.xyz ;\n}\n ",lightMap_fs:"uniform sampler2D lightTexture ;\nvarying vec2 varying_uv1 ;\nvec4 decode_hdr( vec4 data ){ \n    data.w = data.w * 255.0 - 128.0 ; \n    data.w = pow( 2.0 ,data.w); \n    data.xyz *= data.w ; \n    return data ; \n}\nvoid main(void){\n	vec4 lightmap = texture2D( lightTexture , varying_uv1 );\n	lightmap.xyz = decode_hdr(lightmap).xyz  ;\n    outColor.xyz *= lightmap.xyz ; \n}\n",lightingBase_fs:"vec4 LightingBlinnPhong(vec3 lightDir, vec3 lightColor , vec3 lightAmbient , vec3 normal , vec3 viewDir, float atten){ \n	vec3 h = normalize(lightDir + normalize(viewDir)); \n	float diff = max(dot(normal, lightDir),0.0); \n	float nh = max(dot(normal,h),0.0); \n	float spec = pow(nh, materialSource.shininess ) * materialSource.specularScale ; \n	vec4 c ; \n	c.rgb = (s.Albedo * lightColor * diff + lightColor * materialSource.specular.rgb * s.Specular.rgb * spec) * (atten * 2.0); \n	c.a = s.Alpha + spec * atten; \n	return c; \n}\nvoid main(void) {\n}\n",lineFog:" \nstruct Fog{\n   vec3 fogColor  ;\n   float globalDensity ;\n   float fogStartDistance ;\n   float fogFarDistance ;\n   float fogAlpha ;\n};\nuniform float uniform_globalFog[7];\nvarying vec4 varying_mvPose;\nvoid main(void){\n    Fog fog; \n    fog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \n    fog.globalDensity = uniform_globalFog[3]; \n    fog.fogStartDistance = uniform_globalFog[4] ;\n    fog.fogFarDistance = uniform_globalFog[5] ;\n    fog.fogAlpha = uniform_globalFog[6] ;\n    \n	fog.fogColor *= outColor.w;\n	float d = varying_mvPose.z ; \n	float distFog = max( 0.0 , d -  fog.fogStartDistance ) ; \n	outColor.xyz = mix( outColor.xyz,fog.fogColor, clamp(distFog/fog.fogFarDistance,0.0,1.0) * fog.fogAlpha ) ; \n}\n",matCapPass_vs:"varying vec2 capCoord ;\nvoid main(void){\n        capCoord.x = dot(normalMatrix[0].xyz,normal);\n        capCoord.y = dot(normalMatrix[1].xyz,normal);\n        capCoord = capCoord * 0.5 + 0.5;\n        ambientColor.xyz +=  + capCoord.xyz * 2.0 - 1.0 ;\n}",matCap_TextureAdd_fs:"uniform sampler2D matcapTexture;\nvoid main() {\n  	vec4 capCoord ; \n	capCoord.x = -normal.x; \n	capCoord.y = normal.y; \n	capCoord.xy = capCoord.xy * 0.5 + 0.5; \n	capCoord = texture2D(matcapTexture , capCoord.xy ) * 2.0 - 1.0 ; \n	ambientColor.xyz += capCoord.xyz ; \n}\n",matCap_TextureMult_fs:"uniform sampler2D matcapTexture;\nvoid main() {\n  	vec4 capCoord ; \n	capCoord.x = -normal.x; \n	capCoord.y = normal.y; \n	capCoord.xy = capCoord.xy * 0.5 + 0.5; \n	capCoord = texture2D(matcapTexture , capCoord.xy ) ; \n	diffuseColor.xyz *= capCoord.xyz * 2.0 ; \n}\n",materialSource_fs:"struct MaterialSource{\n    vec3 diffuse;\n    vec3 ambient;\n    vec3 specular;\n    float alpha;\n    float cutAlpha;\n    float shininess;\n    float normalDir;\n    vec4 uvRectangle;\n    float gamma;\n    float specularScale;\n    float refraction;\n    float refractionintensity;\n}; \nuniform float uniform_materialSource[20] ;\nMaterialSource materialSource ;\nvec2 uv_0 ;\nvoid main(){\n	materialSource.diffuse.x = uniform_materialSource[0];\n	materialSource.diffuse.y = uniform_materialSource[1];\n	materialSource.diffuse.z = uniform_materialSource[2];\n	\n	materialSource.ambient.x = uniform_materialSource[3];\n	materialSource.ambient.y = uniform_materialSource[4];\n	materialSource.ambient.z = uniform_materialSource[5];\n	\n	materialSource.specular.x = uniform_materialSource[6];\n	materialSource.specular.y = uniform_materialSource[7];\n	materialSource.specular.z = uniform_materialSource[8];\n	\n	materialSource.alpha = uniform_materialSource[9];\n	materialSource.cutAlpha = uniform_materialSource[10];\n	materialSource.shininess = uniform_materialSource[11];\n	materialSource.specularScale = uniform_materialSource[12];\n	materialSource.normalDir = 1.0 ;    \n	materialSource.uvRectangle.x = uniform_materialSource[13];\n	materialSource.uvRectangle.y = uniform_materialSource[14];\n	materialSource.uvRectangle.z = uniform_materialSource[15];\n	materialSource.uvRectangle.w = uniform_materialSource[16];\n	materialSource.gamma = uniform_materialSource[17];\n	materialSource.refraction = uniform_materialSource[18];\n	materialSource.refractionintensity = uniform_materialSource[19];\n	uv_0 = varying_uv0.xy * materialSource.uvRectangle.zw + materialSource.uvRectangle.xy ;\n}",mulUvRoll_fs:"uniform float mulUvRoll[4] ;\nuniform sampler2D diffuseTexture;\nuniform sampler2D diffuseTexture1;\nvec4 diffuseColor ;\nvec2 uv_1;\nvoid main() {\n	uv_1 = varying_uv0;\n    uv_0.xy += vec2(mulUvRoll[0],mulUvRoll[1]);\n	uv_1.xy += vec2(mulUvRoll[2],mulUvRoll[3]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 ) * texture2D(diffuseTexture1 , uv_1 );\n	diffuseColor.xyz = clamp(diffuseColor.xyz / diffuseColor.w,0.0,1.0);\n}",normalMap_fragment:"uniform sampler2D normalTexture;\nvarying vec2 varying_uv0        ;\nvarying vec4 varying_mvPose        ;\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n  vec3 dp1 = dFdx(p);\n  vec3 dp2 = dFdy(p);\n  vec2 duv1 = dFdx(uv);\n  vec2 duv2 = dFdy(uv);\n  vec3 dp2perp = cross(dp2, N);\n  vec3 dp1perp = cross(N, dp1);\n  vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n  vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n  float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n  return mat3(T * invmax, B * invmax, N);\n}\nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) {\n  mat3 TBN = cotangentFrame(N, -V, texcoord);\n  return normalize(TBN * map);\n}\nvoid main(){\n   s.Normal = texture2D(normalTexture,uv_0).xyz *2.0 - 1.0; \n   s.Normal = tbn( s.Normal.xyz , normal.xyz , varying_mvPose.xyz , uv_0 ) ; \n}\n",normalPassEnd_fs:"void main() {\n    outColor = vec4(normal,1.0);\n}\n",outLine_fs:"uniform float uniform_ouline[5] ;\nvoid main(){\n     diffuseColor = vec4(uniform_ouline[1],\n                    uniform_ouline[2],\n                    uniform_ouline[3],\n                    uniform_ouline[4]) ;\n    outColor = diffuseColor; \n}",outLine_vs:"attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_mvPose; \nuniform float uniform_ouline[5] ;\nvoid main(void){\n    outPosition.xy -= normalize(varying_eyeNormal.xyz).xy * uniform_ouline[0]; \n}",out_fs:"void main(){\n    gl_FragColor = outColor;\n}",out_vs:"void main(){\n     gl_Position = outPosition ;\n}",particle_bezier:"float calcBezierArea(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float v0;\n	float v1;\n	float t0;\n	float t1;\n	float deltaTime = 0.0;\n	float a_deltaTime;\n	for(int i = 0; i < 16; i ++)\n	{\n		t0 = bzData[i * 2 + 0] * tTotal;\n		v0 = bzData[i * 2 + 1];\n		t1 = bzData[i * 2 + 2] * tTotal;\n		v1 = bzData[i * 2 + 3];\n		deltaTime = t1 - t0;\n			a_deltaTime = 0.5 * (v1 - v0);\n			if(tCurrent >= t1)\n			{\n				res += deltaTime * (v0 + a_deltaTime);\n			}else\n			{\n				deltaTime = tCurrent - t0;\n				res += deltaTime * (v0 + a_deltaTime);\n				break;\n			}\n	}\n	return res;\n}\nfloat calcBezierSize(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float y0;\n	float y1;\n	float t0;\n	float t1;\n	float deltaTime = 0.0;\n	float v;\n	for(int i = 0; i < 16; i ++)\n	{\n		t0 = bzData[i * 2 + 0] * tTotal;\n		y0 = bzData[i * 2 + 1];\n		t1 = bzData[i * 2 + 2] * tTotal;\n		y1 = bzData[i * 2 + 3];\n		deltaTime = t1 - t0;\n			if(tCurrent <= t1)\n			{\n				v = (y1 - y0) / deltaTime;\n				deltaTime = tCurrent - t0;\n				res = y0 + v * deltaTime;\n				break;\n			}\n	}\n	return res;\n}\n",particle_bezier_low:"float calcBezierArea(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float v0;\n	float v1;\n	float t0;\n	float t1;\n	float breakFlag = 1.0;\n	for (int i = 0; i < 3; i++) {\n		t1 = bzData[i * 4];\n		v1 = bzData[i * 4 + 1];\n		t0 = bzData[(i - 1) * 4];\n		v0 = bzData[(i - 1) * 4 + 1];\n		res += (min(tCurrent, t1) - t0) * (0.5 * (v1 + v0)) * breakFlag;\n		if(t1 >= tCurrent) {\n			breakFlag = 0.0;\n		}\n	}\n	return res;\n}\nfloat calcBezierSize(float bzData[35], float tCurrent, float tTotal){\n	float res = 0.0;\n	float y0;\n	float y1;\n	float t0;\n	float t1;\n	\n	for (int i = 1; i < 4; i ++) {\n		t1 = bzData[i * 4];\n		y1 = bzData[i * 4 + 1];\n		if(t1 >= tCurrent) {\n			t0 = bzData[(i - 1) * 4];\n			y0 = bzData[(i - 1) * 4 + 1];\n			float age = (tCurrent - t0) / (t1 - t0);\n			res = y0 + (y1 - y0) * age;\n		}\n	}\n	return res;\n}\n",particle_color_fs:"//##FilterBegin## ##Particle##\r\nuniform float uniform_colorTransform[40];\r\n//ѹ��������ɫ,rg.b�ĸ�ʽ\r\nvec3 unpack_color(float rgb_data)\r\n{\r\n    vec3 res;\r\n    res.z = fract( rgb_data );\r\n    rgb_data -= res.z;\r\n    \r\n    rgb_data = rgb_data/256.0;\r\n    res.y = fract( rgb_data );\r\n    rgb_data -= res.y;\r\n    \r\n    res.x = rgb_data/256.0;\r\n    return res;\r\n}\r\n\r\nvoid main() {\r\n    float startColor ;\r\n    float startSegment ;\r\n    \r\n    float nextColor ;\r\n    float nextSegment ;\r\n\r\n    float startAlpha;\r\n	float nextAlpha;\r\n\r\n    float progress = varying_particleData.x/varying_particleData.y;\r\n	const int maxColorCount = 20;\r\n	const int loopCount = 20;\r\n    for( int i = 1 ; i < loopCount ; i++ ){\r\n       if( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){\r\n          startColor = uniform_colorTransform[i-1] ;\r\n          startSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ;\r\n          nextColor = uniform_colorTransform[i];\r\n          nextSegment = fract(uniform_colorTransform[i+maxColorCount]) ;\r\n\r\n		  startAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment;\r\n		  nextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment;\r\n       }else{\r\n          break;\r\n       }\r\n    } \r\n    \r\n    float len = nextSegment - startSegment ;\r\n    float ws = ( progress - startSegment ) / len ;\r\n	ws = clamp(ws,0.0,1.0);\r\n    globalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ;\r\n	globalColor = clamp(globalColor,0.0,1.0);\r\n}\r\n//##FilterEnd##",particle_color_fs_low:"//##FilterBegin## ##Particle##\r\nuniform float uniform_colorTransform[40];\r\n//ѹ��������ɫ,rg.b�ĸ�ʽ\r\nvec3 unpack_color(float rgb_data)\r\n{\r\n    vec3 res;\r\n    res.z = fract( rgb_data );\r\n    rgb_data -= res.z;\r\n    \r\n    rgb_data = rgb_data/256.0;\r\n    res.y = fract( rgb_data );\r\n    rgb_data -= res.y;\r\n    \r\n    res.x = rgb_data/256.0;\r\n    return res;\r\n}\r\n\r\nvoid main() {\r\n    float startColor ;\r\n    float startSegment ;\r\n    \r\n    float nextColor ;\r\n    float nextSegment ;\r\n\r\n    float startAlpha;\r\n	float nextAlpha;\r\n\r\n    float progress = varying_particleData.x/varying_particleData.y;\r\n	const int maxColorCount = 20;\r\n	const int loopCount = 4;\r\n    for( int i = 1 ; i < loopCount ; i++ ){\r\n       if( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){\r\n          startColor = uniform_colorTransform[i-1] ;\r\n          startSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ;\r\n          nextColor = uniform_colorTransform[i];\r\n          nextSegment = fract(uniform_colorTransform[i+maxColorCount]) ;\r\n\r\n		  startAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment;\r\n		  nextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment;\r\n       }else{\r\n          break;\r\n       }\r\n    } \r\n    \r\n    float len = nextSegment - startSegment ;\r\n    float ws = ( progress - startSegment ) / len ;\r\n	ws = clamp(ws,0.0,1.0);\r\n    globalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ;\r\n	globalColor = clamp(globalColor,0.0,1.0);\r\n}\r\n//##FilterEnd##",particle_color_vs:"void getNodeData(){\n	\n}\n//##FilterEnd##",particle_diffuse_fragment:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvec4 globalColor = vec4(1.0, 1.0, 1.0, 1.0);\nvoid calcUVCoord(){\n}\nvoid main() {\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	calcUVCoord();\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n    \n    if( diffuseColor.w < materialSource.cutAlpha ){\n		discard;\n	}\n}\n",particle_end_fs:"varying vec4 varying_particleData;\nvarying vec4 varying_mvPose;\nvoid main() {\n	vec3 fc ;\n	if(materialSource.refraction<2.41){ \n	   float vl = dot(normal,-normalize(varying_mvPose.xyz)); \n	   fc = Fresnel_Schlick(vl,vec3(materialSource.refraction)) * materialSource.refractionintensity ; \n	   fc.xyz = max(fc,vec3(0.0)) ; \n	} \n  \n	s.Albedo = diffuseColor.rgb * globalColor.xyz ;	s.Albedo.x = pow(s.Albedo.x, materialSource.gamma);\n    s.Albedo.y = pow(s.Albedo.y, materialSource.gamma);\n    s.Albedo.z = pow(s.Albedo.z, materialSource.gamma);\n	s.Albedo = s.Albedo * varying_color.xyz;\n	s.Alpha = diffuseColor.a * globalColor.w * materialSource.alpha * varying_color.w ; \n	outColor.xyz = s.Albedo ; \n	outColor.w = s.Alpha; \n	if(varying_particleData.w > 0.5){ \n	outColor.xyz *= outColor.w; \n	} \n	outColor = clamp(outColor, 0.0, 1.0) ; \n}\n",particle_end_vs:"varying vec4 varying_pos;\nmat4 buildModelMatrix(vec4 quat, vec3 scale, vec3 position)\n{\n	mat4 ret = mat4( \n		vec4(scale.x, 0.0, 0.0, 0.0), \n		vec4(0.0, scale.y, 0.0, 0.0), \n		vec4(0.0, 0.0, scale.z, 0.0), \n		vec4(0.0, 0.0, 0.0, 1.0) \n	);\n	ret = buildMat4Quat(quat) * ret; \n	 \n	ret[3][0] = position.x;\n	ret[3][1] = position.y;\n	ret[3][2] = position.z;\n	return ret;\n}\nvec3 calcParticleMove(vec3 distanceXYZ){\n	if(velocityLimitVec2.y > TrueOrFalse){\n		vec3 temp = distanceXYZ * distanceXYZ;\n		float distanceCurrent = sqrt(temp.x + temp.y + temp.z);\n		float distanceLimit = velocityLimitVec2.x;\n		if(distanceLimit < Tiny){\n			return vec3(0.0);\n		}\n		if(distanceCurrent > distanceLimit){\n			float nowFrame = currentTime / 0.017;\n			float dampen = 1.0 - particleStateData.velocityLimitDampen;\n			float startDistance = (distanceCurrent - distanceLimit) / nowFrame;\n			float distanceResult = 0.0;\n			float tempDistance = startDistance;\n			for(int i = 1; i < 600; i++){\n				distanceResult += tempDistance;\n				tempDistance *= dampen;\n				if(float(i) > nowFrame)\n					break;\n			}\n			distanceXYZ *= (distanceResult + distanceLimit) / distanceCurrent;\n		}\n	}\n	return distanceXYZ;\n}\nbool updateStretchedBillBoard(vec3 moveVector){\n	return true;	\n}\nvoid main(void) {\n	\n	vec3 position_emitter = attribute_offsetPosition;\n	vec3 velocityLocalVec3 = velocityBaseVec3 * currentTime;\n	vec3 velocityWorldVec3 = vec3(0.0,0.0,0.0);\n	vec3 velocityMultiVec3 = vec3(0.0,0.0,0.0);\n	if(particleStateData.velocityOverWorldSpace < TrueOrFalse){\n		velocityLocalVec3 += velocityOverVec3;		\n	}else{\n		velocityWorldVec3 += velocityOverVec3;\n	}\n	if(particleStateData.velocityForceWorldSpace < TrueOrFalse){\n		velocityLocalVec3 += velocityForceVec3;\n	}else{\n		velocityWorldVec3 += velocityForceVec3;\n	}\n	position_emitter *= vec3(particleStateData.scaleX, particleStateData.scaleY, particleStateData.scaleZ);\n	if(particleStateData.worldSpace > TrueOrFalse){\n	}else{\n		followTargetPosition.x = particleStateData.positionX;\n		followTargetPosition.y = particleStateData.positionY;\n		followTargetPosition.z = particleStateData.positionZ;\n		followTargetRotation.x = particleStateData.rotationX;\n		followTargetRotation.y = particleStateData.rotationY;\n		followTargetRotation.z = particleStateData.rotationZ;\n		followTargetRotation.w = particleStateData.rotationW;\n	}\n	mat4 followRotQuat = buildMat4Quat(followTargetRotation);\n	velocityLocalVec3 = (followRotQuat * vec4(velocityLocalVec3, 1.0)).xyz;\n	if(particleStateData.renderMode == Mesh){ \n		rotVertexMatrix = followRotQuat * rotVertexMatrix; \n	}\n	localPosition.xyz *= scaleSize;\n	localPosition = rotVertexMatrix * localPosition; \n	trackPosition();\n	mat4 modelMatrix = buildModelMatrix(followTargetRotation, followTargetScale, followTargetPosition);\n	position_emitter = (modelMatrix * vec4(position_emitter, 1.0)).xyz; \n	velocityMultiVec3 = velocityLocalVec3 + velocityWorldVec3;\n	velocityMultiVec3 = calcParticleMove(velocityMultiVec3);\n	velocityMultiVec3.y -= 4.9 * currentTime * currentTime * particleStateData.gravity;		\n	position_emitter += velocityMultiVec3; \n	if(particleStateData.renderMode == StretchedBillboard){\n		discard_particle = discard_particle || updateStretchedBillBoard(velocityMultiVec3) == false; \n		outPosition = localPosition;\n		rotVertexMatrix = rotVertexMatrix * uniform_billboardMatrix; \n	}else{\n		outPosition = uniform_billboardMatrix * localPosition;\n	}\n	if(discard_particle){\n		outPosition = vec4(0.0,0.0,0.0,0.0); \n	}else{\n		\n		outPosition.xyz += position_emitter.xyz;\n		outPosition = uniform_ViewMatrix * outPosition;\n		e_normal.xyz = (rotVertexMatrix * vec4(e_normal, 1.0)).xyz;\n		e_normal = normalize(e_normal);\n		mat4 mvMatrix = mat4(uniform_ViewMatrix * modelMatrix);\n		varying_mvPose = outPosition;\n    	\n		mat4 normalMatrix = inverse(mvMatrix) ;\n		normalMatrix = transpose(normalMatrix); \n		\n		varying_eyeNormal = mat3(normalMatrix) * - e_normal; \n	}\n	varying_pos = outPosition = uniform_ProjectionMatrix * outPosition;\n}\n	\n//##FilterEnd##",particle_follow_vs:"attribute vec3 attribute_followPosition ;\nattribute vec4 attribute_followRotation ;\nattribute vec3 attribute_followScale;\nvoid getNodeData(){\n	 followTargetPosition = attribute_followPosition;\n	 followTargetRotation = attribute_followRotation;\n}\n	\n//##FilterEnd##",particle_rotationConst:"attribute float attribute_rotationZ ;\nvoid getUnitRotate(){\n	rotResultVec3.z = currentTime * attribute_rotationZ;\n}\n",particle_rotationOneBezier:"uniform float uniform_rotationBezier[35];\nvoid getUnitRotate(){\n	float rot = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life);\n	rotResultVec3.z = rot;\n}\n",particle_rotationTwoBezier:"attribute float attribute_rotationRandomSeed;\nuniform float uniform_rotationBezier[35];\nuniform float uniform_rotationBezier2[35];\nvoid getUnitRotate(){\n	vec2 rotationTwoBezier = vec2(0.0);\n	rotationTwoBezier.x = calcBezierArea(uniform_rotationBezier, currentTime, curParticle.life);\n	rotationTwoBezier.y = calcBezierArea(uniform_rotationBezier2, currentTime, curParticle.life);\n	float rot = mix(rotationTwoBezier.x, rotationTwoBezier.y, attribute_rotationRandomSeed);\n	rotResultVec3.z = rot;\n}\n",particle_rotationXYZConst:"attribute vec3 attribute_rotSpeedXYZ ;\nattribute vec3 attribute_rotBirthXYZ ;\nvoid getUnitRotate(){\n	rotResultVec3 = (attribute_rotBirthXYZ + particleStateData.time * attribute_rotSpeedXYZ);\n	rotResultVec3 = mod(rotResultVec3, 360.0);\n}\n",particle_scaleSizeBezier1:"uniform float uniform_scaleSizeBezier1[35];\nvoid main() {\n	scaleSize *= calcBezierSize(uniform_scaleSizeBezier1, currentTime, curParticle.life);\n}\n",particle_scaleSizeBezier2:"attribute float attribute_bezierRandomSeed;\nuniform float uniform_scaleSizeBezier1[35];\nuniform float uniform_scaleSizeBezier2[35];\nvoid main() {\n	vec2 scaleVec2 = vec2(0.0);\n	scaleVec2.x = calcBezierArea(uniform_scaleSizeBezier1, currentTime, curParticle.life);\n	scaleVec2.y = calcBezierArea(uniform_scaleSizeBezier2, currentTime, curParticle.life);\n	scaleSize * = mix(scaleVec2.x, scaleVec2.y, attribute_bezierRandomSeed);\n}\n",particle_scaleSizeConst:"attribute float attribute_scaleSizeConst;\nvoid main() {\n	scaleSize *= attribute_scaleSizeConst;\n}\n//##FilterEnd##",particle_stretched_mode:"\nbool updateStretchedBillBoard(vec3 moveVector){\n	if(currentTime < 0.016){\n		return false;\n	}\n	float speed = dot(moveVector, moveVector); \n	speed = sqrt(speed) / currentTime; \n	speed /= 100.0;\n	if(speed < Tiny){\n		return false;\n	}\n	localPosition.y = localPosition.y * particleStateData.lengthScale + speed * particleStateData.speedScale * localPosition.y / scaleSize;\n	vec3 dir1 = vec3(0.0, 1.0, 0.0);\n	vec3 dir2 = normalize(moveVector);\n	vec3 axis = normalize(cross(dir1, dir2));\n    float angle = acos(dot(dir1, dir2));\n	vec4 quat = vec4(0.0, 0.0, 0.0, 1.0);\n    float halfAngle = angle * 0.5;\n    float sin_a = sin(halfAngle);\n    quat.w = cos(halfAngle);\n    quat.x = axis.x * sin_a;\n    quat.y = axis.y * sin_a;\n    quat.z = axis.z * sin_a;\n    quat = normalize(quat);\n	\n	localPosition = uniform_billboardMatrix * localPosition;\n	rotVertexMatrix = buildMat4Quat(quat); \n	localPosition = rotVertexMatrix * localPosition;\n	return true;\n}\n",particle_textureSheetConst:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	frame = clamp(frame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheetOneBezier:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nuniform float uniform_frameBezier[35];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	float currentTime = varying_particleData.x * uniform_textureSheet[2];\n	currentTime = mod(currentTime, varying_particleData.y);\n	float bezierFrame = calcBezierSize(uniform_frameBezier, currentTime, varying_particleData.y);\n	bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	frame += bezierFrame;\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheetTwoBezier:"\nvarying vec3 varying_textureSheetData;\nuniform float uniform_textureSheet[5];\nuniform float uniform_frameBezier1[35];\nuniform float uniform_frameBezier2[35];\nvec2 getSheetOffset(float frame, float tileX, float tileY)\n{\n	frame = floor(frame);\n	vec2 ret = vec2(0.0); \n	ret.x = (1.0 / tileX) * mod(frame, tileX); \n	ret.y = frame / tileX;\n	ret.y = floor(ret.y);\n	ret.y = (1.0 / tileY) * ret.y; \n	return ret;\n}\nvoid calcUVCoord() {\n	vec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]);\n	uv_0.xy *= rectUV;\n	\n	float frame = varying_textureSheetData.x + varying_textureSheetData.y;\n	float currentTime = varying_particleData.x * uniform_textureSheet[2];\n	currentTime = mod(currentTime, varying_particleData.y);\n	float b1 = calcBezierSize(uniform_frameBezier1, currentTime2, varying_particleData.y);\n	float b2 = calcBezierSize(uniform_frameBezier2, currentTime2, varying_particleData.y);\n	float bezierFrame = mix(b1, b2, varying_particleData.z);\n	bezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]);\n	frame += bezierFrame;\n	uv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]);\n}\n",particle_textureSheet_vs:"attribute vec3 attribute_textureSheetData;\nvarying vec3 varying_textureSheetData;\nvoid getNodeData(){\n	varying_textureSheetData = attribute_textureSheetData;\n}\n	\n",particle_trackPosition:"\nattribute vec3 attribute_trackPosition;\nvoid calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos){ \n \n	vec3 distanceVec3 = endPos - fromPos; \n	float distanceFloat = dot(distanceVec3, distanceVec3); \n	distanceFloat = sqrt(distanceFloat); \n	float t = time / totalTime; \n	t = easeInOut(t); \n	vec3 centerPos = distanceVec3 * 0.5 + fromPos; \n	vec3 zeroPos = vec3(0.0, distanceFloat * 0.05, 0.0); \n	zeroPos = mix(centerPos, zeroPos, 0.6); \n	vec3 bezier1 = mix(fromPos, zeroPos, t); \n	vec3 bezier2 = mix(zeroPos, endPos, t); \n	vec3 bezier3 = mix(bezier1, bezier2, t); \n	cubicPos = bezier3 - fromPos; \n	t = clamp(time / totalTime, 0.0, 1.0); \n	if(t > 0.8){ \n	t = (1.0 - t) * 5.0; \n	}else if(t > 0.2){ \n	t = 1.0; \n	}else{ \n	t *= 5.0; \n	} \n	t = 0.5 * (1.0 - cos(t * PI)); \n	vec4 nrmVec4 = rotVertexMatrix * vec4(attribute_normal, 1.0); \n	vec3 nrmPos = normalize(nrmVec4.xyz); \n	nrmPos = nrmPos * t * distanceFloat * 0.04; \n	t = clamp(time / totalTime, 0.0, 1.0); \n	float heightOffset = 0.0; \n	heightOffset = sin(t * 3.0 * PI) * distanceFloat * 0.2 * sqrt(t * (1.0 - t)); \n	cubicPos += nrmPos; \n	cubicPos.y += heightOffset; \n}\nvoid trackPosition(){ \n \n	calcCubicPos(currentTime - 0.017, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n	vec3 lastOffset = cubicPos; \n	calcCubicPos(currentTime, curParticle.life, attribute_offsetPosition, attribute_trackPosition); \n	vec3 curOffset = cubicPos; \n	vec3 trackVec3 = curOffset - lastOffset; \n	trackVec3 = normalize(trackVec3); \n	float ratio = dot(localPosition.xyz, trackVec3); \n	float t = clamp(currentTime / curParticle.life, 0.0, 1.0); \n	t = 0.5 * (1.0 - cos(t * PI * 2.0)); \n	t = sqrt(t); \n	float speed = sqrt(dot(curOffset - lastOffset, curOffset - lastOffset)); \n	trackVec3 *= speed * 2.0 * t; \n	localPosition.xyz += ratio * trackVec3; \n	localPosition.xyz += curOffset; \n}\n",particle_uv_roll_fs:"\nuniform float uniform_particleUVRoll[2];\nvoid calcUVCoord() {\n	uv_0.xy += vec2(varying_particleData.x * uniform_particleUVRoll[0], varying_particleData.x * uniform_particleUVRoll[1]);\n}\n",particle_velocity:"\nattribute vec3 attribute_velocity;\nvoid getNodeData(){\n	velocityBaseVec3 = attribute_velocity;\n}\n",particle_velocityForceConst:"attribute vec3 attribute_velocityForceConst ;\nvoid getNodeData(){\n	velocityForceVec3 = 0.5 * attribute_velocityForceConst * currentTime * currentTime;\n}\n",particle_velocityForceOneBezier:"\nvec3 velocityForceOneBezier = vec3(0.0);\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	velocityForceVec3.xyz = velocityForceOneBezier.xyz;\n	calcVelocityForceBezier(currentTime, curParticle.life);\n}\n",particle_velocityForceOneBezierX:"\nuniform float uniform_velocityForceX[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.x = calcBezierArea(uniform_velocityForceX, curTime, totalTime);\n}\n",particle_velocityForceOneBezierY:"\nuniform float uniform_velocityForceY[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.y = calcBezierArea(uniform_velocityForceY, curTime, totalTime);\n}\n",particle_velocityForceOneBezierZ:"\nuniform float uniform_velocityForceZ[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceOneBezier.z = calcBezierArea(uniform_velocityForceZ, curTime, totalTime);\n}\n",particle_velocityForceTwoBezier:"\nattribute float attribute_velocityForceRandomSeed;\nvec3 velocityForceTwoBezier1 = vec3(0.0);\nvec3 velocityForceTwoBezier2 = vec3(0.0);\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityForceBezier(currentTime, curParticle.life);\n	velocityForceVec3.x = mix(velocityForceTwoBezier1.x, velocityForceTwoBezier2.x, attribute_velocityForceRandomSeed);\n	velocityForceVec3.y = mix(velocityForceTwoBezier1.y, velocityForceTwoBezier2.y, attribute_velocityForceRandomSeed);\n	velocityForceVec3.z = mix(velocityForceTwoBezier1.z, velocityForceTwoBezier2.z, attribute_velocityForceRandomSeed);\n}\n",particle_velocityForceTwoBezierX1:"\nuniform float uniform_velocityForceX1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.x = calcBezierArea(uniform_velocityForceX1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierX2:"\nuniform float uniform_velocityForceX2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.x = calcBezierArea(uniform_velocityForceX2, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierY1:"\nuniform float uniform_velocityForceY1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.y = calcBezierArea(uniform_velocityForceY1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierY2:"\nuniform float uniform_velocityForceY2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.y = calcBezierArea(uniform_velocityForceY2, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierZ1:"\nuniform float uniform_velocityForceZ1[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier1.z = calcBezierArea(uniform_velocityForceZ1, curTime, totalTime);\n}\n",particle_velocityForceTwoBezierZ2:"\nuniform float uniform_velocityForceZ2[35];\nvoid calcVelocityForceBezier(float curTime, float totalTime)\n{\n	velocityForceTwoBezier2.z = calcBezierArea(uniform_velocityForceZ2, curTime, totalTime);\n}\n",particle_velocityLimitConst:"\nattribute float attribute_velocityLimit;\nvoid getNodeData(){\n	velocityLimitVec2.x = attribute_velocityLimit * currentTime;\n	if(velocityLimitVec2.x < 0.0){\n		velocityLimitVec2.x = 0.0;\n	}\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityLimitOneBezier:"\nuniform float uniform_velocityLimit[35];\nvoid main() {\n	velocityLimitVec2.x = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life);\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityLimitTwoBezier:"\nuniform float uniform_velocityLimit[35];\nuniform float uniform_velocityLimit2[35];\nattribute float attribute_velocityLimitRandomSeed;\nvoid main() {\n	float velocity2Limit1 = calcBezierArea(uniform_velocityLimit, currentTime, curParticle.life);\n	float velocity2Limit2 = calcBezierArea(uniform_velocityLimit2, currentTime, curParticle.life);\n	velocityLimitVec2.x = mix(velocity2Limit1, velocity2Limit1, attribute_velocityLimitRandomSeed);\n	if(velocityLimitVec2.x < 0.0){\n		velocityLimitVec2.x = 0.0;\n	}\n	velocityLimitVec2.y = 1.0;\n}\n",particle_velocityOverConst:"\nattribute vec3 attribute_velocityOverConst;\nvoid getNodeData(){\n	velocityOverVec3 = attribute_velocityOverConst * currentTime;\n}\n",particle_velocityOverOneBezier:"\nvec3 velocityTwoBezier = vec3(0.0);\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityOverBezier(currentTime, curParticle.life);\n	velocityOverVec3.xyz = velocityTwoBezier.xyz;\n}\n",particle_velocityOverOneBezierX:"\nuniform float uniform_velocityOverX[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.x = calcBezierArea(uniform_velocityOverX, curTime, totalTime);\n}\n",particle_velocityOverOneBezierY:"\nuniform float uniform_velocityOverY[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.y = calcBezierArea(uniform_velocityOverY, curTime, totalTime);\n}\n",particle_velocityOverOneBezierZ:"\nuniform float uniform_velocityOverZ[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityTwoBezier.z = calcBezierArea(uniform_velocityOverZ, curTime, totalTime);\n}\n",particle_velocityOverTwoBezier:"\nattribute float attribute_velocityOverRandomSeed;\nvec3 velocityOverTwoBezier1 = vec3(0.0);\nvec3 velocityOverTwoBezier2 = vec3(0.0);\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n}\nvoid main() {\n	calcVelocityOverBezier(currentTime, curParticle.life);\n	velocityOverVec3.x = mix(velocityOverTwoBezier1.x, velocityOverTwoBezier2.x, attribute_velocityOverRandomSeed);\n	velocityOverVec3.y = mix(velocityOverTwoBezier1.y, velocityOverTwoBezier2.y, attribute_velocityOverRandomSeed);\n	velocityOverVec3.z = mix(velocityOverTwoBezier1.z, velocityOverTwoBezier2.z, attribute_velocityOverRandomSeed);\n}\n",particle_velocityOverTwoBezierX1:"\nuniform float uniform_velocityOverX1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.x = calcBezierArea(uniform_velocityOverX1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierX2:"\nuniform float uniform_velocityOverX2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.x = calcBezierArea(uniform_velocityOverX2, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierY1:"\nuniform float uniform_velocityOverY1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.y = calcBezierArea(uniform_velocityOverY1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierY2:"\nuniform float uniform_velocityOverY2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.y = calcBezierArea(uniform_velocityOverY2, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierZ1:"\nuniform float uniform_velocityOverZ1[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier1.z = calcBezierArea(uniform_velocityOverZ1, curTime, totalTime);\n}\n",particle_velocityOverTwoBezierZ2:"\nuniform float uniform_velocityOverZ2[35];\nvoid calcVelocityOverBezier(float curTime, float totalTime)\n{\n	velocityOverTwoBezier2.z = calcBezierArea(uniform_velocityOverZ2, curTime, totalTime);\n}\n",particle_vs:"float currentTime = 0.0;\nfloat totalTime = 0.0;\nbool discard_particle = true;\nconst float PI = 3.1415926;\nconst float TrueOrFalse = 0.5;\nconst float Tiny = 0.0001;\nvarying vec4 varying_particleData;\nvarying vec4 varying_mvPose;\nattribute vec3 attribute_time;attribute vec4 attribute_color;\nattribute vec3 attribute_offsetPosition;\nattribute float attribute_rotationBirth;\nuniform mat4 uniform_cameraMatrix;\nuniform mat4 uniform_billboardMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform float uniform_particleState[27];\nvec3 cubicPos = vec3(1.0,1.0,1.0);\nvec3 rotResultVec3 = vec3(0.0);\nvec4 localPosition = vec4(0.0,0.0,0.0,1.0);\nvec3 velocityBaseVec3 = vec3(0.0,0.0,0.0);\nvec3 velocityOverVec3 = vec3(0.0,0.0,0.0);\nvec3 velocityForceVec3 = vec3(0.0,0.0,0.0);\nvec2 velocityBezierWeightVec2 = vec2(1.0, 1.0);\nvec2 velocityLimitVec2 = vec2(0.0,0.0);\nvec3 followTargetPosition = vec3(0.0,0.0,0.0);\nvec3 followTargetScale = vec3(1.0,1.0,1.0);\nvec4 followTargetRotation = vec4(0.0,0.0,0.0,0.0);\nfloat scaleSize = 1.0;\nconst float Billboard				= 0.0;\nconst float StretchedBillboard		= 1.0;\nconst float HorizontalBillboard		= 2.0;\nconst float VerticalBillboard		= 3.0;\nconst float Mesh					= 4.0;\nstruct ParticleData{\n	float bornTime;	float life;	float index;};                   \nParticleData curParticle;\nstruct ParticleStateData{\n	float time;						\n	float loop;						\n	float worldSpace;				\n	float scaleX;					\n	float scaleY;					\n	float scaleZ;					\n	float rotationX;				\n	float rotationY;				\n	float rotationZ;				\n	float rotationW;\n	float positionX;				\n	float positionY;				\n	float positionZ;				\n	float loopTime;					\n	float delay;					\n	float duration;					\n	float gravity;					\n	float velocityOverWorldSpace;	\n	float velocityForceWorldSpace;	\n	float velocityLimitDampen;\n	float cameraScale;\n	float speedScale;\n	float lengthScale;\n	float renderMode;\n	float stayAtEnd;\n	float blendMode;\n	float shapeType;\n};\nParticleStateData particleStateData;\nmat4 buildRotMat4(vec3 rot)\n{\n	float s;\n	float c;\n	s = sin(rot.x);\n	c = cos(rot.x);\n	\n	mat4 ret = mat4(\n	vec4(1.0, 0.0, 0.0, 0.0),\n	vec4(0.0, c, s, 0.0),\n	vec4(0.0, -s, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	);\n	\n	s = sin(rot.y);\n	c = cos(rot.y);\n	\n	ret = mat4(\n	vec4(c, 0.0, -s, 0.0),\n	vec4(0.0, 1.0, 0.0, 0.0),\n	vec4(s, 0.0, c, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	s = sin(rot.z);\n	c = cos(rot.z);\n	ret = mat4(\n	vec4(c, s, 0.0, 0.0),\n	vec4(-s, c, 0.0, 0.0),\n	vec4(0.0, 0.0, 1.0, 0.0),\n	vec4(0.0, 0.0, 0.0, 1.0)\n	) * ret;\n	return ret;\n}\nmat4 buildMat4Quat(vec4 quat)\n{\n	float xx = quat.x * quat.x;\n	float xy = quat.x * quat.y;\n	float xz = quat.x * quat.z;\n	float xw = quat.x * quat.w;\n	float yy = quat.y * quat.y;\n	float yz = quat.y * quat.z;\n	float yw = quat.y * quat.w;\n	float zz = quat.z * quat.z;\n	float zw = quat.z * quat.w;\n	return mat4(\n		1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n		2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n		2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n		0.0,							0.0,					0.0,					1\n	);\n}\nfloat easeInOut(float t)\n{\n	t = clamp(t, 0.0, 1.0);\n	float p0;\n	float p1;\n	float p2;\n	if(t <= 0.5){ \n		p0 = 0.0; \n		p1 = 0.0; \n		p2 = 0.5; \n	}else{ \n		p0 = 0.5; \n		p1 = 1.0; \n		p2 = 1.0; \n		t -= 0.5;\n	}\n	t *= 2.0;\n	\n	p0 = mix(p0, p1, t);\n	p1 = mix(p1, p2, t);\n	\n	p0 = mix(p0, p1, t);\n	return p0;\n}\nvoid calcParticleTime()\n{\n	discard_particle = true;\n	curParticle.bornTime = attribute_time.x; \n	curParticle.life = attribute_time.y; \n	curParticle.index = attribute_time.z; \n	float time = particleStateData.time - particleStateData.delay;\n	currentTime = time - curParticle.bornTime;\n	if(currentTime <= 0.0){\n		return;\n	}\n	if(particleStateData.stayAtEnd > TrueOrFalse){\n		if(currentTime >= curParticle.life){\n			currentTime = curParticle.life * 0.99999;\n		}\n	}\n	if(particleStateData.loop < TrueOrFalse){\n		if(curParticle.bornTime >= particleStateData.duration){\n			return;\n		}\n		if(currentTime >= curParticle.life){\n			return;\n		}\n		\n	}\n	currentTime = mod(currentTime, particleStateData.loopTime);\n	if(currentTime > curParticle.life || currentTime <= 0.0){\n		return;\n	}\n	discard_particle = false;\n}\nvoid calcCubicPos(float time, float totalTime, vec3 fromPos, vec3 endPos)\n{\n}\nvoid trackPosition()\n{\n}\nvoid getUnitRotate(){\n}\nvoid getNodeData(){\n}\nvoid rotateParticleUnit()\n{\n	rotResultVec3.z += attribute_rotationBirth; \n	rotResultVec3 *= PI / 180.0; \n	if(particleStateData.renderMode == Mesh){\n		if(particleStateData.shapeType > 0.5){ \n			rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n			rotVertexMatrix = buildRotMat4(rotResultVec3); \n	  }else{ \n		  rotResultVec3 = vec3(0.0, 0.0, rotResultVec3.z); \n		  rotVertexMatrix = buildRotMat4(rotResultVec3); \n	  } \n	}else if(particleStateData.renderMode == HorizontalBillboard){ \n		rotVertexMatrix = buildRotMat4(vec3(0.5 * PI, 0.0, 0.0)); \n		rotResultVec3 = vec3(0.0, rotResultVec3.z, 0.0); \n		rotVertexMatrix = buildRotMat4(rotResultVec3) * rotVertexMatrix; \n	}else if(particleStateData.renderMode == StretchedBillboard){\n		rotResultVec3 = vec3(0.0, 0.0, -0.5 * PI); \n		rotVertexMatrix = buildRotMat4(rotResultVec3);\n	}else{\n		rotVertexMatrix = buildRotMat4(rotResultVec3); \n	} \n	\n}\nvoid main(void) \n{\n	localPosition = vec4(e_position, 1.0);\n	particleStateData.time							= uniform_particleState[0];\n	particleStateData.loop							= uniform_particleState[1];\n	particleStateData.worldSpace					= uniform_particleState[2];\n	particleStateData.scaleX						= uniform_particleState[3];\n	particleStateData.scaleY						= uniform_particleState[4];\n	particleStateData.scaleZ						= uniform_particleState[5];\n	particleStateData.rotationX						= uniform_particleState[6];\n	particleStateData.rotationY						= uniform_particleState[7];\n	particleStateData.rotationZ						= uniform_particleState[8];\n	particleStateData.rotationW						= uniform_particleState[9];\n	particleStateData.positionX						= uniform_particleState[10];\n	particleStateData.positionY						= uniform_particleState[11];\n	particleStateData.positionZ						= uniform_particleState[12];\n	particleStateData.loopTime						= uniform_particleState[13];\n	particleStateData.delay							= uniform_particleState[14];\n	particleStateData.duration						= uniform_particleState[15];\n	particleStateData.gravity						= uniform_particleState[16];\n	particleStateData.velocityOverWorldSpace		= uniform_particleState[17];\n	particleStateData.velocityForceWorldSpace		= uniform_particleState[18];\n	particleStateData.velocityLimitDampen			= uniform_particleState[19];\n	particleStateData.cameraScale					= uniform_particleState[20];\n	particleStateData.speedScale					= uniform_particleState[21];\n	particleStateData.lengthScale					= uniform_particleState[22];\n	particleStateData.renderMode					= uniform_particleState[23];\n	particleStateData.stayAtEnd						= uniform_particleState[24];\n	particleStateData.blendMode						= uniform_particleState[25];\n	particleStateData.shapeType						= uniform_particleState[26];\n	\n	calcParticleTime();\n	varying_particleData.x = currentTime;\n	varying_particleData.y = curParticle.life;\n	varying_particleData.z = curParticle.index;\n	varying_particleData.w = particleStateData.blendMode;\n	if(discard_particle){\n		varying_particleData.x = currentTime = 0.0;\n		gl_Position = varying_pos = vec4(0.0, 0.0, 0.0, 1.0);\n		return;\n	}\n	getNodeData();\n	getUnitRotate();\n	rotateParticleUnit();\n}\n",pointLight_fragment:"const int max_pointLight = 0 ;\nuniform float uniform_pointLightSource[12*max_pointLight] ;\nvarying vec4 varying_mvPose; \nstruct PointLight{\n        vec3 position ;\n        vec3 diffuse ;\n        vec3 ambient ;\n        float intensity;\n        float radius;\n        float cutoff;\n};\nvoid calculatePointLight(MaterialSource materialSource){\n    vec3 N = normal; \n	vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n	for(int i = 0 ; i < max_pointLight ; i++){\n		PointLight pointLight;\n		pointLight.position = vec3(uniform_pointLightSource[i*12],uniform_pointLightSource[i*12+1],uniform_pointLightSource[i*12+2]);\n		pointLight.diffuse = vec3(uniform_pointLightSource[i*12+3],uniform_pointLightSource[i*12+4],uniform_pointLightSource[i*12+5]);\n		pointLight.ambient = vec3(uniform_pointLightSource[i*12+6],uniform_pointLightSource[i*12+7],uniform_pointLightSource[i*12+8]);\n	    pointLight.intensity = uniform_pointLightSource[i*12+9];\n	    pointLight.radius = uniform_pointLightSource[i*12+10];\n	    pointLight.cutoff = uniform_pointLightSource[i*12+11];\n		\n		vec3 lightCentre = (mat4(uniform_ViewMatrix) * vec4(pointLight.position.xyz,1.0) ).xyz ; \n		float r = pointLight.radius * 0.5 ;\n		vec3 ldir = varying_mvPose.xyz - lightCentre ;\n		float distance = length(ldir);\n		float d = max(distance - r, 0.0);\n		vec3 L = ldir / distance;\n		\n		float denom = d/r + 1.0;\n		float attenuation = 1.0 / (denom*denom);\n		\n		float cutoff = pointLight.cutoff ;\n		attenuation = (attenuation - cutoff) / (1.0 - cutoff);\n		attenuation = max(attenuation*pointLight.intensity, 0.0);\n		LightingBlinnPhong(normalize(ldir),pointLight.diffuse,pointLight.ambient,N,(viewDir),attenuation); \n	};\n}\nvoid main() {\n   calculatePointLight(materialSource);\n}\n",positionEndPass_fs:"varying vec4 varying_position ;\nvoid main(){\n     outColor = vec4(varying_position.xyz,1.0);\n}",positionEndPass_vs:"varying vec4 varying_position ;\nvoid main(){\n		outPosition = uniform_ProjectionMatrix * outPosition ; \n		varying_position = outPosition.xyzw; \n}",rimlight_fs:"uniform float uniform_rimData[6] ;\nvoid main(){\n    float rim = 1.0 - clamp(dot (vec3(0.0,0.0,1.0), normal ) ,0.0,1.0);  \n    vec3 emission = vec3(uniform_rimData[0],uniform_rimData[1],uniform_rimData[2]) * pow(rim, uniform_rimData[4]);  \n    outColor.xyz += emission * uniform_rimData[3] * uniform_rimData[5] ;\n}",secondaryUV_vs:"attribute vec2 attribute_uv1;\nvarying vec2 varying_uv1 ;\nvoid main(void){\n	varying_uv1 = attribute_uv1 ; \n}",shadowMapping_fs:"uniform sampler2D shadowMapTexture;\nuniform vec4 uniform_ShadowColor;\nvarying vec4 varying_ShadowCoord;\nfloat unpackDepth(vec4 rgbaDepth){\n    vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) );\n    float depth = dot(rgbaDepth,bitShift);\n    return depth ;\n}\nvoid main() {\n	vec3 shadowColor = vec3(1.0,1.0,1.0); \n	float offset = uniform_ShadowColor.w; \n	vec2 sample = varying_ShadowCoord.xy / varying_ShadowCoord.w * 0.5 + 0.5; \n	if (sample.x >=0.0 && sample.x <= 1.0 && sample.y >=0.0 && sample.y <= 1.0) {\n		vec4 sampleDepth = texture2D(shadowMapTexture, sample).xyzw; \n		float depth = varying_ShadowCoord.z;\n	\n		if (sampleDepth.z != 0.0) {\n			if( sampleDepth.z < depth - offset) { \n				shadowColor = uniform_ShadowColor.xyz; \n			}\n		}\n	}\n	diffuseColor.xyz = diffuseColor.xyz * shadowColor; \n}\n",shadowMapping_vs:"uniform mat4 uniform_ShadowMatrix;\nuniform mat4 uniform_ModelMatrix;\nvarying vec4 varying_ShadowCoord;\nvoid main() {\n	varying_ShadowCoord = uniform_ShadowMatrix * uniform_ModelMatrix * vec4(e_position, 1.0);\n}",shadowPass_fs:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nfloat unpackDepth(vec4 rgbaDepth){\n    vec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) );\n    float depth = dot(rgbaDepth,bitShift);\n    return depth ;\n}\nvoid main() {\n	diffuseColor = varying_color ;\n    if( diffuseColor.w == 0.0 ){\n		discard;\n	}\n	diffuseColor = texture2D(diffuseTexture , varying_uv0 );\n    if( diffuseColor.w <= 0.3 ){\n			discard;\n	}\n    gl_FragColor = vec4(varying_pos.zzz, 1.0);\n}\n",shadowPass_skeleton_vs:"attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nattribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvec3 e_position = vec3(0.0, 0.0, 0.0);\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 outPosition = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xy2 = 2.0 * quat.x * quat.y;\n  float xz2 = 2.0 * quat.x * quat.z;\n  float xw2 = 2.0 * quat.x * quat.w;\n  float yz2 = 2.0 * quat.y * quat.z;\n  float yw2 = 2.0 * quat.y * quat.w;\n  float zw2 = 2.0 * quat.z * quat.w;\n  float xx = quat.x * quat.x;\n  float yy = quat.y * quat.y;\n  float zz = quat.z * quat.z;\n  float ww = quat.w * quat.w;\n  mat4 matrix = mat4(\n	   xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0,\n	   xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0,\n	   xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0,\n	   translation.x, translation.y, translation.z, 1\n   );\n   return matrix;\n}\nvoid main(void){\n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	e_position = outPosition.xyz;\n	\n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n	varying_color = attribute_color; \n	varying_uv0 = attribute_uv0 ;\n	varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0);\n	gl_Position = varying_pos;\n}",shadowPass_vs:"attribute vec3 attribute_position;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix ;\nuniform mat4 uniform_ViewMatrix ;\nuniform mat4 uniform_ProjectionMatrix ;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(void){\n	mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n	varying_color = attribute_color; \n	varying_uv0 = attribute_uv0 ;\n	varying_pos = uniform_ProjectionMatrix * uniform_ViewMatrix * uniform_ModelMatrix * vec4(attribute_position, 1.0);\n	gl_Position = varying_pos;\n}",skeletonShadowPass_vs:"attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec4 attribute_color;\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xx = quat.x * quat.x;\n  float xy = quat.x * quat.y;\n  float xz = quat.x * quat.z;\n  float xw = quat.x * quat.w;\n  float yy = quat.y * quat.y;\n  float yz = quat.y * quat.z;\n  float yw = quat.y * quat.w;\n  float zz = quat.z * quat.z;\n  float zw = quat.z * quat.w;\n   return mat4(\n	   1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0,\n	   2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0,\n	   2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0,\n	   translation.x,				translation.y,			translation.z,			1\n   );\n}\nvoid main(void){\n	varying_color = attribute_color; \n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	\n	e_position = outPosition.xyz;\n	outPosition = uniform_ModelMatrix * uniform_ViewMatrix *  outPosition; \n    \n}",skeleton_vs:"attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0);\nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0);\nconst int bonesNumber = 0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec4 varying_mvPose  ;\nmat4 buildMat4(int index){\n  vec4 quat = uniform_PoseMatrix[index * 2 + 0];\n  vec4 translation = uniform_PoseMatrix[index * 2 + 1];\n  float xy2 = 2.0 * quat.x * quat.y;\n  float xz2 = 2.0 * quat.x * quat.z;\n  float xw2 = 2.0 * quat.x * quat.w;\n  float yz2 = 2.0 * quat.y * quat.z;\n  float yw2 = 2.0 * quat.y * quat.w;\n  float zw2 = 2.0 * quat.z * quat.w;\n  float xx = quat.x * quat.x;\n  float yy = quat.y * quat.y;\n  float zz = quat.z * quat.z;\n  float ww = quat.w * quat.w;\n  mat4 matrix = mat4(\n	   xx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0,\n	   xy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0,\n	   xz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0,\n	   translation.x, translation.y, translation.z, 1\n   );\n   return matrix;\n}\nvoid main(void){\n	e_boneIndex = attribute_boneIndex;\n	e_boneWeight = attribute_boneWeight;\n	vec4 temp_position = vec4(attribute_position, 1.0) ;\n	vec4 temp_normal = vec4(attribute_normal, 0.0) ;\n	mat4 m0 = buildMat4(int(e_boneIndex.x));\n	mat4 m1 = buildMat4(int(e_boneIndex.y));\n	mat4 m2 = buildMat4(int(e_boneIndex.z));\n	mat4 m3 = buildMat4(int(e_boneIndex.w));\n	outPosition = m0 * temp_position * e_boneWeight.x;\n	outPosition += m1 * temp_position * e_boneWeight.y;\n	outPosition += m2 * temp_position * e_boneWeight.z;\n	outPosition += m3 * temp_position * e_boneWeight.w;\n	e_position = outPosition.xyz;\n	vec4 temp_n ;\n	temp_n  = m0 * temp_normal * e_boneWeight.x;\n	temp_n += m1 * temp_normal * e_boneWeight.y;\n	temp_n += m2 * temp_normal * e_boneWeight.z;\n	temp_n += m3 * temp_normal * e_boneWeight.w;\n	\n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 ) ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -temp_n.xyz ; \n    \n    outPosition.xyzw = varying_mvPose.xyzw ; \n    varying_color = attribute_color; \n}",specularMap_fragment:"uniform sampler2D specularTexture;\nvoid main(void){\n   	s.Specular = texture2D(specularTexture, uv_0).xyzx ;\n}\n",tangent_vs:"attribute vec3 attribute_tangent;\nvoid main(void){\n} ",terrainRGBA_fragment:"uniform sampler2D blendMaskTexture ;\nuniform sampler2D splat_0Tex ;\nuniform sampler2D splat_1Tex ;\nuniform sampler2D splat_2Tex ;\nuniform sampler2D splat_3Tex ;\nuniform float uvs[8];\nvoid main() {\n	materialSource.refraction = 3.0 ;\n	vec4 splat_control = texture2D ( blendMaskTexture , varying_uv0 );\n	vec4 cc = vec4(0.0,0.0,0.0,1.0);\n	vec2 uv = varying_uv0 ;\n	cc.xyz = splat_control.x * texture2D (splat_0Tex, uv * vec2(uvs[0],uvs[1])).xyz ;\n	cc.xyz += splat_control.y * texture2D (splat_1Tex, uv * vec2(uvs[2],uvs[3]) ).xyz;\n	cc.xyz += splat_control.z * vec4(texture2D (splat_2Tex, uv* vec2(uvs[4],uvs[5]))).xyz;\n	cc.xyz += (1.0-splat_control.w) * vec4(texture2D (splat_3Tex, uv* vec2(uvs[6],uvs[7]))).xyz; \n	s.Albedo.xyz = cc.xyz ; \n	outColor.xyz = s.Albedo.xyz;\n	outColor.w = 1.0;\n}\n",uvRoll_fs:"uniform float uvRoll[2] ;\nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    uv_0.xy += vec2(uvRoll[0],uvRoll[1]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n}",uvSpriteSheet_fs:"uniform float uvSpriteSheet[4] ;\nuniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n    uv_0.xy *= vec2(uvSpriteSheet[2],uvSpriteSheet[3]);\n    uv_0.xy += vec2(uvSpriteSheet[0],uvSpriteSheet[1]);\n	diffuseColor = texture2D(diffuseTexture , uv_0 );\n}",uvStreamerRoll_fs:"uniform float uvRoll[3] ;\nuniform sampler2D diffuseTexture;\nuniform sampler2D streamerTexture;\nvec4 diffuseColor ;\nvoid main() {\n    \n	diffuseColor = texture2D(diffuseTexture , varying_uv0 );\n    \n    vec2 rollUV = varying_uv0 + vec2(uvRoll[0],uvRoll[1]) + vec2(normal.xz) * 0.5 ;\n	diffuseColor.xyz += texture2D(streamerTexture , rollUV ).xyz * uvRoll[2] ;\n    \n}",varyingViewDir_vs:"varying vec3 varying_ViewDir; \nuniform vec3 uniform_eyepos; \nvoid main(void){ \n    varying_ViewDir = (uniform_eyepos.xyz - e_position) ; \n}",vertexPos_vs:"uniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nvarying vec4 varying_mvPose;\nvoid main() {\n       varying_mvPose = uniform_ViewMatrix * uniform_ModelMatrix * vec4(e_position, 1.0) ; \n}\n                      ",waterBump_fs:"uniform vec2 waterNormalData[4];\nuniform vec4 horizonColor;\nuniform float time ;\nuniform sampler2D bumpTexture;\nuniform sampler2D colorControlTexture;\nvarying vec2 varying_uv0        ;\nvarying vec2 varying_uv0        ;\nvec4 UnpackNormal( vec4 nT ){\n    vec4 t ;\n    t.xyzw = nT.xyzw * 2.0 - 1.0 ;\n    return t ;\n}\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n    vec3 dp1 = dFdx(p);\n    vec3 dp2 = dFdy(p);\n    vec2 duv1 = dFdx(uv);\n    vec2 duv2 = dFdy(uv);\n    vec3 dp2perp = cross(dp2, N);\n    vec3 dp1perp = cross(N, dp1);\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n    return mat3(T * invmax, B * invmax, N);\n}\nvoid main(void){\n    float tempTime = mod(time,10000000.0); \n    vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n    vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n    TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ;\n    vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w) ;\n    vec3 bump1 = UnpackNormal(texture2D( bumpTexture, uvA )).rgb;\n	vec3 bump2 = UnpackNormal(texture2D( bumpTexture, uvB )).rgb;\n	vec3 bump = (bump1 + bump2) * 0.5;\n    normal = TBN * bump ;\n	\n	float fresnel = dot( viewDir, bump );\n	vec4 water = texture2D( colorControlTexture, vec2(fresnel,fresnel) );\n	\n	vec4 col;\n	diffuseColor.rgb = mix( water.rgb, horizonColor.rgb, water.a );\n	diffuseColor.a = horizonColor.a;\n}",waterDiffuse_fs:"uniform sampler2D diffuseTexture;\nvec4 diffuseColor ;\nvoid main() {\n			diffuseColor.xyz *= diffuseColor.w ;\n}\n",waterNormal_fs:"uniform vec2 waterNormalData[4];\nuniform float time ;\nuniform sampler2D normalTextureA;\nuniform sampler2D normalTextureB;\nvarying vec4 varying_mvPose;\nvarying vec2 varying_uv0;\nmat3 TBN ;\nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) {\n    vec3 dp1 = dFdx(p);\n    vec3 dp2 = dFdy(p);\n    vec2 duv1 = dFdx(uv);\n    vec2 duv2 = dFdy(uv);\n    vec3 dp2perp = cross(dp2, N);\n    vec3 dp1perp = cross(N, dp1);\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n    float invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B)));\n    return mat3(T * invmax, B * invmax, N);\n}\nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) {\n    mat3 TBN = cotangentFrame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\nvoid main(void){\n    TBN = cotangentFrame(normal,varying_mvPose.xyz, varying_uv0) ;\n    float tempTime = mod(time,100000.0); \n    vec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \n    vec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \n    vec3 bump1 = texture2D( normalTextureA, uvA ).rgb * 2.0-1.0 ; \n    bump1.y *= -1.0;\n    bump1.xyz = TBN * bump1 ; \n    normal.xyz = bump1.xyz ;\n    \n    vec3 bump2 = texture2D( normalTextureB, uvB ).rgb * 2.0-1.0 ; \n    bump2.y *= -1.0;\n    bump2.xyz = TBN * bump2 ; \n    normal.xyz = (normal.xyz + bump2.xyz)*0.5 ;\n    \n} ",wave_fs:"uniform sampler2D diffuseTexture;\nuniform vec3 uniform_eyepos; \nuniform vec4 waveFSData[2]; \nvarying vec4 varying_mvPose;\nvec4 diffuseColor ;\nvoid main(void){\n    vec3 viewDir = normalize(varying_mvPose.xyz/varying_mvPose.w); \n    diffuseColor.xyz = vec3(1.0,1.0,1.0) ; \n    vec3 shallowWaterColor = waveFSData[0].xyz * waveFSData[0].w ;\n    vec3 deepWaterColor = waveFSData[1].xyz * waveFSData[1].w;\n    float facing = clamp(dot( -normalize(viewDir),normal),0.0,1.0);\n    vec3 waterColor = mix(shallowWaterColor,deepWaterColor,facing);\n    diffuseColor.xyz *= waterColor ;\n} ",wave_vs:"#define VERTEX_TEXTURES\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nvarying vec4 varying_mvPose;\nuniform vec3 waveVSData[4];\nuniform float time ;\nstruct wave{\n    vec3 wave_xyz_intensity_0 ;\n    vec3 wave_xyz_intensity_1 ;\n    vec3 wave_xyz_speed_0 ;\n    vec3 wave_xyz_speed_1 ;\n};\nconst float pi = 3.14 ;\nvec3 calcWave2( float t , vec3 x, float amplitude, float waveLength ,float angularVelocity ,  vec3 waveDir ){\n  \n   angularVelocity = angularVelocity * 0.1;\n   vec3 waveVector = waveDir ;\n   float waveNumber = pi / waveLength;\n   waveVector *= waveNumber ;\n  \n  vec3 temp ; \n   float kDotX0SubWt = dot(waveVector , x ) - angularVelocity * t  * 0.001;\n   float A = amplitude * sin(kDotX0SubWt) ;\n   temp.xz = waveDir.xz * A ;\n   temp.y += amplitude * cos(kDotX0SubWt);\n   temp = x - temp ;\n   return temp ;\n}\nvoid main(void){\n   wave wa ; \n    wa.wave_xyz_intensity_0 = vec3(waveVSData[0]) ; \n    wa.wave_xyz_intensity_1 = vec3(waveVSData[1]) ; \n    wa.wave_xyz_speed_0 = vec3(waveVSData[2]) ; \n    wa.wave_xyz_speed_1 = vec3(waveVSData[3]) ; \n    \n    float tempTime = mod( time , 1000000.0 ); \n	vec3 newPose1 = calcWave2(tempTime,e_position,40.0, 20.0, 10.0,vec3(1.0,0.0,1.0)); \n	newPose1 += calcWave2(tempTime,e_position,20.0, 10.0, 10.0,vec3(1.0,0.0,-0.5)); \n	newPose1 += calcWave2(tempTime,e_position,1.0, 1.0, 10.0,vec3(1.0,0.0,-1.5)); \n    e_position = newPose1 ; \n    \n    mat4 mvMatrix = mat4(uniform_ViewMatrix * uniform_ModelMatrix); \n    \n    varying_mvPose = mvMatrix * vec4( e_position , 1.0 )  ; \n    \n    mat4 normalMatrix = inverse(mvMatrix) ;\n    normalMatrix = transpose(normalMatrix); \n    \n    varying_eyeNormal = mat3(normalMatrix) * -attribute_normal ; \n    \n    outPosition = varying_mvPose ; \n    varying_color = attribute_color; \n} "},t.ShaderStore=e,__reflect(e.prototype,"egret3d.ShaderStore")
}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._shaderContentDict=[],this.vs_begin="##define vs begin##",this.vs_end="##define vs end##",this.fs_begin="##define fs begin##",this.fs_end="##define fs end##"}return Object.defineProperty(e,"instance",{get:function(){return this._instance||(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e.prototype.load=function(){var e=[],r=[];for(var i in t.ShaderLib.lib){var a=t.ShaderLib.lib[i].indexOf(this.vs_begin),n=t.ShaderLib.lib[i].indexOf(this.vs_end),o=!1;-1!=a&&(o=!0,a+=this.vs_begin.length,e.push(i),r[i+"vs"]=t.ShaderLib.lib[i].substr(a,n-a)),a=t.ShaderLib.lib[i].indexOf(this.fs_begin),n=t.ShaderLib.lib[i].indexOf(this.fs_end),-1!=a&&(a+=this.fs_begin.length,o&&e.push(i),r[i+"fs"]=t.ShaderLib.lib[i].substr(a,n-a))}for(var i in e)delete t.ShaderLib.lib[e[i]];for(var i in r)t.ShaderLib.lib[i]=r[i];for(var i in t.ShaderLib.lib){var s=this.readShader(t.ShaderLib.lib[i]);this._shaderContentDict[i]=s,s.name=i}},e.prototype.readShader=function(e){for(var r=new t.GLSL.ShaderContent,i=t.StringUtil.processShaderFile(e),a=t.StringUtil.parseContent(i),n=a.concat();n.length>0;){var o=n[0];n.shift();var s=t.StringUtil.getLineType(o),l=-1;if(l=s.indexOf("struct"),-1==l)if(l=s.indexOf("function"),-1==l)if(l=s.indexOf("unknown"),-1==l);else{var h=t.StringUtil.parseLines(o),u=t.StringUtil.getVarKey(h),c=t.StringUtil.getVarType(h);if("sampler2D"==c){var d=t.StringUtil.getSampler2D(o);d&&r.addVar(d)}else if("samplerCube"==c){var p=t.StringUtil.getSampler3D(o);p&&r.addVar(p)}else if("attribute"==u){var f=t.StringUtil.getAttribute(o);f&&r.addVar(f)}else if("varying"==u){var m=t.StringUtil.getVarying(o);m&&r.addVar(m)}else if("uniform"==u){var _=t.StringUtil.getUniform(o);_&&r.addVar(_)}else if("const"==u){var v=t.StringUtil.getConst(o);v&&r.addVar(v)}else if("#extension"==u){var g=t.StringUtil.getExtension(o);g&&r.addVar(g)}else if("#define"==u){var y=t.StringUtil.getDefine(o);y&&r.addVar(y)}else r.addVar(t.StringUtil.getTemper(o))}else{var h=s.split(" "),x=o;r.addFunc(h[1],x)}else{var h=s.split(" "),b=o;r.addStruct(h[1],b),t.StringUtil.processStruct(h[1],b,r)}}return r},e.prototype.fillShaderContent=function(r,i,a){var n,o=0,s="";for(o=0;o<i.length;++o)""!=s&&(s+="/"),s+=i[o];if(s+="/d"+a.maxDirectLight,s+="/s"+a.maxSpotLight,s+="/p"+a.maxPointLight,s+="/b"+a.maxBone,this._shaderContentDict[s])n=this._shaderContentDict[s].clone();else for(n=new t.GLSL.ShaderContent,n.name=s,o=0;o<i.length;++o){var l=this._shaderContentDict[i[o]];n.addContent(l)}for(o=0;o<n.attributeList.length;o++)s=n.attributeList[o].varName,a[s]=n.attributeList[o];for(o=0;o<n.varyingList.length;o++)s=n.varyingList[o].varName,a[s]||(a[s]=n.varyingList[o]);for(o=0;o<n.tempList.length;o++)s=n.tempList[o].varName,a[s]=n.tempList[o];for(o=0;o<n.uniformList.length;o++)s=n.uniformList[o].varName,a[s]=n.uniformList[o];var h;for(o=0;o<n.constList.length;o++)switch(s=n.constList[o].varName,h=n.constList[o],a[s]=h,s){case"max_directLight":h.value=a.maxDirectLight;break;case"max_spotLight":h.value=a.maxSpotLight;break;case"max_pointLight":h.value=a.maxPointLight;break;case"bonesNumber":r.maxBone=a.maxBone,h.value=a.maxBone}for(o=0;o<n.sampler2DList.length;o++){var u=n.sampler2DList[o];u.index=o,a.sampler2DList.push(u),u.activeTextureIndex=e.getTexture2DIndex(o)}for(o=0;o<n.sampler3DList.length;o++){var c=n.sampler3DList[o];c.activeTextureIndex=e.getTexture2DIndex(n.sampler2DList.length+o),c.index=n.sampler2DList.length+o,a.sampler3DList.push(c)}return this.synthesisShader(n,r),t.ShaderPool.getGPUShader(r.shaderType,n.name,n.source)},e.prototype.synthesisShader=function(t,r){var i,a="";for(i=0;i<t.extensionList.length;i++)a+=e.connectExtension(t.extensionList[i]);for(a+="precision highp float;            	\n",i=0;i<t.defineList.length;i++)a+=e.connectDefine(t.defineList[i]);for(i=0;i<t.attributeList.length;i++)a+=e.connectAtt(t.attributeList[i]);for(i=0;i<t.structNames.length;i++)a+=e.connectStruct(t.structDict[t.structNames[i]]);for(i=0;i<t.varyingList.length;i++)a+=e.connectVarying(t.varyingList[i]);for(i=0;i<t.tempList.length;i++)a+=e.connectTemp(t.tempList[i]);for(i=0;i<t.constList.length;i++)a+=e.connectConst(t.constList[i]);for(i=0;i<t.uniformList.length;i++)a+=e.connectUniform(t.uniformList[i]);for(i=0;i<t.sampler2DList.length;i++){var n=t.sampler2DList[i];a+=e.connectSampler(n)}for(i=0;i<t.sampler3DList.length;i++){var o=t.sampler3DList[i];a+=e.connectSampler3D(o)}for(i=0;i<t.funcNames.length;i++)a+=t.funcDict[t.funcNames[i]];t.source=a},e.connectAtt=function(t){return"attribute "+t.valueType+" "+t.name+"; \r\n"},e.connectTemp=function(t){return""!=t.value?t.valueType+" "+t.name+" = "+t.value+"; \r\n":t.valueType+" "+t.name+"; \r\n"},e.connectStruct=function(t){return t+" \r\n"},e.connectConst=function(t){return"const "+t.valueType+" "+t.name+" = "+t.value+"; \r\n"},e.connectVarying=function(t){return"varying "+t.valueType+" "+t.name+"; \r\n"},e.connectUniform=function(t){return"uniform "+t.valueType+" "+t.name+"; \r\n"},e.connectSampler=function(t){return"uniform sampler2D "+t.name+"; \r\n"},e.connectSampler3D=function(t){return"uniform samplerCube "+t.name+"; \r\n"},e.connectExtension=function(t){return"#extension "+t.name+":"+t.value+"\r\n"},e.connectDefine=function(t){return t.key+" "+t.name+" "+t.value+"\r\n"},e.getTexture2DIndex=function(e){switch(e){case 0:return t.ContextSamplerType.TEXTURE_0;case 1:return t.ContextSamplerType.TEXTURE_1;case 2:return t.ContextSamplerType.TEXTURE_2;case 3:return t.ContextSamplerType.TEXTURE_3;case 4:return t.ContextSamplerType.TEXTURE_4;case 5:return t.ContextSamplerType.TEXTURE_5;case 6:return t.ContextSamplerType.TEXTURE_6;case 7:return t.ContextSamplerType.TEXTURE_7;case 8:return t.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")},e}();e._shaderLibs={},e._methodLibs={},t.ShaderUtil=e,__reflect(e.prototype,"egret3d.ShaderUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r){var i=t.call(this)||this;return i.name=e,i.computeVarName(),i.key="attribute",i.valueType=r,i}return __extends(e,t),e}(t.VarRegister);t.Attribute=e,__reflect(e.prototype,"egret3d.GLSL.Attribute")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t}();e["int"]="int",e["float"]="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4",t.AttributeType=e,__reflect(e.prototype,"egret3d.GLSL.AttributeType")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r,i){var a=t.call(this)||this;return a.name=e,a.computeVarName(),a.key="const",a.valueType=r,a.value=i,a}return __extends(e,t),e}(t.VarRegister);t.ConstVar=e,__reflect(e.prototype,"egret3d.GLSL.ConstVar")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r){var i=t.call(this)||this;return i.name=e,i.computeVarName(),i.key="#define",i.value=r,i}return __extends(e,t),e}(t.VarRegister);t.DefineVar=e,__reflect(e.prototype,"egret3d.GLSL.DefineVar")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){var r=t.call(this)||this;return r.name=e,r.computeVarName(),r.key="#extension",r}return __extends(e,t),e}(t.VarRegister);t.Extension=e,__reflect(e.prototype,"egret3d.GLSL.Extension")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){var r=t.call(this)||this;return r.name=e,r.computeVarName(),r.key="sampler2D",r}return __extends(e,t),e}(t.VarRegister);t.Sampler2D=e,__reflect(e.prototype,"egret3d.GLSL.Sampler2D")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){var r=t.call(this)||this;return r.name=e,r.computeVarName(),r.key="samplerCube",r}return __extends(e,t),e}(t.VarRegister);t.Sampler3D=e,__reflect(e.prototype,"egret3d.GLSL.Sampler3D")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.index=0,this.shadersName=new Array,this.endShadername="",this.stateChange=!1,this.maxBone=0,this.shaderType=-1,this.shaderType=t}return e.prototype.addUseShaderName=function(t){this.shadersName.push(t)},e.prototype.addEndShaderName=function(t){this.endShadername=t},e.prototype.getShader=function(e){if(""!=this.endShadername){var r=this.shadersName.indexOf(this.endShadername);-1==r&&this.shadersName.push(this.endShadername)}return t.ShaderUtil.instance.fillShaderContent(this,this.shadersName,e)},e}();t.ShaderBase=e,__reflect(e.prototype,"egret3d.ShaderBase")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r){var i=t.call(this)||this;return i.name=e,i.computeVarName(),i.key="",i.valueType=r,i}return __extends(e,t),e}(t.VarRegister);t.TmpVar=e,__reflect(e.prototype,"egret3d.GLSL.TmpVar")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r){var i=t.call(this)||this;return i.name=e,i.computeVarName(),i.key="uniform",i.valueType=r,i}return __extends(e,t),e}(t.VarRegister);t.Uniform=e,__reflect(e.prototype,"egret3d.GLSL.Uniform")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t}();e.bool="bool",e["int"]="int",e["float"]="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.bvec2="bvec2",e.bvec3="bvec3",e.bvec4="bvec4",e.ivec2="ivec2",e.ivec3="ivec3",e.ivec4="ivec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4",e.sampler2D="sampler2D",e.sampleCube="sampleCube",t.UniformType=e,__reflect(e.prototype,"egret3d.GLSL.UniformType")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t}();e.attribute_position="attribute_position",e.attribute_normal="attribute_normal",e.attribute_tangent="attribute_tangent",e.attribute_vertexColor="attribute_vertexColor",e.attribute_uv0="attribute_uv0",e.attribute_uv1="attribute_uv1",e.varying_pos="varying_pos",e.varying_normal="varying_normal",e.varying_tangent="varying_tangent",e.varying_color="varying_color",e.varying_uv0="varying_uv0",e.varying_uv1="varying_uv1",e.varying_globalPos="varying_globalPos",e.varying_lightDir="varying_lightDir",e.varying_eye="varying_eye",e.uniform_floatv_0="uniform_floatv_0",e.uniform_floatv_1="uniform_floatv_1",e.uniform_floatv_2="uniform_floatv_2",e.uniform_iv_0="uniform_iv_0",e.uniform_iv_1="uniform_iv_1",e.uniform_iv_2="uniform_iv_2",e.uniform_bv_0="uniform_bv_0",e.uniform_bv_1="uniform_bv_1",e.uniform_bv_2="uniform_bv_2",e.uniform_vec2fv_0="uniform_vec2fv_0",e.uniform_vec2fv_1="uniform_vec2fv_1",e.uniform_vec2fv_2="uniform_vec2fv_2",e.uniform_vec3fv_0="uniform_vec3fv_0",e.uniform_vec3fv_1="uniform_vec3fv_1",e.uniform_vec3fv_2="uniform_vec3fv_2",e.uniform_vec4fv_0="uniform_vec4fv_0",e.uniform_vec4fv_1="uniform_vec4fv_1",e.uniform_vec4fv_2="uniform_vec4fv_2",e.uniform_vec2iv_0="uniform_vec2iv_0",e.uniform_vec2iv_1="uniform_vec2iv_1",e.uniform_vec2iv_2="uniform_vec2iv_2",e.uniform_vec3iv_0="uniform_vec3iv_0",e.uniform_vec3iv_1="uniform_vec3iv_1",e.uniform_vec3iv_2="uniform_vec3iv_2",e.uniform_vec4iv_0="uniform_vec4iv_0",e.uniform_vec4iv_1="uniform_vec4iv_1",e.uniform_vec4iv_2="uniform_vec4iv_2",e.uniform_vec2bv_0="uniform_vec2bv_0",e.uniform_vec2bv_1="uniform_vec2bv_1",e.uniform_vec2bv_2="uniform_vec2bv_2",e.uniform_vec3bv_0="uniform_vec3bv_0",e.uniform_vec3bv_1="uniform_vec3bv_1",e.uniform_vec3bv_2="uniform_vec3bv_2",e.uniform_vec4bv_0="uniform_vec4bv_0",e.uniform_vec4bv_1="uniform_vec4bv_1",e.uniform_vec4bv_2="uniform_vec4bv_2",e.uniform_modelMatrix="uniform_modelMatrix",e.uniform_projectionMatrix="uniform_projectionMatrix",e.uniform_normalMatrix="uniform_normalMatrix",e.uniform_eye="uniform_eye",e.uniform_lightDir="uniform_lightDir",e.texture2D_0="texture2D_0",e.texture2D_1="texture2D_1",e.texture2D_2="texture2D_2",e.texture2D_3="texture2D_3",e.texture2D_4="texture2D_4",t.VarConstName=e,__reflect(e.prototype,"egret3d.GLSL.VarConstName")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._dirty=!0,this._makeResult=0,this._values=[],this._values=[],this._values.length=t.MAX_COUNT}return t.prototype.setBoolean=function(e,r){if(e>=t.MAX_COUNT)throw Error("BooleanArray MAX_COUNT："+t.MAX_COUNT);this._values[e]!=r&&(this._values[e]=r,this._dirty=!0)},t.prototype.getBoolean=function(e){return e>=t.MAX_COUNT?!1:this._values[e]},Object.defineProperty(t.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0}),t.prototype.forceDirty=function(){this._dirty=!0},Object.defineProperty(t.prototype,"makeResult",{get:function(){return this._dirty&&this.make(),this._makeResult},enumerable:!0,configurable:!0}),t.prototype.make=function(){this._makeResult=0;for(var e=0,r=t.MAX_COUNT;r>e;e++)this._values[e]&&(this._makeResult+=1<<e);return this._dirty=!1,this._makeResult},t.prototype.clear=function(){this._dirty=!0,this._makeResult=0,this._values.length=0},t}();e.FLAG_0=0,e.FLAG_1=1,e.FLAG_2=2,e.FLAG_3=3,e.FLAG_4=4,e.FLAG_5=5,e.FLAG_6=6,e.FLAG_7=7,e.FLAG_8=8,e.FLAG_9=9,e.FLAG_10=10,e.MAX_COUNT=24,t.BooleanArray=e,__reflect(e.prototype,"egret3d.BooleanArray")}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,r){var i=t.call(this)||this;return i.name=e,i.computeVarName(),i.key="varying",i.valueType=r,i}return __extends(e,t),e}(t.VarRegister);t.Varying=e,__reflect(e.prototype,"egret3d.GLSL.Varying")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t}();e.bool="bool",e["int"]="int",e["float"]="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.bvec2="bvec2",e.bvec3="bvec3",e.bvec4="bvec4",e.ivec2="ivec2",e.ivec3="ivec3",e.ivec4="ivec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4",e.sampler2D="sampler2D",e.sampleCube="sampleCube",t.VaryingType=e,__reflect(e.prototype,"egret3d.GLSL.VaryingType")}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this._boundBox=new t.BoundBox,this.enableShadow=!1,this.textureSizeWidth=1024,this.textureSizeHeight=1024,this.shadowCamera=new t.Camera3D(t.CameraType.orthogonal),this.shadowRender=new t.MultiRender(t.PassType.shadowPass),this.shadowRender.name=t.PassType.shadowPass.toString(),this.shadowRender.camera=this.shadowCamera,this.shadowRender.setRenderToTexture(this.textureSizeWidth,this.textureSizeHeight,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA),this.castShadowLight(e.sunLight);var r=t.MathUtil.CALCULATION_VECTOR3D;r.copyFrom(this.directLight.dir),r.negate(),r.scaleBy(1e3),this.shadowCamera.globalPosition=r,e.renderQuen.addRender(this.shadowRender)}return e.prototype.setTextureSize=function(e,r){this.textureSizeWidth=e,this.textureSizeHeight=r,this.shadowRender.setRenderToTexture(this.textureSizeWidth,this.textureSizeHeight,t.FrameBufferFormat.UNSIGNED_BYTE_RGBA)},e.prototype.castShadowLight=function(t){this.directLight=t,this.shadowCamera.updateViewport(0,0,2048,2048),this.shadowCamera.near=1,this.shadowCamera.far=3e3,t.addChild(this.shadowCamera)},e.prototype.update=function(t,e,r){this.calculateBoundBox(t)},e.prototype.calculateBoundBox=function(e){this._boundBox.min.copyFrom(new t.Vector3D(t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE,t.MathUtil.MAX_VALUE)),this._boundBox.max.copyFrom(new t.Vector3D(-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE,-t.MathUtil.MAX_VALUE));for(var r=0;r<e.specialCastItem[t.SpecialCast.Shadow].length;r++){var i=e.specialCastItem[t.SpecialCast.Shadow][r],a=i.bound;this._boundBox.max.x<a.max.x+i.globalX&&(this._boundBox.max.x=a.max.x+i.globalX),this._boundBox.max.y<a.max.y+i.globalY&&(this._boundBox.max.y=a.max.y+i.globalY),this._boundBox.max.z<a.max.z+i.globalZ&&(this._boundBox.max.z=a.max.z+i.globalZ),this._boundBox.min.x>a.min.x+i.globalX&&(this._boundBox.min.x=a.min.x+i.globalX),this._boundBox.min.y>a.min.y+i.globalY&&(this._boundBox.min.y=a.min.y+i.globalY),this._boundBox.min.z>a.min.z+i.globalZ&&(this._boundBox.min.z=a.min.z+i.globalZ)}this._boundBox.fillBox(this._boundBox.min,this._boundBox.max);var n=t.MathUtil.CALCULATION_VECTOR3D;n.copyFrom(this.directLight.dir),n.negate(),n.scaleBy(this._boundBox.radius),n.add(this._boundBox.center,n),this.shadowCamera.globalPosition=n,this.shadowCamera.updateViewport(0,0,2*this._boundBox.radius,2*this._boundBox.radius),this.shadowCamera.far=2*this._boundBox.radius},e}();t.ShadowCast=e,__reflect(e.prototype,"egret3d.ShadowCast")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.width=32,r.height=32,r.uvRectangle=new t.Rectangle(0,0,1,1),r.buildCheckerboard(),r.texture2D=new t.ContextTexture2D,r.texture2D.border=0,r.texture2D.internalFormat=t.InternalFormat.PixelArray,r}return __extends(r,e),r.prototype.upload=function(e){this.texture2D.textureBuffer||(this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture(),this.texture2D.colorFormat=t.Context3DProxy.gl.RGBA,this.texture2D.mimapData=new Array,this.texture2D.mimapData.push(new t.MipmapData(this._pixelArray,this.width,this.height)),this.texture2D.width=this.width,this.texture2D.height=this.height,this.useMipmap=!1,this.texture2D.dataFormat=t.Context3DProxy.gl.FLOAT,e.upLoadTextureData(0,this))},r.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Float32Array(this.width*this.height*4);for(var e=[t.Color.white(),t.Color.black()],r=0,i=4,a=0;a<this.height;a++)for(var n=0;n<this.width;n++){if(n%i==0&&(r=(r+1)%2),a%i==0&&0==n){var o=e[0];e[0]=e[1],e[1]=o,r=0}this._pixelArray[a*(4*this.width)+4*n+0]=Math.random(),this._pixelArray[a*(4*this.width)+4*n+1]=Math.random(),this._pixelArray[a*(4*this.width)+4*n+2]=Math.random(),this._pixelArray[a*(4*this.width)+4*n+3]=Math.random()}}},r.prototype.uploadForcing=function(t){},r}(t.ITexture);e.texture=new t.CheckerboardTexture,t.CheckerboardFloatTexture=e,__reflect(e.prototype,"egret3d.CheckerboardFloatTexture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){void 0===r&&(r=null);var i=e.call(this,r,null)||this;return i.dir=new t.Vector3D,t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,i.mouseMove,i),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,i.mouseWheel,i),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,i.touchMove,i),i}return __extends(r,e),r.prototype.touchMove=function(t){1==t.targetTouches.length?this.mouseMove(null):this.mouseWheel(null)},r.prototype.mouseWheel=function(e){if(this._target){var i=this._target;if(i){var a=.1*t.Input.wheelDelta,n=i.viewPort;switch(i.cameraType){case t.CameraType.orthogonal:var o=n.width-a,s=n.height-a;i.updateViewport(0,0,o,s);break;case t.CameraType.orthogonalToCenter:var l=n.x-a,h=n.y-a,o=n.width-a,s=n.height-a;i.updateViewport(l,h,o,s);break;case t.CameraType.perspective:this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir),this.dir.normalize(),r.v0.copyFrom(this.dir),r.v0.scaleBy(a),this.target.globalPosition.add(r.v0,r.v0),this.target.globalPosition=r.v0}}}},r.prototype.mouseMove=function(e){t.Input.getMousePress(t.MouseCode.Mouse_Left)&&(this.target.rotationY+=t.Input.mouseOffsetX,this.target.rotationX+=t.Input.mouseOffsetY)},r.prototype.update=function(e,i){if(void 0===e&&(e=16.6),void 0===i&&(i=0),this.target){var a=this.speed*e/1e3;t.Input.getKeyPress(t.KeyCode.Key_W)&&(this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir),this.dir.normalize(),r.v0.copyFrom(this.dir),r.v0.scaleBy(a),this.target.globalPosition.add(r.v0,r.v0),this.target.globalPosition=r.v0),t.Input.getKeyPress(t.KeyCode.Key_S)&&(this.target.globalOrientation.transformVector(t.Vector3D.Z_AXIS,this.dir),this.dir.normalize(),r.v0.copyFrom(this.dir),r.v0.scaleBy(a),this.target.globalPosition.subtract(r.v0,r.v0),this.target.globalPosition=r.v0),t.Input.getKeyPress(t.KeyCode.Key_A)&&(this.target.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir),this.dir.normalize(),r.v0.copyFrom(this.dir),r.v0.scaleBy(a),this.target.globalPosition.subtract(r.v0,r.v0),this.target.globalPosition=r.v0),t.Input.getKeyPress(t.KeyCode.Key_D)&&(this.target.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir),this.dir.normalize(),r.v0.copyFrom(this.dir),r.v0.scaleBy(a),this.target.globalPosition.add(r.v0,r.v0),this.target.globalPosition=r.v0)}},r}(t.ControllerBase);e.v0=new t.Vector3D,t.FreeController=e,__reflect(e.prototype,"egret3d.FreeController")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n,o,s){void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===n&&(n=null),void 0===o&&(o=null),void 0===s&&(s=null);var l=e.call(this)||this;return l.image_front=r,l.image_back=i,l.image_left=a,l.image_right=n,l.image_up=o,l.image_down=s,l.texture3D=new t.ContextTexture3D,l}return __extends(r,e),r.createCubeTexture=function(e,i,a,n,o,s){var l=new t.ContextTexture2D;l.imageData=e;var h=new t.ContextTexture2D;h.imageData=i;var u=new t.ContextTexture2D;u.imageData=a;var c=new t.ContextTexture2D;c.imageData=n;var d=new t.ContextTexture2D;d.imageData=o;var p=new t.ContextTexture2D;p.imageData=s;var f=new r(l,h,u,c,d,p);return f},r.createCubeTextureByImageTexture=function(t,e,i,a,n,o){return new r(t.texture2D,e.texture2D,i.texture2D,a.texture2D,n.texture2D,o.texture2D)},r.setCubeTexture=function(t,e,r,i,a,n,o){t.image_front=e.texture2D,t.image_back=r.texture2D,t.image_left=i.texture2D,t.image_right=a.texture2D,t.image_up=n.texture2D,t.image_down=o.texture2D},r.prototype.upload=function(t){this.image_front&&this.image_back&&this.image_left&&this.image_right&&this.image_up&&this.image_down&&(this.texture3D.texture||(this.texture3D.texture=this.texture3D.texture||t.creatTexture(),this.texture3D.border=0,this.texture3D.image_front=this.image_front,this.texture3D.image_back=this.image_back,this.texture3D.image_left=this.image_left,this.texture3D.image_right=this.image_right,this.texture3D.image_up=this.image_up,this.texture3D.image_down=this.image_down,t.uploadCubetexture(this.texture3D)))},r.prototype.uploadForcing=function(t){},r}(t.ITexture);t.CubeTexture=e,__reflect(e.prototype,"egret3d.CubeTexture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a,n,o,s,l,h,u,c,d,p){void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=0),void 0===n&&(n=90),void 0===o&&(o=100),void 0===s&&(s=-90),void 0===l&&(l=90),void 0===h&&(h=0/0),void 0===u&&(u=0/0),void 0===c&&(c=8),void 0===d&&(d=2),void 0===p&&(p=!1);var f=e.call(this,r,i)||this;return f._currentPanAngle=0,f._currentTiltAngle=90,f._panAngle=0,f._tiltAngle=90,f._distance=1e3,f._minPanAngle=-(1/0),f._maxPanAngle=1/0,f._minTiltAngle=-90,f._maxTiltAngle=90,f._maxDistance=5e3,f._minDistance=-5e3,f._steps=8,f._yFactor=2,f._wrapPanAngle=!1,f._lookAtPosition=new t.Vector3D(0,0,0),f._mouseDown=!1,f._mouseRightDown=!1,f._keyArray=new Array,f.distance=o,f.panAngle=a,f.tiltAngle=n,f.minPanAngle=h||-(1/0),f.maxPanAngle=u||1/0,f.minTiltAngle=s,f.maxTiltAngle=l,f.steps=c,f.yFactor=d,f.wrapPanAngle=p,f._currentPanAngle=f._panAngle,f._currentTiltAngle=f._tiltAngle,t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,f.mouseMove,f),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,f.mouseWheel,f),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,f.mouseUp,f),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,f.mouseDown,f),t.Input.addEventListener(t.KeyEvent3D.KEY_UP,f.keyUp,f),t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,f.keyDown,f),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,f.touchUp,f),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,f.touchDown,f),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,f.touchMove,f),f}return __extends(r,e),r.prototype.mouseMove=function(e){this._mouseDown&&(this._tiltAngle+=.1*t.Input.mouseOffsetY,this._tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)),this._panAngle+=.1*t.Input.mouseOffsetX,this._panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},r.prototype.mouseWheel=function(e){var r=this._target;if(r){var i=.1*t.Input.wheelDelta,a=r.viewPort;switch(r.cameraType){case t.CameraType.orthogonal:var n=a.width-i,o=a.height-i;r.updateViewport(0,0,n,o);break;case t.CameraType.orthogonalToCenter:var s=a.x-i,l=a.y-i,n=a.width-i,o=a.height-i;r.updateViewport(s,l,n,o);break;case t.CameraType.perspective:this._distance-=i,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))}}},r.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!1;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!1}},r.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!0;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!0}},r.prototype.touchMove=function(t){1==t.targetTouches.length?this.mouseMove(null):this.mouseWheel(null)},r.prototype.touchUp=function(t){this._mouseDown=!1},r.prototype.touchDown=function(t){this._mouseDown=!0},r.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0}},r.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1}},Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"steps",{get:function(){return this._steps},set:function(t){t=1>t?1:t,this._steps!=t&&(this._steps=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,t)),this._panAngle!=t&&(this._panAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,t)),this._tiltAngle!=t&&(this._tiltAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance!=t&&(this._distance=this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,t)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){this._minPanAngle!=t&&(this._minPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){this._maxPanAngle!=t&&(this._maxPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){this._minTiltAngle!=t&&(this._minTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){this._maxTiltAngle!=t&&(this._maxTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance!=t&&(this._maxDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"minDistance",{get:function(){return this._maxDistance},set:function(t){this._minDistance!=t&&(this._minDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){this._yFactor!=t&&(this._yFactor=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){this._wrapPanAngle!=t&&(this._wrapPanAngle=t)},enumerable:!0,configurable:!0}),r.prototype.update=function(e){void 0===e&&(e=!0),(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle)&&(this._wrapPanAngle&&(this._panAngle<0?this._panAngle=this._panAngle%360+360:this._panAngle=this._panAngle%360,this._panAngle-this._currentPanAngle<-180?this._currentPanAngle-=360:this._panAngle-this._currentPanAngle>180&&(this._currentPanAngle+=360)),e?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle));var r=this._lookAtObject?this._lookAtObject.position:this._lookAtPosition?this._lookAtPosition:this._origin,i=new t.Vector3D;i.x=r.x+this.distance*Math.sin(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),i.z=r.z+this.distance*Math.cos(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),i.y=r.y+this.distance*Math.sin(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS)*this.yFactor,this._target&&this._lookAtPosition&&this._target.lookAt(i,this._lookAtPosition)},r}(t.ControllerBase);t.HoverController=e,__reflect(e.prototype,"egret3d.HoverController")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r){var i=e.call(this)||this;return i.imageData=r,i.texture2D=new t.ContextTexture2D,i.texture2D.imageData=r,i}return __extends(r,e),Object.defineProperty(r.prototype,"width",{get:function(){return this.imageData.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this.imageData.height},enumerable:!0,configurable:!0}),r.prototype.upload=function(e){this.texture2D.textureBuffer||(this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture(),this.texture2D.internalFormat=t.InternalFormat.ImageData,this.texture2D.imageData=this.imageData,this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE,this.texture2D.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,e.upLoadTextureData(0,this))},r.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this.imageData&&(delete this.imageData,this.imageData=null)},r.prototype.readPixels=function(e,r,i,a,n,o,s){return void 0===n&&(n=t.ContextConfig.ColorFormat_RGBA8888),void 0===o&&(o=t.ContextConfig.UNSIGNED_BYTE),void 0===s&&(s=null),t.Egret3DCanvas.draw2DImage(this.imageData,e,r,i,a)},r}(t.ITexture);t.ImageTexture=e,__reflect(e.prototype,"egret3d.ImageTexture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i,a){void 0===r&&(r=512),void 0===i&&(i=512),void 0===a&&(a=t.FrameBufferFormat.UNSIGNED_BYTE_RGB);var n=e.call(this)||this;switch(n.frameBufferFormat=t.FrameBufferFormat.UNSIGNED_BYTE_RGB,n.useMipmap=!1,n.smooth=!1,n.width=r,n.height=i,n.frameBufferFormat=a,n.uvRectangle=new t.Rectangle(0,0,1,1),n.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:n.colorFormat=t.ContextConfig.UNSIGNED_BYTE;
break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:n.colorFormat=t.ContextConfig.UNSIGNED_BYTE;break;case t.FrameBufferFormat.FLOAT_RGBA:n.colorFormat=t.ContextConfig.FLOAT;break;case t.FrameBufferFormat.FLOAT_RGB:n.colorFormat=t.ContextConfig.FLOAT}return n}return __extends(r,e),r.prototype.upload=function(t){this.texture2D||(this.texture2D=t.createFramebuffer(this.width,this.height,this.frameBufferFormat))},r.prototype.uploadForcing=function(t){},r.prototype.fillPixels=function(){if(this.texture2D){var e;if(this.texture2D.mimapData){var r=this.texture2D.mimapData[0];e=r.data}else{switch(this.texture2D.mimapData=[],this.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:e=new Uint8Array(this.width*this.height*4);break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:e=new Uint8Array(this.width*this.height*3);break;case t.FrameBufferFormat.FLOAT_RGBA:e=new Float32Array(this.width*this.height*4);break;case t.FrameBufferFormat.FLOAT_RGB:e=new Float32Array(this.width*this.height*3)}var r=new t.MipmapData(e,this.width,this.height);this.texture2D.mimapData.push(r)}t.Context3DProxy.gl.readPixels(0,0,this.width,this.height,this.colorFormat,t.ContextConfig.UNSIGNED_BYTE,e)}},r.prototype.readPixels=function(r,i,a,n,o,s,l){if(void 0===o&&(o=t.ContextConfig.ColorFormat_RGBA8888),void 0===s&&(s=t.ContextConfig.UNSIGNED_BYTE),void 0===l&&(l=null),l=e.prototype.readPixels.call(this,r,i,a,n,o,s,l),this.texture2D&&this.texture2D.mimapData){var h=this.texture2D.mimapData[0],u=h.data,c=4;switch(this.frameBufferFormat){case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:case t.FrameBufferFormat.FLOAT_RGBA:c=4;break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:case t.FrameBufferFormat.FLOAT_RGB:c=3}for(var d=0;n>d;++d)for(var p=0;a>p;++p)for(var f=0;c>f;++f)l[4*(d*a+p)+f]=u[4*((i+d)*this.width+(r+p))+f]}return l},r}(t.ITexture);t.RenderTexture=e,__reflect(e.prototype,"egret3d.RenderTexture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(){var r=e.call(this)||this;return r.smooth=!0,r.texture2D=new t.ContextTexture2D,r}return __extends(r,e),r.prototype.upload=function(e){if(!this.texture2D.textureBuffer){if(this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture(),this.texture2D.internalFormat=this.internalFormat,this.texture2D.colorFormat=this.colorFormat,this.texture2D.mimapData=this.mimapData,this.texture2D.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE,this.mimapData&&this.mimapData.length>0)for(var r=0;r<this.mimapData.length;r++)e.upLoadTextureData(r,this);else e.upLoadTextureData(0,this);this.parentTexture&&(this.parentTexture.texture2D||this.parentTexture.upload(e),this.texture2D=this.parentTexture.texture2D,this.texture2D.internalFormat=this.parentTexture.internalFormat,this.texture2D.colorFormat=this.parentTexture.colorFormat,this.texture2D.mimapData=this.parentTexture.mimapData)}},r.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},r}(t.ITexture);t.Texture=e,__reflect(e.prototype,"egret3d.Texture")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.getTextureData=function(t){var r=1024,i=1024;return e.canvas2D.width=r,e.canvas2D.height=i,e.context2D.clearRect(0,0,r,i),e.context2D.drawImage(t,0,0,r,i,0,0,r,i),e.canvas2D},e.regist=function(){e.canvas2D||(e.canvas2D=document.getElementById("TextureCanvasUtil"),e.context2D||(e.canvas2D=document.createElement("canvas"),e.canvas2D.id="TextureCanvasUtil",e.canvas2D.hidden=!0,document.body.appendChild(e.canvas2D),e.context2D=e.canvas2D.getContext("2d")))},e.generateMipMaps=function(e){function r(t){for(var e=new Uint8Array(Math.ceil(t.length/2)),r=0,i=0;i<t.length;i++)i%2==0&&(e[r++]=t[i]);return e}var i=1,a=1,n=Math.ceil(e.width/2),o=Math.ceil(e.height/2),s=new Array;s.push(e);for(var l;n>=i||o>=a;)l=new t.MipmapData(r(e.data),n,o),n>>=1,o>>=1,e=l},e}();t.TextureUtil=e,__reflect(e.prototype,"egret3d.TextureUtil")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function r(r,i){void 0===r&&(r=256),void 0===i&&(i=256);var a=e.call(this)||this;return a.canUpdataTexture=!1,a.width=r,a.height=i,a.texture2D=new t.ContextTexture2D,a.tmpCanvas=document.createElement("canvas"),a.tmpCanvas.width=r,a.tmpCanvas.height=i,a.context=a.tmpCanvas.getContext("2d"),a.video=document.createElement("video"),a.video.msZoom=!0,a.video.width=r,a.video.height=i,a.video.controls=!1,a.video.autoplay=!0,a.video.addEventListener("canplaythrough",function(){return a.loadReady()},!0),a.tmpCanvas.hidden=!0,a}return __extends(r,e),r.prototype.loadReady=function(){this.canUpdataTexture=!0},Object.defineProperty(r.prototype,"source",{get:function(){return this.video.src},set:function(t){this.video.src=t},enumerable:!0,configurable:!0}),r.prototype.play=function(){this.video.play()},r.prototype.pause=function(){this.video.pause()},r.prototype.upload=function(e){this.texture2D.textureBuffer||(this.texture2D.textureBuffer=this.texture2D.textureBuffer||e.creatTexture(),this.context.drawImage(this.video,0,0,this.width,this.height),t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1),t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer),t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)),this.canUpdataTexture&&(this.context.drawImage(this.video,0,0,this.width,this.height),t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1),t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer),t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE))},r.prototype.uploadForcing=function(t){},r}(t.ITexture);t.VideoTexture=e,__reflect(e.prototype,"egret3d.VideoTexture")}(egret3d||(egret3d={}));